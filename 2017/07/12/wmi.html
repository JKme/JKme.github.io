<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>WMIå­¦ä¹ ç¬”è®° | ğŸ˜Š#</title>
  <meta name="author" content="JKme">
  
  <meta name="description" content="windowsä¸‹çš„å®šæ—¶ä»»åŠ¡
ç»´æŒæƒé™çš„è¯è¿˜æ˜¯è€ƒè™‘WMIäº‹ä»¶æˆ–è€…åœ¨æœåŠ¡ä¸Šä¸‹æ‰‹.  å¦‚åŠ«æŒç›¸å…³æœåŠ¡æŒ‡å‘çš„ç¨‹åºï¼Œæœªè¢«åŒå¼•å·ä¿æŠ¤çš„è·¯å¾„ç­‰ï¼Œæ·»åŠ è®¡åˆ’ä»»åŠ¡ä¸€æ—¦è¢«æŠ¥è­¦.å°±æ˜¯æ•´ä¸ªå›¢é˜Ÿçš„ç¾éš¾

WMIåé—¨wmiçš„é€»è¾‘ç»“æ„æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆæ˜¯wmiä½¿ç”¨è€…ï¼Œæ¯”å¦‚è„šæœ¬æˆ–è€…å…¶ä»–ç”¨åˆ°wmiæ¥å£çš„åº”ç”¨ç¨‹åºã€‚ç”±wmiä½¿ç”¨è€…è®¿é—®CIMå¯¹è±¡ç®¡ç†å™¨WinMgmtï¼ˆå³WMIæœåŠ¡ï¼‰ï¼Œåè€…å†è®¿é—®CIMï¼ˆå…¬å…±ä¿¡æ¯æ¨¡å‹Common Information Modelï¼‰å­˜å‚¨åº“ã€‚
é™æ€æˆ–åŠ¨æ€çš„ä¿¡æ¯ï¼ˆå¯¹è±¡çš„å±æ€§ï¼‰å°±ä¿å­˜åœ¨CIMåº“ä¸­ï¼ŒåŒæ—¶ä¿å­˜å¯¹è±¡çš„æ–¹æ³•ã€‚æ¯”å¦‚å¯åŠ¨ä¸€ä¸ªæœåŠ¡ï¼Œé€šè¿‡æ‰§è¡Œå¯¹è±¡çš„æ–¹æ³•å®ç°ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡COMæŠ€æœ¯è°ƒç”¨å„ç§dllï¼Œæœ€åç”±dllä¸­å°è£…çš„APIå®Œæˆè¯·æ±‚ã€‚WMIæ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œæ“ä½œç³»ç»Ÿã€æœåŠ¡ã€åº”ç”¨ç¨‹åºã€è®¾å¤‡é©±åŠ¨ç¨‹åºç­‰éƒ½å¯ä»¥ä½œä¸ºäº‹ä»¶æºï¼Œé€šè¿‡COMæ¥å£ç”Ÿæˆäº‹ä»¶é€šçŸ¥ï¼ŒWinMgmtæ•æ‰åˆ°äº‹ä»¶ï¼Œç„¶ååˆ·æ–°CIMåº“ä¸­çš„åŠ¨æ€ä¿¡æ¯ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆWMIæœåŠ¡ä¾èµ–äºEventLogçš„åŸå› ã€‚å°±åƒæ³¨å†Œè¡¨æœ‰æ ¹é”®ä¸€æ ·ï¼ŒCIMåº“ä¹Ÿæœ‰åˆ†ç±»ï¼Œç”¨é¢å‘å¯¹è±¡çš„æœ¯è¯­æè¿°æ¥æ¥è¯´ï¼Œå«åšå‘½åç©ºé—´(Name Spaceï¼‰
http://huaidan.org/archives/1087.html
å¯ä»¥è°ƒç”¨wmiçš„æ–¹å¼æˆ–è€…è¯­è¨€:
* wmic.exe
* winrm.exe
* winrs.exe
* powershell
* windows scripting host(WSH)
   * VBScript
   * JScript
* mof
* C&amp;#x2F;C++ via IWbem* COM API
* .NET System.Management classes



å•ä¸€ç‚¹ï¼šä¸€ä¸ªå®šæ—¶åŠŸèƒ½åé—¨çš„wmiï¼Œå…¶ä¸­çš„äº‹ä»¶è¿‡æ»¤æ˜¯ç”¨WQLæŸ¥è¯¢æ¥è§¦å‘ï¼Œwooyunä¸Šé¢æ²¹ä¸‰ç§è§¦å‘æ–¹å¼:
WSH"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="WMIå­¦ä¹ ç¬”è®°"/>
  <meta property="og:site_name" content="ğŸ˜Š#"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  

  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="stylesheet" href="/css/prism-atom-dark.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism-line-numbers.css" media="screen" type="text/css">
  <script src="/js/jquery-2.0.3.min.js"></script>
<!--   <script src="/js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <link rel="stylesheet" href="/css/highlight/styles/atom-one-dark.min.css" media="screen" type="text/css"> -->

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="ğŸ˜Š#" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">ğŸ˜Š#</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/project" title="All the categories.">
			  <i class=""></i>Projects
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> WMIå­¦ä¹ ç¬”è®°</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h3 id="windowsä¸‹çš„å®šæ—¶ä»»åŠ¡"><a href="#windowsä¸‹çš„å®šæ—¶ä»»åŠ¡" class="headerlink" title="windowsä¸‹çš„å®šæ—¶ä»»åŠ¡"></a>windowsä¸‹çš„å®šæ—¶ä»»åŠ¡</h3><blockquote>
<p>ç»´æŒæƒé™çš„è¯è¿˜æ˜¯è€ƒè™‘WMIäº‹ä»¶æˆ–è€…åœ¨æœåŠ¡ä¸Šä¸‹æ‰‹.  å¦‚åŠ«æŒç›¸å…³æœåŠ¡æŒ‡å‘çš„ç¨‹åºï¼Œæœªè¢«åŒå¼•å·ä¿æŠ¤çš„è·¯å¾„ç­‰ï¼Œæ·»åŠ è®¡åˆ’ä»»åŠ¡ä¸€æ—¦è¢«æŠ¥è­¦.å°±æ˜¯æ•´ä¸ªå›¢é˜Ÿçš„ç¾éš¾</p>
</blockquote>
<h2 id="WMIåé—¨"><a href="#WMIåé—¨" class="headerlink" title="WMIåé—¨"></a>WMIåé—¨</h2><p>wmiçš„é€»è¾‘ç»“æ„æ˜¯è¿™æ ·çš„ï¼š<br>é¦–å…ˆæ˜¯wmiä½¿ç”¨è€…ï¼Œæ¯”å¦‚è„šæœ¬æˆ–è€…å…¶ä»–ç”¨åˆ°wmiæ¥å£çš„åº”ç”¨ç¨‹åºã€‚ç”±wmiä½¿ç”¨è€…è®¿é—®CIMå¯¹è±¡ç®¡ç†å™¨WinMgmtï¼ˆå³WMIæœåŠ¡ï¼‰ï¼Œåè€…å†è®¿é—®CIMï¼ˆå…¬å…±ä¿¡æ¯æ¨¡å‹Common Information Modelï¼‰å­˜å‚¨åº“ã€‚</p>
<p>é™æ€æˆ–åŠ¨æ€çš„ä¿¡æ¯ï¼ˆå¯¹è±¡çš„å±æ€§ï¼‰å°±ä¿å­˜åœ¨CIMåº“ä¸­ï¼ŒåŒæ—¶ä¿å­˜å¯¹è±¡çš„æ–¹æ³•ã€‚æ¯”å¦‚å¯åŠ¨ä¸€ä¸ªæœåŠ¡ï¼Œé€šè¿‡æ‰§è¡Œå¯¹è±¡çš„æ–¹æ³•å®ç°ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡COMæŠ€æœ¯è°ƒç”¨å„ç§dllï¼Œæœ€åç”±dllä¸­å°è£…çš„APIå®Œæˆè¯·æ±‚ã€‚WMIæ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œæ“ä½œç³»ç»Ÿã€æœåŠ¡ã€åº”ç”¨ç¨‹åºã€è®¾å¤‡é©±åŠ¨ç¨‹åºç­‰éƒ½å¯ä»¥ä½œä¸ºäº‹ä»¶æºï¼Œé€šè¿‡COMæ¥å£ç”Ÿæˆäº‹ä»¶é€šçŸ¥ï¼ŒWinMgmtæ•æ‰åˆ°äº‹ä»¶ï¼Œç„¶ååˆ·æ–°CIMåº“ä¸­çš„åŠ¨æ€ä¿¡æ¯ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆWMIæœåŠ¡ä¾èµ–äºEventLogçš„åŸå› ã€‚å°±åƒæ³¨å†Œè¡¨æœ‰æ ¹é”®ä¸€æ ·ï¼ŒCIMåº“ä¹Ÿæœ‰åˆ†ç±»ï¼Œç”¨é¢å‘å¯¹è±¡çš„æœ¯è¯­æè¿°æ¥æ¥è¯´ï¼Œå«åšå‘½åç©ºé—´(Name Spaceï¼‰</p>
<p><a target="_blank" rel="noopener" href="http://huaidan.org/archives/1087.html">http://huaidan.org/archives/1087.html</a></p>
<p>å¯ä»¥è°ƒç”¨wmiçš„æ–¹å¼æˆ–è€…è¯­è¨€:</p>
<pre class="line-numbers language-none"><code class="language-none">* wmic.exe
* winrm.exe
* winrs.exe
* powershell
* windows scripting host(WSH)
   * VBScript
   * JScript
* mof
* C&#x2F;C++ via IWbem* COM API
* .NET System.Management classes
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>å•ä¸€ç‚¹ï¼š<br>ä¸€ä¸ªå®šæ—¶åŠŸèƒ½åé—¨çš„wmiï¼Œå…¶ä¸­çš„äº‹ä»¶è¿‡æ»¤æ˜¯ç”¨WQLæŸ¥è¯¢æ¥è§¦å‘ï¼Œwooyunä¸Šé¢æ²¹ä¸‰ç§è§¦å‘æ–¹å¼:</p>
<h3 id="WSH"><a href="#WSH" class="headerlink" title="WSH"></a>WSH</h3><p>WSHå¸¸ç”¨çš„å¯¹è±¡ï¼š</p>
<p>####WScript<br>windowsè„šæœ¬å®¿ä¸»å¯¹è±¡æ¨¡å‹çš„æ ¹å¯¹è±¡ï¼Œå®ƒèƒ½æä¾›å¤šä¸ªå­å¯¹è±¡ï¼Œæ¯”å¦‚Wscript.Argumentså’ŒWscript.shellï¼Œå‰è€…æä¾›å¯¹æ•´ä¸ªå‘½ä»¤è¡Œå‚æ•°é›†çš„è®¿é—®ï¼Œåè€…å¯ä»¥è¿è¡Œç¨‹åºï¼Œæ“ä½œæ³¨å†Œè¡¨ï¼Œåˆ›å»ºå¿«æ·æ–¹å¼æˆ–è®¿é—®ç³»ç»Ÿæ–‡ä»¶å¤¹ã€‚<br>####Scripting.FileSystemObject<br>ä¸»è¦ä¸ºIISè®¾è®¡çš„å¯¹è±¡ï¼Œè®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œå‡ ä¹æ‰€æœ‰çš„windowsè„šæœ¬ç—…æ¯’é€šè¿‡å®ƒå¤åˆ¶è‡ªå·±æ„ŸæŸ“åˆ«äººã€‚<br>####ADODB.Stream<br>ActiveX Data Objectsæ•°æ®åº“çš„å­—å¯¹è±¡ï¼Œæä¾›æµæ–¹å¼è®¿é—®æ–‡ä»¶çš„åŠŸèƒ½ã€‚<br>####microsoft.XMLHTP<br>ä¸ºäº†æ”¯æŒXMLè€Œè®¾è®¡çš„å¯¹è±¡ï¼Œé€šè¿‡httpåè®®è®¿é—®ç½‘ç»œï¼Œå¸¸ç”¨æˆ·è·¨ç«™è„šæœ¬æ‰§è¡Œæ¼æ´å’ŒSQL Injection<br>####ADSI(æ´»åŠ¨ç›®å½•æœåŠ¡æ¥å£ï¼Œä¸»è¦ç”¨äºwindowsåŸŸç®¡ç†)<br>####WBEMå¯¹è±¡ï¼ŒwmiæœåŠ¡æä¾›è¯¥å¯¹è±¡çš„æ¥å£</p>
<pre class="line-numbers language-none"><code class="language-none">strComputer &#x3D; &quot;.&quot;
Set objWMIService &#x3D; GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root\default&quot;)
Set colEvents &#x3D; objWMIService.ExecNotificationQuery _
    (&quot;SELECT * FROM RegistryKeyChangeEvent WHERE Hive&#x3D;&#39;HKEY_LOCAL_MACHINE&#39; AND &quot; &amp; _
        &quot;KeyPath&#x3D;&#39;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run&#39;&quot;) 
Do
    Set objLatestEvent &#x3D; colEvents.NextEvent
    Wscript.Echo Now &amp; &quot;: The registry has been modified.&quot;
Loop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>å¦‚ä¸‹ä¾‹å­ï¼švbsè„šæœ¬æ“ä½œwmiå¯¹è±¡çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§æ–¹æ³•<code>winmgmts:\\</code>å’Œ<code>WbemScripting.SWBemlocator</code></p>
<blockquote>
<p>not only throuth an SWbemLocator object, but also through the moniker â€œwinmgmts:â€. A moniker is a short name that locate a namespaceã€class or instance in WMI. The name â€œwinmgmts:â€ is the WMI moniker that tell the Windows Script Host to use the WMI objects, connects to the default namespace, and obtains an SWbemServices object.</p>
</blockquote>
<p>ä¸è¿‡è¿™ä¸¤è€…æ˜¯æœ‰å¼‚åŒçš„ï¼ŒSWbemlocatorå¯ä»¥åšåˆ°WMI monikerä¸èƒ½åšåˆ°çš„ä¸¤ä¸ªåŠŸèƒ½ï¼ˆSWbemlocator is designed to address two specific scripting scenarios that cannot be performed using GetObject and the WMI monikerï¼Œ You must use SWbemLocator if you need to)ï¼š</p>
<ol>
<li>provide user and password credentials to connect to WMI on a remote computer. The WMI moniker used with the GetObject function does not include a mechanism for specifying credentials.</li>
<li>Connect to WMI if you are runing a WMI script from within a Web page.</li>
</ol>
<p>åˆ›å»ºå¯¹è±¡å¹¶è¿æ¥æœåŠ¡å™¨ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">set objlocator&#x3D;createobject(&quot;wbemscripting.swbemlocator&quot;)
set objswbemservices&#x3D;objlocator.connectserver(ipaddress,&quot;root\default&quot;,username,password)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è®¿é—®WMIè¿˜æœ‰ä¸€ä¸ªç‰¹æƒçš„é¢é—®é¢˜ã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">objswbemservices.security_.privileges.add 23,true
objswbemservices.security_.privileges.add 18,true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>è¿™æ˜¯åœ¨å‘WMIæœåŠ¡ç”³è¯·æƒé™ï¼Œ18å’Œ23éƒ½æ˜¯æƒé™ä»£å·ï¼Œä»¥ä¸‹æ˜¯é‡è¦çš„ä»£å·:<br>5 åœ¨åŸŸä¸­åˆ›å»ºè´¦å·<br>7 ç®¡ç†å®¡è®¡å¹¶æŸ¥çœ‹ã€ä¿å­˜å’Œæ¸…ç†å®‰å…¨æ—¥å¿—<br>9 åŠ è½½å’Œå¸è½½è®¾å¤‡é©±åŠ¨<br>10 è®°å½•ç³»ç»Ÿæ—¶é—´<br>11 æ”¹å˜ç³»ç»Ÿæ—¶é—´<br>18 åœ¨æœ¬åœ°å…³æœº<br>22 ç»•è¿‡å†éæ£€æŸ¥<br>23 å…è®¸è¿œç¨‹å…³æœº</p>
<p>è¿è¡Œå¦‚ä¸‹è„šæœ¬å¯ä»¥è·å¾—æ‰€æœ‰æƒé™IDåŠå¯¹åº”è¯´æ˜</p>
<pre class="line-numbers language-none"><code class="language-none">strComputer &#x3D; &quot;.&quot;
set objWMIService &#x3D; GetObject(&quot;winmgmts:\\&quot; _
	&amp; strComputer &amp; &quot;\root\cimv2&quot;)
set colPrivileges &#x3D; objWMIService.Security_.Privileges
for I &#x3D; 1 to 27
colPrivileges.Add(I)
Next
&#39; Display information about each privilege 
For Each objItem In colPrivileges
wscript.echo objItem.Identifier &amp; vbtab &amp; objItem.Name _
    &amp; vbtab &amp; objItem.Displayname _
    &amp; vbtab &amp; &quot;Enabled &#x3D; &quot; &amp; objItem.IsEnabled
Next<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<pre class="line-numbers language-none"><code class="language-none">strComputer&#x3D;&quot;.&quot;
set objService &#x3D; GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root\cimv2&quot;)
&#39;set objWmi &#x3D; CreateObject(&quot;WbemScripting.SWBemLocator&quot;)
&#39;set objService &#x3D; objWmi.ConnectServer(strComputer, &quot;root\cimv2&quot;)
set objSet &#x3D; objService.InstancesOf(&quot;Win32_Process&quot;)
for each obj in objSet
    Wscript.Echo &quot;Name: &quot; &amp; obj.Name
Next<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>wmiæ˜¯äº‹ä»¶é©±åŠ¨ï¼Œæ•´ä¸ªäº‹ä»¶å¤„ç†æœºåˆ¶åˆ†4ä¸ªéƒ¨åˆ†:<br>1ã€äº‹ä»¶ç”Ÿäº§è€…ï¼ˆprovider)ï¼Œè´Ÿè´£ç”Ÿäº§äº‹ä»¶ã€‚WMIåŒ…å«å¤§é‡äº‹ä»¶ç”Ÿäº§è€…ã€‚<br>2ã€äº‹ä»¶è¿‡æ»¤å™¨(fileterï¼‰ï¼Œç³»ç»Ÿæ¯æ—¶æ¯åˆ»æœ‰å¤§é‡çš„äº‹ä»¶ï¼Œé€šè¿‡è‡ªå®šä¹‰è¿‡æ»¤å™¨ï¼Œè„šæœ¬å¯ä»¥æ•è·æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚<br>3ã€äº‹ä»¶æ¶ˆè´¹è€…ï¼ˆconsumer)ï¼šè´Ÿè´£å¤„ç†äº‹ä»¶ï¼Œä»–æ˜¯ç”±å¯æ‰§è¡Œç¨‹åºï¼ŒåŠ¨æ€é“¾æ¥åº“(dllï¼Œç”±wmiæœåŠ¡åŠ è½½)æˆ–è€…è„šæœ¬<br>4ã€äº‹ä»¶ç»‘å®š(bindingï¼‰ï¼šé€šè¿‡å°†è¿‡æ»¤å™¨å’Œæ¶ˆè´¹è€…ç»‘å®šï¼Œæ˜ç¡®ä»€ä¹ˆäº‹ä»¶ç”±ä»€ä¹ˆæ¶ˆè´¹è€…è´Ÿè´£å¤„ç†</p>
<p>äº‹ä»¶æ¶ˆè´¹è€…å¯ä»¥åˆ†ä¸ºä¸´æ—¶å’Œæ°¸ä¹…ä¸¤ç±»ï¼Œä¸´æ—¶çš„äº‹ä»¶æ¶ˆè´¹è€…åªåœ¨å…¶è¿è¡ŒæœŸé—´å…³å¿ƒç‰¹å®šäº‹ä»¶å¹¶å¤„ç†ï¼Œæ°¸ä¹…æ¶ˆè´¹è€…ä½œä¸ºç±»çš„å®ä¾‹æ³¨å†Œåœ¨WMIå‘½åç©ºé—´ä¸­ï¼Œä¸€ç›´æœ‰æ•ˆåˆ°å®ƒè¢«æ³¨é”€ã€‚</p>
<h4 id="EvenetFilter"><a href="#EvenetFilter" class="headerlink" title="EvenetFilter"></a>EvenetFilter</h4><p>1: Data queries</p>
<p><code>select * from Win32_NTlogEvent where logfile = &#39;application&#39;</code><br>è¾£ä¹ˆï¼Œä¸Šé¢è¿™ä¸ªè¯­å¥æ˜¯å¦å¯ä»¥ä¿®æ”¹ä¸‹ï¼Œç±»ä¼¼è¿œç¨‹æ§åˆ¶iptablesçš„æ–¹å¼ï¼Œå½“æ£€æµ‹åˆ°logfileé‡Œé¢å­˜åœ¨ç‰¹å®šå­—ç¬¦ï¼Œè§¦å‘äº‹ä»¶</p>
<p>2: Evenet queries</p>
<p><code>select * from __InstanceModificationEvent WITHIN 10 where TargetInstance ISA &#39;Win32_Service&#39; AND TargetInstance._Class = &#39;win32_TerminalService&#39;</code></p>
<p>3: Schema queries</p>
<p><code>select * from meta_class where __this ISA &quot;Win32_BaseService&quot;</code></p>
<h4 id="consumer"><a href="#consumer" class="headerlink" title="consumer"></a>consumer</h4><p>å¯ä»¥ç†è§£ä¸ºæ»¡è¶³æ¡ä»¶ä¹‹åæ‰§è¡Œçš„æ“ä½œï¼ŒåŒ…æ‹¬å¦‚ä¸‹æŸ¥è¯¢:</p>
<pre class="line-numbers language-none"><code class="language-none">ï¼ˆ1ï¼‰ ActiveScriptEventConsumer
 (2) LogFileEventConsumer
 (3) NTEventLogEventConsumer
 (4) SMTPEventConsumer
 (5) CommandLineEventConsumer
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>wmiéœ€è¦ä¸¤ä¸ªå¯ä»¥æ‰§è¡Œï¼ŒEventfilterå’Œconsumerã€‚</p>
<p>EventFilter</p>
<pre class="line-numbers language-none"><code class="language-none">select * from __InstanceModificationEvent where TargetInstance Isa &quot;Win32_localTime&quot; And TargetInstance.Second &#x3D; 1

select * from __InstanceModificationEvent WITHIN 10 where TargetInstance ISA &#39;Win32_Service&#39; AND TargetInstance._Class &#x3D; &#39;win32_TerminalService&#39;

select * from _InstanceModificationEvent within 5 where Targetinstance ISA &#39;Win32_service&#39; AND 
TargetInstance.name &#x3D; &#39;spooler&#39; and Targetinstatnce.state&#x3D;&#39;stopped&#39;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2003ç³»ç»Ÿä¸Šï¼Œä¸€ä¸ªç”¨æˆ·ç™»é™†çš„æ—¶å€™ï¼Œæ—¥å¿—è®°å½•IDæ˜¯680ï¼Œæ³¨é”€æ–­å¼€çš„æ—¶å€™IDæ˜¯551ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªç”¨æˆ·ç™»é™†çš„æ—¶å€™ï¼Œwmiç›‘æµ‹ç™»é™†idï¼Œå¦‚æœç™»é™†æˆåŠŸï¼Œæ€æ‰åä»¬å’ŒæŒ–çŸ¿è¿›ç¨‹ã€‚<br>æ€æ‰è¿›ç¨‹æœ‰è¿™ä¹ˆå‡ ä¸ªæ¡ä»¶ï¼Œä»»ä½•ä¸€ä¸ªæˆç«‹éƒ½æ€æ‰ï¼š</p>
<p>ç”¨æˆ·æˆåŠŸç™»é™†<br>æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨<br>æ‰“å¼€cmd</p>
<p>æ‰€ä»¥ï¼Œè¯´äº†è¿™ä¹ˆå¤šï¼Œè¿™ä¸ªvbsè„šæœ¬åº”è¯¥æ€ä¹ˆå†™ï¼Ÿ</p>
<ol>
<li>vbsè„šæœ¬è¿è¡Œå…¶ä»–ç¨‹åºï¼Œæ¯”å¦‚cmd</li>
<li>æ»¡è¶³æ¡ä»¶ä¹‹åç»‘å®šæ¶ˆè´¹äº‹ä»¶</li>
</ol>
<p>WMIæä¾›äº†ä¸¤ä¸ªè®¡æ—¶å™¨ï¼š<code>__AbsoluteTimerInstruction</code>å’Œ<code>__IntervalTimerInstruction</code></p>
<p>WMIæä¾›äº†ä¸‰ä¸ªç±»åˆ«çš„WQLæŸ¥è¯¢ï¼š</p>
<ol>
<li><p>å®ä¾‹æŸ¥è¯¢  ï¼ï¼ç”¨äºæŸ¥è¯¢WMIç±»çš„å®ä¾‹</p>
<pre class="line-numbers language-none"><code class="language-none">select &lt;class property name&gt; from &lt;class name&gt; where &lt;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>äº‹ä»¶æŸ¥è¯¢  ï¼ï¼ç”¨äºä¸€ä¸ªWMIäº‹ä»¶æ³¨å†Œæœºåˆ¶ï¼Œå¦‚WMIå¯¹è±¡çš„åˆ›å»ºï¼Œä¿®æ”¹æˆ–åˆ é™¤</p>
</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">äº¤äº’å¼ç”¨æˆ·ç™»å½•çš„äº‹ä»¶æŸ¥è¯¢ï¼š
SELECT * FROM __InstanceCreationEvent WITHIN 15 WHERE TargetInstance ISA &#39;Win32_LogonSession&#39; AND TargetInstance.LogonType &#x3D; 2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ol start="3">
<li>å…ƒæŸ¥è¯¢    ï¼ï¼ç”¨äºæŸ¥è¯¢WMIç±»æ¶æ„</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">select * from Meta_classes where __class like &quot;win32%&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>ä¾‹å­:</p>
<p>æ¯10sæŸ¥è¯¢ä¸€æ¬¡äº‹ä»¶ä¿®æ”¹ï¼Œè®°å½•</p>
<pre class="line-numbers language-none"><code class="language-none">strComputer &#x3D; &quot;.&quot; 
Set objWMIService &#x3D; GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root\cimv2&quot;) 
Set colMonitorProcess &#x3D; objWMIService.ExecNotificationQuery _ 
 (&quot;SELECT * FROM __instancemodificationevent WITHIN 10&quot; &amp; _ 
 &quot;WHERE TargetInstance ISA &#39;Win32_Service&#39;&quot;)  
WScript.Echo &quot;Waiting for process change event ...&quot; 
Set objLatestEvent &#x3D; colMonitorProcess.NextEvent 
WScript.Echo VbCrLf &amp; objLatestEvent.Path_.Class 
Wscript.Echo &quot;Process Name: &quot; &amp; objLatestEvent.TargetInstance.Name 
Wscript.Echo &quot;Process ID: &quot; &amp; objLatestEvent.TargetInstance.ProcessId 
Wscript.Echo &quot;Process State:&quot; &amp; objLatestEvent.TargetInstance.state
WScript.Echo &quot;Time: &quot; &amp; Now <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>ä»¥ä¸‹æ¥è‡ªé¬¼å“¥çš„æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="http://huaidan.org/archives/1087.html">http://huaidan.org/archives/1087.html</a></p>
<p>ç¨å¾®ä¿®æ”¹äº†ä¸‹ï¼Œå¤§æ¦‚åŠŸèƒ½å°±æ˜¯æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨çš„æ—¶å€™ï¼Œ5sä¹‹å†…ä¼šæ‰“å¼€calc.exeï¼Œè¿™ä¸ªåŠ¨ä½œå¯ä»¥åœ¨process exploreré‡Œé¢ç›‘æµ‹åˆ°ã€‚<br>è„šæœ¬ç¨å¾®ä¸åŒçš„åœ°æ–¹æ˜¯:</p>
<p><code>__EventFilter</code>çš„æ—¶å€™ï¼Œè¦åˆ¶å®šå‘½åç©ºé—´ä¸º<code>root\cimv2</code>,æ•´ä¸ªè„šæœ¬æ˜¯æ³¨å†Œåœ¨<code>root\subscription</code>é‡Œé¢çš„ã€‚</p>
<p>ä¸€å¥è¯:<br>ä»¥<code>root\cimv2</code>ç©ºé—´çš„äº‹ä»¶ä¸ºé©±åŠ¨ï¼Œä½¿ç”¨<code>root\subscription</code>ç©ºé—´é‡Œé¢çš„<code>CommandLineEventConsumer</code>æ¥è¿è¡Œç¨‹åºã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">nslink&#x3D;&quot;winmgmts:\\.\root\cimv2:&quot;         &#39;åªéœ€è¦æœ¬åœ°è¿æ¥ï¼Œæ‰€ä»¥ç”¨è¿™ç§è¯­æ³•ï¼Œä¸ç”¨swbemlocatorå¯¹è±¡&#39;
nslink2&#x3D;&quot;winmgmts:\\.\root\subscription:&quot;
set asec&#x3D;getobject(nslink2&amp;&quot;CommandLineEventConsumer&quot;).spawninstance_   &#39;åˆ›å»ºâ€œæ´»åŠ¨è„šæœ¬äº‹ä»¶æ¶ˆè´¹è€…â€&#39;
asec.name&#x3D;&quot;stopped_spooler_restart_consumer&quot;                  &#39;å®šä¹‰æ¶ˆè´¹è€…çš„åå­—&#39;
&#39;asec.scriptingengine&#x3D;&quot;vbscript&quot;                               &#39;å®šä¹‰è„šæœ¬è¯­è¨€(åªèƒ½æ˜¯vbscript)&#39;
asec.CommandLineTemplate&#x3D;&quot;C:\windows\system32\calc.exe&quot;  &#39;è„šæœ¬ä»£ç &#39;
asec.ExecutablePath&#x3D;&quot;C:\windows\system32\calc.exe&quot;
set asecpath&#x3D;asec.put_                                        &#39;æ³¨å†Œæ¶ˆè´¹è€…ï¼Œè¿”å›å…¶é“¾æ¥&#39;

set evtflt&#x3D;getobject(nslink2&amp;&quot;__EventFilter&quot;).spawninstance_   &#39;åˆ›å»ºäº‹ä»¶è¿‡æ»¤å™¨&#39;
evtflt.name&#x3D;&quot;stopped_spooler_filter&quot; 
evtflt.EventNameSpace&#x3D;&quot;root\cimv2&quot;                         &#39;å®šä¹‰è¿‡æ»¤å™¨çš„åå­—&#39;
qstr&#x3D;&quot;select * from __InstanceCreationEvent within 5 &quot;    &#39;æ¯5ç§’æŸ¥è¯¢ä¸€æ¬¡â€œå®ä¾‹ä¿®æ”¹äº‹ä»¶â€&#39;
qstr&#x3D;qstr&amp;&quot;where targetinstance isa &#39;win32_process&#39; and &quot;   &#39;ç›®æ ‡å®ä¾‹çš„ç±»æ˜¯win32_process&#39;
qstr&#x3D;qstr&amp;&quot;targetinstance.name&#x3D;&#39;taskmgr.exe&#39; &quot;                  &#39;å®ä¾‹åæ˜¯taskmgr.exe&#39;
evtflt.query&#x3D;qstr                                             &#39;å®šä¹‰æŸ¥è¯¢è¯­å¥&#39;
evtflt.querylanguage&#x3D;&quot;wql&quot;                                    &#39;å®šä¹‰æŸ¥è¯¢è¯­è¨€(åªèƒ½æ˜¯wql)&#39;
set fltpath&#x3D;evtflt.put_                                       &#39;æ³¨å†Œè¿‡æ»¤å™¨ï¼Œè¿”å›å…¶é“¾æ¥&#39;

set fcbnd&#x3D;getobject(nslink2&amp;&quot;__FilterToConsumerBinding&quot;).spawninstance_  &#39;åˆ›å»ºè¿‡æ»¤å™¨å’Œæ¶ˆè´¹è€…çš„ç»‘å®š&#39;
fcbnd.consumer&#x3D;asecpath.path                                            &#39;æŒ‡å®šæ¶ˆè´¹è€…&#39;
fcbnd.filter&#x3D;fltpath.path                                               &#39;æŒ‡å®šè¿‡æ»¤å™¨&#39;
fcbnd.put_                                                              &#39;æ‰§è¡Œç»‘å®š&#39;

wscript.echo &quot;success&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šé¢æåˆ°è¿‡æœ‰5ç§æ¶ˆè´¹è€…ï¼Œç„¶åè¿™æ¬¡ä»¥LogFileEventConsumeræ¥æµ‹è¯•ï¼Œæ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨ä¹‹åï¼Œåœ¨Cç›˜æ ¹ç›®å½•ä¸‹ç”Ÿæˆ1.phpï¼Œå†…å®¹æ˜¯<code>&lt;?php phpinfo();?&gt;</code>:</p>
<pre class="line-numbers language-none"><code class="language-none">nslink&#x3D;&quot;winmgmts:\\.\root\cimv2:&quot;         &#39;åªéœ€è¦æœ¬åœ°è¿æ¥ï¼Œæ‰€ä»¥ç”¨è¿™ç§è¯­æ³•ï¼Œä¸ç”¨swbemlocatorå¯¹è±¡&#39;
nslink2&#x3D;&quot;winmgmts:\\.\root\subscription:&quot;
set asec&#x3D;getobject(nslink2&amp;&quot;LogFileEventConsumer&quot;).spawninstance_   &#39;åˆ›å»ºâ€œæ´»åŠ¨è„šæœ¬äº‹ä»¶æ¶ˆè´¹è€…â€&#39;
asec.name&#x3D;&quot;stopped_spooler_restart_consumer&quot;                  &#39;å®šä¹‰æ¶ˆè´¹è€…çš„åå­—&#39;
&#39;asec.scriptingengine&#x3D;&quot;vbscript&quot;                               &#39;å®šä¹‰è„šæœ¬è¯­è¨€(åªèƒ½æ˜¯vbscript)&#39;
&#39;asec.CommandLineTemplate&#x3D;&quot;C:\windows\system32\calc.exe&quot;  &#39;è„šæœ¬ä»£ç &#39;
&#39;asec.ExecutablePath&#x3D;&quot;C:\windows\system32\calc.exe&quot;
asec.Filename&#x3D;&quot;C:\1.php&quot;
asec.Text&#x3D;&quot;&lt;?php phpinfo();?&gt;&quot;
set asecpath&#x3D;asec.put_                                        &#39;æ³¨å†Œæ¶ˆè´¹è€…ï¼Œè¿”å›å…¶é“¾æ¥&#39;

set evtflt&#x3D;getobject(nslink2&amp;&quot;__EventFilter&quot;).spawninstance_   &#39;åˆ›å»ºäº‹ä»¶è¿‡æ»¤å™¨&#39;
evtflt.name&#x3D;&quot;stopped_spooler_filter&quot; 
evtflt.EventNameSpace&#x3D;&quot;root\cimv2&quot;                         &#39;å®šä¹‰è¿‡æ»¤å™¨çš„åå­—&#39;
qstr&#x3D;&quot;select * from __InstanceCreationEvent within 5 &quot;    &#39;æ¯5ç§’æŸ¥è¯¢ä¸€æ¬¡â€œå®ä¾‹ä¿®æ”¹äº‹ä»¶â€&#39;
qstr&#x3D;qstr&amp;&quot;where targetinstance isa &#39;win32_process&#39; and &quot;   &#39;ç›®æ ‡å®ä¾‹çš„ç±»æ˜¯win32_service&#39;
qstr&#x3D;qstr&amp;&quot;targetinstance.name&#x3D;&#39;taskmgr.exe&#39; &quot;                  &#39;å®ä¾‹åæ˜¯spooler&#39;
evtflt.query&#x3D;qstr                                             &#39;å®šä¹‰æŸ¥è¯¢è¯­å¥&#39;
evtflt.querylanguage&#x3D;&quot;wql&quot;                                    &#39;å®šä¹‰æŸ¥è¯¢è¯­è¨€(åªèƒ½æ˜¯wql)&#39;
set fltpath&#x3D;evtflt.put_                                       &#39;æ³¨å†Œè¿‡æ»¤å™¨ï¼Œè¿”å›å…¶é“¾æ¥&#39;

set fcbnd&#x3D;getobject(nslink2&amp;&quot;__FilterToConsumerBinding&quot;).spawninstance_  &#39;åˆ›å»ºè¿‡æ»¤å™¨å’Œæ¶ˆè´¹è€…çš„ç»‘å®š&#39;
fcbnd.consumer&#x3D;asecpath.path                                            &#39;æŒ‡å®šæ¶ˆè´¹è€…&#39;
fcbnd.filter&#x3D;fltpath.path                                               &#39;æŒ‡å®šè¿‡æ»¤å™¨&#39;
fcbnd.put_                                                              &#39;æ‰§è¡Œç»‘å®š&#39;

wscript.echo &quot;success&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>wmiç›‘å¬ç”¨æˆ·ç™»å½•å’Œæ³¨é”€äº‹ä»¶ï¼š</p>
<p>2003ç³»ç»Ÿä¸Šï¼Œä¸€ä¸ªç”¨æˆ·ç™»é™†çš„æ—¶å€™ï¼Œæ—¥å¿—è®°å½•IDæ˜¯680ï¼Œæ³¨é”€æ–­å¼€çš„æ—¶å€™IDæ˜¯551ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªç”¨æˆ·ç™»é™†çš„æ—¶å€™ï¼Œwmiç›‘æµ‹ç™»é™†idï¼Œå¦‚æœç™»é™†æˆåŠŸï¼Œæ‰“å¼€calc.exeï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">nslink&#x3D;&quot;winmgmts:\\.\root\cimv2:&quot;         &#39;åªéœ€è¦æœ¬åœ°è¿æ¥ï¼Œæ‰€ä»¥ç”¨è¿™ç§è¯­æ³•ï¼Œä¸ç”¨swbemlocatorå¯¹è±¡&#39;
nslink2&#x3D;&quot;winmgmts:\\.\root\subscription:&quot;
set asec&#x3D;getobject(nslink2&amp;&quot;CommandLineEventConsumer&quot;).spawninstance_   &#39;åˆ›å»ºâ€œæ´»åŠ¨è„šæœ¬äº‹ä»¶æ¶ˆè´¹è€…â€&#39;
asec.name&#x3D;&quot;stopped_spooler_restart_consumer&quot;                  &#39;å®šä¹‰æ¶ˆè´¹è€…çš„åå­—&#39;
&#39;asec.scriptingengine&#x3D;&quot;vbscript&quot;                               &#39;å®šä¹‰è„šæœ¬è¯­è¨€(åªèƒ½æ˜¯vbscript)&#39;
asec.CommandLineTemplate&#x3D;&quot;C:\windows\system32\calc.exe&quot;  &#39;è„šæœ¬ä»£ç &#39;
set asecpath&#x3D;asec.put_                                        &#39;æ³¨å†Œæ¶ˆè´¹è€…ï¼Œè¿”å›å…¶é“¾æ¥&#39;

set evtflt&#x3D;getobject(nslink2&amp;&quot;__EventFilter&quot;).spawninstance_   &#39;åˆ›å»ºäº‹ä»¶è¿‡æ»¤å™¨&#39;
evtflt.name&#x3D;&quot;stopped_spooler_filter&quot; 
evtflt.EventNameSpace&#x3D;&quot;root\cimv2&quot;                         &#39;å®šä¹‰è¿‡æ»¤å™¨çš„åå­—&#39;
qstr&#x3D;&quot;select * from __InstanceCreationEvent within 5 &quot;    &#39;æ¯5ç§’æŸ¥è¯¢ä¸€æ¬¡â€œå®ä¾‹ä¿®æ”¹äº‹ä»¶â€&#39;
qstr&#x3D;qstr&amp;&quot;where targetinstance isa &#39;win32_NTLogEvent&#39; and &quot;   qstr&#x3D;qstr&amp;&quot;targetinstance.EventCode&#x3D;&#39;680&#39; &quot;                  &#39;å®ä¾‹åæ˜¯win32_NTLogEvent&#39;
evtflt.query&#x3D;qstr                                             &#39;å®šä¹‰æŸ¥è¯¢è¯­å¥&#39;
evtflt.querylanguage&#x3D;&quot;wql&quot;                                    &#39;å®šä¹‰æŸ¥è¯¢è¯­è¨€(åªèƒ½æ˜¯wql)&#39;
set fltpath&#x3D;evtflt.put_                                       &#39;æ³¨å†Œè¿‡æ»¤å™¨ï¼Œè¿”å›å…¶é“¾æ¥&#39;

set fcbnd&#x3D;getobject(nslink2&amp;&quot;__FilterToConsumerBinding&quot;).spawninstance_  &#39;åˆ›å»ºè¿‡æ»¤å™¨å’Œæ¶ˆè´¹è€…çš„ç»‘å®š&#39;
fcbnd.consumer&#x3D;asecpath.path                                            &#39;æŒ‡å®šæ¶ˆè´¹è€…&#39;
fcbnd.filter&#x3D;fltpath.path                                               &#39;æŒ‡å®šè¿‡æ»¤å™¨&#39;
fcbnd.put_                                                              &#39;æ‰§è¡Œç»‘å®š&#39;

wscript.echo &quot;success&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-none"><code class="language-none">åœ¨æ¯åˆ†é’Ÿçš„ç¬¬5sä¹‹è¡Œä¸€æ¬¡
select * from __instanceModificationEvent where targetinstance ISA &#39;win32_localtime&#39; and targetinstance.Second&#x3D;5
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>wmiå¯¹è±¡åœ¨ç¡¬ç›˜ä¸­æ˜¯å­˜å‚¨åœ¨<code>C:\Windows\System32\wbem\Repository\fs\objects.data</code></p>
<h2 id="é—ç•™é—®é¢˜"><a href="#é—ç•™é—®é¢˜" class="headerlink" title="é—ç•™é—®é¢˜:"></a>é—ç•™é—®é¢˜:</h2><p>å¾®è½¯çš„å®˜ç½‘æœ‰è¿™ä¹ˆä¸€æ®µè¯:</p>
<blockquote>
<p>A single event filter can be associated with multiple logical event consumer. Furthermore, multiple event filters can be associated with a single logical event consumer.</p>
</blockquote>
<p>å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥å¯¹åº”ä¸€ä¸ªfilterï¼Œå¤šä¸ªfilterä¹Ÿå¯ä»¥å¯¹åº”ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚ä½†æ˜¯å®é™…æµ‹è¯•å¹¶æ²¡æœ‰æˆåŠŸï¼Œåœ¨å¤šä¸ªfilterå­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹æœªè¾¾åˆ°æœŸæœ›ï¼Œæµ‹è¯•ä»£ç :</p>
<p>æµ‹è¯•æœŸæœ›æ˜¯5sä¹‹å†…æ‰“å¼€cmdå’Œtaskmgrçš„æ—¶å€™ä¼šæ‰“å¼€calc.exeï¼Œå®é™…æµ‹è¯•æœªæˆåŠŸã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">
nslink&#x3D;&quot;winmgmts:\\.\root\cimv2:&quot;         
nslink2&#x3D;&quot;winmgmts:\\.\root\subscription:&quot;
set asec&#x3D;getobject(nslink2&amp;&quot;CommandLineEventConsumer&quot;).spawninstance_   
asec.name&#x3D;&quot;taskmgr_consumer&quot;                                                
asec.CommandLineTemplate&#x3D;&quot;cmd &#x2F;C calc.exe&quot;  
set asecpath&#x3D;asec.put_                                        

set evtflt&#x3D;getobject(nslink2&amp;&quot;__EventFilter&quot;).spawninstance_   
evtflt.name&#x3D;&quot;taskmgr&quot; 
evtflt.EventNameSpace&#x3D;&quot;root\cimv2&quot;                         
qstr&#x3D;&quot;select * from __InstanceCreationEvent within 5 &quot;    
qstr&#x3D;qstr&amp;&quot;where targetinstance isa &#39;win32_process&#39; and &quot;   
qstr&#x3D;qstr&amp;&quot;targetinstance.name&#x3D;&#39;taskmgr.exe&#39;&quot;                
evtflt.query&#x3D;qstr                                             
evtflt.querylanguage&#x3D;&quot;wql&quot;                                    
set fltpath&#x3D;evtflt.put_                                       


&#39;set evtflt2&#x3D;getobject(nslink2&amp;&quot;__EventFilter&quot;).spawninstance_   
&#39;evtflt2.name&#x3D;&quot;taskmgr2&quot; 
&#39;evtflt2.EventNameSpace&#x3D;&quot;root\cimv2&quot;                         
&#39;qstr2&#x3D;&quot;select * from __InstanceCreationEvent within 5 &quot;    
&#39;qstr2&#x3D;qstr2&amp;&quot;where targetinstance isa &#39;win32_process&#39; and &quot;   
&#39;qstr2&#x3D;qstr2&amp;&quot;targetinstance.name&#x3D;&#39;cmd.exe&#39; &quot;                
&#39;evtflt2.query&#x3D;qstr2                                             
&#39;evtflt2.querylanguage&#x3D;&quot;wql&quot;                                    
&#39;set fltpath2&#x3D;evtflt2.put_  

set fcbnd&#x3D;getobject(nslink2&amp;&quot;__FilterToConsumerBinding&quot;).spawninstance_  
fcbnd.consumer&#x3D;asecpath.path                                            
fcbnd.filter&#x3D;fltpath.path                                               
fcbnd.put_                
&#39;fcbnd.filter&#x3D;fltpath2.path
&#39;fcbnd.put_                                              
wscript.echo &quot;success&quot;

&#39;set fcbnd&#x3D;getobject(nslink2&amp;&quot;__FilterToConsumerBinding&quot;).spawninstance_  
&#39;fcbnd.consumer&#x3D;asecpath.path                                            
&#39;fcbnd.filter&#x3D;fltpath2.path                                               
&#39;fcbnd.put_                                                              
&#39;wscript.echo &quot;success2&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>ä¸‹é¢è¿™ä¸ªè„šæœ¬æ˜¯ç”¨æ¥ç›‘æ§äº‹ä»¶å˜åŒ–çš„ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è‡ªå·±ä¿®æ”¹ã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">strComputer &#x3D; &quot;.&quot; 
Set objWMIService &#x3D; GetObject(&quot;winmgmts:\\&quot; &amp; strComputer &amp; &quot;\root\cimv2&quot;) 
Set colMonitorProcess &#x3D; objWMIService.ExecNotificationQuery _ 
 (&quot;SELECT * FROM __instanceCreationEvent WITHIN 5&quot; &amp; _ 
 &quot;WHERE TargetInstance ISA &#39;win32_NTLogEvent&#39;&quot;)  
WScript.Echo &quot;Waiting for process change event ...&quot; 
while 1&gt;0
Set objLatestEvent &#x3D; colMonitorProcess.NextEvent 
WScript.Echo VbCrLf &amp; objLatestEvent.Path_.Class 
Wscript.Echo &quot;Process Name: &quot; &amp; objLatestEvent.TargetInstance.EventCode 
Wscript.Echo &quot;Process ID: &quot; &amp; objLatestEvent.TargetInstance.Categorystring 
WScript.Echo &quot;Time: &quot; &amp; Now 
wend
&#39;__instanceDeletionEvent
&#39;__instanceModificationEvent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/mt703459(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/mt703459(v=vs.85).aspx</a></li>
<li><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/aa393719(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/aa393719(v=vs.85).aspx</a></li>
<li><a target="_blank" rel="noopener" href="http://wooyun.jozxing.cc/static/drops/tips-8189.html">http://wooyun.jozxing.cc/static/drops/tips-8189.html</a></li>
<li><a target="_blank" rel="noopener" href="http://wooyun.jozxing.cc/static/drops/tips-12354.html">http://wooyun.jozxing.cc/static/drops/tips-12354.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sans.org/summit-archives/file/summit-archive-1492184420.pdf">https://www.sans.org/summit-archives/file/summit-archive-1492184420.pdf</a></li>
</ul>

	  <div class="article-footer-copyright">

    æœ¬åšå®¢é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®(CC BY-NC-SA 4.0) å‘å¸ƒ.</a>
</div>

	</div>

	
	<span id="/2017/07/12/wmi.html" class="leancloud-visitors view" data-flag-title="WMIå­¦ä¹ ç¬”è®°">
		<em class="post-meta-item-text"> Page View </em> <i class="leancloud-visitors-count"></i>
	</span>
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2017/08/12/ew-slave.html" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2017/05/24/schtaskså®šæ—¶åé—¨.html" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2017-07-12 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Pentest/">Pentest<span>43</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#windows%E4%B8%8B%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-article-text">windowsä¸‹çš„å®šæ—¶ä»»åŠ¡</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#WMI%E5%90%8E%E9%97%A8"><span class="toc-article-text">WMIåé—¨</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#WSH"><span class="toc-article-text">WSH</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#EvenetFilter"><span class="toc-article-text">EvenetFilter</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#consumer"><span class="toc-article-text">consumer</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E9%81%97%E7%95%99%E9%97%AE%E9%A2%98"><span class="toc-article-text">é—ç•™é—®é¢˜:</span></a>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2022 JKme's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>â¬†ï¸TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
