<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>SIEM On ELK | ğŸ˜Š#</title>
  <meta name="author" content="JKme">
  
  <meta name="description" content="å®‰è£…å‚è€ƒé“¾æ¥é‡Œæœ‰è¯¦ç»†çš„å®‰è£…æ­¥éª¤ï¼Œæµ‹è¯•å®¢æˆ·ç«¯æ˜¯Windowsï¼Œå®‰è£…äº†å¦‚ä¸‹è½¯ä»¶ï¼š

sysmon.exe(é…ç½®æ–‡ä»¶)
.\sysmon64.exe -accepteula -i c:\windows\config.xml


winlogbeat.exe
.\install-service-winlogbeat.ps1
.\winlogbeat.exe setup -e


ElasticAgent.exe
.\elastic-agent.exe install  --insecure -f --fleet-server-es=&amp;lt;ES&amp;gt; --fleet-server-service-token=&amp;lt;token&amp;gt;



è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡è§„åˆ™æœ‰5ç§æŸ¥è¯¢ï¼Œä¸€èˆ¬ä½¿ç”¨EQL(Event Query Language)æŸ¥è¯¢ç±»å‹:SIEMæœ‰å†…ç½®å¾ˆå¤šè§„åˆ™ï¼Œé»˜è®¤æ˜¯å…³é—­çŠ¶æ€ï¼Œè¿™äº›è§„åˆ™éƒ½æ˜¯ATT&amp;amp;CKæ¡†æ¶æ”»å‡»è¡Œä¸ºè½¬åŒ–è€Œæ¥çš„ï¼Œä¾‹å¦‚windowsä¸‹çš„whoamiæŸ¥è¯¢è§„åˆ™(æ­£ç»äººè°æŸ¥whoamiå•Š):
process where event.type in (&amp;quot;start&amp;quot;, &amp;quot;process_started&amp;quot;) and process.name : &amp;quot;whoami.exe&amp;quot;
æˆ‘ä»¬æ‹¿è¿™æ¡è§„åˆ™åšåˆ†æï¼Œè¿™æ¡è§„åˆ™åŒ¹é…äº†å½“è¿›ç¨‹å¼€å§‹çš„æ—¶å€™ï¼Œè¿›ç¨‹åä¸ºwhoami.exeçš„æ—¶å€™è§¦å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠwhoami.exeå¤åˆ¶ä¸€ä¸‹ï¼Œå°±å¯ä»¥ç»•è¿‡å»äº†:
copy C:\Windows\System32\whoami.exe C:\Windows\temp\x.exe
C:\Windows\temp\x.exe
æ˜¯ä¸æ˜¯æŠŠsiemæƒ³çš„ç®€å•äº†ï¼Œè¿™è·Ÿé€šè¿‡å¤åˆ¶net.exeç»•è¿‡æ·»åŠ ç”¨æˆ·ä¸€æ¨¡ä¸€æ ·ï¼Œä»”ç»†è§‚å¯Ÿä¸‹elké‡Œé¢çš„å­—æ®µï¼Œå¯ä»¥å‘ç°process.pe.original_file_nameä»ç„¶ä¿ç•™äº†whoami.exeï¼Œè¿™æ˜¯PEæ–‡ä»¶é‡Œé¢å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨æŠŠé¢„è­¦è§„åˆ™ä¿®æ”¹ä¸€ä¸‹:
process where event.type in (&amp;quot;start&amp;quot;, &amp;quot;process_started&amp;quot;) and process.pe.original_file_name: &amp;quot;whoami.exe&amp;quot;"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="SIEM On ELK"/>
  <meta property="og:site_name" content="ğŸ˜Š#"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  

  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="stylesheet" href="/css/prism-atom-dark.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism-line-numbers.css" media="screen" type="text/css">
  <script src="/js/jquery-2.0.3.min.js"></script>
<!--   <script src="/js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <link rel="stylesheet" href="/css/highlight/styles/atom-one-dark.min.css" media="screen" type="text/css"> -->

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="ğŸ˜Š#" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">ğŸ˜Š#</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/project" title="All the categories.">
			  <i class=""></i>Projects
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> SIEM On ELK</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å‚è€ƒé“¾æ¥é‡Œæœ‰è¯¦ç»†çš„å®‰è£…æ­¥éª¤ï¼Œæµ‹è¯•å®¢æˆ·ç«¯æ˜¯Windowsï¼Œå®‰è£…äº†å¦‚ä¸‹è½¯ä»¶ï¼š</p>
<ul>
<li>sysmon.exe(<a target="_blank" rel="noopener" href="https://github.com/SwiftOnSecurity/sysmon-config">é…ç½®æ–‡ä»¶</a>)<ul>
<li><code>.\sysmon64.exe -accepteula -i c:\windows\config.xml</code></li>
</ul>
</li>
<li>winlogbeat.exe<ul>
<li><code>.\install-service-winlogbeat.ps1</code></li>
<li><code>.\winlogbeat.exe setup -e</code></li>
</ul>
</li>
<li>ElasticAgent.exe<ul>
<li><code>.\elastic-agent.exe install  --insecure -f --fleet-server-es=&lt;ES&gt; --fleet-server-service-token=&lt;token&gt;</code></li>
</ul>
</li>
</ul>
<h3 id="è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡"><a href="#è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡" class="headerlink" title="è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡"></a>è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡</h3><p>è§„åˆ™æœ‰5ç§æŸ¥è¯¢ï¼Œä¸€èˆ¬ä½¿ç”¨EQL(Event Query Language)æŸ¥è¯¢ç±»å‹:<br><img src="/2021/08/02/siem-on-elk/siem-1.png"><br>SIEMæœ‰å†…ç½®å¾ˆå¤šè§„åˆ™ï¼Œé»˜è®¤æ˜¯å…³é—­çŠ¶æ€ï¼Œè¿™äº›è§„åˆ™éƒ½æ˜¯ATT&amp;CKæ¡†æ¶æ”»å‡»è¡Œä¸ºè½¬åŒ–è€Œæ¥çš„ï¼Œä¾‹å¦‚windowsä¸‹çš„<code>whoami</code>æŸ¥è¯¢è§„åˆ™(<del>æ­£ç»äººè°æŸ¥whoamiå•Š</del>):</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.name : &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æˆ‘ä»¬æ‹¿è¿™æ¡è§„åˆ™åšåˆ†æï¼Œè¿™æ¡è§„åˆ™åŒ¹é…äº†å½“è¿›ç¨‹å¼€å§‹çš„æ—¶å€™ï¼Œè¿›ç¨‹åä¸º<code>whoami.exe</code>çš„æ—¶å€™è§¦å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ<code>whoami.exe</code>å¤åˆ¶ä¸€ä¸‹ï¼Œå°±å¯ä»¥ç»•è¿‡å»äº†:</p>
<pre class="line-numbers language-none"><code class="language-none">copy C:\Windows\System32\whoami.exe C:\Windows\temp\x.exe
C:\Windows\temp\x.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>æ˜¯ä¸æ˜¯æŠŠsiemæƒ³çš„ç®€å•äº†ï¼Œè¿™è·Ÿé€šè¿‡å¤åˆ¶<code>net.exe</code>ç»•è¿‡æ·»åŠ ç”¨æˆ·ä¸€æ¨¡ä¸€æ ·ï¼Œä»”ç»†è§‚å¯Ÿä¸‹elké‡Œé¢çš„å­—æ®µï¼Œå¯ä»¥å‘ç°<code>process.pe.original_file_name</code>ä»ç„¶ä¿ç•™äº†<code>whoami.exe</code>ï¼Œè¿™æ˜¯PEæ–‡ä»¶é‡Œé¢å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨æŠŠé¢„è­¦è§„åˆ™ä¿®æ”¹ä¸€ä¸‹:</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.pe.original_file_name: &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>æ­¤æ—¶é€šè¿‡å¤åˆ¶ç»•è¿‡å°±å¤±æ•ˆäº†ï¼Œé‚£ä¹ˆ<code>process.pe.original_file_name</code>èƒ½ä¸èƒ½æ”¹å‘¢ï¼Ÿå¯ä»¥çš„ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/electron/rcedit/releases">rcedit</a>:</p>
<pre class="line-numbers language-none"><code class="language-none">cedit-x64.exe x.exe --set-version-string  OriginalFilename &quot;hello.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/2021/08/02/siem-on-elk/siem-2.png"></p>
<p>æ­¤æ—¶å†æ¬¡æ‰§è¡Œ<code>x.exe</code>ï¼ŒSIEMé‡Œé¢ä¸ä¼šæœ‰å‘Šè­¦ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡è¿™ç§å½¢å¼ç»•è¿‡å’Œ<code>process.pe.original_file_name</code>ç›¸å…³çš„è§„åˆ™ï¼Œæ‰€ä»¥åœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œè¦ä»å¤šä¸ªç»´åº¦æ€è€ƒï¼Œæ¯”å¦‚networkã€æ³¨å†Œè¡¨ã€äº‹ä»¶ID</p>
<h3 id="å‘Šè­¦é€šçŸ¥"><a href="#å‘Šè­¦é€šçŸ¥" class="headerlink" title="å‘Šè­¦é€šçŸ¥"></a>å‘Šè­¦é€šçŸ¥</h3><p>ELKçš„åŸºç¡€ç‰ˆæ²¡æœ‰ç”¨æˆ·é€šçŸ¥çš„åŠŸèƒ½ï¼Œéœ€è¦å¼€é€šç™½é‡‘ç‰ˆï¼Œå¯ä»¥ç”³è¯·è¯•ç”¨30å¤©æˆ–è€…ç ´è§£ï¼Œå¦‚æœæƒ³é€šçŸ¥é’‰é’‰ï¼Œå¯ä»¥é€‰æ‹©webhookçš„æ–¹å¼ï¼Œåœ¨webhookçš„æ—¶å€™æ³¨æ„æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´å­—æ®µ:<code>Content-Type: application/x-wwww-form-data</code>ï¼ŒActioné‡Œé¢å¢åŠ bodyæ ¼å¼:</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&#123;#context.alerts&#125;&#125;
timestamp&#x3D;&#123;&#123;@timestamp&#125;&#125;&amp;rule_name&#x3D;&#123;&#123;context.rule.name&#125;&#125;&amp;risk_score&#x3D;&#123;&#123;context.rule.risk_score&#125;&#125;&amp;host_name&#x3D;&#123;&#123;host.name&#125;&#125;&amp;process_parent_name&#x3D;&#123;&#123;process.parent.name&#125;&#125;&amp;process_command_line&#x3D;&#123;&#123;process.command_line&#125;&#125;&amp;process_name&#x3D;&#123;&#123;process.name&#125;&#125;&amp;user_name&#x3D;&#123;&#123;user.name&#125;&#125;&amp;result_link&#x3D;&#123;&#123;&#123;context.results_link&#125;&#125;&#125;
&#123;&#123;&#x2F;context.alerts&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æœåŠ¡ç«¯è§£æbodyç„¶åé€šçŸ¥é’‰é’‰ï¼š</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> json
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    form <span class="token operator">=</span> request<span class="token punctuation">.</span>form
    <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span>
    timestamp <span class="token operator">=</span> date2local<span class="token punctuation">(</span>form<span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    rule_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"rule_name"</span><span class="token punctuation">]</span>
    <span class="token comment"># risk_score = form["risk_score"]</span>
    host_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"host_name"</span><span class="token punctuation">]</span>
    process_parent_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"process_parent_name"</span><span class="token punctuation">]</span>
    process_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"process_name"</span><span class="token punctuation">]</span>
    process_command_line <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"process_command_line"</span><span class="token punctuation">]</span>
    user_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span>
    result_link <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"result_link"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"%0a"</span><span class="token punctuation">)</span>

    dingTalk_notify<span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> rule_name<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> process_parent_name<span class="token punctuation">,</span> process_name<span class="token punctuation">,</span> process_command_line<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> result_link<span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"OK"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">date2local</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">:</span>
    date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%dT%H:%M:%S.%fZ"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">dingTalk_notify</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> rule_name<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> process_parent_name<span class="token punctuation">,</span> process_name<span class="token punctuation">,</span> process_command_line<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> result_link<span class="token punctuation">)</span><span class="token punctuation">:</span>
    token <span class="token operator">=</span> <span class="token string">""</span>  
    ddrobot <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://oapi.dingtalk.com/robot/send?access_token=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json;charset=utf-8'</span>
    <span class="token punctuation">&#125;</span>
    json_text <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"msgtype"</span><span class="token punctuation">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>
        <span class="token string">"markdown"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"SIEMå‘Šè­¦"</span></span><span class="token punctuation">,</span>
            <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"### SIEMå‘Šè­¦é€šçŸ¥\n##### è§¦å‘æ—¶é—´: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>timestamp<span class="token punctuation">&#125;</span></span><span class="token string">\n##### è§¦å‘è§„åˆ™: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>rule_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### è§¦å‘ä¸»æœº: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>host_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### å…³è”çˆ¶è¿›ç¨‹: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_parent_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### å½“å‰è¿›ç¨‹: "</span></span>
                    <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_name<span class="token punctuation">&#125;</span></span><span class="token string">\n#### è¿›ç¨‹å‚æ•°ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_command_line<span class="token punctuation">&#125;</span></span><span class="token string">\n##### å½“å‰ç”¨æˆ·: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### [å‘Šè­¦è¯¦æƒ…](</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result_link<span class="token punctuation">&#125;</span></span><span class="token string">)"</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string">"at"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"atMobiles"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"isAtAll"</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>ddrobot<span class="token punctuation">,</span> data<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_text<span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">,</span> threaded<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/2021/08/02/siem-on-elk/siem-3.png"></p>
<h3 id="è§„åˆ™ç¤ºä¾‹"><a href="#è§„åˆ™ç¤ºä¾‹" class="headerlink" title="è§„åˆ™ç¤ºä¾‹"></a>è§„åˆ™ç¤ºä¾‹</h3><p>SIEMå†…ç½®çš„è§„åˆ™æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„è§„åˆ™æ‰“å¼€çš„æœ‰å¦‚ä¸‹å‡ ä¸ª:<br>è§„åˆ™åç§°ï¼šConhost Spawned By Suspicious Parent Process<br>è§„åˆ™ä»‹ç»ï¼šConsole Window Host (conhost.exe)ä½œä¸ºå­è¿›ç¨‹è¢«å¯åŠ¨ï¼Œé€šå¸¸æ˜¯åœ¨ä»£ç æ³¨å…¥è¿›ç¨‹çš„æ—¶å€™å‡ºç°</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and
  process.name : &quot;conhost.exe&quot; and
  process.parent.name : (&quot;svchost.exe&quot;, &quot;lsass.exe&quot;, &quot;services.exe&quot;, &quot;smss.exe&quot;, &quot;winlogon.exe&quot;, &quot;explorer.exe&quot;,
                         &quot;dllhost.exe&quot;, &quot;rundll32.exe&quot;, &quot;regsvr32.exe&quot;, &quot;userinit.exe&quot;, &quot;wininit.exe&quot;, &quot;spoolsv.exe&quot;,
                         &quot;wermgr.exe&quot;, &quot;csrss.exe&quot;, &quot;ctfmon.exe&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<p>è§„åˆ™åç§°ï¼šEncoding or Decoding Files via CertUtil<br>è§„åˆ™ä»‹ç»ï¼šé€šè¿‡CertUtilç¼–ç è§£ç æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type &#x3D;&#x3D; &quot;start&quot; and
  (process.name : &quot;certutil.exe&quot; or process.pe.original_file_name &#x3D;&#x3D; &quot;CertUtil.exe&quot;) and
  process.args : (&quot;?decode&quot;, &quot;?encode&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<hr>
<p>è§„åˆ™åç§°ï¼šUnusual Child Processes of RunDLL32<br>è§„åˆ™ä»‹ç»ï¼šä¸æ­£å¸¸çš„rundll32.exeæ´»åŠ¨ï¼ˆé€šå¸¸ç”¨åœ¨å¯åŠ¨æœ¨é©¬è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚CSçš„Spawnï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">sequence with maxspan&#x3D;1h
  [process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and
     (process.name : &quot;rundll32.exe&quot; or process.pe.original_file_name &#x3D;&#x3D; &quot;RUNDLL32.EXE&quot;) and
      process.args_count &#x3D;&#x3D; 1
  ] by process.entity_id
  [process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.parent.name : &quot;rundll32.exe&quot;
  ] by process.parent.entity_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<p>è§„åˆ™åç§°ï¼šCreation of a Hidden Local User Account<br>è§„åˆ™ä»‹ç»ï¼šæ·»åŠ éšè—è´¦æˆ·ï¼ˆç”¨äºæƒé™ç»´æŒï¼‰</p>
<pre class="line-numbers language-none"><code class="language-none">registry where registry.path : &quot;HKLM\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*$\\&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<hr>
<p>è§„åˆ™åç§°ï¼šWindows Script Executing PowerShell<br>è§„åˆ™ä»‹ç»ï¼šä½¿ç”¨wscriptæˆ–è€…cscriptæ‰§è¡ŒPowershell</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and
  process.parent.name : (&quot;cscript.exe&quot;, &quot;wscript.exe&quot;) and process.name : &quot;powershell.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<hr>
<p>è§„åˆ™åç§°ï¼šWindows Suspicious Command<br>è§„åˆ™ä»‹ç»ï¼šWindowså¯ç–‘å‘½ä»¤</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and
process.pe.original_file_name in (&quot;whoami.exe&quot;, &quot;tasklist.exe&quot;, &quot;ipconfig.exe&quot;, &quot;powershell.exe&quot;, &quot;sctasks.exe&quot;, &quot;bitsadmin.exe&quot;, &quot;netstat.exe&quot;, &quot;systeminfo.exe&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<hr>
<p>è§„åˆ™åç§°ï¼šSecurity Software Discovery using WMIC<br>è§„åˆ™ä»‹ç»ï¼šä½¿ç”¨wmicæŸ¥è¯¢å®‰å…¨è½¯ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and
   (process.name:&quot;wmic.exe&quot; or process.pe.original_file_name:&quot;wmic.exe&quot;) and
    process.args:&quot;&#x2F;namespace:\\\\root\\SecurityCenter2&quot; and process.args:&quot;Get&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<hr>
<p>è§„åˆ™åç§°ï¼šNet command via SYSTEM account<br>è§„åˆ™ä»‹ç»ï¼šä»¥SYSTEMæƒé™æ‰§è¡Œnet.exe</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and
  user.id in (&quot;S-1-5-18&quot;, &quot;S-1-5-19&quot;, &quot;S-1-5-20&quot;) and
  process.name : &quot;whoami.exe&quot; or
  (process.name : &quot;net1.exe&quot; and not process.parent.name : &quot;net.exe&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://github.com/SigmaHQ/sigma">sigma</a>(Generic Signature Format for SIEM Systems)ï¼Œè¿™ç§æè¿°æ–¹å¼ç‰¹åˆ«åƒç—…æ¯’è½¯ä»¶çš„ç‰¹å¾ç ã€‚</p>
<h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><ul>
<li>ç»•è¿‡çš„æ–¹å¼åº”è¯¥è¿˜æœ‰å¾ˆå¤šï¼Œæœªæµ‹è¯•</li>
<li>å®‰éª‘å£«çš„åŸç†ç±»ä¼¼ï¼Œæ¯”å¦‚ç¢°åˆ°è¿‡é˜¿é‡Œäº‘ä¸Šæ‰§è¡Œ<code>whoamiã€systeminfo</code>å°±å‘Šè­¦</li>
<li>çœ‹å®Œ<a target="_blank" rel="noopener" href="http://weizn.net/?p=439">é€šè¿‡SYSMONæ—¥å¿—æ£€æµ‹Cobalt Strikeæœ¨é©¬</a>æˆ‘è§‰å¾—è¿™ä¸ªæ‰æ˜¯SIEMçš„è§£å†³æ–¹å¼</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul>
<li><a target="_blank" rel="noopener" href="https://unicornsec.com/home/siem-home-lab-series-part-1">SIEMå®éªŒç³»åˆ—-1</a></li>
<li><a target="_blank" rel="noopener" href="https://unicornsec.com/home/siem-home-lab-series-part-2">SIEMå®éªŒç³»åˆ—-2</a></li>
<li><a target="_blank" rel="noopener" href="https://unicornsec.com/home/siem-home-lab-series-part-3">SIEMå®éªŒç³»åˆ—-3</a></li>
<li><a target="_blank" rel="noopener" href="http://weizn.net/?p=439">é€šè¿‡SYSMONæ—¥å¿—æ£€æµ‹Cobalt Strikeæœ¨é©¬</a></li>
</ul>

	</div>

	
	<span id="/2021/08/02/siem-on-elk.html" class="leancloud-visitors view" data-flag-title="SIEM On ELK">
	</span>
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2021/08/06/windows-ntlm-smb-scan.html" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2021/07/29/silverFish.html" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2021-08-02 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Pentest/">Pentest<span>53</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-article-text">å®‰è£…</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%A7%84%E5%88%99%E7%9B%91%E6%B5%8B%E5%92%8C%E7%BB%95%E8%BF%87"><span class="toc-article-text">è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5"><span class="toc-article-text">å‘Šè­¦é€šçŸ¥</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%A7%84%E5%88%99%E7%A4%BA%E4%BE%8B"><span class="toc-article-text">è§„åˆ™ç¤ºä¾‹</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%80%9D%E8%80%83"><span class="toc-article-text">æ€è€ƒ</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%8F%82%E8%80%83"><span class="toc-article-text">å‚è€ƒ</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2023 JKme's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>â¬†ï¸TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
